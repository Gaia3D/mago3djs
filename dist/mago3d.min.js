"use strict";var Atmosphere=function(){if(!(this instanceof Atmosphere))throw new Error(Messages.CONSTRUCT_ERROR);this.cloudsManager=new CloudsManager,this.shadowBlendingCube=new ShadowBlendingCube},ShadowBlendingCube=function(){if(!(this instanceof ShadowBlendingCube))throw new Error(Messages.CONSTRUCT_ERROR);this.vertexMatrix=new VertexMatrix,this.tTrianglesMatrix=new TTrianglesMatrix,this.init(this.vertexMatrix,this.tTrianglesMatrix),this.vboVertexCacheKey,this.vboIndexCacheKey,this.indicesCount=0};ShadowBlendingCube.prototype.init=function(e,t){var i=.1,o=.1,r=.1,n=e.newVertexList(),a=n.newVertex();a.setPosition(0,0,-150.5),a.setColorRGBA(i,o,r,.6),(a=n.newVertex()).setPosition(0,0,-150.5),a.setColorRGBA(i,o,r,.6),(a=n.newVertex()).setPosition(0,0,-150.5),a.setColorRGBA(i,o,r,.6),(a=n.newVertex()).setPosition(0,0,-150.5),a.setColorRGBA(i,o,r,.6),(a=(n=e.newVertexList()).newVertex()).setPosition(-150.5,-150.5,-150.5),a.setColorRGBA(i,o,r,.6),(a=n.newVertex()).setPosition(150.5,-150.5,-150.5),a.setColorRGBA(i,o,r,.6),(a=n.newVertex()).setPosition(150.5,150.5,-150.5),a.setColorRGBA(i,o,r,.6),(a=n.newVertex()).setPosition(-150.5,150.5,-150.5),a.setColorRGBA(i,o,r,.6),(a=(n=e.newVertexList()).newVertex()).setPosition(-150.5,-150.5,150.5),a.setColorRGBA(i,o,r,.6),(a=n.newVertex()).setPosition(150.5,-150.5,150.5),a.setColorRGBA(i,o,r,.6),(a=n.newVertex()).setPosition(150.5,150.5,150.5),a.setColorRGBA(i,o,r,.6),(a=n.newVertex()).setPosition(-150.5,150.5,150.5),a.setColorRGBA(i,o,r,.6),(a=(n=e.newVertexList()).newVertex()).setPosition(0,0,150.5),a.setColorRGBA(i,o,r,.6),(a=n.newVertex()).setPosition(0,0,150.5),a.setColorRGBA(i,o,r,.6),(a=n.newVertex()).setPosition(0,0,150.5),a.setColorRGBA(i,o,r,.6),(a=n.newVertex()).setPosition(0,0,150.5),a.setColorRGBA(i,o,r,.6),e.makeTTrianglesLateralSidesLOOP(t)},ShadowBlendingCube.prototype.getVBOVertexColorRGBAFloatArray=function(){return this.vertexMatrix.getVBOVertexColorRGBAFloatArray()},ShadowBlendingCube.prototype.getVBOIndicesShortArray=function(){this.vertexMatrix.setVertexIdxInList();var e=this.tTrianglesMatrix.getVBOIndicesShortArray();return this.indicesCount=e.length,e};var CloudsManager=function(){if(!(this instanceof CloudsManager))throw new Error(Messages.CONSTRUCT_ERROR);this.circularCloudsArray=[]};CloudsManager.prototype.newCircularCloud=function(){var e=new CircularCloud;return this.circularCloudsArray.push(e),e};var CircularCloud=function(){if(!(this instanceof CircularCloud))throw new Error(Messages.CONSTRUCT_ERROR);this.radius=200,this.depth=150,this.numPointsForCicle=8,this.vertexMatrix=new VertexMatrix,this.tTrianglesMatrix=new TTrianglesMatrix,this.shadowVertexMatrix=new VertexMatrix,this.shadowTTrianglesMatrix=new TTrianglesMatrix,this.sunLightDirection=new Point3D,this.sunLightDirection.set(1,1,-5),this.sunLightDirection.unitary(),this.longitude,this.latitude,this.altitude,this.position,this.positionHIGH,this.positionLOW,this.bbox=new BoundingBox,this.cullingPosition,this.cullingRadius,this.vboVertexCacheKey,this.vboIndexCacheKey,this.vboShadowVertexCacheKey,this.vboShadowIndexCacheKey,this.indicesCount=0,this.rendered=!1,this.point3dSC=new Point3D,this.vertexSC=new Vertex};CircularCloud.prototype.getVBOVertexColorFloatArray=function(){var e;return e=this.vertexMatrix.getVBOVertexColorFloatArray(e)},CircularCloud.prototype.getVBOIndicesShortArray=function(){this.vertexMatrix.setVertexIdxInList();var e=this.tTrianglesMatrix.getVBOIndicesShortArray();return this.indicesCount=e.length,e},CircularCloud.prototype.getVBOShadowVertexFloatArray=function(){var e;return e=this.shadowVertexMatrix.getVBOVertexFloatArray(e)},CircularCloud.prototype.getVBOShadowIndicesShortArray=function(){this.shadowVertexMatrix.setVertexIdxInList();var e=this.shadowTTrianglesMatrix.getVBOIndicesShortArray();return this.indicesCount=e.length,e},CircularCloud.prototype.rotateMeshByLocation=function(e){var t=new Matrix4;t.rotationAxisAngDeg(-this.longitude,0,0,1),e.transformPointsByMatrix4(t);var i,o=this.longitude*Math.PI/180,r=new Point3D,n=new Point3D;r.set(Math.cos(o),Math.sin(o),0),n.set(0,0,1),(i=r.crossProduct(n,i)).unitary(),t.rotationAxisAngDeg(90-this.latitude,i.x,i.y,0),e.transformPointsByMatrix4(t)},CircularCloud.prototype.doShadowMeshWithSunDirection=function(){var e=this.shadowVertexMatrix.getVertexList(5);e.translateVertices(this.sunLightDirection.x,this.sunLightDirection.y,this.sunLightDirection.z,3e3),(e=this.shadowVertexMatrix.getVertexList(4)).translateVertices(this.sunLightDirection.x,this.sunLightDirection.y,this.sunLightDirection.z,3e3),(e=this.shadowVertexMatrix.getVertexList(3)).translateVertices(this.sunLightDirection.x,this.sunLightDirection.y,this.sunLightDirection.z,3e3)},CircularCloud.prototype.createCloud=function(e,t,i,o,r,n){this.longitude=e,this.latitude=t,this.altitude=i,this.radius=o,this.depth=r,this.numPointsForCicle=n,this.makeMesh(this.vertexMatrix,this.tTrianglesMatrix,this.shadowVertexMatrix,this.shadowTTrianglesMatrix),this.doShadowMeshWithSunDirection(),this.rotateMeshByLocation(this.vertexMatrix),this.rotateMeshByLocation(this.shadowVertexMatrix);var a=Cesium.Cartesian3.fromDegrees(this.longitude,this.latitude,this.altitude);this.position=a;var s,l=Cesium.EncodedCartesian3.encode(a.x),c=Cesium.EncodedCartesian3.encode(a.y),h=Cesium.EncodedCartesian3.encode(a.z);this.positionHIGH=new Float32Array([l.high,c.high,h.high]),this.positionLOW=new Float32Array([l.low,c.low,h.low]),this.bbox=this.shadowVertexMatrix.getBoundingBox(this.bbox),s=this.bbox.getCenterPoint(s),this.cullingPosition=new Cesium.Cartesian3(s.x+this.position.x,s.y+this.position.y,s.z+this.position.z),this.cullingRadius=this.bbox.getMaxLength()/2},CircularCloud.prototype.makeMesh=function(e,t,i,o){var r,n,a=2*Math.PI/16,s=0,l=this.depth/2,c=0,h=0,d=0,u=e.newVertexList(),f=i.newVertexList();d=.9+.3*Math.random();for(var g=0;g<16;g++)(r=u.newVertex()).setPosition(c,h,l),(n=f.newVertex()).setPosition(c,h,1.2*-l),r.setColorRGB(d,d,d);s=0;var p=.7*this.radius;u=e.newVertexList(),f=i.newVertexList();for(g=0;g<16;g++)d=(2+Math.random())/2,r=u.newVertex(),n=f.newVertex(),c=p*Math.cos(s)*d,h=p*Math.sin(s)*d,n.setPosition(c,h,2*-l),r.setPosition(c,h,.8*l),d=.9+.3*Math.random(),r.setColorRGB(d,d,d),s+=a;s=0,u=e.newVertexList(),f=i.newVertexList();for(g=0;g<16;g++)d=(2+Math.random())/2,r=u.newVertex(),n=f.newVertex(),c=this.radius*Math.cos(s)*d,h=this.radius*Math.sin(s)*d,n.setPosition(c,h,2*-l),r.setPosition(c,h,.4*l),d=.9+.3*Math.random(),r.setColorRGB(d,d,d),s+=a;s=0,u=e.newVertexList(),f=i.newVertexList();for(g=0;g<16;g++)d=(2+Math.random())/2,r=u.newVertex(),n=f.newVertex(),c=this.radius*Math.cos(s)*d,h=this.radius*Math.sin(s)*d,n.setPosition(c,h,2*-l),r.setPosition(c,h,.4*-l),d=.8+.3*Math.random(),r.setColorRGB(d,d,d),s+=a;s=0,p=.7*this.radius,u=e.newVertexList(),f=i.newVertexList();for(g=0;g<16;g++)d=(2+Math.random())/2,r=u.newVertex(),n=f.newVertex(),c=p*Math.cos(s)*d,h=p*Math.sin(s)*d,r.setPosition(c,h,.8*-l),n.setPosition(c,h,1.2*-l),d=.6+.3*Math.random(),r.setColorRGB(d,d,d),s+=a;u=e.newVertexList(),f=i.newVertexList(),d=.6+.3*Math.random();for(g=0;g<16;g++)r=u.newVertex(),n=f.newVertex(),r.setPosition(0,0,-l),n.setPosition(0,0,-l),r.setColorRGB(d,d,d);e.makeTTrianglesLateralSidesLOOP(t),i.makeTTrianglesLateralSidesLOOP(o)};var AuxiliarSegment=function(){if(!(this instanceof AuxiliarSegment))throw new Error(Messages.CONSTRUCT_ERROR);this.point1,this.point2};AuxiliarSegment.prototype.setPoints=function(e,t,i,o,r,n){this.point1[0]=e,this.point1[1]=t,this.point1[2]=i,this.point2[0]=o,this.point2[1]=r,this.point2[2]=n};var BoundingBox=function(){if(!(this instanceof BoundingBox))throw new Error(Messages.CONSTRUCT_ERROR);this.minX=1e6,this.minY=1e6,this.minZ=1e6,this.maxX=-1e6,this.maxY=-1e6,this.maxZ=-1e6};BoundingBox.prototype.init=function(e){e=e||new Point3D,this.minX=e.x,this.minY=e.y,this.minZ=e.z,this.maxX=e.x,this.maxY=e.y,this.maxZ=e.z},BoundingBox.prototype.deleteObjects=function(){this.minX=void 0,this.minY=void 0,this.minZ=void 0,this.maxX=void 0,this.maxY=void 0,this.maxZ=void 0},BoundingBox.prototype.copyFrom=function(e){this.minX=e.minX,this.minY=e.minY,this.minZ=e.minZ,this.maxX=e.maxX,this.maxY=e.maxY,this.maxZ=e.maxZ},BoundingBox.prototype.translateToOrigin=function(){var e=this.getXLength()/2,t=this.getYLength()/2,i=this.getZLength()/2;this.minX=-e,this.minY=-t,this.minZ=-i,this.maxX=e,this.maxY=t,this.maxZ=i},BoundingBox.prototype.expand=function(e){e=e||0,e=Math.abs(e),this.minX-=e,this.minY-=e,this.minZ-=e,this.maxX+=e,this.maxY+=e,this.maxZ+=e},BoundingBox.prototype.addPoint=function(e){void 0!==e&&(e.x<this.minX?this.minX=e.x:e.x>this.maxX&&(this.maxX=e.x),e.y<this.minY?this.minY=e.y:e.y>this.maxY&&(this.maxY=e.y),e.z<this.minZ?this.minZ=e.z:e.z>this.maxZ&&(this.maxZ=e.z))},BoundingBox.prototype.addBox=function(e){void 0!==e&&(e.minX<this.minX&&(this.minX=e.minX),e.maxX>this.maxX&&(this.maxX=e.maxX),e.minY<this.minY&&(this.minY=e.minY),e.maxY>this.maxY&&(this.maxY=e.maxY),e.minZ<this.minZ&&(this.minZ=e.minZ),e.maxZ>this.maxZ&&(this.maxZ=e.maxZ))},BoundingBox.prototype.getMinLength=function(){return Math.min(this.maxX-this.minX,this.maxY-this.minY,this.maxZ-this.minZ)},BoundingBox.prototype.getMaxLength=function(){return Math.max(this.maxX-this.minX,this.maxY-this.minY,this.maxZ-this.minZ)},BoundingBox.prototype.getXLength=function(){return this.maxX-this.minX},BoundingBox.prototype.getYLength=function(){return this.maxY-this.minY},BoundingBox.prototype.getZLength=function(){return this.maxZ-this.minZ},BoundingBox.prototype.getCenterPoint=function(e){return void 0===e&&(e=new Point3D),e.set((this.maxX+this.minX)/2,(this.maxY+this.minY)/2,(this.maxZ+this.minZ)/2),e},BoundingBox.prototype.getRadiusAprox=function(){return this.getMaxLength()/1.5},BoundingBox.prototype.intersectWithPoint=function(e){return void 0!==e&&!(e.x<this.minX||e.x>this.maxX||e.y<this.minY||e.y>this.maxY||e.z<this.minZ||e.z>this.maxZ)},BoundingBox.prototype.isPoint3dInside=function(e,t,i){return!(e<this.minX||e>this.maxX)&&(!(t<this.minY||t>this.maxY)&&!(i<this.minZ||i>this.maxZ))},BoundingBox.prototype.intersectWithBox=function(e){return void 0!==e&&!(e.minX>this.maxX||e.maxX<this.minX||e.minY>this.maxY||e.maxY<this.minY||e.minZ>this.maxZ||e.maxZ<this.minZ)},BoundingBox.prototype.intersectsWithBBox=function(e){var t=!0;return this.maxX<e.minX?t=!1:this.minX>e.maxX?t=!1:this.maxY<e.minY?t=!1:this.minY>e.maxY?t=!1:this.maxZ<e.minZ?t=!1:this.minZ>e.maxZ&&(t=!1),t};var BoundingSphere=function(){if(!(this instanceof BoundingSphere))throw new Error(Messages.CONSTRUCT_ERROR);this.center=new Point3D,this.radius=0},Box=function(){if(!(this instanceof Box))throw new Error(Messages.CONSTRUCT_ERROR);this.vbo_vicks_container=new VBOVertexIdxCacheKeysContainer,this.vbo_vicks_containerEdges,this.centerPoint,this.width,this.length,this.height};Box.prototype.getVboKeysContainer=function(){return this.vbo_vicks_container},Box.prototype.makeMesh=function(e,t,i){void 0!==e&&(this.width=e),void 0!==t&&(this.length=t),void 0!==i&&(this.height=i),void 0===this.width&&(this.width=1),void 0===this.length&&(this.length=1),void 0===this.height&&(this.height=1),void 0===this.centerPoint&&(this.centerPoint=new Point3D(0,0,0)),void 0===this.vbo_vicks_container&&(this.vbo_vicks_container=new VBOVertexIdxCacheKeysContainer),void 0===this.vbo_vicks_containerEdges&&(this.vbo_vicks_containerEdges=new VBOVertexIdxCacheKeysContainer);var o=new ParametricMesh;o.profile=new Profile;var r=o.profile,n=r.newOuterRing().newElement("RECTANGLE");n.setCenterPosition(this.centerPoint.x,this.centerPoint.y),n.setDimensions(this.width,this.length);o.extrude(r,this.height,1,void 0);var a=o.getSurfaceIndependentMesh(void 0,!0,!0);return a.translate(0,0,-this.height/2),a};var BuildingSeed=function(){if(!(this instanceof BuildingSeed))throw new Error(Messages.CONSTRUCT_ERROR);this.fisrtName,this.name="",this.buildingId,this.buildingFileName,this.geographicCoord,this.rotationsDegree,this.bBox,this.geographicCoordOfBBox};BuildingSeed.prototype.deleteObjects=function(){this.fisrtName=void 0,this.name=void 0,this.buildingId=void 0,this.buildingFileName=void 0,this.geographicCoord.deleteObjects(),this.rotationsDegree.deleteObjects(),this.bBox.deleteObjects(),this.geographicCoordOfBBox.deleteObjects(),this.geographicCoord=void 0,this.rotationsDegree=void 0,this.bBox=void 0,this.geographicCoordOfBBox=void 0};var BuildingSeedList=function(){if(!(this instanceof BuildingSeedList))throw new Error(Messages.CONSTRUCT_ERROR);this.buildingSeedArray=[],this.minGeographicCoord,this.maxGeographicCoord,this.dataArrayBuffer};BuildingSeedList.prototype.deleteObjects=function(){if(this.minGeographicCoord.deleteObjects(),this.maxGeographicCoord.deleteObjects(),this.minGeographicCoord=void 0,this.maxGeographicCoord=void 0,this.buildingSeedArray){for(var e=this.buildingSeedArray.length,t=0;t<e;t++)this.buildingSeedArray[t].deleteObjects(),this.buildingSeedArray[t]=void 0;this.buildingSeedArray=void 0}this.dataArrayBuffer=void 0},BuildingSeedList.prototype.newBuildingSeed=function(){var e=new BuildingSeed;return this.buildingSeedArray.push(e),e},BuildingSeedList.prototype.parseBuildingSeedArrayBuffer=function(){if(void 0===this.dataArrayBuffer)return!1;var e,t,i,o,r=this.dataArrayBuffer,n=0,a=new Int32Array(r.slice(n,n+4))[0];n+=4;for(var s=0;s<a;s++){var l=this.newBuildingSeed();void 0===l.geographicCoord&&(l.geographicCoord=new GeographicCoord),void 0===l.bBox&&(l.bBox=new BoundingBox),e=new Int32Array(r.slice(n,n+4))[0],n+=4;var c=new TextDecoder("utf-8").decode(new Uint8Array(r.slice(n,n+e)));n+=e,t=new Float64Array(r.slice(n,n+8))[0],n+=8,i=new Float64Array(r.slice(n,n+8))[0],n+=8,o=new Float32Array(r.slice(n,n+4))[0],n+=4,l.bBox.minX=new Float32Array(r.slice(n,n+4))[0],n+=4,l.bBox.minY=new Float32Array(r.slice(n,n+4))[0],n+=4,l.bBox.minZ=new Float32Array(r.slice(n,n+4))[0],n+=4,l.bBox.maxX=new Float32Array(r.slice(n,n+4))[0],n+=4,l.bBox.maxY=new Float32Array(r.slice(n,n+4))[0],n+=4,l.bBox.maxZ=new Float32Array(r.slice(n,n+4))[0],n+=4,l.buildingId=c.substr(4,e-4),l.buildingFileName=c,l.geographicCoord.setLonLatAlt(t,i,o)}return!0};var Camera=function(){if(!(this instanceof Camera))throw new Error(Messages.CONSTRUCT_ERROR);this.position=new Point3D,this.direction=new Point3D,this.up=new Point3D,this.right=new Point3D,this.frustum=new Frustum,this.bigFrustum=new Frustum,this.dirty=!0,this.frustumsArray=[],this.frustumsArray.push(this.frustum),this.nearCenterPoint=new Point3D,this.farCenterPoint=new Point3D,this.farLeftBottomPoint=new Point3D,this.farRightTopPoint=new Point3D,this.leftBottomDir=new Point3D,this.rightTopDir=new Point3D,this.leftNormal=new Point3D,this.rightNormal=new Point3D,this.bottomNormal=new Point3D,this.topNormal=new Point3D};Camera.prototype.copyPosDirUpFrom=function(e){this.position.copyFrom(e.position),this.direction.copyFrom(e.direction),this.up.copyFrom(e.up)},Camera.prototype.transformByMatrix4=function(e){this.position=this.transformPoint3DByMatrix4(this.position,e),void 0===this.rotMat&&(this.rotMat=mat3.create()),this.rotMat=mat3.fromMat4(this.rotMat,e),this.direction=this.rotatePoint3DByMatrix3(this.direction,this.rotMat),this.up=this.rotatePoint3DByMatrix3(this.up,this.rotMat)},Camera.prototype.getCameraDirectionLine=function(e){return void 0===e&&(e=new Line),e.point.set(this.position.x,this.position.y,this.position.z),e.direction.set(this.direction.x,this.direction.y,this.direction.z),e},Camera.prototype.getCameraElevation=function(){return this.position.getModul()-6356752.3142},Camera.prototype.getCameraRight=function(){return void 0===this.right&&(this.right=new Point3D),this.right=this.direction.crossProduct(this.up,this.right),this.right},Camera.prototype.transformPoint3DByMatrix4=function(e,t){var i=vec3.clone([e.x,e.y,e.z]),o=vec3.create();return o=vec3.transformMat4(o,i,t),e.set(o[0],o[1],o[2]),e},Camera.prototype.rotatePoint3DByMatrix3=function(e,t){var i=vec3.clone([e.x,e.y,e.z]),o=vec3.create();return o=vec3.transformMat3(o,i,t),e.set(o[0],o[1],o[2]),e},Camera.prototype.setDirty=function(e){this.dirty=e},Camera.prototype.getDirty=function(){return this.dirty},Camera.prototype.isCameraMoved=function(e,t,i,o,r,n,a,s,l){return this.position.x!==e||this.position.y!==t||this.position.z!==i||this.direction.x!==o||this.direction.y!==r||this.direction.z!==n||this.up.x!==a||this.up.y!==s||this.up.z!==l},Camera.prototype.getFrustum=function(e){return void 0===this.frustumsArray[e]&&(this.frustumsArray[e]=new Frustum,this.frustumsArray[e].fovRad[0]=this.frustumsArray[0].fovRad[0],this.frustumsArray[e].fovyRad[0]=this.frustumsArray[0].fovyRad[0],this.frustumsArray[e].aspectRatio[0]=this.frustumsArray[0].aspectRatio[0],this.frustumsArray[e].tangentOfHalfFovy[0]=this.frustumsArray[0].tangentOfHalfFovy[0]),this.frustumsArray[e]},Camera.prototype.getLastFrustum=function(){return this.getFrustum(this.frustumsArray.length-1)},Camera.prototype.setFrustumsDistances=function(e,t){for(var i,o=0;o<e;o++)t[o],(i=this.getFrustum(o)).near[0]=t[2*o],i.far[0]=t[2*o+1],0===o&&(this.bigFrustum.near[0]=t[2*o]),o===e-1&&(this.bigFrustum.far[0]=t[2*o+1]);this.bigFrustum.far[0]>2e4&&(this.bigFrustum.far[0]=2e4)},Camera.prototype.setAspectRatioAndFovyRad=function(e,t){var i,o;(o=this.getFrustum(0)).aspectRatio[0]=e,o.fovyRad[0]=t,o.fovRad[0]=t*e,o.tangentOfHalfFovy[0]=Math.tan(t/2);for(var r=this.frustumsArray.length,n=1;n<r;n++)(i=this.getFrustum(n)).aspectRatio[0]=o.aspectRatio[0],i.fovyRad[0]=o.fovyRad[0],i.fovRad[0]=o.fovRad[0],i.tangentOfHalfFovy[0]=o.tangentOfHalfFovy[0];this.bigFrustum.aspectRatio[0]=o.aspectRatio[0],this.bigFrustum.fovyRad[0]=o.fovyRad[0],this.bigFrustum.fovRad[0]=o.fovRad[0],this.bigFrustum.tangentOfHalfFovy[0]=o.tangentOfHalfFovy[0]},Camera.prototype.setCurrentFrustum=function(e){this.frustum=this.getFrustum(e)},Camera.prototype.calculateFrustumsPlanes=function(){var e,t,i=(e=this.getFrustum(0)).tangentOfHalfFovy*e.near*2,o=e.tangentOfHalfFovy*e.far*2,r=(e.aspectRatio,o*e.aspectRatio),n=this.position.x,a=this.position.y,s=this.position.z,l=this.direction.x,c=this.direction.y,h=this.direction.z;this.right=this.direction.crossProduct(this.up,this.right),this.nearCenterPoint.set(n+l*e.near,a+c*e.near,s+h*e.near),this.farCenterPoint.set(n+l*e.far,a+c*e.far,s+h*e.far),this.farLeftBottomPoint.set(this.farCenterPoint.x-this.right.x*r*.5-this.up.x*o*.5,this.farCenterPoint.y-this.right.y*r*.5-this.up.y*o*.5,this.farCenterPoint.z-this.right.z*r*.5-this.up.z*o*.5),this.farRightTopPoint.set(this.farLeftBottomPoint.x+this.right.x*r+this.up.x*o,this.farLeftBottomPoint.y+this.right.y*r+this.up.y*o,this.farLeftBottomPoint.z+this.right.z*r+this.up.z*o),this.leftBottomDir.set(this.farLeftBottomPoint.x-n,this.farLeftBottomPoint.y-a,this.farLeftBottomPoint.z-s),this.leftBottomDir.unitary(),this.rightTopDir.set(this.farRightTopPoint.x-n,this.farRightTopPoint.y-a,this.farRightTopPoint.z-s),this.rightTopDir.unitary(),e.planesArray[0].setPointAndNormal(this.nearCenterPoint.x,this.nearCenterPoint.y,this.nearCenterPoint.z,l,c,h),e.planesArray[1].setPointAndNormal(this.farCenterPoint.x,this.farCenterPoint.y,this.farCenterPoint.z,-l,-c,-h),this.leftNormal=this.leftBottomDir.crossProduct(this.up,this.leftNormal),this.leftNormal.unitary(),e.planesArray[2].setPointAndNormal(n,a,s,this.leftNormal.x,this.leftNormal.y,this.leftNormal.z),this.bottomNormal=this.right.crossProduct(this.leftBottomDir,this.bottomNormal),this.bottomNormal.unitary(),e.planesArray[3].setPointAndNormal(n,a,s,this.bottomNormal.x,this.bottomNormal.y,this.bottomNormal.z),this.rightNormal=this.up.crossProduct(this.rightTopDir,this.rightNormal),this.rightNormal.unitary(),e.planesArray[4].setPointAndNormal(n,a,s,this.rightNormal.x,this.rightNormal.y,this.rightNormal.z),this.topNormal=this.rightTopDir.crossProduct(this.right,this.topNormal),this.topNormal.unitary(),e.planesArray[5].setPointAndNormal(n,a,s,this.topNormal.x,this.topNormal.y,this.topNormal.z);for(var d=this.frustumsArray.length,u=1;u<d;u++){t=this.getFrustum(u),this.nearCenterPoint.set(n+l*t.near,a+c*t.near,s+h*t.near),this.farCenterPoint.set(n+l*t.far,a+c*t.far,s+h*t.far),t.planesArray[0].setPointAndNormal(this.nearCenterPoint.x,this.nearCenterPoint.y,this.nearCenterPoint.z,l,c,h),t.planesArray[1].setPointAndNormal(this.farCenterPoint.x,this.farCenterPoint.y,this.farCenterPoint.z,-l,-c,-h);for(var f=2;f<6;f++)t.planesArray[f]=e.planesArray[f]}this.nearCenterPoint.set(n+l*this.bigFrustum.near,a+c*this.bigFrustum.near,s+h*this.bigFrustum.near),this.farCenterPoint.set(n+l*this.bigFrustum.far,a+c*this.bigFrustum.far,s+h*this.bigFrustum.far),this.bigFrustum.planesArray[0].setPointAndNormal(this.nearCenterPoint.x,this.nearCenterPoint.y,this.nearCenterPoint.z,l,c,h),this.bigFrustum.planesArray[1].setPointAndNormal(this.farCenterPoint.x,this.farCenterPoint.y,this.farCenterPoint.z,-l,-c,-h);for(this.getLastFrustum(),f=2;f<6;f++)this.bigFrustum.planesArray[f]=e.planesArray[f]};var CCTV=function(e){if(!(this instanceof CCTV))throw new Error(Messages.CONSTRUCT_ERROR);this.name="noName",void 0!==e&&(this.name=e),this.geoLocationData=new GeoLocationData,this.minHeading=0,this.maxHeading=90,this.heading=30,this.pitch=60,this.roll=0,this.rotMat=new Matrix4,this.camera=new Camera,this.vboKeyContainer,this.vboKeyContainerEdges,this.color=new Color,this.color.setRGBA(0,.5,.9,.3),this.greenFactorSpeed=1,this.blueFactorSpeed=2,this.alphaFactorSpeed=2,this.headingAngularSpeed=25,this.lastTime};CCTV.prototype.updateHeading=function(e){void 0===this.lastTime&&(this.lastTime=e);var t=(e-this.lastTime)/1e3;this.heading+=t*this.headingAngularSpeed,this.heading>this.maxHeading?(this.heading=this.maxHeading,this.headingAngularSpeed*=-1):this.heading<this.minHeading&&(this.heading=this.minHeading,this.headingAngularSpeed*=-1),this.lastTime=e,this.calculateRotationMatrix(),void 0===this.greenFactor&&(this.greenFactor=1),void 0===this.blueFactor&&(this.blueFactor=1),void 0===this.alphaFactor&&(this.alphaFactor=1),this.greenFactor+=this.greenFactorSpeed*t,this.blueFactor+=this.blueFactorSpeed*t,this.greenFactor>.5&&(this.greenFactor=.5,this.greenFactorSpeed*=-1),this.greenFactor<0&&(this.greenFactor=0,this.greenFactorSpeed*=-1),this.blueFactor>.9&&(this.blueFactor=.9,this.blueFactorSpeed*=-1),this.blueFactor<0&&(this.blueFactor=0,this.blueFactorSpeed*=-1),this.alphaFactor>.6&&(this.alphaFactor=.6,this.alphaFactorSpeed*=-1),this.alphaFactor<0&&(this.alphaFactor=0,this.alphaFactorSpeed*=-1),this.color.setRGBA(0,this.greenFactor,this.blueFactor,this.alphaFactor)},CCTV.prototype.calculateRotationMatrix=function(){var e;e=Matrix4.getRotationDegZXYMatrix(this.heading,this.pitch,this.roll,e),this.rotMat=e.getMultipliedByMatrix(this.geoLocationData.rotMatrix,this.rotMat)},CCTV.prototype.getVbo=function(e,t){var i;void 0===e&&(e=new VBOVertexIdxCacheKeysContainer),void 0===this.vboKeyContainerEdges&&(this.vboKeyContainerEdges=new VBOVertexIdxCacheKeysContainer),i=this.makeFrustumGeometry_2(i);var o=new Matrix4,r=this.camera.bigFrustum.fovyRad/2;o.rotationAxisAngDeg(-90-r/2*180/Math.PI,1,0,0);var n=i.getSurfaceIndependentMesh(void 0,!0,!0);return n.transformByMatrix4(o),n.setColor(0,.5,.9,.3),n.getVbo(e),n.getVboEdges(this.vboKeyContainerEdges),e},CCTV.prototype.render=function(e,t,i){if(void 0!==this.vboKeyContainer){var o;this.vboKeyContainer.vboCacheKeysArray.length;e.uniformMatrix4fv(i.buildingRotMatrix_loc,!1,this.geoLocationData.rotMatrix._floatArrays),e.uniform3fv(i.buildingPosHIGH_loc,this.geoLocationData.positionHIGH),e.uniform3fv(i.buildingPosLOW_loc,this.geoLocationData.positionLOW),e.uniform1i(i.hasTexture_loc,!1),e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(1,3);e.uniform1i(i.refMatrixType_loc,2),e.uniformMatrix4fv(i.refMatrix_loc,!1,this.rotMat._floatArrays);var r=t.renderer;o=!0,r.renderNormals=!1,e.uniform4fv(i.oneColor4_loc,[0,0,0,1]),r.renderVboContainer(e,this.vboKeyContainerEdges,t,i,o),e.enable(e.BLEND),o=!1,r.renderNormals=!0,e.uniform4fv(i.oneColor4_loc,[this.blueFactor,0,0,this.alphaFactor]),r.renderVboContainer(e,this.vboKeyContainer,t,i,o),e.disable(e.BLEND),e.disable(e.POLYGON_OFFSET_FILL)}},CCTV.prototype.makeFrustumGeometry_2=function(e){void 0===e&&(e=new ParametricMesh),e.profile=new Profile;var t,i,o=e.profile,r=this.camera.bigFrustum,n=r.far,a=r.fovyRad/2,s=r.fovRad/2,l=(Math.tan(s),Math.tan(a),o.newOuterRing());(t=l.newElement("POLYLINE")).newPoint2d(-n*Math.sin(s),n*Math.cos(s)),t.newPoint2d(0,0),t.newPoint2d(n*Math.sin(s),n*Math.cos(s));var c,h,d=90-180*s/Math.PI,u=90+180*s/Math.PI;i=l.newElement("ARC"),this.sweepSense=1,i.setCenterPosition(0,0),i.setRadius(n),i.setStartAngleDegree(d),i.setSweepAngleDegree(u-d),i.numPointsFor360Deg=36,c=2*a*180/Math.PI,h=new Segment2D;var f=new Point2D(-1,0),g=new Point2D(1,0);return h.setPoints(f,g),6,e.revolve(o,c,6,h),e},CCTV.prototype.makeFrustumGeometry=function(e){void 0===e&&(e=new Mesh),void 0===e.hedgesList&&(e.hedgesList=new HalfEdgesList);var t,i,o,r,n,a,s=new Point3D(0,0,0),l=this.camera.bigFrustum,c=l.far,h=l.fovyRad/2,d=l.fovRad/2,u=-c*Math.tan(d),f=-u,g=c*Math.tan(h),p=-g,m=new Point3D(u,p,-c),y=new Point3D(f,p,-c),v=new Point3D(f,g,-c),x=new Point3D(u,g,-c),b=new Vertex(s),C=new Vertex(m),M=new Vertex(y),_=new Vertex(v),A=new Vertex(x);void 0===this.vboKeyContainerEdges&&(this.vboKeyContainerEdges=new VBOVertexIdxCacheKeysContainer),(t=e.newSurface().newFace()).addVertex(C),t.addVertex(A),t.addVertex(_),t.addVertex(M);for(var R=0,P=[],T=[],L=t.vertexArray.length,S=0;S<L;S++)i=t.vertexArray[S],a=VertexList.getNextIdx(S,t.vertexArray),o=t.vertexArray[a],r=i.point3d,n=o.point3d,P.push(r.x),P.push(r.y),P.push(r.z),P.push(n.x),P.push(n.y),P.push(n.z),T.push(R),R++,T.push(R),R++;(t=e.newSurface().newFace()).addVertex(b),t.addVertex(_),t.addVertex(A),L=t.vertexArray.length;for(S=0;S<L;S++)i=t.vertexArray[S],a=VertexList.getNextIdx(S,t.vertexArray),o=t.vertexArray[a],r=i.point3d,n=o.point3d,P.push(r.x),P.push(r.y),P.push(r.z),P.push(n.x),P.push(n.y),P.push(n.z),T.push(R),R++,T.push(R),R++;(t=e.newSurface().newFace()).addVertex(b),t.addVertex(A),t.addVertex(C),L=t.vertexArray.length;for(S=0;S<L;S++)i=t.vertexArray[S],a=VertexList.getNextIdx(S,t.vertexArray),o=t.vertexArray[a],r=i.point3d,n=o.point3d,P.push(r.x),P.push(r.y),P.push(r.z),P.push(n.x),P.push(n.y),P.push(n.z),T.push(R),R++,T.push(R),R++;(t=e.newSurface().newFace()).addVertex(b),t.addVertex(C),t.addVertex(M),L=t.vertexArray.length;for(S=0;S<L;S++)i=t.vertexArray[S],a=VertexList.getNextIdx(S,t.vertexArray),o=t.vertexArray[a],r=i.point3d,n=o.point3d,P.push(r.x),P.push(r.y),P.push(r.z),P.push(n.x),P.push(n.y),P.push(n.z),T.push(R),R++,T.push(R),R++;(t=e.newSurface().newFace()).addVertex(b),t.addVertex(M),t.addVertex(_),L=t.vertexArray.length;for(S=0;S<L;S++)i=t.vertexArray[S],a=VertexList.getNextIdx(S,t.vertexArray),o=t.vertexArray[a],r=i.point3d,n=o.point3d,P.push(r.x),P.push(r.y),P.push(r.z),P.push(n.x),P.push(n.y),P.push(n.z),T.push(R),R++,T.push(R),R++;var w=this.vboKeyContainerEdges.newVBOVertexIdxCacheKey();return w.posVboDataArray=Float32Array.from(P),w.idxVboDataArray=Int16Array.from(T),w.indicesCount=w.idxVboDataArray.length,e.calculateVerticesNormals(),e};var CCTVList=function(){if(!(this instanceof CCTVList))throw new Error(Messages.CONSTRUCT_ERROR);this.camerasList=[]};CCTVList.prototype.new_CCTV=function(e){var t=new CCTV;return void 0!==e&&(t.name=e),this.camerasList.push(t),t},CCTVList.prototype.getCCTV=function(e){return this.camerasList[e]},CCTVList.prototype.getCCTVCount=function(){return this.camerasList.length};var Color=function(){if(!(this instanceof Color))throw new Error(Messages.CONSTRUCT_ERROR);this.r=0,this.g=0,this.b=0,this.a=1};Color.prototype.copyFrom=function(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a},Color.prototype.deleteObjects=function(){this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0},Color.prototype.set=function(e,t,i,o){this.r=e,this.g=t,this.b=i,this.a=o},Color.prototype.setRGB=function(e,t,i){this.r=e,this.g=t,this.b=i},Color.prototype.setRGBA=function(e,t,i,o){this.r=e,this.g=t,this.b=i,this.a=o};var SelectionColor=function(){if(!(this instanceof SelectionColor))throw new Error(Messages.CONSTRUCT_ERROR);this.color=new Color};SelectionColor.prototype.init=function(){this.color.r=0,this.color.g=0,this.color.b=0,this.cycle=0},SelectionColor.prototype.getAvailableColor=function(e){return void 0===e&&(e=new Color),e.setRGB(this.color.r,this.color.g,this.color.b),this.color.b+=1,this.color.b>=254&&(this.color.b=0,this.color.g+=1,this.color.g>=254&&(this.color.g=0,this.color.r+=1,this.color.r>=254&&(this.color.r=0,this.cycle+=1))),e},SelectionColor.prototype.decodeColor3=function(e,t,i){return 64516*e+254*t+i};var FBO=function(e,t,i){if(!(this instanceof FBO))throw new Error(Messages.CONSTRUCT_ERROR);if(this.gl=e,this.width=new Int32Array(1),this.height=new Int32Array(1),this.width[0]=t,this.height[0]=i,this.fbo=e.createFramebuffer(),this.depthBuffer=e.createRenderbuffer(),this.colorBuffer=e.createTexture(),this.dirty=!0,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.colorBuffer),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindFramebuffer(e.FRAMEBUFFER,this.fbo),e.bindRenderbuffer(e.RENDERBUFFER,this.depthBuffer),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t,i),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.depthBuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.colorBuffer,0),e.checkFramebufferStatus(e.FRAMEBUFFER)!==e.FRAMEBUFFER_COMPLETE)throw"Incomplete frame buffer object.";e.bindFramebuffer(e.FRAMEBUFFER,null)};FBO.prototype.bind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fbo)},FBO.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)},FBO.prototype.deleteObjects=function(e){this.depthBuffer&&e.deleteRenderbuffer(this.depthBuffer),this.depthBuffer=void 0,this.colorBuffer&&e.deleteTexture(this.colorBuffer),this.colorBuffer=void 0,this.fbo&&e.deleteFramebuffer(this.fbo),this.fbo=void 0};var FileRequestControler=function(){if(!(this instanceof FileRequestControler))throw new Error(Messages.CONSTRUCT_ERROR);this.maxFilesRequestedCount=1,this.filesRequestedCount=0,this.headerFilesRequestedCount=0,this.modelRefFilesRequestedCount=0,this.lowLodDataRequestedCount=0,this.lowLodImagesRequestedCount=0};FileRequestControler.prototype.isFull=function(){return this.filesRequestedCount>=this.maxFilesRequestedCount},FileRequestControler.prototype.isFullHeaders=function(){return this.headerFilesRequestedCount>=1},FileRequestControler.prototype.isFullPlus=function(e){return void 0===e&&(e=0),this.filesRequestedCount>=this.maxFilesRequestedCount+e},FileRequestControler.prototype.isFullPlusModelReferences=function(e){return void 0===e&&(e=0),this.modelRefFilesRequestedCount>=this.maxFilesRequestedCount+e},FileRequestControler.prototype.isFullPlusLowLodData=function(e){return void 0===e&&(e=0),this.lowLodDataRequestedCount>=this.maxFilesRequestedCount+e},FileRequestControler.prototype.isFullPlusLowLodImages=function(e){return void 0===e&&(e=0),this.lowLodImagesRequestedCount>=this.maxFilesRequestedCount+e};var keyFlags={moveForward:!1,moveBackward:!1,moveLeft:!1,moveRight:!1};function getFlagFromKeyCode(e){switch(e){case 37:return"moveLeft";case 38:return"moveForward";case 39:return"moveRight";case 40:return"moveBackward";default:return}}function onKeyDown(e){var t=getFlagFromKeyCode(e.keyCode);void 0!==t&&(keyFlags[t]=!0)}function onKeyUp(e){var t=getFlagFromKeyCode(e.keyCode);void 0!==t&&(keyFlags[t]=!1)}function FirstPersonView(){this._camera=void 0,this._cameraBAK=void 0,this._position=new Point3D,this._rotation=new Point3D,this._positionSpeed=1,this._ratationSpeed=1}Object.defineProperties(FirstPersonView.prototype,{camera:{get:function(){return this._camera},set:function(e){this._camera=e}},position:{get:function(){return this._position},set:function(e){this._position=e}},rotation:{get:function(){return this._rotation},set:function(e){this._rotation=e}},positionSpeed:{get:function(){return this._positionSpeed},set:function(e){this._positionSpeed=e}},rotationSpeed:{get:function(){return this._ratationSpeed},set:function(e){this._ratationSpeed=e}}}),FirstPersonView.prototype.init=function(){this._position.set(0,0,0),this._rotation.set(0,0,0),document.addEventListener("keydown",onKeyDown,!1),document.addEventListener("keyup",onKeyUp,!1)},FirstPersonView.prototype.release=function(){this._camera=void 0,this._cameraBAK=void 0,document.removeEventListener("keydown",onKeyDown,!1),document.removeEventListener("keyup",onKeyUp,!1)},FirstPersonView.prototype.move=function(e){var t=vec3.fromValues(this._position.x,this._position.y,this.position.z),i=mat4.create();mat4.rotateY(i,i,this._rotation.y),vec3.transformMat4(e,e,i),vec3.add(t,t,e),this._position.set(t[0],t[1],t[2])},FirstPersonView.prototype.update=function(e){void 0!==this._camera&&(keyFlags.moveForward&&(this._camera.moveForward(.5),this.move(vec3.fromValues(0,1,0))),keyFlags.moveBackward&&(this._camera.moveBackward(.5),this.move(vec3.fromValues(0,-1,0))),keyFlags.moveLeft&&(this._camera.lookLeft(.1),this.move(vec3.fromValues(-1,0,0))),keyFlags.moveRight&&(this._camera.lookRight(.1),this.move(vec3.fromValues(1,0,0))))};var Frustum=function(){if(!(this instanceof Frustum))throw new Error(Messages.CONSTRUCT_ERROR);this.near=new Float32Array([.1]),this.far=new Float32Array([1e3]),this.fovyRad=new Float32Array([.8037]),this.tangentOfHalfFovy=new Float32Array([0]),this.fovRad=new Float32Array([1.047]),this.aspectRatio=new Float32Array([1.3584]),this.planesArray=[],this.dirty=!0;for(var e=0;e<6;e++){var t=new Plane;this.planesArray.push(t)}};Frustum.prototype.copyParametersFrom=function(e){this.near[0]=e.near[0],this.far[0]=e.far[0],this.fovyRad[0]=e.fovyRad[0],this.tangentOfHalfFovy[0]=e.tangentOfHalfFovy[0],this.fovRad[0]=e.fovRad[0],this.aspectRatio[0]=e.aspectRatio[0]},Frustum.prototype.setNear=function(e){this.near[0]=e},Frustum.prototype.setFar=function(e){this.far[0]=e},Frustum.prototype.intersectionNearFarSphere=function(e){for(var t=!1,i=0;i<2;i++){var o=this.planesArray[i].intersectionSphere(e);if(o===Constant.INTERSECTION_OUTSIDE)return Constant.INTERSECTION_OUTSIDE;o===Constant.INTERSECTION_INTERSECT&&(t=!0)}return t?Constant.INTERSECTION_INTERSECT:Constant.INTERSECTION_INSIDE},Frustum.prototype.intersectionSphere=function(e){for(var t=!1,i=0;i<6;i++){var o=this.planesArray[i].intersectionSphere(e);if(o===Constant.INTERSECTION_OUTSIDE)return Constant.INTERSECTION_OUTSIDE;o===Constant.INTERSECTION_INTERSECT&&(t=!0)}return t?Constant.INTERSECTION_INTERSECT:Constant.INTERSECTION_INSIDE};var FrustumVolumeControl=function(){if(!(this instanceof FrustumVolumeControl))throw new Error(Messages.CONSTRUCT_ERROR);this.frustumVolumensMap={}};FrustumVolumeControl.prototype.getFrustumVolumeCulling=function(e){return this.frustumVolumensMap.hasOwnProperty(e)||(this.frustumVolumensMap[e]={},this.frustumVolumensMap[e].fullyIntersectedLowestTilesArray=[],this.frustumVolumensMap[e].partiallyIntersectedLowestTilesArray=[],this.frustumVolumensMap[e].visibleNodes=new VisibleObjectsController),this.frustumVolumensMap[e]},FrustumVolumeControl.prototype.initArrays=function(){var e;for(var t in this.frustumVolumensMap)(e=this.frustumVolumensMap[t]).fullyIntersectedLowestTilesArray.length=0,e.partiallyIntersectedLowestTilesArray.length=0,e.visibleNodes.initArrays()};var GeographicCoord=function(e,t,i){if(!(this instanceof GeographicCoord))throw new Error(Messages.CONSTRUCT_ERROR);this.longitude,this.latitude,this.altitude,void 0!==e&&(this.longitude=e),void 0!==t&&(this.latitude=t),void 0!==i&&(this.altitude=i)};GeographicCoord.prototype.deleteObjects=function(){this.longitude=void 0,this.latitude=void 0,this.altitude=void 0},GeographicCoord.prototype.copyFrom=function(e){this.longitude=e.longitude,this.latitude=e.latitude,this.altitude=e.altitude},GeographicCoord.prototype.setLonLatAlt=function(e,t,i){this.longitude=e,this.latitude=t,this.altitude=i},GeographicCoord.getMidPoint=function(e,t,i){var o=(e.latitude+t.latitude)/2,r=(e.longitude+t.longitude)/2,n=(e.altitude+t.altitude)/2;return void 0===i?i=new GeographicCoord(r,o,n):i.setLonLatAlt(r,o,n),i};var GeographicExtent=function(){if(!(this instanceof GeographicExtent))throw new Error(Messages.CONSTRUCT_ERROR);this.minGeographicCoord,this.maxGeographicCoord},GeoLocationData=function(e){if(!(this instanceof GeoLocationData))throw new Error(Messages.CONSTRUCT_ERROR);this.name,this.name=void 0===e?"noName":e,this.geographicCoord,this.heading,this.pitch,this.roll,this.date,this.position,this.positionHIGH,this.positionLOW,this.pivotPoint,this.geoLocMatrix,this.geoLocMatrixInv,this.tMatrix,this.tMatrixInv,this.rotMatrix,this.rotMatrixInv,this.pivotPointTraslation};GeoLocationData.prototype.deleteObjects=function(){this.name=void 0,this.geographicCoord&&this.geographicCoord.deleteObjects(),this.geographicCoord=void 0,this.heading=void 0,this.pitch=void 0,this.roll=void 0,this.date=void 0,this.position&&this.position.deleteObjects(),this.position=void 0,this.positionHIGH=void 0,this.positionLOW=void 0,this.pivotPoint&&this.pivotPoint.deleteObjects(),this.pivotPoint=void 0,this.geoLocMatrix&&this.geoLocMatrix.deleteObjects(),this.geoLocMatrixInv&&this.geoLocMatrixInv.deleteObjects(),this.tMatrix&&this.tMatrix.deleteObjects(),this.tMatrixInv&&this.tMatrixInv.deleteObjects(),this.rotMatrix&&this.rotMatrix.deleteObjects(),this.rotMatrixInv&&this.rotMatrixInv.deleteObjects(),this.geoLocMatrix=void 0,this.geoLocMatrixInv=void 0,this.tMatrix=void 0,this.tMatrixInv=void 0,this.rotMatrix=void 0,this.rotMatrixInv=void 0,this.pivotPointTraslation&&this.pivotPointTraslation.deleteObjects(),this.pivotPointTraslation=void 0},GeoLocationData.prototype.doEffectivePivotPointTranslation=function(){var e;void 0!==this.pivotPointTraslation&&(e=this.tMatrix.rotatePoint3D(this.pivotPointTraslation,e),this.position.x+=e.x,this.position.y+=e.y,this.position.z+=e.z,this.positionLOW[0]+=e.x,this.positionLOW[1]+=e.y,this.positionLOW[2]+=e.z,void 0===this.pivotPoint&&(this.pivotPoint=new Point3D),this.pivotPoint.set(this.position.x,this.position.y,this.position.z))},GeoLocationData.prototype.copyFrom=function(e){void 0!==e&&(this.name=e.name,e.geographicCoord&&(void 0===this.geographicCoord&&(this.geographicCoord=new GeographicCoord),this.geographicCoord.copyFrom(e.geographicCoord)),this.heading=e.heading,this.pitch=e.pitch,this.roll=e.roll,this.date=e.date,e.position&&(void 0===this.position&&(this.position=new Point3D),this.position.copyFrom(e.position)),e.positionHIGH&&(void 0===this.positionHIGH&&(this.positionHIGH=new Float32Array(3)),this.positionHIGH[0]=e.positionHIGH[0],this.positionHIGH[1]=e.positionHIGH[1],this.positionHIGH[2]=e.positionHIGH[2]),e.positionLOW&&(void 0===this.positionLOW&&(this.positionLOW=new Float32Array(3)),this.positionLOW[0]=e.positionLOW[0],this.positionLOW[1]=e.positionLOW[1],this.positionLOW[2]=e.positionLOW[2]),e.pivotPoint&&(void 0===this.pivotPoint&&(this.pivotPoint=new Point3D),this.pivotPoint.copyFrom(e.pivotPoint)),e.geoLocMatrix&&(void 0===this.geoLocMatrix&&(this.geoLocMatrix=new Matrix4),this.geoLocMatrix.copyFromMatrix4(e.geoLocMatrix)),e.geoLocMatrixInv&&(void 0===this.geoLocMatrixInv&&(this.geoLocMatrixInv=new Matrix4),this.geoLocMatrixInv.copyFromMatrix4(e.geoLocMatrixInv)),e.tMatrix&&(void 0===this.tMatrix&&(this.tMatrix=new Matrix4),this.tMatrix.copyFromMatrix4(e.tMatrix)),e.tMatrixInv&&(void 0===this.tMatrixInv&&(this.tMatrixInv=new Matrix4),this.tMatrixInv.copyFromMatrix4(e.tMatrixInv)),e.rotMatrix&&(void 0===this.rotMatrix&&(this.rotMatrix=new Matrix4),this.rotMatrix.copyFromMatrix4(e.rotMatrix)),e.rotMatrixInv&&(void 0===this.rotMatrixInv&&(this.rotMatrixInv=new Matrix4),this.rotMatrixInv.copyFromMatrix4(e.rotMatrixInv)),e.aditionalTraslation&&(void 0===this.aditionalTraslation&&(this.aditionalTraslation=new Point3D),this.aditionalTraslation.copyFrom(e.aditionalTraslation)))},GeoLocationData.prototype.localCoordToWorldCoord=function(e,t){if(void 0!==e&&void 0!==this.tMatrix)return void 0===t&&(t=new Point3D),t=this.tMatrix.transformPoint3D(e,t)},GeoLocationData.prototype.worldCoordToLocalCoord=function(e,t){if(void 0!==e&&void 0!==this.tMatrixInv)return void 0===t&&(t=new Point3D),t=this.tMatrixInv.transformPoint3D(e,t)},GeoLocationData.prototype.getTransformedRelativeCamera=function(e,t){var i=new Point3D;return i.set(e.position.x-this.position.x,e.position.y-this.position.y,e.position.z-this.position.z),t.position=this.rotMatrixInv.transformPoint3D(i,t.position),i.set(e.direction.x,e.direction.y,e.direction.z),t.direction=this.rotMatrixInv.transformPoint3D(i,t.direction),i.set(e.up.x,e.up.y,e.up.z),t.up=this.rotMatrixInv.transformPoint3D(i,t.up),i.x=void 0,i.y=void 0,i.z=void 0,i=void 0,t};var GeoLocationDataManager=function(){if(!(this instanceof GeoLocationDataManager))throw new Error(Messages.CONSTRUCT_ERROR);this.geoLocationDataArray=[]};GeoLocationDataManager.prototype.deleteObjects=function(){if(this.geoLocationDataArray){for(var e=0;e<this.geoLocationDataArray.length;e++)this.geoLocationDataArray[e].deleteObjects(),this.geoLocationDataArray[e]=void 0;this.geoLocationDataArray=void 0}},GeoLocationDataManager.prototype.newGeoLocationData=function(e){void 0===e&&(e="noName"+this.geoLocationDataArray.length.toString());var t=new GeoLocationData(e);return this.geoLocationDataArray.push(t),t},GeoLocationDataManager.prototype.getGeoLocationData=function(e){if(!(e>this.geoLocationDataArray.length-1))return this.geoLocationDataArray[e]},GeoLocationDataManager.prototype.getCurrentGeoLocationData=function(){if(0!==this.geoLocationDataArray.length)return this.geoLocationDataArray[0]};var GeometryModifier=function(){if(!(this instanceof GeometryModifier))throw new Error(Messages.CONSTRUCT_ERROR)};GeometryModifier.prototype.setPoint3d=function(e,t,i,o){e.x=t,e.y=i,e.z=o},GeometryModifier.prototype.point3dSquareDistTo=function(e,t,i,o){var r=e.x-t,n=e.y-i,a=e.z-o;return r*r+n*n+a*a},GeometryModifier.prototype.Matrix4SetByFloat32Array=function(e,t){for(var i=0;i<16;i++)e._floatArrays[i]=t[i]},GeometryModifier.prototype.Matrix4TransformPoint3D=function(e,t){var i=new Point3D;return i.x=t.x*e._floatArrays[0]+t.y*e._floatArrays[4]+t.z*e._floatArrays[8]+e._floatArrays[12],i.y=t.x*e._floatArrays[1]+t.y*e._floatArrays[5]+t.z*e._floatArrays[9]+e._floatArrays[13],i.z=t.x*e._floatArrays[2]+t.y*e._floatArrays[6]+t.z*e._floatArrays[10]+e._floatArrays[14],i},GeometryModifier.prototype.Matrix4GetMultipliedByMatrix=function(e,t){for(var i=new Matrix4,o=0;o<4;o++)for(var r=0;r<4;r++){var n=4*o+r;i._floatArrays[n]=0;for(var a=0;a<4;a++)i._floatArrays[n]+=t._floatArrays[4*a+r]*e._floatArrays[4*o+a]}return i},GeometryModifier.prototype.referenceMultiplyTransformMatrix=function(e,t){var i=this.Matrix4GetMultipliedByMatrix(e._matrix4,t);e._matrix4=i},GeometryModifier.prototype.compoundReferencesListMultiplyReferencesMatrices=function(e,t){for(var i=e._compoundRefsArray.length,o=0;o<i;o++)for(var r=e._compoundRefsArray[o],n=r._referencesList.length,a=0;a<n;a++){var s=r._referencesList[a];this.referenceMultiplyTransformMatrix(s,t)}},GeometryModifier.prototype.compoundReferencesListGetVisibleCompRefObjectsList=function(e,t,i,o){var r=new CompoundReferencesList;r._myBlocksList=e._myBlocksList;var n=e._ocCulling._ocCulling_box,a=this.occlusionCullingOctreeCellGetIndicesVisiblesForEye(n,t,i,o);if(a)for(var s=a.length,l=0;l<s;l++)r._compoundRefsArray.push(e._compoundRefsArray[a[l]]);var c=e._ocCulling._infinite_ocCulling_box,h=this.occlusionCullingOctreeCellGetIndicesVisiblesForEye(c,eye_x,eye_y,eye_z);if(h)for(s=h.length,l=0;l<s;l++)r._compoundRefsArray.push(e._compoundRefsArray[h[l]]);return r&&0===r.length?null:r},GeometryModifier.prototype.compoundReferencesListContainerGetVisibleCompRefObjectsList=function(e,t,i,o){for(var r=[],n=void 0,a=e.compRefsListArray.length,s=0;s<a;s++){n=e.compRefsListArray[s];var l=this.compoundReferencesListGetVisibleCompRefObjectsList(n,t,i,o);null!==l&&r.push(l)}return r},GeometryModifier.prototype.bRbuildingProjectGetVisibleCompRefLists=function(e,t,i,o){var r=e._interiorCompRefList_Container,n=this.compoundReferencesListContainerGetVisibleCompRefObjectsList(r,eye_x,eye_y,eye_z),a=e._compRefList_Container;return this.compoundReferencesListContainerGetVisibleCompRefObjectsList(a,t,i,o).concat(n)},GeometryModifier.prototype.occlusionCullingOctreeCellSetDimensions=function(e,t,i,o,r,n,a){e.minX=t,e.maxX=i,e.minY=o,e.maxY=r,e.minZ=n,e.maxZ=a},GeometryModifier.prototype.occlusionCullingOctreeCellSetSizesSubBoxes=function(e){if(e._subBoxesArray.length>0){var t=(e.maxX+e.minX)/2,i=(e.maxY+e.minY)/2,o=(e.maxZ+e.minZ)/2;this.occlusionCullingOctreeCellSetDimensions(e._subBoxesArray[0],e.minX,t,e.minY,i,e.minZ,o),this.occlusionCullingOctreeCellSetDimensions(e._subBoxesArray[1],t,e.maxX,e.minY,i,e.minZ,o),this.occlusionCullingOctreeCellSetDimensions(e._subBoxesArray[2],t,e.maxX,i,e.maxY,e.minZ,o),this.occlusionCullingOctreeCellSetDimensions(e._subBoxesArray[3],e.minX,t,i,e.maxY,e.minZ,half_z),this.occlusionCullingOctreeCellSetDimensions(e._subBoxesArray[4],e.minX,t,e.minY,i,o,e.maxZ),this.occlusionCullingOctreeCellSetDimensions(e._subBoxesArray[5],t,e.maxX,e.minY,i,o,e.maxZ),this.occlusionCullingOctreeCellSetDimensions(e._subBoxesArray[6],t,e.maxX,i,e.maxY,o,e.maxZ),this.occlusionCullingOctreeCellSetDimensions(e._subBoxesArray[7],e.minX,t,i,e.maxY,o,e.maxZ);for(var r=0;r<e._subBoxesArray.length;r++)this.occlusionCullingOctreeCellSetSizesSubBoxes(e._subBoxesArray[r])}},GeometryModifier.prototype.occlusionCullingOctreeCellIntersectsWithPoint3D=function(e,t,i,o){var r=!1;return t>e.minX&&t<e.maxX&&i>e.minY&&i<e.maxY&&o>e.minZ&&o<e.maxZ&&(r=!0),r},GeometryModifier.prototype.occlusionCullingOctreeCellGetIntersectedSubBoxByPoint3D=function(e,t,i,o){var r=null;if(null===e._ocCulling_Cell_owner&&!this.occlusionCullingOctreeCellIntersectsWithPoint3D(e,t,i,o))return null;if(e._subBoxesArray.length>0){var n,a=(e.minX+e.maxX)/2,s=(e.minY+e.maxY)/2,l=(e.minZ+e.maxZ)/2,c=void 0;c=t<a?i<s?o<l?0:4:o<l?3:7:i<center_y?o<center_z?1:5:o<center_z?2:6,n=e._subBoxesArray[c],r=this.occlusionCullingOctreeCellGetIntersectedSubBoxByPoint3D(n,t,i,o)}else r=e;return r},GeometryModifier.prototype.occlusionCullingOctreeCellGetIndicesVisiblesForEye=function(e,t,i,o){var r=null,n=this.occlusionCullingOctreeCellGetIntersectedSubBoxByPoint3D(e,t,i,o);return null!==n&&n._indicesArray.length>0&&(r=n._indicesArray),r},GeometryModifier.prototype.occlusionCullingOctreeCellExpandBox=function(e,t){e.minX-=t,e.maxX+=t,e.minY-=t,e.maxY+=t,e.minZ-=t,e.maxZ+=t},GeometryModifier.prototype.vertexTexcoordsArraysCacheKeysContainerNewVertexTexcoordsArraysCacheKey=function(e){var t=new VertexTexcoordsArraysCacheKeys;return e._vtArrays_cacheKeys_array.push(t),t},GeometryModifier.prototype.blocksListGetBlock=function(e,t){var i=null;return t>=0&&t<e.blocksArray.length&&(i=e.blocksArray[t]),i},GeometryModifier.prototype.blocksListsContainerNewBlocksList=function(e,t){var i=new BlocksList;return i.name=t,e.blocksListsArray.push(i),i},GeometryModifier.prototype.blocksListsContainerGetBlockList=function(e,t){for(var i=e.blocksListsArray.length,o=!1,r=0,n=null;!o&&r<i;){var a=e.blocksListsArray[r];a.name===t&&(o=!0,n=a),r++}return n},GeometryModifier.prototype.bRbuildingProjectCreateDefaultBlockReferencesLists=function(e){this.f4dBlocksListsContainerNewBlocksList(e._blocksList_Container,"Blocks1"),this.f4dBlocksListsContainerNewBlocksList(e._blocksList_Container,"Blocks2"),this.f4dBlocksListsContainerNewBlocksList(e._blocksList_Container,"Blocks3"),this.f4dBlocksListsContainerNewBlocksList(e._blocksList_Container,"Blocks4"),this.f4dBlocksListsContainerNewBlocksList(e._blocksList_Container,"BlocksBone")},GeometryModifier.prototype.bRbuildingProjectsListNewBRProject=function(e){var t=new BRBuildingProject;return this.bRbuildingProjectCreateDefaultBlockReferencesLists(t),e._BR_buildingsArray.push(t),t};var Globe=function(){if(!(this instanceof Globe))throw new Error(Messages.CONSTRUCT_ERROR);this.equatorialRadius=6378137,this.polarRadius=6356752.3142,this.firstEccentricitySquared=.00669437999014,this.secondEccentricitySquared=.00673949674228,this.degToRadFactor=Math.PI/180};Globe.equatorialRadius=function(){return 6378137},Globe.prototype.normalizeCartesian=function(e){if(void 0!==e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return e[0]/=t,e[1]/=t,e[2]/=t,e}},Globe.prototype.transformMatrixAtCartesianPointWgs84=function(e,t,i,o){var r,n;n=this.normalAtCartesianPointWgs84(e,t,i,n),(r=new Float32Array(3))[0]=-t,r[1]=e,r[2]=0,r=this.normalizeCartesian(r);var a=new Point3D(r[0],r[1],r[2]),s=new Point3D,l=new Point3D(n[0],n[1],n[2]);return s=l.crossProduct(a,s),void 0===o&&(o=new Float32Array(16)),o[0]=a.x,o[1]=a.y,o[2]=a.z,o[3]=0,o[4]=s.x,o[5]=s.y,o[6]=s.z,o[7]=0,o[8]=l.x,o[9]=l.y,o[10]=l.z,o[11]=0,o[12]=e,o[13]=t,o[14]=i,o[15]=1,o},Globe.prototype.intersectionLineWgs84=function(e,t,i){var o=e.point,r=e.direction,n=new Point3D(o.x+1e3*r.x,o.y+1e3*r.y,o.z+1e3*r.z),a=o.x,s=o.y,l=o.z,c=n.x,h=n.y,d=n.z,u=this.equatorialRadius;void 0!==i&&(u=i);var f=c-a,g=h-s,p=d-l,m=f*f+g*g+p*p,y=2*(f*(a-0)+g*(s-0)+p*(l-0)),v=y*y-4*m*(0+a*a+s*s+l*l-2*(0*a+0*s+0*l)-u*u);if(!(v<0)){if(0===v){void 0===t&&(t=new Float32Array(3));var x=new Point3D(a+(c-a)*(b=-y/(2*m)),s+(h-s)*b,l+(d-l)*b);t[0]=x.x,t[1]=x.y,t[2]=x.z}else{var b=(-y+Math.sqrt(v))/(2*m),C=(-y-Math.sqrt(v))/(2*m),M=(x=new Point3D(a+(c-a)*b,s+(h-s)*b,l+(d-l)*b),new Point3D(a+(c-a)*C,s+(h-s)*C,l+(d-l)*C)),_=o.squareDistToPoint(x),A=o.squareDistToPoint(M);void 0===t&&(t=new Float32Array(3)),_<A?(t[0]=x.x,t[1]=x.y,t[2]=x.z):(t[0]=M.x,t[1]=M.y,t[2]=M.z)}return t}},Globe.prototype.normalAtCartesianPointWgs84=function(e,t,i,o){void 0===o&&(o=new Float32Array(3));var r=this.equatorialRadius*this.equatorialRadius,n=this.polarRadius*this.polarRadius;return o[0]=e/r,o[1]=t/r,o[2]=i/n,o=this.normalizeCartesian(o)},Globe.CartesianToGeographicWgs84=function(e,t,i,o){var r,n,a,s,l,c,h,d,u,f,g,p,m,y,v,x=e,b=t,C=i,M=x*x+b*b,_=Math.sqrt(M),A=6378137,R=1/(A*A),P=.00669437999014,T=P*P,L=M*R,S=C*C*(1-P)*R,w=(L+S-T)/6,E=8*w*w*w+T*L*S;E>0||0!=S?(E>0?(s=Math.sqrt(E),l=Math.sqrt(T*L*S),a=E>10*P?w+.5*(c=Math.cbrt((s+l)*(s+l)))+2*w*w/c:w+.5*Math.cbrt((s+l)*(s+l))+.5*Math.cbrt((s-l)*(s-l))):(s=Math.sqrt(-E),l=Math.sqrt(-8*w*w*w),c=Math.sqrt(T*L*S),h=2*Math.atan2(c,s+l)/3,a=-4*w*Math.sin(h)*Math.cos(Math.PI/6+h)),u=P*(a+(d=Math.sqrt(a*a+T*S))-S)/(2*d),g=(f=(a+d)/(Math.sqrt(u*u+a+d)+u))*_/(f+P),r=(f+P-1)*(p=Math.sqrt(g*g+C*C))/f,n=2*Math.atan2(C,p+g)):(r=-A*(s=Math.sqrt(1-P))*(l=Math.sqrt(P-L))/(m=Math.sqrt(P)),n=l/(m*l+s*Math.sqrt(L))),y=((v=Math.sqrt(2))-1)*b<_+x?2*Math.atan2(b,_+x):_+b<(v+1)*x?.5*-Math.PI+2*Math.atan2(x,_-b):.5*Math.PI-2*Math.atan2(x,_+b),void 0===o&&(o=new GeographicCoord);var D=180/Math.PI;return o.latitude=D*n,o.longitude=D*y,o.altitude=r,o},Globe.geographicToCartesianWgs84=function(e,t,i,o){var r=Math.PI/180,n=e*r,a=t*r,s=Math.cos(n),l=Math.cos(a),c=Math.sin(n),h=Math.sin(a),d=.00669437999014,u=6378137/Math.sqrt(1-d*h*h),f=i;return void 0===o&&(o=new Float32Array(3)),o[0]=(u+f)*l*s,o[1]=(u+f)*l*c,o[2]=(u*(1-d)+f)*h,o},Globe.geographicRadianArrayToFloat32ArrayWgs84=function(e,t,i,o){var r,n,a,s,l,c,h,d,u=.00669437999014,f=e.length;o=new Float32Array(3*f);for(var g=0;g<f;g++)r=e[g],n=t[g],a=Math.cos(r),s=Math.cos(n),l=Math.sin(r),c=Math.sin(n),h=6378137/Math.sqrt(1-u*c*c),d=i[g],o[3*g]=(h+d)*s*a,o[3*g+1]=(h+d)*s*l,o[3*g+2]=(.99330562000986*h+d)*c;return o};var GlobeTile=function(){if(!(this instanceof GlobeTile))throw new Error(Messages.CONSTRUCT_ERROR);this.globeTileOwner,this.depth,this.numberName,this.minGeographicCoord,this.maxGeographicCoord,this.subTilesArray};GlobeTile.prototype.newSubTile=function(){var e=this.subTilesArray.length,t=new GlobeTile;return t.depth=this.depth+1,t.numberName=10*this.numberName+e+1,this.subTilesArray.push(t),t};var MagoManager=function(){if(!(this instanceof MagoManager))throw new Error(Messages.CONSTRUCT_ERROR);this.tinTerrainManager=new TinTerrainManager,this.renderer=new Renderer,this.selectionCandidates=new SelectionCandidates,this.shadersManager=new ShadersManager,this.postFxShadersManager=new PostFxShadersManager,this.vBOManager=new VBOManager,this.readerWriter=new ReaderWriter,this.magoPolicy=new Policy;var e=MagoConfig.getPolicy();void 0!==e&&(this.magoPolicy.setLod0DistInMeters(e.geo_lod0),this.magoPolicy.setLod1DistInMeters(e.geo_lod1),this.magoPolicy.setLod2DistInMeters(e.geo_lod2),this.magoPolicy.setLod3DistInMeters(e.geo_lod3),this.magoPolicy.setLod4DistInMeters(e.geo_lod4),this.magoPolicy.setLod5DistInMeters(e.geo_lod5)),this.smartTileManager=new SmartTileManager,this.processQueue=new ProcessQueue,this.parseQueue=new ParseQueue,this.loadQueue=new LoadQueue(this),this.hierarchyManager=new HierarchyManager,this.inspectorBox=new InspectorBox,this.noiseTexture,this.depthFbo,this.normalFbo,this.ssaoFbo,this.pixels=new Uint8Array(64),this.depthFboNeo,this.ssaoFboNeo,this.selectionFbo,this.handler,this.mouse_x=0,this.mouse_y=0,this.mouseLeftDown=!1,this.mouseMiddleDown=!1,this.mouseDragging=!1,this.selObjMovePlane,this.objectSelected,this.buildingSelected,this.octreeSelected,this.nodeSelected,this.mustCheckIfDragging=!0,this.thereAreStartMovePoint=!1,this.startMovPoint=new Point3D,this.TEST_maxWheelZoomAmount=0,this.TEST_maxZoomAmount=0,this.configInformation,this.cameraFPV=new FirstPersonView,this.myCameraSCX,this.lightCam,this.magoGeometryTest,this.kernel=[.33,0,.85,.25,.3,.5,.1,.3,.85,-.15,.2,.85,-.33,.05,.6,-.1,-.15,.85,-.05,-.32,.25,.2,-.15,.85,.6,0,.55,.5,.6,.45,-.01,.7,.35,-.33,.5,.45,-.45,0,.55,-.65,-.5,.7,0,-.5,.55,.33,.3,.35],this.atmosphere=new Atmosphere,this.sceneState=new SceneState,this.selectionColor=new SelectionColor,this.vboMemoryManager=new VBOMemoryManager,this.fileRequestControler=new FileRequestControler,this.visibleObjControlerOctrees=new VisibleObjectsController,this.visibleObjControlerNodes=new VisibleObjectsController,this.visibleObjControlerTerrain=new VisibleObjectsController,this.boundingSphere_Aux,this.radiusAprox_aux,this.lastCamPos=new Point3D,this.squareDistUmbral=22,this.lowestOctreeArray=[],this.backGround_fileReadings_count=0,this.backGround_imageReadings_count=0,this.isCameraMoving=!1,this.isCameraInsideNeoBuilding=!1,this.renderingFase=0,this.bPicking=!1,this.scene,this.numFrustums,this.isLastFrustum=!1,this.currentFrustumIdx=0,this.highLightColor4=new Float32Array([.2,1,.2,1]),this.thereAreUrgentOctrees=!1,this.hierarchyManager=new HierarchyManager,this.smallObjectSize=.153,this.sqrtTable=new Float32Array(11);for(var t=0;t<11;t++)this.sqrtTable[t]=Math.sqrt(1+.1*t*(.1*t));this.managerUtil=new ManagerUtils,this.currentSelectedObj_idx=-1,this.currentByteColorPicked=new Uint8Array(4),this.currentShader,this.pointSC=new Point3D,this.pointSC_2=new Point3D,this.arrayAuxSC=[],this.currentTimeSC,this.dateSC,this.startTimeSC,this.maxMilisecondsForRender=10,this.terranTileSC,this.textureAux_1x1,this.resultRaySC=new Float32Array(3),this.matrix4SC=new Matrix4,this.unitaryBoxSC=new BoxAux,this.unitaryBoxSC.makeAABB(1,1,1),this.unitaryBoxSC.vBOVertexIdxCacheKey=this.unitaryBoxSC.triPolyhedron.getVBOArrayModePosNorCol(this.unitaryBoxSC.vBOVertexIdxCacheKey),this.axisXYZ=new AxisXYZ,this.invertedBox=new Box;var i=this.invertedBox.makeMesh(1.5,1.5,1.5);i.reverseSense(),i.getVbo(this.invertedBox.vbo_vicks_container),i.getVboEdges(this.invertedBox.vbo_vicks_containerEdges),this.demoBlocksLoaded=!1,this.objMarkerManager=new ObjectMarkerManager,this.pin=new Pin};function genNoiseTextureRGBA(e,t,i,o){var r=e.createTexture();if(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,r),4===t&&4===i){var n=0;o[n]=50,o[++n]=58,o[++n]=229,o[++n]=120,o[++n]=212,o[++n]=236,o[++n]=251,o[++n]=148,o[++n]=75,o[++n]=92,o[++n]=246,o[++n]=59,o[++n]=197,o[++n]=95,o[++n]=235,o[++n]=216,o[++n]=130,o[++n]=124,o[++n]=215,o[++n]=154,o[++n]=25,o[++n]=41,o[++n]=221,o[++n]=146,o[++n]=187,o[++n]=217,o[++n]=130,o[++n]=199,o[++n]=142,o[++n]=112,o[++n]=61,o[++n]=135,o[++n]=67,o[++n]=125,o[++n]=159,o[++n]=153,o[++n]=215,o[++n]=49,o[++n]=49,o[++n]=69,o[++n]=126,o[++n]=168,o[++n]=61,o[++n]=215,o[++n]=21,o[++n]=93,o[++n]=183,o[++n]=1,o[++n]=125,o[++n]=44,o[++n]=22,o[++n]=130,o[++n]=197,o[++n]=118,o[++n]=109,o[++n]=23,o[++n]=195,o[++n]=4,o[++n]=148,o[++n]=245,o[++n]=124,o[++n]=125,o[++n]=185,o[++n]=28,n++}else for(var a=0;a<i;a++)for(var s=0;s<t;s++)o[4*(a*t+s)+0]=Math.floor(255*Math.random()),o[4*(a*t+s)+1]=Math.floor(255*Math.random()),o[4*(a*t+s)+2]=Math.floor(255*Math.random()),o[4*(a*t+s)+3]=Math.floor(255*Math.random());return e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,e.UNSIGNED_BYTE,o),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.bindTexture(e.TEXTURE_2D,null),r.width=t,r.height=i,r}function handleTextureLoaded(e,t,i){e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_NEAREST),e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null)}MagoManager.prototype.start=function(e,t,i,o){if(this.magoPolicy.getMagoEnable()){var r=!1;if(this.numFrustums=o,this.currentFrustumIdx=this.numFrustums-i-1,this.currentFrustumIdx===o-1&&(r=!0,this.isLastFrustum=!0),t.pick);else{if(void 0===this.configInformation&&(this.configInformation=MagoConfig.getPolicy()),e){var n=e.context._gl;if(n.getExtension("EXT_frag_depth"),n.isContextLost())return;this.sceneState.gl=n}this.startRender(e,r,this.currentFrustumIdx,o)}}},MagoManager.prototype.render=function(e){e.addOrderedRenderable(this,1e3)},MagoManager.prototype.renderOrdered=function(e){void 0===this.configInformation&&(this.configInformation=MagoConfig.getPolicy());this.sceneState.dc=e,this.sceneState.gl=e.currentGlContext,this.startRender(void 0,!0,0,1)},MagoManager.prototype.swapRenderingFase=function(){this.renderingFase=!this.renderingFase},MagoManager.prototype.renderAtmosphere=function(e,t,i,o){var r=this.atmosphere.cloudsManager.circularCloudsArray.length;if(0!==r){var n=Cesium.EncodedCartesian3.encode(t.x),a=Cesium.EncodedCartesian3.encode(t.y),s=Cesium.EncodedCartesian3.encode(t.z);this.encodedCamPosMC_High[0]=n.high,this.encodedCamPosMC_High[1]=a.high,this.encodedCamPosMC_High[2]=s.high,this.encodedCamPosMC_Low[0]=n.low,this.encodedCamPosMC_Low[1]=a.low,this.encodedCamPosMC_Low[2]=s.low;var l,c=this.shadersManager.getMagoShader(4),h=c.SHADER_PROGRAM;e.useProgram(h),e.enableVertexAttribArray(c._color),e.enableVertexAttribArray(c._position),Cesium.Matrix4.toArray(o,this.modelViewProjRelToEye_matrix),e.uniformMatrix4fv(c._ModelViewProjectionMatrixRelToEye,!1,this.modelViewProjRelToEye_matrix),e.uniform3fv(c._encodedCamPosHIGH,this.encodedCamPosMC_High),e.uniform3fv(c._encodedCamPosLOW,this.encodedCamPosMC_Low),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.depthRange(0,1);for(var d=0;d<r;d++)l=this.atmosphere.cloudsManager.circularCloudsArray[d],e.uniform3fv(c._cloudPosHIGH,l.positionHIGH),e.uniform3fv(c._cloudPosLOW,l.positionLOW),void 0===l.vbo_vertexCacheKey&&(l.vbo_vertexCacheKey=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,l.vbo_vertexCacheKey),e.bufferData(e.ARRAY_BUFFER,l.getVBOVertexColorFloatArray(),e.STATIC_DRAW)),void 0===l.vbo_indexCacheKey&&(l.vbo_indexCacheKey=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,l.vbo_indexCacheKey),e.bufferData(e.ELEMENT_ARRAY_BUFFER,l.getVBOIndicesShortArray(),e.STATIC_DRAW)),e.bindBuffer(e.ARRAY_BUFFER,l.vbo_vertexCacheKey),e.vertexAttribPointer(c._position,3,e.FLOAT,!1,24,0),e.vertexAttribPointer(c._color,3,e.FLOAT,!1,24,12),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,l.vbo_indexCacheKey),e.drawElements(e.TRIANGLES,l.indicesCount,e.UNSIGNED_SHORT,0);e.disableVertexAttribArray(c._color),e.disableVertexAttribArray(c._position),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)}},MagoManager.prototype.renderCloudShadows=function(e,t,i,o){var r=this.atmosphere.cloudsManager.circularCloudsArray.length;if(0!==r){var n=Cesium.EncodedCartesian3.encode(t.x),a=Cesium.EncodedCartesian3.encode(t.y),s=Cesium.EncodedCartesian3.encode(t.z);this.encodedCamPosMC_High[0]=n.high,this.encodedCamPosMC_High[1]=a.high,this.encodedCamPosMC_High[2]=s.high,this.encodedCamPosMC_Low[0]=n.low,this.encodedCamPosMC_Low[1]=a.low,this.encodedCamPosMC_Low[2]=s.low;var l,c=this.shadersManager,h=c.getMagoShader(4),d=h.SHADER_PROGRAM;e.useProgram(d),e.enableVertexAttribArray(h._position),Cesium.Matrix4.toArray(o,this.modelViewProjRelToEye_matrix),e.uniformMatrix4fv(h._ModelViewProjectionMatrixRelToEye,!1,this.modelViewProjRelToEye_matrix),e.uniform3fv(h._encodedCamPosHIGH,this.encodedCamPosMC_High),e.uniform3fv(h._encodedCamPosLOW,this.encodedCamPosMC_Low),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.depthRange(0,1),e.colorMask(!1,!1,!1,!1),e.depthMask(!1),e.enable(e.CULL_FACE),e.enable(e.STENCIL_TEST),e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(1,2),e.cullFace(e.FRONT),e.stencilFunc(e.ALWAYS,0,255),e.stencilOp(e.KEEP,e.INCR,e.KEEP),e.clearStencil(0);for(var u=0;u<r;u++)l=this.atmosphere.cloudsManager.circularCloudsArray[u],e.uniform3fv(h._cloudPosHIGH,l.positionHIGH),e.uniform3fv(h._cloudPosLOW,l.positionLOW),void 0===l.vbo_shadowVertexCacheKey&&(l.vbo_shadowVertexCacheKey=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,l.vbo_shadowVertexCacheKey),e.bufferData(e.ARRAY_BUFFER,l.getVBOShadowVertexFloatArray(),e.STATIC_DRAW)),void 0===l.vbo_shadowIndexCacheKey&&(l.vbo_shadowIndexCacheKey=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,l.vbo_shadowIndexCacheKey),e.bufferData(e.ELEMENT_ARRAY_BUFFER,l.getVBOShadowIndicesShortArray(),e.STATIC_DRAW)),e.bindBuffer(e.ARRAY_BUFFER,l.vbo_shadowVertexCacheKey),e.vertexAttribPointer(h._position,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,l.vbo_shadowIndexCacheKey),e.drawElements(e.TRIANGLES,l.indicesCount,e.UNSIGNED_SHORT,0);e.cullFace(e.BACK),e.stencilFunc(e.ALWAYS,0,255),e.stencilOp(e.KEEP,e.DECR,e.KEEP);for(u=0;u<r;u++)l=this.atmosphere.cloudsManager.circularCloudsArray[u],e.uniform3fv(h._cloudPosHIGH,l.positionHIGH),e.uniform3fv(h._cloudPosLOW,l.positionLOW),void 0===l.vbo_shadowVertexCacheKey&&(l.vbo_shadowVertexCacheKey=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,l.vbo_shadowVertexCacheKey),e.bufferData(e.ARRAY_BUFFER,l.getVBOShadowVertexFloatArray(),e.STATIC_DRAW)),void 0===l.vbo_shadowIndexCacheKey&&(l.vbo_shadowIndexCacheKey=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,l.vbo_shadowIndexCacheKey),e.bufferData(e.ELEMENT_ARRAY_BUFFER,l.getVBOShadowIndicesShortArray(),e.STATIC_DRAW)),e.bindBuffer(e.ARRAY_BUFFER,l.vbo_shadowVertexCacheKey),e.vertexAttribPointer(h._position,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,l.vbo_shadowIndexCacheKey),e.drawElements(e.TRIANGLES,l.indicesCount,e.UNSIGNED_SHORT,0);e.disableVertexAttribArray(h._position),e.disable(e.POLYGON_OFFSET_FILL),e.disable(e.CULL_FACE),e.colorMask(!0,!0,!0,!0),e.depthMask(!1),e.stencilMask(0),e.stencilFunc(e.NOTEQUAL,1,255),e.stencilOp(e.REPLACE,e.REPLACE,e.REPLACE),e.disable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.cullFace(e.FRONT),h=c.getMagoShader(5),e.useProgram(h.SHADER_PROGRAM),e.enableVertexAttribArray(h._color),e.enableVertexAttribArray(h._position),e.uniformMatrix4fv(h._ModelViewProjectionMatrixRelToEye,!1,this.modelViewProjRelToEye_matrix),e.uniform3fv(h._encodedCamPosHIGH,this.encodedCamPosMC_High),e.uniform3fv(h._encodedCamPosLOW,this.encodedCamPosMC_Low);var f=this.atmosphere.shadowBlendingCube;void 0===f.vbo_vertexCacheKey&&(f.vbo_vertexCacheKey=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,f.vbo_vertexCacheKey),e.bufferData(e.ARRAY_BUFFER,f.getVBOVertexColorRGBAFloatArray(),e.STATIC_DRAW)),void 0===f.vbo_indexCacheKey&&(f.vbo_indexCacheKey=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,f.vbo_indexCacheKey),e.bufferData(e.ELEMENT_ARRAY_BUFFER,f.getVBOIndicesShortArray(),e.STATIC_DRAW)),e.bindBuffer(e.ARRAY_BUFFER,f.vbo_vertexCacheKey),e.vertexAttribPointer(h._position,3,e.FLOAT,!1,28,0),e.vertexAttribPointer(h._color,4,e.FLOAT,!1,28,12),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,f.vbo_indexCacheKey),e.drawElements(e.TRIANGLES,f.indicesCount,e.UNSIGNED_SHORT,0),e.disableVertexAttribArray(h._position),e.disableVertexAttribArray(h._color),e.enable(e.DEPTH_TEST),e.disable(e.BLEND),e.disable(e.STENCIL_TEST)}},MagoManager.prototype.prepareNeoBuildingsAsimetricVersion=function(e,t){var i,o,r=this.readerWriter.geometryDataPath;void 0===this.headersRequestedCounter&&(this.headersRequestedCounter=0);for(var n=[].concat(t.currentVisibles0,t.currentVisibles2,t.currentVisibles3),a=0,s=n.length;a<s;a++){if(o=n[a].data.projectFolderName,(i=n[a].data.neoBuilding).metaData.fileLoadState===CODE.fileLoadState.READY){if(this.fileRequestControler.isFullHeaders())return;var l=r+"/"+o+"/"+i.buildingFileName+"/HeaderAsimetric.hed";this.readerWriter.getNeoHeaderAsimetricVersion(e,l,i,this.readerWriter,this)}}n.length=0},MagoManager.prototype.upDateSceneStateMatrices=function(e){if(void 0===this.myCameraSCX&&(this.myCameraSCX=new Camera),void 0!==this.configInformation){if(this.configInformation.geo_view_library===Constant.WORLDWIND){var t=e.dc,i=WorldWind.Matrix.fromIdentity(),o=WorldWind.Matrix.fromIdentity(),r=WorldWind.Matrix.fromIdentity();r.copy(t.navigatorState.modelview),r[3]=0,r[7]=0,r[11]=0;var n=WorldWind.Matrix.fromIdentity();n.copy(t.navigatorState.modelview),i=n.columnMajorComponents(o),e.modelViewMatrix.copyFromFloatArray(i);var a=WorldWind.Matrix.fromIdentity();a.invertOrthonormalMatrix(n),i=a.columnMajorComponents(o),e.modelViewMatrixInv.copyFromFloatArray(i),e.normalMatrix4.copyFromFloatArray(a);var s=WorldWind.Matrix.fromIdentity();s.copy(t.navigatorState.projection),i=s.columnMajorComponents(o),e.projectionMatrix.copyFromFloatArray(i),(n=WorldWind.Matrix.fromIdentity()).copy(t.navigatorState.modelview),i=r.columnMajorComponents(i),e.modelViewRelToEyeMatrix.copyFromFloatArray(i);var l=WorldWind.Matrix.fromIdentity();l.invertOrthonormalMatrix(r),i=l.columnMajorComponents(o),e.modelViewRelToEyeMatrixInv.copyFromFloatArray(i);var c=WorldWind.Matrix.fromIdentity();c.copy(s),c.multiplyMatrix(r);o=WorldWind.Matrix.fromIdentity(),i=c.columnMajorComponents(o);e.modelViewProjRelToEyeMatrix.copyFromFloatArray(i);var h=WorldWind.Matrix.fromIdentity();h.copy(s),h.multiplyMatrix(n);o=WorldWind.Matrix.fromIdentity(),i=h.columnMajorComponents(o);e.modelViewProjMatrix.copyFromFloatArray(i);t.navigatorState.heading,t.navigatorState.tilt;var d=new Point3D;d.set(0,0,-1);var u=new Point3D;u.set(0,0,0);var f=new Point3D;f.set(0,1,0);var g=new Point3D;g.set(0,0,0),(u=e.modelViewMatrixInv.rotatePoint3D(d,u)).unitary(),(g=e.modelViewMatrixInv.rotatePoint3D(f,g)).unitary();var p=t.navigatorState.eyePoint;e.camera.position.set(p[0],p[1],p[2]),e.camera.direction.set(u.x,u.y,u.z),e.camera.up.set(g.x,g.y,g.z),ManagerUtils.calculateSplited3fv([p[0],p[1],p[2]],e.encodedCamPosHigh,e.encodedCamPosLow);var m=this.wwd.viewport;if(e.camera.frustum.aspectRatio[0]=m.width/m.height,e.camera.frustum.near[0]=.1,e.camera.frustum.far[0]=1e3,e.camera.frustum.dirty){var y=t.navigatorState.projection,v=e.camera.frustum.aspectRatio,x=2*Math.atan(1/(v*y[0]));(I=e.camera.getFrustum(0)).dirty=!1,e.camera.setAspectRatioAndFovyRad(m.width/m.height,x)}e.drawingBufferWidth[0]=m.width,e.drawingBufferHeight[0]=m.height}else if(this.configInformation.geo_view_library===Constant.CESIUM){var b=this.scene,C=b._context.uniformState;Cesium.Matrix4.toArray(C._modelViewProjectionRelativeToEye,e.modelViewProjRelToEyeMatrix._floatArrays),Cesium.Matrix4.toArray(C._modelViewProjection,e.modelViewProjMatrix._floatArrays),Cesium.Matrix4.toArray(C._modelViewRelativeToEye,e.modelViewRelToEyeMatrix._floatArrays),e.modelViewRelToEyeMatrixInv._floatArrays=Cesium.Matrix4.inverseTransformation(e.modelViewRelToEyeMatrix._floatArrays,e.modelViewRelToEyeMatrixInv._floatArrays),e.modelViewMatrix._floatArrays=Cesium.Matrix4.clone(C.view,e.modelViewMatrix._floatArrays),Cesium.Matrix4.toArray(C._projection,e.projectionMatrix._floatArrays);p=b.context._us._cameraPosition;ManagerUtils.calculateSplited3fv([p.x,p.y,p.z],e.encodedCamPosHigh,e.encodedCamPosLow),e.modelViewMatrixInv._floatArrays=Cesium.Matrix4.inverseTransformation(e.modelViewMatrix._floatArrays,e.modelViewMatrixInv._floatArrays),e.normalMatrix4._floatArrays=Cesium.Matrix4.transpose(e.modelViewMatrixInv._floatArrays,e.normalMatrix4._floatArrays),(I=e.camera.getFrustum(0)).far[0]=b._frustumCommandsList[0].far,I.near[0]=b._frustumCommandsList[0].near,I.fovRad[0]=b._camera.frustum._fov,I.fovyRad[0]=b._camera.frustum._fovy,I.aspectRatio[0]=b._camera.frustum._aspectRatio,I.tangentOfHalfFovy[0]=Math.tan(I.fovyRad/2),e.camera.setCurrentFrustum(0);var M=b.context._us._cameraPosition.x,_=b.context._us._cameraPosition.y,A=b.context._us._cameraPosition.z,R=b._camera.direction.x,P=b._camera.direction.y,T=b._camera.direction.z,L=b._camera.up.x,S=b._camera.up.y,w=b._camera.up.z;e.camera.isCameraMoved(M,_,A,R,P,T,L,S,w)&&(this.isCameraMoved=!0),e.camera.position.set(b.context._us._cameraPosition.x,b.context._us._cameraPosition.y,b.context._us._cameraPosition.z),e.camera.direction.set(b._camera.direction.x,b._camera.direction.y,b._camera.direction.z),e.camera.up.set(b._camera.up.x,b._camera.up.y,b._camera.up.z),e.drawingBufferWidth[0]=b.drawingBufferWidth,e.drawingBufferHeight[0]=b.drawingBufferHeight}else if(this.configInformation.geo_view_library===Constant.MAGOWORLD){var E=e.camera,D=E.position,I=E.getFrustum(0);e.camera.frustum.aspectRatio=e.drawingBufferWidth/e.drawingBufferHeight;var O=E.getCameraElevation(),V=Globe.equatorialRadius();I.far[0]=V+O,I.near[0]=.1+O/1e7,ManagerUtils.calculateSplited3fv([D.x,D.y,D.z],e.encodedCamPosHigh,e.encodedCamPosLow),e.projectionMatrix._floatArrays=mat4.perspective(e.projectionMatrix._floatArrays,I.fovyRad[0],I.aspectRatio,0,I.far[0]),e.modelViewMatrixInv._floatArrays=mat4.invert(e.modelViewMatrixInv._floatArrays,e.modelViewMatrix._floatArrays),e.normalMatrix4._floatArrays=mat4.transpose(e.normalMatrix4._floatArrays,e.modelViewMatrixInv._floatArrays),e.modelViewRelToEyeMatrix._floatArrays=mat4.copy(e.modelViewRelToEyeMatrix._floatArrays,e.modelViewMatrix._floatArrays),e.modelViewRelToEyeMatrix._floatArrays[12]=0,e.modelViewRelToEyeMatrix._floatArrays[13]=0,e.modelViewRelToEyeMatrix._floatArrays[14]=0,e.modelViewRelToEyeMatrix._floatArrays[15]=1,e.modelViewRelToEyeMatrixInv._floatArrays=mat4.invert(e.modelViewRelToEyeMatrixInv._floatArrays,e.modelViewRelToEyeMatrix._floatArrays),e.modelViewProjMatrix._floatArrays=mat4.multiply(e.modelViewProjMatrix._floatArrays,e.projectionMatrix._floatArrays,e.modelViewMatrix._floatArrays),e.modelViewProjRelToEyeMatrix.copyFromMatrix4(e.modelViewProjMatrix),e.modelViewProjRelToEyeMatrix._floatArrays[12]=0,e.modelViewProjRelToEyeMatrix._floatArrays[13]=0,e.modelViewProjRelToEyeMatrix._floatArrays[14]=0,e.modelViewProjRelToEyeMatrix._floatArrays[15]=1,I.tangentOfHalfFovy[0]=Math.tan(I.fovyRad[0]/2)}void 0!==this.depthFboNeo&&(e.ssaoNoiseScale2[0]=this.depthFboNeo.width[0]/this.noiseTexture.width,e.ssaoNoiseScale2[1]=this.depthFboNeo.height[0]/this.noiseTexture.height),this.myCameraSCX.direction.set(e.camera.direction.x,e.camera.direction.y,e.camera.direction.z),this.myCameraSCX.up.set(e.camera.up.x,e.camera.up.y,e.camera.up.z);I=this.myCameraSCX.getFrustum(0);var B=e.camera.getFrustum(0);I.near[0]=B.near[0],I.far[0]=B.far[0],I.fovyRad[0]=B.fovyRad[0],I.tangentOfHalfFovy[0]=B.tangentOfHalfFovy[0],I.fovRad[0]=B.fovRad[0],I.aspectRatio[0]=B.aspectRatio[0]}},MagoManager.prototype.upDateCamera=function(e){if(this.configInformation.geo_view_library===Constant.WORLDWIND){var t=this.currentFrustumIdx,i=(u=e.getFrustum(t)).fovyRad;e.setAspectRatioAndFovyRad(s,i);for(var o=this.sceneState.dc.navigatorState.frustumInModelCoordinates,r=0;r<6;r++){var n=o._planes[r];e.frustum.planesArray[r].setNormalAndDistance(n.normal[0],n.normal[1],n.normal[2],n.distance)}}else if(this.configInformation.geo_view_library===Constant.CESIUM){var a=this.scene.frameState.camera,s=(t=this.currentFrustumIdx,(u=(a=this.sceneState.camera).getFrustum(t)).aspectRatio);i=u.fovyRad;u.far[0]=this.scene._frustumCommandsList[t].far,u.near[0]=this.scene._frustumCommandsList[t].near;var l=this.scene._frustumCommandsList[t].far,c=this.scene._frustumCommandsList[t].near;this.sceneState.camera.frustum.near[0]=c,this.sceneState.camera.frustum.far[0]=l;var h=this.scene._frustumCommandsList.length,d=[];for(r=0;r<h;r++)d[2*r]=this.scene._frustumCommandsList[r].near,d[2*r+1]=this.scene._frustumCommandsList[r].far;e.position.set(a.position.x,a.position.y,a.position.z),e.direction.set(a.direction.x,a.direction.y,a.direction.z),e.up.set(a.up.x,a.up.y,a.up.z),(u=e.getFrustum(t)).near[0]=c,u.far[0]=l,e.setFrustumsDistances(h,d),e.setAspectRatioAndFovyRad(s,i),e.calculateFrustumsPlanes()}else if(this.configInformation.geo_view_library===Constant.MAGOWORLD){var u;a=this.sceneState.camera,t=0,s=(u=(a=this.sceneState.camera).getFrustum(t)).aspectRatio,i=u.fovyRad,l=u.far,c=u.near;this.sceneState.camera.frustum.near[0]=c,this.sceneState.camera.frustum.far[0]=l,this.sceneState.camera.frustum.aspectRatio=s;for(h=1,d=[],r=0;r<h;r++)d[2*r]=u.near,d[2*r+1]=u.far;e.position.set(a.position.x,a.position.y,a.position.z),e.direction.set(a.direction.x,a.direction.y,a.direction.z),e.up.set(a.up.x,a.up.y,a.up.z),(u=e.getFrustum(t)).near[0]=c,u.far[0]=l,e.setFrustumsDistances(h,d),e.setAspectRatioAndFovyRad(s,i),e.calculateFrustumsPlanes()}},MagoManager.prototype.renderFakeEarth=function(e){if(void 0===e&&(e=1),void 0===this.fakeEarth){new MagoNativeProject;var t=new Sphere;t.r=6378137;var i=new ParametricMesh;t.mesh=i,i.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,i.vboKeyContainer=t.getVbo(i.vboKeyContainer),this.fakeEarth=t}var o,r=this.sceneState.gl;0===e&&(o=this.postFxShadersManager.getTriPolyhedronDepthShader(),r.disable(r.BLEND)),1===e&&(o=this.postFxShadersManager.getTriPolyhedronShader(),r.enable(r.BLEND));var n,a=o.program;r.frontFace(r.CCW),r.useProgram(a),r.enableVertexAttribArray(o.position3_loc),r.uniformMatrix4fv(o.modelViewProjectionMatrix4RelToEye_loc,!1,this.sceneState.modelViewProjRelToEyeMatrix._floatArrays),r.uniformMatrix4fv(o.modelViewMatrix4RelToEye_loc,!1,this.sceneState.modelViewRelToEyeMatrix._floatArrays),r.uniform3fv(o.cameraPosHIGH_loc,this.sceneState.encodedCamPosHigh),r.uniform3fv(o.cameraPosLOW_loc,this.sceneState.encodedCamPosLow),r.uniform1f(o.near_loc,this.sceneState.camera.frustum.near),r.uniform1f(o.far_loc,this.sceneState.camera.frustum.far),r.uniform1i(o.bApplySsao_loc,!1),r.uniformMatrix4fv(o.normalMatrix4_loc,!1,this.sceneState.normalMatrix4._floatArrays),1===e&&(r.uniform1i(o.bApplySpecularLighting_loc,!0),r.enableVertexAttribArray(o.normal3_loc),r.enableVertexAttribArray(o.color4_loc),r.uniform1i(o.bUse1Color_loc,!1),r.uniform4fv(o.oneColor4_loc,[1,.1,.1,1]),r.uniform1i(o.bUseNormal_loc,!0),r.uniformMatrix4fv(o.modelViewMatrix4_loc,!1,this.sceneState.modelViewMatrix._floatArrays),r.uniformMatrix4fv(o.projectionMatrix4_loc,!1,this.sceneState.projectionMatrix._floatArrays),r.uniform1i(o.depthTex_loc,0),r.uniform1i(o.noiseTex_loc,1),r.uniform1i(o.diffuseTex_loc,2),r.uniform1f(o.fov_loc,this.sceneState.camera.frustum.fovyRad),r.uniform1f(o.aspectRatio_loc,this.sceneState.camera.frustum.aspectRatio),r.uniform1f(o.screenWidth_loc,this.sceneState.drawingBufferWidth),r.uniform1f(o.screenHeight_loc,this.sceneState.drawingBufferHeight),r.uniform2fv(o.noiseScale2_loc,[this.depthFboNeo.width/this.noiseTexture.width,this.depthFboNeo.height/this.noiseTexture.height]),r.uniform3fv(o.kernel16_loc,this.kernel),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.depthFboNeo.colorBuffer),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.noiseTexture)),r.uniform3fv(o.scale_loc,[1,1,1]),r.uniformMatrix4fv(o.buildingRotMatrix_loc,!1,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),r.uniform3fv(o.buildingPosHIGH_loc,[0,0,0]),r.uniform3fv(o.buildingPosLOW_loc,[0,0,0]),r.uniform3fv(o.aditionalMov_loc,[0,0,0]),n=this.fakeEarth.mesh,this.renderer.renderObject(r,n,this,o,e,!1),o&&(-1!==o.texCoord2_loc&&r.disableVertexAttribArray(o.texCoord2_loc),-1!==o.position3_loc&&r.disableVertexAttribArray(o.position3_loc),-1!==o.normal3_loc&&r.disableVertexAttribArray(o.normal3_loc),-1!==o.color4_loc&&r.disableVertexAttribArray(o.color4_loc)),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,null),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,null),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,null),r.disable(r.BLEND)},MagoManager.prototype.test_cctv=function(){if(void 0===this.cctvList){this.cctvList=new CCTVList;var e=60,t=this.cctvList.new_CCTV("0000100001000T"),i=128.606641,o=35.902546;ManagerUtils.calculateGeoLocationData(i,o,74,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,74,t.camera.position,this);var r=t.camera.bigFrustum;r.far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),t=this.cctvList.new_CCTV("0000100002000T"),i=128.606341,o=35.901937;ManagerUtils.calculateGeoLocationData(i,o,82,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,82,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),t=this.cctvList.new_CCTV("0000100003000T"),i=128.606641,o=35.902156;ManagerUtils.calculateGeoLocationData(i,o,80,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,80,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),t=this.cctvList.new_CCTV("0000100004000T"),i=128.606641,o=35.902106,ManagerUtils.calculateGeoLocationData(i,o,80,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,80,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),(t=this.cctvList.new_CCTV("CCTV-1")).minHeading=45,t.maxHeading=180,i=127.05472,o=37.540641;ManagerUtils.calculateGeoLocationData(i,o,47,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,47,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),t=this.cctvList.new_CCTV("CCTV-2"),i=127.055259,o=37.544781,ManagerUtils.calculateGeoLocationData(i,o,e,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,e,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),t=this.cctvList.new_CCTV("CCTV-3"),i=127.043323,o=37.548298,ManagerUtils.calculateGeoLocationData(i,o,e,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,e,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),t=this.cctvList.new_CCTV("CCTV-4"),i=127.05688,o=37.544136,ManagerUtils.calculateGeoLocationData(i,o,e,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,e,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),t=this.cctvList.new_CCTV("CCTV-5"),i=127.054847,o=37.544761,ManagerUtils.calculateGeoLocationData(i,o,e,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,e,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),t=this.cctvList.new_CCTV("CCTV10"),i=127.056265,o=37.542031;ManagerUtils.calculateGeoLocationData(i,o,43,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,43,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),(t=this.cctvList.new_CCTV("CCTV11")).minHeading=-150,t.maxHeading=-35,i=127.054967,o=37.539409;ManagerUtils.calculateGeoLocationData(i,o,45,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,45,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),(t=this.cctvList.new_CCTV("CCTV13")).minHeading=90,t.maxHeading=240,i=127.05503,o=37.540139;ManagerUtils.calculateGeoLocationData(i,o,46,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,46,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),t=this.cctvList.new_CCTV("CCTV14"),i=127.056001,o=37.53994;ManagerUtils.calculateGeoLocationData(i,o,47,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,47,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),t=this.cctvList.new_CCTV("CCTV6"),i=127.057016,o=37.544093,ManagerUtils.calculateGeoLocationData(i,o,e,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,e,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),(t=this.cctvList.new_CCTV("CCTV7")).minHeading=-140,t.maxHeading=0,i=127.056593,o=37.543283,e=45,ManagerUtils.calculateGeoLocationData(i,o,e,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,e,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),t=this.cctvList.new_CCTV("CCTV8"),i=127.055027,o=37.545001,e=60,ManagerUtils.calculateGeoLocationData(i,o,e,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,e,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),t=this.cctvList.new_CCTV("CCTV9"),i=127.057023,o=37.54442,ManagerUtils.calculateGeoLocationData(i,o,e,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,e,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),t=this.cctvList.new_CCTV("3-22"),i=127.057024,o=37.54442,ManagerUtils.calculateGeoLocationData(i,o,e,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,e,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),t=this.cctvList.new_CCTV("4-42"),i=127.057025,o=37.54442,ManagerUtils.calculateGeoLocationData(i,o,e,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,e,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),t=this.cctvList.new_CCTV("1-51"),i=127.057026,o=37.54442,ManagerUtils.calculateGeoLocationData(i,o,e,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,e,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),t=this.cctvList.new_CCTV("15-31123"),i=127.057027,o=37.54442,ManagerUtils.calculateGeoLocationData(i,o,e,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,e,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix(),t=this.cctvList.new_CCTV("6-13"),i=127.057028,o=37.54442,ManagerUtils.calculateGeoLocationData(i,o,e,0,0,0,t.geoLocationData,this),t.camera.position=ManagerUtils.geographicCoordToWorldPoint(i,o,e,t.camera.position,this),(r=t.camera.bigFrustum).far=10,t.vboKeyContainer=new VBOVertexIdxCacheKeysContainer,t.vboKeyContainer=t.getVbo(t.vboKeyContainer),t.calculateRotationMatrix()}},MagoManager.prototype.startRender=function(e,t,i,o){this.numFrustums=o,this.isLastFrustum=t;var r=this.sceneState.gl;if(this.upDateSceneStateMatrices(this.sceneState),this.isFarestFrustum()){if(this.test_cctv(),void 0===this.textureAux_1x1&&(this.textureAux_1x1=r.createTexture(),r.bindTexture(r.TEXTURE_2D,this.textureAux_1x1),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,1,1,0,r.RGBA,r.UNSIGNED_BYTE,new Uint8Array([200,200,200,255])),r.bindTexture(r.TEXTURE_2D,null)),void 0===this.noiseTexture&&(this.noiseTexture=genNoiseTextureRGBA(r,4,4,this.pixels)),void 0===this.pin.texture){this.pin.texture=new Texture;var n=this.magoPolicy.imagePath+"/bugger.png";this.pin.texture.texId=r.createTexture(),this.readerWriter.readNeoReferenceTexture(r,n,this.pin.texture,void 0,this),this.pin.texturesArray.push(this.pin.texture);var a=new Texture;n=this.magoPolicy.imagePath+"/improve.png",a.texId=r.createTexture(),this.readerWriter.readNeoReferenceTexture(r,n,a,void 0,this),this.pin.texturesArray.push(a),a=new Texture,n=this.magoPolicy.imagePath+"/etc.png",a.texId=r.createTexture(),this.readerWriter.readNeoReferenceTexture(r,n,a,void 0,this),this.pin.texturesArray.push(a),a=new Texture,n=this.magoPolicy.imagePath+"/new.png",a.texId=r.createTexture(),this.readerWriter.readNeoReferenceTexture(r,n,a,void 0,this),this.pin.texturesArray.push(a),a=new Texture,n=this.magoPolicy.imagePath+"/funny.jpg",a.texId=r.createTexture(),this.readerWriter.readNeoReferenceTexture(r,n,a,void 0,this),this.pin.texturesArray.push(a)}void 0===this.depthFboNeo&&(this.depthFboNeo=new FBO(r,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight)),this.sceneState.drawingBufferWidth[0]===this.depthFboNeo.width[0]&&this.sceneState.drawingBufferHeight[0]===this.depthFboNeo.height[0]||(this.depthFboNeo.deleteObjects(r),this.depthFboNeo=new FBO(r,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight),this.sceneState.camera.frustum.dirty=!0),void 0===this.myCameraSCX&&(this.myCameraSCX=new Camera),this.isCameraMoving||this.mouseLeftDown||this.mouseMiddleDown||(this.upDateCamera(this.myCameraSCX),this.doMultiFrustumCullingSmartTiles(this.myCameraSCX)),r.clearStencil(0),r.clear(r.STENCIL_BUFFER_BIT)}var s=this.sceneState.camera.position,l=this.frustumVolumeControl.getFrustumVolumeCulling(i);this.myCameraSCX.setCurrentFrustum(i);var c=l.visibleNodes;if(!this.isCameraMoving&&!this.mouseLeftDown&&!this.mouseMiddleDown){if(void 0===this.frustumVolumeControl)return;var h=this.myCameraSCX.bigFrustum,d=!1;this.tilesMultiFrustumCullingFinished(l.fullyIntersectedLowestTilesArray,c,s,h,d),d=!0,this.tilesMultiFrustumCullingFinished(l.partiallyIntersectedLowestTilesArray,c,s,h,d),this.prepareNeoBuildingsAsimetricVersion(r,c)}if(this.visibleObjControlerNodes=c,!this.isCameraMoving&&!this.mouseLeftDown&&!this.mouseMiddleDown){var u;this.visibleObjControlerOctrees.initArrays(),this.checkPropertyFilters(this.visibleObjControlerNodes.currentVisibles0),this.checkPropertyFilters(this.visibleObjControlerNodes.currentVisibles2);for(var f=this.visibleObjControlerNodes.currentVisibles0.length,g=0;g<f;g++)u=this.visibleObjControlerNodes.currentVisibles0[g],this.getRenderablesDetailedNeoBuildingAsimetricVersion(r,u,this.visibleObjControlerOctrees,0)||(this.visibleObjControlerNodes.currentVisibles0.splice(g,1),g--,f=this.visibleObjControlerNodes.currentVisibles0.length);var p=1;this.prepareVisibleOctreesSortedByDistance(r,this.visibleObjControlerOctrees,p),this.prepareVisibleOctreesSortedByDistanceLOD2(r,this.visibleObjControlerOctrees.currentVisibles0,p),this.prepareVisibleOctreesSortedByDistanceLOD2(r,this.visibleObjControlerOctrees.currentVisibles1,p),this.prepareVisibleOctreesSortedByDistanceLOD2(r,this.visibleObjControlerOctrees.currentVisibles2,p),(p=this.visibleObjControlerOctrees.currentVisibles0.length)>2&&(p=2),f=this.visibleObjControlerNodes.currentVisibles2.length;for(g=0;g<f;g++)u=this.visibleObjControlerNodes.currentVisibles2[g],this.getRenderablesDetailedNeoBuildingAsimetricVersion(r,u,this.visibleObjControlerOctrees,2)||(this.visibleObjControlerNodes.currentVisibles2.splice(g,1),g--,f=this.visibleObjControlerNodes.currentVisibles2.length);p=2,this.prepareVisibleOctreesSortedByDistanceLOD2(r,this.visibleObjControlerOctrees.currentVisibles2,p);for(g=(f=this.visibleObjControlerNodes.currentVisibles2.length)-1;g>=0;g--)u=this.visibleObjControlerNodes.currentVisibles2[g],this.processQueue.putNodeToDeleteModelReferences(u,0);this.prepareVisibleLowLodNodes(this.visibleObjControlerNodes.currentVisibles3),void 0===this.visibleObjControlerOctreesAux&&(this.visibleObjControlerOctreesAux=new VisibleObjectsController),this.visibleObjControlerOctreesAux.initArrays();for(f=this.visibleObjControlerNodes.currentVisiblesAux.length,g=0;g<f;g++)u=this.visibleObjControlerNodes.currentVisiblesAux[g],this.getRenderablesDetailedNeoBuildingAsimetricVersion(r,u,this.visibleObjControlerOctreesAux,0)||(this.visibleObjControlerNodes.currentVisiblesAux.splice(g,1),g--,f=this.visibleObjControlerNodes.currentVisiblesAux.length);p=2,this.prepareVisibleOctreesSortedByDistancePointsCloudType(r,this.visibleObjControlerOctreesAux,p),this.isFarestFrustum()&&this.prepareVisibleTinTerrains(this.tinTerrainManager),this.manageQueue(),0===this.currentFrustumIdx&&this.loadQueue.manageQueue()}if(!0===this.bPicking&&t){var m;if(!0===this.magoPolicy.issueInsertEnable){void 0===this.objMarkerSC&&(this.objMarkerSC=new ObjectMarker),m=new Point3D,m=this.calculatePixelPositionWorldCoord(r,this.mouse_x,this.mouse_y,m);var y=this.objMarkerManager.newObjectMarker();ManagerUtils.calculateGeoLocationDataByAbsolutePoint(m.x,m.y,m.z,y.geoLocationData,this)}!0===this.magoPolicy.objectInfoViewEnable&&(void 0===this.objMarkerSC&&(this.objMarkerSC=new ObjectMarker),void 0===m&&(m=new Point3D,m=this.calculatePixelPositionWorldCoord(r,this.mouse_x,this.mouse_y,m)),ManagerUtils.calculateGeoLocationDataByAbsolutePoint(m.x,m.y,m.z,this.objMarkerSC.geoLocationData,this))}this.isCameraMoving||this.mouseLeftDown||this.mouseMiddleDown||(void 0===this.selectionFbo&&(this.selectionFbo=new FBO(r,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight)),(this.isCameraMoved||this.bPicking)&&(this.selectionFbo.bind(),r.enable(r.DEPTH_TEST),r.depthFunc(r.LEQUAL),r.depthRange(0,1),r.disable(r.CULL_FACE),this.isLastFrustum&&(r.clearColor(1,1,1,1),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),this.selectionCandidates.clearCandidates()),this.renderGeometryColorCoding(r,this.visibleObjControlerNodes),this.swapRenderingFase(),0===this.currentFrustumIdx&&(this.isCameraMoved=!1)),0===this.currentFrustumIdx&&(!0===this.bPicking&&(this.bPicking=!1,this.arrayAuxSC.length=0,this.objectSelected=this.getSelectedObjects(r,this.mouse_x,this.mouse_y,this.arrayAuxSC),this.buildingSelected=this.arrayAuxSC[0],this.octreeSelected=this.arrayAuxSC[1],this.nodeSelected=this.arrayAuxSC[3],this.nodeSelected?this.rootNodeSelected=this.nodeSelected.getRoot():this.rootNodeSelected=void 0,this.arrayAuxSC.length=0,void 0!==this.buildingSelected&&(this.displayLocationAndRotation(this.buildingSelected),this.selectedObjectNotice(this.buildingSelected)),this.objectSelected),this.selectionColor.init()),this.selectionFbo.unbind(),r.enable(r.CULL_FACE));var v=0;this.depthFboNeo.bind(),r.clearColor(1,1,1,1),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),r.viewport(0,0,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight),this.renderGeometry(r,s,void 0,!1,v,this.visibleObjControlerNodes),this.depthFboNeo.unbind(),this.swapRenderingFase(),this.configInformation.geo_view_library===Constant.WORLDWIND||this.configInformation.geo_view_library===Constant.CESIUM&&e._context._currentFramebuffer._bind(),v=1,this.renderGeometry(r,s,void 0,!1,v,this.visibleObjControlerNodes),this.swapRenderingFase(),this.magoPolicy.getShowLabelInfo()&&this.drawBuildingNames(this.visibleObjControlerNodes),this.configInformation.geo_view_library===Constant.WORLDWIND&&(r.activeTexture(r.TEXTURE0),this.wwd.drawContext.redrawRequested=!0)},MagoManager.prototype.prepareVisibleTinTerrains=function(e){var t,i,o=e.currentVisibles_terrName_geoCoords_map,r=e.currentTerrainsMap,n=this.sceneState.gl;for(var a in o)if(void 0===(t=r[a])){(t=new TinTerrain).pathName=a,r[a]=t,0;var s=a.split("\\");t.depth=s[0]}else if(this.processQueue.eraseTinTerrainToDelete(t),t.fileLoadState===CODE.fileLoadState.READY){var l="CesiumTerrain/"+t.pathName+".terrain";this.readerWriter.loadTINTerrain(n,l,t,this)}else if(t.fileLoadState===CODE.fileLoadState.LOADING_FINISHED)this.parseQueue.putTinTerrainToParse(t,0);else if(t.fileLoadState===CODE.fileLoadState.PARSE_FINISHED&&void 0===t.vboKeyContainer){var c=e.currentVisibles_terrName_geoCoords_map[t.pathName];void 0!==c&&(t.geographicExtent=c,t.decodeData(),t.makeVbo())}for(var a in r)void 0===(t=o[a])&&(i=r[a],this.processQueue.putTinTerrainToDelete(i,0))},MagoManager.prototype.prepareVisibleLowLodNodes=function(e){if(!(Object.keys(this.loadQueue.lowLodSkinDataMap).length>1)&&!(Object.keys(this.loadQueue.lowLodSkinTextureMap).length>1)){this.sceneState.gl;for(var t,i,o,r,n=this.readerWriter.geometryDataPath,a=e.length,s=0;s<a;s++){if(Object.keys(this.loadQueue.lowLodSkinDataMap).length>1)return;if(Object.keys(this.loadQueue.lowLodSkinTextureMap).length>1)return;var l=(i=e[s].data.neoBuilding).getHeaderVersion();if(void 0!==l&&"0"===l[0]){var c,h;void 0===i.lodMeshesMap&&(i.lodMeshesMap={}),o=i.projectFolderName,r=i.buildingFileName;i.currentLod;var d=i.getLodBuildingData(i.currentLod);if(void 0!==d&&!d.isModelRef&&(c=d.textureFileName,h=d.geometryFileName,void 0===(t=i.lodMeshesMap[h])&&((t=new Lego).fileLoadState=CODE.fileLoadState.READY,t.textureName=c,t.legoKey=i.buildingId+"_"+h,i.lodMeshesMap[h]=t),-1!==t.fileLoadState)){if(t.fileLoadState===CODE.fileLoadState.READY){var u=n+"/"+o+"/"+r+"/"+h;this.loadQueue.putLowLodSkinData(t,u,0),void 0===t.vbo_vicks_container.vboCacheKeysArray&&(t.vbo_vicks_container.vboCacheKeysArray=[])}if(t.vbo_vicks_container.vboCacheKeysArray[0]&&t.vbo_vicks_container.vboCacheKeysArray[0].meshTexcoordsCacheKey&&void 0===t.texture){t.texture=new Texture;var f=n+"/"+o+"/"+r+"/"+c;this.loadQueue.putLowLodSkinTexture(f,t.texture,0)}if(this.fileRequestControler.isFullPlusLowLodData(5))return}}}}},MagoManager.prototype.renderMagoGeometries=function(e){if(void 0===this.nativeProjectsArray){this.nativeProjectsArray=[];var t=new MagoNativeProject;this.nativeProjectsArray.push(t);var i=t.newParametricMesh();i.profile=new Profile;var o,r=i.profile;r.TEST__setFigureHole_2(),void 0===i.vboKeyContainer&&(i.vboKeyContainer=new VBOVertexIdxCacheKeysContainer),void 0===i.vboKeyContainerEdges&&(i.vboKeyContainerEdges=new VBOVertexIdxCacheKeysContainer),90,o=new Segment2D;var n=new Point2D(20,-10),a=new Point2D(20,10);if(o.setPoints(n,a),24,i.revolve(r,90,24,o),!0,!0,(h=i.getSurfaceIndependentMesh(void 0,!0,!0)).setColor(.1,.5,.5,1),h.getVbo(i.vboKeyContainer),h.getVboEdges(i.vboKeyContainerEdges),void 0===t.geoLocDataManager){t.geoLocDataManager=new GeoLocationDataManager;var s=t.geoLocDataManager.newGeoLocationData("deploymentLoc");ManagerUtils.calculateGeoLocationData(126.61120237344926,37.577213509597016,50,0,0,0,s,this)}}var l,c=this.sceneState.gl;0===e&&(l=this.postFxShadersManager.getTriPolyhedronDepthShader(),c.disable(c.BLEND)),1===e&&(l=this.postFxShadersManager.getTriPolyhedronShader(),c.enable(c.BLEND));var h,d,u,f=l.program;c.frontFace(c.CCW),c.useProgram(f),c.enableVertexAttribArray(l.position3_loc),c.uniformMatrix4fv(l.modelViewProjectionMatrix4RelToEye_loc,!1,this.sceneState.modelViewProjRelToEyeMatrix._floatArrays),c.uniformMatrix4fv(l.modelViewMatrix4RelToEye_loc,!1,this.sceneState.modelViewRelToEyeMatrix._floatArrays),c.uniform3fv(l.cameraPosHIGH_loc,this.sceneState.encodedCamPosHigh),c.uniform3fv(l.cameraPosLOW_loc,this.sceneState.encodedCamPosLow),c.uniform1f(l.near_loc,this.sceneState.camera.frustum.near),c.uniform1f(l.far_loc,this.sceneState.camera.frustum.far),c.uniform1i(l.bApplySsao_loc,!1),c.uniformMatrix4fv(l.normalMatrix4_loc,!1,this.sceneState.normalMatrix4._floatArrays),1===e&&(c.enableVertexAttribArray(l.normal3_loc),c.enableVertexAttribArray(l.color4_loc),c.uniform1i(l.bUse1Color_loc,!1),c.uniform4fv(l.oneColor4_loc,[1,.1,.1,1]),c.uniform1i(l.bUseNormal_loc,!0),c.uniformMatrix4fv(l.modelViewMatrix4_loc,!1,this.sceneState.modelViewMatrix._floatArrays),c.uniformMatrix4fv(l.projectionMatrix4_loc,!1,this.sceneState.projectionMatrix._floatArrays),c.uniform1i(l.depthTex_loc,0),c.uniform1i(l.noiseTex_loc,1),c.uniform1i(l.diffuseTex_loc,2),c.uniform1f(l.fov_loc,this.sceneState.camera.frustum.fovyRad),c.uniform1f(l.aspectRatio_loc,this.sceneState.camera.frustum.aspectRatio),c.uniform1f(l.screenWidth_loc,this.sceneState.drawingBufferWidth),c.uniform1f(l.screenHeight_loc,this.sceneState.drawingBufferHeight),c.uniform2fv(l.noiseScale2_loc,[this.depthFboNeo.width/this.noiseTexture.width,this.depthFboNeo.height/this.noiseTexture.height]),c.uniform3fv(l.kernel16_loc,this.kernel),c.activeTexture(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,this.depthFboNeo.colorBuffer),c.activeTexture(c.TEXTURE1),c.bindTexture(c.TEXTURE_2D,this.noiseTexture));for(var g=this.nativeProjectsArray.length,p=0;p<g;p++){d=(t=this.nativeProjectsArray[p]).geoLocDataManager,c.uniform3fv(l.scale_loc,[1,1,1]),(u=d.getCurrentGeoLocationData()).positionHIGH[0]=0,u.positionHIGH[1]=0,u.positionHIGH[2]=0,u.positionLOW[0]=0,u.positionLOW[1]=0,u.positionLOW[2]=0,c.uniformMatrix4fv(l.buildingRotMatrix_loc,!1,u.rotMatrix._floatArrays),c.uniform3fv(l.buildingPosHIGH_loc,u.positionHIGH),c.uniform3fv(l.buildingPosLOW_loc,u.positionLOW),c.uniform3fv(l.aditionalMov_loc,[0,0,0]);for(var m=t.getMeshesCount(),y=0;y<m;y++)h=t.getMesh(y),this.renderer.renderObject(c,h,this,l,e)}l&&(-1!==l.texCoord2_loc&&c.disableVertexAttribArray(l.texCoord2_loc),-1!==l.position3_loc&&c.disableVertexAttribArray(l.position3_loc),-1!==l.normal3_loc&&c.disableVertexAttribArray(l.normal3_loc),-1!==l.color4_loc&&c.disableVertexAttribArray(l.color4_loc)),c.activeTexture(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,null),c.activeTexture(c.TEXTURE1),c.bindTexture(c.TEXTURE_2D,null),c.activeTexture(c.TEXTURE2),c.bindTexture(c.TEXTURE_2D,null),c.disable(c.BLEND)},MagoManager.prototype.drawBuildingNames=function(e){var t=document.getElementById("objectLabel");if(void 0!==t){t.style.opacity=1,t.width=this.sceneState.drawingBufferWidth,t.height=this.sceneState.drawingBufferHeight;var i=t.getContext("2d");i.strokeStyle="DarkSlateGray",i.fillStyle="PapayaWhip",i.lineWidth=4,i.font="20px Arial",i.textAlign="center",i.fillRect(0,0,i.canvas.width,i.canvas.height),i.save(),i.clearRect(0,0,i.canvas.width,i.canvas.height);i.measureText("M").width;for(var o,r,n,a,s,l=this.sceneState.gl,c={},h=e.currentVisibles2.concat(e.currentVisibles3),d=h.length,u=0;u<d;u++){if(r=(o=h[u]).getRoot(),void 0!==o.data&&void 0!==o.data.neoBuilding)c[f=o.data.neoBuilding.buildingId]=r}for(var f in c)Object.prototype.hasOwnProperty.call(c,f)&&(n=(r=c[f]).data.geoLocDataManager.getCurrentGeoLocationData(),a=r.getBBoxCenterPositionWorldCoord(n),(s=this.calculateWorldPositionToScreenCoord(l,a.x,a.y,a.z,s)).x>=0&&s.y>=0&&(i.font="13px Arial",i.strokeText(r.data.data_name,s.x,s.y),i.fillText(r.data.data_name,s.x,s.y)));c={},i.restore()}},MagoManager.prototype.cameraMoved=function(){this.sceneState.camera.setDirty(!0),void 0===this.selectionFbo&&(this.selectionFbo=new FBO(this.sceneState.gl,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight)),this.selectionFbo.dirty=!0},MagoManager.prototype.getNodeGeoLocDataManager=function(e){if(void 0!==e){var t=e.getClosestParentWithData("geoLocDataManager");if(void 0!==t)if(void 0!==t.data)return t.data.geoLocDataManager}},MagoManager.prototype.renderGeometryColorCoding=function(e,t){var i,o,r,n,a,s,l=0,c=e.TRIANGLES,h=this.postFxShadersManager.pFx_shaders_array[5],d=h.program;e.useProgram(d),e.enableVertexAttribArray(h.position3_loc),e.uniformMatrix4fv(h.modelViewProjectionMatrix4RelToEye_loc,!1,this.sceneState.modelViewProjRelToEyeMatrix._floatArrays),e.uniform3fv(h.cameraPosHIGH_loc,this.sceneState.encodedCamPosHigh),e.uniform3fv(h.cameraPosLOW_loc,this.sceneState.encodedCamPosLow);for(var u=t.currentVisibles0.length,f=0;f<u;f++){o=(i=t.currentVisibles0[f]).data.neoBuilding;var g=this.getNodeGeoLocDataManager(i).getCurrentGeoLocationData();if(e.uniformMatrix4fv(h.buildingRotMatrix_loc,!1,g.rotMatrix._floatArrays),e.uniform3fv(h.buildingPosHIGH_loc,g.positionHIGH),e.uniform3fv(h.buildingPosLOW_loc,g.positionLOW),void 0!==(r=o.currentVisibleOctreesControler)){n=r.currentVisibles0.length;for(var p=0;p<n;p++)a=r.currentVisibles0[p],l=0,this.renderer.renderNeoRefListsAsimetricVersionColorSelection(e,a,i,this,!1,h,l,0,c);n=r.currentVisibles1.length;for(p=0;p<n;p++)a=r.currentVisibles1[p],l=0,this.renderer.renderNeoRefListsAsimetricVersionColorSelection(e,a,i,this,!1,h,l,0,c);void 0===this.colorAux&&(this.colorAux=new Color),e.uniformMatrix4fv(h.refMatrix_loc,!1,g.rotMatrix._floatArrays),n=r.currentVisibles2.length;for(p=0;p<n;p++)void 0!==(a=r.currentVisibles2[p]).lego&&a.lego.fileLoadState===CODE.fileLoadState.PARSE_FINISHED&&(this.colorAux=this.selectionColor.getAvailableColor(this.colorAux),s=this.selectionColor.decodeColor3(this.colorAux.r,this.colorAux.g,this.colorAux.b),this.selectionCandidates.setCandidates(s,void 0,a,o,i),e.uniform1i(h.hasTexture_loc,!1),e.uniform4fv(h.color4Aux_loc,[this.colorAux.r/255,this.colorAux.g/255,this.colorAux.b/255,1]),e.uniform1i(h.hasAditionalMov_loc,!1),e.uniform3fv(h.aditionalMov_loc,[0,0,0]),this.renderer.renderLodBuildingColorSelection(e,a.lego,this,h))}}var m=t.currentVisibles2.length;for(f=0;f<m;f++){o=(i=t.currentVisibles2[f]).data.neoBuilding;g=this.getNodeGeoLocDataManager(i).getCurrentGeoLocationData();if(e.uniformMatrix4fv(h.buildingRotMatrix_loc,!1,g.rotMatrix._floatArrays),e.uniform3fv(h.buildingPosHIGH_loc,g.positionHIGH),e.uniform3fv(h.buildingPosLOW_loc,g.positionLOW),r=o.currentVisibleOctreesControler){e.uniformMatrix4fv(h.refMatrix_loc,!1,g.rotMatrix._floatArrays),n=r.currentVisibles2.length;for(p=0;p<n;p++)void 0!==(a=r.currentVisibles2[p]).lego&&a.lego.fileLoadState!==CODE.fileLoadState.READY&&2!==a.lego.fileLoadState&&(this.colorAux=this.selectionColor.getAvailableColor(this.colorAux),s=this.selectionColor.decodeColor3(this.colorAux.r,this.colorAux.g,this.colorAux.b),this.selectionCandidates.setCandidates(s,void 0,a,o,i),e.uniform1i(h.hasTexture_loc,!1),e.uniform4fv(h.color4Aux_loc,[this.colorAux.r/255,this.colorAux.g/255,this.colorAux.b/255,1]),e.uniform1i(h.hasAditionalMov_loc,!1),e.uniform3fv(h.aditionalMov_loc,[0,0,0]),this.renderer.renderLodBuildingColorSelection(e,a.lego,this,h))}}var y=t.currentVisibles3.length;e.uniform1i(h.refMatrixType_loc,0);for(f=0;f<y;f++){o=(i=t.currentVisibles3[f]).data.neoBuilding;g=this.getNodeGeoLocDataManager(i).getCurrentGeoLocationData();e.uniformMatrix4fv(h.buildingRotMatrix_loc,!1,g.rotMatrix._floatArrays),e.uniform3fv(h.buildingPosHIGH_loc,g.positionHIGH),e.uniform3fv(h.buildingPosLOW_loc,g.positionLOW);o.currentLod;e.uniformMatrix4fv(h.refMatrix_loc,!1,g.rotMatrix._floatArrays);var v=o.getCurrentSkin();void 0!==v&&(v.fileLoadState===CODE.fileLoadState.PARSE_FINISHED&&(this.colorAux=this.selectionColor.getAvailableColor(this.colorAux),s=this.selectionColor.decodeColor3(this.colorAux.r,this.colorAux.g,this.colorAux.b),this.selectionCandidates.setCandidates(s,void 0,void 0,o,i),e.uniform1i(h.hasTexture_loc,!1),e.uniform4fv(h.color4Aux_loc,[this.colorAux.r/255,this.colorAux.g/255,this.colorAux.b/255,1]),e.uniform1i(h.hasAditionalMov_loc,!1),e.uniform3fv(h.aditionalMov_loc,[0,0,0]),this.renderer.renderLodBuildingColorSelection(e,v,this,h)))}-1!==h.position3_loc&&e.disableVertexAttribArray(h.position3_loc),e.disableVertexAttribArray(h.position3_loc)},MagoManager.prototype.getSelectedObjects=function(e,t,i,o){var r=new Uint8Array(4);e.readPixels(t,this.sceneState.drawingBufferHeight-i,1,1,e.RGBA,e.UNSIGNED_BYTE,r),e.bindFramebuffer(e.FRAMEBUFFER,null);var n=64516*r[0]+254*r[1]+r[2];this.selectionCandidates.selectObjects(n);var a=this.selectionCandidates.currentReferenceSelected;return o[0]=this.selectionCandidates.currentBuildingSelected,o[1]=this.selectionCandidates.currentOctreeSelected,o[2]=this.selectionCandidates.currentReferenceSelected,o[3]=this.selectionCandidates.currentNodeSelected,a},MagoManager.prototype.getRayWorldSpace=function(e,t,i,o){void 0===o&&(o=new Line);var r=this.sceneState.camera.position,n=new Float32Array(3);return n=this.getRayCamSpace(t,i,n),void 0===this.pointSC&&(this.pointSC=new Point3D),this.pointSC.set(n[0],n[1],n[2]),this.pointSC2=this.sceneState.modelViewMatrixInv.rotatePoint3D(this.pointSC,this.pointSC2),this.pointSC2.unitary(),o.setPointAndDir(r.x,r.y,r.z,this.pointSC2.x,this.pointSC2.y,this.pointSC2.z),o},MagoManager.prototype.getRayCamSpace=function(e,t,i){var o=this.sceneState.camera.frustum.fovyRad,r=this.sceneState.camera.frustum.aspectRatio,n=2*Math.tan(o/2)*1,a=n*r,s=e,l=this.sceneState.drawingBufferHeight-t;return void 0===i&&(i=new Float32Array(3)),i[0]=a*(s/this.sceneState.drawingBufferWidth-.5),i[1]=n*(l/this.sceneState.drawingBufferHeight-.5),i[2]=-1,i},MagoManager.prototype.calculateSelObjMovePlaneAsimetricMode=function(e,t,i,o){void 0===this.pointSC&&(this.pointSC=new Point3D),void 0===this.pointSC2&&(this.pointSC2=new Point3D);var r=this.getNodeGeoLocDataManager(this.nodeSelected);this.calculatePixelPositionWorldCoord(e,t,i,this.pointSC2);var n=r.getCurrentGeoLocationData();return this.pointSC=n.tMatrixInv.transformPoint3D(this.pointSC2,this.pointSC),void 0===o&&(o=new Plane),o.setPointAndNormal(this.pointSC.x,this.pointSC.y,this.pointSC.z,0,0,1),o},MagoManager.prototype.calculatePixelPositionCamCoord=function(e,t,i,o){e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.depthRange(0,1),e.frontFace(e.CCW);var r=this.sceneState.camera.frustum.far;if(this.depthFboNeo)this.depthFboNeo.bind();else{void 0===this.depthFboNeo&&(this.depthFboNeo=new FBO(e,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight)),this.depthFboNeo.bind(),e.clearColor(1,1,1,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.disable(e.BLEND);this.depthRenderLowestOctreeAsimetricVersion(e,0,this.visibleObjControlerNodes)}var n=new Uint8Array(4);e.readPixels(t,this.sceneState.drawingBufferHeight-i,1,1,e.RGBA,e.UNSIGNED_BYTE,n);var a=n[0]/16777216+n[1]/65536+n[2]/256+n[3],s=(a/=256)*r;return this.resultRaySC=this.getRayCamSpace(t,i,this.resultRaySC),void 0===o&&(o=new Point3D),this.depthFboNeo.unbind(),o.set(this.resultRaySC[0]*s,this.resultRaySC[1]*s,this.resultRaySC[2]*s),e.bindFramebuffer(e.FRAMEBUFFER,null),o},MagoManager.prototype.calculatePixelPositionWorldCoord=function(e,t,i,o){var r=new Point3D;if(r=this.calculatePixelPositionCamCoord(e,t,i,r),void 0===o)o=new Point3D;return o=this.cameraCoordPositionToWorldCoord(r,o)},MagoManager.prototype.cameraCoordPositionToWorldCoord=function(e,t){var i=this.sceneState.modelViewMatrixInv;if(void 0===t)t=new Point3D;return t=i.transformPoint3D(e,t)},MagoManager.prototype.calculateWorldPositionToScreenCoord=function(e,t,i,o,r){void 0===r&&(r=new Point3D),void 0===this.pointSC&&(this.pointSC=new Point3D),void 0===this.pointSC2&&(this.pointSC2=new Point3D),this.pointSC.set(t,i,o),this.pointSC2=this.sceneState.modelViewMatrix.transformPoint3D(this.pointSC,this.pointSC2);var n=this.pointSC2.z;if(n>0)return r.set(-1,-1,0),r;var a=this.sceneState.camera.frustum.tangentOfHalfFovy*n*2,s=a*this.sceneState.camera.frustum.aspectRatio,l=-this.pointSC2.x*this.sceneState.drawingBufferWidth/s,c=-this.pointSC2.y*this.sceneState.drawingBufferHeight/a;return l+=this.sceneState.drawingBufferWidth/2,c+=this.sceneState.drawingBufferHeight/2,c=this.sceneState.drawingBufferHeight-c,r.set(l,c,0),r},MagoManager.prototype.isDragging=function(){var e=this.sceneState.gl;if(this.magoPolicy.objectMoveMode===CODE.moveMode.ALL){this.arrayAuxSC.length=0,this.selectionFbo.bind();var t,i=this.getSelectedObjects(e,this.mouse_x,this.mouse_y,this.arrayAuxSC),o=(this.arrayAuxSC[0],this.arrayAuxSC[3]);return o&&(t=o.getRoot()),this.arrayAuxSC.length=0,t===this.rootNodeSelected}if(this.magoPolicy.objectMoveMode===CODE.moveMode.OBJECT){this.arrayAuxSC.length=0,this.selectionFbo.bind();i=this.getSelectedObjects(e,this.mouse_x,this.mouse_y,this.arrayAuxSC);return this.arrayAuxSC.length=0,i===this.objectSelected}return!1},MagoManager.prototype.setCameraMotion=function(e){this.configInformation.geo_view_library===Constant.WORLDWIND?(this.wwd.navigator.panRecognizer.enabled=e,this.wwd.navigator.primaryDragRecognizer.enabled=e):this.configInformation.geo_view_library===Constant.CESIUM&&(this.scene.screenSpaceCameraController.enableRotate=e,this.scene.screenSpaceCameraController.enableZoom=e,this.scene.screenSpaceCameraController.enableLook=e,this.scene.screenSpaceCameraController.enableTilt=e,this.scene.screenSpaceCameraController.enableTranslate=e)},MagoManager.prototype.mouseActionLeftDown=function(e,t){this.dateSC=new Date,this.startTimeSC=this.dateSC.getTime(),this.mouse_x=e,this.mouse_y=t,this.mouseLeftDown=!0},MagoManager.prototype.saveHistoryObjectMovement=function(e,t){var i=new ChangeHistory,o=i.getReferenceObjectAditionalMovement(),r=i.getReferenceObjectAditionalMovementRelToBuilding();if(void 0===e.moveVector&&(e.moveVector=new Point3D),void 0===e.moveVectorRelToBuilding&&(e.moveVectorRelToBuilding=new Point3D),o.set(e.moveVector.x,e.moveVector.y,e.moveVector.z),r.set(e.moveVectorRelToBuilding.x,e.moveVectorRelToBuilding.y,e.moveVectorRelToBuilding.z),void 0!==t){var n=t.data.projectId,a=t.data.nodeId,s=e._id;i.setProjectId(n),i.setDataKey(a),i.setObjectIndexOrder(s),MagoConfig.saveMovingHistory(n,a,s,i)}},MagoManager.prototype.mouseActionLeftUp=function(e,t){if(this.objectMoved){this.objectMoved=!1;var i=this.selectionCandidates.currentNodeSelected;if(void 0===i)return;this.saveHistoryObjectMovement(this.objectSelected,i)}this.isCameraMoving=!1,this.mouseLeftDown=!1,this.mouseDragging=!1,this.selObjMovePlane=void 0,this.mustCheckIfDragging=!0,this.thereAreStartMovePoint=!1,this.dateSC=new Date,this.currentTimeSC=this.dateSC.getTime(),this.currentTimeSC-this.startTimeSC<1500&&this.mouse_x===e&&this.mouse_y===t&&(this.bPicking=!0),this.setCameraMotion(!0)},MagoManager.prototype.mouseActionMiddleDown=function(e,t){this.dateSC=new Date,this.startTimeSC=this.dateSC.getTime(),this.mouse_x=e,this.mouse_y=t,this.mouseMiddleDown=!0,this.isCameraMoving=!0},MagoManager.prototype.mouseActionMiddleUp=function(e,t){this.isCameraMoving=!1,this.mouseMiddleDown=!1,this.mouseDragging=!1,this.selObjMovePlane=void 0,this.mustCheckIfDragging=!0,this.thereAreStartMovePoint=!1,this.setCameraMotion(!1)},MagoManager.prototype.mouseActionRightDown=function(e,t){},MagoManager.prototype.mouseActionRightUp=function(e,t){},MagoManager.prototype.mouseActionMove=function(e,t){this.mouseLeftDown?this.manageMouseDragging(e,t):this.mouseMiddleDown?this.sceneState.camera.setDirty(!0):this.mouseRightDown?this.sceneState.camera.setDirty(!0):(this.mouseDragging=!1,this.setCameraMotion(!1),this.mouseMiddleDown&&(this.isCameraMoving=!0))},MagoManager.prototype.manageMouseDragging=function(e,t){if(this.sceneState.camera.setDirty(!0),this.magoPolicy.objectMoveMode===CODE.moveMode.ALL)if(void 0!==this.buildingSelected){this.mouse_x=e,this.mouse_y=t,this.mustCheckIfDragging&&(this.isDragging()&&(this.mouseDragging=!0,this.setCameraMotion(!1)),this.mustCheckIfDragging=!1);var i=this.buildingSelected.nodeOwner;if(void 0===i)return;var o=i.data.geoLocDataManager;if(void 0===o)return;var r=o.getGeoLocationData(0);if(void 0===r)return;var n=r.geographicCoord;if(void 0===n)return;movedDataCallback(MagoConfig.getPolicy().geo_callback_moveddata,i.data.projectId,i.data.nodeId,null,n.latitude,n.longitude,n.altitude,r.heading,r.pitch,r.roll)}else this.isCameraMoving=!0;else this.magoPolicy.objectMoveMode===CODE.moveMode.OBJECT&&(void 0!==this.objectSelected?(this.mouse_x=e,this.mouse_y=t,this.mustCheckIfDragging&&(this.isDragging()&&(this.mouseDragging=!0,this.setCameraMotion(!1)),this.mustCheckIfDragging=!1)):this.isCameraMoving=!0);this.isCameraMoving=!0,this.mouseDragging&&this.moveSelectedObjectAsimetricMode(this.sceneState.gl)},MagoManager.prototype.moveSelectedObjectAsimetricMode=function(e){if(this.magoPolicy.objectMoveMode===CODE.moveMode.ALL){if(void 0===this.selectionCandidates.currentNodeSelected)return;var t=(u=this.getNodeGeoLocDataManager(this.selectionCandidates.currentNodeSelected)).getCurrentGeoLocationData();if(void 0===this.selObjMovePlane){this.selObjMovePlane=new Plane;var i=new Point3D;i=this.calculatePixelPositionWorldCoord(e,this.mouse_x,this.mouse_y,i);var o=t.tMatrixInv.transformPoint3D(i,o);this.selObjMovePlane.setPointAndNormal(o.x,o.y,o.z,0,0,1)}void 0===this.lineSC&&(this.lineSC=new Line),this.lineSC=this.getRayWorldSpace(e,this.mouse_x,this.mouse_y,this.lineSC);var r=new Point3D,n=new Point3D;r=t.geoLocMatrixInv.transformPoint3D(this.lineSC.point,r),this.pointSC=t.geoLocMatrixInv.rotatePoint3D(this.lineSC.direction,this.pointSC),n.x=this.pointSC.x,n.y=this.pointSC.y,n.z=this.pointSC.z,(f=new Line).setPointAndDir(r.x,r.y,r.z,n.x,n.y,n.z);var a=new Point3D;if((a=this.selObjMovePlane.intersectionLine(f,a)).set(-a.x,-a.y,-a.z),void 0===this.pointSC&&(this.pointSC=new Point3D),this.pointSC=t.geoLocMatrix.transformPoint3D(a,this.pointSC),a.set(this.pointSC.x,this.pointSC.y,this.pointSC.z),this.thereAreStartMovePoint){d=ManagerUtils.pointToGeographicCoord(a,d,this);this.pointSC.x=d.longitude,this.pointSC.y=d.latitude;var s=this.pointSC.x-this.startMovPoint.x,l=this.pointSC.y-this.startMovPoint.y,c=t.geographicCoord.longitude-s,h=t.geographicCoord.latitude-l;this.changeLocationAndRotationNode(this.selectionCandidates.currentNodeSelected,h,c,void 0,void 0,void 0,void 0),this.displayLocationAndRotation(this.buildingSelected),this.startMovPoint.x-=s,this.startMovPoint.y-=l}else{var d=ManagerUtils.pointToGeographicCoord(a,d,this);this.startMovPoint.x=d.longitude,this.startMovPoint.y=d.latitude,this.thereAreStartMovePoint=!0}}else if(this.magoPolicy.objectMoveMode===CODE.moveMode.OBJECT){if(void 0===this.objectSelected)return;void 0===this.selObjMovePlane&&(this.selObjMovePlane=this.calculateSelObjMovePlaneAsimetricMode(e,this.mouse_x,this.mouse_y,this.selObjMovePlane));var u=this.getNodeGeoLocDataManager(this.selectionCandidates.currentNodeSelected);void 0===this.lineSC&&(this.lineSC=new Line),this.getRayWorldSpace(e,this.mouse_x,this.mouse_y,this.lineSC);var f,g=u.getCurrentGeoLocationData();r=new Point3D,n=new Point3D;r=g.tMatrixInv.transformPoint3D(this.lineSC.point,r),n=g.tMatrixInv.rotatePoint3D(this.lineSC.direction,n),(f=new Line).setPointAndDir(r.x,r.y,r.z,n.x,n.y,n.z);a=new Point3D;if(a=this.selObjMovePlane.intersectionLine(f,a),void 0===this.objectSelected.moveVectorRelToBuilding&&(this.objectSelected.moveVectorRelToBuilding=new Point3D),this.thereAreStartMovePoint){s=a.x-this.startMovPoint.x,l=a.y-this.startMovPoint.y;var p=a.z-this.startMovPoint.z;this.objectSelected.moveVectorRelToBuilding.set(s,l,p),this.objectSelected.moveVector=g.tMatrix.rotatePoint3D(this.objectSelected.moveVectorRelToBuilding,this.objectSelected.moveVector)}else this.startMovPoint=a,this.startMovPoint.add(-this.objectSelected.moveVectorRelToBuilding.x,-this.objectSelected.moveVectorRelToBuilding.y,-this.objectSelected.moveVectorRelToBuilding.z),this.thereAreStartMovePoint=!0;var m=this.selectionCandidates.currentNodeSelected.data.projectId,y=this.selectionCandidates.currentNodeSelected.data.nodeId,v=this.objectSelected._id;MagoConfig.deleteMovingHistoryObject(m,y,v),this.objectMoved=!0}},MagoManager.prototype.getRenderablesDetailedNeoBuildingAsimetricVersion=function(e,t,i,o){var r=t.data.neoBuilding;if(void 0!==r&&void 0!==r.octree){var n=this.getNodeGeoLocDataManager(t),a=(n.getCurrentGeoLocationData(),n.getCurrentGeoLocationData());if(void 0===a)return!1;void 0===r.currentVisibleOctreesControler&&(r.currentVisibleOctreesControler=new VisibleObjectsController);var s,l=this.magoPolicy.getLod0DistInMeters(),c=this.magoPolicy.getLod1DistInMeters(),h=this.magoPolicy.getLod2DistInMeters(),d=(this.magoPolicy.getLod3DistInMeters(),this.magoPolicy.getLod4DistInMeters(),this.magoPolicy.getLod5DistInMeters()),u=!1;if(void 0===this.myCameraRelative&&(this.myCameraRelative=new Camera),this.myCameraRelative.frustum.copyParametersFrom(this.myCameraSCX.bigFrustum),this.myCameraRelative=a.getTransformedRelativeCamera(this.sceneState.camera,this.myCameraRelative),r.currentVisibleOctreesControler.clear(),2===o)r.octree.extractLowestOctreesByLOD(r.currentVisibleOctreesControler,i,this.boundingSphere_Aux,this.myCameraRelative.position,l,c,d),u=!0;else{this.myCameraRelative.calculateFrustumsPlanes();var f=this.myCameraRelative.bigFrustum;u=r.octree.getFrustumVisibleLowestOctreesByLOD(f,r.currentVisibleOctreesControler,i,this.boundingSphere_Aux,this.myCameraRelative.position,l,c,100*h)}if(!u)return r.distToCam>10&&this.processQueue.putNodeToDeleteModelReferences(t,1),!1;this.processQueue.eraseNodeToDeleteModelReferences(t);var g=[].concat(r.currentVisibleOctreesControler.currentVisibles0,r.currentVisibleOctreesControler.currentVisibles1),p=r.getRenderSettingApplyOcclusionCulling();0===g.length?this.processQueue.putNodeToDeleteModelReferences(t,0):this.processQueue.eraseNodeToDeleteModelReferences(t);for(var m=!1,y=0,v=g.length;y<v;y++)if(m=!1,0!==(s=g[y]).triPolyhedronsCount){void 0===s.neoReferencesMotherAndIndices?(s.neoReferencesMotherAndIndices=new NeoReferencesMotherAndIndices,s.neoReferencesMotherAndIndices.motherNeoRefsList=r.motherNeoReferencesArray,m=!0):s.neoReferencesMotherAndIndices.updateCurrentVisibleIndices(this.myCameraRelative.position.x,this.myCameraRelative.position.y,this.myCameraRelative.position.z,p);var x=s.neoReferencesMotherAndIndices.blocksList;void 0!==x&&x.fileLoadState===CODE.fileLoadState.PARSE_FINISHED||(m=!0),m&&r.currentVisibleOctreesControler.currentVisibles2.push(s)}g.length=0;var b,C=!0,M=r.currentVisibleOctreesControler.currentVisibles2.length;M>6&&(M=6);for(var _=0;_<M;_++)if(void 0===(b=r.currentVisibleOctreesControler.currentVisibles2[_]).lego||b.lego.fileLoadState!==CODE.fileLoadState.PARSE_FINISHED){C=!1;break}return C||(r.currentLod=3,this.visibleObjControlerNodes.putNodeToArraySortedByDist(this.visibleObjControlerNodes.currentVisibles3,t)),!0}},MagoManager.prototype.manageQueue=function(){var e=this.sceneState.gl,t=8,i=Object.keys(this.processQueue.nodesToDeleteMap).length;for(var o in i<t&&(t=i),this.processQueue.nodesToDeleteMap)if(Object.prototype.hasOwnProperty.call(this.processQueue.nodesToDeleteMap,o)){if(void 0===(v=this.processQueue.nodesToDeleteMap[o]))continue;if(p=v.data.neoBuilding,this.processQueue.eraseNodeToDelete(v),void 0===p)continue;var r=!0;1==o&&(r=!1),this.deleteNeoBuilding(e,p,r)}var n=0;for(var o in this.processQueue.nodesToDeleteModelReferencesMap)if(Object.prototype.hasOwnProperty.call(this.processQueue.nodesToDeleteModelReferencesMap,o)){if(void 0===(v=this.processQueue.nodesToDeleteModelReferencesMap[o]).data)continue;if(p=v.data.neoBuilding,this.processQueue.eraseNodeToDeleteModelReferences(p),void 0===p)continue;if(p.octree&&p.octree.deleteObjectsModelReferences(e,this.vboMemoryManager),(p.motherBlocksArray.length>0||p.motherNeoReferencesArray.length>0)&&n++,p.deleteObjectsModelReferences(e,this.vboMemoryManager),n>10)break}var a=0;for(var o in this.processQueue.nodesToDeleteLessThanLod3Map)if(void 0!==(v=this.processQueue.nodesToDeleteLessThanLod3Map[o]).data&&this.processQueue.eraseNodeToDeleteLessThanLod3(v)){if(void 0===(p=v.data.neoBuilding))continue;if(p.octree&&p.octree.deleteObjectsModelReferences(e,this.vboMemoryManager),(p.motherBlocksArray.length>0||p.motherNeoReferencesArray.length>0)&&n++,p.deleteObjectsModelReferences(e,this.vboMemoryManager),p.deleteObjectsLod2(e,this.vboMemoryManager),++a>10)break}for(var o in a=0,this.processQueue.nodesToDeleteLessThanLod4Map)if(void 0!==(v=this.processQueue.nodesToDeleteLessThanLod4Map[o]).data&&this.processQueue.eraseNodeToDeleteLessThanLod4(v)){if(void 0===(p=v.data.neoBuilding))continue;if(p.deleteObjectsModelReferences(e,this.vboMemoryManager),p.deleteObjectsLod2(e,this.vboMemoryManager),p.deleteObjectsLodMesh(e,this.vboMemoryManager,"lod3"),++a>10)break}for(var o in a=0,this.processQueue.nodesToDeleteLessThanLod5Map)if(void 0!==(v=this.processQueue.nodesToDeleteLessThanLod5Map[o]).data&&this.processQueue.eraseNodeToDeleteLessThanLod5(v)){if(void 0===(p=v.data.neoBuilding))continue;if(p.deleteObjectsModelReferences(e,this.vboMemoryManager),p.deleteObjectsLod2(e,this.vboMemoryManager),p.deleteObjectsLodMesh(e,this.vboMemoryManager,"lod3"),p.deleteObjectsLodMesh(e,this.vboMemoryManager,"lod4"),++a>10)break}a=0;var s,l=1,c=0;if(void 0===this.matrix4SC&&(this.matrix4SC=new Matrix4),c=0,l=1,this.parseQueue.parseOctreesLod0References(e,this.visibleObjControlerOctrees,this,l)&&this.selectionFbo&&(this.selectionFbo.dirty=!0),c=0,l=1,Object.keys(this.parseQueue.octreesLod0ReferencesToParseMap).length>0){for(var h=this.visibleObjControlerOctrees.currentVisibles1.length,d=0;d<h&&(u=this.visibleObjControlerOctrees.currentVisibles1[d],this.parseQueue.parseOctreesLod0References(e,u,this)&&c++,!(c>l));d++);if(0===c)for(var o in this.parseQueue.octreesLod0ReferencesToParseMap)if(Object.prototype.hasOwnProperty.call(this.parseQueue.octreesLod0ReferencesToParseMap,o)){var u=this.parseQueue.octreesLod0ReferencesToParseMap[o];if(this.parseQueue.parseOctreesLod0References(e,u,this),++c>l)break}c>0&&this.selectionFbo&&(this.selectionFbo.dirty=!0)}if(c=0,l=1,Object.keys(this.parseQueue.octreesLod0ModelsToParseMap).length>0){for(h=this.visibleObjControlerOctrees.currentVisibles0.length,d=0;d<h;d++){if(u=this.visibleObjControlerOctrees.currentVisibles0[d],this.parseQueue.octreesLod0ModelsToParseMap.hasOwnProperty(u.octreeKey)){if(delete this.parseQueue.octreesLod0ModelsToParseMap[u.octreeKey],void 0===u.neoReferencesMotherAndIndices)continue;if(void 0===(f=u.neoReferencesMotherAndIndices.blocksList))continue;if(void 0===f.dataArraybuffer)continue;if(f.fileLoadState!==CODE.fileLoadState.LOADING_FINISHED)continue;"v"===(p=u.neoBuildingOwner).getHeaderVersion()[0]?f.parseBlocksList(f.dataArraybuffer,this.readerWriter,p.motherBlocksArray,this):f.parseBlocksListVersioned(f.dataArraybuffer,this.readerWriter,p.motherBlocksArray,this),f.dataArraybuffer=void 0,c++}if(c>l)break}if(0===c)for(var o in this.parseQueue.octreesLod0ModelsToParseMap)if(Object.prototype.hasOwnProperty.call(this.parseQueue.octreesLod0ModelsToParseMap,o)){u=this.parseQueue.octreesLod0ModelsToParseMap[o];if(delete this.parseQueue.octreesLod0ModelsToParseMap[o],void 0===u.neoReferencesMotherAndIndices)continue;if(void 0===(f=u.neoReferencesMotherAndIndices.blocksList))continue;if(void 0===f.dataArraybuffer)continue;if(f.fileLoadState!==CODE.fileLoadState.LOADING_FINISHED)continue;if("v"===(p=u.neoBuildingOwner).getHeaderVersion()[0]?f.parseBlocksList(f.dataArraybuffer,this.readerWriter,p.motherBlocksArray,this):f.parseBlocksListVersioned(f.dataArraybuffer,this.readerWriter,p.motherBlocksArray,this),f.dataArraybuffer=void 0,++c>l)break}c>0&&this.selectionFbo&&(this.selectionFbo.dirty=!0)}if(c=0,l=1,Object.keys(this.parseQueue.octreesLod0ModelsToParseMap).length>0){for(h=this.visibleObjControlerOctrees.currentVisibles1.length,d=0;d<h;d++){if(u=this.visibleObjControlerOctrees.currentVisibles1[d],this.parseQueue.octreesLod0ModelsToParseMap.hasOwnProperty(u.octreeKey)){if(delete this.parseQueue.octreesLod0ModelsToParseMap[u.octreeKey],void 0===u.neoReferencesMotherAndIndices)continue;if(void 0===(f=u.neoReferencesMotherAndIndices.blocksList))continue;if(void 0===f.dataArraybuffer)continue;if(f.fileLoadState!==CODE.fileLoadState.LOADING_FINISHED)continue;"v"===(p=u.neoBuildingOwner).getHeaderVersion()[0]?f.parseBlocksList(f.dataArraybuffer,this.readerWriter,p.motherBlocksArray,this):f.parseBlocksListVersioned(f.dataArraybuffer,this.readerWriter,p.motherBlocksArray,this),f.dataArraybuffer=void 0,c++}if(c>l)break}if(0===c)for(var o in this.parseQueue.octreesLod0ModelsToParseMap)if(Object.prototype.hasOwnProperty.call(this.parseQueue.octreesLod0ModelsToParseMap,o)){var f;u=this.parseQueue.octreesLod0ModelsToParseMap[o];if(delete this.parseQueue.octreesLod0ModelsToParseMap[o],void 0===u.neoReferencesMotherAndIndices)continue;if(void 0===(f=u.neoReferencesMotherAndIndices.blocksList))continue;if(void 0===f.dataArraybuffer)continue;if(f.fileLoadState!==CODE.fileLoadState.LOADING_FINISHED)continue;if("v"===(p=u.neoBuildingOwner).getHeaderVersion()[0]?f.parseBlocksList(f.dataArraybuffer,this.readerWriter,p.motherBlocksArray,this):f.parseBlocksListVersioned(f.dataArraybuffer,this.readerWriter,p.motherBlocksArray,this),f.dataArraybuffer=void 0,++c>l)break}c>0&&this.selectionFbo&&(this.selectionFbo.dirty=!0)}if(c=0,l=1,Object.keys(this.parseQueue.octreesLod2LegosToParseMap).length>0){for(h=this.visibleObjControlerOctrees.currentVisibles2.length,d=0;d<h;d++){if(u=this.visibleObjControlerOctrees.currentVisibles2[d],this.parseQueue.octreesLod2LegosToParseMap.hasOwnProperty(u.octreeKey)){if(delete this.parseQueue.octreesLod2LegosToParseMap[u.octreeKey],void 0===u.lego)continue;u.lego.parseArrayBuffer(e,u.lego.dataArrayBuffer,this),u.lego.dataArrayBuffer=void 0,c++}if(c>l)break}if(0===c)for(var o in this.parseQueue.octreesLod2LegosToParseMap)if(Object.prototype.hasOwnProperty.call(this.parseQueue.octreesLod2LegosToParseMap,o)){u=this.parseQueue.octreesLod2LegosToParseMap[o];if(this.parseQueue.octreesLod2LegosToParseMap.hasOwnProperty(o)){if(delete this.parseQueue.octreesLod2LegosToParseMap[o],void 0===u.lego)continue;u.lego.parseArrayBuffer(e,u.lego.dataArrayBuffer,this),u.lego.dataArrayBuffer=void 0,c++}if(c>l)break}c>0&&this.selectionFbo&&(this.selectionFbo.dirty=!0)}if(c=0,l=1,Object.keys(this.parseQueue.octreesPCloudToParseMap).length>0){for(h=this.visibleObjControlerOctrees.currentVisiblesAux.length,d=0;d<h;d++){if(u=this.visibleObjControlerOctrees.currentVisiblesAux[d],this.parseQueue.eraseOctreePCloudToParse(u)){if(void 0===u.lego)continue;u.lego.parsePointsCloudData(e,u.lego.dataArrayBuffer,this),u.lego.dataArrayBuffer=void 0,c++}if(c>l)break}if(0===c)for(var o in this.parseQueue.octreesPCloudToParseMap){u=this.parseQueue.octreesPCloudToParseMap[o];if(this.parseQueue.eraseOctreePCloudToParse(u)){if(void 0===u.lego)continue;u.lego.parsePointsCloudData(u.lego.dataArrayBuffer,e,this),u.lego.dataArrayBuffer=void 0,c++}if(c>l)break}c>0&&this.selectionFbo&&(this.selectionFbo.dirty=!0)}if(c=0,l=1,Object.keys(this.parseQueue.skinLegosToParseMap).length>0){var g,p,m=this.visibleObjControlerNodes.currentVisibles3.length;for(d=0;d<m;d++){if(void 0!==(p=(v=this.visibleObjControlerNodes.currentVisibles3[d]).data.neoBuilding)&&void 0!==p.lodMeshesMap)if(!((b=x=p.currentLod)<0)){var y=void 0;if(0===x?y="lod0":1===x?y="lod1":2===x?y="lod2":3===x?y="lod3":4===x?y="lod4":5===x&&(y="lod5"),void 0!==y&&void 0!==(g=p.lodMeshesMap[y])&&(this.parseQueue.skinLegosToParseMap.hasOwnProperty(g.legoKey)&&(delete this.parseQueue.skinLegosToParseMap[g.legoKey],g.parseArrayBuffer(e,g.dataArrayBuffer,this),g.dataArrayBuffer=void 0,c++),c>l))break}}if(0===c)for(var o in this.parseQueue.skinLegosToParseMap)if(Object.prototype.hasOwnProperty.call(this.parseQueue.skinLegosToParseMap,o)){var v,x,b;if(void 0===(v=this.parseQueue.skinLegosToParseMap[o]).data)continue;if(void 0===(p=v.data.neoBuilding))continue;if((b=(x=p.currentLod)-3)<0)continue;if(void 0===(g=p.lodMeshesArray[b]))continue;if(this.parseQueue.skinLegosToParseMap.hasOwnProperty(g.legoKey)&&(delete this.parseQueue.skinLegosToParseMap[g.legoKey],g.parseArrayBuffer(e,g.dataArrayBuffer,this),g.dataArrayBuffer=void 0,c++),c>l)break}}var C=this.tinTerrainManager.currentVisibles_terrName_geoCoords_map;for(var o in C)void 0!==(s=this.tinTerrainManager.currentTerrainsMap[o])&&this.parseQueue.eraseTinTerrainToParse(s)&&s.parseData(s.dataArrayBuffer)},MagoManager.prototype.prepareVisibleOctreesSortedByDistancePointsCloudType=function(e,t,i){if(!(Object.keys(this.loadQueue.lod2PCloudDataMap).length>5)){var o=i,r=[].concat(t.currentVisibles0,t.currentVisibles1,t.currentVisibles2,t.currentVisibles3);if(void 0!==r)for(var n,a,s,l,c=this.readerWriter.geometryDataPath,h=0,d=r.length;h<d;h++){if(this.fileRequestControler.isFullPlus(o))return;if(void 0!==(l=r[h]).octree_number_name&&(void 0===l.lego&&(l.lego=new Lego,l.lego.fileLoadState=CODE.fileLoadState.READY,l.lego.legoKey=l.octreeKey+"_lego"),void 0!==(a=l.neoBuildingOwner))){if(n=a.projectFolderName,s=a.buildingFileName,l.lego.fileLoadState===CODE.fileLoadState.READY){var u=c+"/"+n+"/"+s+"/References"+"/"+l.octree_number_name.toString()+"_Ref";this.loadQueue.putLod2PCloudData(l,u,void 0,void 0,0)}if(Object.keys(this.loadQueue.lod2PCloudDataMap).length>5)return}}}},MagoManager.prototype.prepareVisibleOctreesSortedByDistance=function(e,t,i){if(!this.fileRequestControler.isFullPlusModelReferences(i)){var o,r,n,a,s=this.readerWriter.geometryDataPath,l=[].concat(t.currentVisibles0,t.currentVisibles1);this.thereAreUrgentOctrees=!1;for(var c=0,h=0,d=l.length;h<d;h++){if(this.fileRequestControler.isFullPlusModelReferences(i))return;if(void 0!==(n=(a=l[h]).neoBuildingOwner)&&0!==a.triPolyhedronsCount&&void 0!==a.octree_number_name){n.metaData.projectDataType;if(o=n.buildingFileName,r=n.projectFolderName,void 0===a.neoReferencesMotherAndIndices&&(a.neoReferencesMotherAndIndices=new NeoReferencesMotherAndIndices,a.neoReferencesMotherAndIndices.motherNeoRefsList=n.motherNeoReferencesArray),a.neoReferencesMotherAndIndices.fileLoadState===CODE.fileLoadState.READY){void 0===a.neoReferencesMotherAndIndices.blocksList&&(a.neoReferencesMotherAndIndices.blocksList=new BlocksList);var u=s+"/"+r+"/"+o+"/References"+"/"+a.octree_number_name.toString()+"_Ref";this.readerWriter.getNeoReferencesArraybuffer(u,a,this),c++}var f=a.neoReferencesMotherAndIndices.blocksList;if(void 0!==f){if(f.fileLoadState===CODE.fileLoadState.READY){var g=s+"/"+r+"/"+o+"/Models"+"/"+a.octree_number_name.toString()+"_Model";this.readerWriter.getNeoBlocksArraybuffer(g,a,this),c++}if(c>2)return}}}}},MagoManager.prototype.prepareVisibleOctreesSortedByDistanceLOD2=function(e,t,i){if(!(Object.keys(this.loadQueue.lod2SkinDataMap).length>5)){var o=i;if(void 0!==t)for(var r,n,a,s=this.readerWriter.geometryDataPath,l=0,c=t.length;l<c;l++){if(this.fileRequestControler.isFullPlus(o))return;if(void 0!==(a=t[l]).octree_number_name&&(void 0===a.lego&&(a.lego=new Lego,a.lego.fileLoadState=CODE.fileLoadState.READY,a.lego.legoKey=a.octreeKey+"_lego"),void 0!==(n=a.neoBuildingOwner))){r=n.projectFolderName,u=n.buildingFileName;var h=n.getHeaderVersion();if(a.lego.fileLoadState===CODE.fileLoadState.READY){var d=s+"/"+r+"/"+u+"/Bricks"+"/"+a.octree_number_name.toString()+"_Brick";if("v"===h[0])if(a.lego.vbo_vicks_container.vboCacheKeysArray[0]&&a.lego.vbo_vicks_container.vboCacheKeysArray[0].meshTexcoordsCacheKey){if(void 0===n.simpleBuilding3x3Texture){n.simpleBuilding3x3Texture=new Texture;var u,f=s+"/"+r+"/"+(u=n.buildingFileName)+"/SimpleBuildingTexture3x3.png";this.loadQueue.putLod2SkinData(a,d,n.simpleBuilding3x3Texture,f,0)}}else this.loadQueue.putLod2SkinData(a,d,void 0,void 0,0);else if(void 0===n.simpleBuilding3x3Texture){n.simpleBuilding3x3Texture=new Texture;f=s+"/"+r+"/"+u+"/"+n.getImageFileNameForLOD(2);this.loadQueue.putLod2SkinData(a,d,n.simpleBuilding3x3Texture,f,0)}else if(n.simpleBuilding3x3Texture.fileLoadState===CODE.fileLoadState.READY){f=s+"/"+r+"/"+u+"/"+n.getImageFileNameForLOD(2);this.loadQueue.putLod2SkinData(a,d,n.simpleBuilding3x3Texture,f,0)}else n.simpleBuilding3x3Texture.fileLoadState===CODE.fileLoadState.LOADING_FINISHED&&this.loadQueue.putLod2SkinData(a,d,void 0,void 0,0)}if(Object.keys(this.loadQueue.lod2SkinDataMap).length>5)return}}}},MagoManager.prototype.checkChangesHistoryMovements=function(e){for(var t,i,o,r,n,a,s,l,c,h,d,u=e.length,f=0;f<u;f++)if(void 0!==(i=(t=e[f]).getRoot())&&(d=this.getNodeGeoLocDataManager(i).getCurrentGeoLocationData(),o=t.data.projectId,r=t.data.nodeId,n=MagoConfig.getMovingHistoryObjects(o,r)))for(var g in s=t.data.neoBuilding,n)if(Object.prototype.hasOwnProperty.call(n,g)){var p=n[g];if(a=p.getObjectIndexOrder(),void 0===(l=s.getReferenceObject(a)))continue;void 0===l.moveVector&&(l.moveVector=new Point3D),void 0===l.moveVectorRelToBuilding&&(l.moveVectorRelToBuilding=new Point3D),c=p.getReferenceObjectAditionalMovement(),h=p.getReferenceObjectAditionalMovementRelToBuilding(),l.moveVectorRelToBuilding.set(h.x,h.y,h.z),l.moveVector.set(c.x,c.y,c.z),l.moveVector=d.tMatrix.rotatePoint3D(l.moveVectorRelToBuilding,l.moveVector)}},MagoManager.prototype.checkPropertyFilters=function(e){if(void 0!==this.propertyFilterSC)for(var t,i=e.length,o=this.propertyFilterSC.propertyKey,r=this.propertyFilterSC.propertyValue,n=this.propertyFilterSC.visible,a=0;a<i;a++)(t=e[a]).data.projectId===this.propertyFilterSC.projectId&&t.data.attributes&&(void 0!==t.data.attributes[o]&&t.data.attributes[o].toString()===r?"true"===n||(e.splice(a,1),a--,i=e.length):"true"===n&&(e.splice(a,1),a--,i=e.length))},MagoManager.prototype.checkChangesHistoryColors=function(e){for(var t,i,o,r=e.length,n=0;n<r;n++)if(void 0!==(t=e[n]).getRoot()&&(C=t.data.projectId,i=t.data.nodeId,p=MagoConfig.getColorHistorys(C,i)))for(var a in o=t.data.neoBuilding,p){if(Object.prototype.hasOwnProperty.call(p,a))if(null===(x=p[a]).objectId||void 0===x.objectId||""===x.objectId)if(null===x.property||void 0===x.property||""===x.property)o.isColorChanged=!0,void 0===o.aditionalColor&&(o.aditionalColor=new Color),o.aditionalColor.setRGB(x.rgbColor[0],x.rgbColor[1],x.rgbColor[2]);else{e=[];t.extractNodes(e);for(r=e.length,n=0;n<r;n++){b=e[n];var s=x.propertyKey,l=x.propertyValue;void 0!==b.data.attributes[s]&&b.data.attributes[s].toString()===l&&(o.isColorChanged=!0,void 0===o.aditionalColor&&(o.aditionalColor=new Color),o.aditionalColor.setRGB(x.rgbColor[0],x.rgbColor[1],x.rgbColor[2]))}}else{var c=x.objectId,h=o.getReferenceObjectsArrayByObjectId(c);if(h)for(var d=h.length,u=0;u<d;u++){var f=h[u];void 0===f.aditionalColor&&(f.aditionalColor=new Color),f.aditionalColor.setRGB(x.rgbColor[0],x.rgbColor[1],x.rgbColor[2])}}}var g=MagoConfig.getAllColorHistory();if(g)for(var a in g)if(Object.prototype.hasOwnProperty.call(g,a)){var p=g[a];for(var m in p)if(Object.prototype.hasOwnProperty.call(p,m)){var y=p[m];for(var v in y)if(Object.prototype.hasOwnProperty.call(y,v)){var x,b,C=(x=y[v]).projectId;if((b=this.hierarchyManager.getNodesMap(C)[x.dataKey])&&void 0!==b.data.attributes.isPhysical&&!1===b.data.attributes.isPhysical)if(null===x.property||void 0===x.property||""===x.property){e=[];b.extractNodes(e);for(r=e.length,n=0;n<r;n++){(o=(M=e[n]).data.neoBuilding)&&(o.isColorChanged=!0,void 0===o.aditionalColor&&(o.aditionalColor=new Color),o.aditionalColor.setRGB(x.rgbColor[0],x.rgbColor[1],x.rgbColor[2]))}}else{s=x.propertyKey,l=x.propertyValue,e=[];b.extractNodes(e);for(r=e.length,n=0;n<r;n++){var M;(o=(M=e[n]).data.neoBuilding)&&void 0!==M.data.attributes[s]&&M.data.attributes[s].toString()===l&&(o.isColorChanged=!0,void 0===o.aditionalColor&&(o.aditionalColor=new Color),o.aditionalColor.setRGB(x.rgbColor[0],x.rgbColor[1],x.rgbColor[2]))}}}}}},MagoManager.prototype.renderInvertedBox=function(e){},MagoManager.prototype.renderDirectionalLight=function(e,t,i,o,r,n){},MagoManager.prototype.renderGeometry=function(e,t,i,o,r,n){e.frontFace(e.CCW);var a,s,l;if(e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),!1,0===r&&(e.disable(e.BLEND),this.depthRenderLowestOctreeAsimetricVersion(e,r,n),this.magoPolicy.getShowOrigin()&&void 0!==this.nodeSelected)){var c=[l=this.nodeSelected];this.renderAxisNodes(e,c,!0,r)}if(1===r){var h=n.currentVisibles0.length;if(h>0){this.checkChangesHistoryMovements(n.currentVisibles0),this.checkChangesHistoryColors(n.currentVisibles0),void 0===this.noiseTexture&&(this.noiseTexture=genNoiseTextureRGBA(e,4,4,this.pixels)),x=(a=this.postFxShadersManager.getShader("modelRefSsao")).program,e.useProgram(x),e.uniform1i(a.bApplySpecularLighting_loc,!0),e.enableVertexAttribArray(a.texCoord2_loc),e.enableVertexAttribArray(a.position3_loc),e.enableVertexAttribArray(a.normal3_loc),a.bindUniformGenerals(),e.uniform1i(a.textureFlipYAxis_loc,this.sceneState.textureFlipYAxis),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.depthFboNeo.colorBuffer),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.noiseTexture);this.renderer.renderNodes(e,n.currentVisibles0,this,a,!1,r,0,0),a&&(-1!==a.texCoord2_loc&&e.disableVertexAttribArray(a.texCoord2_loc),-1!==a.position3_loc&&e.disableVertexAttribArray(a.position3_loc),-1!==a.normal3_loc&&e.disableVertexAttribArray(a.normal3_loc),-1!==a.color4_loc&&e.disableVertexAttribArray(a.color4_loc)),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,null)}var d=n.currentVisibles2.length,u=n.currentVisibles3.length;if((d>0||h>0||u>0)&&(this.checkChangesHistoryColors(n.currentVisibles2),x=(a=this.postFxShadersManager.getShader("lodBuildingSsao")).program,e.useProgram(x),e.uniform1i(a.bApplySpecularLighting_loc,!0),e.enableVertexAttribArray(a.position3_loc),e.enableVertexAttribArray(a.normal3_loc),e.enableVertexAttribArray(a.color4_loc),a.bindUniformGenerals(),e.uniform1i(a.textureFlipYAxis_loc,this.sceneState.textureFlipYAxis),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.depthFboNeo.colorBuffer),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.noiseTexture),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.textureAux_1x1),this.renderer.renderNeoBuildingsLOD2AsimetricVersion(e,n.currentVisibles0,this,a,!1,r),this.renderer.renderNeoBuildingsLOD2AsimetricVersion(e,n.currentVisibles2,this,a,!1,r),this.renderer.renderNeoBuildingsLowLOD(e,n.currentVisibles3,this,a,!1,r),a&&(-1!==a.texCoord2_loc&&e.disableVertexAttribArray(a.texCoord2_loc),-1!==a.position3_loc&&e.disableVertexAttribArray(a.position3_loc),-1!==a.normal3_loc&&e.disableVertexAttribArray(a.normal3_loc),-1!==a.color4_loc&&e.disableVertexAttribArray(a.color4_loc)),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,null)),this.nodeSelected){if(this.magoPolicy.getObjectMoveMode()===CODE.moveMode.OBJECT&&this.objectSelected){l=this.nodeSelected;var f=this.getNodeGeoLocDataManager(l);s=this.buildingSelected;var g=f.getCurrentGeoLocationData(),p=this.octreeSelected.neoReferencesMotherAndIndices,m=e.POINTS;m=e.TRIANGLES;var y=0,v=0,x=(a=this.postFxShadersManager.getModelRefSilhouetteShader()).program;e.useProgram(x),e.enableVertexAttribArray(a.position3_loc),e.uniformMatrix4fv(a.buildingRotMatrix_loc,!1,g.rotMatrix._floatArrays),e.uniformMatrix4fv(a.modelViewProjectionMatrix4RelToEye_loc,!1,this.sceneState.modelViewProjRelToEyeMatrix._floatArrays),e.uniformMatrix4fv(a.ModelViewMatrixRelToEye_loc,!1,this.sceneState.modelViewRelToEyeMatrix._floatArrays),e.uniform3fv(a.cameraPosHIGH_loc,this.sceneState.encodedCamPosHigh),e.uniform3fv(a.cameraPosLOW_loc,this.sceneState.encodedCamPosLow),e.uniform3fv(a.buildingPosHIGH_loc,g.positionHIGH),e.uniform3fv(a.buildingPosLOW_loc,g.positionLOW),e.uniform4fv(a.color4Aux_loc,[0,1,0,1]),e.uniform2fv(a.screenSize_loc,[this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight]),e.uniformMatrix4fv(a.ProjectionMatrix_loc,!1,this.sceneState.projectionMatrix._floatArrays),e.enable(e.STENCIL_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.depthRange(0,0),e.stencilFunc(e.EQUAL,0,1),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE),m=e.TRIANGLES;var b=.003;e.uniform2fv(a.camSpacePixelTranslation_loc,[b,b]),this.renderer.renderNeoReferenceAsimetricVersionColorSelection(e,this.objectSelected,p,s,this,a,y,v,m),e.uniform2fv(a.camSpacePixelTranslation_loc,[-b,b]),this.renderer.renderNeoReferenceAsimetricVersionColorSelection(e,this.objectSelected,p,s,this,a,y,v,m),e.uniform2fv(a.camSpacePixelTranslation_loc,[b,-b]),this.renderer.renderNeoReferenceAsimetricVersionColorSelection(e,this.objectSelected,p,s,this,a,y,v,m),e.uniform2fv(a.camSpacePixelTranslation_loc,[-b,-b]),this.renderer.renderNeoReferenceAsimetricVersionColorSelection(e,this.objectSelected,p,s,this,a,y,v,m),e.enable(e.DEPTH_TEST),e.disable(e.STENCIL_TEST),e.depthRange(0,1),e.disableVertexAttribArray(a.position3_loc),a&&(-1!==a.texCoord2_loc&&e.disableVertexAttribArray(a.texCoord2_loc),-1!==a.position3_loc&&e.disableVertexAttribArray(a.position3_loc),-1!==a.normal3_loc&&e.disableVertexAttribArray(a.normal3_loc),-1!==a.color4_loc&&e.disableVertexAttribArray(a.color4_loc))}if(this.magoPolicy.getObjectMoveMode()===CODE.moveMode.ALL&&this.buildingSelected){l=this.nodeSelected;f=this.getNodeGeoLocDataManager(l);s=this.buildingSelected;g=f.getCurrentGeoLocationData(),m=e.POINTS;m=e.TRIANGLES;y=0,v=0;var C=s.getCurrentSkin();if(void 0!==C){x=(a=this.postFxShadersManager.getModelRefSilhouetteShader()).program;e.useProgram(x),e.enableVertexAttribArray(a.position3_loc),e.uniformMatrix4fv(a.buildingRotMatrix_loc,!1,g.rotMatrix._floatArrays),e.uniformMatrix4fv(a.modelViewProjectionMatrix4RelToEye_loc,!1,this.sceneState.modelViewProjRelToEyeMatrix._floatArrays),e.uniformMatrix4fv(a.ModelViewMatrixRelToEye_loc,!1,this.sceneState.modelViewRelToEyeMatrix._floatArrays),e.uniform3fv(a.cameraPosHIGH_loc,this.sceneState.encodedCamPosHigh),e.uniform3fv(a.cameraPosLOW_loc,this.sceneState.encodedCamPosLow),e.uniform3fv(a.buildingPosHIGH_loc,g.positionHIGH),e.uniform3fv(a.buildingPosLOW_loc,g.positionLOW),e.uniform4fv(a.color4Aux_loc,[0,1,0,1]),e.uniform2fv(a.screenSize_loc,[this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight]),e.uniformMatrix4fv(a.ProjectionMatrix_loc,!1,this.sceneState.projectionMatrix._floatArrays),e.uniform3fv(a.aditionalMov_loc,[0,0,0]),e.enable(e.STENCIL_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.depthRange(0,0),e.stencilFunc(e.EQUAL,0,1),e.stencilOp(e.KEEP,e.REPLACE,e.REPLACE),m=e.TRIANGLES,e.uniform1i(a.refMatrixType_loc,0);b=.004;e.uniform2fv(a.camSpacePixelTranslation_loc,[b,b]),this.renderer.renderLodBuildingColorSelection(e,C,this,a),e.uniform2fv(a.camSpacePixelTranslation_loc,[-b,b]),this.renderer.renderLodBuildingColorSelection(e,C,this,a),e.uniform2fv(a.camSpacePixelTranslation_loc,[b,-b]),this.renderer.renderLodBuildingColorSelection(e,C,this,a),e.uniform2fv(a.camSpacePixelTranslation_loc,[-b,-b]),this.renderer.renderLodBuildingColorSelection(e,C,this,a),e.enable(e.DEPTH_TEST),e.disable(e.STENCIL_TEST),e.depthRange(0,1),e.disableVertexAttribArray(a.position3_loc),a&&(-1!==a.texCoord2_loc&&e.disableVertexAttribArray(a.texCoord2_loc),-1!==a.position3_loc&&e.disableVertexAttribArray(a.position3_loc),-1!==a.normal3_loc&&e.disableVertexAttribArray(a.normal3_loc),-1!==a.color4_loc&&e.disableVertexAttribArray(a.color4_loc))}}if(this.magoPolicy.getShowOrigin()){c=[l=this.nodeSelected];this.renderAxisNodes(e,c,!0,r)}}if(this.magoPolicy.getShowBoundingBox()){this.renderBoundingBoxesNodes(e,this.visibleObjControlerNodes.currentVisibles0,void 0,!0),this.renderBoundingBoxesNodes(e,this.visibleObjControlerNodes.currentVisibles2,void 0,!0),this.renderBoundingBoxesNodes(e,this.visibleObjControlerNodes.currentVisibles3,void 0,!0)}var M=this.objMarkerManager.objectMarkerArray.length;if(M>0){void 0===this.pin.positionBuffer&&this.pin.createPinCenterBottom(e),x=(a=this.postFxShadersManager.pFx_shaders_array[13]).program,e.useProgram(x),e.uniformMatrix4fv(a.modelViewProjectionMatrix4RelToEye_loc,!1,this.sceneState.modelViewProjRelToEyeMatrix._floatArrays),e.uniform3fv(a.cameraPosHIGH_loc,this.sceneState.encodedCamPosHigh),e.uniform3fv(a.cameraPosLOW_loc,this.sceneState.encodedCamPosLow),e.uniformMatrix4fv(a.buildingRotMatrix_loc,!1,this.sceneState.modelViewRelToEyeMatrixInv._floatArrays),e.uniform1i(a.textureFlipYAxis_loc,this.sceneState.textureFlipYAxis),e.uniform1i(a.texture_loc,0),e.enableVertexAttribArray(a.texCoord2_loc),e.enableVertexAttribArray(a.position3_loc),e.activeTexture(e.TEXTURE0),e.depthRange(0,0),e.bindBuffer(e.ARRAY_BUFFER,this.pin.positionBuffer),e.vertexAttribPointer(a.position3_loc,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.pin.texcoordBuffer),e.vertexAttribPointer(a.texCoord2_loc,2,e.FLOAT,!1,0,0);for(var _=0,A=0;A<M;A++){_>=this.pin.texturesArray.length&&(_=0);var R=this.pin.texturesArray[_],P=this.objMarkerManager.objectMarkerArray[A].geoLocationData;e.bindTexture(e.TEXTURE_2D,R.texId),e.uniform3fv(a.buildingPosHIGH_loc,P.positionHIGH),e.uniform3fv(a.buildingPosLOW_loc,P.positionLOW),e.drawArrays(e.TRIANGLES,0,6),_++}e.depthRange(0,1),e.useProgram(null),e.bindTexture(e.TEXTURE_2D,null),e.disableVertexAttribArray(a.texCoord2_loc),e.disableVertexAttribArray(a.position3_loc)}if(void 0!==this.tinTerrainManager){x=(a=this.postFxShadersManager.getShader("tinTerrain")).program,e.useProgram(x),e.enableVertexAttribArray(a.position3_loc),e.enableVertexAttribArray(a.texCoord2_loc),a.bindUniformGenerals();var T=this.pin.texturesArray[4];e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,T.texId),e.uniform1i(a.bIsMakingDepth_loc,!1),e.uniform1i(a.hasTexture_loc,!0),e.uniform4fv(a.oneColor4_loc,[.5,.5,.5,1]);var L,S=this.tinTerrainManager.currentTerrainsMap,w=this.tinTerrainManager.currentVisibles_terrName_geoCoords_map;for(var E in w)if(void 0!==(L=S[E])&&void 0!==L.vboKeyContainer&&0!==L.vboKeyContainer.vboCacheKeysArray.length)if(void 0!==L.texture){e.bindTexture(e.TEXTURE_2D,L.texture.texId),e.uniform3fv(a.buildingPosHIGH_loc,L.terrainPositionHIGH),e.uniform3fv(a.buildingPosLOW_loc,L.terrainPositionLOW);var D=L.vboKeyContainer.vboCacheKeysArray[0];if(D.isReadyPositions(e,this.vboMemoryManager)&&D.isReadyTexCoords(e,this.vboMemoryManager)&&D.isReadyFaces(e,this.vboMemoryManager)){e.bindBuffer(e.ARRAY_BUFFER,D.meshVertexCacheKey),e.vertexAttribPointer(a.position3_loc,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,D.meshTexcoordsCacheKey),e.vertexAttribPointer(a.texCoord2_loc,2,e.FLOAT,!1,0,0);var I=D.indicesCount;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,D.meshFacesCacheKey),e.drawElements(e.TRIANGLES,I,e.UNSIGNED_SHORT,0)}}else{L.texture=new Texture;var O="\\images\\ko\\funny_"+L.depth+".jpg";this.readerWriter.readLegoSimpleBuildingTexture(e,O,L.texture,this)}a&&(-1!==a.texCoord2_loc&&e.disableVertexAttribArray(a.texCoord2_loc),-1!==a.position3_loc&&e.disableVertexAttribArray(a.position3_loc),-1!==a.normal3_loc&&e.disableVertexAttribArray(a.normal3_loc),-1!==a.color4_loc&&e.disableVertexAttribArray(a.color4_loc))}var V=this.cctvList.getCCTVCount();if(V>0){x=(a=this.postFxShadersManager.getShader("modelRefSsao")).program,e.useProgram(x),e.uniform1i(a.bApplySpecularLighting_loc,!1),e.disableVertexAttribArray(a.texCoord2_loc),e.enableVertexAttribArray(a.position3_loc),e.enableVertexAttribArray(a.normal3_loc),a.bindUniformGenerals(),e.uniform1i(a.textureFlipYAxis_loc,this.sceneState.textureFlipYAxis),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.depthFboNeo.colorBuffer),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.noiseTexture),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.textureAux_1x1),this.renderer.renderTexture=!1;var B=(new Date).getTime();for(A=0;A<V;A++){var F=this.cctvList.getCCTV(A);F.updateHeading(B),F.render(e,this,a)}this.isFarestFrustum()&&this.drawCCTVNames(this.cctvList.camerasList)}this.visibleObjControlerNodes.currentVisiblesAux.length>0&&(x=(a=this.postFxShadersManager.getShader("pointsCloud")).program,e.useProgram(x),e.enableVertexAttribArray(a.position3_loc),e.enableVertexAttribArray(a.color4_loc),a.bindUniformGenerals(),this.renderer.renderNeoBuildingsPCloud(e,this.visibleObjControlerNodes.currentVisiblesAux,this,a,!1,r),a&&(-1!==a.texCoord2_loc&&e.disableVertexAttribArray(a.texCoord2_loc),-1!==a.position3_loc&&e.disableVertexAttribArray(a.position3_loc),-1!==a.normal3_loc&&e.disableVertexAttribArray(a.normal3_loc),-1!==a.color4_loc&&e.disableVertexAttribArray(a.color4_loc)))}a&&(-1!==a.texCoord2_loc&&e.disableVertexAttribArray(a.texCoord2_loc),-1!==a.position3_loc&&e.disableVertexAttribArray(a.position3_loc),-1!==a.normal3_loc&&e.disableVertexAttribArray(a.normal3_loc),-1!==a.color4_loc&&e.disableVertexAttribArray(a.color4_loc)),e.depthRange(0,1)},MagoManager.prototype.drawCCTVNames=function(e){var t=document.getElementById("objectLabel");if(void 0!==t){t.style.opacity=1,t.width=this.sceneState.drawingBufferWidth,t.height=this.sceneState.drawingBufferHeight;var i=t.getContext("2d");i.strokeStyle="DarkSlateGray",i.fillStyle="PapayaWhip",i.lineWidth=4,i.font="20px Arial",i.textAlign="center",i.fillRect(0,0,i.canvas.width,i.canvas.height),i.save(),i.clearRect(0,0,i.canvas.width,i.canvas.height);i.measureText("M").width;for(var o,r,n,a=this.sceneState.gl,s=e.length,l=0;l<s;l++)o=(n=e[l]).geoLocationData.position,(r=this.calculateWorldPositionToScreenCoord(a,o.x,o.y,o.z,r)).x>=0&&r.y>=0&&(i.font="13px Arial",i.strokeText(n.name,r.x,r.y),i.fillText(n.name,r.x,r.y));i.restore()}},MagoManager.prototype.renderRenderables=function(e,t,i,o,r,n){var a,s,l;if(e.frontFace(e.CCW),e.depthRange(0,1),e.enable(e.DEPTH_TEST),!1,0===r&&(e.disable(e.BLEND),this.depthRenderLowestOctreeAsimetricVersion(e,r,n),this.magoPolicy.getShowOrigin()&&void 0!==this.nodeSelected)){var c=[l=this.nodeSelected];this.renderAxisNodes(e,c,!0,r)}if(1===r){var h=n.currentVisibles0.length;if(h>0){this.checkChangesHistoryMovements(n.currentVisibles0),this.checkChangesHistoryColors(n.currentVisibles0),void 0===this.noiseTexture&&(this.noiseTexture=genNoiseTextureRGBA(e,4,4,this.pixels)),x=(a=this.postFxShadersManager.getShader("modelRefSsao")).program,e.useProgram(x),e.uniform1i(a.bApplySpecularLighting_loc,!1),e.enableVertexAttribArray(a.texCoord2_loc),e.enableVertexAttribArray(a.position3_loc),e.enableVertexAttribArray(a.normal3_loc),a.bindUniformGenerals(),e.uniform1i(a.textureFlipYAxis_loc,this.sceneState.textureFlipYAxis),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.depthFboNeo.colorBuffer),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.noiseTexture);this.renderer.renderNodes(e,n.currentVisibles0,this,a,!1,r,0,0),a&&(-1!==a.texCoord2_loc&&e.disableVertexAttribArray(a.texCoord2_loc),-1!==a.position3_loc&&e.disableVertexAttribArray(a.position3_loc),-1!==a.normal3_loc&&e.disableVertexAttribArray(a.normal3_loc),-1!==a.color4_loc&&e.disableVertexAttribArray(a.color4_loc)),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,null)}var d=n.currentVisibles2.length,u=n.currentVisibles3.length;if((d>0||h>0||u>0)&&(this.checkChangesHistoryColors(n.currentVisibles2),x=(a=this.postFxShadersManager.getShader("lodBuildingSsao")).program,e.useProgram(x),e.uniform1i(a.bApplySpecularLighting_loc,!1),e.enableVertexAttribArray(a.position3_loc),e.enableVertexAttribArray(a.normal3_loc),e.enableVertexAttribArray(a.color4_loc),a.bindUniformGenerals(),e.uniform1i(a.textureFlipYAxis_loc,this.sceneState.textureFlipYAxis),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.depthFboNeo.colorBuffer),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.noiseTexture),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.textureAux_1x1),this.renderer.renderNeoBuildingsLOD2AsimetricVersion(e,n.currentVisibles0,this,a,!1,r),this.renderer.renderNeoBuildingsLOD2AsimetricVersion(e,n.currentVisibles2,this,a,!1,r),this.renderer.renderNeoBuildingsLowLOD(e,n.currentVisibles3,this,a,!1,r),a&&(-1!==a.texCoord2_loc&&e.disableVertexAttribArray(a.texCoord2_loc),-1!==a.position3_loc&&e.disableVertexAttribArray(a.position3_loc),-1!==a.normal3_loc&&e.disableVertexAttribArray(a.normal3_loc),-1!==a.color4_loc&&e.disableVertexAttribArray(a.color4_loc)),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,null)),this.nodeSelected){if(this.magoPolicy.getObjectMoveMode()===CODE.moveMode.OBJECT&&this.objectSelected){l=this.nodeSelected;var f=this.getNodeGeoLocDataManager(l);s=this.buildingSelected;var g=f.getCurrentGeoLocationData(),p=this.octreeSelected.neoReferencesMotherAndIndices,m=e.POINTS;m=e.TRIANGLES;var y=0,v=0,x=(a=this.postFxShadersManager.getModelRefSilhouetteShader()).program;e.useProgram(x),e.enableVertexAttribArray(a.position3_loc),e.uniformMatrix4fv(a.buildingRotMatrix_loc,!1,g.rotMatrix._floatArrays),e.uniformMatrix4fv(a.modelViewProjectionMatrix4RelToEye_loc,!1,this.sceneState.modelViewProjRelToEyeMatrix._floatArrays),e.uniformMatrix4fv(a.ModelViewMatrixRelToEye_loc,!1,this.sceneState.modelViewRelToEyeMatrix._floatArrays),e.uniform3fv(a.cameraPosHIGH_loc,this.sceneState.encodedCamPosHigh),e.uniform3fv(a.cameraPosLOW_loc,this.sceneState.encodedCamPosLow),e.uniform3fv(a.buildingPosHIGH_loc,g.positionHIGH),e.uniform3fv(a.buildingPosLOW_loc,g.positionLOW),e.uniform4fv(a.color4Aux_loc,[0,1,0,1]),e.uniform2fv(a.screenSize_loc,[this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight]),e.uniformMatrix4fv(a.ProjectionMatrix_loc,!1,this.sceneState.projectionMatrix._floatArrays),e.enable(e.STENCIL_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.depthRange(0,0),e.stencilFunc(e.EQUAL,0,1),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE),m=e.TRIANGLES;var b=.003;e.uniform2fv(a.camSpacePixelTranslation_loc,[b,b]),this.renderer.renderNeoReferenceAsimetricVersionColorSelection(e,this.objectSelected,p,s,this,a,y,v,m),e.uniform2fv(a.camSpacePixelTranslation_loc,[-b,b]),this.renderer.renderNeoReferenceAsimetricVersionColorSelection(e,this.objectSelected,p,s,this,a,y,v,m),e.uniform2fv(a.camSpacePixelTranslation_loc,[b,-b]),this.renderer.renderNeoReferenceAsimetricVersionColorSelection(e,this.objectSelected,p,s,this,a,y,v,m),e.uniform2fv(a.camSpacePixelTranslation_loc,[-b,-b]),this.renderer.renderNeoReferenceAsimetricVersionColorSelection(e,this.objectSelected,p,s,this,a,y,v,m),e.enable(e.DEPTH_TEST),e.disable(e.STENCIL_TEST),e.depthRange(0,1),e.disableVertexAttribArray(a.position3_loc),a&&(-1!==a.texCoord2_loc&&e.disableVertexAttribArray(a.texCoord2_loc),-1!==a.position3_loc&&e.disableVertexAttribArray(a.position3_loc),-1!==a.normal3_loc&&e.disableVertexAttribArray(a.normal3_loc),-1!==a.color4_loc&&e.disableVertexAttribArray(a.color4_loc))}if(this.magoPolicy.getObjectMoveMode()===CODE.moveMode.ALL&&this.buildingSelected){l=this.nodeSelected;f=this.getNodeGeoLocDataManager(l);s=this.buildingSelected;g=f.getCurrentGeoLocationData(),m=e.POINTS;m=e.TRIANGLES;y=0,v=0;var C=s.getCurrentSkin();if(void 0!==C){x=(a=this.postFxShadersManager.getModelRefSilhouetteShader()).program;e.useProgram(x),e.enableVertexAttribArray(a.position3_loc),e.uniformMatrix4fv(a.buildingRotMatrix_loc,!1,g.rotMatrix._floatArrays),e.uniformMatrix4fv(a.modelViewProjectionMatrix4RelToEye_loc,!1,this.sceneState.modelViewProjRelToEyeMatrix._floatArrays),e.uniformMatrix4fv(a.ModelViewMatrixRelToEye_loc,!1,this.sceneState.modelViewRelToEyeMatrix._floatArrays),e.uniform3fv(a.cameraPosHIGH_loc,this.sceneState.encodedCamPosHigh),e.uniform3fv(a.cameraPosLOW_loc,this.sceneState.encodedCamPosLow),e.uniform3fv(a.buildingPosHIGH_loc,g.positionHIGH),e.uniform3fv(a.buildingPosLOW_loc,g.positionLOW),e.uniform4fv(a.color4Aux_loc,[0,1,0,1]),e.uniform2fv(a.screenSize_loc,[this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight]),e.uniformMatrix4fv(a.ProjectionMatrix_loc,!1,this.sceneState.projectionMatrix._floatArrays),e.uniform3fv(a.aditionalMov_loc,[0,0,0]),e.enable(e.STENCIL_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.depthRange(0,0),e.stencilFunc(e.EQUAL,0,1),e.stencilOp(e.KEEP,e.REPLACE,e.REPLACE),m=e.TRIANGLES,e.uniform1i(a.refMatrixType_loc,0);b=.004;e.uniform2fv(a.camSpacePixelTranslation_loc,[b,b]),this.renderer.renderLodBuildingColorSelection(e,C,this,a),e.uniform2fv(a.camSpacePixelTranslation_loc,[-b,b]),this.renderer.renderLodBuildingColorSelection(e,C,this,a),e.uniform2fv(a.camSpacePixelTranslation_loc,[b,-b]),this.renderer.renderLodBuildingColorSelection(e,C,this,a),e.uniform2fv(a.camSpacePixelTranslation_loc,[-b,-b]),this.renderer.renderLodBuildingColorSelection(e,C,this,a),e.enable(e.DEPTH_TEST),e.disable(e.STENCIL_TEST),e.depthRange(0,1),e.disableVertexAttribArray(a.position3_loc),a&&(-1!==a.texCoord2_loc&&e.disableVertexAttribArray(a.texCoord2_loc),-1!==a.position3_loc&&e.disableVertexAttribArray(a.position3_loc),-1!==a.normal3_loc&&e.disableVertexAttribArray(a.normal3_loc),-1!==a.color4_loc&&e.disableVertexAttribArray(a.color4_loc))}}if(this.magoPolicy.getShowOrigin()){c=[l=this.nodeSelected];this.renderAxisNodes(e,c,!0,r)}}if(this.magoPolicy.getShowBoundingBox()){this.renderBoundingBoxesNodes(e,this.visibleObjControlerNodes.currentVisibles0,void 0,!0),this.renderBoundingBoxesNodes(e,this.visibleObjControlerNodes.currentVisibles2,void 0,!0)}var M=this.objMarkerManager.objectMarkerArray.length;if(M>0){void 0===this.pin.positionBuffer&&this.pin.createPinCenterBottom(e),x=(a=this.postFxShadersManager.pFx_shaders_array[13]).program,e.useProgram(x),e.uniformMatrix4fv(a.modelViewProjectionMatrix4RelToEye_loc,!1,this.sceneState.modelViewProjRelToEyeMatrix._floatArrays),e.uniform3fv(a.cameraPosHIGH_loc,this.sceneState.encodedCamPosHigh),e.uniform3fv(a.cameraPosLOW_loc,this.sceneState.encodedCamPosLow),e.uniformMatrix4fv(a.buildingRotMatrix_loc,!1,this.sceneState.modelViewRelToEyeMatrixInv._floatArrays),e.uniform1i(a.textureFlipYAxis_loc,this.sceneState.textureFlipYAxis),e.uniform1i(a.texture_loc,0),e.enableVertexAttribArray(a.texCoord2_loc),e.enableVertexAttribArray(a.position3_loc),e.activeTexture(e.TEXTURE0),e.depthRange(0,0),e.bindBuffer(e.ARRAY_BUFFER,this.pin.positionBuffer),e.vertexAttribPointer(a.position3_loc,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.pin.texcoordBuffer),e.vertexAttribPointer(a.texCoord2_loc,2,e.FLOAT,!1,0,0);for(var _=0,A=0;A<M;A++){_>=this.pin.texturesArray.length&&(_=0);var R=this.pin.texturesArray[_],P=this.objMarkerManager.objectMarkerArray[A].geoLocationData;e.bindTexture(e.TEXTURE_2D,R.texId),e.uniform3fv(a.buildingPosHIGH_loc,P.positionHIGH),e.uniform3fv(a.buildingPosLOW_loc,P.positionLOW),e.drawArrays(e.TRIANGLES,0,6),_++}e.depthRange(0,1),e.useProgram(null),e.bindTexture(e.TEXTURE_2D,null),e.disableVertexAttribArray(a.texCoord2_loc),e.disableVertexAttribArray(a.position3_loc)}if(void 0!==this.tinTerrainManager){x=(a=this.postFxShadersManager.getShader("tinTerrain")).program,e.useProgram(x),e.enableVertexAttribArray(a.position3_loc),e.enableVertexAttribArray(a.texCoord2_loc),a.bindUniformGenerals();var T=this.pin.texturesArray[4];e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,T.texId),e.uniform1i(a.hasTexture_loc,!0),e.uniform4fv(a.oneColor4_loc,[.5,.5,.5,1]);var L,S=this.tinTerrainManager.currentTerrainsMap,w=this.tinTerrainManager.currentVisibles_terrName_geoCoords_map;for(var E in w)if(void 0!==(L=S[E])&&void 0!==L.vboKeyContainer&&0!==L.vboKeyContainer.vboCacheKeysArray.length)if(void 0!==L.texture){e.bindTexture(e.TEXTURE_2D,L.texture.texId),e.uniform3fv(a.buildingPosHIGH_loc,L.terrainPositionHIGH),e.uniform3fv(a.buildingPosLOW_loc,L.terrainPositionLOW);var D=L.vboKeyContainer.vboCacheKeysArray[0];if(D.isReadyPositions(e,this.vboMemoryManager)&&D.isReadyTexCoords(e,this.vboMemoryManager)&&D.isReadyFaces(e,this.vboMemoryManager)){e.bindBuffer(e.ARRAY_BUFFER,D.meshVertexCacheKey),e.vertexAttribPointer(a.position3_loc,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,D.meshTexcoordsCacheKey),e.vertexAttribPointer(a.texCoord2_loc,2,e.FLOAT,!1,0,0);var I=D.indicesCount;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,D.meshFacesCacheKey),e.drawElements(e.TRIANGLES,I,e.UNSIGNED_SHORT,0)}}else{L.texture=new Texture;var O="\\images\\ko\\funny_"+L.depth+".jpg";this.readerWriter.readLegoSimpleBuildingTexture(e,O,L.texture,this)}a&&(-1!==a.texCoord2_loc&&e.disableVertexAttribArray(a.texCoord2_loc),-1!==a.position3_loc&&e.disableVertexAttribArray(a.position3_loc),-1!==a.normal3_loc&&e.disableVertexAttribArray(a.normal3_loc),-1!==a.color4_loc&&e.disableVertexAttribArray(a.color4_loc))}}a&&(-1!==a.texCoord2_loc&&e.disableVertexAttribArray(a.texCoord2_loc),-1!==a.position3_loc&&e.disableVertexAttribArray(a.position3_loc),-1!==a.normal3_loc&&e.disableVertexAttribArray(a.normal3_loc),-1!==a.color4_loc&&e.disableVertexAttribArray(a.color4_loc))},MagoManager.prototype.renderBoundingBoxesNodes=function(e,t,i,o){var r,n=this.postFxShadersManager.getTriPolyhedronShader(),a=n.program;e.enable(e.BLEND),e.frontFace(e.CCW),e.useProgram(a),e.enableVertexAttribArray(n.position3_loc),e.enableVertexAttribArray(n.normal3_loc),e.disableVertexAttribArray(n.color4_loc),e.uniformMatrix4fv(n.modelViewProjectionMatrix4RelToEye_loc,!1,this.sceneState.modelViewProjRelToEyeMatrix._floatArrays),e.uniformMatrix4fv(n.modelViewMatrix4RelToEye_loc,!1,this.sceneState.modelViewRelToEyeMatrix._floatArrays),e.uniformMatrix4fv(n.modelViewMatrix4_loc,!1,this.sceneState.modelViewMatrix._floatArrays),e.uniformMatrix4fv(n.projectionMatrix4_loc,!1,this.sceneState.projectionMatrix._floatArrays),e.uniform3fv(n.cameraPosHIGH_loc,this.sceneState.encodedCamPosHigh),e.uniform3fv(n.cameraPosLOW_loc,this.sceneState.encodedCamPosLow),e.uniform1f(n.near_loc,this.sceneState.camera.frustum.near),e.uniform1f(n.far_loc,this.sceneState.camera.frustum.far),e.uniform1i(n.bApplySsao_loc,!1),e.uniformMatrix4fv(n.normalMatrix4_loc,!1,this.sceneState.normalMatrix4._floatArrays),e.uniform1i(n.hasAditionalMov_loc,!0),e.uniform3fv(n.aditionalMov_loc,[0,0,0]),e.uniform1i(n.bScale_loc,!0);var s;e.uniform1i(n.bUse1Color_loc,!0),i?e.uniform4fv(n.oneColor4_loc,[i.r,i.g,i.b,1]):e.uniform4fv(n.oneColor4_loc,[1,0,1,1]),e.uniform1i(n.depthTex_loc,0),e.uniform1i(n.noiseTex_loc,1),e.uniform1i(n.diffuseTex_loc,2),e.uniform1f(n.fov_loc,this.sceneState.camera.frustum.fovyRad),e.uniform1f(n.aspectRatio_loc,this.sceneState.camera.frustum.aspectRatio),e.uniform1f(n.screenWidth_loc,this.sceneState.drawingBufferWidth),e.uniform1f(n.screenHeight_loc,this.sceneState.drawingBufferHeight),e.uniform2fv(n.noiseScale2_loc,[this.depthFboNeo.width/this.noiseTexture.width,this.depthFboNeo.height/this.noiseTexture.height]),e.uniform3fv(n.kernel16_loc,this.kernel),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.depthFboNeo.colorBuffer),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.noiseTexture);for(var l=t.length,c=0;c<l;c++){s=(r=t[c]).data.neoBuilding,e.uniform3fv(n.scale_loc,[s.bbox.getXLength(),s.bbox.getYLength(),s.bbox.getZLength()]);var h=this.getNodeGeoLocDataManager(r).getCurrentGeoLocationData();e.uniformMatrix4fv(n.buildingRotMatrix_loc,!1,h.rotMatrix._floatArrays),e.uniform3fv(n.buildingPosHIGH_loc,h.positionHIGH),e.uniform3fv(n.buildingPosLOW_loc,h.positionLOW),this.pointSC=s.bbox.getCenterPoint(this.pointSC),e.uniform3fv(n.aditionalMov_loc,[this.pointSC.x,this.pointSC.y,this.pointSC.z]),this.renderer.renderObject(e,this.unitaryBoxSC,this,n,1,o)}n&&(-1!==n.texCoord2_loc&&e.disableVertexAttribArray(n.texCoord2_loc),-1!==n.position3_loc&&e.disableVertexAttribArray(n.position3_loc),-1!==n.normal3_loc&&e.disableVertexAttribArray(n.normal3_loc),-1!==n.color4_loc&&e.disableVertexAttribArray(n.color4_loc)),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,null),e.disable(e.BLEND)},MagoManager.prototype.renderAxisNodes=function(e,t,i,o){0===this.axisXYZ.vbo_vicks_container.vboCacheKeysArray.length&&this.axisXYZ.makeMesh(30).getVbo(this.axisXYZ.vbo_vicks_container);var r,n;e=this.sceneState.gl;0===o&&(n=this.postFxShadersManager.getTriPolyhedronDepthShader(),e.disable(e.BLEND)),1===o&&(n=this.postFxShadersManager.getTriPolyhedronShader(),e.enable(e.BLEND));var a=n.program;e.frontFace(e.CCW),e.useProgram(a),e.enableVertexAttribArray(n.position3_loc),e.uniformMatrix4fv(n.modelViewProjectionMatrix4RelToEye_loc,!1,this.sceneState.modelViewProjRelToEyeMatrix._floatArrays),e.uniformMatrix4fv(n.modelViewMatrix4RelToEye_loc,!1,this.sceneState.modelViewRelToEyeMatrix._floatArrays),e.uniform3fv(n.cameraPosHIGH_loc,this.sceneState.encodedCamPosHigh),e.uniform3fv(n.cameraPosLOW_loc,this.sceneState.encodedCamPosLow),e.uniform1f(n.near_loc,this.sceneState.camera.frustum.near),e.uniform1f(n.far_loc,this.sceneState.camera.frustum.far),e.uniform1i(n.bApplySsao_loc,!0),e.uniformMatrix4fv(n.normalMatrix4_loc,!1,this.sceneState.normalMatrix4._floatArrays),1===o&&(e.enableVertexAttribArray(n.normal3_loc),e.enableVertexAttribArray(n.color4_loc),e.uniform1i(n.bUse1Color_loc,!1),e.uniform4fv(n.oneColor4_loc,[1,.1,.1,1]),e.uniformMatrix4fv(n.modelViewMatrix4_loc,!1,this.sceneState.modelViewMatrix._floatArrays),e.uniformMatrix4fv(n.projectionMatrix4_loc,!1,this.sceneState.projectionMatrix._floatArrays),e.uniform1i(n.depthTex_loc,0),e.uniform1i(n.noiseTex_loc,1),e.uniform1i(n.diffuseTex_loc,2),e.uniform1f(n.fov_loc,this.sceneState.camera.frustum.fovyRad),e.uniform1f(n.aspectRatio_loc,this.sceneState.camera.frustum.aspectRatio),e.uniform1f(n.screenWidth_loc,this.sceneState.drawingBufferWidth),e.uniform1f(n.screenHeight_loc,this.sceneState.drawingBufferHeight),e.uniform2fv(n.noiseScale2_loc,[this.depthFboNeo.width/this.noiseTexture.width,this.depthFboNeo.height/this.noiseTexture.height]),e.uniform3fv(n.kernel16_loc,this.kernel),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.depthFboNeo.colorBuffer),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.noiseTexture));for(var s=t.length,l=0;l<s;l++){(r=t[l]).data.neoBuilding,e.uniform3fv(n.scale_loc,[1,1,1]);var c=this.getNodeGeoLocDataManager(r).getCurrentGeoLocationData();e.uniformMatrix4fv(n.buildingRotMatrix_loc,!1,c.rotMatrix._floatArrays),e.uniform3fv(n.buildingPosHIGH_loc,c.positionHIGH),e.uniform3fv(n.buildingPosLOW_loc,c.positionLOW),e.uniform3fv(n.aditionalMov_loc,[0,0,0]),this.renderer.renderObject(e,this.axisXYZ,this,n,o)}n&&(-1!==n.texCoord2_loc&&e.disableVertexAttribArray(n.texCoord2_loc),-1!==n.position3_loc&&e.disableVertexAttribArray(n.position3_loc),-1!==n.normal3_loc&&e.disableVertexAttribArray(n.normal3_loc),-1!==n.color4_loc&&e.disableVertexAttribArray(n.color4_loc)),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,null),e.disable(e.BLEND)},MagoManager.prototype.depthRenderLowestOctreeAsimetricVersion=function(e,t,i){var o,r,n=i.currentVisibles0.length;if(n>0){r=(o=this.postFxShadersManager.pFx_shaders_array[3]).program,e.useProgram(r),e.enableVertexAttribArray(o.position3_loc),e.uniformMatrix4fv(o.modelViewProjectionMatrix4RelToEye_loc,!1,this.sceneState.modelViewProjRelToEyeMatrix._floatArrays),e.uniformMatrix4fv(o.modelViewMatrix4RelToEye_loc,!1,this.sceneState.modelViewRelToEyeMatrix._floatArrays),e.uniformMatrix4fv(o.modelViewMatrix4_loc,!1,this.sceneState.modelViewMatrix._floatArrays),e.uniformMatrix4fv(o.projectionMatrix4_loc,!1,this.sceneState.projectionMatrix._floatArrays),e.uniform3fv(o.cameraPosHIGH_loc,this.sceneState.encodedCamPosHigh),e.uniform3fv(o.cameraPosLOW_loc,this.sceneState.encodedCamPosLow),e.uniform1f(o.near_loc,this.sceneState.camera.frustum.near),e.uniform1f(o.far_loc,this.sceneState.camera.frustum.far);this.renderer.renderNodes(e,i.currentVisibles0,this,o,!1,t,0,0,0),-1!==o.position3_loc&&e.disableVertexAttribArray(o.position3_loc)}if((i.currentVisibles2.length>0||n>0)&&(r=(o=this.postFxShadersManager.pFx_shaders_array[7]).program,e.useProgram(r),e.enableVertexAttribArray(o.position3_loc),e.uniformMatrix4fv(o.modelViewProjectionMatrix4RelToEye_loc,!1,this.sceneState.modelViewProjRelToEyeMatrix._floatArrays),e.uniformMatrix4fv(o.modelViewMatrix4RelToEye_loc,!1,this.sceneState.modelViewRelToEyeMatrix._floatArrays),e.uniformMatrix4fv(o.modelViewMatrix4_loc,!1,this.sceneState.modelViewMatrix._floatArrays),e.uniformMatrix4fv(o.projectionMatrix4_loc,!1,this.sceneState.projectionMatrix._floatArrays),e.uniform3fv(o.cameraPosHIGH_loc,this.sceneState.encodedCamPosHigh),e.uniform3fv(o.cameraPosLOW_loc,this.sceneState.encodedCamPosLow),e.uniform1f(o.near_loc,this.sceneState.camera.frustum.near),e.uniform1f(o.far_loc,this.sceneState.camera.frustum.far),e.uniform1i(o.hasAditionalMov_loc,!0),e.uniform3fv(o.aditionalMov_loc,[0,0,0]),this.renderer.renderNeoBuildingsLOD2AsimetricVersion(e,i.currentVisibles0,this,o,!1,t),this.renderer.renderNeoBuildingsLOD2AsimetricVersion(e,i.currentVisibles2,this,o,!1,t),-1!==o.position3_loc&&e.disableVertexAttribArray(o.position3_loc)),i.currentVisibles3.length>0&&(r=(o=this.postFxShadersManager.pFx_shaders_array[7]).program,e.useProgram(r),e.enableVertexAttribArray(o.position3_loc),e.uniformMatrix4fv(o.modelViewProjectionMatrix4RelToEye_loc,!1,this.sceneState.modelViewProjRelToEyeMatrix._floatArrays),e.uniformMatrix4fv(o.modelViewMatrix4RelToEye_loc,!1,this.sceneState.modelViewRelToEyeMatrix._floatArrays),e.uniformMatrix4fv(o.modelViewMatrix4_loc,!1,this.sceneState.modelViewMatrix._floatArrays),e.uniformMatrix4fv(o.projectionMatrix4_loc,!1,this.sceneState.projectionMatrix._floatArrays),e.uniform3fv(o.cameraPosHIGH_loc,this.sceneState.encodedCamPosHigh),e.uniform3fv(o.cameraPosLOW_loc,this.sceneState.encodedCamPosLow),e.uniform1f(o.near_loc,this.sceneState.camera.frustum.near),e.uniform1f(o.far_loc,this.sceneState.camera.frustum.far),e.uniform1i(o.hasAditionalMov_loc,!0),e.uniform3fv(o.aditionalMov_loc,[0,0,0]),this.renderer.renderNeoBuildingsLowLOD(e,i.currentVisibles3,this,o,!1,t),-1!==o.position3_loc&&e.disableVertexAttribArray(o.position3_loc)),void 0!==this.tinTerrainManager){r=(o=this.postFxShadersManager.getShader("tinTerrain")).program,e.useProgram(r),e.enableVertexAttribArray(o.position3_loc),e.disableVertexAttribArray(o.texCoord2_loc),o.bindUniformGenerals();var a=this.pin.texturesArray[4];e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,a.texId),e.uniform1i(o.bIsMakingDepth_loc,!0),e.uniform1i(o.hasTexture_loc,!0),e.uniform4fv(o.oneColor4_loc,[.5,.5,.5,1]);var s,l=this.tinTerrainManager.currentTerrainsMap,c=this.tinTerrainManager.currentVisibles_terrName_geoCoords_map;for(var h in c)if(void 0!==(s=l[h])&&void 0!==s.vboKeyContainer&&0!==s.vboKeyContainer.vboCacheKeysArray.length){e.uniform3fv(o.buildingPosHIGH_loc,s.terrainPositionHIGH),e.uniform3fv(o.buildingPosLOW_loc,s.terrainPositionLOW);var d=s.vboKeyContainer.vboCacheKeysArray[0];if(d.isReadyPositions(e,this.vboMemoryManager)&&d.isReadyTexCoords(e,this.vboMemoryManager)&&d.isReadyFaces(e,this.vboMemoryManager)){e.bindBuffer(e.ARRAY_BUFFER,d.meshVertexCacheKey),e.vertexAttribPointer(o.position3_loc,3,e.FLOAT,!1,0,0);var u=d.indicesCount;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,d.meshFacesCacheKey),e.drawElements(e.TRIANGLES,u,e.UNSIGNED_SHORT,0)}}o&&(-1!==o.texCoord2_loc&&e.disableVertexAttribArray(o.texCoord2_loc),-1!==o.position3_loc&&e.disableVertexAttribArray(o.position3_loc),-1!==o.normal3_loc&&e.disableVertexAttribArray(o.normal3_loc),-1!==o.color4_loc&&e.disableVertexAttribArray(o.color4_loc))}},MagoManager.prototype.createDefaultShaders=function(e){var t="modelRefSsao",i=this.postFxShadersManager.newShader(t),o=ShaderSource.ModelRefSsaoVS,r=ShaderSource.ModelRefSsaoFS;i.program=e.createProgram(),i.shader_vertex=this.postFxShadersManager.createShader(e,o,e.VERTEX_SHADER,"VERTEX"),i.shader_fragment=this.postFxShadersManager.createShader(e,r,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(i.program,i.shader_vertex),e.attachShader(i.program,i.shader_fragment),e.linkProgram(i.program),i.createUniformGenerals(e,i,this.sceneState),i.createUniformLocals(e,i,this.sceneState),t="lodBuildingSsao",i=this.postFxShadersManager.newShader(t),o=ShaderSource.LodBuildingSsaoVS,r=ShaderSource.LodBuildingSsaoFS,i.program=e.createProgram(),i.shader_vertex=this.postFxShadersManager.createShader(e,o,e.VERTEX_SHADER,"VERTEX"),i.shader_fragment=this.postFxShadersManager.createShader(e,r,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(i.program,i.shader_vertex),e.attachShader(i.program,i.shader_fragment),e.linkProgram(i.program),i.createUniformGenerals(e,i,this.sceneState),i.createUniformLocals(e,i,this.sceneState),t="tinTerrain",i=this.postFxShadersManager.newShader(t),o=ShaderSource.TinTerrainVS,r=ShaderSource.TinTerrainFS,i.program=e.createProgram(),i.shader_vertex=this.postFxShadersManager.createShader(e,o,e.VERTEX_SHADER,"VERTEX"),i.shader_fragment=this.postFxShadersManager.createShader(e,r,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(i.program,i.shader_vertex),e.attachShader(i.program,i.shader_fragment),e.linkProgram(i.program),i.createUniformGenerals(e,i,this.sceneState),i.createUniformLocals(e,i,this.sceneState),i.bIsMakingDepth_loc=e.getUniformLocation(i.program,"bIsMakingDepth"),t="pointsCloud",i=this.postFxShadersManager.newShader(t),o=ShaderSource.PointCloudVS,r=ShaderSource.PointCloudFS,i.program=e.createProgram(),i.shader_vertex=this.postFxShadersManager.createShader(e,o,e.VERTEX_SHADER,"VERTEX"),i.shader_fragment=this.postFxShadersManager.createShader(e,r,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(i.program,i.shader_vertex),e.attachShader(i.program,i.shader_fragment),e.linkProgram(i.program),i.createUniformGenerals(e,i,this.sceneState),i.createUniformLocals(e,i,this.sceneState),i.bPositionCompressed_loc=e.getUniformLocation(i.program,"bPositionCompressed"),i.minPosition_loc=e.getUniformLocation(i.program,"minPosition"),i.bboxSize_loc=e.getUniformLocation(i.program,"bboxSize")},MagoManager.prototype.renderLodBuilding=function(e,t,i,o,r,n,a){a.fileLoadState===CODE.fileLoadState.LOADING_FINISHED&&a.parseArrayBuffer(e,this.readerWriter),this.renderer.renderLodBuilding(e,a,this,o,n)},MagoManager.prototype.reCalculateModelViewProjectionRelToEyeMatrix=function(e){for(var t=0;t<16;t++)if(0===e.context._us._modelView[t])return;var i=new Cesium.Matrix4;(i=Cesium.Matrix4.clone(e.context._us._modelView))[12]=0,i[13]=0,i[14]=0;var o=new Cesium.Matrix4;Cesium.Matrix4.multiply(e.context._us._projection,i,o),Cesium.Matrix4.toArray(o,this.modelViewProjRelToEye_matrix)},MagoManager.prototype.deleteNeoBuilding=function(e,t){var i=this.vboMemoryManager;t===this.buildingSelected&&(this.buildingSelected=void 0,this.octreeSelected=void 0,this.objectSelected=void 0),t.deleteObjects(e,i)},MagoManager.prototype.isFarestFrustum=function(){return this.numFrustums-this.currentFrustumIdx-1==0},MagoManager.prototype.doMultiFrustumCullingSmartTiles=function(e){var t=this.myCameraSCX.bigFrustum,i=this.smartTileManager.tilesArray[0],o=this.smartTileManager.tilesArray[1];void 0===this.frustumVolumeControl&&(this.frustumVolumeControl=new FrustumVolumeControl),void 0===this.fullyIntersectedLowestTilesArray&&(this.fullyIntersectedLowestTilesArray=[]),void 0===this.partiallyIntersectedLowestTilesArray&&(this.partiallyIntersectedLowestTilesArray=[]),void 0===this.lastIntersectedLowestTilesArray&&(this.lastIntersectedLowestTilesArray=[]),this.lastIntersectedLowestTilesArray.push.apply(this.lastIntersectedLowestTilesArray,this.fullyIntersectedLowestTilesArray),this.lastIntersectedLowestTilesArray.push.apply(this.lastIntersectedLowestTilesArray,this.partiallyIntersectedLowestTilesArray);for(var r=this.lastIntersectedLowestTilesArray.length,n=0;n<r;n++)(c=this.lastIntersectedLowestTilesArray[n]).isVisible=!1;this.fullyIntersectedLowestTilesArray.length=0,this.partiallyIntersectedLowestTilesArray.length=0,i.getFrustumIntersectedLowestTiles(t,this.fullyIntersectedLowestTilesArray,this.partiallyIntersectedLowestTilesArray),o.getFrustumIntersectedLowestTiles(t,this.fullyIntersectedLowestTilesArray,this.partiallyIntersectedLowestTilesArray),this.frustumVolumeControl.initArrays();var a=this.myCameraSCX.frustumsArray.length,s=this.fullyIntersectedLowestTilesArray.length;for(n=0;n<s;n++)if(void 0!==(c=this.fullyIntersectedLowestTilesArray[n]).sphereExtent){c.isVisible=!0;for(var l=a-1;l>=0;l--){if(this.myCameraSCX.frustumsArray[l].intersectionNearFarSphere(c.sphereExtent)!==Constant.INTERSECTION_OUTSIDE)this.frustumVolumeControl.getFrustumVolumeCulling(l).fullyIntersectedLowestTilesArray.push(c)}}s=this.partiallyIntersectedLowestTilesArray.length;for(n=0;n<s;n++)if(void 0!==(c=this.partiallyIntersectedLowestTilesArray[n]).sphereExtent){c.isVisible=!0;for(l=a-1;l>=0;l--){if(this.myCameraSCX.frustumsArray[l].intersectionNearFarSphere(c.sphereExtent)!==Constant.INTERSECTION_OUTSIDE)this.frustumVolumeControl.getFrustumVolumeCulling(l).partiallyIntersectedLowestTilesArray.push(c)}}var c;for(r=this.lastIntersectedLowestTilesArray.length,n=0;n<r;n++)(c=this.lastIntersectedLowestTilesArray[n]).isVisible||(this.processQueue.putNodesArrayToDelete(c.nodesArray),c.clearNodesArray());this.lastIntersectedLowestTilesArray.length=0},MagoManager.prototype.tilesMultiFrustumCullingFinished=function(e,t,i,o,r){var n=e.length;if(0!==n)for(var a,s,l,c,h,d,u,f=this.magoPolicy.getLod1DistInMeters(),g=this.magoPolicy.getLod2DistInMeters(),p=this.magoPolicy.getLod5DistInMeters(),m=this.magoPolicy.getLod0DistInMeters(),y=this.magoPolicy.getLod1DistInMeters(),v=this.magoPolicy.getLod2DistInMeters(),x=this.magoPolicy.getLod3DistInMeters(),b=this.magoPolicy.getLod4DistInMeters(),C=this.magoPolicy.getLod5DistInMeters(),M=0;M<n;M++)if(void 0!==(s=e[M]).sphereExtent&&!((a=i.distToSphere(s.sphereExtent))>Number(p)))if(s.nodesArray&&s.nodesArray.length>0){for(var _=s.nodesArray.length,A=0;A<_;A++){if(void 0!==(h=(c=s.nodesArray[A]).getRoot()).data.geoLocDataManager)if(d=h.data.geoLocDataManager.getCurrentGeoLocationData(),u=c.getBBoxCenterPositionWorldCoord(d),l=c.data.neoBuilding,this.radiusAprox_aux=l.bbox.getRadiusAprox(),void 0===this.boundingSphere_Aux&&(this.boundingSphere_Aux=new Sphere),this.boundingSphere_Aux.setCenterPoint(u.x,u.y,u.z),this.boundingSphere_Aux.setRadius(this.radiusAprox_aux),a=i.distToSphere(this.boundingSphere_Aux),l.distToCam=a,l.distToCam<m?l.currentLod=0:l.distToCam<y?l.currentLod=1:l.distToCam<v?l.currentLod=2:l.distToCam<x?l.currentLod=3:l.distToCam<b?l.currentLod=4:l.distToCam<C&&(l.currentLod=5),a>this.magoPolicy.getFrustumFarDistance())this.processQueue.putNodeToDelete(c,0);else{if(r)if(o.intersectionSphere(this.boundingSphere_Aux)===Constant.INTERSECTION_OUTSIDE){this.processQueue.putNodeToDeleteLessThanLod3(c,0);continue}var R=l.getHeaderVersion();if(void 0!==R)if("v"===R[0])a<f?t.putNodeToArraySortedByDist(t.currentVisibles0,c):a<1?t.putNodeToArraySortedByDist(t.currentVisibles1,c):a<g?t.putNodeToArraySortedByDist(t.currentVisibles2,c):a<p&&t.putNodeToArraySortedByDist(t.currentVisibles3,c);else{var P=l.metaData.projectDataType;if(P&&4===P)t.putNodeToArraySortedByDist(t.currentVisiblesAux,c);else if(a<f)(T=l.getLodBuildingData(0))&&T.isModelRef?t.putNodeToArraySortedByDist(t.currentVisibles0,c):t.putNodeToArraySortedByDist(t.currentVisibles3,c);else if(a<1){(T=l.getLodBuildingData(1))&&T.isModelRef?t.putNodeToArraySortedByDist(t.currentVisibles1,c):t.putNodeToArraySortedByDist(t.currentVisibles3,c)}else if(a<g){var T;(T=l.getLodBuildingData(2))&&T.isModelRef?t.putNodeToArraySortedByDist(t.currentVisibles2,c):t.putNodeToArraySortedByDist(t.currentVisibles3,c)}else a<p&&t.putNodeToArraySortedByDist(t.currentVisibles3,c)}}else d=this.calculate_geoLocDataOfNode(c)}s.nodesArray.length!==s.nodeSeedsArray.length&&this.createBuildingsByBuildingSeedsOnLowestTile(s)}else this.createBuildingsByBuildingSeedsOnLowestTile(s)},MagoManager.prototype.testAproxDist3D=function(){var e,t=0,i=0,o=new Point3D,r=new Point3D;e=(new Date).getTime();for(var n=0;n<1e6;n++)o.set(1e3*Math.random(),1e3*Math.random(),1e3*Math.random()),r.set(1e3*Math.random(),1e3*Math.random(),1e3*Math.random()),o.squareDistToPoint(r);(new Date).getTime(),e=(new Date).getTime();for(n=0;n<1e6;n++)o.set(1e3*Math.random(),1e3*Math.random(),1e3*Math.random()),r.set(1e3*Math.random(),1e3*Math.random(),1e3*Math.random()),o.aproxDistTo(r,this.sqrtTable);i+=((new Date).getTime()-e)/1e3,e=(new Date).getTime();for(n=0;n<1e6;n++)o.set(1e3*Math.random(),1e3*Math.random(),1e3*Math.random()),r.set(1e3*Math.random(),1e3*Math.random(),1e3*Math.random()),o.distToPoint(r);t+=((new Date).getTime()-e)/1e3},MagoManager.prototype.calculateAproxDist3D=function(e,t){var i,o,r,n,a=Math.abs(e.x-t.x),s=Math.abs(e.y-t.y),l=Math.abs(e.z-t.z);return a>s?a>l?(o=~~(10*(s/(i=a))),r=~~(10*(l/(n=i*this.sqrtTable[o]))),n*this.sqrtTable[r]):(o=~~(10*(a/(i=l))),r=~~(10*(s/(n=i*this.sqrtTable[o]))),n*this.sqrtTable[r]):s>l?(o=~~(10*(a/(i=s))),r=~~(10*(l/(n=i*this.sqrtTable[o]))),n*this.sqrtTable[r]):(o=~~(10*(a/(i=l))),r=~~(10*(s/(n=i*this.sqrtTable[o]))),n*this.sqrtTable[r])},MagoManager.prototype.createBuildingsByBuildingSeedsOnLowestTile=function(e){var t,i,o,r,n=0;e.nodesArray&&(n=e.nodesArray.length);for(var a=e.nodeSeedsArray.length,s=n;s<a;s++)t=e.nodeSeedsArray[s],(i=new NeoBuilding).nodeOwner=t,t.data.neoBuilding=i,o=new BoundingBox,t.data.bbox=o,r=t.data.buildingSeed,void 0===e.nodesArray&&(e.nodesArray=[]),e.nodesArray.push(t),void 0===i.metaData&&(i.metaData=new MetaData),void 0===i.metaData.geographicCoord&&(i.metaData.geographicCoord=new GeographicCoord),void 0===i.metaData.bbox&&(i.metaData.bbox=new BoundingBox),i.name=r.name,i.buildingId=r.buildingId,i.buildingType="basicBuilding",i.buildingFileName=r.buildingFileName,i.metaData.geographicCoord.setLonLatAlt(r.geographicCoord.longitude,r.geographicCoord.latitude,r.geographicCoord.altitude),i.metaData.bbox.copyFrom(r.bBox),o.copyFrom(r.bBox),void 0===i.bbox&&(i.bbox=new BoundingBox),i.bbox.copyFrom(r.bBox),i.metaData.heading=r.rotationsDegree.z,i.metaData.pitch=r.rotationsDegree.x,i.metaData.roll=r.rotationsDegree.y,i.projectFolderName=t.data.projectFolderName},MagoManager.prototype.calculate_geoLocDataOfNode=function(e){var t=e.getRoot();void 0===t.data.geoLocDataManager&&(t.data.geoLocDataManager=new GeoLocationDataManager);var i=t.data.geoLocDataManager,o=i.getCurrentGeoLocationData();if(void 0===o||void 0===o.pivotPoint){var r,n;if(o=i.newGeoLocationData("deploymentLoc"),void 0===e.data.geographicCoord)r=(u=e.data.buildingSeed).geographicCoord,n=u.rotationsDegree;else r=e.data.geographicCoord,n=e.data.rotationsDegree;var a=r.longitude,s=r.latitude,l=r.altitude,c=n.z,h=n.x,d=n.y;if(ManagerUtils.calculateGeoLocationData(a,s,l,c,h,d,o,this),this.pointSC=e.data.bbox.getCenterPoint(this.pointSC),void 0!==e.data.mapping_type&&"boundingboxcenter"===e.data.mapping_type.toLowerCase())if(e.getRoot()){var u,f=(u=e.data.buildingSeed).bBox;this.pointSC=f.getCenterPoint(this.pointSC),ManagerUtils.translatePivotPointGeoLocationData(o,this.pointSC)}}return o},MagoManager.prototype.flyTo=function(e,t,i,o){MagoConfig.getPolicy().geo_view_library===Constant.CESIUM?this.scene.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(parseFloat(e),parseFloat(t),parseFloat(i)+10),duration:parseInt(o)}):MagoConfig.getPolicy().geo_view_library===Constant.WORLDWIND?(this.wwd.goToAnimator.travelTime=1e3*o,this.wwd.goTo(new WorldWind.Position(parseFloat(t),parseFloat(e),parseFloat(i)+50))):MagoConfig.getPolicy().geo_view_library===Constant.MAGOWORLD&&this.magoWorld.goto(parseFloat(e),parseFloat(t),parseFloat(i)+10)},MagoManager.prototype.flyToBuilding=function(e,t,i){var o=this.hierarchyManager.getNodeByDataName(t,"nodeId",i);if(void 0!==o){var r,n=o.getRoot(),a=n.data.geoLocDataManager;if(void 0!==a||void 0!==(r=this.calculate_geoLocDataOfNode(o))){r=(a=n.data.geoLocDataManager).getCurrentGeoLocationData();var s=o.getBBoxCenterPositionWorldCoord(r);if(void 0!==s)if(this.radiusAprox_aux=n.data.bbox.getRadiusAprox(),void 0===this.boundingSphere_Aux&&(this.boundingSphere_Aux=new Sphere),this.boundingSphere_Aux.radius=this.radiusAprox_aux,this.configInformation.geo_view_library===Constant.CESIUM){this.boundingSphere_Aux.center=Cesium.Cartesian3.clone(s);this.scene.camera.flyToBoundingSphere(this.boundingSphere_Aux,3)}else if(this.configInformation.geo_view_library===Constant.WORLDWIND){var l=buildingSeed.geographicCoordOfBBox;this.wwd.goToAnimator.travelTime=3e3,this.wwd.goTo(new WorldWind.Position(l.latitude,l.longitude,l.altitude+1e3))}}else apiResultCallback(MagoConfig.getPolicy().geo_callback_apiresult,e,"-1")}else apiResultCallback(MagoConfig.getPolicy().geo_callback_apiresult,e,"-1")},MagoManager.prototype.getNeoBuildingById=function(e,t){return this.smartTileManager.getNeoBuildingById(e,t)},MagoManager.prototype.getBuildingSeedById=function(e,t){return this.smartTileManager.getBuildingSeedById(e,t)},MagoManager.prototype.doFrustumCullingTerranTileServiceFormat=function(e,t,i,o){var r,n,a,s;this.filteredVisibleTiles_array.length=0,this.detailedVisibleTiles_array.length=0,this.LOD0VisibleTiles_array.length=0;this.currentVisible_terranTiles_array.length=0,this.terranTile.getIntersectedSmallestTiles(t,this.currentVisible_terranTiles_array,this.boundingSphere_Aux);var l=this.currentVisible_terranTiles_array.length;if(0!==l){for(var c=0;c<l;c++)this.terranTileSC=this.currentVisible_terranTiles_array[c],(r=Cesium.Cartesian3.distanceSquared(o,this.terranTileSC.position))>this.min_squaredDist_to_see||(r<1.2*this.min_squaredDist_to_see_detailed?this.detailedVisibleTiles_array.push(this.terranTileSC):r<1.2*this.min_squaredDist_to_see_LOD0?this.LOD0VisibleTiles_array.push(this.terranTileSC):this.filteredVisibleTiles_array.push(this.terranTileSC));this.boundingSphere_Aux.radius=50;var h,d,u=!1,f=this.detailedVisibleTiles_array.length;for(c=0;c<f;c++)if(this.terranTileSC=this.detailedVisibleTiles_array[c],this.terranTileSC.fileReading_started){this.terranTileSC.fileReading_finished&&!this.terranTileSC.fileParsingFinished&&this.terranTileSC.parseFileAllBuildings(this),u=!1,this.terranTileSC.visibilityType===Cesium.Intersect.INTERSECTING&&(u=!0),a=this.terranTileSC._BR_buildingsArray.length;for(var g=0;g<a;g++)void 0!==(s=this.detailedVisibleTiles_array[c]._BR_buildingsArray[g]).buildingPosition?(r=Cesium.Cartesian3.distanceSquared(o,s.buildingPosition))<this.min_squaredDist_to_see_detailed?s._compRefList_Container.compRefsListArray.length>0?1===s._header._f4d_version&&(n?r<n?(n=r,this.currentVisibleBuildings_LOD0_array.push(this.detailed_building),this.detailed_building=s):this.currentVisibleBuildings_LOD0_array.push(s):(n=r,this.detailed_building=s)):s._header.isSmall?i.push(s):this.currentVisibleBuildings_LOD0_array.push(s):r<this.min_squaredDist_to_see_LOD0?u?(this.boundingSphere_Aux.center=Cesium.Cartesian3.clone(s.buildingPosition),u&&t.computeVisibility(this.boundingSphere_Aux)!==Cesium.Intersect.OUTSIDE&&this.currentVisibleBuildings_LOD0_array.push(s)):this.currentVisibleBuildings_LOD0_array.push(s):u?(this.boundingSphere_Aux.center=Cesium.Cartesian3.clone(s.buildingPosition),u&&t.computeVisibility(this.boundingSphere_Aux)!==Cesium.Intersect.OUTSIDE&&i.push(s)):i.push(s):this.currentVisibleBuildings_LOD0_array.push(s)}else this.backGround_fileReadings_count<10&&(d=this.terranTileSC._numberName.toString(),h=this.readerWriter.getCurrentDataPath()+Constant.RESULT_XDO2F4D_TERRAINTILES+d+".til",this.readerWriter.getTileArrayBuffer(e,h,this.terranTileSC,this.readerWriter,this),this.backGround_fileReadings_count++);var p=this.LOD0VisibleTiles_array.length;for(c=0;c<p;c++)if(this.terranTileSC=this.LOD0VisibleTiles_array[c],this.terranTileSC.fileReading_started){this.terranTileSC.fileReading_finished&&!this.terranTileSC.fileParsingFinished&&this.terranTileSC.parseFileAllBuildings(this),u=!1,this.terranTileSC.visibilityType===Cesium.Intersect.INTERSECTING&&(u=!0),a=this.terranTileSC._BR_buildingsArray.length;for(g=0;g<a;g++)void 0!==(s=this.LOD0VisibleTiles_array[c]._BR_buildingsArray[g]).buildingPosition?(r=Cesium.Cartesian3.distanceSquared(o,s.buildingPosition))<this.min_squaredDist_to_see_LOD0?u?(this.boundingSphere_Aux.center=Cesium.Cartesian3.clone(s.buildingPosition),t.computeVisibility(this.boundingSphere_Aux)!==Cesium.Intersect.OUTSIDE&&this.currentVisibleBuildings_LOD0_array.push(s)):this.currentVisibleBuildings_LOD0_array.push(s):u?(this.boundingSphere_Aux.center=Cesium.Cartesian3.clone(s.buildingPosition),t.computeVisibility(this.boundingSphere_Aux)!==Cesium.Intersect.OUTSIDE&&i.push(s)):i.push(s):i.push(s)}else this.backGround_fileReadings_count<10&&(d=this.terranTileSC._numberName.toString(),h=this.readerWriter.getCurrentDataPath()+Constant.RESULT_XDO2F4D_TERRAINTILES+d+".til",this.readerWriter.getTileArrayBuffer(e,h,this.terranTileSC,this.readerWriter,this),this.backGround_fileReadings_count++);var m=this.filteredVisibleTiles_array.length;for(c=0;c<m;c++)if(this.terranTileSC=this.filteredVisibleTiles_array[c],this.terranTileSC.fileReading_started){this.terranTileSC.fileReading_finished&&!this.terranTileSC.fileParsingFinished&&this.terranTileSC.parseFileAllBuildings(this),u=!1,this.terranTileSC.visibilityType===Cesium.Intersect.INTERSECTING&&(u=!0),a=this.terranTileSC._BR_buildingsArray.length;for(g=0;g<a;g++)void 0!==(s=this.filteredVisibleTiles_array[c]._BR_buildingsArray[g]).buildingPosition?(r=Cesium.Cartesian3.distanceSquared(o,s.buildingPosition),s._header.isSmall?r<this.min_squaredDist_to_see_smallBuildings&&(u?(this.boundingSphere_Aux.center=Cesium.Cartesian3.clone(s.buildingPosition),t.computeVisibility(this.boundingSphere_Aux)!==Cesium.Intersect.OUTSIDE&&i.push(s)):i.push(s)):r<this.min_squaredDist_to_see_LOD0?u?(this.boundingSphere_Aux.center=Cesium.Cartesian3.clone(s.buildingPosition),t.computeVisibility(this.boundingSphere_Aux)!==Cesium.Intersect.OUTSIDE&&this.currentVisibleBuildings_LOD0_array.push(s)):this.currentVisibleBuildings_LOD0_array.push(s):u?(this.boundingSphere_Aux.center=Cesium.Cartesian3.clone(s.buildingPosition),t.computeVisibility(this.boundingSphere_Aux)!==Cesium.Intersect.OUTSIDE&&i.push(s)):i.push(s)):i.push(s)}else this.backGround_fileReadings_count<10&&(d=this.terranTileSC._numberName.toString(),h=this.readerWriter.getCurrentDataPath()+Constant.RESULT_XDO2F4D_TERRAINTILES+d+".til",this.readerWriter.getTileArrayBuffer(e,h,this.terranTileSC,this.readerWriter,this),this.backGround_fileReadings_count++);return i}},MagoManager.prototype.doFrustumCullingClouds=function(e,t){this.currentVisibleClouds_array.length=0;for(var i=this.atmosphere.cloudsManager.circularCloudsArray.length,o=0;o<i;o++){var r=this.atmosphere.cloudsManager.circularCloudsArray[o];if(void 0!==r.cullingPosition)this.boundingSphere_Aux.center=Cesium.Cartesian3.clone(r.cullingPosition),this.radiusAprox_aux=r.cullingRadius,this.radiusAprox_aux?this.boundingSphere_Aux.radius=this.radiusAprox_aux:this.boundingSphere_Aux.radius=50,e.computeVisibility(this.boundingSphere_Aux)!==Cesium.Intersect.OUTSIDE&&this.currentVisibleClouds_array.push(r)}return t},MagoManager.prototype.renderModeChanged=function(){0===this.renderModeTemp||1===this.renderModeTemp||this.renderModeTemp},MagoManager.prototype.displayLocationAndRotation=function(e){var t=e.nodeOwner,i=this.getNodeGeoLocDataManager(t);if(void 0!==i){var o=i.getCurrentGeoLocationData();o.geographicCoord.latitude,o.geographicCoord.longitude,o.geographicCoord.altitude,o.heading,o.pitch,o.roll,e.buildingId.split("_")}},MagoManager.prototype.selectedObjectNotice=function(e){var t=e.nodeOwner,i=this.getNodeGeoLocDataManager(t);if(void 0!==i){var o=i.getCurrentGeoLocationData(),r=t.data.nodeId,n=t.data.projectId;if("true"===MagoConfig.getPolicy().geo_callback_enable){var a=null;if(void 0!==this.objectSelected&&(a=this.objectSelected.objectId),this.magoPolicy.getObjectInfoViewEnable()&&selectedObjectCallback(MagoConfig.getPolicy().geo_callback_selectedobject,n,r,a,o.geographicCoord.latitude,o.geographicCoord.longitude,o.geographicCoord.altitude,o.heading,o.pitch,o.roll),this.magoPolicy.getIssueInsertEnable()){if(void 0===this.objMarkerSC)return;insertIssueCallback(MagoConfig.getPolicy().geo_callback_insertissue,n,r,a,o.geographicCoord.latitude,o.geographicCoord.longitude,parseFloat(o.geographicCoord.altitude))}}}},MagoManager.prototype.changeLocationAndRotation=function(e,t,i,o,r,n,a,s){var l=this.hierarchyManager.getNodesMap(e);if(l){var c=l[t];if(void 0===c)return;this.changeLocationAndRotationNode(c,i,o,r,n,a,s)}},MagoManager.prototype.changeLocationAndRotationNode=function(e,t,i,o,r,n,a){var s;if(void 0!==e&&void 0!==(s=e.getClosestParentWithData("geoLocDataManager"))){var l,c=[];s.extractNodesByDataName(c,"neoBuilding");for(var h=c.length,d=0;d<h;d++){l=c[d];var u=this.getNodeGeoLocDataManager(l).getCurrentGeoLocationData();if(void 0!==(u=ManagerUtils.calculateGeoLocationData(i,t,o,r,n,a,u,this))){var f=l.data.neoBuilding;f.octree&&f.octree.multiplyKeyTransformMatrix(0,u.rotMatrix),f.calculateBBoxCenterPositionWorldCoord(u),s.bboxAbsoluteCenterPos=void 0,s.calculateBBoxCenterPositionWorldCoord(u),l.bboxAbsoluteCenterPos=void 0,l.calculateBBoxCenterPositionWorldCoord(u)}}this.selectedObjectNotice(this.buildingSelected)}},MagoManager.prototype.getObjectIndexFile=function(e,t){var i;void 0===this.configInformation&&(this.configInformation=MagoConfig.getPolicy()),this.buildingSeedList=new BuildingSeedList;var o=t;i=this.readerWriter.geometryDataPath+"/"+o+Constant.OBJECT_INDEX_FILE+Constant.CACHE_VERSION+MagoConfig.getPolicy().content_cache_version,this.readerWriter.getObjectIndexFileForSmartTile(i,this,this.buildingSeedList,e)},MagoManager.prototype.getObjectIndexFile_xxxx=function(){void 0===this.configInformation&&(this.configInformation=MagoConfig.getPolicy()),this.buildingSeedList=new BuildingSeedList,this.readerWriter.getObjectIndexFileForSmartTile(this.readerWriter.getCurrentDataPath()+Constant.OBJECT_INDEX_FILE+Constant.CACHE_VERSION+MagoConfig.getPolicy().content_cache_version,this,this.buildingSeedList)},MagoManager.prototype.makeNode=function(e,t,i,o,r){var n,a,s,l,c,h,d=void 0,u=void 0,f=void 0,g=void 0,p=void 0,m=void 0,y=void 0,v=void 0,x=void 0,b=void 0,C=void 0;if(void 0!==e&&(d=e.attributes,u=e.children,e.data_group_id,e.data_group_name,e.data_id,f=e.data_key,g=e.data_name,p=e.heading,m=e.height,y=e.latitude,v=e.longitude,x=e.pitch,b=e.roll,C=e.mapping_type),void 0!==d){var M;if(n=f,(s=this.hierarchyManager.newNode(n,r,d)).data.projectFolderName=o,s.data.projectId=r,s.data.data_name=g,s.data.attributes=d,s.data.mapping_type=C,d.isPhysical&&(a=i[n])&&(s.data.buildingSeed=a,t.push(s)),v&&y&&(void 0===m&&(m=0),s.data.geographicCoord=new GeographicCoord,s.data.geographicCoord.setLonLatAlt(v,y,m),void 0===s.data.rotationsDegree&&(s.data.rotationsDegree=new Point3D),s.data.rotationsDegree.set(x,b,p),void 0!==a)){void 0===a.geographicCoord&&(a.geographicCoord=new GeographicCoord),void 0===a.rotationsDegree&&(a.rotationsDegree=new Point3D),a.geographicCoord.setLonLatAlt(v,y,m),a.rotationsDegree.set(x,b,p),void 0===a.geographicCoordOfBBox&&(a.geographicCoordOfBBox=new GeographicCoord);var _,A=ManagerUtils.geographicCoordToWorldPoint(v,y,m,A,this);M=ManagerUtils.calculateTransformMatrixAtWorldPosition(A,p,x,b,void 0,M,this),_=a.bBox.getCenterPoint(_);var R=M.transformPoint3D(_,R);a.geographicCoordOfBBox=ManagerUtils.pointToGeographicCoord(R,a.geographicCoordOfBBox,this)}if(s.data.bbox=new BoundingBox,s.data.buildingSeed&&s.data.buildingSeed.bBox&&s.data.bbox.copyFrom(a.bBox),s.data.mapping_type&&"boundingboxcenter"===s.data.mapping_type.toLowerCase()&&s.data.bbox.translateToOrigin(),void 0!==M){_=s.data.bbox.getCenterPoint(_);R=M.transformPoint3D(_,R);s.data.bbox.geographicCoord=ManagerUtils.pointToGeographicCoord(R,s.data.bbox.geographicCoord,this)}if(s.data.bbox,void 0!==u){h=u.length;for(var P=0;P<h;P++)l=u[P],void 0===(c=this.makeNode(l,t,i,o,r)).data.geographicCoord&&s.addChildren(c)}}return s},MagoManager.prototype.calculateBoundingBoxesNodes=function(){for(var e,t,i,o,r,n,a,s,l,c=this.hierarchyManager.nodesArray.length,h=0;h<c;h++)if(i=(e=this.hierarchyManager.nodesArray[h]).data.buildingSeed){o=(t=e.getClosestParentWithData("geographicCoord")).data.geographicCoord.longitude,r=t.data.geographicCoord.latitude,n=t.data.geographicCoord.altitude,a=t.data.rotationsDegree.z,s=t.data.rotationsDegree.x,l=t.data.rotationsDegree.y,void 0===i.geographicCoord&&(i.geographicCoord=new GeographicCoord),void 0===i.rotationsDegree&&(i.rotationsDegree=new Point3D),i.geographicCoord.setLonLatAlt(o,r,n),i.rotationsDegree.set(s,l,a),void 0===i.geographicCoordOfBBox&&(i.geographicCoordOfBBox=new GeographicCoord);var d=ManagerUtils.geographicCoordToWorldPoint(o,r,n,d,this),u=ManagerUtils.calculateTransformMatrixAtWorldPosition(d,a,s,l,void 0,u,this);if(e.data.attributes.mapping_type&&"boundingboxcenter"===e.data.attributes.mapping_type){var f=i.bBox.getCenterPoint(f),g=u.transformPoint3D(f,g);i.geographicCoordOfBBox=ManagerUtils.pointToGeographicCoord(g,i.geographicCoordOfBBox,this)}else i.geographicCoordOfBBox.setLonLatAlt(o,r,n)}var p=[],m=[];this.hierarchyManager.getRootNodes(p);var y=!1,v=p.length;for(h=0;h<v;h++){t=p[h],m.length=0,t.extractNodesByDataName(m,"buildingSeed"),y=!1,c=m.length;for(var x=0;x<c;x++){var b=(e=m[x]).data.bbox;b&&(e.data.attributes?(e.data.attributes.isMain,!1===y?(t.data.bbox.copyFrom(b),y=!0):t.data.bbox.addBox(b)):!1===y?(t.data.bbox.copyFrom(b),y=!0):t.data.bbox.addBox(b))}}},MagoManager.prototype.makeSmartTile=function(e,t){for(var i,o=MagoConfig.getData(CODE.PROJECT_ID_PREFIX+t),r=[],n={},a=e.buildingSeedArray.length,s=0;s<a;s++)n[(i=e.buildingSeedArray[s]).buildingId]=i;var l=o.data_key;this.makeNode(o,r,n,l,t),this.calculateBoundingBoxesNodes();for(var c=this.smartTileManager.tilesArray.length,h=0;h<c;h++){var d=this.smartTileManager.tilesArray[h];void 0===d.nodeSeedsArray&&(d.nodeSeedsArray=[]),d.nodeSeedsArray=r,d.makeTreeByDepth(17,this)}this.buildingSeedList.buildingSeedArray.length=0},MagoManager.prototype.getNeoBuildingByTypeId=function(e,t){return this.smartTileManager.getNeoBuildingById(e,t)},MagoManager.prototype.callAPI=function(e){var t=e.getAPIName();if("changeMagoState"===t)this.magoPolicy.setMagoEnable(e.getMagoEnable());else{if("searchData"===t)return this.flyToBuilding(t,e.getProjectId(),e.getDataKey());if("changeColor"===t)ColorAPI.changeColor(e,this);else if("show"===t)this.magoPolicy.setHideBuildings.length=0;else if("hide"===t)this.magoPolicy.setHideBuildings(e.gethideBuilds());else if("changeOutFitting"===t)this.magoPolicy.setShowOutFitting(e.getShowOutFitting());else if("changeLabel"===t){this.magoPolicy.setShowLabelInfo(e.getShowLabelInfo());var i=document.getElementById("objectLabel").getContext("2d");i.clearRect(0,0,i.canvas.width,i.canvas.height)}else if("changeOrigin"===t)this.magoPolicy.setShowOrigin(e.getShowOrigin());else if("changeBoundingBox"===t)this.magoPolicy.setShowBoundingBox(e.getShowBoundingBox());else if("changeShadow"===t)this.magoPolicy.setShowShadow(e.getShowShadow());else if("changefrustumFarDistance"===t)this.magoPolicy.setFrustumFarSquaredDistance(e.getFrustumFarDistance()*e.getFrustumFarDistance());else if("changeLocationAndRotation"===t)LocationAndRotationAPI.changeLocationAndRotation(e,this);else if("changeObjectMove"===t)this.magoPolicy.setObjectMoveMode(e.getObjectMoveMode());else if("saveObjectMove"===t);else if("deleteAllObjectMove"===t){var o=MagoConfig.getAllMovingHistory();if(void 0===o)return void MagoConfig.clearMovingHistory();for(var r in o)if(Object.prototype.hasOwnProperty.call(o,r)){if(void 0===(c=o[P=r]))continue;for(var n in c)if(Object.prototype.hasOwnProperty.call(c,n)){var a=n;if(void 0===(h=c[n]))continue;for(var s in h)if(Object.prototype.hasOwnProperty.call(h,s)){if(void 0===(G=this.hierarchyManager.getNodeByDataKey(P,a))||void 0===G.data)continue;if(void 0===(m=G.data.neoBuilding))continue;(p=m.getReferenceObject(s))&&(p.moveVector=void 0,p.moveVectorRelToBuilding=void 0)}}}MagoConfig.clearMovingHistory()}else if("deleteAllChangeColor"===t){var l=MagoConfig.getAllColorHistory();if(void 0===l)return void MagoConfig.clearColorHistory();for(var r in l)if(Object.prototype.hasOwnProperty.call(l,r)){var c;if(void 0===(c=l[P=r]))continue;for(var n in c)if(Object.prototype.hasOwnProperty.call(c,n)){var h;a=n;if(void 0===(h=c[n]))continue;for(var d in h)if(Object.prototype.hasOwnProperty.call(h,d)){if(void 0===(G=this.hierarchyManager.getNodeByDataKey(P,a))||void 0===G.data)continue;if(void 0===(m=G.data.neoBuilding))continue;var u=m.getReferenceObjectsArrayByObjectId(d);if(void 0===u)continue;for(var f=u.length,g=0;g<f;g++){var p;(p=u[g])&&(p.aditionalColor=void 0)}}}}MagoConfig.clearColorHistory()}else if("changeInsertIssueMode"===t)this.magoPolicy.setIssueInsertEnable(e.getIssueInsertEnable());else if("changeObjectInfoViewMode"===t)this.magoPolicy.setObjectInfoViewEnable(e.getObjectInfoViewEnable());else if("changeNearGeoIssueListViewMode"===t)this.magoPolicy.setNearGeoIssueListEnable(e.getNearGeoIssueListEnable()),e.getNearGeoIssueListEnable()||(this.objMarkerManager.objectMarkerArray=[]);else if("changeOcclusionCulling"===t){var m;this.magoPolicy.setOcclusionCullingEnable(e.getOcclusionCullingEnable()),(m=this.selectionCandidates.currentBuildingSelected)&&m.setRenderSettingApplyOcclusionCulling(this.magoPolicy.getOcclusionCullingEnable())}else if("drawInsertIssueImage"===t)DrawAPI.drawInsertIssueImage(e,this);else if("changeInsertIssueState"===t)this.sceneState.insertIssueState=0;else if("changeLod"===t)LodAPI.changeLod(e,this);else if("changeLighting"===t)this.magoPolicy.setAmbientReflectionCoef(e.getAmbientReflectionCoef()),this.magoPolicy.setDiffuseReflectionCoef(e.getDiffuseReflectionCoef()),this.magoPolicy.setSpecularReflectionCoef(e.getSpecularReflectionCoef()),this.magoPolicy.setSpecularColor(e.getSpecularColor());else if("changeSsaoRadius"===t)this.magoPolicy.setSsaoRadius(e.getSsaoRadius());else if("changeFPVMode"===t)if(e.getFPVMode()){if(void 0!==this.cameraFPV._camera)return;if(this.cameraFPV.init(),this.configInformation.geo_view_library===Constant.WORLDWIND);else if(this.configInformation.geo_view_library===Constant.CESIUM){var y=new Cesium.Matrix4,v=new Cesium.Cartesian4,x=this.scene._camera;this.cameraFPV._camera=x,this.cameraFPV._cameraBAK=Cesium.Camera.clone(x,this.cameraFPV._cameraBAK);var b=new Cesium.Cartesian3,C=new Cesium.Cartesian3,M=new Cesium.Cartesian3,_=this.scene.globe.ellipsoid.cartesianToCartographic(x.position);_.height=this.scene.globe.getHeight(_)+1.5,this.scene.globe.ellipsoid.cartographicToCartesian(_,b);var A=Cesium.Transforms.eastNorthUpToFixedFrame(b,Cesium.Ellipsoid.WGS84,y);Cesium.Cartesian3.fromCartesian4(Cesium.Matrix4.getColumn(A,1,v),C),Cesium.Cartesian3.fromCartesian4(Cesium.Matrix4.getColumn(A,2,v),M),x.flyTo({destination:b,orientation:{direction:C,up:M},duration:1})}}else{if(void 0===this.cameraFPV._cameraBAK)return;this.configInformation.geo_view_library===Constant.WORLDWIND||this.configInformation.geo_view_library===Constant.CESIUM&&(this.scene._camera=Cesium.Camera.clone(this.cameraFPV._cameraBAK,this.scene._camera)),this.cameraFPV.release()}else if("changePropertyRendering"===t){var R=e.getShowShadow(),P=e.getProjectId(),T=e.getProperty().split("="),L=T[0],S=T[1];void 0===this.propertyFilterSC&&(this.propertyFilterSC={}),this.propertyFilterSC.visible=R,this.propertyFilterSC.projectId=P,this.propertyFilterSC.propertyKey=L,this.propertyFilterSC.propertyValue=S}else if("drawAppendData"===t)DrawAPI.drawAppendData(e,this);else if("drawDeleteData"===t)this.deleteAll();else if("clearAllData"===t)this.deleteAll();else if("getDataInfoByDataKey"===t){P=e.getProjectId(),a=e.getDataKey();if(void 0===(G=this.hierarchyManager.getNodeByDataKey(P,a)))return void apiResultCallback(MagoConfig.getPolicy().geo_callback_apiresult,t,"-1");var w=G.data.data_name,E=G.data.geoLocDataManager;if(void 0===w||void 0===E)return void apiResultCallback(MagoConfig.getPolicy().geo_callback_apiresult,t,"-1");if(void 0===(z=E.getCurrentGeoLocationData())||void 0===z.geographicCoord)return void apiResultCallback(MagoConfig.getPolicy().geo_callback_apiresult,t,"-1");P=G.data.projectId;var D=z.geographicCoord.latitude,I=z.geographicCoord.longitude,O=z.geographicCoord.altitude,V=z.heading,B=z.pitch,F=z.roll;dataInfoCallback(MagoConfig.getPolicy().geo_callback_dataInfo,P,a,w,D,I,O,V,B,F)}else if("gotoProject"===t){P=e.getProjectId();var N=this.hierarchyManager.getNodesMap(P);if(0===Object.keys(N).length){var U=e.getProjectDataFolder();this.getObjectIndexFile(P,U)}this.flyTo(e.getLongitude(),e.getLatitude(),e.getElevation(),e.getDuration())}else if("gotoIssue"===t){P=e.getProjectId();if(!this.hierarchyManager.existProject(P)){U=e.getProjectDataFolder();this.getObjectIndexFile(P,U)}this.flyTo(e.getLongitude(),e.getLatitude(),e.getElevation(),e.getDuration()),null!==e.getIssueId()&&void 0!==e.getIssueType()&&DrawAPI.drawInsertIssueImage(e,this)}else{if("getCoordinateRelativeToBuilding"===t){P=e.getProjectId(),a=e.getDataKey();var j=e.getInputPoint(),H=e.getResultPoint();if(void 0===P||void 0===a||void 0===j)return;if(void 0===H&&(H=new Point3D),void 0===(G=this.hierarchyManager.getNodeByDataKey(P,a)))return;if(void 0===(E=G.data.geoLocDataManager))return;return H=(z=E.getCurrentGeoLocationData()).worldCoordToLocalCoord(j,H)}if("getAbsoluteCoodinateOfBuildingPoint"===t){P=e.getProjectId(),a=e.getDataKey();var G,z,W=e.getInputPoint();H=e.getResultPoint();if(void 0===P||void 0===a||void 0===W)return;if(void 0===H&&(H=new Point3D),void 0===(G=this.hierarchyManager.getNodeByDataKey(P,a)))return;if(void 0===(E=G.data.geoLocDataManager))return;return H=(z=E.getCurrentGeoLocationData()).localCoordToWorldCoord(W,H)}}}},MagoManager.prototype.deleteAll=function(){this.selectionCandidates.clearCandidates(),this.selectionCandidates.clearCurrents(),this.objectSelected=void 0,this.octreeSelected=void 0,this.buildingSelected=void 0,this.nodeSelected=void 0,this.parseQueue.clearAll(),this.processQueue.clearAll(),this.visibleObjControlerBuildings&&this.visibleObjControlerBuildings.clear(),this.visibleObjControlerNodes&&this.visibleObjControlerNodes.clear(),this.visibleObjControlerOctrees&&this.visibleObjControlerOctrees.clear(),this.smartTileManager.resetTiles(),this.hierarchyManager.deleteNodes(this.sceneState.gl,this.vboMemoryManager)},MagoManager.prototype.checkCollision=function(e,t){var i=this.sceneState.gl;if(void 0!==i){var o=.5*this.sceneState.drawingBufferWidth,r=.5*this.sceneState.drawingBufferHeight;if(void 0!==this.getSelectedObjects(i,o,r,this.arrayAuxSC)){var n=this.buildingSelected;this.buildingSelected=this.arrayAuxSC[0];var a=new Point3D,s=new Point3D;this.calculatePixelPositionWorldCoord(i,o,r,a),this.swapRenderingFase(),this.calculatePixelPositionWorldCoord(i,o,this.sceneState.drawingBufferHeight,s),this.buildingSelected=n;var l=a.squareDistTo(e.x,e.y,e.z);if(this.swapRenderingFase(),l>3.5){var c=this.scene.globe.ellipsoid.cartesianToCartographic(s),h=this.scene.globe.ellipsoid.cartesianToCartographic(e),d=h.height,u=c.height+1.5;u<d&&(d-=.2),(u>d||u<d&&d-u>1.5)&&(d=u);var f=Cesium.Math.toDegrees(h.latitude),g=Cesium.Math.toDegrees(h.longitude);return this.cameraFPV.camera.position=Cesium.Cartesian3.fromDegrees(g,f,d),!1}return!0}}};var ManagerFactory=function(e,t,i,o,r,n,a){if(!(this instanceof ManagerFactory))throw new Error(Messages.CONSTRUCT_ERROR);var s=null,l=null,c=CODE.magoManagerState.INIT;function h(){s.handler.setInputAction(function(e){s.mouseActionLeftDown(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.LEFT_DOWN),s.handler.setInputAction(function(e){s.mouseActionMiddleDown(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.MIDDLE_DOWN),s.handler.setInputAction(function(e){s.mouseActionRightDown(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.RIGHT_DOWN),s.handler.setInputAction(function(t){var i;s.mouseLeftDown?t.startPosition.x===t.endPosition.x&&t.startPosition.y===t.endPosition.y||(s.manageMouseDragging(t.startPosition.x,t.startPosition.y),s.cameraMoved()):(s.mouseDragging=!1,i=!0,e.scene.screenSpaceCameraController.enableRotate=i,e.scene.screenSpaceCameraController.enableZoom=i,e.scene.screenSpaceCameraController.enableLook=i,e.scene.screenSpaceCameraController.enableTilt=i,e.scene.screenSpaceCameraController.enableTranslate=i,(s.mouseMiddleDown||s.mouseRightDown)&&(s.isCameraMoving=!0,s.cameraMoved()))},Cesium.ScreenSpaceEventType.MOUSE_MOVE),s.handler.setInputAction(function(e){s.mouseActionLeftUp(e.position.x,e.position.y);var t={lat:null,lon:null,alt:null},o=s.scene.camera.pickEllipsoid(e.position);if(o){var r=Cesium.Cartographic.fromCartesian(o);t.lat=Cesium.Math.toDegrees(r.latitude),t.lon=Cesium.Math.toDegrees(r.longitude),t.alt=r.height}"true"===MagoConfig.getPolicy().geo_callback_enable&&""!==i.geo_callback_clickposition&&clickPositionCallback(i.geo_callback_clickposition,t)},Cesium.ScreenSpaceEventType.LEFT_UP),s.handler.setInputAction(function(e){s.mouseActionMiddleUp(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.MIDDLE_UP),s.handler.setInputAction(function(e){s.mouseActionRightUp(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.RIGHT_UP)}function d(){var t,i;MagoConfig.getPolicy().geo_view_library===Constant.CESIUM?function(){var t=e.scene.context._gl;if(e.scene.magoManager.shadersManager.createDefaultShader(t),e.scene.magoManager.postFxShadersManager.gl=t,e.scene.magoManager.postFxShadersManager.createDefaultShaders(t),e.scene.magoManager.createDefaultShaders(t),e.scene.magoManager.scene=e.scene,s=e.scene.magoManager,l=e.scene,e.scene.globe.depthTestAgainstTerrain=!0,null!==o&&o.length>0)for(var i=0;i<o.length;i++)e.scene.magoManager.getObjectIndexFile(o[i],n[i]);e.scene.magoManager.handler=new Cesium.ScreenSpaceEventHandler(l.canvas),h(),e.clock.onTick.addEventListener(function(e){s.cameraFPV.update(s)})}():MagoConfig.getPolicy().geo_view_library===Constant.WORLDWIND||MagoConfig.getPolicy().geo_view_library===Constant.MAGOWORLD&&(t=e.magoManager.sceneState.gl,(i=e.magoManager).shadersManager.createDefaultShader(t),i.postFxShadersManager.gl=t,i.postFxShadersManager.createDefaultShaders(t),i.createDefaultShaders(t))}MagoConfig.init(i,o,r);var u,f,g="ESRI World Imagery",p="WGS84 Ellipsoid";if(null===i.geo_view_library||""===i.geo_view_library||i.geo_view_library===Constant.CESIUM){if((v=document.getElementById(t)).addEventListener("webglcontextlost",function(e){},!1),v.addEventListener("webglcontextrestored",function(e){},!1),"true"===i.geo_server_enable&&null!==i.geo_server_url&&""!==i.geo_server_url){var m={imageryProvider:new Cesium.WebMapServiceImageryProvider({url:i.geo_server_url,layers:i.geo_server_layers,parameters:{service:i.geo_server_parameters_service,version:i.geo_server_parameters_version,request:i.geo_server_parameters_request,transparent:i.geo_server_parameters_transparent,format:i.geo_server_parameters_format}}),baseLayerPicker:!1};null===e&&(e=new Cesium.Viewer(t,m))}else null!==i.geo_cesium_ion_token&&""!==i.geo_cesium_ion_token&&(Cesium.Ion.defaultAccessToken=i.geo_cesium_ion_token,p="Cesium World Terrain"),null===e&&(e=new Cesium.Viewer(t)),function(){null!==MagoConfig.getPolicy().geo_init_default_terrain&&""!==MagoConfig.getPolicy().geo_init_default_terrain&&(p=MagoConfig.getPolicy().geo_init_default_terrain);var t=null,i=e.baseLayerPicker.viewModel.imageryProviderViewModels;for(var o in i)if(i.hasOwnProperty(o)&&(a=i[o]).name===g){t=a;break}t&&(e.baseLayerPicker.viewModel.selectedImagery=t);var r=null,n=e.baseLayerPicker.viewModel.terrainProviderViewModels;for(var o in n){var a;if(n.hasOwnProperty(o)&&(a=n[o]).name===p){r=a;break}}r&&(e.baseLayerPicker.viewModel.selectedTerrain=r)}();e.scene.magoManager=new MagoManager,e.scene.magoManager.sceneState.textureFlipYAxis=!1,e.camera.frustum.fov=1.8*Cesium.Math.PI_OVER_THREE,MagoConfig.getPolicy().geo_init_default_fov>0&&(e.camera.frustum.fov=Cesium.Math.PI_OVER_THREE*MagoConfig.getPolicy().geo_init_default_fov),"true"===i.geo_server_enable&&null!==i.geo_server_add_url&&""!==i.geo_server_add_url&&(f=new Cesium.WebMapServiceImageryProvider({url:MagoConfig.getPolicy().geo_server_add_url,layers:MagoConfig.getPolicy().geo_server_add_layers,parameters:{service:MagoConfig.getPolicy().geo_server_add_parameters_service,version:MagoConfig.getPolicy().geo_server_add_parameters_version,request:MagoConfig.getPolicy().geo_server_add_parameters_request,transparent:MagoConfig.getPolicy().geo_server_add_parameters_transparent,format:MagoConfig.getPolicy().geo_server_add_parameters_format}}),e.imageryLayers.addImageryProvider(f)),d(),e.entities.add({name:"mago3D",position:Cesium.Cartesian3.fromDegrees(37.521168,126.924185,3e3),box:{dimensions:new Cesium.Cartesian3(3e8,3e8,3e8),fill:!0,material:Cesium.Color.BLUE,outline:!1}}),"true"===i.geo_init_camera_enable&&e.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(parseFloat(MagoConfig.getPolicy().geo_init_longitude),parseFloat(MagoConfig.getPolicy().geo_init_latitude),parseFloat(MagoConfig.getPolicy().geo_init_height)),duration:parseInt(MagoConfig.getPolicy().geo_init_duration)}),u=new API("renderMode"),s.callAPI(u),"false"===MagoConfig.getPolicy().geo_time_line_enable&&($(e._animation.container).css("visibility","hidden"),$(e._timeline.container).css("visibility","hidden"),e.forceResize())}else if(i.geo_view_library===Constant.WORLDWIND){WorldWind.Logger.setLoggingLevel(WorldWind.Logger.LEVEL_WARNING);var y,v=document.getElementById(t);if("true"===i.geo_server_enable&&null!==i.geo_server_url&&""!==i.geo_server_url){y=new WorldWind.WorldWindow(t,new WorldWind.ZeroElevationModel);var x=i.geo_server_url+"?SERVICE=WMS&REQUEST=GetCapabilities&VERSION=1.3.0";$.get(x).done(function(e){var t=new WorldWind.WmsCapabilities(e).getNamedLayer("mago3d"),i=WorldWind.WmsLayer.formLayerConfiguration(t);i.title="imageProvider";var o=new WorldWind.WmsLayer(i);y.addLayer(o)}).fail(function(e,t,i){})}else{y=new WorldWind.WorldWindow(t);for(var b=[{layer:new WorldWind.BMNGLayer,enabled:!0},{layer:new WorldWind.BMNGLandsatLayer,enabled:!1},{layer:new WorldWind.BingAerialWithLabelsLayer(null),enabled:!0},{layer:new WorldWind.OpenStreetMapImageLayer(null),enabled:!1},{layer:new WorldWind.CompassLayer,enabled:!1},{layer:new WorldWind.CoordinatesDisplayLayer(y),enabled:!0},{layer:new WorldWind.ViewControlsLayer(y),enabled:!0}],C=0;C<b.length;C++)b[C].layer.enabled=b[C].enabled,y.addLayer(b[C].layer)}(s=new MagoManager).wwd=y,s.sceneState.textureFlipYAxis=!0;var M=new WorldWind.RenderableLayer;M.displayName="F4D tiles",M.inCurrentFrame=!0,y.addLayer(M),M.addRenderable(s);var _=y.drawContext.currentGlContext;!function(e,t){if(e.shadersManager.createDefaultShader(t),e.postFxShadersManager.gl=t,e.postFxShadersManager.createDefaultShaders(t),e.createDefaultShaders(t),null!==o&&o.length>0)for(var i=0;i<o.length;i++)e.getObjectIndexFile(o[i],n[i])}(s,_);new WorldWind.ClickRecognizer(y,function(e){}).button=0;y.addEventListener("mousedown",function(e){0===e.button?s.mouseActionLeftDown(e.layerX,e.layerY):1===e.button?s.mouseActionMiddleDown(e.layerX,e.layerY):2===e.button&&s.mouseActionRightDown(e.layerX,e.layerY)},!1);y.addEventListener("mouseup",function(e){var t;0===e.button?s.mouseActionLeftUp(e.layerX,e.layerY):1===e.button?s.mouseActionMiddleUp(e.layerX,e.layerY):2===e.button&&s.mouseActionRightUp(e.layerX,e.layerY);var o={lat:null,lon:null,alt:null},r=y.canvasCoordinates(e.layerX,e.layerY);if(r[0]>=0&&r[0]<y.canvas.width&&r[1]>=0&&r[1]<y.canvas.height){var n=(t=y.pickTerrain(r).terrainObject())?t.position:null;null!==n&&(o.lat=n.latitude,o.lon=n.longitude,o.alt=n.altitude)}"true"===MagoConfig.getPolicy().geo_callback_enable&&""!==i.geo_callback_clickposition&&clickPositionCallback(i.geo_callback_clickposition,o)},!1);y.addEventListener("mousemove",function(e){s.mouse_x=e.layerX,s.mouse_y=e.layerY,s.mouseLeftDown?(s.manageMouseDragging(e.layerX,e.layerY),s.cameraMoved()):(s.mouseMiddleDown||s.mouseRightDown)&&s.cameraMoved()},!1),y.goToAnimator.travelTime=1e3*MagoConfig.getPolicy().geo_init_duration,y.goTo(new WorldWind.Position(MagoConfig.getPolicy().geo_init_latitude,MagoConfig.getPolicy().geo_init_longitude,MagoConfig.getPolicy().geo_init_height))}if(i.geo_view_library===Constant.MAGOWORLD){var A={antialias:!1,stencil:!0};(_=(v=document.getElementById(t)).getContext("webgl",A))||(_=v.getContext("experimental-webgl",A)),v.width=v.clientWidth,v.height=v.clientHeight;var R=(s=new MagoManager).sceneState;R.textureFlipYAxis=!0,R.gl=_,R.drawingBufferWidth[0]=v.clientWidth,R.drawingBufferHeight[0]=v.clientHeight,R.camera.frustum.aspectRatio=v.clientWidth/v.clientHeight,R.camera.frustum.fovRad[0]=Math.PI/3*1.8,R.camera.frustum.fovyRad[0]=R.camera.frustum.fovRad[0]/R.camera.frustum.aspectRatio,R.camera.frustum.tangentOfHalfFovy[0]=Math.tan(R.camera.frustum.fovyRad[0]/2),R.camera.position.set(0,0,1e7),R.camera.direction.set(0,0,-1),R.camera.up.set(0,1,0),R.encodedCamPosHigh[0]=0,R.encodedCamPosHigh[1]=0,R.encodedCamPosHigh[2]=1e7,R.encodedCamPosLow[0]=0,R.encodedCamPosLow[1]=0,R.encodedCamPosLow[2]=0,e=new MagoWorld(s),s.magoWorld=e,s.globe=new Globe,e.updateModelViewMatrixByCamera(R.camera),v.addEventListener("mousedown",function(t){e.mousedown(t)},!1),v.addEventListener("mouseup",function(t){e.mouseup(t)},!1),v.addEventListener("mousewheel",function(t){e.mousewheel(t)},!1),v.addEventListener("mousemove",function(t){e.mousemove(t)},!1),v.addEventListener("resize",function(e){},!1),v.addEventListener("keydown",function(t){e.keydown(t)},!1),d()}return s.magoPolicy.imagePath=a,c=CODE.magoManagerState.READY,document.addEventListener("keydown",function(e){if(!s.magoPolicy.issueInsertEnable&&void 0!==s.buildingSelected){var t=s.selectionCandidates.currentNodeSelected;if(void 0!==t){var i=t.getRoot().data.geoLocDataManager.getCurrentGeoLocationData();if(void 0!==i){var o=i.heading||0,r=i.pitch||0,n=i.roll||0,a=i.geographicCoord.altitude||0,l=!1;e.keyCode==="Q".charCodeAt(0)?(o+=3,l=!0):e.keyCode==="A".charCodeAt(0)&&(o-=3,l=!0),e.keyCode==="W".charCodeAt(0)?(r+=3,l=!0):e.keyCode==="S".charCodeAt(0)&&(r-=3,l=!0),e.keyCode==="E".charCodeAt(0)?(n+=3,l=!0):e.keyCode==="D".charCodeAt(0)&&(n-=3,l=!0),e.keyCode==="Z".charCodeAt(0)?(a+=.2,l=!0):e.keyCode==="X".charCodeAt(0)&&(a-=.2,l=!0),l&&s.changeLocationAndRotationNode(t,i.geographicCoord.latitude,i.geographicCoord.longitude,a,o,r,n)}}}},!1),{callAPI:function(e){if(e.getReturnable())return s.callAPI(e);s.callAPI(e)},getViewer:function(){return e},getMagoManagerState:function(){return c}}},Matrix4=function(){if(!(this instanceof Matrix4))throw new Error(Messages.CONSTRUCT_ERROR);this._floatArrays=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]};Matrix4.prototype.Identity=function(){this._floatArrays=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},Matrix4.prototype.deleteObjects=function(){this._floatArrays=void 0},Matrix4.prototype.getRowMajorMatrix=function(){var e=new Float32Array(16);return e[0]=this.get(0,0),e[1]=this.get(1,0),e[2]=this.get(2,0),e[3]=this.get(3,0),e[4]=this.get(0,1),e[5]=this.get(1,1),e[6]=this.get(2,1),e[7]=this.get(3,1),e[8]=this.get(0,2),e[9]=this.get(1,2),e[10]=this.get(2,2),e[11]=this.get(3,2),e[12]=this.get(0,3),e[13]=this.get(1,3),e[14]=this.get(2,3),e[15]=this.get(3,3),e},Matrix4.getRotationDegZXYMatrix=function(e,t,i,o){var r,n,a,s=new Matrix4,l=new Matrix4,c=new Matrix4;return void 0!==e&&0!==e&&c.rotationAxisAngDeg(e,0,0,1),void 0!==t&&0!==t&&s.rotationAxisAngDeg(t,1,0,0),void 0!==i&&0!==i&&l.rotationAxisAngDeg(i,0,1,0),void 0===o&&(o=new Matrix4),r=c,n=s.getMultipliedByMatrix(r,n),o=a=l.getMultipliedByMatrix(n,a)},Matrix4.prototype.rotationAxisAngDeg=function(e,t,i,o){var r=new Quaternion;r.rotationAngDeg(e,t,i,o),this.rotationByQuaternion(r),r=void 0},Matrix4.prototype.rotationAxisAngRad=function(e,t,i,o){var r=new Quaternion;r.rotationAngRad(e,t,i,o),this.rotationByQuaternion(r),r=void 0},Matrix4.prototype.rotationByQuaternion=function(e){var t=e.w,i=e.x,o=e.y,r=e.z;this._floatArrays[this.getIndexOfArray(0,0)]=1-2*o*o-2*r*r,this._floatArrays[this.getIndexOfArray(0,1)]=2*i*o+2*r*t,this._floatArrays[this.getIndexOfArray(0,2)]=2*i*r-2*o*t,this._floatArrays[this.getIndexOfArray(0,3)]=0,this._floatArrays[this.getIndexOfArray(1,0)]=2*i*o-2*r*t,this._floatArrays[this.getIndexOfArray(1,1)]=1-2*i*i-2*r*r,this._floatArrays[this.getIndexOfArray(1,2)]=2*o*r+2*i*t,this._floatArrays[this.getIndexOfArray(1,3)]=0,this._floatArrays[this.getIndexOfArray(2,0)]=2*i*r+2*o*t,this._floatArrays[this.getIndexOfArray(2,1)]=2*o*r-2*i*t,this._floatArrays[this.getIndexOfArray(2,2)]=1-2*i*i-2*o*o,this._floatArrays[this.getIndexOfArray(2,3)]=0,this._floatArrays[this.getIndexOfArray(3,0)]=0,this._floatArrays[this.getIndexOfArray(3,1)]=0,this._floatArrays[this.getIndexOfArray(3,2)]=0,this._floatArrays[this.getIndexOfArray(3,3)]=1},Matrix4.prototype.setByFloat32Array=function(e){for(var t=0;t<16;t++)this._floatArrays[t]=e[t]},Matrix4.prototype.getIndexOfArray=function(e,t){return 4*e+t},Matrix4.prototype.get=function(e,t){return null===this._floatArrays?null:this._floatArrays[this.getIndexOfArray(e,t)]},Matrix4.prototype.set=function(e,t,i){this._floatArrays[this.getIndexOfArray(e,t)]=i},Matrix4.prototype.transformPoint3D=function(e,t){void 0===t&&(t=new Point3D);var i=e.x,o=e.y,r=e.z;return t.x=i*this.get(0,0)+o*this.get(1,0)+r*this.get(2,0)+this.get(3,0),t.y=i*this.get(0,1)+o*this.get(1,1)+r*this.get(2,1)+this.get(3,1),t.z=i*this.get(0,2)+o*this.get(1,2)+r*this.get(2,2)+this.get(3,2),t},Matrix4.prototype.rotatePoint3D=function(e,t){void 0===t&&(t=new Point3D);var i=e.x,o=e.y,r=e.z;return t.x=i*this.get(0,0)+o*this.get(1,0)+r*this.get(2,0),t.y=i*this.get(0,1)+o*this.get(1,1)+r*this.get(2,1),t.z=i*this.get(0,2)+o*this.get(1,2)+r*this.get(2,2),t},Matrix4.prototype.getMultipliedByMatrix=function(e,t){void 0===t&&(t=new Matrix4);for(var i=0;i<4;i++)for(var o=0;o<4;o++){var r=this.getIndexOfArray(i,o);t._floatArrays[r]=0;for(var n=0;n<4;n++)t._floatArrays[r]+=e.get(n,o)*this.get(i,n)}return t},Matrix4.prototype.setToPerspectiveProjection=function(e,t,i,o){var r=1/Math.tan(e/2),n=r/t,a=i-o;this.setByFloat32Array([n,0,0,0,0,r,0,0,0,0,(o+i)/a,-1,0,0,2*o*i/a,0])},Matrix4.prototype.copyFromMatrix4=function(e){for(var t=0;t<16;t++)this._floatArrays[t]=e._floatArrays[t]},Matrix4.prototype.copyFromFloatArray=function(e){for(var t=0;t<16;t++)this._floatArrays[t]=e[t]},Matrix4.prototype.computeMatrixType=function(){return this.isRotationIdentity()?this.aproxEqual(this._floatArrays[3],0,1e-7)&&this.aproxEqual(this._floatArrays[7],0,1e-7)&&this.aproxEqual(this._floatArrays[11],0,1e-7)&&this.aproxEqual(this._floatArrays[12],0,1e-7)&&this.aproxEqual(this._floatArrays[13],0,1e-7)&&this.aproxEqual(this._floatArrays[14],0,1e-7)&&this.aproxEqual(this._floatArrays[15],1,1e-7)?0:1:2},Matrix4.prototype.aproxEqual=function(e,t,i){return void 0===i&&(i=1e-7),e===t||e>t-i&&e<t+i},Matrix4.areEqualArrays=function(e,t){for(var i=!0,o=0;i&&o<16;)e[o]!==t[o]&&(i=!1),o++;return i},Matrix4.prototype.isIdentity=function(e){return!!this.isRotationIdentity()&&(!!this.aproxEqual(this._floatArrays[3],0,e)&&(!!this.aproxEqual(this._floatArrays[7],0,e)&&(!!this.aproxEqual(this._floatArrays[11],0,e)&&(!!this.aproxEqual(this._floatArrays[12],0,e)&&(!!this.aproxEqual(this._floatArrays[13],0,e)&&(!!this.aproxEqual(this._floatArrays[14],0,e)&&!!this.aproxEqual(this._floatArrays[15],1,e)))))))},Matrix4.prototype.isRotationIdentity=function(e){return!!this.aproxEqual(this._floatArrays[0],1,e)&&(!!this.aproxEqual(this._floatArrays[1],0,e)&&(!!this.aproxEqual(this._floatArrays[2],0,e)&&(!!this.aproxEqual(this._floatArrays[4],0,e)&&(!!this.aproxEqual(this._floatArrays[5],1,e)&&(!!this.aproxEqual(this._floatArrays[6],0,e)&&(!!this.aproxEqual(this._floatArrays[8],0,e)&&(!!this.aproxEqual(this._floatArrays[9],0,e)&&!!this.aproxEqual(this._floatArrays[10],1,e))))))))};var Messages={CONSTRUCT_ERROR:"  new   ."},MouseAction=function(){if(!(this instanceof MouseAction))throw new Error(Messages.CONSTRUCT_ERROR);this.curX,this.curY,this.curCamCoordPoint,this.curWorldPoint,this.curWorldPoint2,this.curModelViewMatrix=new Matrix4,this.curModelViewMatrixInv=new Matrix4,this.strX,this.strY,this.strCamCoordPoint,this.strWorldPoint,this.curCamera=new Camera,this.curCameraTarget=new Float32Array([0,0,0]),this.camRotPoint=new Point3D,this.camRotAxis=new Point3D};MouseAction.prototype.saveCurrentToStart=function(){this.strX=this.curX,this.strY=this.curY,void 0===this.strWorldPoint&&(this.strWorldPoint=new Point3D),this.curWorldPoint&&this.strWorldPoint.copyFrom(this.curWorldPoint),void 0===this.strCamCoordPoint&&(this.strCamCoordPoint=new Point3D),this.curCamCoordPoint&&this.strCamCoordPoint.copyFrom(this.curCamCoordPoint)};var ObjectMarker=function(){if(!(this instanceof ObjectMarker))throw new Error(Messages.CONSTRUCT_ERROR);this.geoLocationData=new GeoLocationData,this.issue_id=null,this.issue_type=null};ObjectMarker.prototype.copyFrom=function(e){void 0!==e&&(e.geoLocationData&&this.geoLocationData.copyFrom(e.geoLocationData),this.issue_id=e.issue_id,this.issue_type=e.issue_type)};var ObjectMarkerManager=function(){if(!(this instanceof ObjectMarkerManager))throw new Error(Messages.CONSTRUCT_ERROR);this.objectMarkerArray=[]};ObjectMarkerManager.prototype.newObjectMarker=function(){var e=new ObjectMarker;return this.objectMarkerArray.push(e),e};var OcclusionCullingOctreeCell=function(e){if(!(this instanceof OcclusionCullingOctreeCell))throw new Error(Messages.CONSTRUCT_ERROR);this._ocCulling_Cell_owner=e,this.minX=0,this.maxX=0,this.minY=0,this.maxY=0,this.minZ=0,this.maxZ=0,this._indicesArray=[],this._subBoxesArray=[],this.modelReferencedGroupsList};OcclusionCullingOctreeCell.prototype.createModelReferencedGroups=function(e){var t=this._subBoxesArray.length;if(0===t){if(0===this._indicesArray.length)return;void 0===this.modelReferencedGroupsList&&(this.modelReferencedGroupsList=new ModelReferencedGroupsList),this.modelReferencedGroupsList.createModelReferencedGroups(this._indicesArray,e)}else for(var i=0;i<t;i++)this._subBoxesArray[i].createModelReferencedGroups(e)},OcclusionCullingOctreeCell.prototype.newSubBox=function(){var e=new OcclusionCullingOctreeCell(this);return this._subBoxesArray.push(e),e},OcclusionCullingOctreeCell.prototype.create8SubBoxes=function(){this._subBoxesArray.length=0;for(var e=0;e<8;e++)this.newSubBox()},OcclusionCullingOctreeCell.prototype.setDimensions=function(e,t,i,o,r,n){this.minX=e,this.maxX=t,this.minY=i,this.maxY=o,this.minZ=r,this.maxZ=n},OcclusionCullingOctreeCell.prototype.setSizesSubBoxes=function(){if(this._subBoxesArray.length>0){var e=(this.maxX+this.minX)/2,t=(this.maxY+this.minY)/2,i=(this.maxZ+this.minZ)/2;this._subBoxesArray[0].setDimensions(this.minX,e,this.minY,t,this.minZ,i),this._subBoxesArray[1].setDimensions(e,this.maxX,this.minY,t,this.minZ,i),this._subBoxesArray[2].setDimensions(e,this.maxX,t,this.maxY,this.minZ,i),this._subBoxesArray[3].setDimensions(this.minX,e,t,this.maxY,this.minZ,i),this._subBoxesArray[4].setDimensions(this.minX,e,this.minY,t,i,this.maxZ),this._subBoxesArray[5].setDimensions(e,this.maxX,this.minY,t,i,this.maxZ),this._subBoxesArray[6].setDimensions(e,this.maxX,t,this.maxY,i,this.maxZ),this._subBoxesArray[7].setDimensions(this.minX,e,t,this.maxY,i,this.maxZ);for(var o=0;o<this._subBoxesArray.length;o++)this._subBoxesArray[o].setSizesSubBoxes()}},OcclusionCullingOctreeCell.prototype.intersectsWithPoint3D=function(e,t,i){var o=!1;return e>this.minX&&e<this.maxX&&t>this.minY&&t<this.maxY&&i>this.minZ&&i<this.maxZ&&(o=!0),o},OcclusionCullingOctreeCell.prototype.getIntersectedSubBoxByPoint3D=function(e,t,i){if(void 0!==this._ocCulling_Cell_owner||this.intersectsWithPoint3D(e,t,i)){var o=void 0;if(this._subBoxesArray.length>0){var r,n=(this.minX+this.maxX)/2,a=(this.minY+this.maxY)/2,s=(this.minZ+this.maxZ)/2;r=e<n?t<a?i<s?0:4:i<s?3:7:t<a?i<s?1:5:i<s?2:6,o=this._subBoxesArray[r].getIntersectedSubBoxByPoint3D(e,t,i)}else o=this;return o}},OcclusionCullingOctreeCell.prototype.getIndicesVisiblesForEye=function(e,t,i,o,r){var n=this.getIntersectedSubBoxByPoint3D(e,t,i);return void 0!==n&&n._indicesArray.length>0&&(o=n._indicesArray,r&&(r=this.modelReferencedGroupsList)),o},OcclusionCullingOctreeCell.prototype.expandBox=function(e){this.minX-=e,this.maxX+=e,this.minY-=e,this.maxY+=e,this.minZ-=e,this.maxZ+=e},OcclusionCullingOctreeCell.prototype.parseArrayBuffer=function(e,t,i){var o=i.readInt8(e,t,t+1);if(t+=1,o){var r=i.readFloat32(e,t,t+4);t+=4;var n=i.readFloat32(e,t,t+4);t+=4;var a=i.readFloat32(e,t,t+4);t+=4;var s=i.readFloat32(e,t,t+4);t+=4;var l=i.readFloat32(e,t,t+4);t+=4;var c=i.readFloat32(e,t,t+4);t+=4,this.setDimensions(r,n,a,s,l,c)}var h=i.readUInt32(e,t,t+4);if(t+=4,0===h){var d=i.readUInt32(e,t,t+4);t+=4;for(var u=0;u<d;u++){var f=i.readUInt32(e,t,t+4);if(t+=4,f<0);this._indicesArray.push(f)}}else for(u=0;u<h;u++){t=this.newSubBox().parseArrayBuffer(e,t,i)}return t};var OcclusionCullingOctree=function(){if(!(this instanceof OcclusionCullingOctree))throw new Error(Messages.CONSTRUCT_ERROR);this._ocCulling_box=new OcclusionCullingOctreeCell(null),this._infinite_ocCulling_box=new OcclusionCullingOctreeCell(null)},Pin=function(){if(!(this instanceof Pin))throw new Error(Messages.CONSTRUCT_ERROR);this.texture,this.texturesArray=[],this.positionBuffer,this.texcoordBuffer};Pin.prototype.createPin=function(e){this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer);e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,0,0,0,1,0,0,1,0,1,0,0,1,1,0]),e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer);e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW)},Pin.prototype.createPinCenterBottom=function(e){this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer);e.bufferData(e.ARRAY_BUFFER,new Float32Array([-.5,0,0,.5,0,0,-.5,1,0,-.5,1,0,.5,0,0,.5,1,0]),e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer);e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW)};var Plane=function(){if(!(this instanceof Plane))throw new Error(Messages.CONSTRUCT_ERROR);this.a=0,this.b=0,this.c=0,this.d=0};Plane.prototype.setPointAndNormal=function(e,t,i,o,r,n){this.a=o,this.b=r,this.c=n,this.d=-this.a*e-this.b*t-this.c*i},Plane.prototype.setPoint=function(e,t,i){this.d=-this.a*e-this.b*t-this.c*i},Plane.prototype.setNormalAndDistance=function(e,t,i,o){this.a=e,this.b=t,this.c=i,this.d=o},Plane.prototype.intersectionLine=function(e,t){var i=e.point.x,o=e.point.y,r=e.point.z,n=e.direction.x,a=e.direction.y,s=e.direction.z,l=this.a*n+this.b*a+this.c*s;if(Math.abs(l)>1e-7){var c=-(this.a*i+this.b*o+this.c*r+this.d)/l;return void 0===t&&(t=new Point3D),t.set(i+c*n,o+c*a,r+c*s),t}},Plane.prototype.intersectionSphere=function(e){if(void 0===e||void 0===e.centerPoint)return Constant.INTERSECTION_OUTSIDE;var t=e.centerPoint,i=t.x*this.a+t.y*this.b+t.z*this.c+this.d;return i<-e.r?Constant.INTERSECTION_OUTSIDE:i<e.r?Constant.INTERSECTION_INTERSECT:Constant.INTERSECTION_INSIDE};var Quaternion=function(){if(!(this instanceof Quaternion))throw new Error(Messages.CONSTRUCT_ERROR);this.x=0,this.y=0,this.z=0,this.w=1};Quaternion.prototype.Modul=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},Quaternion.prototype.Unitary=function(){var e=this.Modul();this.x/=e,this.y/=e,this.z/=e,this.w/=e},Quaternion.prototype.rotationAngDeg=function(e,t,i,o){var r=e*Math.PI/180;this.rotationAngRad(r,t,i,o)},Quaternion.prototype.rotationAngRad=function(e,t,i,o){var r=Math.sqrt(t*t+i*i+o*o);if(!r<1e-12){var n=1/r,a=.5*e;r=Math.sin(a),this.x=t*n*r,this.y=i*n*r,this.z=o*n*r,this.w=Math.cos(a),this.Unitary()}else this.x=0,this.y=0,this.z=0,this.w=1};var SmartTile=function(e){if(!(this instanceof SmartTile))throw new Error(Messages.CONSTRUCT_ERROR);this.name,e&&(this.name=e),this.depth,this.minGeographicCoord,this.maxGeographicCoord,this.sphereExtent,this.subTiles,this.nodeSeedsArray,this.nodesArray,this.isVisible};SmartTile.prototype.deleteObjects=function(){if(this.name=void 0,this.depth=void 0,this.minGeographicCoord&&this.minGeographicCoord.deleteObjects(),this.maxGeographicCoord&&this.maxGeographicCoord.deleteObjects(),this.minGeographicCoord=void 0,this.maxGeographicCoord=void 0,this.sphereExtent&&this.sphereExtent.deleteObjects(),this.sphereExtent=void 0,this.nodeSeedsArray){for(var e=this.nodeSeedsArray.length,t=0;t<e;t++)this.nodeSeedsArray[t]=void 0;this.nodeSeedsArray=void 0}if(this.nodesArray){var i=this.nodesArray.length;for(t=0;t<i;t++)this.nodesArray[t]=void 0;this.nodesArray=void 0}if(this.isVisible=void 0,this.subTiles){var o=this.subTiles.length;for(t=0;t<o;t++)this.subTiles[t].deleteObjects(),this.subTiles[t]=void 0;this.subTiles=void 0}},SmartTile.prototype.newSubTile=function(e){void 0===this.subTiles&&(this.subTiles=[]);var t=new SmartTile;return t.depth=e.depth+1,this.subTiles.push(t),t},SmartTile.prototype.clearNodesArray=function(){if(void 0!==this.nodesArray){for(var e=0;e<this.nodesArray.length;e++)this.nodesArray[e]=void 0;this.nodesArray=void 0}},SmartTile.prototype.getNeoBuildingById=function(e,t){var i,o=this.getNodeByBuildingId(e,t);return void 0!==o&&(i=o.data.neoBuilding),i},SmartTile.prototype.getBuildingSeedById=function(e,t){var i,o=!0;if(void 0===this.subTiles&&(o=!1),this.subTiles&&0===this.subTiles.length&&(o=!1),o){for(s=0;s<this.subTiles.length;s++)if(i=this.subTiles[s].getBuildingSeedById(e,t))return i}else if(this.nodeSeedsArray)for(var r,n=this.nodeSeedsArray.length,a=!1,s=0;!a&&s<n;){if(r=this.nodeSeedsArray[s].data.buildingSeed,e){if(r.buildingId===t&&r.buildingType===e)return a=!0,i=r}else if(r.buildingId===t)return a=!0,i=r;s++}return i},SmartTile.prototype.TEST__hasLowestTiles_nodesArray=function(){var e=[];this.extractLowestTiles(e);for(var t=e.length,i=0;i<t;){if(e[i].nodesArray&&e[i].nodesArray.length>0)return!0;i++}return!1},SmartTile.prototype.makeSphereExtent=function(e){this.sphereExtent=SmartTile.computeSphereExtent(e,this.minGeographicCoord,this.maxGeographicCoord,this.sphereExtent)},SmartTile.computeSphereExtent=function(e,t,i,o){void 0===o&&(o=new Sphere);var r,n=(i.longitude+t.longitude)/2,a=(i.latitude+t.latitude)/2,s=(i.altitude+t.altitude)/2;return o.centerPoint=ManagerUtils.geographicCoordToWorldPoint(n,a,s,o.centerPoint,e),r=ManagerUtils.geographicCoordToWorldPoint(t.longitude,t.latitude,t.altitude,r,e),o.r=1.2*o.centerPoint.distTo(r.x,r.y,r.z),o},SmartTile.prototype.makeTreeByDepth=function(e,t){if(void 0!==this.nodeSeedsArray&&0!==this.nodeSeedsArray.length&&(this.makeSphereExtent(t),this.depth<e)){if(void 0===this.subTiles||0===this.subTiles.length)for(var i=0;i<4;i++)this.newSubTile(this);this.setSizesToSubTiles();for(i=0;i<4;i++)this.subTiles[i].takeIntersectedBuildingSeeds(this.nodeSeedsArray,t);for(i=0;i<4;i++)this.subTiles[i].makeTreeByDepth(e,t)}},SmartTile.prototype.takeIntersectedBuildingSeeds=function(e){for(var t,i,o,r=e.length,n=0;n<r;n++){var a,s;if(t=(i=e[n]).data.buildingSeed,void 0===(o=i.getRoot()).data.bbox.geographicCoord?(a=t.geographicCoordOfBBox.longitude,s=t.geographicCoordOfBBox.latitude):(a=o.data.bbox.geographicCoord.longitude,s=o.data.bbox.geographicCoord.latitude),this.intersectPoint(a,s)){e.splice(n,1),n--,r=e.length,void 0===this.nodeSeedsArray&&(this.nodeSeedsArray=[]),this.nodeSeedsArray.push(i);var l=t.geographicCoordOfBBox.altitude,c=t.bBox.getRadiusAprox();l-c<this.minGeographicCoord.altitude&&(this.minGeographicCoord.altitude=l-c),l+c>this.maxGeographicCoord.altitude&&(this.maxGeographicCoord.altitude=l+c)}}},SmartTile.prototype.intersectPoint=function(e,t){return!(e<this.minGeographicCoord.longitude||e>this.maxGeographicCoord.longitude)&&!(t<this.minGeographicCoord.latitude||t>this.maxGeographicCoord.latitude)},SmartTile.prototype.extractLowestTiles=function(e){if(void 0!==this.subTiles)for(var t=this.subTiles.length,i=0;i<t;i++)this.subTiles[i].extractLowestTiles(e);else this.nodeSeedsArray&&this.nodeSeedsArray.length>0&&e.push(this)},SmartTile.prototype.getFrustumIntersectedLowestTiles=function(e,t,i){var o=[];this.getFrustumIntersectedTiles(e,o,i);for(var r=o.length,n=0;n<r;n++)o[n].extractLowestTiles(t)},SmartTile.prototype.getFrustumIntersectedTiles=function(e,t,i){if(void 0===this.sphereExtent)return Constant.INTERSECTION_OUTSIDE;var o=e.intersectionSphere(this.sphereExtent);if(o!==Constant.INTERSECTION_OUTSIDE)if(o!==Constant.INTERSECTION_INSIDE){if(o===Constant.INTERSECTION_INTERSECT)if(this.subTiles&&this.subTiles.length>0)for(var r=0;r<this.subTiles.length;r++)this.subTiles[r].sphereExtent&&this.subTiles[r].getFrustumIntersectedTiles(e,t,i);else this.nodeSeedsArray&&this.nodeSeedsArray.length>0&&i.push(this)}else t.push(this)},SmartTile.selectTileAngleRangeByDepth=function(e){if(!(void 0===e||e<0||e>15))return 0===e?180:1===e?90:2===e?45:3===e?22.5:4===e?11.25:5===e?5.625:6===e?2.8125:7===e?1.40625:8===e?.703125:9===e?.3515625:10===e?.17578125:11===e?.087890625:12===e?.043945313:13===e?.021972656:14===e?.010986328:15===e?.005493164:void 0},SmartTile.selectTileName=function(e,t,i,o){var r=SmartTile.selectTileAngleRangeByDepth(e),n=Math.floor((t- -180)/r),a=Math.floor((90-i)/r);return e.toString()+"\\"+n.toString()+"\\"+a.toString()},SmartTile.getFrustumIntersectedTilesNames=function(e,t,i,o,r){var n=new GeographicCoord,a=new GeographicCoord,s=0;n.setLonLatAlt(-180,-90,0),a.setLonLatAlt(0,90,0),s=0,SmartTile.getFrustumIntersectedTilesNamesForGeographicExtent(e,t,s,i,n,a,o,o.boundingSphere_Aux,r),n.setLonLatAlt(0,-90,0),a.setLonLatAlt(180,90,0),s=0,SmartTile.getFrustumIntersectedTilesNamesForGeographicExtent(e,t,s,i,n,a,o,o.boundingSphere_Aux,r)},SmartTile.getFrustumIntersectedTilesNamesForGeographicExtent=function(e,t,i,o,r,n,a,s,l){s=SmartTile.computeSphereExtent(a,r,n,s);var c=e.intersectionSphere(s);if(c!==Constant.INTERSECTION_OUTSIDE){if(c===Constant.INTERSECTION_INSIDE){var h=(r.longitude+n.longitude)/2,d=(r.latitude+n.latitude)/2,u=SmartTile.selectTileName(i,h,d,void 0);return(f=new GeographicExtent).minGeographicCoord=new GeographicCoord(r.longitude,r.latitude,r.altitude),f.maxGeographicCoord=new GeographicCoord(n.longitude,n.latitude,n.altitude),void(l[u]=f)}if(c===Constant.INTERSECTION_INTERSECT){if(o.distToSphere(s)>2e3){h=(r.longitude+n.longitude)/2,d=(r.latitude+n.latitude)/2,u=SmartTile.selectTileName(i,h,d,void 0);return(f=new GeographicExtent).minGeographicCoord=new GeographicCoord(r.longitude,r.latitude,r.altitude),f.maxGeographicCoord=new GeographicCoord(n.longitude,n.latitude,n.altitude),void(l[u]=f)}if(!(i<t)){var f;h=(r.longitude+n.longitude)/2,d=(r.latitude+n.latitude)/2,u=SmartTile.selectTileName(i,h,d,void 0);return(f=new GeographicExtent).minGeographicCoord=new GeographicCoord(r.longitude,r.latitude,r.altitude),f.maxGeographicCoord=new GeographicCoord(n.longitude,n.latitude,n.altitude),void(l[u]=f)}i+=1;var g=r.longitude,p=r.latitude,m=r.altitude,y=n.longitude,v=n.latitude,x=n.altitude,h=(g+y)/2,d=(p+v)/2;n.setLonLatAlt(h,d,x),this.getFrustumIntersectedTilesNamesForGeographicExtent(e,t,i,o,r,n,a,s,l),r.setLonLatAlt(h,p,m),n.setLonLatAlt(y,d,x),this.getFrustumIntersectedTilesNamesForGeographicExtent(e,t,i,o,r,n,a,s,l),r.setLonLatAlt(h,d,m),n.setLonLatAlt(y,v,x),this.getFrustumIntersectedTilesNamesForGeographicExtent(e,t,i,o,r,n,a,s,l),r.setLonLatAlt(g,d,m),n.setLonLatAlt(h,v,x),this.getFrustumIntersectedTilesNamesForGeographicExtent(e,t,i,o,r,n,a,s,l)}}},SmartTile.prototype.getSphereExtent=function(){return this.sphereExtent},SmartTile.prototype.setSize=function(e,t,i,o,r,n){void 0===this.minGeographicCoord&&(this.minGeographicCoord=new GeographicCoord),void 0===this.maxGeographicCoord&&(this.maxGeographicCoord=new GeographicCoord),this.minGeographicCoord.setLonLatAlt(e,t,i),this.maxGeographicCoord.setLonLatAlt(o,r,n)},SmartTile.prototype.setSizesToSubTiles=function(){var e=this.minGeographicCoord.longitude,t=this.maxGeographicCoord.longitude,i=this.minGeographicCoord.latitude,o=this.maxGeographicCoord.latitude,r=this.minGeographicCoord.altitude,n=this.maxGeographicCoord.altitude,a=(t+e)/2,s=(o+i)/2,l=this.subTiles[0];l.setSize(e,i,r,a,s,n),(l=this.subTiles[1]).setSize(a,i,r,t,s,n),(l=this.subTiles[2]).setSize(a,s,r,t,o,n),(l=this.subTiles[3]).setSize(e,s,r,a,o,n)},SmartTile.prototype.getLongitudeRangeDegree=function(){return this.maxGeographicCoord.longitude-this.minGeographicCoord.longitude},SmartTile.prototype.getLatitudeRangeDegree=function(){return this.maxGeographicCoord.latitude-this.minGeographicCoord.latitude};var SmartTileManager=function(){if(!(this instanceof SmartTileManager))throw new Error(Messages.CONSTRUCT_ERROR);this.tilesArray=[],this.createMainTiles()};SmartTileManager.prototype.createMainTiles=function(){var e=this.newSmartTile("AmericaSide");void 0===e.minGeographicCoord&&(e.minGeographicCoord=new GeographicCoord),void 0===e.maxGeographicCoord&&(e.maxGeographicCoord=new GeographicCoord),e.depth=0,e.minGeographicCoord.setLonLatAlt(-180,-90,0),e.maxGeographicCoord.setLonLatAlt(0,90,0);var t=this.newSmartTile("AsiaSide");void 0===t.minGeographicCoord&&(t.minGeographicCoord=new GeographicCoord),void 0===t.maxGeographicCoord&&(t.maxGeographicCoord=new GeographicCoord),t.depth=0,t.minGeographicCoord.setLonLatAlt(0,-90,0),t.maxGeographicCoord.setLonLatAlt(180,90,0)},SmartTileManager.prototype.deleteTiles=function(){if(this.tilesArray){for(var e=this.tilesArray.length,t=0;t<e;t++)this.tilesArray[t].deleteObjects(),this.tilesArray[t]=void 0;this.tilesArray.length=0}},SmartTileManager.prototype.resetTiles=function(){this.deleteTiles(),this.createMainTiles()},SmartTileManager.prototype.newSmartTile=function(e){void 0===this.tilesArray&&(this.tilesArray=[]);var t=new SmartTile(e);return this.tilesArray.push(t),t},SmartTileManager.prototype.getNeoBuildingById=function(e,t){for(var i,o=0,r=this.tilesArray.length;void 0===i&&o<r;)i=this.tilesArray[o].getNeoBuildingById(e,t),o++;return i},SmartTileManager.prototype.getBuildingSeedById=function(e,t){for(var i,o=0,r=this.tilesArray.length;void 0===i&&o<r;)i=this.tilesArray[o].getBuildingSeedById(e,t),o++;return i};var Sphere=function(){if(!(this instanceof Sphere))throw new Error(Messages.CONSTRUCT_ERROR);this.r=0,this.centerPoint=new Point3D,this.vboKeyContainer};Sphere.prototype.setCenterPoint=function(e,t,i){this.centerPoint.set(e,t,i)},Sphere.prototype.setRadius=function(e){this.r=e},Sphere.prototype.deleteObjects=function(){this.r=void 0,this.centerPoint.deleteObjects(),this.centerPoint=void 0},Sphere.prototype.getVbo=function(e){var t;void 0===e&&(e=new VBOVertexIdxCacheKeysContainer);var i=(t=this.makeMesh(t)).getSurfaceIndependentMesh(void 0,!1,!1),o=new Matrix4;return o.rotationAxisAngDeg(90,1,0,0),i.transformByMatrix4(o),i.setColor(0,.5,.9,.3),i.calculateVerticesNormals(),i.getVbo(e),e},Sphere.prototype.makeMesh=function(e){void 0===e&&(e=new ParametricMesh),e.profile=new Profile;var t,i,o=e.profile,r=o.newOuterRing();(t=r.newElement("POLYLINE")).newPoint2d(.01*-this.r,-this.r),t.newPoint2d(.01*-this.r,this.r);var n;i=r.newElement("ARC"),this.sweepSense=1,i.setCenterPosition(0,0),i.setRadius(this.r),i.setStartAngleDegree(95),i.setSweepAngleDegree(170),i.numPointsFor360Deg=48,n=new Segment2D;var a=new Point2D(0,-1),s=new Point2D(0,1);return n.setPoints(a,s),48,e.revolve(o,360,48,n),e};var SplitValue=function(){this.high=void 0,this.low=void 0},TerranTile=function(){if(!(this instanceof TerranTile))throw new Error(Messages.CONSTRUCT_ERROR);this._depth=0,this._numberName=1,this._terranTile_owner,this.projectsArray=[],this._BR_buildingsArray=[],this._boundingBox,this._pCloudMesh_array=[],this.position,this.radius,this.leftDown_position,this.rightDown_position,this.rightUp_position,this.leftUp_position,this.visibilityType,this.subTiles_array=[],this.terranIndexFile_readed=!1,this.empty_tile=!1,this.fileReading_started=!1,this.fileReading_finished=!1,this.fileArrayBuffer,this.fileBytesReaded=0,this.fileParsingFinished=!1,this.projectsParsed_count=0,this.current_BRProject_parsing,this.current_BRProject_parsing_state=0,this.readWriter};TerranTile.prototype.newBRProject=function(){var e=new BRBuildingProject;return this._BR_buildingsArray.push(e),e},TerranTile.prototype.newSubTerranTile=function(){var e=this.subTiles_array.length,t=new TerranTile;return t._depth=this._depth+1,t._numberName=10*this._numberName+e+1,this.subTiles_array.push(t),t},TerranTile.prototype.make4subTiles=function(){for(var e=0;e<4;e++)this.newSubTerranTile()},TerranTile.prototype.setDimensions=function(e,t,i,o){this.longitudeMin=e,this.longitudeMax=t,this.latitudeMin=i,this.latitudeMax=o},TerranTile.prototype.makeTree=function(e){if(this._depth<e)for(var t=0;t<4;t++)this.newSubTerranTile().makeTree(e)},TerranTile.prototype.calculatePositionByLonLat=function(){var e=(this.longitudeMax+this.longitudeMin)/2,t=(this.latitudeMax+this.latitudeMin)/2;this.position=Cesium.Cartesian3.fromDegrees(e,t,0),this.leftDown_position=Cesium.Cartesian3.fromDegrees(this.longitudeMin,this.latitudeMin,0),this.rightDown_position=Cesium.Cartesian3.fromDegrees(this.longitudeMax,this.latitudeMin,0),this.rightUp_position=Cesium.Cartesian3.fromDegrees(this.longitudeMax,this.latitudeMax,0),this.leftUp_position=Cesium.Cartesian3.fromDegrees(this.longitudeMin,this.latitudeMax,0),this.radius=Cesium.Cartesian3.distance(this.leftDown_position,this.rightUp_position)/2*.9},TerranTile.prototype.calculatePositionByLonLatSubTiles=function(){this.calculatePositionByLonLat();for(var e=this.subTiles_array.length,t=0;t<e;t++)this.subTiles_array[t].calculatePositionByLonLatSubTiles()},TerranTile.prototype.parseFileHeader=function(e){var t=this.fileArrayBuffer.byteLength;if(!(this.fileBytesReaded>=t)){var i,o=e._header,r=this.fileArrayBuffer,n=this.fileBytesReaded;void 0===this.readWriter&&(this.readWriter=new ReaderWriter);for(var a=0;a<5;a++)o._version+=String.fromCharCode(new Int8Array(r.slice(n,n+1))),n+=1;o._f4d_version=2,i=this.readWriter.readInt32(r,n,n+4),n+=4;for(a=0;a<i;a++)o._global_unique_id+=String.fromCharCode(new Int8Array(r.slice(n,n+1))),n+=1;o._longitude=new Float64Array(r.slice(n,n+8))[0],n+=8,o._latitude=new Float64Array(r.slice(n,n+8))[0],n+=8,o._elevation=new Float32Array(r.slice(n,n+4))[0],n+=4,o._boundingBox.minX=new Float32Array(r.slice(n,n+4))[0],n+=4,o._boundingBox.minY=new Float32Array(r.slice(n,n+4))[0],n+=4,o._boundingBox.minZ=new Float32Array(r.slice(n,n+4))[0],n+=4,o._boundingBox.maxX=new Float32Array(r.slice(n,n+4))[0],n+=4,o._boundingBox.maxY=new Float32Array(r.slice(n,n+4))[0],n+=4,o._boundingBox.maxZ=new Float32Array(r.slice(n,n+4))[0],n+=4;var s=(o._boundingBox.maxZ-o._boundingBox.minZ)/2;o._elevation=45+s-.5;var l=!1;(o._boundingBox.maxX-o._boundingBox.minX>40||o._boundingBox.maxY-o._boundingBox.minY>40)&&(l=!0),!l&&o._boundingBox.maxZ-o._boundingBox.minZ<30&&(o.isSmall=!0);this.readWriter.readUInt8(r,n,n+1);n+=1;var c=Cesium.Cartesian3.fromDegrees(o._longitude,o._latitude,o._elevation),h=Cesium.Ellipsoid.WGS84.cartesianToCartographic(c).height;c=Cesium.Cartesian3.fromDegrees(o._longitude,o._latitude,h),e.buildingPosition=c;Cesium.EncodedCartesian3.encode(c);var d=Cesium.EncodedCartesian3.encode(c.x),u=Cesium.EncodedCartesian3.encode(c.y),f=Cesium.EncodedCartesian3.encode(c.z);e.buildingPositionHIGH=new Float32Array(3),e.buildingPositionHIGH[0]=d.high,e.buildingPositionHIGH[1]=u.high,e.buildingPositionHIGH[2]=f.high,e.buildingPositionLOW=new Float32Array(3),e.buildingPositionLOW[0]=d.low,e.buildingPositionLOW[1]=u.low,e.buildingPositionLOW[2]=f.low,this.fileBytesReaded=n}},TerranTile.prototype.parseFileSimpleBuilding=function(e){var t=this.fileArrayBuffer.byteLength;if(!(this.fileBytesReaded>=t)){void 0===this.readWriter&&(this.readWriter=new ReaderWriter);var i,o,r=this.fileBytesReaded,n=this.fileArrayBuffer;void 0===e._simpleBuilding_v1&&(e._simpleBuilding_v1=new SimpleBuildingV1);var a=e._simpleBuilding_v1,s=this.readWriter.readUInt32(n,r,r+4);r+=4;for(var l=0;l<s;l++){var c=a.newSimpleObject()._vtCacheKeys_container.newVertexTexcoordsArraysCacheKey(),h=this.readWriter.readUInt32(n,r,r+4);i=r+=4,o=r+20*h,c.verticesArrayBuffer=n.slice(i,o),r+=20*h,c._vertices_count=h}this.readWriter.readInt32(n,r,r+4);r+=4,this.fileBytesReaded=r}},TerranTile.prototype.parseFileNailImage=function(e,t){void 0===e._simpleBuilding_v1&&(e._simpleBuilding_v1=new SimpleBuildingV1),void 0===this.readWriter&&(this.readWriter=new ReaderWriter);var i=e._simpleBuilding_v1,o=this.fileBytesReaded,r=this.fileArrayBuffer,n=this.readWriter.readUInt32(r,o,o+4),a=o+=4,s=o+n;i.textureArrayBuffer=new Uint8Array(r.slice(a,s)),o+=n,this.fileBytesReaded=o},TerranTile.prototype.parseFileAllBuildings=function(e){var t=this.fileArrayBuffer.byteLength;if(this.fileBytesReaded>=t)this.fileParsingFinished=!0;else{void 0===this.readWriter&&(this.readWriter=new ReaderWriter);var i=this.fileArrayBuffer,o=this.readWriter.readInt32(i,0,4);this.fileBytesReaded+=4,0===o&&(this.empty_tile=!0);for(var r=0;r<o;r++){var n=this.fileBytesReaded;this.fileBytesReaded=n,this.current_BRProject_parsing=this.newBRProject(),this.parseFileHeader(this.current_BRProject_parsing),this.parseFileSimpleBuilding(this.current_BRProject_parsing),this.parseFileNailImage(this.current_BRProject_parsing,e)}this.fileParsingFinished=!0,this.fileArrayBuffer=null}},TerranTile.prototype.parseFileOneBuilding=function(e,t){var i=this.fileArrayBuffer.byteLength;if(this.fileBytesReaded>=i)this.fileParsingFinished=!0;else{void 0===this.readWriter&&(this.readWriter=new ReaderWriter);var o=this.readWriter.readInt32(this.fileArrayBuffer,0,4);if(this.projectsParsed_count>=o)return this.fileParsingFinished=!0,void(this.fileBytesReaded=null);0===this.current_BRProject_parsing_state&&(0===this.projectsParsed_count&&(this.fileBytesReaded=4),this.current_BRProject_parsing=this.newBRProject());var r=this.current_BRProject_parsing;0===this.current_BRProject_parsing_state?(this.parseFileHeader(r),this.current_BRProject_parsing_state=1):1===this.current_BRProject_parsing_state?t.backGround_imageReadings_count<1&&(this.parseFile_simpleBuilding_old(e,r),this.current_BRProject_parsing_state=2):2===this.current_BRProject_parsing_state&&t.backGround_imageReadings_count<1&&(this.parseFile_nailImage_old(e,r,t),this.current_BRProject_parsing_state=0,this.projectsParsed_count++,t.backGround_imageReadings_count++)}},TerranTile.prototype.setDimensionsSubTiles=function(){var e=this.subTiles_array.length;if(4===e){var t=(this.longitudeMax+this.longitudeMin)/2,i=(this.latitudeMax+this.latitudeMin)/2;this.subTiles_array[0].setDimensions(this.longitudeMin,t,this.latitudeMin,i),this.subTiles_array[1].setDimensions(t,this.longitudeMax,this.latitudeMin,i),this.subTiles_array[2].setDimensions(t,this.longitudeMax,i,this.latitudeMax),this.subTiles_array[3].setDimensions(this.longitudeMin,t,i,this.latitudeMax);for(var o=0;o<e;o++)this.subTiles_array[o].setDimensionsSubTiles()}},TerranTile.prototype.getSmallestTiles=function(e){if(this.subTiles_array.length>0)for(var t=0;t<this.subTiles_array.length;t++)this.subTiles_array[t].visibilityType=this.visibilityType,this.subTiles_array[t].getSmallestTiles(e);else this.empty_tile.length||e.push(this)},TerranTile.prototype.getIntersectedSmallestTiles=function(e,t,i){var o=[];this.getIntersectedTiles(e,o,i);for(var r=o.length,n=0;n<r;n++)o[n].getSmallestTiles(t);o.length=0},TerranTile.prototype.getIntersectedTiles=function(e,t,i){if(void 0!==this.position)if(void 0===i&&(i=new Cesium.BoundingSphere),i.radius=this.radius,i.center.x=this.position.x,i.center.y=this.position.y,i.center.z=this.position.z,this.visibilityType=e.computeVisibility(i),this.visibilityType===Cesium.Intersect.OUTSIDE);else if(this.visibilityType===Cesium.Intersect.INSIDE)t.push(this);else if(this.subTiles_array.length>0)for(var o=0;o<this.subTiles_array.length;o++)this.subTiles_array[o].getIntersectedTiles(e,t);else t.push(this)};var Texture=function(){if(!(this instanceof Texture))throw new Error(Messages.CONSTRUCT_ERROR);this.textureTypeName="",this.textureImageFileName="",this.texId,this.fileLoadState=CODE.fileLoadState.READY};Texture.prototype.deleteObjects=function(e){this.textureTypeName=void 0,this.textureImageFileName=void 0,this.texId&&e.deleteTexture(this.texId),this.texId=void 0,this.fileLoadState=void 0};var TriPolyhedron=function(){if(!(this instanceof TriPolyhedron))throw new Error(Messages.CONSTRUCT_ERROR);this.vertexMatrix=new VertexMatrix,this.vertexList=this.vertexMatrix.newVertexList(),this.triSurfacesArray=[]};TriPolyhedron.prototype.newTriSurface=function(){var e=new TriSurface;return this.triSurfacesArray.push(e),e},TriPolyhedron.prototype.invertTrianglesSenses=function(){for(var e=this.triSurfacesArray.length,t=0;t<e;t++)this.triSurfacesArray[t].invertTrianglesSenses()},TriPolyhedron.prototype.getVBOArrayModePosNorCol=function(e){void 0===e&&(e=new VBOVertexIdxCacheKey),void 0===e.posVboDataArray&&(e.posVboDataArray=[]),void 0===e.norVboDataArray&&(e.norVboDataArray=[]),void 0===e.colVboDataArray&&(e.colVboDataArray=[]);var t,i,o,r,n,a,s=[],l=[],c=[];e.vertexCount=0;for(var h=this.triSurfacesArray.length,d=0;d<h;d++){n=(a=this.triSurfacesArray[d]).trianglesArray.length;for(var u=0;u<n;u++)void 0===(r=a.trianglesArray[u]).normal&&r.calculatePlaneNormal(),t=r.vertex0,i=r.vertex1,o=r.vertex2,s.push(t.point3d.x),s.push(t.point3d.y),s.push(t.point3d.z),s.push(i.point3d.x),s.push(i.point3d.y),s.push(i.point3d.z),s.push(o.point3d.x),s.push(o.point3d.y),s.push(o.point3d.z),l.push(r.normal.x),l.push(r.normal.y),l.push(r.normal.z),l.push(r.normal.x),l.push(r.normal.y),l.push(r.normal.z),l.push(r.normal.x),l.push(r.normal.y),l.push(r.normal.z),void 0===t.color4?(c.push(200),c.push(200),c.push(200),c.push(200),c.push(200),c.push(200),c.push(200),c.push(200),c.push(200),c.push(200),c.push(200),c.push(200)):(c.push(t.color4.r),c.push(t.color4.g),c.push(t.color4.b),c.push(t.color4.a),c.push(i.color4.r),c.push(i.color4.g),c.push(i.color4.b),c.push(i.color4.a),c.push(o.color4.r),c.push(o.color4.g),c.push(o.color4.b),c.push(o.color4.a)),e.vertexCount+=3}var f=e.vertexCount;e.norVboDataArray=new Int8Array(3*f),e.colVboDataArray=new Uint8Array(4*f),e.posVboDataArray=new Float32Array(3*f);for(d=0;d<3*f;d++)e.posVboDataArray[d]=s[d],e.norVboDataArray[d]=l[d];for(d=0;d<4*f;d++)e.colVboDataArray[d]=c[d];return s=void 0,l=void 0,c=void 0,e};var TriSurface=function(){if(!(this instanceof TriSurface))throw new Error(Messages.CONSTRUCT_ERROR);this.vertexList,this.trianglesArray,this.trianglesList};TriSurface.prototype.newTriangle=function(){void 0===this.trianglesArray&&(this.trianglesArray=[]);var e=new Triangle;return this.trianglesArray.push(e),e},TriSurface.prototype.invertTrianglesSenses=function(){for(var e=this.trianglesArray.length,t=0;t<e;t++)this.trianglesArray[t].invertSense()};var VBOManager=function(){if(!(this instanceof VBOManager))throw new Error(Messages.CONSTRUCT_ERROR)},Buffer=function(){if(!(this instanceof Buffer))throw new Error(Messages.CONSTRUCT_ERROR);this.dataArray,this.dataArrayByteLength=0},VBOVertexIdxCacheKey=function(){if(!(this instanceof VBOVertexIdxCacheKey))throw new Error(Messages.CONSTRUCT_ERROR);this.indicesCount=-1,this.vertexCount=-1,this.bigTrianglesIndicesCount=-1,this.meshVertexCacheKey,this.meshFacesCacheKey,this.meshNormalCacheKey,this.meshColorCacheKey,this.meshTexcoordsCacheKey,this.posVboDataArray,this.norVboDataArray,this.idxVboDataArray,this.colVboDataArray,this.tcoordVboDataArray,this.posArrayByteSize,this.norArrayByteSize,this.idxArrayByteSize,this.colArrayByteSize,this.tcoordArrayByteSize,this.posArrayByteType,this.norArrayByteType,this.idxArrayByteType,this.colArrayByteType,this.tcoordArrayByteType,this.buffer};VBOVertexIdxCacheKey.prototype.deleteGlObjects=function(e,t){this.meshVertexCacheKey&&(t.storeClassifiedBufferKey(e,this.meshVertexCacheKey,this.posArrayByteSize),this.meshVertexCacheKey=void 0),this.posVboDataArray=void 0,this.meshNormalCacheKey&&(t.storeClassifiedBufferKey(e,this.meshNormalCacheKey,this.norArrayByteSize),this.meshNormalCacheKey=void 0),this.norVboDataArray=void 0,this.meshColorCacheKey&&(t.storeClassifiedBufferKey(e,this.meshColorCacheKey,this.colArrayByteSize),this.meshColorCacheKey=void 0),this.colVboDataArray=void 0,this.meshTexcoordsCacheKey&&(t.storeClassifiedBufferKey(e,this.meshTexcoordsCacheKey,this.tcoordArrayByteSize),this.meshTexcoordsCacheKey=void 0),this.tcoordVboDataArray=void 0,this.meshFacesCacheKey&&(t.storeClassifiedElementKey(e,this.meshFacesCacheKey,this.idxArrayByteSize),this.meshFacesCacheKey=void 0),this.idxVboDataArray=void 0,this.posArrayByteSize=void 0,this.norArrayByteSize=void 0,this.idxArrayByteSize=void 0,this.colArrayByteSize=void 0,this.tcoordArrayByteSize=void 0,this.buffer=void 0},VBOVertexIdxCacheKey.prototype.isReadyPositions=function(e,t){return void 0!==this.meshVertexCacheKey||void 0!==this.posVboDataArray&&(this.meshVertexCacheKey=t.getClassifiedBufferKey(e,this.posArrayByteSize),void 0!==this.meshVertexCacheKey&&(e.bindBuffer(e.ARRAY_BUFFER,this.meshVertexCacheKey),e.bufferData(e.ARRAY_BUFFER,this.posVboDataArray,e.STATIC_DRAW),this.posVboDataArray=void 0,!0))},VBOVertexIdxCacheKey.prototype.isReadyNormals=function(e,t){return void 0!==this.meshNormalCacheKey||void 0!==this.norVboDataArray&&(this.meshNormalCacheKey=t.getClassifiedBufferKey(e,this.norArrayByteSize),void 0!==this.meshNormalCacheKey&&(e.bindBuffer(e.ARRAY_BUFFER,this.meshNormalCacheKey),e.bufferData(e.ARRAY_BUFFER,this.norVboDataArray,e.STATIC_DRAW),this.norVboDataArray=void 0,!0))},VBOVertexIdxCacheKey.prototype.isReadyFaces=function(e,t){return void 0!==this.meshFacesCacheKey||void 0!==this.idxVboDataArray&&(this.meshFacesCacheKey=t.getClassifiedElementKey(e,this.idxArrayByteSize),void 0!==this.meshFacesCacheKey&&(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.meshFacesCacheKey),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.idxVboDataArray,e.STATIC_DRAW),this.idxVboDataArray=void 0,!0))},VBOVertexIdxCacheKey.prototype.isReadyTexCoords=function(e,t){return void 0!==this.meshTexcoordsCacheKey||void 0!==this.tcoordVboDataArray&&(this.meshTexcoordsCacheKey=t.getClassifiedBufferKey(e,this.tcoordArrayByteSize),void 0!==this.meshTexcoordsCacheKey&&(e.bindBuffer(e.ARRAY_BUFFER,this.meshTexcoordsCacheKey),e.bufferData(e.ARRAY_BUFFER,this.tcoordVboDataArray,e.STATIC_DRAW),this.tcoordVboDataArray=void 0,!0))},VBOVertexIdxCacheKey.prototype.isReadyColors=function(e,t){return void 0!==this.meshColorCacheKey||void 0!==this.colVboDataArray&&(this.meshColorCacheKey=t.getClassifiedBufferKey(e,this.colArrayByteSize),void 0!==this.meshColorCacheKey&&(e.bindBuffer(e.ARRAY_BUFFER,this.meshColorCacheKey),e.bufferData(e.ARRAY_BUFFER,this.colVboDataArray,e.STATIC_DRAW),this.colVboDataArray=void 0,!0))};var VBOVertexIdxCacheKeysContainer=function(){if(!(this instanceof VBOVertexIdxCacheKeysContainer))throw new Error(Messages.CONSTRUCT_ERROR);this.vboCacheKeysArray=[]};VBOVertexIdxCacheKeysContainer.prototype.newVBOVertexIdxCacheKey=function(){var e=new VBOVertexIdxCacheKey;return this.vboCacheKeysArray.push(e),e},VBOVertexIdxCacheKeysContainer.prototype.deleteGlObjects=function(e,t){if(void 0!==this.vboCacheKeysArray){for(var i=this.vboCacheKeysArray.length,o=0;o<i;o++)this.vboCacheKeysArray[o].deleteGlObjects(e,t),this.vboCacheKeysArray[o]=void 0;this.vboCacheKeysArray.length=0,this.vboCacheKeysArray=void 0}},VBOVertexIdxCacheKeysContainer.prototype.getVbosCount=function(){return void 0===this.vboCacheKeysArray?0:this.vboCacheKeysArray.length};var VBOByteColorCacheKey=function(){if(!(this instanceof VBOByteColorCacheKey))throw new Error(Messages.CONSTRUCT_ERROR);this.meshColorsCacheKey=null,this.meshTexcoordsCacheKey=null},VBOByteColorCacheKeysContainer=function(){if(!(this instanceof VBOByteColorCacheKeysContainer))throw new Error(Messages.CONSTRUCT_ERROR);this.vboByteColorsCacheKeysArray=[]};VBOByteColorCacheKeysContainer.prototype.newVBOByteColorsCacheKey=function(){var e=new VBOByteColorCacheKey;return this.vboByteColorsCacheKeysArray.push(e),e};var VBOKeysStore=function(e){if(!(this instanceof VBOKeysStore))throw new Error(Messages.CONSTRUCT_ERROR);this.classifiedSize=e,this.vboKeysArray=[],this.keysCreated=0};VBOKeysStore.prototype.getBufferKey=function(e,t,i,o){if(this.vboKeysArray.length>0)return r=this.vboKeysArray.pop();if(!o){var r=e.createBuffer();return this.keysCreated+=1,t.totalBytesUsed+=this.classifiedSize,i.totalBytesUsed+=this.classifiedSize,r}},VBOKeysStore.prototype.storeBufferKey=function(e){this.vboKeysArray.push(e)};var VBOKeysNation=function(e,t){if(!(this instanceof VBOKeysNation))throw new Error(Messages.CONSTRUCT_ERROR);var i;this.vboKeysStoreMap={},this.bufferSizes=e,this.minSize=t,this.maxSize=e[e.length-1],this.totalBytesUsed=0;for(var o=e.length,r=0;r<o;r++)i=new VBOKeysStore(e[r]),this.vboKeysStoreMap[e[r]]=i,e[r]>this.maxSize&&(this.maxSize=e[r])};VBOKeysNation.prototype.getClassifiedBufferKey=function(e,t,i,o){var r=this.vboKeysStoreMap[t];return r?r.getBufferKey(e,this,i,o):-1},VBOKeysNation.prototype.storeClassifiedBufferKey=function(e,t){var i=this.vboKeysStoreMap[t];i&&i.storeBufferKey(e)},VBOKeysNation.prototype.getClosestBufferSize=function(e){if(!this.isInsideRange(e))return-1;for(var t=this.bufferSizes.length,i=0;i<t;i++)if(e<=this.bufferSizes[i])return this.bufferSizes[i];return-1},VBOKeysNation.prototype.isInsideRange=function(e){return!(e>this.maxSize||e<this.minSize)};var VBOKeysWorld=function(){if(!(this instanceof VBOKeysWorld))throw new Error(Messages.CONSTRUCT_ERROR);this.totalBytesUsed=0,this.bytesLimit=1e3,this.vboKeysNationsArray=[],this.vboKeyNation12to128=new VBOKeysNation(new Uint32Array([12,16,32,48,64,76,92,128]),0),this.vboKeysNationsArray.push(this.vboKeyNation12to128),this.vboKeyNation200to1000=new VBOKeysNation(new Uint32Array([200,300,400,500,600,700,800,900,1e3]),129),this.vboKeysNationsArray.push(this.vboKeyNation200to1000),this.vboKeyNation1500to6000=new VBOKeysNation(new Uint32Array([1500,2e3,2500,3e3,3500,4e3,4500,5e3,5500,6e3]),1001),this.vboKeysNationsArray.push(this.vboKeyNation1500to6000),this.vboKeyNation7000to16000=new VBOKeysNation(new Uint32Array([7e3,8e3,9e3,1e4,11e3,12e3,13e3,14e3,15e3,16e3]),6001),this.vboKeysNationsArray.push(this.vboKeyNation7000to16000),this.vboKeyNation20000to56000=new VBOKeysNation(new Uint32Array([2e4,24e3,28e3,32e3,36e3,4e4,44e3,48e3,52e3,56e3]),16001),this.vboKeysNationsArray.push(this.vboKeyNation20000to56000),this.vboKeyNation60000to150000=new VBOKeysNation(new Uint32Array([6e4,7e4,8e4,9e4,1e5,11e4,12e4,13e4,14e4,15e4]),56001),this.vboKeysNationsArray.push(this.vboKeyNation60000to150000),this.vboKeyNation200000to1100000=new VBOKeysNation(new Uint32Array([2e5,3e5,4e5,5e5,6e5,7e5,8e5,9e5,1e6,11e5]),150001),this.vboKeysNationsArray.push(this.vboKeyNation200000to1100000),this.vboKeyNation1500000to3000000=new VBOKeysNation(new Uint32Array([15e5,2e6,25e5,3e6]),1100001),this.vboKeysNationsArray.push(this.vboKeyNation1500000to3000000)};VBOKeysWorld.prototype.getClassifiedBufferKey=function(e,t){var i=!1;this.totalBytesUsed>this.bytesLimit&&(i=!0);var o=this.getKeyNationBySize(t),r=void 0;return o&&(r=o.getClassifiedBufferKey(e,t,this,i)),r},VBOKeysWorld.prototype.storeClassifiedBufferKey=function(e,t){var i=this.getKeyNationBySize(t);i&&i.storeClassifiedBufferKey(e,t)},VBOKeysWorld.prototype.getKeyNationBySize=function(e){for(var t=this.vboKeysNationsArray.length,i=0;i<t;){if(this.vboKeysNationsArray[i].isInsideRange(e))return this.vboKeysNationsArray[i];i++}return-1},VBOKeysWorld.prototype.getClassifiedBufferSize=function(e){var t=this.getKeyNationBySize(e),i=-1;return-1!==t&&(i=t.getClosestBufferSize(e)),i};var VBOMemoryManager=function(){if(!(this instanceof VBOMemoryManager))throw new Error(Messages.CONSTRUCT_ERROR);this.enableMemoryManagement=!1,this.buffersKeyWorld=new VBOKeysWorld,this.elementKeyWorld=new VBOKeysWorld,this.buffersKeyWorld.bytesLimit=8e8,this.elementKeyWorld.bytesLimit=3e8};VBOMemoryManager.prototype.isGpuMemFull=function(){return this.buffersKeyWorld.totalBytesUsed>this.buffersKeyWorld.bytesLimit||this.elementKeyWorld.totalBytesUsed>this.elementKeyWorld.bytesLimit},VBOMemoryManager.prototype.getClassifiedBufferKey=function(e,t){return this.enableMemoryManagement?this.buffersKeyWorld.getClassifiedBufferKey(e,t):e.createBuffer()},VBOMemoryManager.prototype.storeClassifiedBufferKey=function(e,t,i){this.enableMemoryManagement?this.buffersKeyWorld.storeClassifiedBufferKey(t,i):e.deleteBuffer(t)},VBOMemoryManager.prototype.getClassifiedElementKey=function(e,t){return this.enableMemoryManagement?this.elementKeyWorld.getClassifiedBufferKey(e,t):e.createBuffer()},VBOMemoryManager.prototype.storeClassifiedElementKey=function(e,t,i){this.enableMemoryManagement?this.elementKeyWorld.storeClassifiedBufferKey(t,i):e.deleteBuffer(t)},VBOMemoryManager.prototype.getClassifiedBufferSize=function(e){return this.enableMemoryManagement?this.buffersKeyWorld.getClassifiedBufferSize(e):e};var VisibleObjectsController=function(){if(!(this instanceof VisibleObjectsController))throw new Error(Messages.CONSTRUCT_ERROR);this.currentVisibles0=[],this.currentVisibles1=[],this.currentVisibles2=[],this.currentVisibles3=[],this.currentVisiblesAux=[]};function changeMagoStateAPI(e,t){if(null!==e){var i=new API("changeMagoState");i.setMagoEnable(t),e.callAPI(i)}}function changeLabelAPI(e,t){if(null!==e){var i=new API("changeLabel");i.setShowLabelInfo(t),e.callAPI(i)}}function changeOriginAPI(e,t){if(null!==e){var i=new API("changeOrigin");i.setShowOrigin(t),e.callAPI(i)}}function changeBoundingBoxAPI(e,t){if(null!==e){var i=new API("changeBoundingBox");i.setShowBoundingBox(t),e.callAPI(i)}}function changePropertyRenderingAPI(e,t,i,o){if(null!==e){var r=new API("changePropertyRendering");r.setShowShadow(t),r.setProjectId(i),r.setProperty(o),e.callAPI(r)}}function changeShadowAPI(e,t){if(null!==e){var i=new API("changeShadow");i.setShowShadow(t),e.callAPI(i)}}function changeColorAPI(e,t,i,o,r,n){if(null!==e){var a=new API("changeColor");a.setProjectId(t),a.setDataKey(i),a.setObjectIds(o),a.setProperty(r),a.setColor(n),e.callAPI(a)}}function changeLocationAndRotationAPI(e,t,i,o,r,n,a,s,l){if(null!==e){var c=new API("changeLocationAndRotation");c.setProjectId(t),c.setDataKey(i),c.setLatitude(o),c.setLongitude(r),c.setElevation(n),c.setHeading(a),c.setPitch(s),c.setRoll(l),e.callAPI(c)}}function changeObjectMoveAPI(e,t){if(null!==e){var i=new API("changeObjectMove");i.setObjectMoveMode(t),e.callAPI(i)}}function saveObjectMoveAPI(e,t){if(null!==e){var i=new API("saveObjectMove");i.setObjectMoveMode(t),e.callAPI(i)}}function deleteAllObjectMoveAPI(e,t){if(null!==e){var i=new API("deleteAllObjectMove");i.setObjectMoveMode(t),e.callAPI(i)}}function deleteAllChangeColorAPI(e){if(null!==e){var t=new API("deleteAllChangeColor");e.callAPI(t)}}function changeInsertIssueModeAPI(e,t){if(null!==e){var i=new API("changeInsertIssueMode");i.setIssueInsertEnable(t),e.callAPI(i)}}function changeObjectInfoViewModeAPI(e,t){if(null!==e){var i=new API("changeObjectInfoViewMode");i.setObjectInfoViewEnable(t),e.callAPI(i)}}function changeOcclusionCullingAPI(e,t,i){if(null!==e){var o=new API("changeOcclusionCulling");o.setOcclusionCullingEnable(t),o.setDataKey(i),e.callAPI(o)}}function changeFPVModeAPI(e,t){if(null!==e){var i=new API("changeFPVMode");i.setFPVMode(t),e.callAPI(i)}}function changeNearGeoIssueListViewModeAPI(e,t){if(null!==e){var i=new API("changeNearGeoIssueListViewMode");i.setNearGeoIssueListEnable(t),e.callAPI(i)}}function changeInsertIssueStateAPI(e,t){if(null!==e){var i=new API("changeInsertIssueState");i.setInsertIssueState(t),e.callAPI(i)}}function changeLodAPI(e,t,i,o,r,n,a){if(null!==e){var s=new API("changeLod");s.setLod0DistInMeters(t),s.setLod1DistInMeters(i),s.setLod2DistInMeters(o),s.setLod3DistInMeters(r),s.setLod4DistInMeters(n),s.setLod5DistInMeters(a),e.callAPI(s)}}function changeLightingAPI(e,t,i,o,r,n){if(null!==e){var a=new API("changeLighting");a.setAmbientReflectionCoef(t),a.setDiffuseReflectionCoef(i),a.setSpecularReflectionCoef(o),a.setAmbientColor(r),a.setSpecularColor(n),e.callAPI(a)}}function changeSsaoRadiusAPI(e,t){if(null!==e){var i=new API("changeSsaoRadius");i.setSsaoRadius(t),e.callAPI(i)}}function clearAllDataAPI(e){if(null!==e){var t=new API("clearAllData");MagoConfig.clearAllData(),e.callAPI(t)}}function drawInsertIssueImageAPI(e,t,i,o,r,n,a,s){if(null!==e){var l=new API("drawInsertIssueImage");l.setDrawType(t),l.setIssueId(i),l.setIssueId(o),l.setDataKey(r),l.setLatitude(n),l.setLongitude(a),l.setElevation(s),e.callAPI(l)}}function gotoProjectAPI(e,t,i,o,r,n,a,s){if(null!==e){MagoConfig.setData(CODE.PROJECT_ID_PREFIX+t,i),MagoConfig.setProjectDataFolder(CODE.PROJECT_DATA_FOLDER_PREFIX+o,o);var l=new API("gotoProject");l.setProjectId(t),l.setProjectDataFolder(o),l.setLatitude(n),l.setLongitude(r),l.setElevation(a),l.setDuration(s),e.callAPI(l)}}function gotoIssueAPI(e,t,i,o,r,n,a,s,l,c){if(null!==e){MagoConfig.setData(CODE.PROJECT_ID_PREFIX+t,i),MagoConfig.setProjectDataFolder(CODE.PROJECT_DATA_FOLDER_PREFIX+o,o);var h=new API("gotoIssue");h.setProjectId(t),h.setProjectDataFolder(o),h.setIssueId(r),h.setIssueType(n),h.setLatitude(s),h.setLongitude(a),h.setElevation(l),h.setDuration(c),e.callAPI(h)}}function mouseMoveAPI(e,t){null!==e&&e.mouseMove(t)}function searchDataAPI(e,t,i){if(null!==e){var o=new API("searchData");o.setProjectId(t),o.setDataKey(i),e.callAPI(o)}}function isDataExistAPI(e){return!!MagoConfig.isDataExist(e)}function getDataAPI(e){return MagoConfig.getData(e)}function getDataInfoByDataKeyAPI(e,t,i){if(null!==e){var o=new API("getDataInfoByDataKey");o.setProjectId(t),o.setDataKey(i),e.callAPI(o)}}function drawAppendDataAPI(e,t,i,o){if(null!==e&&!(t.length<=0)){var r=new API("drawAppendData");t.forEach(function(t,n){MagoConfig.setData(CODE.PROJECT_ID_PREFIX+t,i[n]),MagoConfig.setProjectDataFolder(CODE.PROJECT_DATA_FOLDER_PREFIX+o[n],o[n]),r.setProjectId(t),r.setProjectDataFolder(o[n]),e.callAPI(r)})}}function getCoordinateRelativeToBuildingAPI(e,t,i,o,r){if(null!==e){var n=new API("getCoordinateRelativeToBuilding");return n.setReturnable(!0),n.setProjectId(t),n.setDataKey(i),n.setInputPoint(o),n.setResultPoint(r),e.callAPI(n)}}function getAbsoluteCoodinateOfBuildingPointAPI(e,t,i,o,r){if(null!==e){var n=new API("getAbsoluteCoodinateOfBuildingPoint");return n.setReturnable(!0),n.setProjectId(t),n.setDataKey(i),n.setInputPoint(o),n.setResultPoint(r),e.callAPI(n)}}VisibleObjectsController.prototype.initArrays=function(){this.currentVisibles0=[],this.currentVisibles1=[],this.currentVisibles2=[],this.currentVisibles3=[],this.currentVisiblesAux=[]},VisibleObjectsController.prototype.clear=function(){this.currentVisibles0.length=0,this.currentVisibles1.length=0,this.currentVisibles2.length=0,this.currentVisibles3.length=0,this.currentVisiblesAux.length=0},VisibleObjectsController.prototype.getNodeIdxSortedByDist=function(e,t,i,o){var r=o.data.neoBuilding,n=i-t;if(n<6){for(var a,s=!1,l=t;!s&&l<=i;){var c=e[l].data.neoBuilding;r.distToCam<c.distToCam&&(a=l,s=!0),l++}return s?a:i+1}var h,d,u=t+Math.floor(n/2);return e[u].data.neoBuilding.distToCam>r.distToCam?(h=t,d=u):(h=u,d=i),this.getNodeIdxSortedByDist(e,h,d,o)},VisibleObjectsController.prototype.putNodeToArraySortedByDist=function(e,t){if(e.length>0){var i=e.length-1,o=this.getNodeIdxSortedByDist(e,0,i,t);e.splice(o,0,t)}else e.push(t)};var ColorAPI={changeColor:function(e,t){var i=e.getProjectId(),o=e.getDataKey(),r=e.getObjectIds(),n=e.getProperty(),a=null,s=null;if(null!==n&&""!==n){var l=n.split("=");a=l[0],s=l[1]}var c=e.getColor().split(","),h=[c[0]/255,c[1]/255,c[2]/255],d=!1;null!==r&&0!==r.length&&(d=!0);var u=[];if(d)for(var f=0,g=r.length;f<g;f++){var p;(p=new ChangeHistory).setProjectId(i),p.setDataKey(o),p.setObjectId(r[f]),p.setProperty(n),p.setPropertyKey(a),p.setPropertyValue(s),p.setRgbColor(h),u.push(p)}else(p=new ChangeHistory).setProjectId(i),p.setDataKey(o),p.setObjectId(null),p.setProperty(n),p.setPropertyKey(a),p.setPropertyValue(s),p.setRgbColor(h),u.push(p);var m=u.length;for(f=0;f<m;f++)p=u[f],MagoConfig.saveColorHistory(i,o,p.getObjectId(),p)}},DrawAPI={drawAppendData:function(e,t){t.getObjectIndexFile(e.getProjectId(),e.getProjectDataFolder())},drawInsertIssueImage:function(e,t){void 0!==t.objMarkerSC&&0!==e.getDrawType()||(t.objMarkerSC=new ObjectMarker,t.objMarkerSC.geoLocationData.geographicCoord=new GeographicCoord,ManagerUtils.calculateGeoLocationData(parseFloat(e.getLongitude()),parseFloat(e.getLatitude()),parseFloat(e.getElevation()),void 0,void 0,void 0,t.objMarkerSC.geoLocationData,t));var i=t.objMarkerManager.newObjectMarker();t.objMarkerSC.issue_id=e.getIssueId(),t.objMarkerSC.issue_type=e.getIssueType(),t.objMarkerSC.geoLocationData.geographicCoord.setLonLatAlt(parseFloat(e.getLongitude()),parseFloat(e.getLatitude()),parseFloat(e.getElevation())),i.copyFrom(t.objMarkerSC),t.objMarkerSC=void 0}},LocationAndRotationAPI={changeLocationAndRotation:function(e,t){var i=new ChangeHistory;i.setProjectId(e.getProjectId()),i.setDataKey(e.getDataKey()),i.setLatitude(parseFloat(e.getLatitude())),i.setLongitude(parseFloat(e.getLongitude())),i.setElevation(parseFloat(e.getElevation())),i.setHeading(parseFloat(e.getHeading())),i.setPitch(parseFloat(e.getPitch())),i.setRoll(parseFloat(e.getRoll())),t.changeLocationAndRotation(e.getProjectId(),e.getDataKey(),parseFloat(e.getLatitude()),parseFloat(e.getLongitude()),parseFloat(e.getElevation()),parseFloat(e.getHeading()),parseFloat(e.getPitch()),parseFloat(e.getRoll()))}},LodAPI={};function API(e){if(!(this instanceof API))throw new Error(Messages.CONSTRUCT_ERROR);this.magoEnable=!0,this.returnable=!1,this.apiName=e,this.projectId=null,this.projectDataFolder=null,this.objectIds=null,this.dataKey=null,this.issueId=null,this.issueType=null,this.drawType=0,this.latitude=0,this.longitude=0,this.elevation=0,this.heading=0,this.pitch=0,this.roll=0,this.duration=0,this.property=null,this.color=0,this.blockType=null,this.showOutFitting=!1,this.showLabelInfo=!0,this.showOrigin=!1,this.showBoundingBox=!1,this.showShadow=!1,this.frustumFarDistance=0,this.objectMoveMode=CODE.moveMode.NONE,this.issueInsertEnable=!1,this.objectInfoViewEnable=!1,this.nearGeoIssueListEnable=!1,this.occlusionCullingEnable=!1,this.insertIssueState=0,this.lod0DistInMeters=null,this.lod1DistInMeters=null,this.lod2DistInMeters=null,this.lod3DistInMeters=null,this.lod4DistInMeters=null,this.lod5DistInMeters=null,this.ambientReflectionCoef=null,this.diffuseReflectionCoef=null,this.specularReflectionCoef=null,this.ambientColor=null,this.specularColor=null,this.ssaoRadius=null,this.FPVMode=!1,this.inputPoint=null,this.resultPoint=null}function apiResultCallback(e,t,i){window[e](t,i)}function selectedObjectCallback(e,t,i,o,r,n,a,s,l,c){window[e](t,i,o,r,n,a,s,l,c)}function movedDataCallback(e,t,i,o,r,n,a,s,l,c){window[e](t,i,o,r,n,a,s,l,c)}function dataInfoCallback(e,t,i,o,r,n,a,s,l,c){window[e](t,i,o,r,n,a,s,l,c)}function insertIssueCallback(e,t,i,o,r,n,a){window[e](t,i,o,r,n,a)}function clickPositionCallback(e,t){window[e](t)}LodAPI.changeLod=function(e,t){null!==e.getLod0DistInMeters()&&""!==e.getLod0DistInMeters()&&t.magoPolicy.setLod0DistInMeters(e.getLod0DistInMeters()),null!==e.getLod1DistInMeters()&&""!==e.getLod1DistInMeters()&&t.magoPolicy.setLod1DistInMeters(e.getLod1DistInMeters()),null!==e.getLod2DistInMeters()&&""!==e.getLod2DistInMeters()&&t.magoPolicy.setLod2DistInMeters(e.getLod2DistInMeters()),null!==e.getLod3DistInMeters()&&""!==e.getLod3DistInMeters()&&t.magoPolicy.setLod3DistInMeters(e.getLod3DistInMeters()),null!==e.getLod4DistInMeters()&&""!==e.getLod4DistInMeters()&&t.magoPolicy.setLod4DistInMeters(e.getLod4DistInMeters()),null!==e.getLod5DistInMeters()&&""!==e.getLod5DistInMeters()&&t.magoPolicy.setLod5DistInMeters(e.getLod5DistInMeters())},API.prototype.getMagoEnable=function(){return this.magoEnable},API.prototype.setMagoEnable=function(e){this.magoEnable=e},API.prototype.getReturnable=function(){return this.returnable},API.prototype.setReturnable=function(e){this.returnable=e},API.prototype.getAPIName=function(){return this.apiName},API.prototype.getProjectId=function(){return this.projectId},API.prototype.setProjectId=function(e){this.projectId=e},API.prototype.getProjectDataFolder=function(){return this.projectDataFolder},API.prototype.setProjectDataFolder=function(e){this.projectDataFolder=e},API.prototype.getObjectIds=function(){return this.objectIds},API.prototype.setObjectIds=function(e){this.objectIds=e},API.prototype.getIssueId=function(){return this.issueId},API.prototype.setIssueId=function(e){this.issueId=e},API.prototype.getIssueType=function(){return this.issueType},API.prototype.setIssueType=function(e){this.issueId=e},API.prototype.getDataKey=function(){return this.dataKey},API.prototype.setDataKey=function(e){this.dataKey=e},API.prototype.getLatitude=function(){return this.latitude},API.prototype.setLatitude=function(e){this.latitude=e},API.prototype.getLongitude=function(){return this.longitude},API.prototype.setLongitude=function(e){this.longitude=e},API.prototype.getElevation=function(){return this.elevation},API.prototype.setElevation=function(e){this.elevation=e},API.prototype.getHeading=function(){return this.heading},API.prototype.setHeading=function(e){this.heading=e},API.prototype.getPitch=function(){return this.pitch},API.prototype.setPitch=function(e){this.pitch=e},API.prototype.getRoll=function(){return this.roll},API.prototype.setRoll=function(e){this.roll=e},API.prototype.getProperty=function(){return this.property},API.prototype.setProperty=function(e){this.property=e},API.prototype.getColor=function(){return this.color},API.prototype.setColor=function(e){this.color=e},API.prototype.getBlockType=function(){return this.blockType},API.prototype.setBlockType=function(e){this.blockType=e},API.prototype.getShowOutFitting=function(){return this.showOutFitting},API.prototype.setShowOutFitting=function(e){this.showOutFitting=e},API.prototype.getShowLabelInfo=function(){return this.showLabelInfo},API.prototype.setShowLabelInfo=function(e){this.showLabelInfo=e},API.prototype.getShowOrigin=function(){return this.showOrigin},API.prototype.setShowOrigin=function(e){this.showOrigin=e},API.prototype.getShowBoundingBox=function(){return this.showBoundingBox},API.prototype.setShowBoundingBox=function(e){this.showBoundingBox=e},API.prototype.getShowShadow=function(){return this.showShadow},API.prototype.setShowShadow=function(e){this.showShadow=e},API.prototype.getFrustumFarDistance=function(){return this.frustumFarDistance},API.prototype.setFrustumFarDistance=function(e){this.frustumFarDistance=e},API.prototype.getObjectMoveMode=function(){return this.objectMoveMode},API.prototype.setObjectMoveMode=function(e){this.objectMoveMode=e},API.prototype.getIssueInsertEnable=function(){return this.issueInsertEnable},API.prototype.setIssueInsertEnable=function(e){this.issueInsertEnable=e},API.prototype.getObjectInfoViewEnable=function(){return this.objectInfoViewEnable},API.prototype.setObjectInfoViewEnable=function(e){this.objectInfoViewEnable=e},API.prototype.getOcclusionCullingEnable=function(){return this.occlusionCullingEnable},API.prototype.setOcclusionCullingEnable=function(e){this.occlusionCullingEnable=e},API.prototype.getNearGeoIssueListEnable=function(){return this.nearGeoIssueListEnable},API.prototype.setNearGeoIssueListEnable=function(e){this.nearGeoIssueListEnable=e},API.prototype.getInsertIssueState=function(){return this.insertIssueState},API.prototype.setInsertIssueState=function(e){this.insertIssueState=e},API.prototype.getDrawType=function(){return this.drawType},API.prototype.setDrawType=function(e){this.drawType=e},API.prototype.getLod0DistInMeters=function(){return this.lod0DistInMeters},API.prototype.setLod0DistInMeters=function(e){this.lod0DistInMeters=e},API.prototype.getLod1DistInMeters=function(){return this.lod1DistInMeters},API.prototype.setLod1DistInMeters=function(e){this.lod1DistInMeters=e},API.prototype.getLod2DistInMeters=function(){return this.lod2DistInMeters},API.prototype.setLod2DistInMeters=function(e){this.lod2DistInMeters=e},API.prototype.getLod3DistInMeters=function(){return this.lod3DistInMeters},API.prototype.setLod3DistInMeters=function(e){this.lod3DistInMeters=e},API.prototype.getLod4DistInMeters=function(){return this.lod4DistInMeters},API.prototype.setLod4DistInMeters=function(e){this.lod4DistInMeters=e},API.prototype.getLod5DistInMeters=function(){return this.lod5DistInMeters},API.prototype.setLod5DistInMeters=function(e){this.lod5DistInMeters=e},API.prototype.getAmbientReflectionCoef=function(){return this.ambientReflectionCoef},API.prototype.setAmbientReflectionCoef=function(e){this.ambientReflectionCoef=e},API.prototype.getDiffuseReflectionCoef=function(){return this.diffuseReflectionCoef},API.prototype.setDiffuseReflectionCoef=function(e){this.diffuseReflectionCoef=e},API.prototype.getSpecularReflectionCoef=function(){return this.specularReflectionCoef},API.prototype.setSpecularReflectionCoef=function(e){this.specularReflectionCoef=e},API.prototype.getAmbientColor=function(){return this.ambientColor},API.prototype.setAmbientColor=function(e){this.ambientColor=e},API.prototype.getSpecularColor=function(){return this.specularColor},API.prototype.setSpecularColor=function(e){this.specularColor=e},API.prototype.getSsaoRadius=function(){return this.ssaoRadius},API.prototype.setSsaoRadius=function(e){this.ssaoRadius=e},API.prototype.getFPVMode=function(){return this.FPVMode},API.prototype.setFPVMode=function(e){this.FPVMode=e},API.prototype.getDuration=function(){return this.duration},API.prototype.setDuration=function(e){this.duration=e},API.prototype.getInputPoint=function(){return this.inputPoint},API.prototype.setInputPoint=function(e){this.inputPoint=e},API.prototype.getResultPoint=function(){return this.resultPoint},API.prototype.setResultPoint=function(e){this.resultPoint=e};var ChangeHistory=function(){if(!(this instanceof ChangeHistory))throw new Error(Messages.CONSTRUCT_ERROR);this.moveHistory=!1,this.colorHistory=!1,this.rotationHistory=!1,this.objectMoveMode=null,this.projectId=null,this.projectDataFolder=null,this.dataKey=null,this.objectId=null,this.objectIndexOrder=0,this.refObjectAditionalMove,this.refObjectAditionalMoveRelToBuilding,this.latitude=0,this.longitude=0,this.elevation=0,this.heading=0,this.pitch=0,this.roll=0,this.duration=0,this.color=0,this.rgbColor=[],this.property=null,this.propertyKey=null,this.propertyValue=null};ChangeHistory.prototype.getReferenceObjectAditionalMovement=function(){return void 0===this.refObjectAditionalMove&&(this.refObjectAditionalMove=new Point3D),this.refObjectAditionalMove},ChangeHistory.prototype.getReferenceObjectAditionalMovementRelToBuilding=function(){return void 0===this.refObjectAditionalMoveRelToBuilding&&(this.refObjectAditionalMoveRelToBuilding=new Point3D),this.refObjectAditionalMoveRelToBuilding},ChangeHistory.prototype.getProjectId=function(){return this.projectId},ChangeHistory.prototype.setProjectId=function(e){this.projectId=e},ChangeHistory.prototype.getProjectDataFolder=function(){return this.projectDataFolder},ChangeHistory.prototype.setProjectDataFolder=function(e){this.projectDataFolder=e},ChangeHistory.prototype.getDataKey=function(){return this.dataKey},ChangeHistory.prototype.setDataKey=function(e){this.dataKey=e},ChangeHistory.prototype.getObjectId=function(){return this.objectId},ChangeHistory.prototype.setObjectId=function(e){this.objectId=e},ChangeHistory.prototype.getObjectIndexOrder=function(){return this.objectIndexOrder},ChangeHistory.prototype.setObjectIndexOrder=function(e){this.objectIndexOrder=e},ChangeHistory.prototype.getLatitude=function(){return this.latitude},ChangeHistory.prototype.setLatitude=function(e){this.latitude=e},ChangeHistory.prototype.getLongitude=function(){return this.longitude},ChangeHistory.prototype.setLongitude=function(e){this.longitude=e},ChangeHistory.prototype.getElevation=function(){return this.elevation},ChangeHistory.prototype.setElevation=function(e){this.elevation=e},ChangeHistory.prototype.getHeading=function(){return this.heading},ChangeHistory.prototype.setHeading=function(e){this.heading=e},ChangeHistory.prototype.getPitch=function(){return this.pitch},ChangeHistory.prototype.setPitch=function(e){this.pitch=e},ChangeHistory.prototype.getRoll=function(){return this.roll},ChangeHistory.prototype.setRoll=function(e){this.roll=e},ChangeHistory.prototype.getColor=function(){return this.color},ChangeHistory.prototype.setColor=function(e){this.color=e},ChangeHistory.prototype.getRgbColor=function(){return this.rgbColor},ChangeHistory.prototype.setRgbColor=function(e){this.rgbColor=e},ChangeHistory.prototype.getProperty=function(){return this.property},ChangeHistory.prototype.setProperty=function(e){this.property=e},ChangeHistory.prototype.getPropertyKey=function(){return this.propertyKey},ChangeHistory.prototype.setPropertyKey=function(e){this.propertyKey=e},ChangeHistory.prototype.getPropertyValue=function(){return this.propertyValue},ChangeHistory.prototype.setPropertyValue=function(e){this.propertyValue=e},ChangeHistory.prototype.getDuration=function(){return this.duration},ChangeHistory.prototype.setDuration=function(e){this.duration=e},ChangeHistory.prototype.getObjectMoveMode=function(){return this.objectMoveMode},ChangeHistory.prototype.setObjectMoveMode=function(e){this.objectMoveMode=e};var CODE={magoManagerState:{INIT:0,STARTED:1,READY:2},fileLoadState:{READY:0,LOADING_STARTED:1,LOADING_FINISHED:2,PARSE_STARTED:3,PARSE_FINISHED:4,IN_QUEUE:5},moveMode:{ALL:"0",OBJECT:"1",NONE:"2"},PROJECT_ID_PREFIX:"projectId_",PROJECT_DATA_FOLDER_PREFIX:"projectDataFolder_"},Constant={CESIUM:"cesium",WORLDWIND:"worldwind",MAGOWORLD:"magoworld",OBJECT_INDEX_FILE:"/objectIndexFile.ihe",CACHE_VERSION:"?cache_version=",SIMPLE_BUILDING_TEXTURE3x3_BMP:"/SimpleBuildingTexture3x3.bmp",RESULT_XDO2F4D:"/Result_xdo2f4d/Images/",RESULT_XDO2F4D_TERRAINTILES:"/Result_xdo2f4d/F4D_TerrainTiles/",RESULT_XDO2F4D_TERRAINTILEFILE_TXT:"/Result_xdo2f4d/f4dTerranTileFile.txt",INTERSECTION_OUTSIDE:0,INTERSECTION_INTERSECT:1,INTERSECTION_INSIDE:2,INTERSECTION_POINT_A:3,INTERSECTION_POINT_B:4},MagoConfig={getPolicy:function(){return this.serverPolicy},getData:function(e){return this.dataObject[e]},isDataExist:function(e){return this.dataObject.hasOwnProperty(e)},deleteData:function(e){return delete this.dataObject[e]},setData:function(e,t){this.isDataExist(e)||(this.dataObject[e]=t)},getProjectDataFolder:function(e){var t=CODE.PROJECT_DATA_FOLDER_PREFIX+e;return this.dataObject[t]},isProjectDataFolderExist:function(e){var t=CODE.PROJECT_DATA_FOLDER_PREFIX+e;return this.dataObject.hasOwnProperty(t)},deleteProjectDataFolder:function(e){var t=CODE.PROJECT_DATA_FOLDER_PREFIX+e;return delete this.dataObject[t]},setProjectDataFolder:function(e,t){var i=CODE.PROJECT_DATA_FOLDER_PREFIX+e;this.isProjectDataFolderExist(i)||(this.dataObject[i]=t)},init:function(e,t,i){if(this.dataObject={},this.selectHistoryObject={},this.movingHistoryObject={},this.colorHistoryObject={},this.locationAndRotationHistoryObject={},this.serverPolicy=e,null!==t&&t.length>0)for(var o=0;o<t.length;o++)this.isDataExist(CODE.PROJECT_ID_PREFIX+t[o])||(this.setData(CODE.PROJECT_ID_PREFIX+t[o],i[o]),this.setProjectDataFolder(CODE.PROJECT_DATA_FOLDER_PREFIX+i[o].data_key,i[o].data_key))},clearAllData:function(){this.dataObject={}},clearSelectHistory:function(){this.selectHistoryObject={}},getAllSelectHistory:function(){return this.selectHistoryObject},getSelectHistoryObjects:function(e,t){var i=this.selectHistoryObject[e];if(void 0!==i)return i[t]},getSelectHistoryObject:function(e,t,i){var o=this.selectHistoryObject[e];if(void 0!==o){var r=o[t];if(void 0!==r)return r[i]}},saveSelectHistory:function(e,t,i,o){var r=this.selectHistoryObject.get(e);void 0===r&&(r={},this.selectHistoryObject[e]=r);var n=r[t];void 0===n&&(n={},r[t]=n),n[i]=o},deleteSelectHistoryObject:function(e,t,i){var o=this.selectHistoryObject[e];if(void 0!==o){var r=o[t];if(void 0!==r)return delete r[i]}},clearMovingHistory:function(){this.movingHistoryObject={}},getAllMovingHistory:function(){return this.movingHistoryObject},getMovingHistoryObjects:function(e,t){var i=this.movingHistoryObject[e];if(void 0!==i)return i[t]},getMovingHistoryObject:function(e,t,i){var o=this.movingHistoryObject[e];if(void 0!==o){var r=o[t];if(void 0!==r)return r[i]}},saveMovingHistory:function(e,t,i,o){var r=this.movingHistoryObject[e];void 0===r&&(r={},this.movingHistoryObject[e]=r);var n=r[t];void 0===n&&(n={},r[t]=n),n[i]=o},deleteMovingHistoryObject:function(e,t,i){var o=this.movingHistoryObject[e];if(void 0!==o){var r=o[t];if(void 0!==r)return delete r[i]}},getAllColorHistory:function(){return this.colorHistoryObject},clearColorHistory:function(){this.colorHistoryObject={}},getColorHistorys:function(e,t){var i=this.colorHistoryObject[e];if(void 0!==i)return i[t]},getColorHistory:function(e,t,i){var o=this.colorHistoryObject[e];if(void 0!==o){var r=o[t];if(void 0!==r)return r[i]}},saveColorHistory:function(e,t,i,o){var r=this.colorHistoryObject[e];void 0===r&&(r={},this.colorHistoryObject[e]=r);var n=r[t];void 0===n&&(n={},r[t]=n),null===i||""===i?n[t]=o:n[i]=o},deleteColorHistory:function(e,t,i){var o=this.colorHistoryObject[e];if(void 0!==o){var r=o[t];if(void 0!==r)return delete r[i]}}};MagoConfig.clearColorHistory=function(){this.colorHistoryObject={}},MagoConfig.getAllLocationAndRotationHistory=function(){return this.locationAndRotationHistoryObject},MagoConfig.getLocationAndRotationHistorys=function(e,t){var i=this.locationAndRotationHistoryObject[e];if(void 0!==i)return i[t]},MagoConfig.getLocationAndRotationHistory=function(e,t){var i=this.locationAndRotationHistoryObject[e];if(void 0!==i)return i[t]},MagoConfig.saveLocationAndRotationHistory=function(e,t,i){var o=this.locationAndRotationHistoryObject[e];void 0===o&&(o={},this.locationAndRotationHistoryObject[e]=o);var r=o[t];void 0===r&&(r={}),r[t]=i},MagoConfig.deleteLocationAndRotationHistory=function(e,t){var i=this.locationAndRotationHistoryObject[e];if(void 0!==i)delete i[t]},MagoConfig.clearLocationAndRotationHistory=function(){this.locationAndRotationHistoryObject={}};var Policy=function(){if(!(this instanceof Policy))throw new Error(Messages.CONSTRUCT_ERROR);this.magoEnable=!0,this.showOutFitting=!1,this.showLabelInfo=!1,this.showBoundingBox=!1,this.showShadow=!1,this.frustumFarSquaredDistance=5e6,this.frustumFarDistance=2e4,this.highLightedBuildings=[],this.colorBuildings=[],this.color=[],this.hideBuildings=[],this.objectMoveMode=CODE.moveMode.NONE,this.issueInsertEnable=!1,this.objectInfoViewEnable=!1,this.nearGeoIssueListEnable=!1,this.occlusionCullingEnable=!1,this.showOrigin=!1,this.imagePath="",this.colorChangedObjectId,this.lod0DistInMeters=15,this.lod1DistInMeters=50,this.lod2DistInMeters=90,this.lod3DistInMeters=200,this.lod4DistInMeters=1e3,this.lod5DistInMeters=5e4,this.ambientReflectionCoef=.45,this.diffuseReflectionCoef=.75,this.specularReflectionCoef=.6,this.ambientColor=null,this.specularColor=new Float32Array([.6,.6,.6]),this.ssaoRadius=.15};Policy.prototype.getShowOrigin=function(){return this.showOrigin},Policy.prototype.setShowOrigin=function(e){this.showOrigin=e},Policy.prototype.getMagoEnable=function(){return this.magoEnable},Policy.prototype.setMagoEnable=function(e){this.magoEnable=e},Policy.prototype.getShowOutFitting=function(){return this.showOutFitting},Policy.prototype.setShowOutFitting=function(e){this.showOutFitting=e},Policy.prototype.getShowLabelInfo=function(){return this.showLabelInfo},Policy.prototype.setShowLabelInfo=function(e){this.showLabelInfo=e},Policy.prototype.getShowBoundingBox=function(){return this.showBoundingBox},Policy.prototype.setShowBoundingBox=function(e){this.showBoundingBox=e},Policy.prototype.getShowShadow=function(){return this.showShadow},Policy.prototype.setShowShadow=function(e){this.showShadow=e},Policy.prototype.getFrustumFarSquaredDistance=function(){return this.frustumFarSquaredDistance},Policy.prototype.setFrustumFarSquaredDistance=function(e){this.frustumFarSquaredDistance=e},Policy.prototype.getFrustumFarDistance=function(){return this.frustumFarDistance},Policy.prototype.setFrustumFarDistance=function(e){this.frustumFarDistance=e},Policy.prototype.getHighLightedBuildings=function(){return this.highLightedBuildings},Policy.prototype.setHighLightedBuildings=function(e){this.highLightedBuildings=e},Policy.prototype.getColorBuildings=function(){return this.colorBuildings},Policy.prototype.setColorBuildings=function(e){this.colorBuildings=e},Policy.prototype.getColor=function(){return this.color},Policy.prototype.setColor=function(e){this.color=e},Policy.prototype.getHideBuildings=function(){return this.hideBuildings},Policy.prototype.setHideBuildings=function(e){this.hideBuildings=e},Policy.prototype.getObjectMoveMode=function(){return this.objectMoveMode},Policy.prototype.setObjectMoveMode=function(e){this.objectMoveMode=e},Policy.prototype.getIssueInsertEnable=function(){return this.issueInsertEnable},Policy.prototype.setIssueInsertEnable=function(e){this.issueInsertEnable=e},Policy.prototype.getObjectInfoViewEnable=function(){return this.objectInfoViewEnable},Policy.prototype.setObjectInfoViewEnable=function(e){this.objectInfoViewEnable=e},Policy.prototype.getOcclusionCullingEnable=function(){return this.occlusionCullingEnable},Policy.prototype.setOcclusionCullingEnable=function(e){this.occlusionCullingEnable=e},Policy.prototype.getNearGeoIssueListEnable=function(){return this.nearGeoIssueListEnable},Policy.prototype.setNearGeoIssueListEnable=function(e){this.nearGeoIssueListEnable=e},Policy.prototype.getImagePath=function(){return this.imagePath},Policy.prototype.setImagePath=function(e){this.imagePath=e},Policy.prototype.getLod0DistInMeters=function(){return this.lod0DistInMeters},Policy.prototype.setLod0DistInMeters=function(e){this.lod0DistInMeters=e},Policy.prototype.getLod1DistInMeters=function(){return this.lod1DistInMeters},Policy.prototype.setLod1DistInMeters=function(e){this.lod1DistInMeters=e},Policy.prototype.getLod2DistInMeters=function(){return this.lod2DistInMeters},Policy.prototype.setLod2DistInMeters=function(e){this.lod2DistInMeters=e},Policy.prototype.getLod3DistInMeters=function(){return this.lod3DistInMeters},Policy.prototype.setLod3DistInMeters=function(e){this.lod3DistInMeters=e},Policy.prototype.getLod4DistInMeters=function(){return this.lod4DistInMeters},Policy.prototype.setLod4DistInMeters=function(e){this.lod4DistInMeters=e},Policy.prototype.getLod5DistInMeters=function(){return this.lod5DistInMeters},Policy.prototype.setLod5DistInMeters=function(e){this.lod5DistInMeters=e},Policy.prototype.getAmbientReflectionCoef=function(){return this.ambientReflectionCoef},Policy.prototype.setAmbientReflectionCoef=function(e){this.ambientReflectionCoef=e},Policy.prototype.getDiffuseReflectionCoef=function(){return this.diffuseReflectionCoef},Policy.prototype.setDiffuseReflectionCoef=function(e){this.diffuseReflectionCoef=e},Policy.prototype.getSpecularReflectionCoef=function(){return this.specularReflectionCoef},Policy.prototype.setSpecularReflectionCoef=function(e){this.specularReflectionCoef=e},Policy.prototype.getAmbientColor=function(){return this.ambientColor},Policy.prototype.setAmbientColor=function(e){this.ambientColor=e},Policy.prototype.getSpecularColor=function(){return this.specularColor},Policy.prototype.setSpecularColor=function(e){this.specularColor=e},Policy.prototype.getSsaoRadius=function(){return this.ssaoRadius},Policy.prototype.setSsaoRadius=function(e){this.ssaoRadius=e};var DataStream=function(e,t,i){this._byteOffset=t||0,e instanceof ArrayBuffer?this.buffer=e:"object"==typeof e?(this.dataView=e,t&&(this._byteOffset+=t)):this.buffer=new ArrayBuffer(e||1),this.position=0,this.endianness=null==i?DataStream.LITTLE_ENDIAN:i};DataStream.prototype={},void 0===Uint8Array.prototype.BYTES_PER_ELEMENT&&(Uint8Array.prototype.BYTES_PER_ELEMENT=Uint8Array.BYTES_PER_ELEMENT,Int8Array.prototype.BYTES_PER_ELEMENT=Int8Array.BYTES_PER_ELEMENT,Uint8ClampedArray.prototype.BYTES_PER_ELEMENT=Uint8ClampedArray.BYTES_PER_ELEMENT,Uint16Array.prototype.BYTES_PER_ELEMENT=Uint16Array.BYTES_PER_ELEMENT,Int16Array.prototype.BYTES_PER_ELEMENT=Int16Array.BYTES_PER_ELEMENT,Uint32Array.prototype.BYTES_PER_ELEMENT=Uint32Array.BYTES_PER_ELEMENT,Int32Array.prototype.BYTES_PER_ELEMENT=Int32Array.BYTES_PER_ELEMENT,Float64Array.prototype.BYTES_PER_ELEMENT=Float64Array.BYTES_PER_ELEMENT),DataStream.prototype.save=function(e){var t=new Blob(this.buffer),i=window.webkitURL||window.URL;if(!i||!i.createObjectURL)throw"DataStream.save: Can't create object URL.";var o=i.createObjectURL(t),r=document.createElement("a");r.setAttribute("href",o),r.setAttribute("download",e),r.click(),i.revokeObjectURL(o)},DataStream.BIG_ENDIAN=!1,DataStream.LITTLE_ENDIAN=!0,DataStream.prototype._dynamicSize=!0,Object.defineProperty(DataStream.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(e){e||this._trimAlloc(),this._dynamicSize=e}}),DataStream.prototype._byteLength=0,Object.defineProperty(DataStream.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(DataStream.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(e){this._buffer=e,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(DataStream.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(e){this._byteOffset=e,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(DataStream.prototype,"dataView",{get:function(){return this._dataView},set:function(e){this._byteOffset=e.byteOffset,this._buffer=e.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+e.byteLength}}),DataStream.prototype._realloc=function(e){if(this._dynamicSize){var t=this._byteOffset+this.position+e,i=this._buffer.byteLength;if(t<=i)t>this._byteLength&&(this._byteLength=t);else{for(i<1&&(i=1);t>i;)i*=2;var o=new ArrayBuffer(i),r=new Uint8Array(this._buffer);new Uint8Array(o,0,r.length).set(r),this.buffer=o,this._byteLength=t}}},DataStream.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var e=new ArrayBuffer(this._byteLength),t=new Uint8Array(e),i=new Uint8Array(this._buffer,0,t.length);t.set(i),this.buffer=e}},DataStream.prototype.seek=function(e){var t=Math.max(0,Math.min(this.byteLength,e));this.position=isNaN(t)||!isFinite(t)?0:t},DataStream.prototype.isEof=function(){return this.position>=this.byteLength},DataStream.prototype.mapInt32Array=function(e,t){this._realloc(4*e);var i=new Int32Array(this._buffer,this.byteOffset+this.position,e);return DataStream.arrayToNative(i,null==t?this.endianness:t),this.position+=4*e,i},DataStream.prototype.mapInt16Array=function(e,t){this._realloc(2*e);var i=new Int16Array(this._buffer,this.byteOffset+this.position,e);return DataStream.arrayToNative(i,null==t?this.endianness:t),this.position+=2*e,i},DataStream.prototype.mapInt8Array=function(e){this._realloc(1*e);var t=new Int8Array(this._buffer,this.byteOffset+this.position,e);return this.position+=1*e,t},DataStream.prototype.mapUint32Array=function(e,t){this._realloc(4*e);var i=new Uint32Array(this._buffer,this.byteOffset+this.position,e);return DataStream.arrayToNative(i,null==t?this.endianness:t),this.position+=4*e,i},DataStream.prototype.mapUint16Array=function(e,t){this._realloc(2*e);var i=new Uint16Array(this._buffer,this.byteOffset+this.position,e);return DataStream.arrayToNative(i,null==t?this.endianness:t),this.position+=2*e,i},DataStream.prototype.mapUint8Array=function(e){this._realloc(1*e);var t=new Uint8Array(this._buffer,this.byteOffset+this.position,e);return this.position+=1*e,t},DataStream.prototype.mapFloat64Array=function(e,t){this._realloc(8*e);var i=new Float64Array(this._buffer,this.byteOffset+this.position,e);return DataStream.arrayToNative(i,null==t?this.endianness:t),this.position+=8*e,i},DataStream.prototype.mapFloat32Array=function(e,t){this._realloc(4*e);var i=new Float32Array(this._buffer,this.byteOffset+this.position,e);return DataStream.arrayToNative(i,null==t?this.endianness:t),this.position+=4*e,i},DataStream.prototype.readInt32Array=function(e,t){e=null==e?this.byteLength-this.position/4:e;var i=new Int32Array(e);return DataStream.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,e*i.BYTES_PER_ELEMENT),DataStream.arrayToNative(i,null==t?this.endianness:t),this.position+=i.byteLength,i},DataStream.prototype.readInt16Array=function(e,t){e=null==e?this.byteLength-this.position/2:e;var i=new Int16Array(e);return DataStream.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,e*i.BYTES_PER_ELEMENT),DataStream.arrayToNative(i,null==t?this.endianness:t),this.position+=i.byteLength,i},DataStream.prototype.readInt8Array=function(e){e=null==e?this.byteLength-this.position:e;var t=new Int8Array(e);return DataStream.memcpy(t.buffer,0,this.buffer,this.byteOffset+this.position,e*t.BYTES_PER_ELEMENT),this.position+=t.byteLength,t},DataStream.prototype.readUint32Array=function(e,t){e=null==e?this.byteLength-this.position/4:e;var i=new Uint32Array(e);return DataStream.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,e*i.BYTES_PER_ELEMENT),DataStream.arrayToNative(i,null==t?this.endianness:t),this.position+=i.byteLength,i},DataStream.prototype.readUint16Array=function(e,t){e=null==e?this.byteLength-this.position/2:e;var i=new Uint16Array(e);return DataStream.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,e*i.BYTES_PER_ELEMENT),DataStream.arrayToNative(i,null==t?this.endianness:t),this.position+=i.byteLength,i},DataStream.prototype.readUint8Array=function(e){e=null==e?this.byteLength-this.position:e;var t=new Uint8Array(e);return DataStream.memcpy(t.buffer,0,this.buffer,this.byteOffset+this.position,e*t.BYTES_PER_ELEMENT),this.position+=t.byteLength,t},DataStream.prototype.readFloat64Array=function(e,t){e=null==e?this.byteLength-this.position/8:e;var i=new Float64Array(e);return DataStream.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,e*i.BYTES_PER_ELEMENT),DataStream.arrayToNative(i,null==t?this.endianness:t),this.position+=i.byteLength,i},DataStream.prototype.readFloat32Array=function(e,t){e=null==e?this.byteLength-this.position/4:e;var i=new Float32Array(e);return DataStream.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,e*i.BYTES_PER_ELEMENT),DataStream.arrayToNative(i,null==t?this.endianness:t),this.position+=i.byteLength,i},DataStream.prototype.writeInt32Array=function(e,t){if(this._realloc(4*e.length),e instanceof Int32Array&&(this.byteOffset+this.position)%e.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,e.byteOffset,e.byteLength),this.mapInt32Array(e.length,t);else for(var i=0;i<e.length;i++)this.writeInt32(e[i],t)},DataStream.prototype.writeInt16Array=function(e,t){if(this._realloc(2*e.length),e instanceof Int16Array&&(this.byteOffset+this.position)%e.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,e.byteOffset,e.byteLength),this.mapInt16Array(e.length,t);else for(var i=0;i<e.length;i++)this.writeInt16(e[i],t)},DataStream.prototype.writeInt8Array=function(e){if(this._realloc(1*e.length),e instanceof Int8Array&&(this.byteOffset+this.position)%e.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,e.byteOffset,e.byteLength),this.mapInt8Array(e.length);else for(var t=0;t<e.length;t++)this.writeInt8(e[t])},DataStream.prototype.writeUint32Array=function(e,t){if(this._realloc(4*e.length),e instanceof Uint32Array&&(this.byteOffset+this.position)%e.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,e.byteOffset,e.byteLength),this.mapUint32Array(e.length,t);else for(var i=0;i<e.length;i++)this.writeUint32(e[i],t)},DataStream.prototype.writeUint16Array=function(e,t){if(this._realloc(2*e.length),e instanceof Uint16Array&&(this.byteOffset+this.position)%e.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,e.byteOffset,e.byteLength),this.mapUint16Array(e.length,t);else for(var i=0;i<e.length;i++)this.writeUint16(e[i],t)},DataStream.prototype.writeUint8Array=function(e){if(this._realloc(1*e.length),e instanceof Uint8Array&&(this.byteOffset+this.position)%e.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,e.byteOffset,e.byteLength),this.mapUint8Array(e.length);else for(var t=0;t<e.length;t++)this.writeUint8(e[t])},DataStream.prototype.writeFloat64Array=function(e,t){if(this._realloc(8*e.length),e instanceof Float64Array&&(this.byteOffset+this.position)%e.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,e.byteOffset,e.byteLength),this.mapFloat64Array(e.length,t);else for(var i=0;i<e.length;i++)this.writeFloat64(e[i],t)},DataStream.prototype.writeFloat32Array=function(e,t){if(this._realloc(4*e.length),e instanceof Float32Array&&(this.byteOffset+this.position)%e.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,e.byteOffset,e.byteLength),this.mapFloat32Array(e.length,t);else for(var i=0;i<e.length;i++)this.writeFloat32(e[i],t)},DataStream.prototype.readInt32=function(e){var t=this._dataView.getInt32(this.position,null==e?this.endianness:e);return this.position+=4,t},DataStream.prototype.readInt16=function(e){var t=this._dataView.getInt16(this.position,null==e?this.endianness:e);return this.position+=2,t},DataStream.prototype.readInt8=function(){var e=this._dataView.getInt8(this.position);return this.position+=1,e},DataStream.prototype.readUint32=function(e){var t=this._dataView.getUint32(this.position,null==e?this.endianness:e);return this.position+=4,t},DataStream.prototype.readUint16=function(e){var t=this._dataView.getUint16(this.position,null==e?this.endianness:e);return this.position+=2,t},DataStream.prototype.readUint8=function(){var e=this._dataView.getUint8(this.position);return this.position+=1,e},DataStream.prototype.readFloat32=function(e){var t=this._dataView.getFloat32(this.position,null==e?this.endianness:e);return this.position+=4,t},DataStream.prototype.readFloat64=function(e){var t=this._dataView.getFloat64(this.position,null==e?this.endianness:e);return this.position+=8,t},DataStream.prototype.writeInt32=function(e,t){this._realloc(4),this._dataView.setInt32(this.position,e,null==t?this.endianness:t),this.position+=4},DataStream.prototype.writeInt16=function(e,t){this._realloc(2),this._dataView.setInt16(this.position,e,null==t?this.endianness:t),this.position+=2},DataStream.prototype.writeInt8=function(e){this._realloc(1),this._dataView.setInt8(this.position,e),this.position+=1},DataStream.prototype.writeUint32=function(e,t){this._realloc(4),this._dataView.setUint32(this.position,e,null==t?this.endianness:t),this.position+=4},DataStream.prototype.writeUint16=function(e,t){this._realloc(2),this._dataView.setUint16(this.position,e,null==t?this.endianness:t),this.position+=2},DataStream.prototype.writeUint8=function(e){this._realloc(1),this._dataView.setUint8(this.position,e),this.position+=1},DataStream.prototype.writeFloat32=function(e,t){this._realloc(4),this._dataView.setFloat32(this.position,e,null==t?this.endianness:t),this.position+=4},DataStream.prototype.writeFloat64=function(e,t){this._realloc(8),this._dataView.setFloat64(this.position,e,null==t?this.endianness:t),this.position+=8},DataStream.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,DataStream.memcpy=function(e,t,i,o,r){var n=new Uint8Array(e,t,r),a=new Uint8Array(i,o,r);n.set(a)},DataStream.arrayToNative=function(e,t){return t==this.endianness?e:this.flipArrayEndianness(e)},DataStream.nativeToEndian=function(e,t){return this.endianness==t?e:this.flipArrayEndianness(e)},DataStream.flipArrayEndianness=function(e){for(var t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),i=0;i<e.byteLength;i+=e.BYTES_PER_ELEMENT)for(var o=i+e.BYTES_PER_ELEMENT-1,r=i;o>r;o--,r++){var n=t[r];t[r]=t[o],t[o]=n}return e},DataStream.createStringFromArray=function(e){for(var t=[],i=0;i<e.length;i+=32768)t.push(String.fromCharCode.apply(null,e.subarray(i,i+32768)));return t.join("")},DataStream.prototype.failurePosition=0,DataStream.prototype.readStruct=function(e){for(var t,i,o={},r=this.position,n=0;n<e.length;n+=2){if(t=e[n+1],null==(i=this.readType(t,o)))return 0==this.failurePosition&&(this.failurePosition=this.position),this.position=r,null;o[e[n]]=i}return o},DataStream.prototype.readUCS2String=function(e,t){return DataStream.createStringFromArray(this.readUint16Array(e,t))},DataStream.prototype.writeUCS2String=function(e,t,i){null==i&&(i=e.length);for(var o=0;o<e.length&&o<i;o++)this.writeUint16(e.charCodeAt(o),t);for(;o<i;o++)this.writeUint16(0)},DataStream.prototype.readString=function(e,t){return null==t||"ASCII"==t?DataStream.createStringFromArray(this.mapUint8Array(null==e?this.byteLength-this.position:e)):new TextDecoder(t).decode(this.mapUint8Array(e))},DataStream.prototype.writeString=function(e,t,i){if(null==t||"ASCII"==t)if(null!=i){var o=0,r=Math.min(e.length,i);for(o=0;o<r;o++)this.writeUint8(e.charCodeAt(o));for(;o<i;o++)this.writeUint8(0)}else for(o=0;o<e.length;o++)this.writeUint8(e.charCodeAt(o));else this.writeUint8Array(new TextEncoder(t).encode(e.substring(0,i)))},DataStream.prototype.readCString=function(e){var t=this.byteLength-this.position,i=new Uint8Array(this._buffer,this._byteOffset+this.position),o=t;null!=e&&(o=Math.min(e,t));for(var r=0;r<o&&0!=i[r];r++);var n=DataStream.createStringFromArray(this.mapUint8Array(r));return null!=e?this.position+=o-r:r!=t&&(this.position+=1),n},DataStream.prototype.writeCString=function(e,t){if(null!=t){var i=0,o=Math.min(e.length,t);for(i=0;i<o;i++)this.writeUint8(e.charCodeAt(i));for(;i<t;i++)this.writeUint8(0)}else{for(i=0;i<e.length;i++)this.writeUint8(e.charCodeAt(i));this.writeUint8(0)}},DataStream.prototype.readType=function(e,t){if("function"==typeof e)return e(this,t);if(!("object"!=typeof e||e instanceof Array))return e.get(this,t);if(e instanceof Array&&3!=e.length)return this.readStruct(e,t);var i,o=null,r=null,n="ASCII",a=this.position;"string"==typeof e&&/:/.test(e)&&(e=(i=e.split(":"))[0],r=null!=t[s=i[1]]?parseInt(t[s]):parseInt(i[1]));"string"==typeof e&&/,/.test(e)&&(e=(i=e.split(","))[0],n=parseInt(i[1]));switch(e){case"uint8":o=this.readUint8();break;case"int8":o=this.readInt8();break;case"uint16":o=this.readUint16(this.endianness);break;case"int16":o=this.readInt16(this.endianness);break;case"uint32":o=this.readUint32(this.endianness);break;case"int32":o=this.readInt32(this.endianness);break;case"float32":o=this.readFloat32(this.endianness);break;case"float64":o=this.readFloat64(this.endianness);break;case"uint16be":o=this.readUint16(DataStream.BIG_ENDIAN);break;case"int16be":o=this.readInt16(DataStream.BIG_ENDIAN);break;case"uint32be":o=this.readUint32(DataStream.BIG_ENDIAN);break;case"int32be":o=this.readInt32(DataStream.BIG_ENDIAN);break;case"float32be":o=this.readFloat32(DataStream.BIG_ENDIAN);break;case"float64be":o=this.readFloat64(DataStream.BIG_ENDIAN);break;case"uint16le":o=this.readUint16(DataStream.LITTLE_ENDIAN);break;case"int16le":o=this.readInt16(DataStream.LITTLE_ENDIAN);break;case"uint32le":o=this.readUint32(DataStream.LITTLE_ENDIAN);break;case"int32le":o=this.readInt32(DataStream.LITTLE_ENDIAN);break;case"float32le":o=this.readFloat32(DataStream.LITTLE_ENDIAN);break;case"float64le":o=this.readFloat64(DataStream.LITTLE_ENDIAN);break;case"cstring":o=this.readCString(r);break;case"string":o=this.readString(r,n);break;case"u16string":o=this.readUCS2String(r,this.endianness);break;case"u16stringle":o=this.readUCS2String(r,DataStream.LITTLE_ENDIAN);break;case"u16stringbe":o=this.readUCS2String(r,DataStream.BIG_ENDIAN);break;default:if(3==e.length){var s,l=e[1],c=0;if(c="function"==typeof(s=e[2])?s(t,this,e):"string"==typeof s&&null!=t[s]?parseInt(t[s]):parseInt(s),"string"==typeof l){var h=l.replace(/(le|be)$/,""),d=null;switch(/le$/.test(l)?d=DataStream.LITTLE_ENDIAN:/be$/.test(l)&&(d=DataStream.BIG_ENDIAN),"*"==s&&(c=null),h){case"uint8":o=this.readUint8Array(c);break;case"uint16":o=this.readUint16Array(c,d);break;case"uint32":o=this.readUint32Array(c,d);break;case"int8":o=this.readInt8Array(c);break;case"int16":o=this.readInt16Array(c,d);break;case"int32":o=this.readInt32Array(c,d);break;case"float32":o=this.readFloat32Array(c,d);break;case"float64":o=this.readFloat64Array(c,d);break;case"cstring":case"utf16string":case"string":if(null==c)for(o=[];!this.isEof();){if(null==(p=this.readType(l,t)))break;o.push(p)}else{o=new Array(c);for(var u=0;u<c;u++)o[u]=this.readType(l,t)}}}else if("*"==s)for(o=[],this.buffer;;){var f=this.position;try{var g=this.readType(l,t);if(null==g){this.position=f;break}o.push(g)}catch(e){this.position=f;break}}else{o=new Array(c);for(u=0;u<c;u++){var p;if(null==(p=this.readType(l,t)))return null;o[u]=p}}break}}return null!=r&&(this.position=a+r),o},DataStream.prototype.writeStruct=function(e,t){for(var i=0;i<e.length;i+=2){var o=e[i+1];this.writeType(o,t[e[i]],t)}},DataStream.prototype.writeType=function(e,t,i){if("function"==typeof e)return e(this,t);if("object"==typeof e&&!(e instanceof Array))return e.set(this,t,i);var o,r=null,n="ASCII",a=this.position;"string"==typeof e&&/:/.test(e)&&(e=(o=e.split(":"))[0],r=parseInt(o[1]));"string"==typeof e&&/,/.test(e)&&(e=(o=e.split(","))[0],n=parseInt(o[1]));switch(e){case"uint8":this.writeUint8(t);break;case"int8":this.writeInt8(t);break;case"uint16":this.writeUint16(t,this.endianness);break;case"int16":this.writeInt16(t,this.endianness);break;case"uint32":this.writeUint32(t,this.endianness);break;case"int32":this.writeInt32(t,this.endianness);break;case"float32":this.writeFloat32(t,this.endianness);break;case"float64":this.writeFloat64(t,this.endianness);break;case"uint16be":this.writeUint16(t,DataStream.BIG_ENDIAN);break;case"int16be":this.writeInt16(t,DataStream.BIG_ENDIAN);break;case"uint32be":this.writeUint32(t,DataStream.BIG_ENDIAN);break;case"int32be":this.writeInt32(t,DataStream.BIG_ENDIAN);break;case"float32be":this.writeFloat32(t,DataStream.BIG_ENDIAN);break;case"float64be":this.writeFloat64(t,DataStream.BIG_ENDIAN);break;case"uint16le":this.writeUint16(t,DataStream.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(t,DataStream.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(t,DataStream.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(t,DataStream.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(t,DataStream.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(t,DataStream.LITTLE_ENDIAN);break;case"cstring":this.writeCString(t,r);break;case"string":this.writeString(t,n,r);break;case"u16string":this.writeUCS2String(t,this.endianness,r);break;case"u16stringle":this.writeUCS2String(t,DataStream.LITTLE_ENDIAN,r);break;case"u16stringbe":this.writeUCS2String(t,DataStream.BIG_ENDIAN,r);break;default:if(3==e.length){for(var s=e[1],l=0;l<t.length;l++)this.writeType(s,t[l]);break}this.writeStruct(e,t)}null!=r&&(this.position=a,this._realloc(r),this.position=a+r)},"function"==typeof define&&define.amd&&define("DataStream",[],function(){return DataStream}),"object"==typeof module&&module&&module.exports&&(module.exports=DataStream),function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var i=t();for(var o in i)("object"==typeof exports?exports:e)[o]=i[o]}}(this,function(){return function(e){var t={};function i(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.d=function(e,t,o){i.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=4)}([function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.setMatrixArrayType=function(e){t.ARRAY_TYPE=e},t.toRadian=function(e){return e*r},t.equals=function(e,t){return Math.abs(e-t)<=o*Math.max(1,Math.abs(e),Math.abs(t))};var o=t.EPSILON=1e-6;t.ARRAY_TYPE="undefined"!=typeof Float32Array?Float32Array:Array,t.RANDOM=Math.random;var r=Math.PI/180},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.sub=t.mul=void 0,t.create=function(){var e=new o.ARRAY_TYPE(9);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},t.fromMat4=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},t.clone=function(e){var t=new o.ARRAY_TYPE(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},t.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},t.fromValues=function(e,t,i,r,n,a,s,l,c){var h=new o.ARRAY_TYPE(9);return h[0]=e,h[1]=t,h[2]=i,h[3]=r,h[4]=n,h[5]=a,h[6]=s,h[7]=l,h[8]=c,h},t.set=function(e,t,i,o,r,n,a,s,l,c){return e[0]=t,e[1]=i,e[2]=o,e[3]=r,e[4]=n,e[5]=a,e[6]=s,e[7]=l,e[8]=c,e},t.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},t.transpose=function(e,t){if(e===t){var i=t[1],o=t[2],r=t[5];e[1]=t[3],e[2]=t[6],e[3]=i,e[5]=t[7],e[6]=o,e[7]=r}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},t.invert=function(e,t){var i=t[0],o=t[1],r=t[2],n=t[3],a=t[4],s=t[5],l=t[6],c=t[7],h=t[8],d=h*a-s*c,u=-h*n+s*l,f=c*n-a*l,g=i*d+o*u+r*f;if(!g)return null;return g=1/g,e[0]=d*g,e[1]=(-h*o+r*c)*g,e[2]=(s*o-r*a)*g,e[3]=u*g,e[4]=(h*i-r*l)*g,e[5]=(-s*i+r*n)*g,e[6]=f*g,e[7]=(-c*i+o*l)*g,e[8]=(a*i-o*n)*g,e},t.adjoint=function(e,t){var i=t[0],o=t[1],r=t[2],n=t[3],a=t[4],s=t[5],l=t[6],c=t[7],h=t[8];return e[0]=a*h-s*c,e[1]=r*c-o*h,e[2]=o*s-r*a,e[3]=s*l-n*h,e[4]=i*h-r*l,e[5]=r*n-i*s,e[6]=n*c-a*l,e[7]=o*l-i*c,e[8]=i*a-o*n,e},t.determinant=function(e){var t=e[0],i=e[1],o=e[2],r=e[3],n=e[4],a=e[5],s=e[6],l=e[7],c=e[8];return t*(c*n-a*l)+i*(-c*r+a*s)+o*(l*r-n*s)},t.multiply=r,t.translate=function(e,t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=t[4],l=t[5],c=t[6],h=t[7],d=t[8],u=i[0],f=i[1];return e[0]=o,e[1]=r,e[2]=n,e[3]=a,e[4]=s,e[5]=l,e[6]=u*o+f*a+c,e[7]=u*r+f*s+h,e[8]=u*n+f*l+d,e},t.rotate=function(e,t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=t[4],l=t[5],c=t[6],h=t[7],d=t[8],u=Math.sin(i),f=Math.cos(i);return e[0]=f*o+u*a,e[1]=f*r+u*s,e[2]=f*n+u*l,e[3]=f*a-u*o,e[4]=f*s-u*r,e[5]=f*l-u*n,e[6]=c,e[7]=h,e[8]=d,e},t.scale=function(e,t,i){var o=i[0],r=i[1];return e[0]=o*t[0],e[1]=o*t[1],e[2]=o*t[2],e[3]=r*t[3],e[4]=r*t[4],e[5]=r*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},t.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e},t.fromRotation=function(e,t){var i=Math.sin(t),o=Math.cos(t);return e[0]=o,e[1]=i,e[2]=0,e[3]=-i,e[4]=o,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},t.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},t.fromMat2d=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e},t.fromQuat=function(e,t){var i=t[0],o=t[1],r=t[2],n=t[3],a=i+i,s=o+o,l=r+r,c=i*a,h=o*a,d=o*s,u=r*a,f=r*s,g=r*l,p=n*a,m=n*s,y=n*l;return e[0]=1-d-g,e[3]=h-y,e[6]=u+m,e[1]=h+y,e[4]=1-c-g,e[7]=f-p,e[2]=u-m,e[5]=f+p,e[8]=1-c-d,e},t.normalFromMat4=function(e,t){var i=t[0],o=t[1],r=t[2],n=t[3],a=t[4],s=t[5],l=t[6],c=t[7],h=t[8],d=t[9],u=t[10],f=t[11],g=t[12],p=t[13],m=t[14],y=t[15],v=i*s-o*a,x=i*l-r*a,b=i*c-n*a,C=o*l-r*s,M=o*c-n*s,_=r*c-n*l,A=h*p-d*g,R=h*m-u*g,P=h*y-f*g,T=d*m-u*p,L=d*y-f*p,S=u*y-f*m,w=v*S-x*L+b*T+C*P-M*R+_*A;if(!w)return null;return w=1/w,e[0]=(s*S-l*L+c*T)*w,e[1]=(l*P-a*S-c*R)*w,e[2]=(a*L-s*P+c*A)*w,e[3]=(r*L-o*S-n*T)*w,e[4]=(i*S-r*P+n*R)*w,e[5]=(o*P-i*L-n*A)*w,e[6]=(p*_-m*M+y*C)*w,e[7]=(m*b-g*_-y*x)*w,e[8]=(g*M-p*b+y*v)*w,e},t.projection=function(e,t,i){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/i,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e},t.str=function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},t.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2))},t.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e[4]=t[4]+i[4],e[5]=t[5]+i[5],e[6]=t[6]+i[6],e[7]=t[7]+i[7],e[8]=t[8]+i[8],e},t.subtract=n,t.multiplyScalar=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*i,e},t.multiplyScalarAndAdd=function(e,t,i,o){return e[0]=t[0]+i[0]*o,e[1]=t[1]+i[1]*o,e[2]=t[2]+i[2]*o,e[3]=t[3]+i[3]*o,e[4]=t[4]+i[4]*o,e[5]=t[5]+i[5]*o,e[6]=t[6]+i[6]*o,e[7]=t[7]+i[7]*o,e[8]=t[8]+i[8]*o,e},t.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]},t.equals=function(e,t){var i=e[0],r=e[1],n=e[2],a=e[3],s=e[4],l=e[5],c=e[6],h=e[7],d=e[8],u=t[0],f=t[1],g=t[2],p=t[3],m=t[4],y=t[5],v=t[6],x=t[7],b=t[8];return Math.abs(i-u)<=o.EPSILON*Math.max(1,Math.abs(i),Math.abs(u))&&Math.abs(r-f)<=o.EPSILON*Math.max(1,Math.abs(r),Math.abs(f))&&Math.abs(n-g)<=o.EPSILON*Math.max(1,Math.abs(n),Math.abs(g))&&Math.abs(a-p)<=o.EPSILON*Math.max(1,Math.abs(a),Math.abs(p))&&Math.abs(s-m)<=o.EPSILON*Math.max(1,Math.abs(s),Math.abs(m))&&Math.abs(l-y)<=o.EPSILON*Math.max(1,Math.abs(l),Math.abs(y))&&Math.abs(c-v)<=o.EPSILON*Math.max(1,Math.abs(c),Math.abs(v))&&Math.abs(h-x)<=o.EPSILON*Math.max(1,Math.abs(h),Math.abs(x))&&Math.abs(d-b)<=o.EPSILON*Math.max(1,Math.abs(d),Math.abs(b))};var o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}(i(0));function r(e,t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=t[4],l=t[5],c=t[6],h=t[7],d=t[8],u=i[0],f=i[1],g=i[2],p=i[3],m=i[4],y=i[5],v=i[6],x=i[7],b=i[8];return e[0]=u*o+f*a+g*c,e[1]=u*r+f*s+g*h,e[2]=u*n+f*l+g*d,e[3]=p*o+m*a+y*c,e[4]=p*r+m*s+y*h,e[5]=p*n+m*l+y*d,e[6]=v*o+x*a+b*c,e[7]=v*r+x*s+b*h,e[8]=v*n+x*l+b*d,e}function n(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e[4]=t[4]-i[4],e[5]=t[5]-i[5],e[6]=t[6]-i[6],e[7]=t[7]-i[7],e[8]=t[8]-i[8],e}t.mul=r,t.sub=n},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.forEach=t.sqrLen=t.len=t.sqrDist=t.dist=t.div=t.mul=t.sub=void 0,t.create=r,t.clone=function(e){var t=new o.ARRAY_TYPE(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},t.length=n,t.fromValues=a,t.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},t.set=function(e,t,i,o){return e[0]=t,e[1]=i,e[2]=o,e},t.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e},t.subtract=s,t.multiply=l,t.divide=c,t.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e},t.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e},t.min=function(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e},t.max=function(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e},t.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e},t.scale=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e},t.scaleAndAdd=function(e,t,i,o){return e[0]=t[0]+i[0]*o,e[1]=t[1]+i[1]*o,e[2]=t[2]+i[2]*o,e},t.distance=h,t.squaredDistance=d,t.squaredLength=u,t.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},t.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e},t.normalize=f,t.dot=g,t.cross=function(e,t,i){var o=t[0],r=t[1],n=t[2],a=i[0],s=i[1],l=i[2];return e[0]=r*l-n*s,e[1]=n*a-o*l,e[2]=o*s-r*a,e},t.lerp=function(e,t,i,o){var r=t[0],n=t[1],a=t[2];return e[0]=r+o*(i[0]-r),e[1]=n+o*(i[1]-n),e[2]=a+o*(i[2]-a),e},t.hermite=function(e,t,i,o,r,n){var a=n*n,s=a*(2*n-3)+1,l=a*(n-2)+n,c=a*(n-1),h=a*(3-2*n);return e[0]=t[0]*s+i[0]*l+o[0]*c+r[0]*h,e[1]=t[1]*s+i[1]*l+o[1]*c+r[1]*h,e[2]=t[2]*s+i[2]*l+o[2]*c+r[2]*h,e},t.bezier=function(e,t,i,o,r,n){var a=1-n,s=a*a,l=n*n,c=s*a,h=3*n*s,d=3*l*a,u=l*n;return e[0]=t[0]*c+i[0]*h+o[0]*d+r[0]*u,e[1]=t[1]*c+i[1]*h+o[1]*d+r[1]*u,e[2]=t[2]*c+i[2]*h+o[2]*d+r[2]*u,e},t.random=function(e,t){t=t||1;var i=2*o.RANDOM()*Math.PI,r=2*o.RANDOM()-1,n=Math.sqrt(1-r*r)*t;return e[0]=Math.cos(i)*n,e[1]=Math.sin(i)*n,e[2]=r*t,e},t.transformMat4=function(e,t,i){var o=t[0],r=t[1],n=t[2],a=i[3]*o+i[7]*r+i[11]*n+i[15];return a=a||1,e[0]=(i[0]*o+i[4]*r+i[8]*n+i[12])/a,e[1]=(i[1]*o+i[5]*r+i[9]*n+i[13])/a,e[2]=(i[2]*o+i[6]*r+i[10]*n+i[14])/a,e},t.transformMat3=function(e,t,i){var o=t[0],r=t[1],n=t[2];return e[0]=o*i[0]+r*i[3]+n*i[6],e[1]=o*i[1]+r*i[4]+n*i[7],e[2]=o*i[2]+r*i[5]+n*i[8],e},t.transformQuat=function(e,t,i){var o=t[0],r=t[1],n=t[2],a=i[0],s=i[1],l=i[2],c=i[3],h=c*o+s*n-l*r,d=c*r+l*o-a*n,u=c*n+a*r-s*o,f=-a*o-s*r-l*n;return e[0]=h*c+f*-a+d*-l-u*-s,e[1]=d*c+f*-s+u*-a-h*-l,e[2]=u*c+f*-l+h*-s-d*-a,e},t.rotateX=function(e,t,i,o){var r=[],n=[];return r[0]=t[0]-i[0],r[1]=t[1]-i[1],r[2]=t[2]-i[2],n[0]=r[0],n[1]=r[1]*Math.cos(o)-r[2]*Math.sin(o),n[2]=r[1]*Math.sin(o)+r[2]*Math.cos(o),e[0]=n[0]+i[0],e[1]=n[1]+i[1],e[2]=n[2]+i[2],e},t.rotateY=function(e,t,i,o){var r=[],n=[];return r[0]=t[0]-i[0],r[1]=t[1]-i[1],r[2]=t[2]-i[2],n[0]=r[2]*Math.sin(o)+r[0]*Math.cos(o),n[1]=r[1],n[2]=r[2]*Math.cos(o)-r[0]*Math.sin(o),e[0]=n[0]+i[0],e[1]=n[1]+i[1],e[2]=n[2]+i[2],e},t.rotateZ=function(e,t,i,o){var r=[],n=[];return r[0]=t[0]-i[0],r[1]=t[1]-i[1],r[2]=t[2]-i[2],n[0]=r[0]*Math.cos(o)-r[1]*Math.sin(o),n[1]=r[0]*Math.sin(o)+r[1]*Math.cos(o),n[2]=r[2],e[0]=n[0]+i[0],e[1]=n[1]+i[1],e[2]=n[2]+i[2],e},t.angle=function(e,t){var i=a(e[0],e[1],e[2]),o=a(t[0],t[1],t[2]);f(i,i),f(o,o);var r=g(i,o);return r>1?0:r<-1?Math.PI:Math.acos(r)},t.str=function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},t.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]},t.equals=function(e,t){var i=e[0],r=e[1],n=e[2],a=t[0],s=t[1],l=t[2];return Math.abs(i-a)<=o.EPSILON*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-s)<=o.EPSILON*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(n-l)<=o.EPSILON*Math.max(1,Math.abs(n),Math.abs(l))};var o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}(i(0));function r(){var e=new o.ARRAY_TYPE(3);return e[0]=0,e[1]=0,e[2]=0,e}function n(e){var t=e[0],i=e[1],o=e[2];return Math.sqrt(t*t+i*i+o*o)}function a(e,t,i){var r=new o.ARRAY_TYPE(3);return r[0]=e,r[1]=t,r[2]=i,r}function s(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e}function l(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e}function c(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e}function h(e,t){var i=t[0]-e[0],o=t[1]-e[1],r=t[2]-e[2];return Math.sqrt(i*i+o*o+r*r)}function d(e,t){var i=t[0]-e[0],o=t[1]-e[1],r=t[2]-e[2];return i*i+o*o+r*r}function u(e){var t=e[0],i=e[1],o=e[2];return t*t+i*i+o*o}function f(e,t){var i=t[0],o=t[1],r=t[2],n=i*i+o*o+r*r;return n>0&&(n=1/Math.sqrt(n),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n),e}function g(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}var p;t.sub=s,t.mul=l,t.div=c,t.dist=h,t.sqrDist=d,t.len=n,t.sqrLen=u,t.forEach=(p=r(),function(e,t,i,o,r,n){var a=void 0,s=void 0;for(t||(t=3),i||(i=0),s=o?Math.min(o*t+i,e.length):e.length,a=i;a<s;a+=t)p[0]=e[a],p[1]=e[a+1],p[2]=e[a+2],r(p,p,n),e[a]=p[0],e[a+1]=p[1],e[a+2]=p[2];return e})},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.forEach=t.sqrLen=t.len=t.sqrDist=t.dist=t.div=t.mul=t.sub=void 0,t.create=r,t.clone=function(e){var t=new o.ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},t.fromValues=function(e,t,i,r){var n=new o.ARRAY_TYPE(4);return n[0]=e,n[1]=t,n[2]=i,n[3]=r,n},t.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},t.set=function(e,t,i,o,r){return e[0]=t,e[1]=i,e[2]=o,e[3]=r,e},t.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e},t.subtract=n,t.multiply=a,t.divide=s,t.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e},t.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e},t.min=function(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e[3]=Math.min(t[3],i[3]),e},t.max=function(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e[3]=Math.max(t[3],i[3]),e},t.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e},t.scale=l,t.scaleAndAdd=function(e,t,i,o){return e[0]=t[0]+i[0]*o,e[1]=t[1]+i[1]*o,e[2]=t[2]+i[2]*o,e[3]=t[3]+i[3]*o,e},t.distance=c,t.squaredDistance=h,t.length=d,t.squaredLength=u,t.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},t.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e},t.normalize=f,t.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},t.lerp=function(e,t,i,o){var r=t[0],n=t[1],a=t[2],s=t[3];return e[0]=r+o*(i[0]-r),e[1]=n+o*(i[1]-n),e[2]=a+o*(i[2]-a),e[3]=s+o*(i[3]-s),e},t.random=function(e,t){return t=t||1,e[0]=o.RANDOM(),e[1]=o.RANDOM(),e[2]=o.RANDOM(),e[3]=o.RANDOM(),f(e,e),l(e,e,t),e},t.transformMat4=function(e,t,i){var o=t[0],r=t[1],n=t[2],a=t[3];return e[0]=i[0]*o+i[4]*r+i[8]*n+i[12]*a,e[1]=i[1]*o+i[5]*r+i[9]*n+i[13]*a,e[2]=i[2]*o+i[6]*r+i[10]*n+i[14]*a,e[3]=i[3]*o+i[7]*r+i[11]*n+i[15]*a,e},t.transformQuat=function(e,t,i){var o=t[0],r=t[1],n=t[2],a=i[0],s=i[1],l=i[2],c=i[3],h=c*o+s*n-l*r,d=c*r+l*o-a*n,u=c*n+a*r-s*o,f=-a*o-s*r-l*n;return e[0]=h*c+f*-a+d*-l-u*-s,e[1]=d*c+f*-s+u*-a-h*-l,e[2]=u*c+f*-l+h*-s-d*-a,e[3]=t[3],e},t.str=function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},t.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},t.equals=function(e,t){var i=e[0],r=e[1],n=e[2],a=e[3],s=t[0],l=t[1],c=t[2],h=t[3];return Math.abs(i-s)<=o.EPSILON*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(r-l)<=o.EPSILON*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(n-c)<=o.EPSILON*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(a-h)<=o.EPSILON*Math.max(1,Math.abs(a),Math.abs(h))};var o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}(i(0));function r(){var e=new o.ARRAY_TYPE(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e}function n(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}function a(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e[3]=t[3]*i[3],e}function s(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e[3]=t[3]/i[3],e}function l(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e}function c(e,t){var i=t[0]-e[0],o=t[1]-e[1],r=t[2]-e[2],n=t[3]-e[3];return Math.sqrt(i*i+o*o+r*r+n*n)}function h(e,t){var i=t[0]-e[0],o=t[1]-e[1],r=t[2]-e[2],n=t[3]-e[3];return i*i+o*o+r*r+n*n}function d(e){var t=e[0],i=e[1],o=e[2],r=e[3];return Math.sqrt(t*t+i*i+o*o+r*r)}function u(e){var t=e[0],i=e[1],o=e[2],r=e[3];return t*t+i*i+o*o+r*r}function f(e,t){var i=t[0],o=t[1],r=t[2],n=t[3],a=i*i+o*o+r*r+n*n;return a>0&&(a=1/Math.sqrt(a),e[0]=i*a,e[1]=o*a,e[2]=r*a,e[3]=n*a),e}var g;t.sub=n,t.mul=a,t.div=s,t.dist=c,t.sqrDist=h,t.len=d,t.sqrLen=u,t.forEach=(g=r(),function(e,t,i,o,r,n){var a=void 0,s=void 0;for(t||(t=4),i||(i=0),s=o?Math.min(o*t+i,e.length):e.length,a=i;a<s;a+=t)g[0]=e[a],g[1]=e[a+1],g[2]=e[a+2],g[3]=e[a+3],r(g,g,n),e[a]=g[0],e[a+1]=g[1],e[a+2]=g[2],e[a+3]=g[3];return e})},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.vec4=t.vec3=t.vec2=t.quat=t.mat4=t.mat3=t.mat2d=t.mat2=t.glMatrix=void 0;var o=u(i(0)),r=u(i(5)),n=u(i(6)),a=u(i(1)),s=u(i(7)),l=u(i(8)),c=u(i(9)),h=u(i(2)),d=u(i(3));function u(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}t.glMatrix=o,t.mat2=r,t.mat2d=n,t.mat3=a,t.mat4=s,t.quat=l,t.vec2=c,t.vec3=h,t.vec4=d},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.sub=t.mul=void 0,t.create=function(){var e=new o.ARRAY_TYPE(4);return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},t.clone=function(e){var t=new o.ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},t.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},t.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},t.fromValues=function(e,t,i,r){var n=new o.ARRAY_TYPE(4);return n[0]=e,n[1]=t,n[2]=i,n[3]=r,n},t.set=function(e,t,i,o,r){return e[0]=t,e[1]=i,e[2]=o,e[3]=r,e},t.transpose=function(e,t){if(e===t){var i=t[1];e[1]=t[2],e[2]=i}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},t.invert=function(e,t){var i=t[0],o=t[1],r=t[2],n=t[3],a=i*n-r*o;if(!a)return null;return a=1/a,e[0]=n*a,e[1]=-o*a,e[2]=-r*a,e[3]=i*a,e},t.adjoint=function(e,t){var i=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=i,e},t.determinant=function(e){return e[0]*e[3]-e[2]*e[1]},t.multiply=r,t.rotate=function(e,t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=Math.sin(i),l=Math.cos(i);return e[0]=o*l+n*s,e[1]=r*l+a*s,e[2]=o*-s+n*l,e[3]=r*-s+a*l,e},t.scale=function(e,t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=i[0],l=i[1];return e[0]=o*s,e[1]=r*s,e[2]=n*l,e[3]=a*l,e},t.fromRotation=function(e,t){var i=Math.sin(t),o=Math.cos(t);return e[0]=o,e[1]=i,e[2]=-i,e[3]=o,e},t.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},t.str=function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},t.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2))},t.LDU=function(e,t,i,o){return e[2]=o[2]/o[0],i[0]=o[0],i[1]=o[1],i[3]=o[3]-e[2]*i[1],[e,t,i]},t.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e},t.subtract=n,t.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},t.equals=function(e,t){var i=e[0],r=e[1],n=e[2],a=e[3],s=t[0],l=t[1],c=t[2],h=t[3];return Math.abs(i-s)<=o.EPSILON*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(r-l)<=o.EPSILON*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(n-c)<=o.EPSILON*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(a-h)<=o.EPSILON*Math.max(1,Math.abs(a),Math.abs(h))},t.multiplyScalar=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e},t.multiplyScalarAndAdd=function(e,t,i,o){return e[0]=t[0]+i[0]*o,e[1]=t[1]+i[1]*o,e[2]=t[2]+i[2]*o,e[3]=t[3]+i[3]*o,e};var o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}(i(0));function r(e,t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=i[0],l=i[1],c=i[2],h=i[3];return e[0]=o*s+n*l,e[1]=r*s+a*l,e[2]=o*c+n*h,e[3]=r*c+a*h,e}function n(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}t.mul=r,t.sub=n},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.sub=t.mul=void 0,t.create=function(){var e=new o.ARRAY_TYPE(6);return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},t.clone=function(e){var t=new o.ARRAY_TYPE(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},t.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},t.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},t.fromValues=function(e,t,i,r,n,a){var s=new o.ARRAY_TYPE(6);return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s[4]=n,s[5]=a,s},t.set=function(e,t,i,o,r,n,a){return e[0]=t,e[1]=i,e[2]=o,e[3]=r,e[4]=n,e[5]=a,e},t.invert=function(e,t){var i=t[0],o=t[1],r=t[2],n=t[3],a=t[4],s=t[5],l=i*n-o*r;if(!l)return null;return l=1/l,e[0]=n*l,e[1]=-o*l,e[2]=-r*l,e[3]=i*l,e[4]=(r*s-n*a)*l,e[5]=(o*a-i*s)*l,e},t.determinant=function(e){return e[0]*e[3]-e[1]*e[2]},t.multiply=r,t.rotate=function(e,t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=t[4],l=t[5],c=Math.sin(i),h=Math.cos(i);return e[0]=o*h+n*c,e[1]=r*h+a*c,e[2]=o*-c+n*h,e[3]=r*-c+a*h,e[4]=s,e[5]=l,e},t.scale=function(e,t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=t[4],l=t[5],c=i[0],h=i[1];return e[0]=o*c,e[1]=r*c,e[2]=n*h,e[3]=a*h,e[4]=s,e[5]=l,e},t.translate=function(e,t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=t[4],l=t[5],c=i[0],h=i[1];return e[0]=o,e[1]=r,e[2]=n,e[3]=a,e[4]=o*c+n*h+s,e[5]=r*c+a*h+l,e},t.fromRotation=function(e,t){var i=Math.sin(t),o=Math.cos(t);return e[0]=o,e[1]=i,e[2]=-i,e[3]=o,e[4]=0,e[5]=0,e},t.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e[4]=0,e[5]=0,e},t.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=t[0],e[5]=t[1],e},t.str=function(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},t.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+1)},t.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e[4]=t[4]+i[4],e[5]=t[5]+i[5],e},t.subtract=n,t.multiplyScalar=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*i,e[5]=t[5]*i,e},t.multiplyScalarAndAdd=function(e,t,i,o){return e[0]=t[0]+i[0]*o,e[1]=t[1]+i[1]*o,e[2]=t[2]+i[2]*o,e[3]=t[3]+i[3]*o,e[4]=t[4]+i[4]*o,e[5]=t[5]+i[5]*o,e},t.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]},t.equals=function(e,t){var i=e[0],r=e[1],n=e[2],a=e[3],s=e[4],l=e[5],c=t[0],h=t[1],d=t[2],u=t[3],f=t[4],g=t[5];return Math.abs(i-c)<=o.EPSILON*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(r-h)<=o.EPSILON*Math.max(1,Math.abs(r),Math.abs(h))&&Math.abs(n-d)<=o.EPSILON*Math.max(1,Math.abs(n),Math.abs(d))&&Math.abs(a-u)<=o.EPSILON*Math.max(1,Math.abs(a),Math.abs(u))&&Math.abs(s-f)<=o.EPSILON*Math.max(1,Math.abs(s),Math.abs(f))&&Math.abs(l-g)<=o.EPSILON*Math.max(1,Math.abs(l),Math.abs(g))};var o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}(i(0));function r(e,t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=t[4],l=t[5],c=i[0],h=i[1],d=i[2],u=i[3],f=i[4],g=i[5];return e[0]=o*c+n*h,e[1]=r*c+a*h,e[2]=o*d+n*u,e[3]=r*d+a*u,e[4]=o*f+n*g+s,e[5]=r*f+a*g+l,e}function n(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e[4]=t[4]-i[4],e[5]=t[5]-i[5],e}t.mul=r,t.sub=n},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.sub=t.mul=void 0,t.create=function(){var e=new o.ARRAY_TYPE(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},t.clone=function(e){var t=new o.ARRAY_TYPE(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},t.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},t.fromValues=function(e,t,i,r,n,a,s,l,c,h,d,u,f,g,p,m){var y=new o.ARRAY_TYPE(16);return y[0]=e,y[1]=t,y[2]=i,y[3]=r,y[4]=n,y[5]=a,y[6]=s,y[7]=l,y[8]=c,y[9]=h,y[10]=d,y[11]=u,y[12]=f,y[13]=g,y[14]=p,y[15]=m,y},t.set=function(e,t,i,o,r,n,a,s,l,c,h,d,u,f,g,p,m){return e[0]=t,e[1]=i,e[2]=o,e[3]=r,e[4]=n,e[5]=a,e[6]=s,e[7]=l,e[8]=c,e[9]=h,e[10]=d,e[11]=u,e[12]=f,e[13]=g,e[14]=p,e[15]=m,e},t.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},t.transpose=function(e,t){if(e===t){var i=t[1],o=t[2],r=t[3],n=t[6],a=t[7],s=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=i,e[6]=t[9],e[7]=t[13],e[8]=o,e[9]=n,e[11]=t[14],e[12]=r,e[13]=a,e[14]=s}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},t.invert=function(e,t){var i=t[0],o=t[1],r=t[2],n=t[3],a=t[4],s=t[5],l=t[6],c=t[7],h=t[8],d=t[9],u=t[10],f=t[11],g=t[12],p=t[13],m=t[14],y=t[15],v=i*s-o*a,x=i*l-r*a,b=i*c-n*a,C=o*l-r*s,M=o*c-n*s,_=r*c-n*l,A=h*p-d*g,R=h*m-u*g,P=h*y-f*g,T=d*m-u*p,L=d*y-f*p,S=u*y-f*m,w=v*S-x*L+b*T+C*P-M*R+_*A;if(!w)return null;return w=1/w,e[0]=(s*S-l*L+c*T)*w,e[1]=(r*L-o*S-n*T)*w,e[2]=(p*_-m*M+y*C)*w,e[3]=(u*M-d*_-f*C)*w,e[4]=(l*P-a*S-c*R)*w,e[5]=(i*S-r*P+n*R)*w,e[6]=(m*b-g*_-y*x)*w,e[7]=(h*_-u*b+f*x)*w,e[8]=(a*L-s*P+c*A)*w,e[9]=(o*P-i*L-n*A)*w,e[10]=(g*M-p*b+y*v)*w,e[11]=(d*b-h*M-f*v)*w,e[12]=(s*R-a*T-l*A)*w,e[13]=(i*T-o*R+r*A)*w,e[14]=(p*x-g*C-m*v)*w,e[15]=(h*C-d*x+u*v)*w,e},t.adjoint=function(e,t){var i=t[0],o=t[1],r=t[2],n=t[3],a=t[4],s=t[5],l=t[6],c=t[7],h=t[8],d=t[9],u=t[10],f=t[11],g=t[12],p=t[13],m=t[14],y=t[15];return e[0]=s*(u*y-f*m)-d*(l*y-c*m)+p*(l*f-c*u),e[1]=-(o*(u*y-f*m)-d*(r*y-n*m)+p*(r*f-n*u)),e[2]=o*(l*y-c*m)-s*(r*y-n*m)+p*(r*c-n*l),e[3]=-(o*(l*f-c*u)-s*(r*f-n*u)+d*(r*c-n*l)),e[4]=-(a*(u*y-f*m)-h*(l*y-c*m)+g*(l*f-c*u)),e[5]=i*(u*y-f*m)-h*(r*y-n*m)+g*(r*f-n*u),e[6]=-(i*(l*y-c*m)-a*(r*y-n*m)+g*(r*c-n*l)),e[7]=i*(l*f-c*u)-a*(r*f-n*u)+h*(r*c-n*l),e[8]=a*(d*y-f*p)-h*(s*y-c*p)+g*(s*f-c*d),e[9]=-(i*(d*y-f*p)-h*(o*y-n*p)+g*(o*f-n*d)),e[10]=i*(s*y-c*p)-a*(o*y-n*p)+g*(o*c-n*s),e[11]=-(i*(s*f-c*d)-a*(o*f-n*d)+h*(o*c-n*s)),e[12]=-(a*(d*m-u*p)-h*(s*m-l*p)+g*(s*u-l*d)),e[13]=i*(d*m-u*p)-h*(o*m-r*p)+g*(o*u-r*d),e[14]=-(i*(s*m-l*p)-a*(o*m-r*p)+g*(o*l-r*s)),e[15]=i*(s*u-l*d)-a*(o*u-r*d)+h*(o*l-r*s),e},t.determinant=function(e){var t=e[0],i=e[1],o=e[2],r=e[3],n=e[4],a=e[5],s=e[6],l=e[7],c=e[8],h=e[9],d=e[10],u=e[11],f=e[12],g=e[13],p=e[14],m=e[15];return(t*a-i*n)*(d*m-u*p)-(t*s-o*n)*(h*m-u*g)+(t*l-r*n)*(h*p-d*g)+(i*s-o*a)*(c*m-u*f)-(i*l-r*a)*(c*p-d*f)+(o*l-r*s)*(c*g-h*f)},t.multiply=r,t.translate=function(e,t,i){var o=i[0],r=i[1],n=i[2],a=void 0,s=void 0,l=void 0,c=void 0,h=void 0,d=void 0,u=void 0,f=void 0,g=void 0,p=void 0,m=void 0,y=void 0;t===e?(e[12]=t[0]*o+t[4]*r+t[8]*n+t[12],e[13]=t[1]*o+t[5]*r+t[9]*n+t[13],e[14]=t[2]*o+t[6]*r+t[10]*n+t[14],e[15]=t[3]*o+t[7]*r+t[11]*n+t[15]):(a=t[0],s=t[1],l=t[2],c=t[3],h=t[4],d=t[5],u=t[6],f=t[7],g=t[8],p=t[9],m=t[10],y=t[11],e[0]=a,e[1]=s,e[2]=l,e[3]=c,e[4]=h,e[5]=d,e[6]=u,e[7]=f,e[8]=g,e[9]=p,e[10]=m,e[11]=y,e[12]=a*o+h*r+g*n+t[12],e[13]=s*o+d*r+p*n+t[13],e[14]=l*o+u*r+m*n+t[14],e[15]=c*o+f*r+y*n+t[15]);return e},t.scale=function(e,t,i){var o=i[0],r=i[1],n=i[2];return e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e[3]=t[3]*o,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},t.rotate=function(e,t,i,r){var n=r[0],a=r[1],s=r[2],l=Math.sqrt(n*n+a*a+s*s),c=void 0,h=void 0,d=void 0,u=void 0,f=void 0,g=void 0,p=void 0,m=void 0,y=void 0,v=void 0,x=void 0,b=void 0,C=void 0,M=void 0,_=void 0,A=void 0,R=void 0,P=void 0,T=void 0,L=void 0,S=void 0,w=void 0,E=void 0,D=void 0;if(Math.abs(l)<o.EPSILON)return null;n*=l=1/l,a*=l,s*=l,c=Math.sin(i),h=Math.cos(i),d=1-h,u=t[0],f=t[1],g=t[2],p=t[3],m=t[4],y=t[5],v=t[6],x=t[7],b=t[8],C=t[9],M=t[10],_=t[11],A=n*n*d+h,R=a*n*d+s*c,P=s*n*d-a*c,T=n*a*d-s*c,L=a*a*d+h,S=s*a*d+n*c,w=n*s*d+a*c,E=a*s*d-n*c,D=s*s*d+h,e[0]=u*A+m*R+b*P,e[1]=f*A+y*R+C*P,e[2]=g*A+v*R+M*P,e[3]=p*A+x*R+_*P,e[4]=u*T+m*L+b*S,e[5]=f*T+y*L+C*S,e[6]=g*T+v*L+M*S,e[7]=p*T+x*L+_*S,e[8]=u*w+m*E+b*D,e[9]=f*w+y*E+C*D,e[10]=g*w+v*E+M*D,e[11]=p*w+x*E+_*D,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]);return e},t.rotateX=function(e,t,i){var o=Math.sin(i),r=Math.cos(i),n=t[4],a=t[5],s=t[6],l=t[7],c=t[8],h=t[9],d=t[10],u=t[11];t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]);return e[4]=n*r+c*o,e[5]=a*r+h*o,e[6]=s*r+d*o,e[7]=l*r+u*o,e[8]=c*r-n*o,e[9]=h*r-a*o,e[10]=d*r-s*o,e[11]=u*r-l*o,e},t.rotateY=function(e,t,i){var o=Math.sin(i),r=Math.cos(i),n=t[0],a=t[1],s=t[2],l=t[3],c=t[8],h=t[9],d=t[10],u=t[11];t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]);return e[0]=n*r-c*o,e[1]=a*r-h*o,e[2]=s*r-d*o,e[3]=l*r-u*o,e[8]=n*o+c*r,e[9]=a*o+h*r,e[10]=s*o+d*r,e[11]=l*o+u*r,e},t.rotateZ=function(e,t,i){var o=Math.sin(i),r=Math.cos(i),n=t[0],a=t[1],s=t[2],l=t[3],c=t[4],h=t[5],d=t[6],u=t[7];t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]);return e[0]=n*r+c*o,e[1]=a*r+h*o,e[2]=s*r+d*o,e[3]=l*r+u*o,e[4]=c*r-n*o,e[5]=h*r-a*o,e[6]=d*r-s*o,e[7]=u*r-l*o,e},t.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e},t.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},t.fromRotation=function(e,t,i){var r=i[0],n=i[1],a=i[2],s=Math.sqrt(r*r+n*n+a*a),l=void 0,c=void 0,h=void 0;if(Math.abs(s)<o.EPSILON)return null;return r*=s=1/s,n*=s,a*=s,l=Math.sin(t),c=Math.cos(t),h=1-c,e[0]=r*r*h+c,e[1]=n*r*h+a*l,e[2]=a*r*h-n*l,e[3]=0,e[4]=r*n*h-a*l,e[5]=n*n*h+c,e[6]=a*n*h+r*l,e[7]=0,e[8]=r*a*h+n*l,e[9]=n*a*h-r*l,e[10]=a*a*h+c,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},t.fromXRotation=function(e,t){var i=Math.sin(t),o=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=i,e[7]=0,e[8]=0,e[9]=-i,e[10]=o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},t.fromYRotation=function(e,t){var i=Math.sin(t),o=Math.cos(t);return e[0]=o,e[1]=0,e[2]=-i,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=i,e[9]=0,e[10]=o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},t.fromZRotation=function(e,t){var i=Math.sin(t),o=Math.cos(t);return e[0]=o,e[1]=i,e[2]=0,e[3]=0,e[4]=-i,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},t.fromRotationTranslation=function(e,t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=o+o,l=r+r,c=n+n,h=o*s,d=o*l,u=o*c,f=r*l,g=r*c,p=n*c,m=a*s,y=a*l,v=a*c;return e[0]=1-(f+p),e[1]=d+v,e[2]=u-y,e[3]=0,e[4]=d-v,e[5]=1-(h+p),e[6]=g+m,e[7]=0,e[8]=u+y,e[9]=g-m,e[10]=1-(h+f),e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e},t.getTranslation=function(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e},t.getScaling=function(e,t){var i=t[0],o=t[1],r=t[2],n=t[4],a=t[5],s=t[6],l=t[8],c=t[9],h=t[10];return e[0]=Math.sqrt(i*i+o*o+r*r),e[1]=Math.sqrt(n*n+a*a+s*s),e[2]=Math.sqrt(l*l+c*c+h*h),e},t.getRotation=function(e,t){var i=t[0]+t[5]+t[10],o=0;i>0?(o=2*Math.sqrt(i+1),e[3]=.25*o,e[0]=(t[6]-t[9])/o,e[1]=(t[8]-t[2])/o,e[2]=(t[1]-t[4])/o):t[0]>t[5]&t[0]>t[10]?(o=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/o,e[0]=.25*o,e[1]=(t[1]+t[4])/o,e[2]=(t[8]+t[2])/o):t[5]>t[10]?(o=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/o,e[0]=(t[1]+t[4])/o,e[1]=.25*o,e[2]=(t[6]+t[9])/o):(o=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/o,e[0]=(t[8]+t[2])/o,e[1]=(t[6]+t[9])/o,e[2]=.25*o);return e},t.fromRotationTranslationScale=function(e,t,i,o){var r=t[0],n=t[1],a=t[2],s=t[3],l=r+r,c=n+n,h=a+a,d=r*l,u=r*c,f=r*h,g=n*c,p=n*h,m=a*h,y=s*l,v=s*c,x=s*h,b=o[0],C=o[1],M=o[2];return e[0]=(1-(g+m))*b,e[1]=(u+x)*b,e[2]=(f-v)*b,e[3]=0,e[4]=(u-x)*C,e[5]=(1-(d+m))*C,e[6]=(p+y)*C,e[7]=0,e[8]=(f+v)*M,e[9]=(p-y)*M,e[10]=(1-(d+g))*M,e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e},t.fromRotationTranslationScaleOrigin=function(e,t,i,o,r){var n=t[0],a=t[1],s=t[2],l=t[3],c=n+n,h=a+a,d=s+s,u=n*c,f=n*h,g=n*d,p=a*h,m=a*d,y=s*d,v=l*c,x=l*h,b=l*d,C=o[0],M=o[1],_=o[2],A=r[0],R=r[1],P=r[2];return e[0]=(1-(p+y))*C,e[1]=(f+b)*C,e[2]=(g-x)*C,e[3]=0,e[4]=(f-b)*M,e[5]=(1-(u+y))*M,e[6]=(m+v)*M,e[7]=0,e[8]=(g+x)*_,e[9]=(m-v)*_,e[10]=(1-(u+p))*_,e[11]=0,e[12]=i[0]+A-(e[0]*A+e[4]*R+e[8]*P),e[13]=i[1]+R-(e[1]*A+e[5]*R+e[9]*P),e[14]=i[2]+P-(e[2]*A+e[6]*R+e[10]*P),e[15]=1,e},t.fromQuat=function(e,t){var i=t[0],o=t[1],r=t[2],n=t[3],a=i+i,s=o+o,l=r+r,c=i*a,h=o*a,d=o*s,u=r*a,f=r*s,g=r*l,p=n*a,m=n*s,y=n*l;return e[0]=1-d-g,e[1]=h+y,e[2]=u-m,e[3]=0,e[4]=h-y,e[5]=1-c-g,e[6]=f+p,e[7]=0,e[8]=u+m,e[9]=f-p,e[10]=1-c-d,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},t.frustum=function(e,t,i,o,r,n,a){var s=1/(i-t),l=1/(r-o),c=1/(n-a);return e[0]=2*n*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*n*l,e[6]=0,e[7]=0,e[8]=(i+t)*s,e[9]=(r+o)*l,e[10]=(a+n)*c,e[11]=-1,e[12]=0,e[13]=0,e[14]=a*n*2*c,e[15]=0,e},t.perspective=function(e,t,i,o,r){var n=1/Math.tan(t/2),a=1/(o-r);return e[0]=n/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(r+o)*a,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*r*o*a,e[15]=0,e},t.perspectiveFromFieldOfView=function(e,t,i,o){var r=Math.tan(t.upDegrees*Math.PI/180),n=Math.tan(t.downDegrees*Math.PI/180),a=Math.tan(t.leftDegrees*Math.PI/180),s=Math.tan(t.rightDegrees*Math.PI/180),l=2/(a+s),c=2/(r+n);return e[0]=l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=c,e[6]=0,e[7]=0,e[8]=-(a-s)*l*.5,e[9]=(r-n)*c*.5,e[10]=o/(i-o),e[11]=-1,e[12]=0,e[13]=0,e[14]=o*i/(i-o),e[15]=0,e},t.ortho=function(e,t,i,o,r,n,a){var s=1/(t-i),l=1/(o-r),c=1/(n-a);return e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+i)*s,e[13]=(r+o)*l,e[14]=(a+n)*c,e[15]=1,e},t.lookAt=function(e,t,i,r){var n=void 0,a=void 0,s=void 0,l=void 0,c=void 0,h=void 0,d=void 0,u=void 0,f=void 0,g=void 0,p=t[0],m=t[1],y=t[2],v=r[0],x=r[1],b=r[2],C=i[0],M=i[1],_=i[2];if(Math.abs(p-C)<o.EPSILON&&Math.abs(m-M)<o.EPSILON&&Math.abs(y-_)<o.EPSILON)return mat4.identity(e);d=p-C,u=m-M,f=y-_,g=1/Math.sqrt(d*d+u*u+f*f),n=x*(f*=g)-b*(u*=g),a=b*(d*=g)-v*f,s=v*u-x*d,(g=Math.sqrt(n*n+a*a+s*s))?(n*=g=1/g,a*=g,s*=g):(n=0,a=0,s=0);l=u*s-f*a,c=f*n-d*s,h=d*a-u*n,(g=Math.sqrt(l*l+c*c+h*h))?(l*=g=1/g,c*=g,h*=g):(l=0,c=0,h=0);return e[0]=n,e[1]=l,e[2]=d,e[3]=0,e[4]=a,e[5]=c,e[6]=u,e[7]=0,e[8]=s,e[9]=h,e[10]=f,e[11]=0,e[12]=-(n*p+a*m+s*y),e[13]=-(l*p+c*m+h*y),e[14]=-(d*p+u*m+f*y),e[15]=1,e},t.targetTo=function(e,t,i,o){var r=t[0],n=t[1],a=t[2],s=o[0],l=o[1],c=o[2],h=r-i[0],d=n-i[1],u=a-i[2],f=h*h+d*d+u*u;f>0&&(f=1/Math.sqrt(f),h*=f,d*=f,u*=f);var g=l*u-c*d,p=c*h-s*u,m=s*d-l*h;return e[0]=g,e[1]=p,e[2]=m,e[3]=0,e[4]=d*m-u*p,e[5]=u*g-h*m,e[6]=h*p-d*g,e[7]=0,e[8]=h,e[9]=d,e[10]=u,e[11]=0,e[12]=r,e[13]=n,e[14]=a,e[15]=1,e},t.str=function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},t.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2)+Math.pow(e[9],2)+Math.pow(e[10],2)+Math.pow(e[11],2)+Math.pow(e[12],2)+Math.pow(e[13],2)+Math.pow(e[14],2)+Math.pow(e[15],2))},t.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e[4]=t[4]+i[4],e[5]=t[5]+i[5],e[6]=t[6]+i[6],e[7]=t[7]+i[7],e[8]=t[8]+i[8],e[9]=t[9]+i[9],e[10]=t[10]+i[10],e[11]=t[11]+i[11],e[12]=t[12]+i[12],e[13]=t[13]+i[13],e[14]=t[14]+i[14],e[15]=t[15]+i[15],e},t.subtract=n,t.multiplyScalar=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*i,e[9]=t[9]*i,e[10]=t[10]*i,e[11]=t[11]*i,e[12]=t[12]*i,e[13]=t[13]*i,e[14]=t[14]*i,e[15]=t[15]*i,e},t.multiplyScalarAndAdd=function(e,t,i,o){return e[0]=t[0]+i[0]*o,e[1]=t[1]+i[1]*o,e[2]=t[2]+i[2]*o,e[3]=t[3]+i[3]*o,e[4]=t[4]+i[4]*o,e[5]=t[5]+i[5]*o,e[6]=t[6]+i[6]*o,e[7]=t[7]+i[7]*o,e[8]=t[8]+i[8]*o,e[9]=t[9]+i[9]*o,e[10]=t[10]+i[10]*o,e[11]=t[11]+i[11]*o,e[12]=t[12]+i[12]*o,e[13]=t[13]+i[13]*o,e[14]=t[14]+i[14]*o,e[15]=t[15]+i[15]*o,e},t.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]},t.equals=function(e,t){var i=e[0],r=e[1],n=e[2],a=e[3],s=e[4],l=e[5],c=e[6],h=e[7],d=e[8],u=e[9],f=e[10],g=e[11],p=e[12],m=e[13],y=e[14],v=e[15],x=t[0],b=t[1],C=t[2],M=t[3],_=t[4],A=t[5],R=t[6],P=t[7],T=t[8],L=t[9],S=t[10],w=t[11],E=t[12],D=t[13],I=t[14],O=t[15];return Math.abs(i-x)<=o.EPSILON*Math.max(1,Math.abs(i),Math.abs(x))&&Math.abs(r-b)<=o.EPSILON*Math.max(1,Math.abs(r),Math.abs(b))&&Math.abs(n-C)<=o.EPSILON*Math.max(1,Math.abs(n),Math.abs(C))&&Math.abs(a-M)<=o.EPSILON*Math.max(1,Math.abs(a),Math.abs(M))&&Math.abs(s-_)<=o.EPSILON*Math.max(1,Math.abs(s),Math.abs(_))&&Math.abs(l-A)<=o.EPSILON*Math.max(1,Math.abs(l),Math.abs(A))&&Math.abs(c-R)<=o.EPSILON*Math.max(1,Math.abs(c),Math.abs(R))&&Math.abs(h-P)<=o.EPSILON*Math.max(1,Math.abs(h),Math.abs(P))&&Math.abs(d-T)<=o.EPSILON*Math.max(1,Math.abs(d),Math.abs(T))&&Math.abs(u-L)<=o.EPSILON*Math.max(1,Math.abs(u),Math.abs(L))&&Math.abs(f-S)<=o.EPSILON*Math.max(1,Math.abs(f),Math.abs(S))&&Math.abs(g-w)<=o.EPSILON*Math.max(1,Math.abs(g),Math.abs(w))&&Math.abs(p-E)<=o.EPSILON*Math.max(1,Math.abs(p),Math.abs(E))&&Math.abs(m-D)<=o.EPSILON*Math.max(1,Math.abs(m),Math.abs(D))&&Math.abs(y-I)<=o.EPSILON*Math.max(1,Math.abs(y),Math.abs(I))&&Math.abs(v-O)<=o.EPSILON*Math.max(1,Math.abs(v),Math.abs(O))};var o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}(i(0));function r(e,t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=t[4],l=t[5],c=t[6],h=t[7],d=t[8],u=t[9],f=t[10],g=t[11],p=t[12],m=t[13],y=t[14],v=t[15],x=i[0],b=i[1],C=i[2],M=i[3];return e[0]=x*o+b*s+C*d+M*p,e[1]=x*r+b*l+C*u+M*m,e[2]=x*n+b*c+C*f+M*y,e[3]=x*a+b*h+C*g+M*v,x=i[4],b=i[5],C=i[6],M=i[7],e[4]=x*o+b*s+C*d+M*p,e[5]=x*r+b*l+C*u+M*m,e[6]=x*n+b*c+C*f+M*y,e[7]=x*a+b*h+C*g+M*v,x=i[8],b=i[9],C=i[10],M=i[11],e[8]=x*o+b*s+C*d+M*p,e[9]=x*r+b*l+C*u+M*m,e[10]=x*n+b*c+C*f+M*y,e[11]=x*a+b*h+C*g+M*v,x=i[12],b=i[13],C=i[14],M=i[15],e[12]=x*o+b*s+C*d+M*p,e[13]=x*r+b*l+C*u+M*m,e[14]=x*n+b*c+C*f+M*y,e[15]=x*a+b*h+C*g+M*v,e}function n(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e[4]=t[4]-i[4],e[5]=t[5]-i[5],e[6]=t[6]-i[6],e[7]=t[7]-i[7],e[8]=t[8]-i[8],e[9]=t[9]-i[9],e[10]=t[10]-i[10],e[11]=t[11]-i[11],e[12]=t[12]-i[12],e[13]=t[13]-i[13],e[14]=t[14]-i[14],e[15]=t[15]-i[15],e}t.mul=r,t.sub=n},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.setAxes=t.sqlerp=t.rotationTo=t.equals=t.exactEquals=t.normalize=t.sqrLen=t.squaredLength=t.len=t.length=t.lerp=t.dot=t.scale=t.mul=t.add=t.set=t.copy=t.fromValues=t.clone=void 0,t.create=l,t.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},t.setAxisAngle=c,t.getAxisAngle=function(e,t){var i=2*Math.acos(t[3]),o=Math.sin(i/2);0!=o?(e[0]=t[0]/o,e[1]=t[1]/o,e[2]=t[2]/o):(e[0]=1,e[1]=0,e[2]=0);return i},t.multiply=h,t.rotateX=function(e,t,i){i*=.5;var o=t[0],r=t[1],n=t[2],a=t[3],s=Math.sin(i),l=Math.cos(i);return e[0]=o*l+a*s,e[1]=r*l+n*s,e[2]=n*l-r*s,e[3]=a*l-o*s,e},t.rotateY=function(e,t,i){i*=.5;var o=t[0],r=t[1],n=t[2],a=t[3],s=Math.sin(i),l=Math.cos(i);return e[0]=o*l-n*s,e[1]=r*l+a*s,e[2]=n*l+o*s,e[3]=a*l-r*s,e},t.rotateZ=function(e,t,i){i*=.5;var o=t[0],r=t[1],n=t[2],a=t[3],s=Math.sin(i),l=Math.cos(i);return e[0]=o*l+r*s,e[1]=r*l-o*s,e[2]=n*l+a*s,e[3]=a*l-n*s,e},t.calculateW=function(e,t){var i=t[0],o=t[1],r=t[2];return e[0]=i,e[1]=o,e[2]=r,e[3]=Math.sqrt(Math.abs(1-i*i-o*o-r*r)),e},t.slerp=d,t.invert=function(e,t){var i=t[0],o=t[1],r=t[2],n=t[3],a=i*i+o*o+r*r+n*n,s=a?1/a:0;return e[0]=-i*s,e[1]=-o*s,e[2]=-r*s,e[3]=n*s,e},t.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},t.fromMat3=u,t.fromEuler=function(e,t,i,o){var r=.5*Math.PI/180;t*=r,i*=r,o*=r;var n=Math.sin(t),a=Math.cos(t),s=Math.sin(i),l=Math.cos(i),c=Math.sin(o),h=Math.cos(o);return e[0]=n*l*h-a*s*c,e[1]=a*s*h+n*l*c,e[2]=a*l*c-n*s*h,e[3]=a*l*h+n*s*c,e},t.str=function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"};var o=s(i(0)),r=s(i(1)),n=s(i(2)),a=s(i(3));function s(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}function l(){var e=new o.ARRAY_TYPE(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e}function c(e,t,i){i*=.5;var o=Math.sin(i);return e[0]=o*t[0],e[1]=o*t[1],e[2]=o*t[2],e[3]=Math.cos(i),e}function h(e,t,i){var o=t[0],r=t[1],n=t[2],a=t[3],s=i[0],l=i[1],c=i[2],h=i[3];return e[0]=o*h+a*s+r*c-n*l,e[1]=r*h+a*l+n*s-o*c,e[2]=n*h+a*c+o*l-r*s,e[3]=a*h-o*s-r*l-n*c,e}function d(e,t,i,o){var r=t[0],n=t[1],a=t[2],s=t[3],l=i[0],c=i[1],h=i[2],d=i[3],u=void 0,f=void 0,g=void 0,p=void 0,m=void 0;return(f=r*l+n*c+a*h+s*d)<0&&(f=-f,l=-l,c=-c,h=-h,d=-d),1-f>1e-6?(u=Math.acos(f),g=Math.sin(u),p=Math.sin((1-o)*u)/g,m=Math.sin(o*u)/g):(p=1-o,m=o),e[0]=p*r+m*l,e[1]=p*n+m*c,e[2]=p*a+m*h,e[3]=p*s+m*d,e}function u(e,t){var i=t[0]+t[4]+t[8],o=void 0;if(i>0)o=Math.sqrt(i+1),e[3]=.5*o,o=.5/o,e[0]=(t[5]-t[7])*o,e[1]=(t[6]-t[2])*o,e[2]=(t[1]-t[3])*o;else{var r=0;t[4]>t[0]&&(r=1),t[8]>t[3*r+r]&&(r=2);var n=(r+1)%3,a=(r+2)%3;o=Math.sqrt(t[3*r+r]-t[3*n+n]-t[3*a+a]+1),e[r]=.5*o,o=.5/o,e[3]=(t[3*n+a]-t[3*a+n])*o,e[n]=(t[3*n+r]+t[3*r+n])*o,e[a]=(t[3*a+r]+t[3*r+a])*o}return e}t.clone=a.clone,t.fromValues=a.fromValues,t.copy=a.copy,t.set=a.set,t.add=a.add,t.mul=h,t.scale=a.scale,t.dot=a.dot,t.lerp=a.lerp;var f,g,p,m,y,v,x=t.length=a.length,b=(t.len=x,t.squaredLength=a.squaredLength),C=(t.sqrLen=b,t.normalize=a.normalize);t.exactEquals=a.exactEquals,t.equals=a.equals,t.rotationTo=(f=n.create(),g=n.fromValues(1,0,0),p=n.fromValues(0,1,0),function(e,t,i){var o=n.dot(t,i);return o<-.999999?(n.cross(f,g,t),n.len(f)<1e-6&&n.cross(f,p,t),n.normalize(f,f),c(e,f,Math.PI),e):o>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(n.cross(f,t,i),e[0]=f[0],e[1]=f[1],e[2]=f[2],e[3]=1+o,C(e,e))}),t.sqlerp=(m=l(),y=l(),function(e,t,i,o,r,n){return d(m,t,r,n),d(y,i,o,n),d(e,m,y,2*n*(1-n)),e}),t.setAxes=(v=r.create(),function(e,t,i,o){return v[0]=i[0],v[3]=i[1],v[6]=i[2],v[1]=o[0],v[4]=o[1],v[7]=o[2],v[2]=-t[0],v[5]=-t[1],v[8]=-t[2],C(e,u(e,v))})},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.forEach=t.sqrLen=t.sqrDist=t.dist=t.div=t.mul=t.sub=t.len=void 0,t.create=r,t.clone=function(e){var t=new o.ARRAY_TYPE(2);return t[0]=e[0],t[1]=e[1],t},t.fromValues=function(e,t){var i=new o.ARRAY_TYPE(2);return i[0]=e,i[1]=t,i},t.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e},t.set=function(e,t,i){return e[0]=t,e[1]=i,e},t.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e},t.subtract=n,t.multiply=a,t.divide=s,t.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e},t.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e},t.min=function(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e},t.max=function(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e},t.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e},t.scale=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e},t.scaleAndAdd=function(e,t,i,o){return e[0]=t[0]+i[0]*o,e[1]=t[1]+i[1]*o,e},t.distance=l,t.squaredDistance=c,t.length=h,t.squaredLength=d,t.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e},t.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e},t.normalize=function(e,t){var i=t[0],o=t[1],r=i*i+o*o;r>0&&(r=1/Math.sqrt(r),e[0]=t[0]*r,e[1]=t[1]*r);return e},t.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},t.cross=function(e,t,i){var o=t[0]*i[1]-t[1]*i[0];return e[0]=e[1]=0,e[2]=o,e},t.lerp=function(e,t,i,o){var r=t[0],n=t[1];return e[0]=r+o*(i[0]-r),e[1]=n+o*(i[1]-n),e},t.random=function(e,t){t=t||1;var i=2*o.RANDOM()*Math.PI;return e[0]=Math.cos(i)*t,e[1]=Math.sin(i)*t,e},t.transformMat2=function(e,t,i){var o=t[0],r=t[1];return e[0]=i[0]*o+i[2]*r,e[1]=i[1]*o+i[3]*r,e},t.transformMat2d=function(e,t,i){var o=t[0],r=t[1];return e[0]=i[0]*o+i[2]*r+i[4],e[1]=i[1]*o+i[3]*r+i[5],e},t.transformMat3=function(e,t,i){var o=t[0],r=t[1];return e[0]=i[0]*o+i[3]*r+i[6],e[1]=i[1]*o+i[4]*r+i[7],e},t.transformMat4=function(e,t,i){var o=t[0],r=t[1];return e[0]=i[0]*o+i[4]*r+i[12],e[1]=i[1]*o+i[5]*r+i[13],e},t.str=function(e){return"vec2("+e[0]+", "+e[1]+")"},t.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]},t.equals=function(e,t){var i=e[0],r=e[1],n=t[0],a=t[1];return Math.abs(i-n)<=o.EPSILON*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(r-a)<=o.EPSILON*Math.max(1,Math.abs(r),Math.abs(a))};var o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}(i(0));function r(){var e=new o.ARRAY_TYPE(2);return e[0]=0,e[1]=0,e}function n(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e}function a(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e}function s(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e}function l(e,t){var i=t[0]-e[0],o=t[1]-e[1];return Math.sqrt(i*i+o*o)}function c(e,t){var i=t[0]-e[0],o=t[1]-e[1];return i*i+o*o}function h(e){var t=e[0],i=e[1];return Math.sqrt(t*t+i*i)}function d(e){var t=e[0],i=e[1];return t*t+i*i}var u;t.len=h,t.sub=n,t.mul=a,t.div=s,t.dist=l,t.sqrDist=c,t.sqrLen=d,t.forEach=(u=r(),function(e,t,i,o,r,n){var a=void 0,s=void 0;for(t||(t=2),i||(i=0),s=o?Math.min(o*t+i,e.length):e.length,a=i;a<s;a+=t)u[0]=e[a],u[1]=e[a+1],r(u,u,n),e[a]=u[0],e[a+1]=u[1];return e})}])}),function(e){function t(){if(1==arguments.length){var e=arguments[0];this.header={idLength:i((n=e).idLength,0),colorMapType:i(n.colorMapType,0),imageType:i(n.imageType,t.Type.RGB),colorMapIndex:i(n.colorMapIndex,0),colorMapLength:i(n.colorMapLength,0),colorMapDepth:i(n.colorMapDepth,0),offsetX:i(n.offsetX,0),offsetY:i(n.offsetY,0),width:i(n.width,0),height:i(n.height,0),pixelDepth:i(n.pixelDepth,32),flags:i(n.flags,8)},o(this.header),r(this.header)}var n}function i(e,t){return void 0!==e?e:t}function o(e){e.hasEncoding=e.imageType===t.Type.RLE_INDEXED||e.imageType===t.Type.RLE_RGB||e.imageType===t.Type.RLE_GREY,e.hasColorMap=e.imageType===t.Type.RLE_INDEXED||e.imageType===t.Type.INDEXED,e.isGreyColor=e.imageType===t.Type.RLE_GREY||e.imageType===t.Type.GREY,e.bytePerPixel=e.pixelDepth>>3,e.origin=(e.flags&t.Origin.MASK)>>t.Origin.SHIFT,e.alphaBits=e.flags&t.Origin.ALPHA}function r(e){if(e.imageType===t.Type.NO_DATA)throw new Error("Targa::checkHeader() - No data");if(e.hasColorMap){if(e.colorMapLength>256||1!==e.colorMapType)throw new Error("Targa::checkHeader() - Unsupported colormap for indexed type");if(16!==e.colorMapDepth&&24!==e.colorMapDepth&&32!==e.colorMapDepth)throw new Error("Targa::checkHeader() - Unsupported colormap depth")}else if(e.colorMapType)throw new Error("Targa::checkHeader() - Why does the image contain a palette ?");if(e.width<=0||e.height<=0)throw new Error("Targa::checkHeader() - Invalid image size");if(8!==e.pixelDepth&&16!==e.pixelDepth&&24!==e.pixelDepth&&32!==e.pixelDepth)throw new Error('Targa::checkHeader() - Invalid pixel size "'+e.pixelDepth+'"');if(0!==e.alphaBits&&1!==e.alphaBits&&8!==e.alphaBits)throw new Error("Targa::checkHeader() - Unsuppported alpha size")}function n(e,t,i,o,r,n,a,s,l,c){var h,d,u,f,g,p,m=this.header.colorMapDepth>>3;for(f=0,p=r;p!==a;p+=n)for(g=s;g!==c;g+=l,f++)u=4*(g+o*p),d=t[f]*m,4===m?(e[u]=i[d+2],e[u+1]=i[d+1],e[u+2]=i[d],e[u+3]=i[d+3]):3===m?(e[u]=i[d+2],e[u+1]=i[d+1],e[u+2]=i[d],e[u+3]=255):2===m&&(h=i[d]|i[d+1]<<8,e[u]=(31744&h)>>7,e[u+1]=(992&h)>>2,e[u+2]=(31&h)<<3,e[u+3]=32768&h?0:255);return e}function a(e,t,i,o,r,n,a,s,l,c){var h,d,u,f,g;for(u=0,g=r;g!==a;g+=n)for(f=s;f!==c;f+=l,u+=2)h=t[u]|t[u+1]<<8,e[d=4*(f+o*g)]=(31744&h)>>7,e[d+1]=(992&h)>>2,e[d+2]=(31&h)<<3,e[d+3]=32768&h?0:255;return e}function s(e,t,i,o,r,n,a,s,l,c){var h,d,u,f,g=this.header.pixelDepth>>3;for(d=0,f=r;f!==a;f+=n)for(u=s;u!==c;u+=l,d+=g)e[(h=4*(u+o*f))+3]=255,e[h+2]=t[d],e[h+1]=t[d+1],e[h]=t[d+2];return e}function l(e,t,i,o,r,n,a,s,l,c){var h,d,u,f;for(h=0,u=r;u!==a;u+=n)for(d=s;d!==c;d+=l,h+=4)e[(f=4*(d+o*u))+2]=t[h],e[f+1]=t[h+1],e[f]=t[h+2],e[f+3]=t[h+3];return e}function c(e,t,i,o,r,n,a,s,l,c){var h,d,u,f,g;for(h=0,u=r;u!==a;u+=n)for(d=s;d!==c;d+=l,h+=4)f=4*(d+o*u),g=255*t[h+3],e[f+2]=t[h]/g,e[f+1]=t[h+1]/g,e[f]=t[h+2]/g,e[f+3]=t[h+3];return e}function h(e,t,i,o,r,n,a,s,l,c){var h,d,u,f,g;for(u=0,g=r;g!==a;g+=n)for(f=s;f!==c;f+=l,u++)h=t[u],e[d=4*(f+o*g)]=h,e[d+1]=h,e[d+2]=h,e[d+3]=255;return e}function d(e,t,i,o,r,n,a,s,l,c){var h,d,u,f,g;for(u=0,g=r;g!==a;g+=n)for(f=s;f!==c;f+=l,u+=2)h=t[u],e[d=4*(f+o*g)]=h,e[d+1]=h,e[d+2]=h,e[d+3]=t[u+1];return e}function u(e){var i=e.byteLength-t.FOOTER_SIZE,o=t.SIGNATURE,r={},n=new Uint8Array(e.buffer,i+8,o.length);return function(e){for(var i=t.SIGNATURE,o=0;o<i.length;o++)if(e.charCodeAt(o)!==i.charCodeAt(o))return!1;return!0}(String.fromCharCode.apply(null,n))?(r.hasFooter=!0,r.extensionOffset=e.getUint32(i,t.LITTLE_ENDIAN),r.developerOffset=e.getUint32(i+4,t.LITTLE_ENDIAN),r.hasExtensionArea=0!==r.extensionOffset,r.hasDeveloperArea=0!==r.developerOffset,r.extensionOffset&&(r.attributeType=e.getUint8(r.extensionOffset+494)),r):(r.hasFooter=!1,r)}t.Type={NO_DATA:0,INDEXED:1,RGB:2,GREY:3,RLE_INDEXED:9,RLE_RGB:10,RLE_GREY:11},t.Origin={BOTTOM_LEFT:0,BOTTOM_RIGHT:1,TOP_LEFT:2,TOP_RIGHT:3,SHIFT:4,MASK:48,ALPHA:8},t.HEADER_SIZE=18,t.FOOTER_SIZE=26,t.LITTLE_ENDIAN=!0,t.RLE_BIT=128,t.RLE_MASK=127,t.RLE_PACKET=1,t.RAW_PACKET=2,t.SIGNATURE="TRUEVISION-XFILE.\0",t.prototype.open=function(e,t){var i,o=this;(i=new XMLHttpRequest).open("GET",e,!0),i.responseType="arraybuffer",i.onload=function(){200===this.status&&(o.arrayBuffer=i.response,o.load(o.arrayBuffer),t&&t.call(o))},i.send(null)},t.prototype.load=function(e){var i=new DataView(e);this.headerData=new Uint8Array(e,0,t.HEADER_SIZE),this.header=function(e){var i=t.LITTLE_ENDIAN;if(e.byteLength<18)throw new Error("Targa::load() - Not enough data to contain header");var o={};return o.idLength=e.getUint8(0),o.colorMapType=e.getUint8(1),o.imageType=e.getUint8(2),o.colorMapIndex=e.getUint16(3,i),o.colorMapLength=e.getUint16(5,i),o.colorMapDepth=e.getUint8(7),o.offsetX=e.getUint16(8,i),o.offsetY=e.getUint16(10,i),o.width=e.getUint16(12,i),o.height=e.getUint16(14,i),o.pixelDepth=e.getUint8(16),o.flags=e.getUint8(17),o}(i),o(this.header),r(this.header);var n=t.HEADER_SIZE;if((n+=this.header.idLength)>=e.byteLength)throw new Error("Targa::load() - No data");if(this.header.hasColorMap){var a=this.header.colorMapLength*(this.header.colorMapDepth>>3);this.palette=new Uint8Array(e,n,a),n+=a}var s=this.header.pixelDepth>>3,l=this.header.width*this.header.height,c=l*s;if(this.header.hasEncoding){var h=e.byteLength-n-t.FOOTER_SIZE,d=new Uint8Array(e,n,h);this.imageData=function(e,i,o){var r,n,a,s,l,c,h;for(h=new Uint8Array(o),c=new Uint8Array(i),l=0,r=0;r<o;)if(a=1+((n=e[l++])&t.RLE_MASK),n&t.RLE_BIT){for(s=0;s<i;++s)c[s]=e[l++];for(s=0;s<a;++s)h.set(c,r),r+=i}else for(a*=i,s=0;s<a;++s)h[r++]=e[l++];if(r>o)throw new Error("Targa::decodeRLE() - Read bytes: "+r+" Expected bytes: "+o);return h}(d,s,c)}else this.imageData=new Uint8Array(e,n,this.header.hasColorMap?l:c);this.footer=u(i),(0!==this.header.alphaBits||this.footer.hasExtensionArea&&(3===this.footer.attributeType||4===this.footer.attributeType))&&(this.footer.usesAlpha=!0)},t.prototype.getImageData=function(e){var i,o,r,u,f,g,p,m=this.header.width,y=this.header.height,v=(this.header.flags&t.Origin.MASK)>>t.Origin.SHIFT;switch(e||(e=document?document.createElement("canvas").getContext("2d").createImageData(m,y):{width:m,height:y,data:new Uint8ClampedArray(m*y*4)}),v===t.Origin.TOP_LEFT||v===t.Origin.TOP_RIGHT?(u=0,f=1,g=y):(u=y-1,f=-1,g=-1),v===t.Origin.TOP_LEFT||v===t.Origin.BOTTOM_LEFT?(i=0,o=1,r=m):(i=m-1,o=-1,r=-1),this.header.pixelDepth){case 8:p=this.header.isGreyColor?h:n;break;case 16:p=this.header.isGreyColor?d:a;break;case 24:p=s;break;case 32:p=this.footer.hasExtensionArea?3===this.footer.attributeType?l:4===this.footer.attributeType?c:s:0!==this.header.alphaBits?l:s}return p.call(this,e.data,this.imageData,this.palette,m,u,f,g,i,o,r),e},t.prototype.setImageData=function(e){if(!e)throw new Error("Targa::setImageData() - imageData argument missing");var i,o,r,n,a,s,c=this.header.width,h=this.header.height,d=c*h*(this.header.pixelDepth>>3),u=(this.header.flags&t.Origin.MASK)>>t.Origin.SHIFT;u===t.Origin.TOP_LEFT||u===t.Origin.TOP_RIGHT?(n=0,a=1,s=h):(n=h-1,a=-1,s=-1),u===t.Origin.TOP_LEFT||u===t.Origin.BOTTOM_LEFT?(i=0,o=1,r=c):(i=c-1,o=-1,r=-1),this.imageData||(this.imageData=new Uint8Array(d)),l(this.imageData,e.data,this.palette,c,n,a,s,i,o,r);var f=this.imageData;this.header.hasEncoding&&(f=function(e,i){for(var o,r,n,a,s=i,l=[],c=0,h=e.pixelDepth>>3,d=0,u=e.width*e.height*h,f=function(e,t){for(var i=0;i<h;i++)if(s[e*h+i]!==s[t*h+i])return!1;return!0},g=function(e){return f(e,e+1)?t.RLE_PACKET:t.RAW_PACKET};c*h<s.length&&c*h<u;){if(n=0,(r=g(c))===t.RLE_PACKET)for(;c+n<s.length&&n<128&&f(c,c+n);)n++;else for(;c+n<s.length&&n<128&&g(c+n)===t.RAW_PACKET;)n++;if(a=n-1,r===t.RLE_PACKET&&(a|=t.RLE_BIT),l[d++]=a,r===t.RLE_PACKET){for(o=0;o<h;o++)l[o+d]=s[o+c*h];d+=h}else{for(o=0;o<h*n;o++)l[o+d]=s[o+c*h];d+=h*n}c+=n}return new Uint8Array(l)}(this.header,f));var g=t.HEADER_SIZE+f.length+t.FOOTER_SIZE,p=new ArrayBuffer(g);this.arrayBuffer=p,this.headerData=new Uint8Array(p,0,t.HEADER_SIZE),this.RLEData=new Uint8Array(p,t.HEADER_SIZE,f.length),this.footerData=new Uint8Array(p,t.HEADER_SIZE+f.length,t.FOOTER_SIZE);var m,y,v,x=new DataView(this.headerData.buffer);m=this.header,y=x,v=t.LITTLE_ENDIAN,y.setUint8(0,m.idLength),y.setUint8(1,m.colorMapType),y.setUint8(2,m.imageType),y.setUint16(3,m.colorMapIndex,v),y.setUint16(5,m.colorMapLength,v),y.setUint8(7,m.colorMapDepth),y.setUint16(8,m.offsetX,v),y.setUint16(10,m.offsetY,v),y.setUint16(12,m.width,v),y.setUint16(14,m.height,v),y.setUint8(16,m.pixelDepth),y.setUint8(17,m.flags),this.RLEData.set(f),function(e){for(var i=t.SIGNATURE,o=e.byteLength-i.length,r=0;r<i.length;r++)e[o+r]=i.charCodeAt(r)}(this.footerData)},t.prototype.getCanvas=function(){var e,t,i;return i=(t=(e=document.createElement("canvas")).getContext("2d")).createImageData(this.header.width,this.header.height),e.width=this.header.width,e.height=this.header.height,t.putImageData(this.getImageData(i),0,0),e},t.prototype.getDataURL=function(e){return this.getCanvas().toDataURL(e||"image/png")},t.prototype.getBlobURL=function(){if(!this.arrayBuffer)throw new Error("Targa::getBlobURL() - No data available for blob");var e=new Blob([this.arrayBuffer],{type:"image/x-tga"});return URL.createObjectURL(e)};var f={};"undefined"==typeof exports?"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(function(){return t}):f.exports="undefined"!=typeof window?window:e:f.exports=exports,f.exports&&(f.exports.TGA=t)}(this);var Accessor=function(){if(!(this instanceof Accessor))throw new Error(Messages.CONSTRUCT_ERROR);this.bufferId,this.accesorType,this.bufferStart,this.stride,this.dataType,this.dimension,this.minX=0,this.minY=0,this.minZ=0,this.maxX=0,this.maxY=0,this.maxZ=0},Block=function(){if(!(this instanceof Block))throw new Error(Messages.CONSTRUCT_ERROR);this.vBOVertexIdxCacheKeysContainer=new VBOVertexIdxCacheKeysContainer,this.mIFCEntityType=-1,this.isSmallObj=!1,this.radius=10,this.vertexCount=0,this.lego};Block.prototype.deleteObjects=function(e,t){this.vBOVertexIdxCacheKeysContainer.deleteGlObjects(e,t),this.vBOVertexIdxCacheKeysContainer=void 0,this.mIFCEntityType=void 0,this.isSmallObj=void 0,this.radius=void 0,this.vertexCount=void 0,this.lego&&this.lego.deleteGlObjects(e),this.lego=void 0};var BlocksList=function(){if(!(this instanceof BlocksList))throw new Error(Messages.CONSTRUCT_ERROR);this.name="",this.blocksArray,this.fileLoadState=CODE.fileLoadState.READY,this.dataArraybuffer};BlocksList.prototype.newBlock=function(){void 0===this.blocksArray&&(this.blocksArray=[]);var e=new Block;return this.blocksArray.push(e),e},BlocksList.prototype.getBlock=function(e){return void 0===this.blocksArray?null:e>=0&&e<this.blocksArray.length?this.blocksArray[e]:null},BlocksList.prototype.deleteGlObjects=function(e,t){if(void 0!==this.blocksArray){for(var i=0,o=this.blocksArray.length;i<o;i++){var r=this.blocksArray[i];r.vBOVertexIdxCacheKeysContainer.deleteGlObjects(e,t),r.vBOVertexIdxCacheKeysContainer=void 0,r.mIFCEntityType=void 0,r.isSmallObj=void 0,r.radius=void 0,r.vertexCount=void 0,r.lego&&(r.lego.vbo_vicks_container.deleteGlObjects(e,t),r.lego.vbo_vicks_container=void 0),r.lego=void 0,this.blocksArray[i]=void 0}this.blocksArray=void 0,this.name=void 0,this.fileLoadState=void 0,this.dataArraybuffer=void 0}},BlocksList.prototype.stepOverBlockVersioned=function(e,t,i){var o,r,n,a,s=i.readInt32(e,t,t+4);t+=4;for(var l=0;l<s;l++)o=i.readUInt32(e,t,t+4),t+=4,t+4*(r=3*o),t+=4*r,o=i.readUInt32(e,t,t+4),t+=4,t+=1*(3*o),n=i.readUInt32(e,t,t+4),t+=4,a=i.readUInt8(e,t,t+1),t+=1,t+=4*a,t+=4*a,t+=2*n;return t},BlocksList.prototype.parseBlockVersioned=function(e,t,i,o,r){var n,a,s,l,c,h,d,u,f=r.vboMemoryManager,g=o.readInt32(e,t,t+4);t+=4;for(var p=0;p<g;p++){var m=o.readUInt32(e,t,t+4);t+=4;var y=3*m;n=y,l=f.getClassifiedBufferSize(n),i.vertexCount=m,d=t,u=t+4*y;var v=i.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();v.posVboDataArray=new Float32Array(l),v.posVboDataArray.set(new Float32Array(e.slice(d,u))),v.posArrayByteSize=l,t+=4*y,m=o.readUInt32(e,t,t+4),t+=4;var x=3*m;a=1*x,c=f.getClassifiedBufferSize(a),d=t,u=t+1*x,v.norVboDataArray=new Int8Array(c),v.norVboDataArray.set(new Int8Array(e.slice(d,u))),v.norArrayByteSize=c,t+=1*x;var b=o.readUInt32(e,t,t+4);t+=4,s=b,h=f.getClassifiedBufferSize(s);var C=o.readUInt8(e,t,t+1);t+=1;for(var M=[],_=0;_<C;_++)M.push(new Float32Array(e.slice(t,t+4))),t+=4;var A=[];for(_=0;_<C;_++)A.push(o.readUInt32(e,t,t+4)),t+=4;var R=A[C-1];v.bigTrianglesIndicesCount=R,d=t,u=t+2*b,v.idxVboDataArray=new Int16Array(h),v.idxVboDataArray.set(new Int16Array(e.slice(d,u))),v.idxArrayByteSize=h,t+=2*b,v.indicesCount=b}return t},BlocksList.prototype.parseBlocksListVersioned=function(e,t,i,o){this.fileLoadState=CODE.fileLoadState.PARSE_STARTED;var r=0,n=(o.vboMemoryManager,o.sceneState.gl),a=!0;String.fromCharCode.apply(null,new Int8Array(e.slice(r,r+5)));r+=5;var s=t.readUInt32(e,r,r+4);r+=4;for(var l=0;l<s;l++){var c=t.readInt32(e,r,r+4);if(r+=4,i[c]){r+=24,r=this.stepOverBlockVersioned(e,r,t);var h=t.readUInt8(e,r,r+1);r+=1,h&&(r=this.stepOverBlockVersioned(e,r,t))}else{var d=new Block;d.idx=c,i[c]=d;var u=new BoundingBox;u.minX=new Float32Array(e.slice(r,r+4)),r+=4,u.minY=new Float32Array(e.slice(r,r+4)),r+=4,u.minZ=new Float32Array(e.slice(r,r+4)),r+=4,u.maxX=new Float32Array(e.slice(r,r+4)),r+=4,u.maxY=new Float32Array(e.slice(r,r+4)),r+=4,u.maxZ=new Float32Array(e.slice(r,r+4)),r+=4;var f=u.getMaxLength();d.isSmallObj=f<.5,d.radius=f/2,u.deleteObjects(),u=void 0,r=this.parseBlockVersioned(e,r,d,t,o);for(var g=d.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray.length,p=0;p<g;p++){var m=d.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[p];m.isReadyPositions(n,o.vboMemoryManager)||(a=!1),m.isReadyNormals(n,o.vboMemoryManager)||(a=!1),m.isReadyFaces(n,o.vboMemoryManager)||(a=!1)}h=t.readUInt8(e,r,r+1);r+=1,h&&(void 0===d.lego&&(d.lego=new Lego),r=this.parseBlockVersioned(e,r,d.lego,t,o))}}return this.fileLoadState=CODE.fileLoadState.PARSE_FINISHED,a},BlocksList.prototype.parseBlocksList=function(e,t,i,o){this.fileLoadState=CODE.fileLoadState.PARSE_STARTED;var r,n,a,s,l,c=0,h=t.readUInt32(e,c,c+4);c+=4;for(var d=o.vboMemoryManager,u=0,f=0,g=0,p=o.sceneState.gl,m=!0,y=0;y<h;y++){var v=t.readInt32(e,c,c+4);if(c+=4,i[v]){c+=24;var x=t.readInt32(e,c,c+4);c+=4;for(var b=0;b<x;b++){var C=t.readUInt32(e,c,c+4);r=c+=4,n=c+4*(T=3*C),c+=4*T,C=t.readUInt32(e,c,c+4),c+=4,c+=1*(L=3*C);var M=t.readUInt32(e,c,c+4);c+=4;var _=t.readUInt8(e,c,c+1);c+=1,c+=4*_,c+=4*_,c+=2*M}}else{var A=new Block;A.idx=v,i[v]=A;var R=new BoundingBox;R.minX=new Float32Array(e.slice(c,c+4)),c+=4,R.minY=new Float32Array(e.slice(c,c+4)),c+=4,R.minZ=new Float32Array(e.slice(c,c+4)),c+=4,R.maxX=new Float32Array(e.slice(c,c+4)),c+=4,R.maxY=new Float32Array(e.slice(c,c+4)),c+=4,R.maxZ=new Float32Array(e.slice(c,c+4)),c+=4;var P=R.getMaxLength();A.isSmallObj=P<.5,A.radius=P/2,R.deleteObjects(),R=void 0;x=t.readInt32(e,c,c+4);c+=4;for(b=0;b<x;b++){var T;C=t.readUInt32(e,c,c+4);c+=4,a=4*(T=3*C),u=d.getClassifiedBufferSize(a),A.vertexCount=C,r=c,n=c+4*T;var L,S=A.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();S.posVboDataArray=new Float32Array(u),S.posVboDataArray.set(new Float32Array(e.slice(r,n))),S.posArrayByteSize=u,c+=4*T,C=t.readUInt32(e,c,c+4),c+=4,s=1*(L=3*C),f=d.getClassifiedBufferSize(s),r=c,n=c+1*L,S.norVboDataArray=new Int8Array(f),S.norVboDataArray.set(new Int8Array(e.slice(r,n))),S.norArrayByteSize=f,c+=1*L,l=2*(M=t.readUInt32(e,c,c+4)),g=d.getClassifiedBufferSize(l),c+=4;_=t.readUInt8(e,c,c+1);c+=1;for(var w=[],E=0;E<_;E++)w.push(new Float32Array(e.slice(c,c+4))),c+=4;var D=[];for(E=0;E<_;E++)D.push(t.readUInt32(e,c,c+4)),c+=4;var I=D[_-1];S.bigTrianglesIndicesCount=I,r=c,n=c+2*M,S.idxVboDataArray=new Int16Array(g),S.idxVboDataArray.set(new Int16Array(e.slice(r,n))),S.idxArrayByteSize=g,c+=2*M,S.indicesCount=M,S.isReadyPositions(p,o.vboMemoryManager)||(m=!1),S.isReadyNormals(p,o.vboMemoryManager)||(m=!1),S.isReadyFaces(p,o.vboMemoryManager)||(m=!1)}}}return this.fileLoadState=CODE.fileLoadState.PARSE_FINISHED,m};var BlocksListsContainer=function(){if(!(this instanceof BlocksListsContainer))throw new Error(Messages.CONSTRUCT_ERROR);this.blocksListsArray=[]};BlocksListsContainer.prototype.newBlocksList=function(e){var t=new BlocksList;return t.name=e,this.blocksListsArray.push(t),t},BlocksListsContainer.prototype.getBlockList=function(e){for(var t=this.blocksListsArray.length,i=!1,o=0,r=null;!i&&o<t;){var n=this.blocksListsArray[o];n.name===e&&(i=!0,r=n),o++}return r};var HierarchyManager=function(){if(!(this instanceof HierarchyManager))throw new Error(Messages.CONSTRUCT_ERROR);this.nodesArray=[],this.projectsMap={}};HierarchyManager.prototype.deleteNodes=function(e,t){this.projectsMap={};for(var i=this.nodesArray.length,o=0;o<i;o++)this.nodesArray[o]&&(this.nodesArray[o].deleteObjects(e,t),this.nodesArray[o]=void 0);this.nodesArray.length=0},HierarchyManager.prototype.getNodeByDataName=function(e,t,i){var o=this.getNodesMap(e);if(void 0!==o){var r;for(var n in o)if(Object.prototype.hasOwnProperty.call(o,n)){var a=o[n];if(void 0!==a.data&&a.data[t]===i){r=a;break}}return r}},HierarchyManager.prototype.getNodeByDataKey=function(e,t){var i=this.getNodesMap(e);if(void 0!==i)return i[t]},HierarchyManager.prototype.getRootNodes=function(e){void 0===e&&(e=[]);for(var t,i=this.nodesArray.length,o=0;o<i;o++)void 0===(t=this.nodesArray[o]).parent&&e.push(t);return e},HierarchyManager.prototype.existProject=function(e){return this.projectsMap.hasOwnProperty(e)},HierarchyManager.prototype.getNodesMap=function(e,t){var i=this.projectsMap[e];return void 0===i?(i={},void 0!==t&&(i.attributes=t),this.projectsMap[e]=i):void 0!==t&&void 0===i.attributes&&(i.attributes=t),i},HierarchyManager.prototype.newNode=function(e,t,i){var o=this.getNodesMap(t,i),r=new Node;return r.data={nodeId:e},this.nodesArray.push(r),o[e]=r,r};var InspectorBox=function(){if(!(this instanceof InspectorBox))throw new Error(Messages.CONSTRUCT_ERROR)},Lego=function(){if(!(this instanceof Lego))throw new Error(Messages.CONSTRUCT_ERROR);this.vbo_vicks_container=new VBOVertexIdxCacheKeysContainer,this.fileLoadState=CODE.fileLoadState.READY,this.bbox,this.dataArrayBuffer,this.selColor4,this.hasTexCoords,this.texture,this.textureName,this.legoKey,this.renderableType,this.hasColors};Lego.prototype.parseArrayBuffer=function(e,t,i){this.parseLegoData(t,e,i)},Lego.prototype.isReadyToRender=function(){return this.fileLoadState===CODE.fileLoadState.PARSE_FINISHED&&(void 0!==this.texture&&void 0!==this.texture.texId)},Lego.prototype.deleteObjects=function(e,t){void 0!==this.vbo_vicks_container&&(this.vbo_vicks_container.deleteGlObjects(e,t),this.vbo_vicks_container=void 0),this.fileLoadState=void 0,this.dataArrayBuffer=void 0,void 0!==this.selColor4&&(this.selColor4.deleteObjects(),this.selColor4=void 0),this.textureName=void 0,this.texture&&this.texture.deleteObjects(e),this.texture=void 0,this.bbox&&this.bbox.deleteObjects(),this.bbox=void 0},Lego.prototype.parsePointsCloudData=function(e,t,i){if(this.fileLoadState===CODE.fileLoadState.LOADING_FINISHED){var o=new DataStream(e,0,DataStream.LITTLE_ENDIAN),r=o.readInt32();if(r>7e7);var n=i.vboMemoryManager;this.fileLoadState=CODE.fileLoadState.PARSE_STARTED,this.bbox=new BoundingBox;var a=this.bbox,s=this.vbo_vicks_container.newVBOVertexIdxCacheKey();a.minX=o.readFloat32(),a.minY=o.readFloat32(),a.minZ=o.readFloat32(),a.maxX=o.readFloat32(),a.maxY=o.readFloat32(),a.maxZ=o.readFloat32(),this.bPositionsCompressed=o.readInt8();var l,c=3*r,h=n.getClassifiedBufferSize(c);if(this.bPositionsCompressed?(l=new Uint16Array(h)).set(o.readUint16Array(3*r)):(l=new Float32Array(h)).set(o.readFloat32Array(3*r)),s.vertexCount=r,s.posVboDataArray=l,s.posArrayByteSize=h,s.posArrayByteType=5123,this.hasNormals=o.readInt8(),this.hasColors=o.readInt8(),this.hasColors){var d=r,u=4*d,f=n.getClassifiedBufferSize(u),g=new Uint8Array(f);g.set(o.readUint8Array(4*d)),s.colVboDataArray=g,s.colArrayByteSize=f,s.colArrayByteType=5121}this.hasTexCoords=o.readInt8(),this.hasIndices=o.readInt8(),this.fileLoadState=CODE.fileLoadState.PARSE_FINISHED}},Lego.prototype.parseLegoData=function(e,t,i){if(this.fileLoadState===CODE.fileLoadState.LOADING_FINISHED){var o=i.vboMemoryManager,r=new DataStream(e,0,DataStream.LITTLE_ENDIAN);this.fileLoadState=CODE.fileLoadState.PARSE_STARTED,this.bbox=new BoundingBox;var n=this.bbox,a=this.vbo_vicks_container.newVBOVertexIdxCacheKey();n.minX=r.readFloat32(),n.minY=r.readFloat32(),n.minZ=r.readFloat32(),n.maxX=r.readFloat32(),n.maxY=r.readFloat32(),n.maxZ=r.readFloat32();var s=r.readUint32(),l=3*s,c=o.getClassifiedBufferSize(l),h=new Float32Array(c);if(h.set(r.readFloat32Array(3*s)),a.vertexCount=s,a.posVboDataArray=h,a.posArrayByteSize=c,r.readUint8()){var d=r.readUint32(),u=3*d,f=o.getClassifiedBufferSize(u),g=new Int8Array(f);g.set(r.readInt8Array(3*d)),a.norVboDataArray=g,a.norArrayByteSize=f}if(r.readUint8()){var p=r.readUint32(),m=4*p,y=o.getClassifiedBufferSize(m),v=new Uint8Array(y);v.set(r.readUint8Array(4*p)),a.colVboDataArray=v,a.colArrayByteSize=y}if(this.hasTexCoords=r.readUint8(),this.hasTexCoords){r.readUint16();var x=r.readUint32(),b=2*x,C=o.getClassifiedBufferSize(b),M=new Float32Array(C);M.set(r.readFloat32Array(2*x)),a.tcoordVboDataArray=M,a.tcoordArrayByteSize=C}this.fileLoadState=CODE.fileLoadState.PARSE_FINISHED;var _=!0;return a.isReadyPositions(t,i.vboMemoryManager)||(_=!1),a.isReadyNormals(t,i.vboMemoryManager)||(_=!1),a.isReadyColors(t,i.vboMemoryManager)||(_=!1),this.hasTexCoords&&(a.isReadyTexCoords(t,i.vboMemoryManager)||(_=!1)),_}};var LoadData=function(){if(!(this instanceof LoadData))throw new Error(Messages.CONSTRUCT_ERROR);this.dataType,this.distToCam,this.lod,this.filePath,this.texFilePath,this.skinMesh,this.octree,this.texture};LoadData.prototype.deleteObjects=function(){this.dataType=void 0,this.distToCam=void 0,this.lod=void 0,this.filePath=void 0,this.texFilePath=void 0,this.skinMesh=void 0,this.octree=void 0,this.texture=void 0};var LoadQueue=function(e){if(!(this instanceof LoadQueue))throw new Error(Messages.CONSTRUCT_ERROR);this.magoManager,void 0!==e&&(this.magoManager=e),this.lod2SkinDataMap={},this.lod2PCloudDataMap={},this.lowLodSkinDataMap={},this.lowLodSkinTextureMap={}};LoadQueue.prototype.putLod2SkinData=function(e,t,i,o,r){e.lego.fileLoadState=CODE.fileLoadState.IN_QUEUE;var n=new LoadData;n.filePath=t,n.octree=e,n.texFilePath=o,n.texture=i,this.lod2SkinDataMap[t]=n},LoadQueue.prototype.putLod2PCloudData=function(e,t,i,o,r){e.lego.fileLoadState=CODE.fileLoadState.IN_QUEUE;var n=new LoadData;n.filePath=t,n.octree=e,n.texFilePath=o,n.texture=i,this.lod2PCloudDataMap[t]=n},LoadQueue.prototype.putLowLodSkinData=function(e,t,i){e.fileLoadState=CODE.fileLoadState.IN_QUEUE;var o=new LoadData;o.dataType=3,o.filePath=t,o.skinMesh=e,this.lowLodSkinDataMap[e.legoKey]=o},LoadQueue.prototype.putLowLodSkinTexture=function(e,t,i){t.fileLoadState=CODE.fileLoadState.IN_QUEUE;var o=new LoadData;o.dataType=4,o.filePath=e,o.texture=t,this.lowLodSkinTextureMap[e]=o},LoadQueue.prototype.resetQueue=function(){for(var e in this.lod2SkinDataMap){void 0!==(t=this.lod2SkinDataMap[e]).octree&&void 0!==t.octree.lego&&(t.octree.lego.fileLoadState=CODE.fileLoadState.READY)}for(var e in this.lod2SkinDataMap={},this.lowLodSkinDataMap){void 0!==(t=this.lowLodSkinDataMap[e]).skinMesh&&(t.skinMesh.fileLoadState=CODE.fileLoadState.READY)}for(var e in this.lowLodSkinDataMap={},this.lowLodSkinTextureMap){void 0!==(t=this.lowLodSkinTextureMap[e]).texture&&(t.texture.fileLoadState=CODE.fileLoadState.READY)}for(var e in this.lowLodSkinTextureMap={},this.lod2PCloudDataMap){var t;void 0!==(t=this.lod2PCloudDataMap[e]).octree&&void 0!==t.octree.lego&&(t.octree.lego.fileLoadState=CODE.fileLoadState.READY)}this.lod2PCloudDataMap={}},LoadQueue.prototype.manageQueue=function(){var e=this.magoManager.readerWriter,t=this.magoManager.sceneState.gl,i=0;for(var o in i=0,this.lod2SkinDataMap){var r=(s=this.lod2SkinDataMap[o]).octree,n=s.filePath;if(void 0!==r.lego)void 0!==s.texture&&s.texture.fileLoadState===CODE.fileLoadState.READY&&(e.readLegoSimpleBuildingTexture(t,s.texFilePath,s.texture,this.magoManager),i+=4),e.getOctreeLegoArraybuffer(n,r,this.magoManager);else;if(delete this.lod2SkinDataMap[o],s.deleteObjects(),s=void 0,++i>4){!0;break}}if(!this.magoManager.fileRequestControler.isFullPlusLowLodImages()){for(var o in i=0,this.lowLodSkinTextureMap){var a=(s=this.lowLodSkinTextureMap[o]).skinMesh;n=s.filePath;if(e.readLegoSimpleBuildingTexture(t,n,s.texture,this.magoManager),delete this.lowLodSkinTextureMap[o],s.deleteObjects(),s=void 0,++i>1)break}for(var o in i=0,this.lowLodSkinDataMap){a=(s=this.lowLodSkinDataMap[o]).skinMesh,n=s.filePath;if(e.getLegoArraybuffer(n,a,this.magoManager),delete this.lowLodSkinDataMap[o],s.deleteObjects(),s=void 0,++i>1)break}for(var o in i=0,this.lod2PCloudDataMap){var s;r=(s=this.lod2PCloudDataMap[o]).octree,n=s.filePath;if(void 0!==r.lego)e.getOctreePCloudArraybuffer(n,r,this.magoManager);else;if(delete this.lod2PCloudDataMap[o],s.deleteObjects(),s=void 0,++i>4){!0;break}}this.resetQueue()}};var LodBuildingData=function(){if(!(this instanceof LodBuildingData))throw new Error(Messages.CONSTRUCT_ERROR);this.lod,this.isModelRef,this.geometryFileName,this.textureFileName},MetaData=function(){if(!(this instanceof MetaData))throw new Error(Messages.CONSTRUCT_ERROR);this.guid,this.version="",this.geographicCoord,this.heading,this.pitch,this.roll,this.bbox,this.imageLodCount,this.projectDataType,this.offSetX,this.offSetY,this.offSetZ,this.oct_min_x=0,this.oct_max_x=0,this.oct_min_y=0,this.oct_max_y=0,this.oct_min_z=0,this.oct_max_z=0,this.isSmall=!1,this.fileLoadState=CODE.fileLoadState.READY};MetaData.prototype.deleteObjects=function(){this.guid=void 0,this.geographicCoord&&this.geographicCoord.deleteObjects(),this.geographicCoord=void 0,this.heading=void 0,this.pitch=void 0,this.roll=void 0,this.bbox&&this.bbox.deleteObjects(),this.bbox=void 0,this.imageLodCount=void 0,this.oct_min_x=void 0,this.oct_max_x=void 0,this.oct_min_y=void 0,this.oct_max_y=void 0,this.oct_min_z=void 0,this.oct_max_z=void 0,this.isSmall=void 0,this.fileLoadState=void 0},MetaData.prototype.parseFileHeaderAsimetricVersion=function(e,t){var i,o=0;void 0===t&&(t=new ReaderWriter),this.version="";for(var r=0;r<5;r++)this.version+=String.fromCharCode(new Int8Array(e.slice(o,o+1))),o+=1;void 0===this.guid&&(this.guid=""),i=t.readInt32(e,o,o+4),o+=4;for(r=0;r<i;r++)this.guid+=String.fromCharCode(new Int8Array(e.slice(o,o+1))),o+=1;void 0===this.longitude?(this.longitude=new Float64Array(e.slice(o,o+8))[0],o+=8):o+=8,void 0===this.latitude?(this.latitude=new Float64Array(e.slice(o,o+8))[0],o+=8):o+=8,void 0===this.altitude?(this.altitude=new Float32Array(e.slice(o,o+4))[0],o+=4):o+=4,void 0===this.bbox&&(this.bbox=new BoundingBox),this.bbox.minX=new Float32Array(e.slice(o,o+4))[0],o+=4,this.bbox.minY=new Float32Array(e.slice(o,o+4))[0],o+=4,this.bbox.minZ=new Float32Array(e.slice(o,o+4))[0],o+=4,this.bbox.maxX=new Float32Array(e.slice(o,o+4))[0],o+=4,this.bbox.maxY=new Float32Array(e.slice(o,o+4))[0],o+=4,this.bbox.maxZ=new Float32Array(e.slice(o,o+4))[0],o+=4;var n=!1;return(this.bbox.maxX-this.bbox.minX>40||this.bbox.maxY-this.bbox.minY>40)&&(n=!0),!n&&this.bbox.maxZ-this.bbox.minZ<30&&(this.isSmall=!0),"0.0.2"===this.version&&(this.projectDataType=new Uint16Array(e.slice(o,o+2))[0],o+=2,this.offSetX=new Float64Array(e.slice(o,o+8))[0],o+=8,this.offSetY=new Float64Array(e.slice(o,o+8))[0],o+=8,this.offSetZ=new Float64Array(e.slice(o,o+8))[0],o+=8),o};var ModelReferencedGroup=function(){if(!(this instanceof ModelReferencedGroup))throw new Error(Messages.CONSTRUCT_ERROR);this.modelIdx,this.referencesIdxArray=[]},ModelReferencedGroupsList=function(){if(!(this instanceof ModelReferencedGroupsList))throw new Error(Messages.CONSTRUCT_ERROR);this.modelReferencedGroupsMap=[],this.modelReferencedGroupsArray=[]};ModelReferencedGroupsList.prototype.getModelReferencedGroup=function(e){var t=this.modelReferencedGroupsMap[e];return void 0===t&&((t=new ModelReferencedGroup).modelIdx=e,this.modelReferencedGroupsMap[e]=t),t},ModelReferencedGroupsList.prototype.makeModelReferencedGroupsArray=function(){this.modelReferencedGroupsArray.length=0;for(var e=this.modelReferencedGroupsMap.length,t=0;t<e;t++)void 0!==this.modelReferencedGroupsMap[t]&&this.modelReferencedGroupsArray.push(this.modelReferencedGroupsMap[t]);this.modelReferencedGroupsMap.length=0},ModelReferencedGroupsList.prototype.createModelReferencedGroups=function(e,t){if(void 0!==e&&void 0!==t){for(var i,o,r=e.length,n=0;n<r;n++)o=t[i=e[n]]._block_idx,this.getModelReferencedGroup(o).referencesIdxArray.push(i);this.makeModelReferencedGroupsArray()}};var NeoBuilding=function(){if(!(this instanceof NeoBuilding))throw new Error(Messages.CONSTRUCT_ERROR);this.name="",this.metaData,this.buildingId,this.buildingType,this.buildingFileName="",this.bbox,this.bboxAbsoluteCenterPos,this.motherNeoReferencesArray=[],this.motherNeoReferencesMap,this.motherBlocksArray=[],this.currentVisibleOctreesControler,this.isHighLighted,this.isColorChanged,this.aditionalColor,this.texturesLoaded,this.octree,this.distToCam,this.currentLod,this.simpleBuilding3x3Texture,this.lodMeshesMap,this.lodBuildingDatasMap,this.applyOcclusionCulling};NeoBuilding.prototype.getImageFileNameForLOD=function(e){var t=this.getLodBuildingData(e);if(void 0!==t)return t.textureFileName},NeoBuilding.prototype.getReferenceObject=function(e){if(void 0!==this.motherNeoReferencesArray)return this.motherNeoReferencesArray[e]},NeoBuilding.prototype.getReferenceObjectsArrayByObjectId=function(e){if(void 0!==this.motherNeoReferencesMap)return this.motherNeoReferencesMap[e]},NeoBuilding.prototype.putReferenceObject=function(e,t){void 0===this.motherNeoReferencesArray&&(this.motherNeoReferencesArray=[]),this.motherNeoReferencesArray[t]=e,void 0===this.motherNeoReferencesMap&&(this.motherNeoReferencesMap={});var i=this.motherNeoReferencesMap[e.objectId];void 0===i&&(i=[]),i.push(e),this.motherNeoReferencesMap[e.objectId]=i},NeoBuilding.prototype.getRenderSettingApplyOcclusionCulling=function(){return this.applyOcclusionCulling},NeoBuilding.prototype.setRenderSettingApplyOcclusionCulling=function(e){this.applyOcclusionCulling=e},NeoBuilding.prototype.deleteObjectsModelReferences=function(e,t){this.motherNeoReferencesMap&&(this.motherNeoReferencesMap={},this.motherNeoReferencesMap=void 0);for(var i=this.motherBlocksArray.length,o=0;o<i;o++)this.motherBlocksArray[o]&&this.motherBlocksArray[o].deleteObjects(e,t),this.motherBlocksArray[o]=void 0;this.motherBlocksArray=[];var r=this.motherNeoReferencesArray.length;for(o=0;o<r;o++)this.motherNeoReferencesArray[o]&&this.motherNeoReferencesArray[o].deleteObjects(e,t),this.motherNeoReferencesArray[o]=void 0;if(this.motherNeoReferencesArray=[],this.texturesLoaded){var n,a=this.texturesLoaded.length;for(o=0;o<a;o++)(n=this.texturesLoaded[o])&&n.texId&&(e.deleteTexture(n.texId),n.texId=void 0,n.fileLoadState=CODE.fileLoadState.READY)}},NeoBuilding.prototype.deleteObjectsLodMesh=function(e,t,i){if(void 0!==this.lodMeshesMap&&Object.prototype.hasOwnProperty.call(this.lodMeshesMap,i)){var o=this.lodMeshesMap[i];if(void 0===o)return;delete this.lodMeshesMap[i],o.deleteObjects(e,t),o=void 0}},NeoBuilding.prototype.deleteObjectsLod2=function(e,t){void 0!==this.octree&&this.octree.deleteObjectsLego(e,t)},NeoBuilding.prototype.deleteObjects=function(e,t,i){if(i&&(this.metaData.deleteObjects(),this.metaData.fileLoadState=CODE.fileLoadState.READY),this.deleteObjectsModelReferences(e,t),void 0!==this.octree&&this.octree.deleteObjects(e,t),this.octree=void 0,this.allFilesLoaded=!1,this.isReadyToRender=!1,this.texturesLoaded){for(var o=this.texturesLoaded.length,r=0;r<o;r++)this.texturesLoaded[r]&&this.texturesLoaded[r].deleteObjects(e),this.texturesLoaded[r]=void 0;this.texturesLoaded.length=0}if(this.texturesLoaded=void 0,void 0!==this.lodMeshesMap){for(var n in this.lodMeshesMap)if(Object.prototype.hasOwnProperty.call(this.lodMeshesMap,n)){var a=this.lodMeshesMap[n];if(void 0===a)continue;a.deleteObjects(e,t),a=void 0}this.lodMeshesMap=void 0}},NeoBuilding.prototype.deleteLodMesh=function(e,t,i){if(void 0!==this.lodMeshesMap){var o=this.lodMeshesMap[t];void 0!==o&&(o.deleteObjects(e,i),o=void 0)}},NeoBuilding.prototype.getBBoxCenterPositionWorldCoord=function(e){return void 0===this.bboxAbsoluteCenterPos&&this.calculateBBoxCenterPositionWorldCoord(e),this.bboxAbsoluteCenterPos},NeoBuilding.prototype.calculateBBoxCenterPositionWorldCoord=function(e){var t,i;(t=this.bbox.getCenterPoint(t),this.bboxAbsoluteCenterPos=e.tMatrix.transformPoint3D(t,this.bboxAbsoluteCenterPos),e.pivotPointTraslation)&&(i=e.tMatrix.rotatePoint3D(e.pivotPointTraslation,i),this.bboxAbsoluteCenterPos.add(i.x,i.y,i.z))},NeoBuilding.prototype.getTextureId=function(e){for(var t,i=this.texturesLoaded.length,o=!1,r=0;!o&&r<i;)this.texturesLoaded[r].textureImageFileName===e.textureImageFileName&&(o=!0,t=this.texturesLoaded[r].texId),r++;return t},NeoBuilding.prototype.getSameTexture=function(e){for(var t,i=this.texturesLoaded.length,o=!1,r=0;!o&&r<i;)this.texturesLoaded[r].textureImageFileName===e.textureImageFileName&&(o=!0,t=this.texturesLoaded[r]),r++;return t},NeoBuilding.prototype.updateCurrentVisibleIndicesExterior=function(e,t,i){this._neoRefLists_Container.updateCurrentVisibleIndicesOfLists(e,t,i)},NeoBuilding.prototype.updateCurrentAllIndicesExterior=function(){this._neoRefLists_Container.updateCurrentAllIndicesOfLists()},NeoBuilding.prototype.isCameraInsideOfBuilding=function(e,t,i){return this.metaData.bbox.isPoint3dInside(e,t,i)},NeoBuilding.prototype.getTransformedRelativeEyePositionToBuilding=function(e,t,i,o){var r=this.buildingPosition,n=e-r.x,a=t-r.y,s=i-r.z;void 0===this.buildingPosMatInv&&(this.buildingPosMatInv=new Matrix4,this.buildingPosMatInv.setByFloat32Array(this.moveMatrixInv));var l=new Point3D;return void 0===o&&(o=new Point3D),l.set(n,a,s),o=this.buildingPosMatInv.transformPoint3D(l,o)},NeoBuilding.prototype.getHeaderVersion=function(){return this.metaData.version},NeoBuilding.prototype.getLodBuildingData=function(e){if(void 0!==this.lodBuildingDatasMap)return this.lodBuildingDatasMap[e]},NeoBuilding.prototype.getCurrentLodString=function(){return this.getLodBuildingData(this.currentLod).geometryFileName},NeoBuilding.prototype.getCurrentSkin=function(){if(void 0!==this.lodMeshesMap){var e,t=this.getLodBuildingData(this.currentLod);if(void 0!==t){var i=t.geometryFileName;return void 0!==(e=this.lodMeshesMap[i])&&e.isReadyToRender()?e:(0===this.currentLod?void 0!==(e=this.lodMeshesMap.lod0)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod1)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod2)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod3)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod4)&&e.isReadyToRender()||(e=this.lodMeshesMap.lod5):1===this.currentLod?void 0!==(e=this.lodMeshesMap.lod1)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod2)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod3)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod4)&&e.isReadyToRender()||(e=this.lodMeshesMap.lod5):2===this.currentLod?void 0!==(e=this.lodMeshesMap.lod2)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod3)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod4)&&e.isReadyToRender()||(e=this.lodMeshesMap.lod5):3===this.currentLod?void 0!==(e=this.lodMeshesMap.lod3)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod4)&&e.isReadyToRender()||(e=this.lodMeshesMap.lod5):4===this.currentLod?void 0!==(e=this.lodMeshesMap.lod4)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod5)&&e.isReadyToRender()||(e=this.lodMeshesMap.lod3):5===this.currentLod&&(void 0!==(e=this.lodMeshesMap.lod5)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod4)&&e.isReadyToRender()||(e=this.lodMeshesMap.lod3)),e)}}},NeoBuilding.prototype.manageNeoReferenceTexture=function(e,t){var i=void 0;if("v"===this.metaData.version[0]){if(void 0===e.texture)return;if(void 0===e.texture.texId&&""!==e.texture.textureImageFileName){void 0===this.texturesLoaded&&(this.texturesLoaded=[]);var o=this.getSameTexture(e.texture);if(void 0===o){if(t.backGround_fileReadings_count>10)return;if(e.texture.fileLoadState===CODE.fileLoadState.READY){var r=t.sceneState.gl;e.texture.texId=r.createTexture();var n=this.projectFolderName,a=t.readerWriter.geometryDataPath+"/"+n+"/"+this.buildingFileName+"/Images_Resized/"+e.texture.textureImageFileName;this.texturesLoaded.push(e.texture),t.readerWriter.readNeoReferenceTexture(r,a,e.texture,this,t),t.backGround_fileReadings_count++}}else o.fileLoadState===CODE.fileLoadState.LOADING_FINISHED&&(e.texture=o)}return e.texture.fileLoadState}if("0"===this.metaData.version[0]&&"0"===this.metaData.version[2]&&"1"===this.metaData.version[4]){if(void 0===e.texture||e.texture.fileLoadState===CODE.fileLoadState.READY){var s=e.materialId;if(i=this.texturesLoaded[s],e.texture=i,void 0===i.texId&&""!==i.textureImageFileName){if(t.backGround_fileReadings_count>10)return;if(i.fileLoadState===CODE.fileLoadState.READY){r=t.sceneState.gl;i.texId=r.createTexture();n=this.projectFolderName,a=t.readerWriter.getCurrentDataPath()+"/"+n+"/"+this.buildingFileName+"/Images_Resized/"+i.textureImageFileName;t.readerWriter.readNeoReferenceTexture(r,a,i,this,t),t.backGround_fileReadings_count++}}}return e.texture.fileLoadState}};var NeoBuildingsList=function(){if(!(this instanceof NeoBuildingsList))throw new Error(Messages.CONSTRUCT_ERROR);this.neoBuildingsArray=[]};NeoBuildingsList.prototype.newNeoBuilding=function(){var e=new NeoBuilding;return this.neoBuildingsArray.push(e),e},NeoBuildingsList.prototype.getNeoBuildingByTypeId=function(e,t){for(var i,o=this.neoBuildingsArray.length,r=!1,n=0;!r&&n<o;)this.neoBuildingsArray[n].buildingType===e&&this.neoBuildingsArray[n].buildingId===t&&(r=!0,i=this.neoBuildingsArray[n]),n++;return i},NeoBuildingsList.prototype.get=function(e){return this.neoBuildingsArray[e]},NeoBuildingsList.prototype.add=function(e){void 0!==e&&this.neoBuildingsArray.push(e)};var NeoReference=function(){if(!(this instanceof NeoReference))throw new Error(Messages.CONSTRUCT_ERROR);this._id=0,this.objectId="",this._block_idx=-1,this._matrix4=new Matrix4,this._originalMatrix4=new Matrix4,this.tMatrixAuxArray,this.refMatrixType=2,this.refTranslationVec,this.vBOVertexIdxCacheKeysContainer,this.materialId,this.hasTexture=!1,this.texture,this.color4,this.aditionalColor,this.vertexCount=0,this.moveVectorRelToBuilding,this.moveVector,this.renderingFase=!1};NeoReference.prototype.swapRenderingFase=function(){this.renderingFase=!this.renderingFase},NeoReference.prototype.multiplyTransformMatrix=function(e){this._matrix4=this._originalMatrix4.getMultipliedByMatrix(e)},NeoReference.prototype.multiplyKeyTransformMatrix=function(e,t){void 0===this.tMatrixAuxArray&&(this.tMatrixAuxArray=[]),this.tMatrixAuxArray[e]=this._originalMatrix4.getMultipliedByMatrix(t,this.tMatrixAuxArray[e]),this.moveVectorRelToBuilding&&(this.moveVector=t.rotatePoint3D(this.moveVectorRelToBuilding,this.moveVector))},NeoReference.prototype.hasKeyMatrix=function(e){return void 0!==this.tMatrixAuxArray&&void 0!==this.tMatrixAuxArray[e]},NeoReference.prototype.deleteObjects=function(e,t){this._id=void 0,this._block_idx=void 0,this._matrix4._floatArrays=void 0,this._matrix4=void 0,this._originalMatrix4._floatArrays=void 0,this._originalMatrix4=void 0,this.hasTexture=void 0,this.texture=void 0,this.color4&&this.color4.deleteObjects(),this.color4=void 0,this.selColor4&&this.selColor4.deleteObjects(),this.selColor4=void 0,this.vertexCount=void 0,this.moveVector&&this.moveVector.deleteObjects(),this.moveVector=void 0,this.bRendered=void 0,void 0!==this.vBOVertexIdxCacheKeysContainer&&(this.vBOVertexIdxCacheKeysContainer.deleteGlObjects(e,t),this.vBOVertexIdxCacheKeysContainer=void 0)};var NeoReferencesMotherAndIndices=function(){if(!(this instanceof NeoReferencesMotherAndIndices))throw new Error(Messages.CONSTRUCT_ERROR);this.motherNeoRefsList,this.neoRefsIndices=[],this.modelReferencedGroupsList,this.blocksList,this.fileLoadState=0,this.dataArraybuffer,this.succesfullyGpuDataBinded,this.exterior_ocCullOctree,this.interior_ocCullOctree,this.currentVisibleIndices=[],this.currentVisibleMRG};NeoReferencesMotherAndIndices.prototype.multiplyKeyTransformMatrix=function(e,t){for(var i=this.neoRefsIndices.length,o=0;o<i;o++)this.motherNeoRefsList[this.neoRefsIndices[o]].multiplyKeyTransformMatrix(e,t)},NeoReferencesMotherAndIndices.prototype.updateCurrentVisibleIndices=function(e,t,i,o){void 0===o&&(o=!0);var r=!1;if(void 0!==this.interior_ocCullOctree){var n=!1;if(this.interior_ocCullOctree._subBoxesArray&&this.interior_ocCullOctree._subBoxesArray.length>0&&(n=!0),n&&o){var a=this.interior_ocCullOctree.getIntersectedSubBoxByPoint3D(e,t,i);void 0!==a&&a._indicesArray.length>0?(this.currentVisibleIndices=a._indicesArray,r=!1):r=!0}else this.currentVisibleIndices=this.neoRefsIndices,this.currentVisibleMRG=this.modelReferencedGroupsList}if(r&&void 0!==this.exterior_ocCullOctree){n=!1;this.exterior_ocCullOctree._subBoxesArray&&this.exterior_ocCullOctree._subBoxesArray.length>0&&(n=!0),n&&o?(void 0===this.currentVisibleMRG&&(this.currentVisibleMRG=new ModelReferencedGroupsList),this.currentVisibleIndices=this.exterior_ocCullOctree.getIndicesVisiblesForEye(e,t,i,this.currentVisibleIndices,this.currentVisibleMRG)):(this.currentVisibleIndices=this.neoRefsIndices,this.currentVisibleMRG=this.modelReferencedGroupsList)}},NeoReferencesMotherAndIndices.prototype.getNeoReference=function(e){return this.motherNeoRefsList[this.neoRefsIndices[e]]},NeoReferencesMotherAndIndices.prototype.deleteObjects=function(e,t){this.motherNeoRefsList=void 0,this.neoRefsIndices=void 0,this.blocksList=void 0,this.fileLoadState=void 0,this.dataArraybuffer=void 0,this.exterior_ocCullOctree=void 0,this.interior_ocCullOctree=void 0},NeoReferencesMotherAndIndices.prototype.setRenderedFalseToAllReferences=function(){for(var e=this.neoRefsIndices.length,t=0;t<e;t++)this.motherNeoRefsList[this.neoRefsIndices[t]].bRendered=!1},NeoReferencesMotherAndIndices.prototype.createModelReferencedGroups=function(){void 0!==this.neoRefsIndices&&(void 0===this.modelReferencedGroupsList&&(this.modelReferencedGroupsList=new ModelReferencedGroupsList),this.modelReferencedGroupsList.createModelReferencedGroups(this.neoRefsIndices,this.motherNeoRefsList))},NeoReferencesMotherAndIndices.prototype.parseArrayBufferReferencesVersioned=function(e,t,i,o,r,n){var a,s;this.fileLoadState=CODE.fileLoadState.PARSE_STARTED;var l,c,h,d,u,f=0,g=n.vboMemoryManager,p=0,m=0;this.succesfullyGpuDataBinded=!0;String.fromCharCode.apply(null,new Int8Array(t.slice(f,f+5)));f+=5;var y=i.readUInt32(t,f,f+4);f+=4;for(var v=0;v<y;v++){var x=new NeoReference,b=i.readUInt32(t,f,f+4);if(f+=4,x._id=b,this.motherNeoRefsList=o.motherNeoReferencesArray,void 0!==this.motherNeoRefsList[x._id]){x=this.motherNeoRefsList[x._id],void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(x._id);var C=i.readUInt8(t,f,f+1);f+=1;var M=String.fromCharCode.apply(null,new Int8Array(t.slice(f,f+C)));x.objectId=M,f+=C;var _=i.readUInt32(t,f,f+4);f+=4,x._block_idx=_;var A=i.readUInt8(t,f,f+1);f+=1,0===A||(1===A?(i.readFloat32(t,f,f+4),f+=4,i.readFloat32(t,f,f+4),f+=4,i.readFloat32(t,f,f+4),f+=4):2===A&&(i.readFloat32(t,f,f+4),f+=4,i.readFloat32(t,f,f+4),f+=4,i.readFloat32(t,f,f+4),f+=4,i.readFloat32(t,f,f+4),f+=4,i.readFloat32(t,f,f+4),f+=4,i.readFloat32(t,f,f+4),f+=4,i.readFloat32(t,f,f+4),f+=4,i.readFloat32(t,f,f+4),f+=4,i.readFloat32(t,f,f+4),f+=4,i.readFloat32(t,f,f+4),f+=4,i.readFloat32(t,f,f+4),f+=4,i.readFloat32(t,f,f+4),f+=4,i.readFloat32(t,f,f+4),f+=4,i.readFloat32(t,f,f+4),f+=4,i.readFloat32(t,f,f+4),f+=4,i.readFloat32(t,f,f+4),f+=4));var R=i.readUInt8(t,f,f+1);if(f+=1,R){var P=i.readUInt16(t,f,f+2);f+=2;var T=i.readUInt8(t,f,f+1);f+=1,5121===P&&(N=1);var L=i.readUInt8(t,f,f+N);f+=N;var S=i.readUInt8(t,f,f+N);f+=N;var w=i.readUInt8(t,f,f+N);f+=N;var E=255;4===T&&(E=i.readUInt8(t,f,f+N),f+=N)}var D=i.readUInt8(t,f,f+1);f+=1;var I=i.readUInt8(t,f,f+1);if(f+=1,D||I){var O=i.readInt32(t,f,f+4);f+=4;for(var V=0;V<O;V++){if(D){P=i.readUInt16(t,f,f+2);f+=2;T=i.readUInt8(t,f,f+1);f+=1,5120===P||5121===P?N=1:5122===P||5123===P?N=2:5126===P&&(N=4);var B=i.readUInt32(t,f,f+4);a=f+=4,s=f+N*(U=B*T),f+=N*U}if(I){P=i.readUInt16(t,f,f+2);f+=2,5120===P||5121===P?N=1:5122===P||5123===P?N=2:5126===P&&(N=4);B=i.readUInt32(t,f,f+4);a=f+=4,s=f+N*(U=2*B),f+=N*U}}}i.readInt32(t,f,f+4);f+=4,0===x.refMatrixType&&1,1===x.refMatrixType&&1,2===x.refMatrixType&&1}else{void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(x._id);C=i.readUInt8(t,f,f+1);f+=1,"noObjectId"===(M=String.fromCharCode.apply(null,new Int8Array(t.slice(f,f+C))))&&(M=x._id),x.objectId=M,f+=C,o.putReferenceObject(x,x._id);_=i.readUInt32(t,f,f+4);f+=4,x._block_idx=_,x.refMatrixType=i.readUInt8(t,f,f+1),f+=1,0===x.refMatrixType?1:1===x.refMatrixType?(h=i.readFloat32(t,f,f+4),f+=4,d=i.readFloat32(t,f,f+4),f+=4,u=i.readFloat32(t,f,f+4),f+=4,x.refTranslationVec=new Float32Array([h,d,u]),1):2===x.refMatrixType&&(x._originalMatrix4._floatArrays[0]=i.readFloat32(t,f,f+4),f+=4,x._originalMatrix4._floatArrays[1]=i.readFloat32(t,f,f+4),f+=4,x._originalMatrix4._floatArrays[2]=i.readFloat32(t,f,f+4),f+=4,x._originalMatrix4._floatArrays[3]=i.readFloat32(t,f,f+4),f+=4,x._originalMatrix4._floatArrays[4]=i.readFloat32(t,f,f+4),f+=4,x._originalMatrix4._floatArrays[5]=i.readFloat32(t,f,f+4),f+=4,x._originalMatrix4._floatArrays[6]=i.readFloat32(t,f,f+4),f+=4,x._originalMatrix4._floatArrays[7]=i.readFloat32(t,f,f+4),f+=4,x._originalMatrix4._floatArrays[8]=i.readFloat32(t,f,f+4),f+=4,x._originalMatrix4._floatArrays[9]=i.readFloat32(t,f,f+4),f+=4,x._originalMatrix4._floatArrays[10]=i.readFloat32(t,f,f+4),f+=4,x._originalMatrix4._floatArrays[11]=i.readFloat32(t,f,f+4),f+=4,x._originalMatrix4._floatArrays[12]=i.readFloat32(t,f,f+4),f+=4,x._originalMatrix4._floatArrays[13]=i.readFloat32(t,f,f+4),f+=4,x._originalMatrix4._floatArrays[14]=i.readFloat32(t,f,f+4),f+=4,x._originalMatrix4._floatArrays[15]=i.readFloat32(t,f,f+4),f+=4,1);R=i.readUInt8(t,f,f+1);if(f+=1,R){P=i.readUInt16(t,f,f+2);f+=2;T=i.readUInt8(t,f,f+1);f+=1,5121===P&&(N=1);L=i.readUInt8(t,f,f+N);f+=N;S=i.readUInt8(t,f,f+N);f+=N;w=i.readUInt8(t,f,f+N);f+=N;E=255;4===T&&(E=i.readUInt8(t,f,f+N),f+=N),x.color4=new Color,x.color4.set(L,S,w,E)}D=i.readUInt8(t,f,f+1);f+=1;I=i.readUInt8(t,f,f+1);if(f+=1,D||I){O=i.readInt32(t,f,f+4);f+=4,O>0&&void 0===x.vBOVertexIdxCacheKeysContainer&&(x.vBOVertexIdxCacheKeysContainer=new VBOVertexIdxCacheKeysContainer);for(V=0;V<O;V++){var F=x.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();if(D){P=i.readUInt16(t,f,f+2);f+=2;T=i.readUInt8(t,f,f+1);f+=1,5120===P||5121===P?N=1:5122===P||5123===P?N=2:5126===P&&(N=4);B=i.readUInt32(t,f,f+4);f+=4,l=N*(U=B*T),m=g.getClassifiedBufferSize(l),x.vertexCount=B,a=f,s=f+N*U,F.colVboDataArray=new Float32Array(m),F.colVboDataArray.set(new Float32Array(t.slice(a,s))),F.colArrayByteSize=m,f+=N*U,F.isReadyColors(e,n.vboMemoryManager)||(this.succesfullyGpuDataBinded=!1)}if(I){var N;P=i.readUInt16(t,f,f+2);f+=2,5120===P||5121===P?N=1:5122===P||5123===P?N=2:5126===P&&(N=4);var U;B=i.readUInt32(t,f,f+4);f+=4,c=N*(U=2*B),p=g.getClassifiedBufferSize(c),x.vertexCount=B,a=f,s=f+N*U,F.tcoordVboDataArray=new Float32Array(p),F.tcoordVboDataArray.set(new Float32Array(t.slice(a,s))),F.tcoordArrayByteSize=p,f+=N*U,F.isReadyTexCoords(e,n.vboMemoryManager)||(this.succesfullyGpuDataBinded=!1)}}}x.materialId=i.readInt32(t,f,f+4),f+=4,-1===x.materialId?x.hasTexture=!1:x.hasTexture=!0,r&&x.multiplyTransformMatrix(r)}}i.readUInt32(t,f,f+4);f+=4,void 0===this.exterior_ocCullOctree&&(this.exterior_ocCullOctree=new OcclusionCullingOctreeCell);var j=this.exterior_ocCullOctree;f=this.exterior_ocCullOctree.parseArrayBuffer(t,f,i),j.expandBox(1e3),j.setSizesSubBoxes(),j.createModelReferencedGroups(this.motherNeoRefsList),void 0===this.interior_ocCullOctree&&(this.interior_ocCullOctree=new OcclusionCullingOctreeCell);var H=this.interior_ocCullOctree;return f=this.interior_ocCullOctree.parseArrayBuffer(t,f,i),H.setSizesSubBoxes(),H.createModelReferencedGroups(this.motherNeoRefsList),this.fileLoadState=CODE.fileLoadState.PARSE_FINISHED,this.succesfullyGpuDataBinded},NeoReferencesMotherAndIndices.prototype.parseArrayBufferReferences=function(e,t,i,o,r,n){var a,s;this.fileLoadState=CODE.fileLoadState.PARSE_STARTED;var l=0,c=i.readUInt32(t,l,l+4);l+=4;var h,d,u=n.vboMemoryManager,f=0,g=0;this.succesfullyGpuDataBinded=!0;for(var p=0;p<c;p++){var m=new NeoReference,y=i.readUInt32(t,l,l+4);if(l+=4,m._id=y,this.motherNeoRefsList=o.motherNeoReferencesArray,void 0!==this.motherNeoRefsList[m._id]){m=this.motherNeoRefsList[m._id],void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(m._id);var v=i.readUInt8(t,l,l+1);l+=1;var x=String.fromCharCode.apply(null,new Int8Array(t.slice(l,l+v)));l+=v;var b=i.readUInt32(t,l,l+4);l+=4,m._block_idx=b,i.readFloat32(t,l,l+4),l+=4,i.readFloat32(t,l,l+4),l+=4,i.readFloat32(t,l,l+4),l+=4,i.readFloat32(t,l,l+4),l+=4,i.readFloat32(t,l,l+4),l+=4,i.readFloat32(t,l,l+4),l+=4,i.readFloat32(t,l,l+4),l+=4,i.readFloat32(t,l,l+4),l+=4,i.readFloat32(t,l,l+4),l+=4,i.readFloat32(t,l,l+4),l+=4,i.readFloat32(t,l,l+4),l+=4,i.readFloat32(t,l,l+4),l+=4,i.readFloat32(t,l,l+4),l+=4,i.readFloat32(t,l,l+4),l+=4,i.readFloat32(t,l,l+4),l+=4,i.readFloat32(t,l,l+4),l+=4;var C=i.readUInt8(t,l,l+1);if(l+=1,C){var M=i.readUInt16(t,l,l+2);l+=2;var _=i.readUInt8(t,l,l+1);l+=1,5121===M&&(F=1);var A=i.readUInt8(t,l,l+F);l+=F;var R=i.readUInt8(t,l,l+F);l+=F;var P=i.readUInt8(t,l,l+F);l+=F;var T=255;4===_&&(T=i.readUInt8(t,l,l+F),l+=F)}var L=i.readUInt8(t,l,l+1);l+=1;var S=i.readUInt8(t,l,l+1);if(l+=1,L||S){var w=i.readInt32(t,l,l+4);l+=4;for(var E=0;E<w;E++){if(L){M=i.readUInt16(t,l,l+2);l+=2;_=i.readUInt8(t,l,l+1);l+=1,5120===M||5121===M?F=1:5122===M||5123===M?F=2:5126===M&&(F=4);var D=i.readUInt32(t,l,l+4);a=l+=4,s=l+F*(N=D*_),l+=F*N}if(S){M=i.readUInt16(t,l,l+2);l+=2,5120===M||5121===M?F=1:5122===M||5123===M?F=2:5126===M&&(F=4);D=i.readUInt32(t,l,l+4);a=l+=4,s=l+F*(N=2*D),l+=F*N}}}var I=i.readUInt32(t,l,l+4);if(l+=4,I>0){var O=i.readUInt32(t,l,l+4);l+=4;for(E=0;E<O;E++)l+=1;var V=i.readUInt32(t,l,l+4);l+=4;for(E=0;E<V;E++)l+=1}0===m.refMatrixType&&1,1===m.refMatrixType&&1,2===m.refMatrixType&&1}else{void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(m._id);v=i.readUInt8(t,l,l+1);l+=1,"noObjectId"!==(x=String.fromCharCode.apply(null,new Int8Array(t.slice(l,l+v))))&&""!==x||(x=m._id),m.objectId=x,l+=v,o.putReferenceObject(m,m._id);b=i.readUInt32(t,l,l+4);l+=4,m._block_idx=b,m._originalMatrix4._floatArrays[0]=i.readFloat32(t,l,l+4),l+=4,m._originalMatrix4._floatArrays[1]=i.readFloat32(t,l,l+4),l+=4,m._originalMatrix4._floatArrays[2]=i.readFloat32(t,l,l+4),l+=4,m._originalMatrix4._floatArrays[3]=i.readFloat32(t,l,l+4),l+=4,m._originalMatrix4._floatArrays[4]=i.readFloat32(t,l,l+4),l+=4,m._originalMatrix4._floatArrays[5]=i.readFloat32(t,l,l+4),l+=4,m._originalMatrix4._floatArrays[6]=i.readFloat32(t,l,l+4),l+=4,m._originalMatrix4._floatArrays[7]=i.readFloat32(t,l,l+4),l+=4,m._originalMatrix4._floatArrays[8]=i.readFloat32(t,l,l+4),l+=4,m._originalMatrix4._floatArrays[9]=i.readFloat32(t,l,l+4),l+=4,m._originalMatrix4._floatArrays[10]=i.readFloat32(t,l,l+4),l+=4,m._originalMatrix4._floatArrays[11]=i.readFloat32(t,l,l+4),l+=4,m._originalMatrix4._floatArrays[12]=i.readFloat32(t,l,l+4),l+=4,m._originalMatrix4._floatArrays[13]=i.readFloat32(t,l,l+4),l+=4,m._originalMatrix4._floatArrays[14]=i.readFloat32(t,l,l+4),l+=4,m._originalMatrix4._floatArrays[15]=i.readFloat32(t,l,l+4),l+=4,m.refMatrixType=m._originalMatrix4.computeMatrixType(),0===m.refMatrixType&&1,1===m.refMatrixType&&(m.refTranslationVec=new Float32Array([m._originalMatrix4._floatArrays[12],m._originalMatrix4._floatArrays[13],m._originalMatrix4._floatArrays[14]]),1),2===m.refMatrixType&&1;C=i.readUInt8(t,l,l+1);if(l+=1,C){M=i.readUInt16(t,l,l+2);l+=2;_=i.readUInt8(t,l,l+1);l+=1,5121===M&&(F=1);A=i.readUInt8(t,l,l+F);l+=F;R=i.readUInt8(t,l,l+F);l+=F;P=i.readUInt8(t,l,l+F);l+=F;T=255;4===_&&(T=i.readUInt8(t,l,l+F),l+=F),m.color4=new Color,m.color4.set(A,R,P,T)}L=i.readUInt8(t,l,l+1);l+=1;S=i.readUInt8(t,l,l+1);if(l+=1,L||S){w=i.readInt32(t,l,l+4);l+=4,w>0&&void 0===m.vBOVertexIdxCacheKeysContainer&&(m.vBOVertexIdxCacheKeysContainer=new VBOVertexIdxCacheKeysContainer);for(E=0;E<w;E++){var B=m.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();if(L){M=i.readUInt16(t,l,l+2);l+=2;_=i.readUInt8(t,l,l+1);l+=1,5120===M||5121===M?F=1:5122===M||5123===M?F=2:5126===M&&(F=4);D=i.readUInt32(t,l,l+4);l+=4,h=F*(N=D*_),g=u.getClassifiedBufferSize(h),m.vertexCount=D,a=l,s=l+F*N,B.colVboDataArray=new Float32Array(g),B.colVboDataArray.set(new Float32Array(t.slice(a,s))),B.colArrayByteSize=g,l+=F*N,B.isReadyColors(e,n.vboMemoryManager)||(this.succesfullyGpuDataBinded=!1)}if(S){var F;M=i.readUInt16(t,l,l+2);l+=2,5120===M||5121===M?F=1:5122===M||5123===M?F=2:5126===M&&(F=4);var N;D=i.readUInt32(t,l,l+4);l+=4,d=F*(N=2*D),f=u.getClassifiedBufferSize(d),m.vertexCount=D,a=l,s=l+F*N,B.tcoordVboDataArray=new Float32Array(f),B.tcoordVboDataArray.set(new Float32Array(t.slice(a,s))),B.tcoordArrayByteSize=f,l+=F*N,B.isReadyTexCoords(e,n.vboMemoryManager)||(this.succesfullyGpuDataBinded=!1)}}}I=i.readUInt32(t,l,l+4);if(l+=4,I>0){var U,j="";O=i.readUInt32(t,l,l+4);l+=4;for(E=0;E<O;E++)j+=String.fromCharCode(new Int8Array(t.slice(l,l+1))),l+=1;V=i.readUInt32(t,l,l+4);l+=4;var H=new Uint8Array(t.slice(l,l+V));l+=V,U=new TextDecoder("utf-8").decode(H),V>0&&(m.texture=new Texture,m.hasTexture=!0,m.texture.textureTypeName=j,m.texture.textureImageFileName=U)}else m.hasTexture=!1;r&&m.multiplyTransformMatrix(r)}}void 0===this.exterior_ocCullOctree&&(this.exterior_ocCullOctree=new OcclusionCullingOctreeCell);var G=this.exterior_ocCullOctree;l=this.exterior_ocCullOctree.parseArrayBuffer(t,l,i),G.expandBox(1e3),G.setSizesSubBoxes(),G.createModelReferencedGroups(this.motherNeoRefsList),void 0===this.interior_ocCullOctree&&(this.interior_ocCullOctree=new OcclusionCullingOctreeCell);var z=this.interior_ocCullOctree;return l=this.interior_ocCullOctree.parseArrayBuffer(t,l,i),z.setSizesSubBoxes(),z.createModelReferencedGroups(this.motherNeoRefsList),this.fileLoadState=CODE.fileLoadState.PARSE_FINISHED,this.succesfullyGpuDataBinded};var NeoSimpleBuilding=function(){if(!(this instanceof NeoSimpleBuilding))throw new Error(Messages.CONSTRUCT_ERROR);this.accesorsArray=[],this.vbo_vicks_container=new VBOVertexIdxCacheKeysContainer,this.texturesArray=[]};NeoSimpleBuilding.prototype.newAccesor=function(){var e=new Accessor;return this.accesorsArray.push(e),e},NeoSimpleBuilding.prototype.newTexture=function(){var e=new NeoTexture;return this.texturesArray.push(e),e};var NeoTexture=function(){if(!(this instanceof NeoTexture))throw new Error(Messages.CONSTRUCT_ERROR);this.lod,this.textureId,this.texImage,this.loadStarted=!1,this.loadFinished=!1},Node=function(){if(!(this instanceof Node))throw new Error(Messages.CONSTRUCT_ERROR);this.parent,this.children=[],this.data};Node.prototype.deleteObjects=function(e,t){if(this.parent=void 0,this.data&&(this.data.neoBuilding&&(this.data.neoBuilding.deleteObjects(e,t),this.data.neoBuilding=void 0),this.data.geographicCoord&&(this.data.geographicCoord.deleteObjects(),this.data.geographicCoord=void 0),this.data.rotationsDegree&&(this.data.rotationsDegree.deleteObjects(),this.data.rotationsDegree=void 0),this.data.bbox&&(this.data.bbox.deleteObjects(),this.data.bbox=void 0),this.data=void 0),this.children){for(var i=this.children.length,o=0;o<i;o++)this.children[o].deleteObjects(e,t),this.children[o]=void 0;this.children=void 0}},Node.prototype.addChildren=function(e){e.setParent(this),this.children.push(e)},Node.prototype.setParent=function(e){this.parent=e},Node.prototype.getRoot=function(){return void 0===this.parent?this:this.parent.getRoot()},Node.prototype.getClosestParentWithData=function(e){return this.data&&this.data[e]?this:this.parent?this.parent.getClosestParentWithData(e):void 0},Node.prototype.extractNodesByDataName=function(e,t){this.data[t]&&e.push(this);for(var i=this.children.length,o=0;o<i;o++)this.children[o].extractNodesByDataName(e,t)},Node.prototype.extractNodes=function(e){e.push(this);for(var t=this.children.length,i=0;i<t;i++)this.children[i].extractNodes(e)},Node.prototype.getBBoxCenterPositionWorldCoord=function(e){return void 0===this.bboxAbsoluteCenterPos&&this.calculateBBoxCenterPositionWorldCoord(e),this.bboxAbsoluteCenterPos},Node.prototype.calculateBBoxCenterPositionWorldCoord=function(e){var t,i;(t=this.data.bbox.getCenterPoint(t),this.bboxAbsoluteCenterPos=e.tMatrix.transformPoint3D(t,this.bboxAbsoluteCenterPos),e.pivotPointTraslation)&&(i=e.tMatrix.rotatePoint3D(e.pivotPointTraslation,i),this.bboxAbsoluteCenterPos.add(i.x,i.y,i.z))};var Octree=function(e){if(!(this instanceof Octree))throw new Error(Messages.CONSTRUCT_ERROR);this.centerPos=new Point3D,this.half_dx=0,this.half_dy=0,this.half_dz=0,this.octree_owner,this.octree_level=0,this.octree_number_name=0,this.neoBuildingOwnerId,this.octreeKey,this.distToCamera,this.triPolyhedronsCount=0,this.fileLoadState=CODE.fileLoadState.READY,e&&(this.octree_owner=e,this.octree_level=e.octree_level+1),this.subOctrees_array=[],this.neoReferencesMotherAndIndices,this.lowestOctrees_array,this.lego};Octree.prototype.new_subOctree=function(){var e=new Octree(this);return e.octree_level=this.octree_level+1,this.subOctrees_array.push(e),e},Octree.prototype.deleteObjectsModelReferences=function(e,t){if(this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(e,t),this.neoReferencesMotherAndIndices=void 0,void 0!==this.neoRefsList_Array){for(var i=0,o=this.neoRefsList_Array.length;i<o;i++)this.neoRefsList_Array[i]&&this.neoRefsList_Array[i].deleteObjects(e,t),this.neoRefsList_Array[i]=void 0;this.neoRefsList_Array=void 0}if(void 0!==this.subOctrees_array){i=0;for(var r=this.subOctrees_array.length;i<r;i++)this.subOctrees_array[i].deleteObjectsModelReferences(e,t)}},Octree.prototype.deleteObjectsLego=function(e,t){if(void 0!==this.lego&&(this.lego.deleteObjects(e,t),this.lego=void 0),void 0!==this.subOctrees_array)for(var i=0,o=this.subOctrees_array.length;i<o;i++)this.subOctrees_array[i].deleteObjectsLego(e,t)},Octree.prototype.deleteObjects=function(e,t){if(void 0!==this.lego&&(this.lego.deleteObjects(e,t),this.lego=void 0),this.legoDataArrayBuffer=void 0,this.centerPos&&this.centerPos.deleteObjects(),this.centerPos=void 0,this.half_dx=void 0,this.half_dy=void 0,this.half_dz=void 0,this.octree_owner=void 0,this.octree_level=void 0,this.octree_number_name=void 0,this.distToCamera=void 0,this.triPolyhedronsCount=void 0,this.fileLoadState=void 0,this.neoBuildingOwner=void 0,this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(e,t),this.neoReferencesMotherAndIndices=void 0,void 0!==this.neoRefsList_Array){for(var i=0,o=this.neoRefsList_Array.length;i<o;i++)this.neoRefsList_Array[i]&&this.neoRefsList_Array[i].deleteObjects(e,t),this.neoRefsList_Array[i]=void 0;this.neoRefsList_Array=void 0}if(void 0!==this.subOctrees_array){i=0;for(var r=this.subOctrees_array.length;i<r;i++)this.subOctrees_array[i].deleteObjects(e,t),this.subOctrees_array[i]=void 0;this.subOctrees_array=void 0}},Octree.prototype.deleteLod0GlObjects=function(e,t){if(this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(e,t),void 0!==this.subOctrees_array)for(var i=0,o=this.subOctrees_array.length;i<o;i++)this.subOctrees_array[i].deleteLod0GlObjects(e,t)},Octree.prototype.deleteLod2GlObjects=function(e,t){if(void 0!==this.lego&&(this.lego.deleteObjects(e,t),this.lego=void 0),this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(e,t),void 0!==this.subOctrees_array)for(var i=0,o=this.subOctrees_array.length;i<o;i++)this.subOctrees_array[i].deleteLod2GlObjects(e,t)},Octree.prototype.makeTree=function(e){if(this.octree_level<e){for(var t=0;t<8;t++){var i=this.new_subOctree();i.octree_number_name=10*this.octree_number_name+(t+1),i.neoBuildingOwnerId=this.neoBuildingOwnerId,i.octreeKey=this.neoBuildingOwnerId+"_"+i.octree_number_name}this.setSizesSubBoxes();for(t=0;t<8;t++)this.subOctrees_array[t].makeTree(e)}},Octree.prototype.getNumberOfDigits=function(e){return e>0?Math.floor(Math.log10(e)+1):1},Octree.prototype.getMotherOctree=function(){return void 0===this.octree_owner?this:this.octree_owner.getMotherOctree()},Octree.prototype.getOctree=function(e,t){if(1===t)return 0===e?this.getMotherOctree():this.subOctrees_array[e-1];var i=t-1,o=Math.pow(10,i),r=Math.floor(e/o)%10,n=e-r*o;return this.subOctrees_array[r-1].getOctree(n,t-1)},Octree.prototype.getOctreeByNumberName=function(e){var t=this.getMotherOctree(),i=this.getNumberOfDigits(e);if(1===i)return 0===e?t:t.subOctrees_array[e-1];if(0!==t.subOctrees_array.length){var o=i-1,r=Math.pow(10,o),n=Math.floor(e/r)%10,a=e-n*r;return t.subOctrees_array[n-1].getOctree(a,i-1)}},Octree.prototype.setSizesSubBoxes=function(){if(this.subOctrees_array.length>0){var e=this.centerPos.x,t=this.centerPos.y,i=this.centerPos.z,o=this.centerPos.x-this.half_dx,r=this.centerPos.y-this.half_dy,n=this.centerPos.z-this.half_dz,a=this.centerPos.x+this.half_dx,s=this.centerPos.y+this.half_dy,l=this.centerPos.z+this.half_dz;this.subOctrees_array[0].setBoxSize(o,e,r,t,n,i),this.subOctrees_array[1].setBoxSize(e,a,r,t,n,i),this.subOctrees_array[2].setBoxSize(e,a,t,s,n,i),this.subOctrees_array[3].setBoxSize(o,e,t,s,n,i),this.subOctrees_array[4].setBoxSize(o,e,r,t,i,l),this.subOctrees_array[5].setBoxSize(e,a,r,t,i,l),this.subOctrees_array[6].setBoxSize(e,a,t,s,i,l),this.subOctrees_array[7].setBoxSize(o,e,t,s,i,l);for(var c=0;c<8;c++)this.subOctrees_array[c].setSizesSubBoxes()}},Octree.prototype.setBoxSize=function(e,t,i,o,r,n){this.centerPos.x=(t+e)/2,this.centerPos.y=(o+i)/2,this.centerPos.z=(n+r)/2,this.half_dx=(t-e)/2,this.half_dy=(o-i)/2,this.half_dz=(n-r)/2},Octree.prototype.getCenterPos=function(){return this.centerPos},Octree.prototype.getRadiusAprox=function(){return 1.7*this.half_dx},Octree.prototype.getNeoRefListArray=function(e){void 0===e&&(e=[]);var t=this.subOctrees_array.length;if(t>0)for(var i=0;i<t;i++)this.subOctrees_array[i].getNeoRefListArray(e);else this.neoRefsList_Array.length>0&&e.push(this.neoRefsList_Array[0])},Octree.prototype.getFrustumVisibleLowestOctreesByLOD=function(e,t,i,o,r,n,a,s){var l=[],c=!1;this.getFrustumVisibleOctreesNeoBuildingAsimetricVersion(e,l,o);for(var h=l.length,d=0;d<h;d++)l[d].setDistToCamera(r);for(d=0;d<h;d++)l[d].distToCamera<n?l[d].triPolyhedronsCount>0&&(i&&this.putOctreeInEyeDistanceSortedArray(i.currentVisibles0,l[d]),t.currentVisibles0.push(l[d]),c=!0):l[d].distToCamera<a?l[d].triPolyhedronsCount>0&&(i&&this.putOctreeInEyeDistanceSortedArray(i.currentVisibles1,l[d]),t.currentVisibles1.push(l[d]),c=!0):l[d].distToCamera<s?l[d].triPolyhedronsCount>0&&(i&&this.putOctreeInEyeDistanceSortedArray(i.currentVisibles2,l[d]),t.currentVisibles2.push(l[d]),c=!0):l[d].triPolyhedronsCount>0&&(i&&i.currentVisibles3.push(l[d]),t.currentVisibles3.push(l[d]),c=!0);return l=void 0,c},Octree.prototype.intersectsWithPoint3D=function(e,t,i){var o=this.centerPos.x-this.half_dx,r=this.centerPos.y-this.half_dz,n=this.centerPos.z-this.half_dz,a=this.centerPos.x+this.half_dx,s=this.centerPos.y+this.half_dz,l=this.centerPos.z+this.half_dz,c=!1;return e>o&&e<a&&t>r&&t<s&&i>n&&i<l&&(c=!0),c},Octree.prototype.getIntersectedSubBoxByPoint3D=function(e,t,i){if(void 0===this.octree_owner&&!this.intersectsWithPoint3D(e,t,i))return!1;var o=void 0;if(this.subOctrees_array.length>0){var r,n=this.centerPos.x,a=this.centerPos.y,s=this.centerPos.z;r=e<n?t<a?i<s?0:4:i<s?3:7:t<a?i<s?1:5:i<s?2:6,o=this.subOctrees_array[r].getIntersectedSubBoxByPoint3D(e,t,i)}else o=this;return o},Octree.prototype.getMinDistToCamera=function(e){var t,i=1e6;void 0===this.lowestOctrees_array&&(this.lowestOctrees_array=[],this.extractLowestOctreesIfHasTriPolyhedrons(this.lowestOctrees_array));for(var o=this.lowestOctrees_array.length,r=0;r<o;r++)(t=this.lowestOctrees_array[r].centerPos.distToPoint(e)-this.getRadiusAprox())<i&&(i=t);return i},Octree.prototype.extractLowestOctreesByLOD=function(e,t,i,o,r,n,a){var s=!1;o.x,o.y,o.z;void 0===this.lowestOctrees_array&&(this.lowestOctrees_array=[],this.extractLowestOctreesIfHasTriPolyhedrons(this.lowestOctrees_array));for(var l=this.lowestOctrees_array.length,c=0;c<l;c++)this.lowestOctrees_array[c].setDistToCamera(o);for(c=0;c<l;c++)this.lowestOctrees_array[c].distToCamera<r?this.lowestOctrees_array[c].triPolyhedronsCount>0&&(t&&this.putOctreeInEyeDistanceSortedArray(t.currentVisibles0,this.lowestOctrees_array[c]),e.currentVisibles0.push(this.lowestOctrees_array[c]),s=!0):this.lowestOctrees_array[c].distToCamera<n?this.lowestOctrees_array[c].triPolyhedronsCount>0&&(t&&this.putOctreeInEyeDistanceSortedArray(t.currentVisibles1,this.lowestOctrees_array[c]),e.currentVisibles1.push(this.lowestOctrees_array[c]),s=!0):this.lowestOctrees_array[c].distToCamera<a?this.lowestOctrees_array[c].triPolyhedronsCount>0&&(t&&this.putOctreeInEyeDistanceSortedArray(t.currentVisibles2,this.lowestOctrees_array[c]),e.currentVisibles2.push(this.lowestOctrees_array[c]),s=!0):this.lowestOctrees_array[c].triPolyhedronsCount>0&&(t&&t.currentVisibles3.push(this.lowestOctrees_array[c]),e.currentVisibles3.push(this.lowestOctrees_array[c]),s=!0);return s},Octree.prototype.getFrustumVisibleOctreesNeoBuildingAsimetricVersion=function(e,t,i){if(void 0!==this.subOctrees_array&&(0!==this.subOctrees_array.length||0!==this.triPolyhedronsCount)){void 0===t&&(t=[]),void 0===i&&(i=new Sphere),i.centerPoint.x=this.centerPos.x,i.centerPoint.y=this.centerPos.y,i.centerPoint.z=this.centerPos.z,i.r=this.getRadiusAprox();var o=e.intersectionSphere(i);if(o===Constant.INTERSECTION_INSIDE)this.getAllSubOctreesIfHasRefLists(t);else if(o===Constant.INTERSECTION_INTERSECT)if(0===this.subOctrees_array.length)t.push(this);else for(var r=0,n=this.subOctrees_array.length;r<n;r++)this.subOctrees_array[r].getFrustumVisibleOctreesNeoBuildingAsimetricVersion(e,t,i)}},Octree.prototype.getBBoxIntersectedOctreesNeoBuildingAsimetricVersion=function(e,t,i){void 0!==this.subOctrees_array&&(0===this.subOctrees_array.length&&0===this.triPolyhedronsCount||(void 0===t&&(t=[]),void 0===i&&(i=new BoundingBox),i.minX=this.centerPos.x-this.half_dx,i.maxX=this.centerPos.x+this.half_dx,i.minY=this.centerPos.y-this.half_dy,i.maxY=this.centerPos.y+this.half_dy,i.minZ=this.centerPos.z-this.half_dz,i.maxZ=this.centerPos.z+this.half_dz,e.intersectsWithBBox(i)&&this.getAllSubOctreesIfHasRefLists(t)))},Octree.prototype.setDistToCamera=function(e){var t=this.centerPos.distToPoint(e)-this.getRadiusAprox();return this.distToCamera=t,t},Octree.prototype.getIndexToInsertBySquaredDistToEye=function(e,t,i,o){void 0===i&&(i=0),void 0===o&&(o=e.length-1);var r=o-i;if(r<=0)return 0;if(r<6){var n,a=!1,s=i;for(e.length;!a&&s<=o;)t.distToCamera<e[s].distToCamera&&(n=s,a=!0),s++;return a?n:o+1}var l,c,h=i+Math.floor(r/2);return e[h].distToCamera>t.distToCamera?(l=i,c=h):(l=h,c=o),this.getIndexToInsertBySquaredDistToEye(e,t,l,c)},Octree.prototype.putOctreeInEyeDistanceSortedArray=function(e,t){if(e.length>0){var i=e.length-1,o=this.getIndexToInsertBySquaredDistToEye(e,t,0,i);e.splice(o,0,t)}else e.push(t)},Octree.prototype.getAllSubOctreesIfHasRefLists=function(e){if(void 0!==this.subOctrees_array)if(void 0===e&&(e=[]),this.subOctrees_array.length>0)for(var t=0,i=this.subOctrees_array.length;t<i;t++)this.subOctrees_array[t].getAllSubOctreesIfHasRefLists(e);else this.triPolyhedronsCount>0&&e.push(this)},Octree.prototype.getAllSubOctrees=function(e){if(void 0===e&&(e=[]),this.subOctrees_array.length>0)for(var t=0,i=this.subOctrees_array.length;t<i;t++)this.subOctrees_array[t].getAllSubOctrees(e);else e.push(this)},Octree.prototype.extractLowestOctreesIfHasTriPolyhedrons=function(e){if(void 0!==this.subOctrees_array){var t=this.subOctrees_array.length;if(0===t&&this.triPolyhedronsCount>0)e.push(this);else for(var i=0;i<t;i++)this.subOctrees_array[i].extractLowestOctreesIfHasTriPolyhedrons(e)}},Octree.prototype.multiplyKeyTransformMatrix=function(e,t){var i=this.subOctrees_array.length;if(0===i&&this.triPolyhedronsCount>0)this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.multiplyKeyTransformMatrix(e,t);else for(var o=0;o<i;o++)this.subOctrees_array[o].multiplyKeyTransformMatrix(e,t)},Octree.prototype.parseAsimetricVersion=function(e,t,i,o){var r=t.readInt32(e,i,i+4);if(i+=4,0===r){var n=t.readFloat32(e,i,i+4);i+=4;var a=t.readFloat32(e,i,i+4);i+=4;var s=t.readFloat32(e,i,i+4);i+=4;var l=t.readFloat32(e,i,i+4);i+=4;var c=t.readFloat32(e,i,i+4);i+=4;var h=t.readFloat32(e,i,i+4);i+=4,this.setBoxSize(n,a,s,l,c,h),this.octree_number_name=0}var d=t.readUInt8(e,i,i+1);i+=1,this.triPolyhedronsCount=t.readInt32(e,i,i+4),i+=4,this.triPolyhedronsCount>0&&(this.neoBuildingOwner=o);for(var u=0;u<d;u++){(f=this.new_subOctree()).octree_number_name=10*this.octree_number_name+(u+1),f.neoBuildingOwnerId=this.neoBuildingOwnerId,f.octreeKey=this.neoBuildingOwnerId+"_"+f.octree_number_name}this.setSizesSubBoxes();for(u=0;u<d;u++){var f;i=(f=this.subOctrees_array[u]).parseAsimetricVersion(e,t,i,o)}return i};var ParseQueue=function(){if(!(this instanceof ParseQueue))throw new Error(Messages.CONSTRUCT_ERROR);this.octreesLod0ReferencesToParseMap={},this.octreesLod0ModelsToParseMap={},this.octreesLod2LegosToParseMap={},this.octreesPCloudToParseMap={},this.skinLegosToParseMap={},this.tinTerrainsToParseMap={}};ParseQueue.prototype.putTinTerrainToParse=function(e,t){void 0===t&&(t=0),this.tinTerrainsToParseMap[e.pathName]=e},ParseQueue.prototype.eraseTinTerrainToParse=function(e){if(void 0!==e){var t=e.pathName;return!!this.tinTerrainsToParseMap.hasOwnProperty(t)&&(delete this.tinTerrainsToParseMap[t],!0)}},ParseQueue.prototype.parseOctreesPCloud=function(e,t,i,o){var r;void 0===this.matrix4SC&&(this.matrix4SC=new Matrix4);var n=0;if(void 0===o&&(o=20),Object.keys(this.octreesLod0ReferencesToParseMap).length>0){for(var a=t.currentVisibles0.length,s=0;s<a&&(r=t.currentVisibles0[s],this.parseOctreesLod0References(e,r,i)&&n++,!(n>o));s++);if(0===n)for(var l in this.octreesLod0ReferencesToParseMap)if(Object.prototype.hasOwnProperty.call(foo,l)&&(r=this.octreesLod0ReferencesToParseMap[l],delete this.octreesLod0ReferencesToParseMap[l],this.parseOctreesLod0References(e,r,i),++n>o))break}return n>0},ParseQueue.prototype.parseOctreesLod0References=function(e,t,i,o){var r;void 0===this.matrix4SC&&(this.matrix4SC=new Matrix4);var n=0;if(void 0===o&&(o=20),Object.keys(this.octreesLod0ReferencesToParseMap).length>0){for(var a=t.currentVisibles0.length,s=0;s<a&&(r=t.currentVisibles0[s],this.parseOctreesLod0References(e,r,i)&&n++,!(n>o));s++);this.octreesLod0ReferencesToParseMap={}}return n>0},ParseQueue.prototype.parseOctreesLod0References=function(e,t,i){var o=!1;if(this.octreesLod0ReferencesToParseMap.hasOwnProperty(t.octreeKey)){if(delete this.octreesLod0ReferencesToParseMap[t.octreeKey],void 0===t.neoReferencesMotherAndIndices)return!1;if(void 0===t.neoReferencesMotherAndIndices.dataArraybuffer)return!1;if(t.neoReferencesMotherAndIndices.fileLoadState!==CODE.fileLoadState.LOADING_FINISHED)return!1;var r,n=t.neoBuildingOwner,a=n.nodeOwner;if(void 0===(r=a?a.getRoot():void 0))return!1;if(void 0===r.data)return!1;var s=r.data.geoLocDataManager;if(void 0===s)return!1;void 0===this.matrix4SC&&(this.matrix4SC=new Matrix4);var l=s.getCurrentGeoLocationData(),c=n.getHeaderVersion();this.matrix4SC.setByFloat32Array(l.rotMatrix._floatArrays),"v"===c[0]?t.neoReferencesMotherAndIndices.parseArrayBufferReferences(e,t.neoReferencesMotherAndIndices.dataArraybuffer,i.readerWriter,n,this.matrix4SC,i):t.neoReferencesMotherAndIndices.parseArrayBufferReferencesVersioned(e,t.neoReferencesMotherAndIndices.dataArraybuffer,i.readerWriter,n,this.matrix4SC,i),t.neoReferencesMotherAndIndices.multiplyKeyTransformMatrix(0,l.rotMatrix),t.neoReferencesMotherAndIndices.dataArraybuffer=void 0,o=!0}return o},ParseQueue.prototype.putOctreeLod0ReferencesToParse=function(e,t){void 0===t&&(t=0),this.octreesLod0ReferencesToParseMap[e.octreeKey]=e},ParseQueue.prototype.eraseOctreeLod0ReferencesToParse=function(e){delete this.octreesLod0ReferencesToParseMap[e.octreeKey]},ParseQueue.prototype.putOctreeLod0ModelsToParse=function(e,t){void 0===t&&(t=0),this.octreesLod0ModelsToParseMap[e.octreeKey]=e},ParseQueue.prototype.eraseOctreeLod0ModelsToParse=function(e){delete this.octreesLod0ModelsToParseMap[e.octreeKey]},ParseQueue.prototype.putOctreeLod2LegosToParse=function(e,t){void 0===t&&(t=0),this.octreesLod2LegosToParseMap[e.octreeKey]=e},ParseQueue.prototype.eraseOctreeLod2LegosToParse=function(e){delete this.octreesLod2LegosToParseMap[e.octreeKey]},ParseQueue.prototype.putOctreePCloudToParse=function(e,t){void 0===t&&(t=0),this.octreesPCloudToParseMap[e.octreeKey]=e},ParseQueue.prototype.eraseOctreePCloudToParse=function(e){if(void 0===e)return!1;var t=e.octreeKey;return!!this.octreesPCloudToParseMap.hasOwnProperty(t)&&(delete this.octreesPCloudToParseMap[t],!0)},ParseQueue.prototype.putSkinLegosToParse=function(e,t){void 0===t&&(t=0),this.skinLegosToParseMap[e.legoKey]=e},ParseQueue.prototype.eraseSkinLegosToParse=function(e){delete this.skinLegosToParseMap[e.legoKey]},ParseQueue.prototype.clearAll=function(){this.octreesLod0ReferencesToParseMap={},this.octreesLod0ModelsToParseMap={},this.octreesLod2LegosToParseMap={}},ParseQueue.prototype.eraseAny=function(e){this.eraseOctreeLod0ReferencesToParse(e),this.eraseOctreeLod0ModelsToParse(e),this.eraseOctreeLod2LegosToParse(e)};var ProcessQueue=function(){if(!(this instanceof ProcessQueue))throw new Error(Messages.CONSTRUCT_ERROR);this.nodesToDeleteMap={},this.nodesToDeleteModelReferencesMap={},this.nodesToDeleteLessThanLod3Map={},this.nodesToDeleteLessThanLod4Map={},this.nodesToDeleteLessThanLod5Map={},this.nodesToDeleteLodMeshMap={},this.tinTerrainsToDeleteMap={}};ProcessQueue.prototype.putNodeToDeleteLodMesh=function(e,t){if(void 0===t&&(t=0),void 0!==e.data&&void 0!==e.data.neoBuilding){var i=e.data.neoBuilding.buildingId;this.nodesToDeleteLodMeshMap[i]=e}},ProcessQueue.prototype.eraseNodeToDeleteLodMesh=function(e){if(void 0!==e.data&&void 0!==e.data.neoBuilding){var t=e.data.neoBuilding.buildingId;return!!this.nodesToDeleteLodMeshMap.hasOwnProperty(t)&&(delete this.nodesToDeleteLodMeshMap[t],!0)}},ProcessQueue.prototype.putTinTerrainToDelete=function(e,t){if(void 0===t&&(t=0),void 0!==e){var i=e.pathName;this.tinTerrainsToDeleteMap[i]=e}},ProcessQueue.prototype.eraseTinTerrainToDelete=function(e){if(void 0!==e){var t=e.pathName;return!!this.tinTerrainsToDeleteMap.hasOwnProperty(t)&&(delete this.tinTerrainsToDeleteMap[t],!0)}},ProcessQueue.prototype.putNodeToDeleteLessThanLod3=function(e,t){if(void 0===t&&(t=0),void 0!==e.data&&void 0!==e.data.neoBuilding){var i=e.data.neoBuilding.buildingId;this.nodesToDeleteLessThanLod3Map[i]=e}},ProcessQueue.prototype.eraseNodeToDeleteLessThanLod3=function(e){if(void 0!==e.data&&void 0!==e.data.neoBuilding){var t=e.data.neoBuilding.buildingId;return!!this.nodesToDeleteLessThanLod3Map.hasOwnProperty(t)&&(delete this.nodesToDeleteLessThanLod3Map[t],!0)}},ProcessQueue.prototype.putNodeToDeleteLessThanLod4=function(e,t){if(void 0===t&&(t=0),void 0!==e.data&&void 0!==e.data.neoBuilding){var i=e.data.neoBuilding.buildingId;this.nodesToDeleteLessThanLod4Map[i]=e}},ProcessQueue.prototype.eraseNodeToDeleteLessThanLod4=function(e){if(void 0!==e.data&&void 0!==e.data.neoBuilding){var t=e.data.neoBuilding.buildingId;return!!this.nodesToDeleteLessThanLod4Map.hasOwnProperty(t)&&(delete this.nodesToDeleteLessThanLod4Map[t],!0)}},ProcessQueue.prototype.putNodeToDeleteLessThanLod5=function(e,t){if(void 0===t&&(t=0),void 0!==e.data&&void 0!==e.data.neoBuilding){var i=e.data.neoBuilding.buildingId;this.nodesToDeleteLessThanLod5Map[i]=e}},ProcessQueue.prototype.eraseNodeToDeleteLessThanLod5=function(e){if(void 0!==e.data&&void 0!==e.data.neoBuilding){var t=e.data.neoBuilding.buildingId;return!!this.nodesToDeleteLessThanLod5Map.hasOwnProperty(t)&&(delete this.nodesToDeleteLessThanLod5Map[t],!0)}},ProcessQueue.prototype.putNodeToDeleteModelReferences=function(e,t){if(void 0===t&&(t=0),void 0!==e.data&&void 0!==e.data.neoBuilding){var i=e.data.neoBuilding.buildingId;this.nodesToDeleteModelReferencesMap[i]=e}},ProcessQueue.prototype.eraseNodeToDeleteModelReferences=function(e){if(void 0!==e.data&&void 0!==e.data.neoBuilding){var t=e.data.neoBuilding.buildingId;return!!this.nodesToDeleteModelReferencesMap.hasOwnProperty(t)&&(delete this.nodesToDeleteModelReferencesMap[t],!0)}},ProcessQueue.prototype.putNodeToDelete=function(e,t){if(void 0===t&&(t=0),void 0!==e.data&&void 0!==e.data.neoBuilding){var i=e.data.neoBuilding.buildingId;this.nodesToDeleteMap[i]=e}},ProcessQueue.prototype.putNodesArrayToDelete=function(e,t){if(void 0!==e){void 0===t&&(t=0);for(var i=e.length,o=0;o<i;o++)this.putNodeToDelete(e[o],t)}},ProcessQueue.prototype.eraseNodeToDelete=function(e){var t=e.data.neoBuilding.buildingId;return!!this.nodesToDeleteMap.hasOwnProperty(t)&&(delete this.nodesToDeleteMap[t],!0)},ProcessQueue.prototype.eraseNodesArrayToDelete=function(e){for(var t,i=e.length,o=0;o<i;o++)t=e[o].data.neoBuilding.buildingId,delete this.nodesToDeleteMap[t]},ProcessQueue.prototype.clearAll=function(){this.nodesToDeleteMap={},this.nodesToDeleteModelReferencesMap={}};var ProjectTree=function(){if(!(this instanceof ProjectTree))throw new Error(Messages.CONSTRUCT_ERROR);this.root,this.nodesArray=[]},ReaderWriter=function(){if(!(this instanceof ReaderWriter))throw new Error(Messages.CONSTRUCT_ERROR);var e=MagoConfig.getPolicy();void 0!==e&&(this.geometryDataPath=e.geo_data_path),this.geometrySubDataPath,this.j_counter,this.k_counter,this.gl,this.incre_latAng=.001,this.incre_longAng=.001,this.GAIA3D__offset_latitude=-.001,this.GAIA3D__offset_longitude=-.001,this.GAIA3D__counter=0,this.uint32,this.uint16,this.int16,this.float32,this.float16,this.int8,this.int8_value,this.max_color_value=126,this.startBuff,this.endBuff,this.filesReadings_count=0,this.temp_var_to_waste,this.countSC,this.xSC,this.ySC,this.zSC,this.point3dSC=new Point3D,this.bboxSC=new BoundingBox};function loadWithXhr(e){var t=$.Deferred(),i=new XMLHttpRequest;return i.open("GET",e,!0),i.responseType="arraybuffer",i.onload=function(){i.status<200||i.status>=300?t.reject(i.status):t.resolve(i.response)},i.onerror=function(e){t.reject(i.status)},i.send(null),t.promise()}ReaderWriter.prototype.getCurrentDataPath=function(){return void 0!==this.geometrySubDataPath&&""!==this.geometrySubDataPath?this.geometryDataPath+"/"+this.geometrySubDataPath:this.geometryDataPath},ReaderWriter.prototype.readUInt32=function(e,t,i){return new Uint32Array(e.slice(t,i))[0]},ReaderWriter.prototype.readInt32=function(e,t,i){return new Int32Array(e.slice(t,i))[0]},ReaderWriter.prototype.readUInt16=function(e,t,i){return new Uint16Array(e.slice(t,i))[0]},ReaderWriter.prototype.readInt16=function(e,t,i){return new Int16Array(e.slice(t,i))[0]},ReaderWriter.prototype.readFloat64=function(e,t,i){return new Float64Array(e.slice(t,i))[0]},ReaderWriter.prototype.readFloat32=function(e,t,i){return new Float32Array(e.slice(t,i))[0]},ReaderWriter.prototype.readFloat16=function(e,t,i){return new Float32Array(e.slice(t,i))[0]},ReaderWriter.prototype.readInt8=function(e,t,i){return new Int8Array(e.slice(t,i))[0]},ReaderWriter.prototype.readUInt8=function(e,t,i){return new Uint8Array(e.slice(t,i))[0]},ReaderWriter.prototype.readInt8ByteColor=function(e,t,i){var o=new Int8Array(e.slice(t,i))[0];return o>max_color_value&&(o=max_color_value),o<0&&(o+=256),o},ReaderWriter.prototype.getNeoBlocksArraybuffer=function(e,t,i){i.fileRequestControler.modelRefFilesRequestedCount+=1;var o=t.neoReferencesMotherAndIndices.blocksList;o.fileLoadState=CODE.fileLoadState.LOADING_STARTED,loadWithXhr(e).done(function(e){var r=e;r?(o.dataArraybuffer=r,o.fileLoadState=CODE.fileLoadState.LOADING_FINISHED,r=null,i.parseQueue.putOctreeLod0ModelsToParse(t)):o.fileLoadState=500}).fail(function(e){o.fileLoadState=0===e?500:e}).always(function(){i.fileRequestControler.modelRefFilesRequestedCount-=1,i.fileRequestControler.modelRefFilesRequestedCount<0&&(i.fileRequestControler.modelRefFilesRequestedCount=0)})},ReaderWriter.prototype.getNeoReferencesArraybuffer=function(e,t,i){i.fileRequestControler.modelRefFilesRequestedCount+=1,t.neoReferencesMotherAndIndices.fileLoadState=CODE.fileLoadState.LOADING_STARTED,loadWithXhr(e).done(function(e){var o=e;if(o){var r=t.neoReferencesMotherAndIndices;r&&(r.dataArraybuffer=o,r.fileLoadState=CODE.fileLoadState.LOADING_FINISHED,i.parseQueue.putOctreeLod0ReferencesToParse(t)),o=null}else t.neoReferencesMotherAndIndices.fileLoadState=500}).fail(function(e){t.neoReferencesMotherAndIndices.fileLoadState=0===e?500:e}).always(function(){i.fileRequestControler.modelRefFilesRequestedCount-=1,i.fileRequestControler.modelRefFilesRequestedCount<0&&(i.fileRequestControler.modelRefFilesRequestedCount=0)})},ReaderWriter.prototype.getOctreeLegoArraybuffer=function(e,t,i){void 0!==t.lego&&(i.fileRequestControler.filesRequestedCount+=1,t.lego.fileLoadState=CODE.fileLoadState.LOADING_STARTED,loadWithXhr(e).done(function(e){var o=e;o?(t.lego?(t.lego.dataArrayBuffer=o,t.lego.fileLoadState=CODE.fileLoadState.LOADING_FINISHED,i.parseQueue.putOctreeLod2LegosToParse(t)):t=void 0,o=null):t.lego.fileLoadState=500}).fail(function(e){t.lego.fileLoadState=0===e?500:e}).always(function(){i.fileRequestControler.filesRequestedCount-=1,i.fileRequestControler.filesRequestedCount<0&&(i.fileRequestControler.filesRequestedCount=0)}))},ReaderWriter.prototype.getOctreePCloudArraybuffer=function(e,t,i){void 0!==t.lego&&(i.fileRequestControler.filesRequestedCount+=1,t.lego.fileLoadState=CODE.fileLoadState.LOADING_STARTED,loadWithXhr(e).done(function(e){var o=e;o?(t.lego?(t.lego.dataArrayBuffer=o,t.lego.fileLoadState=CODE.fileLoadState.LOADING_FINISHED,i.parseQueue.putOctreePCloudToParse(t)):t=void 0,o=null):t.lego.fileLoadState=500}).fail(function(e){t.lego.fileLoadState=0===e?500:e}).always(function(){i.fileRequestControler.filesRequestedCount-=1,i.fileRequestControler.filesRequestedCount<0&&(i.fileRequestControler.filesRequestedCount=0)}))},ReaderWriter.prototype.getLegoArraybuffer=function(e,t,i){i.fileRequestControler.lowLodDataRequestedCount+=1,t.fileLoadState=CODE.fileLoadState.LOADING_STARTED,loadWithXhr(e).done(function(e){var o=e;o?(t&&(t.dataArrayBuffer=o,t.fileLoadState=CODE.fileLoadState.LOADING_FINISHED,i.parseQueue.putSkinLegosToParse(t)),o=null):t.fileLoadState=500}).fail(function(e){t.fileLoadState=0===e?500:-1}).always(function(){i.fileRequestControler.lowLodDataRequestedCount-=1,i.fileRequestControler.lowLodDataRequestedCount<0&&(i.fileRequestControler.lowLodDataRequestedCount=0)})},ReaderWriter.prototype.getObjectIndexFileForSmartTile=function(e,t,i,o){loadWithXhr(e).done(function(e){var r=e;r&&(i.dataArrayBuffer=r,i.parseBuildingSeedArrayBuffer(),t.makeSmartTile(i,o),r=null)}).fail(function(e){}).always(function(){})},ReaderWriter.prototype.getObjectIndexFile=function(e,t,i,o){loadWithXhr(e).done(function(e){var r=e;r&&(t.parseObjectIndexFile(r,i),r=null,o.createDeploymentGeoLocationsForHeavyIndustries())}).fail(function(e){}).always(function(){})},ReaderWriter.prototype.parseObjectIndexFile=function(e,t){var i,o,r,n,a=0,s=this.readInt32(e,a,a+4);a+=4;for(var l=0;l<s;l++){var c=t.newNeoBuilding();void 0===c.metaData&&(c.metaData=new MetaData),void 0===c.metaData.geographicCoord&&(c.metaData.geographicCoord=new GeographicCoord),void 0===c.metaData.bbox&&(c.metaData.bbox=new BoundingBox),i=this.readInt32(e,a,a+4),a+=4;var h=String.fromCharCode.apply(null,new Int8Array(e.slice(a,a+i)));a+=i,o=this.readFloat64(e,a,a+8),a+=8,r=this.readFloat64(e,a,a+8),a+=8,n=this.readFloat32(e,a,a+4),a+=4,c.bbox=new BoundingBox,c.bbox.minX=this.readFloat32(e,a,a+4),a+=4,c.bbox.minY=this.readFloat32(e,a,a+4),a+=4,c.bbox.minZ=this.readFloat32(e,a,a+4),a+=4,c.bbox.maxX=this.readFloat32(e,a,a+4),a+=4,c.bbox.maxY=this.readFloat32(e,a,a+4),a+=4,c.bbox.maxZ=this.readFloat32(e,a,a+4),a+=4,c.buildingId=h.substr(4,i-4),c.buildingType="basicBuilding",c.buildingFileName=h,c.metaData.geographicCoord.setLonLatAlt(o,r,n)}t.neoBuildingsArray.reverse()},ReaderWriter.prototype.getNeoHeaderAsimetricVersion=function(e,t,i,o,r){r.fileRequestControler.headerFilesRequestedCount+=1,i.metaData.fileLoadState=CODE.fileLoadState.LOADING_STARTED,loadWithXhr(t).done(function(e){var t=e;if(t){void 0===i.metaData&&(i.metaData=new MetaData);var r=i.metaData.parseFileHeaderAsimetricVersion(t,o);if(void 0===i.octree&&(i.octree=new Octree(void 0)),i.octree.neoBuildingOwnerId=i.buildingId,i.octree.octreeKey=i.buildingId+"_"+i.octree.octree_number_name,r=i.octree.parseAsimetricVersion(t,o,r,i),i.metaData.oct_min_x=i.octree.centerPos.x-i.octree.half_dx,i.metaData.oct_max_x=i.octree.centerPos.x+i.octree.half_dx,i.metaData.oct_min_y=i.octree.centerPos.y-i.octree.half_dy,i.metaData.oct_max_y=i.octree.centerPos.y+i.octree.half_dy,i.metaData.oct_min_z=i.octree.centerPos.z-i.octree.half_dz,i.metaData.oct_max_z=i.octree.centerPos.z+i.octree.half_dz,"0.0.1"===i.metaData.version||"0.0.2"===i.metaData.version){var n,a=o.readInt32(t,r,r+4);r+=4;for(var s=0;s<a;s++){var l,c="",h=o.readUInt32(t,r,r+4);r+=4;for(var d=0;d<h;d++)c+=String.fromCharCode(new Int8Array(t.slice(r,r+1))),r+=1;var u=o.readUInt32(t,r,r+4);r+=4;var f=new Uint8Array(t.slice(r,r+u));if(r+=u,l=new TextDecoder("utf-8").decode(f),u>0){var g=new Texture;g.textureTypeName=c,g.textureImageFileName=l,void 0===i.texturesLoaded&&(i.texturesLoaded=[]),i.texturesLoaded.push(g)}}var p=new Uint8Array(t.slice(r,r+1))[0];if(r+=1,void 0!==p){i.lodBuildingDatasMap={};for(s=0;s<p;s++){var m=new LodBuildingData;if(m.lod=new Uint8Array(t.slice(r,r+1))[0],r+=1,m.isModelRef=new Uint8Array(t.slice(r,r+1))[0],r+=1,2===m.lod){n=new Int8Array(t.slice(r,r+1))[0],r+=1,m.textureFileName="";for(d=0;d<n;d++)m.textureFileName+=String.fromCharCode(new Int8Array(t.slice(r,r+1))),r+=1}if(!m.isModelRef){n=new Int8Array(t.slice(r,r+1))[0],r+=1,m.geometryFileName="";for(d=0;d<n;d++)m.geometryFileName+=String.fromCharCode(new Int8Array(t.slice(r,r+1))),r+=1;n=new Int8Array(t.slice(r,r+1))[0],r+=1,m.textureFileName="";for(d=0;d<n;d++)m.textureFileName+=String.fromCharCode(new Int8Array(t.slice(r,r+1))),r+=1}i.lodBuildingDatasMap[m.lod]=m}}}i.metaData.fileLoadState=CODE.fileLoadState.LOADING_FINISHED,t=void 0}else i.metaData.fileLoadState=500,t=void 0}).fail(function(e){i.metaData.fileLoadState=0===e?500:e}).always(function(){r.fileRequestControler.headerFilesRequestedCount-=1,r.fileRequestControler.headerFilesRequestedCount<0&&(r.fileRequestControler.headerFilesRequestedCount=0)})},ReaderWriter.prototype.readNailImageOfArrayBuffer=function(e,t,i,o,r,n){var a=i._simpleBuilding_v1,s=new Blob([t],{type:"image/jpeg"}),l=(window.URL||window.webkitURL).createObjectURL(s),c=new Image;c.onload=function(){void 0===a._simpleBuildingTexture&&(a._simpleBuildingTexture=e.createTexture()),handleTextureLoaded(e,c,a._simpleBuildingTexture),i._f4d_nailImage_readed_finished=!0,t=null,i._simpleBuilding_v1.textureArrayBuffer=null,r.backGround_imageReadings_count>0&&r.backGround_imageReadings_count--},c.onerror=function(){},c.src=l},ReaderWriter.prototype.readNailImage=function(e,t,i,o,r,n){void 0===n&&(n=3),3===n?i._f4d_nailImage_readed=!0:0===n&&(i._f4d_lod0Image_readed=!0),void 0===i._simpleBuilding_v1&&(i._simpleBuilding_v1=new SimpleBuildingV1);var a=i._simpleBuilding_v1,s=new Image;s.onload=function(){3===n?(handleTextureLoaded(e,s,a._simpleBuildingTexture),i._f4d_nailImage_readed_finished=!0):0===n&&(void 0===a._texture_0&&(a._texture_0=e.createTexture()),handleTextureLoaded(e,s,a._texture_0),i._f4d_lod0Image_readed_finished=!0),r.backGround_fileReadings_count>0&&(r.backGround_fileReadings_count-=1)},s.onerror=function(){i._f4d_lod0Image_readed_finished=!1,i._f4d_lod0Image_exists=!1,r.backGround_fileReadings_count>0&&(r.backGround_fileReadings_count-=1)};var l=t;s.src=l},ReaderWriter.prototype.readTexture=function(e,t,i,o){i.loadStarted=!0,i.texImage=new Image,i.texImage.onload=function(){i.loadFinished=!0,o.backGround_fileReadings_count>0&&(o.backGround_fileReadings_count-=1)},i.texImage.onerror=function(){i.loadStarted=!1,o.backGround_fileReadings_count>0&&(o.backGround_fileReadings_count-=1)},i.texImage.src=t},ReaderWriter.prototype.decodeTGA=function(e){var t,i,o,r,n,a=new Uint8Array(e),s=18+a[0],l=a[2],c=a[12]+(a[13]<<8),h=a[14]+(a[15]<<8),d=a[16],u=d/8,f=4*c;if(!c||!h)return null;if(2!==l)return null;for(t=new Uint8Array(c*h*4),i=s,n=h-1;n>=0;--n)for(r=0;r<c;++r,i+=u)t[o=4*r+n*f]=a[i+2],t[o+1]=a[i+1],t[o+2]=a[i+0],t[o+3]=32===d?a[i+3]:255;return{width:c,height:h,data:t}},ReaderWriter.prototype.readNeoReferenceTexture=function(e,t,i,o,r){var n=t.split(".").pop();if("tga"===n||"TGA"===n||"Tga"===n)i.fileLoadState=CODE.fileLoadState.LOADING_STARTED,loadWithXhr(t).done(function(t){var o=t;if(o){var r=new TGA;if(r.load(o),r){var n;if(3===r.header.bytePerPixel)n=e.RGB;else if(4===r.header.bytePerPixel){n=e.RGBA;for(var a,s,l,c,h=r.imageData.length/4,d=0;d<h;d++)a=r.imageData[4*d],s=r.imageData[4*d+1],l=r.imageData[4*d+2],c=r.imageData[4*d+3],r.imageData[4*d]=l,r.imageData[4*d+1]=s,r.imageData[4*d+2]=a,r.imageData[4*d+3]=c}if(void 0!==r.imageData&&r.imageData.length>0&&void 0!==i.texId)e.bindTexture(e.TEXTURE_2D,i.texId),e.texImage2D(e.TEXTURE_2D,0,n,r.header.width,r.header.height,0,n,e.UNSIGNED_BYTE,r.imageData),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.generateMipmap(e.TEXTURE_2D),i.fileLoadState=CODE.fileLoadState.LOADING_FINISHED,e.bindTexture(e.TEXTURE_2D,null);else;}}}).fail(function(e){o&&(o.metaData.fileLoadState=0===e?500:e)}).always(function(){r.backGround_fileReadings_count-=1,r.backGround_fileReadings_count<0&&(r.backGround_fileReadings_count=0)});else{var a=new Image;i.fileLoadState=CODE.fileLoadState.LOADING_STARTED,a.onload=function(){void 0!==i.texId&&(handleTextureLoaded(e,a,i.texId),i.fileLoadState=CODE.fileLoadState.LOADING_FINISHED,r.backGround_fileReadings_count>0&&(r.backGround_fileReadings_count-=1))},a.onerror=function(){},a.src=t}},ReaderWriter.prototype.readLegoSimpleBuildingTexture=function(e,t,i,o){var r=new Image;i.fileLoadState,CODE.fileLoadState.LOADING_STARTED,o.fileRequestControler.lowLodImagesRequestedCount+=1,r.onload=function(){void 0===i.texId&&(i.texId=e.createTexture()),handleTextureLoaded(e,r,i.texId),i.fileLoadState,CODE.fileLoadState.LOADING_FINISHED,o.fileRequestControler.lowLodImagesRequestedCount-=1,o.backGround_fileReadings_count>0&&(o.backGround_fileReadings_count-=1),o.fileRequestControler.lowLodImagesRequestedCount<0&&(o.fileRequestControler.lowLodImagesRequestedCount=0)},r.onerror=function(){void 0===i.texId&&(i.texId=e.createTexture(),e.bindTexture(e.TEXTURE_2D,i.texId),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([200,200,200,255])),e.bindTexture(e.TEXTURE_2D,null)),i.fileLoadState,CODE.fileLoadState.READY,o.fileRequestControler.lowLodImagesRequestedCount-=1,o.fileRequestControler.lowLodImagesRequestedCount<0&&(o.fileRequestControler.lowLodImagesRequestedCount=0)},r.src=t},ReaderWriter.prototype.getTileArrayBuffer=function(e,t,i,o,r){i.fileReading_started=!0,loadWithXhr(t).done(function(e){var t=e;t&&(i.fileArrayBuffer=t,i.fileReading_finished=!0,r.backGround_fileReadings_count>0&&(r.backGround_fileReadings_count-=1),t=null)}).fail(function(e){}).always(function(){})},ReaderWriter.prototype.loadTINTerrain=function(e,t,i,o){i.fileLoadState=CODE.fileLoadState.LOADING_STARTED,loadWithXhr(t).done(function(e){var t=e;t?(i.dataArrayBuffer=t,i.fileLoadState=CODE.fileLoadState.LOADING_FINISHED,t=void 0):i.fileLoadState=500}).fail(function(e){}).always(function(){})},ReaderWriter.prototype.handleTextureLoaded=function(e,t,i){e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null)};var TinTerrain=function(){if(!(this instanceof TinTerrain))throw new Error(Messages.CONSTRUCT_ERROR);this.owner,this.geographicExtent,this.fileLoadState=0,this.dataArrayBuffer,this.vboKeyContainer,this.terrainPositionHIGH,this.terrainPositionLOW,this.pathName,this.texture};TinTerrain.prototype.zigZagDecode=function(e){return e>>1^-(1&e)},TinTerrain.prototype.makeVbo=function(){if(void 0!==this.cartesiansArray){for(var e=this.cartesiansArray.length/3,t=0;t<e;t++)this.cartesiansArray[3*t]-=this.centerX,this.cartesiansArray[3*t+1]-=this.centerY,this.cartesiansArray[3*t+2]-=this.centerZ;void 0===this.terrainPositionHIGH&&(this.terrainPositionHIGH=new Float32Array(3)),void 0===this.terrainPositionLOW&&(this.terrainPositionLOW=new Float32Array(3)),ManagerUtils.calculateSplited3fv([this.centerX[0],this.centerY[0],this.centerZ[0]],this.terrainPositionHIGH,this.terrainPositionLOW),void 0===this.vboKeyContainer&&(this.vboKeyContainer=new VBOVertexIdxCacheKeysContainer);var i=this.vboKeyContainer.newVBOVertexIdxCacheKey();i.posVboDataArray=this.cartesiansArray,i.tcoordVboDataArray=this.texCoordsArray,i.idxVboDataArray=this.indices,i.indicesCount=this.indices.length}},TinTerrain.prototype.decodeData=function(){if(void 0!==this.geographicExtent){void 0===this.vertexArray&&(this.vertexArray=[]);var e=Math.PI/180,t=this.geographicExtent.minGeographicCoord.longitude*e,i=this.geographicExtent.minGeographicCoord.latitude*e,o=this.geographicExtent.maxGeographicCoord.longitude*e-t,r=this.geographicExtent.maxGeographicCoord.latitude*e-i,n=this.minHeight[0],a=this.maxHeight[0]-n,s=this.vertexCount[0];this.texCoordsArray=new Float32Array(2*s);for(var l=new Float32Array(s),c=new Float32Array(s),h=new Float32Array(s),d=o/32767,u=r/32767,f=a/32767,g=this.uValues,p=this.vValues,m=this.hValues,y=0;y<s;y++)l[y]=t+g[y]*d,c[y]=i+p[y]*u,h[y]=n+m[y]*f+2,this.texCoordsArray[2*y]=g[y]/32767,this.texCoordsArray[2*y+1]=p[y]/32767;this.cartesiansArray=Globe.geographicRadianArrayToFloat32ArrayWgs84(l,c,h,this.cartesiansArray),this.uValues=void 0,this.vValues=void 0,this.hValues=void 0,l=void 0,c=void 0,h=void 0}},TinTerrain.prototype.parseData=function(e){this.fileLoadState=CODE.fileLoadState.PARSE_STARTED;var t=0;this.centerX=new Float64Array(e.slice(t,t+8)),t+=8,this.centerY=new Float64Array(e.slice(t,t+8)),t+=8,this.centerZ=new Float64Array(e.slice(t,t+8)),t+=8,this.minHeight=new Float32Array(e.slice(t,t+4)),t+=4,this.maxHeight=new Float32Array(e.slice(t,t+4)),t+=4,this.boundingSphereCenterX=new Float64Array(e.slice(t,t+8)),t+=8,this.boundingSphereCenterY=new Float64Array(e.slice(t,t+8)),t+=8,this.boundingSphereCenterZ=new Float64Array(e.slice(t,t+8)),t+=8,this.boundingSphereRadius=new Float64Array(e.slice(t,t+8)),t+=8,this.horizonOcclusionPointX=new Float64Array(e.slice(t,t+8)),t+=8,this.horizonOcclusionPointY=new Float64Array(e.slice(t,t+8)),t+=8,this.horizonOcclusionPointZ=new Float64Array(e.slice(t,t+8)),t+=8,this.vertexCount=new Uint32Array(e.slice(t,t+4)),t+=4;var i=this.vertexCount[0];this.uValues=new Uint16Array(e.slice(t,t+2*i)),t+=2*i,this.vValues=new Uint16Array(e.slice(t,t+2*i)),t+=2*i,this.hValues=new Uint16Array(e.slice(t,t+2*i)),t+=2*i;for(var o=0,r=0,n=0,a=0;a<i;a++)o+=this.zigZagDecode(this.uValues[a]),r+=this.zigZagDecode(this.vValues[a]),n+=this.zigZagDecode(this.hValues[a]),this.uValues[a]=o,this.vValues[a]=r,this.hValues[a]=n;this.trianglesCount=new Uint32Array(e.slice(t,t+4)),t+=4;var s,l=this.trianglesCount;i>65536?(this.indices=new Uint32Array(e.slice(t,t+4*l*3)),t+=4*l*3):(this.indices=new Uint16Array(e.slice(t,t+2*l*3)),t+=2*l*3);var c=0,h=this.indices.length;for(a=0;a<h;a++)s=this.indices[a],this.indices[a]=c-s,0===s&&++c;i>65536?(this.westVertexCount=new Uint32Array(e.slice(t,t+4)),t+=4,this.westIndices=new Uint32Array(e.slice(t,t+4*this.westVertexCount)),t+=4*this.westVertexCount,this.southVertexCount=new Uint32Array(e.slice(t,t+4)),t+=4,this.southIndices=new Uint32Array(e.slice(t,t+4*this.southVertexCount)),t+=4*this.southVertexCount,this.eastVertexCount=new Uint32Array(e.slice(t,t+4)),t+=4,this.eastIndices=new Uint32Array(e.slice(t,t+4*this.eastVertexCount)),t+=4*this.eastVertexCount,this.northVertexCount=new Uint32Array(e.slice(t,t+4)),t+=4,this.northIndices=new Uint32Array(e.slice(t,t+4*this.northVertexCount)),t+=4*this.northVertexCount):(this.westVertexCount=new Uint32Array(e.slice(t,t+4)),t+=4,this.westIndices=new Uint16Array(e.slice(t,t+2*this.westVertexCount)),t+=2*this.westVertexCount,this.southVertexCount=new Uint32Array(e.slice(t,t+4)),t+=4,this.southIndices=new Uint16Array(e.slice(t,t+2*this.southVertexCount)),t+=2*this.southVertexCount,this.eastVertexCount=new Uint32Array(e.slice(t,t+4)),t+=4,this.eastIndices=new Uint16Array(e.slice(t,t+2*this.eastVertexCount)),t+=2*this.eastVertexCount,this.northVertexCount=new Uint32Array(e.slice(t,t+4)),t+=4,this.northIndices=new Uint16Array(e.slice(t,t+2*this.northVertexCount)),t+=2*this.northVertexCount),this.extensionId=new Uint8Array(e.slice(t,t+1)),t+=1,this.extensionLength=new Uint32Array(e.slice(t,t+4)),t+=4,this.fileLoadState=CODE.fileLoadState.PARSE_FINISHED,e=void this.extensionId.length};var TinTerrainManager=function(){if(!(this instanceof TinTerrainManager))throw new Error(Messages.CONSTRUCT_ERROR);this.maxDepth=15,this.currentVisibles_terrName_geoCoords_map={},this.currentTerrainsMap={}},Arc=function(){if(!(this instanceof Arc))throw new Error(Messages.CONSTRUCT_ERROR);this.centerPoint,this.radius,this.startAngleDeg,this.sweepAngleDeg,this.numPointsFor360Deg,this.startPoint,this.endPoint,this.sweepSense};Arc.prototype.deleteObjects=function(){void 0!==this.centerPoint&&this.centerPoint.deleteObjects(),this.centerPoint=void 0,this.radius=void 0,this.startAngleDeg=void 0,this.sweepAngleDeg=void 0,this.numPointsFor360Deg=void 0,void 0!==this.startPoint&&this.startPoint.deleteObjects(),this.startPoint=void 0,void 0!==this.endPoint&&this.endPoint.deleteObjects(),this.endPoint=void 0,this.sweepSense=void 0},Arc.prototype.setCenterPosition=function(e,t){void 0===this.centerPoint&&(this.centerPoint=new Point2D),this.centerPoint.set(e,t)},Arc.prototype.setRadius=function(e){this.radius=e},Arc.prototype.setStartAngleDegree=function(e){this.startAngleDeg=e},Arc.prototype.setStartPoint=function(e,t){void 0===this.startPoint&&(this.startPoint=new Point2D),this.startPoint.set(e,t)},Arc.prototype.setEndPoint=function(e,t){void 0===this.endPoint&&(this.endPoint=new Point2D),this.endPoint.set(e,t)},Arc.prototype.setSense=function(e){this.sweepSense=e},Arc.prototype.setSweepAngleDegree=function(e){this.sweepAngleDeg=e},Arc.prototype.getPoints=function(e,t){if(void 0===this.centerPoint)return e;var i,o;if(t&&(this.numPointsFor360Deg=t),void 0===this.numPointsFor360Deg&&(this.numPointsFor360Deg=36),void 0===this.startAngleDeg){if(void 0===this.startPoint)return e;(i=new Point2D).set(this.startPoint.x-this.centerPoint.x,this.startPoint.y-this.centerPoint.y),o=i.getModul();var r=Math.acos(n/o);this.startPoint.y<0&&(r*=-1),this.startAngleDeg=180*r/Math.PI}if(void 0===this.radius){if(void 0===this.startPoint)return e;void 0===o&&(void 0===i&&(i=new Point2D).set(this.startPoint.x-this.centerPoint.x,this.startPoint.y-this.centerPoint.y),o=i.getModul()),this.radius=o}if(void 0===this.sweepAngleDeg){if(void 0===this.endPoint||void 0===this.sweepSense)return e;(new Point2D).set(this.endPoint.x-this.centerPoint.x,this.endPoint.y-this.endPoint.y);endPoint.getModul(),r=Math.acos(n/o);this.endPoint.y<0&&(r*=-1),this.sweepAngleDeg=180*r/Math.PI,this.sweepSense<0&&(this.sweepAngleDeg=360-this.sweepAngleDeg)}void 0===e&&(e=[]);var n,a,s,l=[],c=2*Math.PI/this.numPointsFor360Deg,h=this.centerPoint.x,d=this.centerPoint.y,u=Math.PI/180*this.startAngleDeg,f=Math.PI/180*this.sweepAngleDeg;if(f>=0)for(var g=0;g<f;g+=c)n=h+this.radius*Math.cos(g+u),a=d+this.radius*Math.sin(g+u),s=new Point2D(n,a),l.push(s);else for(g=0;g>f;g-=c)n=h+this.radius*Math.cos(g+u),a=d+this.radius*Math.sin(g+u),s=new Point2D(n,a),l.push(s);var p=l.length;p>0&&(l[0].pointType=1,l[p-1].pointType=1);for(var m=e.length,y=0;y<p;y++)if(0===y)if(m>0){var v=e[m-1];s=l[y],v.isCoincidentToPoint(s,1e-4)||e.push(s)}else e.push(l[y]);else e.push(l[y]);if((m=e.length)>0){var x=e[m-1],b=e[0];x.isCoincidentToPoint(b,1e-4)&&(e.pop(),x.deleteObjects())}return e};var AxisXYZ=function(e){if(!(this instanceof AxisXYZ))throw new Error(Messages.CONSTRUCT_ERROR);this.length=void 0===e?60:e,this.vbo_vicks_container=new VBOVertexIdxCacheKeysContainer};AxisXYZ.prototype.setDimension=function(e){this.length=e},AxisXYZ.prototype.makeMesh=function(e){void 0!==e&&(this.length=e);var t=new ParametricMesh;t.profile=new Profile;var i,o=t.profile,r=o.newOuterRing(),n=this.length,a=.1*this.length,s=r.newElement("POLYLINE");s.newPoint2d(0,0);s.newPoint2d(.25*a,.25*n),s.newPoint2d(.25*a,.75*n),s.newPoint2d(.5*a,.75*n),s.newPoint2d(0,n),i=new Segment2D;var l=new Point2D(0,-10),c=new Point2D(0,10);i.setPoints(l,c),t.revolve(o,360,8,i);var h=t.getSurfaceIndependentMesh(void 0,!1,!1);h.setColor(.1,1,.1,1),h.reverseSense();var d=new Matrix4,u=h.getCopy(void 0);d.rotationAxisAngDeg(-90,0,0,1),u.transformByMatrix4(d),u.setColor(1,.1,.1,1);var f=h.getCopy(void 0);return d.rotationAxisAngDeg(90,1,0,0),f.transformByMatrix4(d),f.setColor(.1,.1,1,1),h.mergeMesh(u),h.mergeMesh(f),h},AxisXYZ.prototype.getVboKeysContainer=function(){return this.vbo_vicks_container};var BoundingRectangle=function(e,t){if(!(this instanceof BoundingRectangle))throw new Error(Messages.CONSTRUCT_ERROR);this.minX=1e5,this.maxX=-1e5,this.minY=1e5,this.maxY=-1e5};BoundingRectangle.prototype.setInit=function(e){void 0!==e&&(this.minX=e.x,this.minY=e.y,this.maxX=e.x,this.maxY=e.y)},BoundingRectangle.prototype.setInitByRectangle=function(e){void 0!==e&&(this.minX=e.minX,this.minY=e.minY,this.maxX=e.maxX,this.maxY=e.maxY)},BoundingRectangle.prototype.addPoint=function(e){void 0!==e&&(e.x<this.minX?this.minX=e.x:e.x>this.maxX&&(this.maxX=e.x),e.y<this.minY?this.minY=e.y:e.y>this.maxY&&(this.maxY=e.y))},BoundingRectangle.prototype.addRectangle=function(e){void 0!==e&&(e.minX<this.minX&&(this.minX=e.minX),e.maxX>this.maxX&&(this.maxX=e.maxX),e.minY<this.minY&&(this.minY=e.minY),e.maxY>this.maxY&&(this.maxY=e.maxY))},BoundingRectangle.prototype.intersectsWithRectangle=function(e){return void 0!==e&&(!(e.minX>this.maxX)&&(!(e.maxX<this.minX)&&(!(e.minY>this.maxY)&&!(e.maxY<this.minY))))};var BoxAux=function(){if(!(this instanceof BoxAux))throw new Error(Messages.CONSTRUCT_ERROR);this.triPolyhedron=new TriPolyhedron,this.vbo_vicks_container=new VBOVertexIdxCacheKeysContainer,this.vBOVertexIdxCacheKey=this.vbo_vicks_container.newVBOVertexIdxCacheKey()};BoxAux.prototype.getVboKeysContainer=function(){return this.vbo_vicks_container},BoxAux.prototype.makeAABB=function(e,t,i){var o,r=-e/2,n=-t/2,a=-i/2,s=e/2,l=t/2,c=i/2,h=this.triPolyhedron.vertexList,d=h.newVertex();d.setPosition(r,n,a),(d=h.newVertex()).setPosition(s,n,a),(d=h.newVertex()).setPosition(s,l,a),(d=h.newVertex()).setPosition(r,l,a),(d=h.newVertex()).setPosition(r,n,c),(d=h.newVertex()).setPosition(s,n,c),(d=h.newVertex()).setPosition(s,l,c),(d=h.newVertex()).setPosition(r,l,c),(o=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(h.getVertex(0),h.getVertex(2),h.getVertex(1)),o.newTriangle().setVertices(h.getVertex(0),h.getVertex(3),h.getVertex(2)),(o=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(h.getVertex(4),h.getVertex(5),h.getVertex(6)),o.newTriangle().setVertices(h.getVertex(4),h.getVertex(6),h.getVertex(7)),(o=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(h.getVertex(0),h.getVertex(1),h.getVertex(5)),o.newTriangle().setVertices(h.getVertex(0),h.getVertex(5),h.getVertex(4)),(o=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(h.getVertex(1),h.getVertex(2),h.getVertex(6)),o.newTriangle().setVertices(h.getVertex(1),h.getVertex(6),h.getVertex(5)),(o=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(h.getVertex(2),h.getVertex(3),h.getVertex(7)),o.newTriangle().setVertices(h.getVertex(2),h.getVertex(7),h.getVertex(6)),(o=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(h.getVertex(3),h.getVertex(0),h.getVertex(4)),o.newTriangle().setVertices(h.getVertex(3),h.getVertex(4),h.getVertex(7))};var Circle=function(){if(!(this instanceof Circle))throw new Error(Messages.CONSTRUCT_ERROR);this.centerPoint,this.radius,this.numPointsFor360Deg};Circle.prototype.setCenterPosition=function(e,t){void 0===this.centerPoint&&(this.centerPoint=new Point2D),this.centerPoint.set(e,t)},Circle.prototype.setRadius=function(e){this.radius=e},Circle.prototype.getPoints=function(e,t){if(t&&(this.numPointsFor360Deg=t),void 0===this.numPointsFor360Deg&&(this.numPointsFor360Deg=36),void 0===this.centerPoint||void 0===this.radius)return e;var i=new Arc;return i.setCenterPosition(this.centerPoint.x,this.centerPoint.y),i.setRadius(this.radius),i.setStartAngleDegree(0),i.setSweepAngleDegree(360),i.setSense(1),void 0===e&&(e=[]),e=i.getPoints(e,this.numPointsFor360Deg)};var Ellipsoid=function(e,t,i){if(!(this instanceof Ellipsoid))throw new Error(Messages.CONSTRUCT_ERROR);this.radiusX,this.radiusY,this.radiusZ,void 0!==e&&(this.radiusX=e),void 0!==t&&(this.radiusY=t),void 0!==i&&(this.radiusZ=i)},Face=function(){if(!(this instanceof Face))throw new Error(Messages.CONSTRUCT_ERROR);this.vertexArray,this.hEdge,this.planeNormal,this.surfaceOwner};Face.prototype.getVerticesCount=function(){return void 0===this.vertexArray?0:this.vertexArray.length},Face.prototype.addVertex=function(e){void 0===this.vertexArray&&(this.vertexArray=[]),this.vertexArray.push(e)},Face.prototype.getVertex=function(e){if(void 0!==this.vertexArray)return this.vertexArray[e]},Face.prototype.reverseSense=function(){this.vertexArray.reverse()},Face.prototype.setColor=function(e,t,i,o){for(var r=this.getVerticesCount(),n=0;n<r;n++)this.getVertex(n).setColorRGBA(e,t,i,o)},Face.prototype.calculateVerticesNormals=function(){for(var e=!1,t=this.vertexArray.length,i=0;!e&&i<t;)this.planeNormal=VertexList.getCrossProduct(i,this.vertexArray,this.planeNormal),0===this.planeNormal.x&&0===this.planeNormal.y&&0===this.planeNormal.z||(e=!0),i++;this.planeNormal.unitary();for(t=this.getVerticesCount(),i=0;i<t;i++)this.vertexArray[i].setNormal(this.planeNormal.x,this.planeNormal.y,this.planeNormal.z)},Face.prototype.getTrianglesConvex=function(e){if(void 0===this.vertexArray||0===this.vertexArray.length)return e;var t,i,o,r;void 0===e&&(e=[]),t=this.getVertex(0);for(var n=this.getVerticesCount(),a=1;a<n-1;a++)i=this.getVertex(a),o=this.getVertex(a+1),r=new Triangle(t,i,o),e.push(r);return e},Face.prototype.setTwinHalfEdge=function(e){for(var t=!1,i=this.hEdge,o=this.hEdge;!t;){if(o.setTwin(e))return!0;(o=o.next)===i&&(t=!0)}return!1},Face.prototype.getFrontierHalfEdges=function(e){var t=this.getHalfEdgesLoop(void 0);if(void 0===t)return e;void 0===e&&(e=[]);for(var i,o=t.length,r=0;r<o;r++)(i=t[r]).isFrontier()&&e.push(i);return e},Face.prototype.getHalfEdgesLoop=function(e){return void 0===this.hEdge?e:e=HalfEdge.getHalfEdgesLoop(this.hEdge,e)},Face.prototype.setTwinFace=function(e){if(void 0===e)return!1;if(void 0===this.hEdge||void 0===e.hEdge)return!1;for(var t,i=e.getHalfEdgesLoop(void 0),o=i.length,r=!1,n=0;n<o;n++)t=i[n],this.setTwinHalfEdge(t)&&(r=!0);return r},Face.prototype.createHalfEdges=function(e){if(void 0===this.vertexArray||0===this.vertexArray.length)return e;var t,i;void 0===e&&(e=[]);for(var o,r=this.getVerticesCount(),n=0;n<r;n++)t=this.getVertex(n),(i=new HalfEdge).setStartVertex(t),i.setFace(this),e.push(i);for(n=0;n<r;n++)i=e[n],o=e[VertexList.getNextIdx(n,this.vertexArray)],i.setNext(o);return this.hEdge=e[0],e};var HalfEdge=function(){if(!(this instanceof HalfEdge))throw new Error(Messages.CONSTRUCT_ERROR);this.startVertex,this.next,this.twin,this.face};HalfEdge.prototype.setStartVertex=function(e){this.startVertex=e,e.outingHedge=this},HalfEdge.prototype.setNext=function(e){this.next=e},HalfEdge.prototype.setTwin=function(e){var t=HalfEdge.areTwinables(e,this);return t&&(this.twin=e,e.twin=this),t},HalfEdge.prototype.setFace=function(e){this.face=e},HalfEdge.prototype.getEndVertex=function(){if(void 0!==this.next)return this.next.startVertex},HalfEdge.prototype.isFrontier=function(){return void 0===this.twin||null===this.twin},HalfEdge.prototype.getPrev=function(){for(var e=this;;){if(e.next===this)return e;if(void 0===e.next)return;e=e.next}},HalfEdge.areTwinables=function(e,t){return e.startVertex===t.getEndVertex()&&e.getEndVertex()===t.startVertex},HalfEdge.getHalfEdgesLoop=function(e,t){if(void 0===e)return t;void 0===t&&(t=[]),t.length=0;for(var i=e,o=e,r=!1;!r;)t.push(o),(o=o.next)!==i&&void 0!==o||(r=!0);return t};var HalfEdgesList=function(){if(!(this instanceof HalfEdgesList))throw new Error(Messages.CONSTRUCT_ERROR);this.hEdgesArray};HalfEdgesList.prototype.newHalfEdge=function(){void 0===this.hEdgesArray&&(this.hEdgesArray=[]);var e=new HalfEdge;return this.hEdgesArray.push(e),e},HalfEdgesList.prototype.addHalfEdgesArray=function(e){void 0!==e&&(void 0===this.hEdgesArray&&(this.hEdgesArray=[]),Array.prototype.push.apply(this.hEdgesArray,e))};var IndexData=function(){if(!(this instanceof IndexData))throw new Error(Messages.CONSTRUCT_ERROR);this.owner,this.idx},IndexRange=function(){if(!(this instanceof IndexRange))throw new Error(Messages.CONSTRUCT_ERROR);this.strIdx,this.endIdx};IndexRange.prototype.copyFrom=function(e){void 0!==e&&(this.strIdx=e.strIdx,this.endIdx=e.endIdx)};var Line=function(){if(!(this instanceof Line))throw new Error(Messages.CONSTRUCT_ERROR);this.point=new Point3D,this.direction=new Point3D};Line.prototype.setPointAndDir=function(e,t,i,o,r,n){this.point.set(e,t,i),this.direction.set(o,r,n),this.direction.unitary()},Line.prototype.getProjectedPoint=function(e,t){void 0===t&&(t=new Point3D);var i=new Plane;return i.setPointAndNormal(e.x,e.y,e.z,this.direction.x,this.direction.y,this.direction.z),t=i.intersectionLine(this,t)},Line.prototype.isCoincidentPoint=function(e,t){if(void 0===e)return!1;var i=this.getProjectedPoint(e);return void 0!==i&&(void 0===t&&(t=1e-7),i.squareDistToPoint(e)<t*t)};var Line2D=function(){if(!(this instanceof Line2D))throw new Error(Messages.CONSTRUCT_ERROR);this.point=new Point2D,this.direction=new Point2D};Line2D.prototype.setPointAndDir=function(e,t,i,o){this.point.set(e,t),this.direction.set(i,o),this.direction.unitary()},Line2D.prototype.getPerpendicularRight=function(e){var t=new Line2D;return e?t.point.set(e.x,e.y):t.point.set(this.point.x,this.point.y),t.direction.set(this.direction.y,-this.direction.x),t},Line2D.prototype.getPerpendicularLeft=function(e){var t=new Line2D;return e?t.point.set(e.x,e.y):t.point.set(this.point.x,this.point.y),t.direction.set(-this.direction.y,this.direction.x),t},Line2D.prototype.getProjectedPoint=function(e,t){if(void 0!==e){void 0===t&&(t=new Point2D);var i=this.getPerpendicularLeft(e);return t=this.intersectionWithLine(i,t)}},Line2D.prototype.isCoincidentPoint=function(e,t){if(void 0===e)return!1;void 0===t&&(t=1e-7);var i=this.getProjectedPoint(e,i);return e.squareDistToPoint(i)<t*t},Line2D.prototype.isParallelToLine=function(e){if(void 0===e)return!1;var t=this.direction.angleRadToVector(e.direction);return t<1e-9||Math.abs(t-Math.PI)<1e-9},Line2D.prototype.intersectionWithLine=function(e,t){if(void 0!==e&&!this.isParallelToLine(e)){var i,o;if(Math.abs(this.direction.x)<1e-9){var r=e.direction.y/e.direction.x,n=e.point.y-r*e.point.x;i=this.point.x,o=r*this.point.x+n}else if(Math.abs(this.direction.y)<1e-9)if(Math.abs(e.direction.x)<1e-9)i=e.point.x,o=this.point.y;else{r=e.direction.y/e.direction.x,n=e.point.y-r*e.point.x;i=(this.point.y-n)/r,o=this.point.y}else if(Math.abs(e.direction.x)<1e-9){var a=this.direction.y/this.direction.x,s=this.point.y-a*this.point.x;i=e.point.x,o=e.point.x*a+s}else{a=this.direction.y/this.direction.x,s=this.point.y-a*this.point.x;o=(r=e.direction.y/e.direction.x)*(i=(s-(n=e.point.y-r*e.point.x))/(r-a))+n}return void 0===t&&(t=new Point2D),t.set(i,o),t}};var MagoNativeProject=function(){if(!(this instanceof MagoNativeProject))throw new Error(Messages.CONSTRUCT_ERROR);this.meshesArray,this.geoLocDataManager,this.vboKeysContainer};MagoNativeProject.prototype.newParametricMesh=function(){void 0===this.meshesArray&&(this.meshesArray=[]);var e=new ParametricMesh;return this.meshesArray.push(e),e},MagoNativeProject.prototype.deleteObjects=function(){if(void 0!==this.meshesArray){for(var e=this.meshesArray.length,t=0;t<e;t++)this.meshesArray[t].deleteObjects(),this.meshesArray[t]=void 0;this.meshesArray=void 0,this.geoLocDataManager&&this.geoLocDataManager.deleteObjects(),this.geoLocDataManager=void 0}},MagoNativeProject.prototype.getMeshesCount=function(){return void 0===this.meshesArray?0:this.meshesArray.length},MagoNativeProject.prototype.getMesh=function(e){if(void 0!==this.meshesArray)return this.meshesArray[e]};var MagoWorld=function(e){if(!(this instanceof MagoWorld))throw new Error(Messages.CONSTRUCT_ERROR);this.magoManager=e};MagoWorld.prototype.prepareVisibles=function(){},MagoWorld.prototype.renderScene=function(){this.renderTest()},MagoWorld.prototype.renderTest=function(){var e=this.magoManager.sceneState.gl;e.clearColor(0,0,0,1),e.enable(e.DEPTH_TEST),e.viewport(0,0,e.viewportWidth,e.viewportHeight),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.magoManager.start(void 0,!0,0,1)},MagoWorld.prototype.goto=function(e,t,i){var o;o=Globe.geographicToCartesianWgs84(e,t,i,o);var r,n=this.magoManager.sceneState.camera,a=n.position,s=n.direction,l=n.up;r=this.magoManager.globe.transformMatrixAtCartesianPointWgs84(o[0],o[1],o[2],r),a.set(o[0],o[1],o[2]),s.set(-r[8],-r[9],-r[10]),l.set(r[4],r[5],r[6]),this.updateModelViewMatrixByCamera(n)},MagoWorld.prototype.mousedown=function(e){this.magoManager.sceneState.mouseButton=e.button,this.updateMouseCurrent(e.clientX,e.clientY),this.magoManager.isCameraMoving=!0},MagoWorld.prototype.updateMouseCurrent=function(e,t){var i=this.magoManager.sceneState.gl,o=this.magoManager.sceneState.mouseAction;o.curX=e,o.curY=t,0===this.magoManager.sceneState.mouseButton&&(this.magoManager.bPicking=!0),o.curCamCoordPoint=this.magoManager.calculatePixelPositionCamCoord(i,o.curX,o.curY,o.curCamCoordPoint),o.curWorldPoint=this.magoManager.cameraCoordPositionToWorldCoord(o.curCamCoordPoint,o.curWorldPoint);var r=this.magoManager.sceneState.camera;o.curCamera.copyPosDirUpFrom(r);var n,a=this.magoManager.sceneState.modelViewMatrix,s=this.magoManager.sceneState.modelViewMatrixInv;o.curModelViewMatrix._floatArrays=mat4.copy(o.curModelViewMatrix._floatArrays,a._floatArrays),o.curModelViewMatrixInv._floatArrays=mat4.copy(o.curModelViewMatrixInv._floatArrays,s._floatArrays),n=this.magoManager.getRayWorldSpace(i,e,t,n),o.curWorldPoint2=this.magoManager.globe.intersectionLineWgs84(n,o.curWorldPoint2)},MagoWorld.prototype.updateModelViewMatrixByCamera=function(e,t){this.magoManager.sceneState.mouseAction;var i,o=(e=this.magoManager.sceneState.camera).position,r=e.direction,n=e.up,a=e.frustum.far[0];if((i=new Float32Array(3))[0]=o.x+r.x*a,i[1]=o.y+r.y*a,i[2]=o.z+r.z*a,o.getModul()<Math.sqrt(i[0]*i[0],i[1]*i[1],i[2]*i[2]));var s=this.magoManager.sceneState.modelViewMatrix;s._floatArrays=mat4.lookAt(s._floatArrays,[o.x,o.y,o.z],[i[0],i[1],i[2]],[n.x,n.y,n.z])},MagoWorld.prototype.mouseup=function(e){this.magoManager.sceneState.mouseButton=-1,this.magoManager.bPicking=!1,this.magoManager.isCameraMoving=!1},MagoWorld.prototype.mousewheel=function(e){var t,i,o=e.wheelDelta/10,r=(this.magoManager.sceneState.mouseAction,this.magoManager.sceneState.camera),n=r.position,a=r.direction,s=(r.up,r.getCameraElevation());s>2e4&&(t=s*s*1e-9,i=.01*s),s>16e3?(t=s*s*1e-9,i=.001*s):s>14e3?(t=s*s*1e-9,i=.001*s):s>1e4?(t=s*s*1e-10,i=1e-4*s):s>6e3?(t=s*s*1e-11,i=1e-7*s):(t=s*s*1e-11,i=1e-8*s),o*=t+i+1,n.add(a.x*o,a.y*o,a.z*o),this.updateModelViewMatrixByCamera(r)},MagoWorld.prototype.mousemove=function(e){var t=this.magoManager.sceneState.mouseAction;if(0===this.magoManager.sceneState.mouseButton){this.magoManager.sceneState.gl,this.magoManager.sceneState;var i,o,r=t.curCamera,n=this.magoManager.sceneState.camera,a=t.curWorldPoint,s=a.getModul(),l=e.clientX,c=e.clientY;if(l===t.curX&&c===t.curY)return;o=this.magoManager.getRayCamSpace(l,c,o),void 0===this.pointSC&&(this.pointSC=new Point3D),this.pointSC.set(o[0],o[1],o[2]);var h,d=t.curModelViewMatrixInv;if(this.pointSC2=d.rotatePoint3D(this.pointSC,this.pointSC2),this.pointSC2.unitary(),(i=new Line).setPointAndDir(r.position.x,r.position.y,r.position.z,this.pointSC2.x,this.pointSC2.y,this.pointSC2.z),void 0===(h=this.magoManager.globe.intersectionLineWgs84(i,h,s)))return;var u,f=new Point3D(a.x,a.y,a.z),g=new Point3D(h[0],h[1],h[2]);if((u=f.crossProduct(g,u)).unitary(),u.isNAN())return;var p=f.angleRadToVector(g);if(0===p||isNaN(p))return;n.copyPosDirUpFrom(r);var m=mat4.create();m=mat4.rotate(m,m,-p,[u.x,u.y,u.z]),n.transformByMatrix4(m),this.updateModelViewMatrixByCamera(n)}else if(1===this.magoManager.sceneState.mouseButton){r=t.curCamera;(n=this.magoManager.sceneState.camera).copyPosDirUpFrom(r);n.position,n.direction,n.up;var y,v=t.curWorldPoint;void 0===this.magoManager.globe&&(this.magoManager.globe=new Globe),y=this.magoManager.globe.normalAtCartesianPointWgs84(v.x,v.y,v.z,y);var x=n.getCameraRight(),b=(l=e.clientX,c=e.clientY,.003*(l-t.curX)),C=.003*(c-t.curY);if(0===b&&0==C)return;void 0===this.rotMatX&&(this.rotMatX=mat4.create()),void 0===this.rotMatZ&&(this.rotMatZ=mat4.create()),void 0===this.rotMat&&(this.rotMat=mat4.create()),this.rotMatX=mat4.identity(this.rotMatX),this.rotMatZ=mat4.identity(this.rotMatZ),this.rotMat=mat4.identity(this.rotMat),this.rotMatX=mat4.fromRotation(this.rotMatX,-C,[x.x,x.y,x.z]),this.rotMatZ=mat4.fromRotation(this.rotMatZ,-b,y),this.rotMat=mat4.multiply(this.rotMat,this.rotMatZ,this.rotMatX);var M=mat4.create(),_=mat4.create();M=mat4.fromTranslation(M,[-v.x,-v.y,-v.z]),_=mat4.fromTranslation(_,[v.x,v.y,v.z]);var A=mat4.create();A=mat4.multiply(A,_,this.rotMat);var R=mat4.create();R=mat4.multiply(R,A,_),n.transformByMatrix4(M),n.transformByMatrix4(this.rotMat),n.transformByMatrix4(_),this.updateModelViewMatrixByCamera(n)}},MagoWorld.prototype.keydown=function(e){};var Mesh=function(){if(!(this instanceof Mesh))throw new Error(Messages.CONSTRUCT_ERROR);this.vertexList,this.surfacesArray,this.hedgesList};Mesh.prototype.newSurface=function(){void 0===this.surfacesArray&&(this.surfacesArray=[]);var e=new Surface;return this.surfacesArray.push(e),e},Mesh.prototype.getSurface=function(e){if(void 0!==this.surfacesArray)return this.surfacesArray[e]},Mesh.prototype.addSurface=function(e){void 0!==e&&(void 0===this.surfacesArray&&(this.surfacesArray=[]),this.surfacesArray.push(e))},Mesh.prototype.mergeMesh=function(e){if(void 0!==e){void 0===this.surfacesArray&&(this.surfacesArray=[]);for(var t=e.getSurfacesCount(),i=0;i<t;i++)this.addSurface(e.getSurface(i));e.surfacesArray=void 0}},Mesh.prototype.getSurfacesCount=function(){return void 0===this.surfacesArray?0:this.surfacesArray.length},Mesh.prototype.getCopySurfaceIndependentMesh=function(e){var t,i;void 0===e&&(e=new Mesh);for(var o=this.getSurfacesCount(),r=0;r<o;r++)t=this.getSurface(r),i=e.newSurface(),i=t.getCopyIndependentSurface(i);return e},Mesh.prototype.getTrianglesConvex=function(e){if(void 0===this.surfacesArray||0===this.surfacesArray.length)return e;void 0===e&&(e=[]);for(var t=this.getSurfacesCount(),i=0;i<t;i++)e=this.getSurface(i).getTrianglesConvex(e);return e},Mesh.prototype.getNoRepeatedVerticesArray=function(e){var t,i,o;void 0===e&&(e=[]);for(var r,n,a=0,s=this.getSurfacesCount(),l=0;l<s;l++){t=(o=this.getSurface(l)).getFacesCount();for(var c=0;c<t;c++){n=(i=o.getFace(c)).getVerticesCount();for(var h=0;h<n;h++){if(void 0===(r=i.getVertex(h)));r.setIdxInList(a),a++}}}var d,u={};for(s=this.getSurfacesCount(),l=0;l<s;l++){t=(o=this.getSurface(l)).getFacesCount();for(c=0;c<t;c++){n=(i=o.getFace(c)).getVerticesCount();for(h=0;h<n;h++)u[(r=i.getVertex(h)).getIdxInList().toString()]=r}}for(var f in u)d=u[f],e.push(d);return e},Mesh.prototype.transformByMatrix4=function(e){void 0===this.vertexList&&(this.vertexList=new VertexList,this.vertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),this.vertexList.transformPointsByMatrix4(e),this.calculateVerticesNormals()},Mesh.prototype.translate=function(e,t,i){void 0===this.vertexList&&(this.vertexList=new VertexList,this.vertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),this.vertexList.translateVertices(e,t,i)},Mesh.prototype.calculateVerticesNormals=function(){for(var e=this.getSurfacesCount(),t=0;t<e;t++)this.getSurface(t).calculateVerticesNormals()},Mesh.prototype.setColor=function(e,t,i,o){for(var r=this.getSurfacesCount(),n=0;n<r;n++)this.getSurface(n).setColor(e,t,i,o)},Mesh.prototype.reverseSense=function(){for(var e=this.getSurfacesCount(),t=0;t<e;t++)this.getSurface(t).reverseSense();this.calculateVerticesNormals()},Mesh.prototype.getFrontierHalfEdges=function(e){for(var t=this.getSurfacesCount(),i=0;i<t;i++)e=this.getSurface(i).getFrontierHalfEdges(e);return e},Mesh.prototype.getCopy=function(e){var t,i,o,r,n,a,s,l;void 0===this.vertexList&&(this.vertexList=new VertexList),void 0!==this.vertexList.vertexArray&&0!==this.vertexList.vertexArray.length||(this.vertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),void 0===e&&(e=new Mesh),void 0===e.vertexList&&(e.vertexList=new VertexList),e.vertexList.copyFrom(this.vertexList),this.vertexList.setIdxInList(),e.vertexList.setIdxInList();for(var c=this.getSurfacesCount(),h=0;h<c;h++){t=this.getSurface(h),a=e.newSurface(),i=t.getFacesCount();for(var d=0;d<i;d++){o=t.getFace(d),s=a.newFace(),r=o.getVerticesCount();for(var u=0;u<r;u++)n=o.getVertex(u).getIdxInList(),l=e.vertexList.getVertex(n),s.addVertex(l)}}return e.calculateVerticesNormals(),e},Mesh.prototype.getTrianglesListsArrayBy2ByteSize=function(e,t){void 0===t&&(t=[]);var i=new TrianglesList;if(t.push(i),3*(a=e.length)<65535)return i.trianglesArray=[],Array.prototype.push.apply(i.trianglesArray,e),t;var o=TrianglesList.getNoRepeatedVerticesArray(e,void 0);if(o.length<65535)return i.trianglesArray=[],Array.prototype.push.apply(i.trianglesArray,e),t;VertexList.setIdxInList(o);for(var r,n=[],a=e.length,s=0;s<a;s++)(r=e[s]).vertex0.idxInList<65535&&r.vertex1.idxInList<65535&&r.vertex2.idxInList<65535?i.addTriangle(r):n.push(r);return n.length>0&&(t=this.getTrianglesListsArrayBy2ByteSize(n,t)),t},Mesh.prototype.getVbo=function(e){void 0===e&&(e=new VBOVertexIdxCacheKeysContainer);for(var t,i,o=this.getTrianglesConvex(void 0),r=(o.length,this.getTrianglesListsArrayBy2ByteSize(o,void 0)),n=r.length,a=0;a<n;a++){i=(t=r[a]).getNoRepeatedVerticesArray(void 0);var s=e.newVBOVertexIdxCacheKey();VertexList.setIdxInList(i),VertexList.getVboDataArrays(i,s),t.assignVerticesIdx(),TrianglesList.getVboFaceDataArray(t.trianglesArray,s)}return e},Mesh.prototype.getVboEdges=function(e){for(var t,i,o,r=this.getFrontierHalfEdges(void 0),n=r.length,a=[],s=[],l=0,c=0;c<n;c++)i=(t=r[c]).startVertex,o=t.getEndVertex(),a.push(i.point3d.x),a.push(i.point3d.y),a.push(i.point3d.z),a.push(o.point3d.x),a.push(o.point3d.y),a.push(o.point3d.z),s.push(l),l++,s.push(l),l++;var h=e.newVBOVertexIdxCacheKey();h.posVboDataArray=Float32Array.from(a),h.idxVboDataArray=Int16Array.from(s),h.indicesCount=h.idxVboDataArray.length};var ParametricMesh=function(){if(!(this instanceof ParametricMesh))throw new Error(Messages.CONSTRUCT_ERROR);this.vtxProfilesList,this.profile,this.vboKeyContainer,this.vboKeyContainerEdges};ParametricMesh.prototype.deleteObjects=function(){this.profile&&this.profile.deleteObjects(),this.profile=void 0},ParametricMesh.prototype.getVboKeysContainer=function(){return this.vboKeyContainer},ParametricMesh.prototype.getMesh=function(e,t,i){return void 0===e&&(e=new Mesh),(e=this.vtxProfilesList.getMesh(e,t,i)).calculateVerticesNormals(),e},ParametricMesh.prototype.getSurfaceIndependentMesh=function(e,t,i){return void 0===e&&(e=new Mesh),this.mesh=this.vtxProfilesList.getMesh(void 0,t,i),(e=this.mesh.getCopySurfaceIndependentMesh(e)).calculateVerticesNormals(),e},ParametricMesh.prototype.revolve=function(e,t,i,o){if(void 0!==e){void 0===this.vtxProfilesList&&(this.vtxProfilesList=new VtxProfilesList),this.vtxProfilesList.convexFacesIndicesData=e.getConvexFacesIndicesData(void 0);var r=this.vtxProfilesList.newVtxProfile();r.makeByProfile(e);var n=t/i,a=o.getLine(),s=new Point2D(0,0),l=a.getProjectedPoint(s);l.inverse();var c=new Matrix4,h=new Quaternion,d=o.getDirection(),u=new Point3D(d.x,d.y,0);u.unitary();for(var f=0;f<i;f++){h.rotationAngDeg(n*(f+1),u.x,u.y,u.z),c.rotationByQuaternion(h);var g=this.vtxProfilesList.newVtxProfile();g.copyFrom(r),g.translate(l.x,l.y,0),g.transformPointsByMatrix4(c),g.translate(-l.x,-l.y,0)}}},ParametricMesh.prototype.extrude=function(e,t,i,o){if(void 0!==e&&void 0!==t){void 0===this.vtxProfilesList&&(this.vtxProfilesList=new VtxProfilesList),this.vtxProfilesList.convexFacesIndicesData=e.getConvexFacesIndicesData(void 0);var r=this.vtxProfilesList.newVtxProfile();r.makeByProfile(e),void 0===o&&(o=new Point3D(0,0,1));for(var n=t/i,a=0;a<i;a++){var s=this.vtxProfilesList.newVtxProfile();s.copyFrom(r),s.translate(0,0,n*(a+1))}}};var Point2D=function(e,t){if(!(this instanceof Point2D))throw new Error(Messages.CONSTRUCT_ERROR);this.x=e||0,this.y=t||0,this.associated};Point2D.prototype.deleteObjects=function(){this.x=void 0,this.y=void 0},Point2D.prototype.setAssociated=function(e){this.associated=e},Point2D.prototype.getAssociated=function(){return this.associated},Point2D.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y},Point2D.prototype.inverse=function(){this.x=-this.x,this.y=-this.y},Point2D.prototype.set=function(e,t){this.x=e,this.y=t},Point2D.prototype.getSquaredModul=function(){return this.x*this.x+this.y*this.y},Point2D.prototype.getModul=function(){return Math.sqrt(this.getSquaredModul())},Point2D.prototype.unitary=function(){var e=this.getModul();this.x/=e,this.y/=e},Point2D.prototype.squareDistToPoint=function(e){var t=this.x-e.x,i=this.y-e.y;return t*t+i*i},Point2D.prototype.distToPoint=function(e){return Math.sqrt(this.squareDistToPoint(e))},Point2D.prototype.isCoincidentToPoint=function(e,t){var i=!1;return this.distToPoint(e)<t*t&&(i=!0),i},Point2D.prototype.getVectorToPoint=function(e,t){if(void 0!==e)return void 0===t&&(t=new Point2D),t.set(e.x-this.x,e.y-this.y),t},Point2D.prototype.crossProduct=function(e){return this.x*e.y-e.x*this.y},Point2D.prototype.scalarProduct=function(e){return this.x*e.x+this.y*e.y},Point2D.prototype.angleRadToVector=function(e){if(void 0!==e){var t=this.getModul(),i=e.getModul();if(!(t<1e-9||i<1e-9))return Math.acos(this.scalarProduct(e)/(t*i))}},Point2D.prototype.angleDegToVector=function(e){if(void 0!==e){var t=this.angleRadToVector(e);if(void 0!==t)return 180*t/Math.PI}};var Point2DList=function(e,t){if(!(this instanceof Point2DList))throw new Error(Messages.CONSTRUCT_ERROR);this.pointsArray};Point2DList.prototype.deleteObjects=function(){if(void 0!==this.pointsArray){for(var e=this.pointsArray.length,t=0;t<e;t++)this.pointsArray[t].deleteObjects(),this.pointsArray[t]=void 0;this.pointsArray=void 0}},Point2DList.prototype.addPoint=function(e){void 0!==e&&(void 0===this.pointsArray&&(this.pointsArray=[]),this.pointsArray.push(e))},Point2DList.prototype.newPoint=function(e,t){void 0===this.pointsArray&&(this.pointsArray=[]);var i=new Point2D(e,t);return this.pointsArray.push(i),i},Point2DList.prototype.getPoint=function(e){return this.pointsArray[e]},Point2DList.prototype.getPointsCount=function(){return void 0===this.pointsArray?0:this.pointsArray.length},Point2DList.prototype.getPrevIdx=function(e){var t=this.pointsArray.length;return 0===e?t-1:e-1},Point2DList.prototype.getNextIdx=function(e){return e===this.pointsArray.length-1?0:e+1},Point2DList.prototype.getIdxOfPoint=function(e){for(var t=this.pointsArray.length,i=0,o=-1,r=!1;!r&&i<t;)this.pointsArray[i]===e&&(r=!0,o=i),i++;return o},Point2DList.prototype.getSegment=function(e,t){var i=this.getPoint(e),o=this.getNextIdx(e),r=this.getPoint(o);return void 0===t?t=new Segment2D(i,r):t.setPoints(i,r),t},Point2DList.prototype.setIdxInList=function(){for(var e=this.pointsArray.length,t=0;t<e;t++)this.pointsArray[t].idxInList=t},Point2DList.prototype.getCopy=function(e){var t;void 0===e?e=new Point2DList:e.deleteObjects();for(var i=this.getPointsCount(),o=0;o<i;o++)t=this.getPoint(o),e.newPoint(t.x,t.y);return e},Point2DList.prototype.getBoundingRectangle=function(e){var t=this.getPointsCount();if(0===t)return e;void 0===e&&(e=new BoundingRectangle);for(var i=0;i<t;i++)0===i?e.setInit(this.getPoint(i)):e.addPoint(this.getPoint(i));return e},Point2DList.prototype.getNearestPointIdxToPoint=function(e){if(void 0!==e){for(var t,i,o,r=this.getPointsCount(),n=0;n<r;n++)i=this.getPoint(n).squareDistToPoint(e),void 0===t?(t=n,o=i):i<o&&(t=n,o=i);return t}},Point2DList.prototype.reverse=function(){void 0!==this.pointsArray&&this.pointsArray.reverse()},Point2DList.prototype.getPointsIdxSortedByDistToPoint=function(e,t){if(void 0===this.pointsArray)return t;void 0===t&&(t=[]);for(var i,o,r,n,a,s,l=this.pointsArray,c=[],h=l.length,d=0;d<h;d++)(o=l[d])!==e&&(r=e.squareDistToPoint(o),(i={}).pointIdx=d,i.squaredDist=r,n=0,a=c.length-1,s=this.getIndexToInsertBySquaredDist(c,i,n,a),c.splice(s,0,i));t.length=0;var u=c.length;for(d=0;d<u;d++)t.push(c[d].pointIdx);return t},Point2DList.prototype.getIndexToInsertBySquaredDist=function(e,t,i,o){var r=o-i;if(0===e.length)return 0;if(r<6){for(var n,a=!1,s=i;!a&&s<=o;)t.squaredDist<e[s].squaredDist&&(n=s,a=!0),s++;return a?n:o+1}var l,c,h=i+Math.floor(r/2);return e[h].squaredDist>t.squaredDist?(l=i,c=h):(l=h,c=o),this.getIndexToInsertBySquaredDist(e,t,l,c)};var Point3D=function(e,t,i){if(!(this instanceof Point3D))throw new Error(Messages.CONSTRUCT_ERROR);this.x=void 0!==e?e:0,this.y=void 0!==t?t:0,this.z=void 0!==i?i:0,this.pointType};Point3D.prototype.deleteObjects=function(){this.x=void 0,this.y=void 0,this.z=void 0},Point3D.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y,this.z=e.z},Point3D.prototype.getSquaredModul=function(){return this.x*this.x+this.y*this.y+this.z*this.z},Point3D.prototype.getModul=function(){return Math.sqrt(this.getSquaredModul())},Point3D.prototype.unitary=function(){var e=this.getModul();this.x/=e,this.y/=e,this.z/=e},Point3D.prototype.isNAN=function(){return!!(isNaN(this.x)||isNaN(this.y)||isNaN(this.z))},Point3D.prototype.crossProduct=function(e,t){return void 0===t&&(t=new Point3D),t.x=this.y*e.z-e.y*this.z,t.y=e.x*this.z-this.x*e.z,t.z=this.x*e.y-e.x*this.y,t},Point3D.prototype.scalarProduct=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},Point3D.prototype.angleRadToVector=function(e){if(void 0!==e){var t=this.getModul(),i=e.getModul();if(!(t<1e-9||i<1e-9))return Math.acos(this.scalarProduct(e)/(t*i))}},Point3D.prototype.angleDegToVector=function(e){if(void 0!==e){var t=this.angleRadToVector(e);if(void 0!==t)return 180*t/Math.PI}},Point3D.prototype.squareDistToPoint=function(e){var t=this.x-e.x,i=this.y-e.y,o=this.z-e.z;return t*t+i*i+o*o},Point3D.prototype.isCoincidentToPoint=function(e,t){var i=!1;return this.distToPoint(e)<t*t&&(i=!0),i},Point3D.prototype.squareDistTo=function(e,t,i){var o=this.x-e,r=this.y-t,n=this.z-i;return o*o+r*r+n*n},Point3D.prototype.distTo=function(e,t,i){return Math.sqrt(this.squareDistTo(e,t,i))},Point3D.prototype.distToPoint=function(e){return Math.sqrt(this.squareDistToPoint(e))},Point3D.prototype.distToSphere=function(e){return Math.sqrt(this.squareDistToPoint(e.centerPoint))-e.r},Point3D.prototype.aproxDistTo=function(e,t){var i,o,r,n,a=Math.abs(this.x-e.x),s=Math.abs(this.y-e.y),l=Math.abs(this.z-e.z);return a>s?a>l?(o=s/(i=a),r=l/(n=i*t[Math.floor(10*o)]),n*t[Math.floor(10*r)]):(o=a/(i=l),r=s/(n=i*t[Math.floor(10*o)]),n*t[Math.floor(10*r)]):s>l?(o=a/(i=s),r=l/(n=i*t[Math.floor(10*o)]),n*t[Math.floor(10*r)]):(o=a/(i=l),r=s/(n=i*t[Math.floor(10*o)]),n*t[Math.floor(10*r)])},Point3D.prototype.getVectorToPoint=function(e,t){if(void 0!==e)return void 0===t&&(t=new Point3D),t.set(e.x-this.x,e.y-this.y,e.z-this.z),t},Point3D.prototype.set=function(e,t,i){this.x=e,this.y=t,this.z=i},Point3D.prototype.add=function(e,t,i){this.x+=e,this.y+=t,this.z+=i},Point3D.prototype.addPoint=function(e){this.x+=e.x,this.y+=e.y,this.z+=e.z},Point3D.prototype.scale=function(e){this.x*=e,this.y*=e,this.z*=e};var Polygon=function(){if(!(this instanceof Polygon))throw new Error(Messages.CONSTRUCT_ERROR);this.point2dList,this.normal,this.convexPolygonsArray,this.bRect};Polygon.prototype.deleteObjects=function(){void 0!==this.point2dList&&(this.point2dList.deleteObjects(),this.point2dList=void 0),this.normal=void 0},Polygon.prototype.getBoundingRectangle=function(e){return void 0===this.point2dList?e:e=this.point2dList.getBoundingRectangle(e)},Polygon.prototype.getEdgeDirection=function(e){return this.point2dList.getSegment(e).getDirection(void 0)},Polygon.prototype.getEdgeVector=function(e){return this.point2dList.getSegment(e).getVector(void 0)},Polygon.prototype.reverseSense=function(){void 0!==this.point2dList&&this.point2dList.reverse()},Polygon.prototype.getCopy=function(e){return void 0===this.point2dList?e:(void 0===e&&(e=new Polygon),void 0===e.point2dList&&(e.point2dList=new Point2DList),e.point2dList=this.point2dList.getCopy(e.point2dList),this.normal&&(e.normal=this.normal),e)},Polygon.prototype.calculateNormal=function(e){void 0===e&&(e=[]),this.normal=0;for(var t=this.point2dList.getPointsCount(),i=0;i<t;i++){this.point2dList.getPoint(i);var o=this.point2dList.getPrevIdx(i),r=this.getEdgeDirection(o),n=this.getEdgeDirection(i),a=r.crossProduct(n,a),s=r.scalarProduct(n);a<0?(a=-1,e.push(i)):a>0&&(a=1);var l=s,c=Math.acos(l);this.normal+=a*c}return this.normal>0?this.normal=1:this.normal=-1,e},Polygon.prototype.tessellate=function(e,t){var i=e.length;if(0===i)return t.push(this),t;for(var o,r=!1,n=0;!r&&n<i;){var a=e[n],s=this.point2dList.getPoint(a),l=[];this.getPointsIdxSortedByDistToPoint(s,l);for(var c=l.length,h=0;!r&&h<c;)if(o=l[h],this.point2dList.getPrevIdx(a)!==o&&this.point2dList.getNextIdx(a)!==o){var d=new Segment2D(this.point2dList.getPoint(a),this.point2dList.getPoint(o));if(this.intersectionWithSegment(d))h++;else{var u=this.splitPolygon(a,o);if(u.length<2)h++;else{var f=u[0],g=u[1],p=f.calculateNormal(),m=g.calculateNormal(),y=f.normal,v=g.normal;y===this.normal&&v===this.normal&&(r=!0,p.length>0?t=f.tessellate(p,t):(void 0===t&&(t=[]),t.push(f)),m.length>0?t=g.tessellate(m,t):(void 0===t&&(t=[]),t.push(g))),h++}}}else h++;n++}return t},Polygon.prototype.intersectionWithSegment=function(e){if(void 0!==this.bRect){var t=e.getBoundaryRectangle(t);if(!this.bRect.intersectsWithRectangle(t))return!1}for(var i,o=this.point2dList.getPointsCount(),r=0;r<o;r++)if(i=this.point2dList.getSegment(r,i),!e.sharesPointsWithSegment(i)&&e.intersectionWithSegment(i,1e-7))return!0;return!1},Polygon.prototype.splitPolygon=function(e,t,i){void 0===i&&(i=[]);var o=new Polygon;o.point2dList=new Point2DList,o.point2dList.pointsArray=[],o.point2dList.pointsArray.push(this.point2dList.getPoint(e)),o.point2dList.pointsArray.push(this.point2dList.getPoint(t));for(var r=!1,n=t,a=e,s=0,l=this.point2dList.getPointsCount();!r&&s<l;){(h=this.point2dList.getNextIdx(n))===a?r=!0:(o.point2dList.pointsArray.push(this.point2dList.getPoint(h)),n=h),s++}i.push(o);var c=new Polygon;for(c.point2dList=new Point2DList,c.point2dList.pointsArray=[],c.point2dList.pointsArray.push(this.point2dList.getPoint(t)),c.point2dList.pointsArray.push(this.point2dList.getPoint(e)),r=!1,n=e,a=t,s=0;!r&&s<l;){var h;(h=this.point2dList.getNextIdx(n))===a?r=!0:(c.point2dList.pointsArray.push(this.point2dList.getPoint(h)),n=h),s++}return i.push(c),i},Polygon.prototype.getPointsIdxSortedByDistToPoint=function(e,t){return void 0===t&&(t=[]),t=this.point2dList.getPointsIdxSortedByDistToPoint(e,t)},Polygon.prototype.getTrianglesConvexPolygon=function(e){void 0===e&&(e=[]);var t,i=this.point2dList.getPointsCount();if(i<3)return e;for(var o=1;o<i-1;o++){t=new Triangle;var r=this.point2dList.getPoint(0).idxInList,n=this.point2dList.getPoint(o).idxInList,a=this.point2dList.getPoint(o+1).idxInList;t.vtxIdx0=r,t.vtxIdx1=n,t.vtxIdx2=a,e.push(t)}return e},Polygon.prototype.getVbo=function(e){void 0===e&&(e=new VBOVertexIdxCacheKey);var t,i,o=[],r=[];i=this.normal>0?1:-1;for(var n=this.point2dList.getPointsCount(),a=0;a<n;a++)t=this.point2dList.getPoint(a),o.push(t.x),o.push(t.y),o.push(0),r.push(0),r.push(0),r.push(255*i);e.posVboDataArray=Float32Array.from(o),e.norVboDataArray=Int8Array.from(r),this.point2dList.setIdxInList();var s=[],l=this.convexPolygonsArray.length;for(a=0;a<l;a++){s=this.convexPolygonsArray[a].getTrianglesConvexPolygon(s)}return TrianglesList.getVboFaceDataArray(s,e),e},Polygon.getVbo=function(e,t,i){void 0===i&&(i=new VBOVertexIdxCacheKey);var o,r,n=[],a=[];r=e.normal>0?1:-1;for(var s=e.point2dList.getPointsCount(),l=0;l<s;l++)o=e.point2dList.getPoint(l),n.push(o.x),n.push(o.y),n.push(0),a.push(0),a.push(0),a.push(255*r);i.posVboDataArray=Float32Array.from(n),i.norVboDataArray=Int8Array.from(a),e.point2dList.setIdxInList();var c=[],h=t.length;for(l=0;l<h;l++){c=t[l].getTrianglesConvexPolygon(c)}return TrianglesList.getVboFaceDataArray(c,i),i};var PolyLine=function(){if(!(this instanceof PolyLine))throw new Error(Messages.CONSTRUCT_ERROR);this.point2dArray};PolyLine.prototype.newPoint2d=function(e,t){void 0===this.point2dArray&&(this.point2dArray=[]);var i=new Point2D(e,t);return this.point2dArray.push(i),i},PolyLine.prototype.deleteObjects=function(){for(var e=this.point2dArray.length,t=0;t<e;t++)this.point2dArray[t].deleteObjects(),this.point2dArray[t]=void 0;this.point2dArray=void 0},PolyLine.prototype.getPoints=function(e){var t;void 0===e&&(e=[]);for(var i=e.length,o=this.point2dArray.length,r=0;r<o;r++)if(0===r)if(i>0){var n=e[i-1],a=this.point2dArray[r];n.isCoincidentToPoint(a,1e-7)||((t=new Point2D).copyFrom(this.point2dArray[r]),t.pointType=1,e.push(t))}else(t=new Point2D).copyFrom(this.point2dArray[r]),t.pointType=1,e.push(t);else(t=new Point2D).copyFrom(this.point2dArray[r]),t.pointType=1,e.push(t);return e};var Profile=function(){if(!(this instanceof Profile))throw new Error(Messages.CONSTRUCT_ERROR);this.outerRing,this.innerRingsList};Profile.prototype.newOuterRing=function(){return void 0===this.outerRing?this.outerRing=new Ring:this.outerRing.deleteObjects(),this.outerRing},Profile.prototype.newInnerRing=function(){return void 0===this.innerRingsList&&(this.innerRingsList=new RingsList),this.innerRingsList.newRing()},Profile.prototype.deleteObjects=function(){this.outerRing&&(this.outerRing.deleteObjects(),this.outerRing=void 0),this.innerRingsList&&(this.innerRingsList.deleteObjects(),this.innerRingsList=void 0)},Profile.prototype.hasHoles=function(){return void 0!==this.innerRingsList&&0!==this.innerRingsList.getRingsCount()},Profile.prototype.getVBO=function(e){if(void 0===this.outerRing)return e;this.getGeneralPolygon(void 0).getVbo(e)},Profile.prototype.getConvexFacesIndicesData=function(e){if(void 0===this.outerRing)return resultVbo;var t,i,o,r,n,a,s=this.getGeneralPolygon(void 0);if(void 0===e&&(e=[]),this.outerRing.polygon.point2dList.setIdxInList(),void 0!==this.innerRingsList)for(var l=this.innerRingsList.getRingsCount(),c=0;c<l;c++){this.innerRingsList.getRing(c).polygon.point2dList.setIdxInList()}var h=s.convexPolygonsArray.length;for(c=0;c<h;c++){t=[];for(var d=(i=s.convexPolygonsArray[c]).point2dList.getPointsCount(),u=0;u<d;u++)r=(o=(a=i.point2dList.getPoint(u)).indexData).owner,o.idxInList=a.idxInList,n=r===this.outerRing?-1:this.innerRingsList.getRingIdx(r),o.ownerIdx=n,t.push(o);e.push(t)}return e},Profile.prototype.getGeneralPolygon=function(e){if(this.checkNormals(),this.hasHoles())e=this.tessellateHoles(e);else{void 0===e&&(e=new Polygon),void 0===e.point2dList&&(e.point2dList=new Point2DList);for(var t=this.outerRing.polygon,i=t.point2dList.getPointsCount(),o=0;o<i;o++)t.point2dList.getPoint(o),e.point2dList.addPoint(t.point2dList.getPoint(o))}e.convexPolygonsArray=[];var r=e.calculateNormal(r);return e.convexPolygonsArray=e.tessellate(r,e.convexPolygonsArray),e},Profile.prototype.eliminateHolePolygonBySplitPoints=function(e,t,i,o,r){void 0===r&&(r=new Polygon),void 0===r.point2dList&&(r.point2dList=new Point2DList);for(var n,a=e.point2dList.getPointsCount(),s=!1,l=0,c=i;!s&&l<a;)n=e.point2dList.getPoint(c),r.point2dList.addPoint(n),(c=e.point2dList.getNextIdx(c))===i&&(s=!0,n=e.point2dList.getPoint(c),r.point2dList.addPoint(n)),l++;var h,d=t.point2dList.getPointsCount();for(s=!1,l=0,c=o;!s&&l<d;)h=t.point2dList.getPoint(c),r.point2dList.addPoint(h),(c=t.point2dList.getNextIdx(c))===o&&(s=!0,h=t.point2dList.getPoint(c),r.point2dList.addPoint(h)),l++;return r},Profile.prototype.eliminateHolePolygon=function(e,t,i,o){for(var r,n,a=[],s=t.polygon,l=s.point2dList.getPoint(i),c=(a=e.getPointsIdxSortedByDistToPoint(l,a)).length,h=new Segment2D,d=!1,u=0;!d&&u<c;)r=a[u],n=e.point2dList.getPoint(r),h.setPoints(n,l),e.intersectionWithSegment(h)||s.intersectionWithSegment(h)?u++:(o=this.eliminateHolePolygonBySplitPoints(e,s,r,i,o),d=!0,u++);return!!d},Profile.prototype.tessellateHoles=function(e){if(void 0===this.outerRing)return e;if(!this.hasHoles())return e;var t,i,o,r,n,a;void 0===e&&(e=new Polygon);var s=this.outerRing;void 0===s.polygon&&s.makePolygon();for(var l=s.polygon,c=l.calculateNormal(c),h=[],d=this.innerRingsList.getRingsCount(),u=0;u<d;u++)h.push(this.innerRingsList.getRing(u));var f=new Polygon,g=new Polygon;g.point2dList=new Point2DList;var p=l.point2dList.getPointsCount();for(u=0;u<p;u++)l.point2dList.getPoint(u),g.point2dList.addPoint(l.point2dList.getPoint(u));for(var m=new Point2D,y=[],v=(d=h.length,u=0,!1);!v&&u<d;){if(a=RingsList.getBoundingRectangle(h,a),m.set(a.minX,a.minY),y.length=0,t=(r=(y=RingsList.getSortedRingsByDistToPoint(m,h,y))[0]).ring,i=r.ringIdx,o=t.polygon,n=r.pointIdx,o.calculateNormal(),this.eliminateHolePolygon(g,t,n,f)){if(g=f,1==h.length){v=!0;break}h.splice(i,1),f=new Polygon}u++}return e=g},Profile.prototype.checkNormals=function(){if(void 0!==this.outerRing){var e=this.outerRing;void 0===e.polygon&&e.makePolygon();var t=e.polygon,i=t.calculateNormal(i),o=t.normal;if(void 0!==this.innerRingsList)for(var r,n=this.innerRingsList.getRingsCount(),a=0;a<n;a++){var s,l;void 0===(r=this.innerRingsList.getRing(a)).polygon&&r.makePolygon(),(s=r.polygon).calculateNormal(),(l=s.normal)===o&&(s.reverseSense(),s.normal=-l)}}},Profile.prototype.TEST__setFigure_1=function(){var e,t,i,o=this.newOuterRing();(e=o.newElement("POLYLINE")).newPoint2d(7,7),e.newPoint2d(0,7),e.newPoint2d(0,0),e.newPoint2d(7,0),(t=o.newElement("ARC")).setCenterPosition(7,3.5),t.setRadius(3.5),t.setStartAngleDegree(-90),t.setSweepAngleDegree(180),t.numPointsFor360Deg=24,(i=this.newInnerRing().newElement("RECTANGLE")).setCenterPosition(3,3),i.setDimensions(2,2)},Profile.prototype.TEST__setFigureHole_2=function(){var e,t,i,o,r,n=this.newOuterRing();(e=n.newElement("POLYLINE")).newPoint2d(-13,3),e.newPoint2d(-13,-11),(t=n.newElement("ARC")).setCenterPosition(-8,-11),t.setRadius(5),t.setStartAngleDegree(180),t.setSweepAngleDegree(90),t.numPointsFor360Deg=24,(e=n.newElement("POLYLINE")).newPoint2d(-8,-16),e.newPoint2d(-5,-16),e.newPoint2d(-3,-15),e.newPoint2d(-3,-14),e.newPoint2d(-5,-12),e.newPoint2d(-3,-11),e.newPoint2d(-2,-9),e.newPoint2d(3,-9),(t=n.newElement("ARC")).setCenterPosition(9,-9),t.setRadius(6),t.setStartAngleDegree(180),t.setSweepAngleDegree(180),t.numPointsFor360Deg=24,(e=n.newElement("POLYLINE")).newPoint2d(15,-9),e.newPoint2d(16,-9),e.newPoint2d(16,4),(t=n.newElement("ARC")).setCenterPosition(11,4),t.setRadius(5),t.setStartAngleDegree(0),t.setSweepAngleDegree(90),t.numPointsFor360Deg=24,(e=n.newElement("POLYLINE")).newPoint2d(11,9),e.newPoint2d(4,9),(t=n.newElement("ARC")).setCenterPosition(4,11),t.setRadius(2),t.setStartAngleDegree(-90),t.setSweepAngleDegree(-180),t.numPointsFor360Deg=24,(e=n.newElement("POLYLINE")).newPoint2d(4,13),e.newPoint2d(9,13),(t=n.newElement("ARC")).setCenterPosition(9,14.5),t.setRadius(1.5),t.setStartAngleDegree(-90),t.setSweepAngleDegree(180),t.numPointsFor360Deg=24,(e=n.newElement("POLYLINE")).newPoint2d(9,16),e.newPoint2d(2,16),e.newPoint2d(0,14),e.newPoint2d(-4,16),e.newPoint2d(-9,16),(t=n.newElement("ARC")).setCenterPosition(-9,14),t.setRadius(2),t.setStartAngleDegree(90),t.setSweepAngleDegree(180),t.numPointsFor360Deg=24,(e=n.newElement("POLYLINE")).newPoint2d(-9,12),e.newPoint2d(-6,12),(t=n.newElement("ARC")).setCenterPosition(-6,10.5),t.setRadius(1.5),t.setStartAngleDegree(90),t.setSweepAngleDegree(-180),t.numPointsFor360Deg=24,(e=n.newElement("POLYLINE")).newPoint2d(-6,9),e.newPoint2d(-7,9),(t=n.newElement("ARC")).setCenterPosition(-7,3),t.setRadius(6),t.setStartAngleDegree(90),t.setSweepAngleDegree(90),t.numPointsFor360Deg=24;var a=this.newInnerRing();(e=a.newElement("POLYLINE")).newPoint2d(-9,3),e.newPoint2d(-10,-4),e.newPoint2d(-10,-8),e.newPoint2d(-8,-11),e.newPoint2d(-3,-7),e.newPoint2d(4,-7),(t=a.newElement("ARC")).setCenterPosition(8,-7),t.setRadius(4),t.setStartAngleDegree(180),t.setSweepAngleDegree(180),t.numPointsFor360Deg=24,(e=a.newElement("POLYLINE")).newPoint2d(12,-7),e.newPoint2d(12,-4),e.newPoint2d(8,-10),e.newPoint2d(4,-5),e.newPoint2d(-8,-5),e.newPoint2d(-7,4),e.newPoint2d(9,4),e.newPoint2d(9,-5),e.newPoint2d(14,2),e.newPoint2d(13,2),e.newPoint2d(11,0),e.newPoint2d(11,7),e.newPoint2d(13,8),e.newPoint2d(5,8),e.newPoint2d(9,6),e.newPoint2d(-6,6),(t=a.newElement("ARC")).setCenterPosition(-6,3),t.setRadius(3),t.setStartAngleDegree(90),t.setSweepAngleDegree(90),t.numPointsFor360Deg=24,(i=(a=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(-10,-13),i.setRadius(1),(r=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(-6.5,-14),r.setRadiusCount(5),r.setInteriorRadius(.6),r.setExteriorRadius(2),(r=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(-9,14),r.setRadiusCount(6),r.setInteriorRadius(.5),r.setExteriorRadius(1.5),(o=(a=this.newInnerRing()).newElement("RECTANGLE")).setCenterPosition(-4.5,1.5),o.setDimensions(3,3),(i=(a=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(-4.5,-2.5),i.setRadius(2),(r=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(0,0),r.setRadiusCount(5),r.setInteriorRadius(1),r.setExteriorRadius(2.5),(i=(a=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(-6,14),i.setRadius(1.5),(r=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(-1.5,11),r.setRadiusCount(12),r.setInteriorRadius(.6),r.setExteriorRadius(2),(r=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(13.5,5),r.setRadiusCount(25),r.setInteriorRadius(.4),r.setExteriorRadius(1.5),(r=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(9,-13),r.setRadiusCount(10),r.setInteriorRadius(.4),r.setExteriorRadius(1.5),(r=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(5.5,1.5),r.setRadiusCount(7),r.setInteriorRadius(.7),r.setExteriorRadius(2)};var ProfilesList=function(){if(!(this instanceof ProfilesList))throw new Error(Messages.CONSTRUCT_ERROR);this.profilesArray,this.auxiliarAxis};ProfilesList.prototype.newProfile=function(){void 0===this.profilesArray&&(this.profilesArray=[]);var e=new Profile;return this.profilesArray.push(e),e},ProfilesList.prototype.deleteObjects=function(){if(this.profilesArray){for(var e=this.profilesArray.length,t=0;t<e;t++)this.profilesArray[t].deleteObjects(),this.profilesArray=void 0;this.profilesArray=void 0}};var Rectangle=function(){if(!(this instanceof Rectangle))throw new Error(Messages.CONSTRUCT_ERROR);this.centerPoint,this.width,this.height};Rectangle.prototype.setCenterPosition=function(e,t){void 0===this.centerPoint&&(this.centerPoint=new Point2D),this.centerPoint.set(e,t)},Rectangle.prototype.setDimensions=function(e,t){this.width=e,this.height=t},Rectangle.prototype.getPoints=function(e){if(void 0===this.centerPoint||void 0===this.width||void 0===this.height)return e;var t;void 0===e&&(e=[]);var i=this.width/2,o=this.height/2;return(t=new Point2D(this.centerPoint.x-i,this.centerPoint.y-o)).pointType=1,e.push(t),(t=new Point2D(this.centerPoint.x+i,this.centerPoint.y-o)).pointType=1,e.push(t),(t=new Point2D(this.centerPoint.x+i,this.centerPoint.y+o)).pointType=1,e.push(t),(t=new Point2D(this.centerPoint.x-i,this.centerPoint.y+o)).pointType=1,e.push(t),e};var Ring=function(){if(!(this instanceof Ring))throw new Error(Messages.CONSTRUCT_ERROR);this.elemsArray,this.polygon};Ring.prototype.deleteObjects=function(){if(void 0!==this.elemsArray){for(var e=this.elemsArray.length,t=0;t<e;t++)this.elemsArray[t].deleteObjects(),this.elemsArray[t]=void 0;this.elemsArray=void 0}void 0!==this.polygon&&this.polygon.deleteObjects(),this.polygon=void 0},Ring.prototype.newElement=function(e){var t;if("ARC"===e?t=new Arc:"CIRCLE"===e?t=new Circle:"POLYLINE"===e?t=new PolyLine:"RECTANGLE"===e?t=new Rectangle:"STAR"===e&&(t=new Star),void 0!==t)return void 0===this.elemsArray&&(this.elemsArray=[]),this.elemsArray.push(t),t},Ring.prototype.makePolygon=function(){return this.polygon=this.getPolygon(this.polygon),this.polygon},Ring.prototype.getPolygon=function(e){var t;void 0===e&&(e=new Polygon),void 0===e.point2dList&&(e.point2dList=new Point2DList),e.point2dList.deleteObjects(),e.point2dList.pointsArray=this.getPoints(e.point2dList.pointsArray);for(var i=e.point2dList.getPointsCount(),o=0;o<i;o++)(t=e.point2dList.getPoint(o)).indexData=new IndexData,t.indexData.owner=this;return e},Ring.prototype.getPoints=function(e){if(void 0===e&&(e=[]),void 0===this.elemsArray)return e;for(var t=this.elemsArray.length,i=0;i<t;i++)this.elemsArray[i].getPoints(e);var o=e.length;if(o>1){e[o-1].pointType=0;var r=e[0],n=e[o-1];r.isCoincidentToPoint(n,1e-7)&&((n=e.pop()).deleteObjects(),n=void 0)}return e};var RingsList=function(){if(!(this instanceof RingsList))throw new Error(Messages.CONSTRUCT_ERROR);this.ringsArray,this.idxInList};RingsList.prototype.newRing=function(){void 0===this.ringsArray&&(this.ringsArray=[]);var e=new Ring;return this.ringsArray.push(e),e},RingsList.prototype.deleteObjects=function(){if(this.ringsArray){for(var e=this.ringsArray.length,t=0;t<e;t++)this.ringsArray[t].deleteObjects(),this.ringsArray[t]=void 0;this.ringsArray=void 0}},RingsList.prototype.getRingsCount=function(){return void 0===this.ringsArray?0:this.ringsArray.length},RingsList.prototype.getRingIdx=function(e){if(void 0!==e){for(var t,i=this.getRingsCount(),o=!1,r=0;!o&&r<i;)this.getRing(r)===e&&(o=!0,t=r),r++;return t}},RingsList.prototype.getRing=function(e){if(void 0!==this.ringsArray)return this.ringsArray[e]},RingsList.getBoundingRectangle=function(e,t){var i,o;void 0===this.resultBRect&&(t=new BoundingRectangle);for(var r=e.length,n=0;n<r;n++)void 0===(i=e[n]).polygon&&i.makePolygon(),o=i.polygon.getBoundingRectangle(o),0===n?t.setInitByRectangle(o):t.addRectangle(o);return t},RingsList.prototype.setIdxInList=function(){for(var e=this.ringsArray.length,t=0;t<e;t++)this.ringsArray[t].idxInList=t},RingsList.prototype.intersectionWithSegment=function(e){if(void 0===e)return!1;for(var t=!1,i=this.getRingsCount(),o=0;!t&&o<i;)this.ringsArray[o].intersectionWithSegment(e)&&(t=!0),o++;return t},RingsList.getSortedRingsByDistToPoint=function(e,t,i){if(void 0===e)return i;void 0===i&&(i=[]);for(var o,r,n,a,s,l,c,h=[],d=t.length,u=0;u<d;u++)void 0===(o=t[u]).polygon&&o.makePolygon(),r=o.polygon.point2dList.getNearestPointIdxToPoint(e),n=o.polygon.point2dList.getPoint(r).squareDistToPoint(e),(a={}).ring=o,a.ringIdx=u,a.pointIdx=r,a.squaredDist=n,s=0,l=h.length-1,c=RingsList.getIndexToInsertBySquaredDist(h,a,s,l),h.splice(c,0,a);void 0===i&&(i=[]),i.length=0;var f=h.length;for(u=0;u<f;u++)i.push(h[u]);return i},RingsList.getIndexToInsertBySquaredDist=function(e,t,i,o){var r=o-i;if(0===e.length)return 0;if(r<6){for(var n,a=!1,s=i;!a&&s<=o;)t.squaredDist<e[s].squaredDist&&(n=s,a=!0),s++;return a?n:o+1}var l,c,h=i+Math.floor(r/2);return e[h].squaredDist>t.squaredDist?(l=i,c=h):(l=h,c=o),this.getIndexToInsertBySquaredDist(e,t,l,c)};var Segment2D=function(e,t){if(!(this instanceof Segment2D))throw new Error(Messages.CONSTRUCT_ERROR);this.startPoint2d,this.endPoint2d,e&&(this.startPoint2d=e),t&&(this.endPoint2d=t)};Segment2D.prototype.setPoints=function(e,t){e&&(this.startPoint2d=e),t&&(this.endPoint2d=t)},Segment2D.prototype.getVector=function(e){if(void 0!==this.startPoint2d&&void 0!==this.endPoint2d)return void 0===e&&(e=new Point2D),e=this.startPoint2d.getVectorToPoint(this.endPoint2d,e)},Segment2D.prototype.getDirection=function(e){return void 0===e&&(e=new Point2D),(e=this.getVector(e)).unitary(),e},Segment2D.prototype.getBoundaryRectangle=function(e){return void 0===e&&(e=new BoundaryRectangle),e.setInit(this.startPoint2d),e.addPoint(this.endPoint2d),e},Segment2D.prototype.getLine=function(e){void 0===e&&(e=new Line2D);var t=this.getDirection(),i=this.startPoint2d;return e.setPointAndDir(i.x,i.y,t.x,t.y),e},Segment2D.prototype.getSquaredLength=function(){return this.startPoint2d.squareDistToPoint(this.endPoint2d)},Segment2D.prototype.getLength=function(){return Math.sqrt(this.getSquaredLength())},Segment2D.prototype.intersectionWithPointByDistances=function(e,t){if(void 0!==e){void 0===t&&(t=1e-7);var i=this.startPoint2d.distToPoint(e),o=this.endPoint2d.distToPoint(e),r=this.getLength();return i<t?Constant.INTERSECTION_POINT_A:o<t?Constant.INTERSECTION_POINT_B:i>r||o>r?Constant.INTERSECTION_OUTSIDE:Math.abs(i+o-r)<t?Constant.INTERSECTION_INSIDE:void 0}},Segment2D.prototype.intersectionWithPoint=function(e,t){if(void 0!==e)return void 0===t&&(t=1e-7),this.getLine().isCoincidentPoint(e,t)?this.intersectionWithPointByDistances(e,t):Constant.INTERSECTION_OUTSIDE},Segment2D.prototype.intersectionWithSegment=function(e,t){if(void 0!==e){void 0===t&&(t=1e-7);var i=this.getLine(),o=e.getLine(),r=i.intersectionWithLine(o);if(void 0!==r)return this.intersectionWithPointByDistances(r)===Constant.INTERSECTION_OUTSIDE?Constant.INTERSECTION_OUTSIDE:e.intersectionWithPointByDistances(r)===Constant.INTERSECTION_OUTSIDE?Constant.INTERSECTION_OUTSIDE:Constant.INTERSECTION_INTERSECT}},Segment2D.prototype.hasPoint=function(e){return void 0!==e&&(e===this.startPoint2d||e===this.endPoint2d)},Segment2D.prototype.sharesPointsWithSegment=function(e){return void 0!==e&&!(!this.hasPoint(e.startPoint2d)&&!this.hasPoint(e.endPoint2d))};var Star=function(){if(!(this instanceof Star))throw new Error(Messages.CONSTRUCT_ERROR);this.centerPoint,this.interiorRadius,this.exteriorRadius,this.radiusCount};Star.prototype.setCenterPosition=function(e,t){void 0===this.centerPoint&&(this.centerPoint=new Point2D),this.centerPoint.set(e,t)},Star.prototype.setInteriorRadius=function(e){this.interiorRadius=e},Star.prototype.setExteriorRadius=function(e){this.exteriorRadius=e},Star.prototype.setRadiusCount=function(e){this.radiusCount=e},Star.prototype.getPoints=function(e){var t,i,o,r=360/this.radiusCount*Math.PI/180,n=r/2,a=90*Math.PI/180;void 0===e&&(e=[]);for(var s=0;s<this.radiusCount;s++)i=this.centerPoint.x+this.exteriorRadius*Math.cos(a),o=this.centerPoint.y+this.exteriorRadius*Math.sin(a),(t=new Point2D(i,o)).pointType=1,e.push(t),i=this.centerPoint.x+this.interiorRadius*Math.cos(a+n),o=this.centerPoint.y+this.interiorRadius*Math.sin(a+n),(t=new Point2D(i,o)).pointType=1,e.push(t),a+=r;return e};var Surface=function(){if(!(this instanceof Surface))throw new Error(Messages.CONSTRUCT_ERROR);this.facesArray,this.localVertexList};Surface.prototype.newFace=function(){void 0===this.facesArray&&(this.facesArray=[]);var e=new Face;return this.facesArray.push(e),e},Surface.prototype.getFacesCount=function(){return void 0===this.facesArray?0:this.facesArray.length},Surface.prototype.getFace=function(e){if(void 0!==this.facesArray)return this.facesArray[e]},Surface.prototype.setColor=function(e,t,i,o){for(var r=this.getFacesCount(),n=0;n<r;n++)this.getFace(n).setColor(e,t,i,o)},Surface.prototype.addFacesArray=function(e){void 0!==e&&(void 0===this.facesArray&&(this.facesArray=[]),Array.prototype.push.apply(this.facesArray,e))},Surface.prototype.getFrontierHalfEdges=function(e){if(void 0===this.facesArray)return e;void 0===e&&(e=[]);for(var t=this.getFacesCount(),i=0;i<t;i++)e=this.getFace(i).getFrontierHalfEdges(e);return e},Surface.prototype.getHalfEdges=function(e){if(void 0===this.facesArray)return e;void 0===e&&(e=[]);for(var t=this.getFacesCount(),i=0;i<t;i++)e=this.getFace(i).getHalfEdgesLoop(e);return e},Surface.prototype.getCopyIndependentSurface=function(e){if(void 0===this.facesArray)return e;void 0===e&&(e=new Surface),void 0===e.localVertexList&&(e.localVertexList=new VertexList);for(var t,i,o,r,n=e.localVertexList,a=this.getNoRepeatedVerticesArray(void 0),s=a.length,l=0;l<s;l++)(t=a[l]).setIdxInList(l),n.newVertex().copyFrom(t);var c=this.getFacesCount();for(l=0;l<c;l++){i=this.getFace(l),(o=e.newFace()).vertexArray=[],s=i.getVerticesCount();for(var h=0;h<s;h++)r=(t=i.getVertex(h)).getIdxInList(),o.vertexArray.push(n.getVertex(r));o.createHalfEdges([])}return e.setTwinsFaces(),e},Surface.prototype.setTwinsFaces=function(){for(var e,t,i=this.facesArray.length,o=0;o<i;o++){e=this.getFace(o);for(var r=0;r<i;r++)o!==r&&(t=this.getFace(r),e.setTwinFace(t))}},Surface.prototype.getNoRepeatedVerticesArray=function(e){void 0===e&&(e=[]);for(var t,i,o,r=this.getFacesCount(),n=0,a=0;a<r;a++){o=(t=this.getFace(a)).getVerticesCount();for(var s=0;s<o;s++){if(void 0===(i=t.getVertex(s)));i.setIdxInList(n),n++}}var l,c={};for(a=0;a<r;a++){o=(t=this.getFace(a)).getVerticesCount();for(s=0;s<o;s++)c[(i=t.getVertex(s)).getIdxInList().toString()]=i}for(var h in c)l=c[h],e.push(l);return e},Surface.prototype.getTrianglesConvex=function(e){if(void 0===this.facesArray||0===this.facesArray.length)return e;void 0===e&&(e=[]);for(var t=this.getFacesCount(),i=0;i<t;i++)e=this.getFace(i).getTrianglesConvex(e);return e},Surface.prototype.calculateVerticesNormals=function(){for(var e=this.getFacesCount(),t=0;t<e;t++)this.getFace(t).calculateVerticesNormals()},Surface.prototype.reverseSense=function(){for(var e=this.getFacesCount(),t=0;t<e;t++)this.getFace(t).reverseSense()};var Tessellator=function(){if(!(this instanceof Tessellator))throw new Error(Messages.CONSTRUCT_ERROR)},Triangle=function(e,t,i){if(!(this instanceof Triangle))throw new Error(Messages.CONSTRUCT_ERROR);this.vertex0,this.vertex1,this.vertex2,this.vtxIdx0,this.vtxIdx1,this.vtxIdx2,this.normal,void 0!==e&&(this.vertex0=e),void 0!==t&&(this.vertex1=t),void 0!==i&&(this.vertex2=i),this.hEdge};Triangle.prototype.deleteObjects=function(){this.vertex0&&(this.vertex0=void 0),this.vertex1&&(this.vertex1=void 0),this.vertex2&&(this.vertex2=void 0),this.normal&&(this.normal.deleteObjects(),this.normal=void 0),this.vtxIdx0=void 0,this.vtxIdx1=void 0,this.vtxIdx2=void 0},Triangle.prototype.setVertices=function(e,t,i){this.vertex0=e,this.vertex1=t,this.vertex2=i},Triangle.prototype.assignVerticesIdx=function(){void 0!==this.vertex0&&void 0!==this.vertex1&&void 0!==this.vertex2&&(this.vtxIdx0=this.vertex0.getIdxInList(),this.vtxIdx1=this.vertex1.getIdxInList(),this.vtxIdx2=this.vertex2.getIdxInList())},Triangle.prototype.getIndicesArray=function(e){return void 0===e&&(e=[]),void 0!==this.vtxIdx0&&void 0!==this.vtxIdx1&&void 0!==this.vtxIdx2&&(e.push(this.vtxIdx0),e.push(this.vtxIdx1),e.push(this.vtxIdx2)),e},Triangle.prototype.invertSense=function(){var e=this.vertex1;this.vertex1=this.vertex2,this.vertex2=e,this.calculatePlaneNormal()},Triangle.prototype.calculatePlaneNormal=function(){void 0===this.normal&&(this.normal=new Point3D),this.getCrossProduct(0,this.normal),this.normal.unitary()},Triangle.prototype.getCrossProduct=function(e,t){var i,o,r;void 0===t&&(t=new Point3D),0===e?(i=this.vertex0.point3d,o=this.vertex2.point3d,r=this.vertex1.point3d):1===e?(i=this.vertex1.point3d,o=this.vertex0.point3d,r=this.vertex2.point3d):2===e&&(i=this.vertex2.point3d,o=this.vertex1.point3d,r=this.vertex0.point3d);var n=new Point3D,a=new Point3D;return n.set(i.x-o.x,i.y-o.y,i.z-o.z),a.set(r.x-i.x,r.y-i.y,r.z-i.z),n.unitary(),a.unitary(),t=n.crossProduct(a,t)};var TrianglesList=function(){if(!(this instanceof TrianglesList))throw new Error(Messages.CONSTRUCT_ERROR);this.trianglesArray};TrianglesList.prototype.newTriangle=function(e,t,i){void 0===this.trianglesArray&&(this.trianglesArray=[]);var o=new Triangle(e,t,i);return this.trianglesArray.push(o),o},TrianglesList.prototype.addTriangle=function(e){void 0===this.trianglesArray&&(this.trianglesArray=[]),this.trianglesArray.push(e)},TrianglesList.prototype.deleteObjects=function(){if(void 0!==this.trianglesArray){for(var e=this.getTrianglesCount(),t=0;t<e;t++)this.trianglesArray[t].deleteObjects(),this.trianglesArray[t]=void 0;this.trianglesArray=void 0}},TrianglesList.prototype.getTrianglesCount=function(){return void 0===this.trianglesArray?0:this.trianglesArray.length},TrianglesList.prototype.getTriangle=function(e){if(void 0!==this.trianglesArray)return this.trianglesArray[e]},TrianglesList.prototype.assignVerticesIdx=function(){void 0!==this.trianglesArray&&TrianglesList.assignVerticesIdx(this.trianglesArray)},TrianglesList.assignVerticesIdx=function(e){if(void 0!==e)for(var t=e.length,i=(e=e,0);i<t;i++)e[i].assignVerticesIdx()},TrianglesList.getTrianglesIndicesArray=function(e,t){void 0===t&&(t=[]);for(var i=e.length,o=0;o<i;o++)e[o].getIndicesArray(t);return t},TrianglesList.prototype.getNoRepeatedVerticesArray=function(e){return e=TrianglesList.getNoRepeatedVerticesArray(this.trianglesArray,e)},TrianglesList.getNoRepeatedVerticesArray=function(e,t){void 0===t&&(t=[]);for(var i,o,r,n,a=e.length,s=0,l=0;l<a;l++)o=(i=e[l]).vertex0,r=i.vertex1,n=i.vertex2,o.setIdxInList(s),s++,r.setIdxInList(s),s++,n.setIdxInList(s),s++;var c,h={};for(l=0;l<a;l++)o=(i=e[l]).vertex0,r=i.vertex1,n=i.vertex2,h[o.getIdxInList().toString()]=o,h[r.getIdxInList().toString()]=r,h[n.getIdxInList().toString()]=n;for(var d in h)c=h[d],t.push(c);return t},TrianglesList.getVboFaceDataArray=function(e,t){if(void 0===e)return t;if(0===e.length)return t;void 0===t&&(t=new VBOVertexIdxCacheKey);var i=TrianglesList.getTrianglesIndicesArray(e,void 0);return t.idxVboDataArray=Int16Array.from(i),t.indicesCount=t.idxVboDataArray.length,t};var TrianglesMatrix=function(){if(!(this instanceof TrianglesMatrix))throw new Error(Messages.CONSTRUCT_ERROR);this.trianglesListsArray};TrianglesMatrix.prototype.deleteObjects=function(){if(void 0!==this.trianglesListsArray){for(var e=this.trianglesListsArray.length,t=0;t<e;t++)this.trianglesListsArray[t].deleteObjects(),this.trianglesListsArray[t]=void 0;this.trianglesListsArray=void 0}},TrianglesMatrix.prototype.getTrianglesList=function(e){if(void 0!==this.trianglesListsArray)return this.trianglesListsArray[e]},TrianglesMatrix.prototype.getTrianglesListsCount=function(){return void 0===this.trianglesListsArray?0:this.trianglesListsArray.length},TrianglesMatrix.prototype.newTrianglesList=function(){void 0===this.trianglesListsArray&&(this.trianglesListsArray=[]);var e=new TrianglesList;return this.trianglesListsArray.push(e),e},TrianglesMatrix.prototype.assignVerticesIdx=function(){for(var e=this.trianglesListsArray.length,t=0;t<e;t++)this.trianglesListsArray[t].assignVerticesIdx()},TrianglesMatrix.prototype.getVboFaceDataArray=function(e){if(void 0===this.trianglesListsArray)return e;for(var t=[],i=this.trianglesListsArray.length,o=0;o<i;o++)t=this.trianglesListsArray[o].getTrianglesIndicesArray(t);return e.idxVboDataArray=Int16Array.from(t),e.indicesCount=e.idxVboDataArray.length,e};var Vertex=function(e){if(!(this instanceof Vertex))throw new Error(Messages.CONSTRUCT_ERROR);this.point3d,this.normal,this.texCoord,this.color4,this.outingHedge,this.vertexType,this.idxInList,this.point3d=e||new Point3D};Vertex.prototype.deleteObjects=function(){this.point3d&&this.point3d.deleteObjects(),this.normal&&this.normal.deleteObjects(),this.texCoord&&this.texCoord.deleteObjects(),this.color4&&this.color4.deleteObjects(),this.point3d=void 0,this.normal=void 0,this.texCoord=void 0,this.color4=void 0},Vertex.prototype.getIdxInList=function(){return this.idxInList},Vertex.prototype.setIdxInList=function(e){this.idxInList=e},Vertex.prototype.copyFrom=function(e){e.point3d&&(void 0===this.point3d&&(this.point3d=new Point3D),this.point3d.copyFrom(e.point3d)),e.normal&&(void 0===this.normal&&(this.normal=new Point3D),this.normal.copyFrom(e.normal)),e.texCoord&&(void 0===this.texCoord&&(this.texCoord=new Point2D),this.texCoord.copyFrom(e.texCoord)),e.color4&&(void 0===this.color4&&(this.color4=new Color),this.color4.copyFrom(e.color4)),this.vertexType=e.vertexType},Vertex.prototype.setPosition=function(e,t,i){this.point3d.set(e,t,i)},Vertex.prototype.setColorRGB=function(e,t,i){void 0===this.color4&&(this.color4=new Color),this.color4.setRGB(e,t,i)},Vertex.prototype.setColorRGBA=function(e,t,i,o){void 0===this.color4&&(this.color4=new Color),this.color4.setRGBA(e,t,i,o)},Vertex.prototype.setNormal=function(e,t,i){void 0===this.normal&&(this.normal=new Point3D),this.normal.set(e,t,i)},Vertex.prototype.translate=function(e,t,i){this.point3d.add(e,t,i)};var VertexList=function(){if(!(this instanceof VertexList))throw new Error(Messages.CONSTRUCT_ERROR);this.vertexArray=[]};VertexList.getPrevIdx=function(e,t){var i=t.length;if(!(e<0||e>i-1))return 0===e?i-1:e-1},VertexList.getNextIdx=function(e,t){var i=t.length;if(!(e<0||e>i-1))return e===i-1?0:e+1},VertexList.getVtxSegment=function(e,t,i){var o=t[e],r=t[VertexList.getNextIdx(e,t)];return void 0===i?i=new VtxSegment(o,r):i.setVertices(o,r),i},VertexList.getVector=function(e,t,i){var o=t[e],r=t[VertexList.getNextIdx(e,t)],n=o.point3d,a=r.point3d;return void 0===i?i=new Point3D(a.x-n.x,a.y-n.y,a.z-n.z):i.setVertices(a.x-n.x,a.y-n.y,a.z-n.z),i},VertexList.getCrossProduct=function(e,t,i){var o=VertexList.getVector(e,t,void 0),r=VertexList.getPrevIdx(e,t);return i=VertexList.getVector(r,t,void 0).crossProduct(o,i)},VertexList.prototype.deleteObjects=function(){for(var e=0,t=this.vertexArray.length;e<t;e++)this.vertexArray[e].deleteObjects(),this.vertexArray[e]=void 0;this.vertexArray=void 0},VertexList.prototype.copyFrom=function(e){var t;this.deleteObjects(),this.vertexArray=[];for(var i=e.getVertexCount(),o=0;o<i;o++)t=e.getVertex(o),this.newVertex().copyFrom(t)},VertexList.prototype.copyFromPoint2DList=function(e,t){var i,o;this.deleteObjects(),this.vertexArray=[],void 0===t&&(t=0);for(var r=e.getPointsCount(),n=0;n<r;n++)i=e.getPoint(n),(o=this.newVertex()).point3d=new Point3D,o.point3d.set(i.x,i.y,t),o.vertexType=i.pointType},VertexList.prototype.setNormal=function(e,t,i){for(var o=this.getVertexCount(),r=0;r<o;r++)this.getVertex(r).setNormal(e,t,i)},VertexList.prototype.newVertex=function(){var e=new Vertex;return this.vertexArray.push(e),e},VertexList.prototype.getVertex=function(e){return this.vertexArray[e]},VertexList.prototype.getVertexCount=function(){return this.vertexArray.length},VertexList.prototype.getPrevIdx=function(e){return VertexList.getPrevIdx(e,this.vertexArray)},VertexList.prototype.getNextIdx=function(e){return VertexList.getNextIdx(e,this.vertexArray)},VertexList.prototype.getIdxOfVertex=function(e){for(var t=this.vertexArray.length,i=0,o=-1,r=!1;!r&&i<t;)this.vertexArray[i]===e&&(r=!0,o=i),i++;return o},VertexList.prototype.getVtxSegment=function(e,t){return VertexList.getVtxSegment(e,this.vertexArray,t)},VertexList.prototype.translateVertices=function(e,t,i){for(var o=0,r=this.vertexArray.length;o<r;o++)this.vertexArray[o].translate(e,t,i)},VertexList.prototype.getBoundingBox=function(e){void 0===e&&(e=new BoundingBox);for(var t=0,i=this.vertexArray.length;t<i;t++)0===t?e.init(this.vertexArray[t].point3d):e.addPoint(this.vertexArray[t].point3d);return e},VertexList.prototype.transformPointsByMatrix4=function(e){for(var t=0,i=this.vertexArray.length;t<i;t++){var o=this.vertexArray[t];e.transformPoint3D(o.point3d,o.point3d)}},VertexList.prototype.setIdxInList=function(){VertexList.setIdxInList(this.vertexArray)},VertexList.setIdxInList=function(e){if(void 0!==e)for(var t=0,i=e.length;t<i;t++)e[t].idxInList=t},VertexList.prototype.getVboDataArrays=function(e){return VertexList.getVboDataArrays(this.vertexArray,e),e},VertexList.getVboDataArrays=function(e,t){var i=e.length;if(0===i)return t;void 0===t&&(t=new VBOVertexIdxCacheKey);for(var o,r,n,a,s,l,c,h,d=[],u=0;u<i;u++)void 0!==(a=e[u]).point3d&&(s=a.point3d,d.push(s.x),d.push(s.y),d.push(s.z),(l=a.normal)&&(void 0===o&&(o=[]),o.push(127*l.x),o.push(127*l.y),o.push(127*l.z)),(c=a.color4)&&(void 0===r&&(r=[]),r.push(255*c.r),r.push(255*c.g),r.push(255*c.b),r.push(255*c.a)),(h=a.texCoord)&&(void 0===n&&(n=[]),n.push(h.x),n.push(h.y)));return t.posVboDataArray=Float32Array.from(d),l&&(t.norVboDataArray=Int8Array.from(o)),c&&(t.colVboDataArray=Uint8Array.from(r)),h&&(t.tcoordVboDataArray=Float32Array.from(n)),t};var VertexMatrix=function(){if(!(this instanceof VertexMatrix))throw new Error(Messages.CONSTRUCT_ERROR);this.vertexListsArray=[],this.totalVertexArraySC=[]};VertexMatrix.prototype.deleteObjects=function(){for(var e=0,t=this.vertexListsArray.length;e<t;e++)this.vertexListsArray[e].deleteObjects(),this.vertexListsArray[e]=void 0;this.vertexListsArray=void 0},VertexMatrix.prototype.newVertexList=function(){var e=new VertexList;return this.vertexListsArray.push(e),e},VertexMatrix.prototype.getVertexList=function(e){return e>=0&&e<this.vertexListsArray.length?this.vertexListsArray[e]:void 0},VertexMatrix.prototype.copyFrom=function(e){if(void 0!==e)for(var t,i=e.vertexListsArray.length,o=0;o<i;o++)t=e.getVertexList(o),this.newVertexList().copyFrom(t)},VertexMatrix.prototype.getBoundingBox=function(e){void 0===e&&(e=new BoundingBox),this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);for(var t=0,i=this.totalVertexArraySC.length;t<i;t++)0===t?e.init(this.totalVertexArraySC[t].point3d):e.addPoint(this.totalVertexArraySC[t].point3d);return e},VertexMatrix.prototype.setVertexIdxInList=function(){for(var e=0,t=0,i=this.vertexListsArray.length;t<i;t++)for(var o=this.vertexListsArray[t],r=0,n=o.vertexArray.length;r<n;r++){o.getVertex(r).mIdxInList=e,e++}},VertexMatrix.prototype.getVertexCount=function(){for(var e=0,t=0,i=this.vertexListsArray.length;t<i;t++)e+=this.vertexListsArray[t].getVertexCount();return e},VertexMatrix.prototype.getTotalVertexArray=function(e){for(var t=0,i=this.vertexListsArray.length;t<i;t++)for(var o=this.vertexListsArray[t],r=0,n=o.vertexArray.length;r<n;r++){var a=o.getVertex(r);e.push(a)}return e},VertexMatrix.prototype.getVBOVertexColorFloatArray=function(e){this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);var t=this.totalVertexArraySC.length;void 0===e&&(e=new Float32Array(6*t));for(var i=0;i<t;i++){var o=this.totalVertexArraySC[i];e[6*i]=o.point3d.x,e[6*i+1]=o.point3d.y,e[6*i+2]=o.point3d.z,e[6*i+3]=o.color4.r,e[6*i+4]=o.color4.g,e[6*i+5]=o.color4.b}return e},VertexMatrix.prototype.getVBOVertexColorRGBAFloatArray=function(e){this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);var t=this.totalVertexArraySC.length;void 0===e&&(e=new Float32Array(7*t));for(var i=0;i<t;i++){var o=this.totalVertexArraySC[i];e[7*i]=o.point3d.x,e[7*i+1]=o.point3d.y,e[7*i+2]=o.point3d.z,e[7*i+3]=o.color4.r,e[7*i+4]=o.color4.g,e[7*i+5]=o.color4.b,e[7*i+6]=o.color4.a}return e},VertexMatrix.prototype.getVBOVertexFloatArray=function(e){this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);var t=this.totalVertexArraySC.length;void 0===e&&(e=new Float32Array(3*t));for(var i=0;i<t;i++){var o=this.totalVertexArraySC[i];e[3*i]=o.point3d.x,e[3*i+1]=o.point3d.y,e[3*i+2]=o.point3d.z}return e},VertexMatrix.prototype.translateVertices=function(e,t,i){for(var o=0,r=this.vertexListsArray.length;o<r;o++)this.vertexListsArray[o].translateVertices(e,t,i)},VertexMatrix.prototype.makeTTrianglesLateralSidesLOOP=function(e){for(var t,i,o,r,n,a=0,s=0,l=this.vertexListsArray.length;s<l-1;s++){t=this.vertexListsArray[s],i=this.vertexListsArray[s+1],o=e.newTTrianglesList(),a=t.vertexArray.length;for(var c=0;c<a;c++)r=o.newTTriangle(),n=o.newTTriangle(),c===a-1?(r.setVertices(t.getVertex(c),i.getVertex(c),i.getVertex(0)),n.setVertices(t.getVertex(c),i.getVertex(0),t.getVertex(0))):(r.setVertices(t.getVertex(c),i.getVertex(c),i.getVertex(c+1)),n.setVertices(t.getVertex(c),i.getVertex(c+1),t.getVertex(c+1)))}},VertexMatrix.prototype.transformPointsByMatrix4=function(e){for(var t=0,i=this.vertexListsArray.length;t<i;t++){this.vertexListsArray[t].transformPointsByMatrix4(e)}};var VtxProfile=function(e,t){if(!(this instanceof VtxProfile))throw new Error(Messages.CONSTRUCT_ERROR);this.outerVtxRing,this.innerVtxRingsList};VtxProfile.prototype.getInnerVtxRingsCount=function(){return void 0===this.innerVtxRingsList||0===this.innerVtxRingsList.getRingsCount?0:this.innerVtxRingsList.getVtxRingsCount()},VtxProfile.prototype.getInnerVtxRing=function(e){if(void 0!==this.innerVtxRingsList&&0!==this.innerVtxRingsList.getRingsCount)return this.innerVtxRingsList.getVtxRing(e)},VtxProfile.prototype.setVerticesIdxInList=function(){this.outerVtxRing&&this.outerVtxRing.vertexList&&this.outerVtxRing.vertexList.setIdxInList(),this.innerVtxRingsList&&this.innerVtxRingsList.setVerticesIdxInList()},VtxProfile.prototype.copyFrom=function(e){e.outerVtxRing&&(void 0===this.outerVtxRing&&(this.outerVtxRing=new VtxRing),this.outerVtxRing.copyFrom(e.outerVtxRing)),e.innerVtxRingsList&&(void 0===this.innerVtxRingsList&&(this.innerVtxRingsList=new VtxRingsList),this.innerVtxRingsList.copyFrom(e.innerVtxRingsList))},VtxProfile.prototype.translate=function(e,t,i){void 0!==this.outerVtxRing&&this.outerVtxRing.translate(e,t,i),void 0!==this.innerVtxRingsList&&this.innerVtxRingsList.translate(e,t,i)},VtxProfile.prototype.transformPointsByMatrix4=function(e){void 0!==this.outerVtxRing&&this.outerVtxRing.transformPointsByMatrix4(e),void 0!==this.innerVtxRingsList&&this.innerVtxRingsList.transformPointsByMatrix4(e)},VtxProfile.prototype.makeByProfile=function(e){if(void 0!==e&&void 0!==e.outerRing){var t=e.outerRing;void 0===t.polygon&&t.makePolygon(),void 0===this.outerVtxRing&&(this.outerVtxRing=new VtxRing);var i=t.polygon.point2dList;if(this.outerVtxRing.makeByPoint2DList(i,0),void 0!==e.innerRingsList){var o=e.innerRingsList,r=o.getRingsCount();if(0!==r){var n;void 0===this.innerVtxRingsList&&(this.innerVtxRingsList=new VtxRingsList);for(var a=0;a<r;a++)void 0===(n=o.getRing(a)).polygon&&n.makePolygon(),i=n.polygon.point2dList,this.innerVtxRingsList.newVtxRing().makeByPoint2DList(i,0)}}}},VtxProfile.prototype.getAllVertices=function(e){return void 0!==this.outerVtxRing&&this.outerVtxRing.getAllVertices(e),void 0!==this.innerVtxRingsList&&this.innerVtxRingsList.getAllVertices(e),e};var VtxProfilesList=function(e,t){if(!(this instanceof VtxProfilesList))throw new Error(Messages.CONSTRUCT_ERROR);this.vtxProfilesArray,this.convexFacesIndicesData};VtxProfilesList.getLateralFaces=function(e,t,i,o,r){void 0===i&&(i=[]),void 0===o.hedgesList&&(o.hedgesList=new HalfEdgesList);var n,a,s,l,c,h,d,u,f=o.hedgesList,g=[];for(n=r.strIdx;n!==r.endIdx;)a=e.vertexList.getNextIdx(n),d=new Face,i.push(d),d.vertexArray=[],s=e.vertexList.getVertex(n),l=e.vertexList.getVertex(a),c=t.vertexList.getVertex(a),h=t.vertexList.getVertex(n),Array.prototype.push.apply(d.vertexArray,[s,l,c,h]),g.length=0,g=d.createHalfEdges(g),f.addHalfEdgesArray(g),void 0!==u&&d.setTwinFace(u),u=d,n=a;return i},VtxProfilesList.prototype.newVtxProfile=function(){void 0===this.vtxProfilesArray&&(this.vtxProfilesArray=[]);var e=new VtxProfile;return this.vtxProfilesArray.push(e),e},VtxProfilesList.prototype.getVtxProfilesCount=function(){return void 0===this.vtxProfilesArray?0:this.vtxProfilesArray.length},VtxProfilesList.prototype.getVtxProfile=function(e){if(void 0!==this.vtxProfilesArray)return this.vtxProfilesArray[e]},VtxProfilesList.prototype.getAllVertices=function(e){void 0===e&&(e=[]);for(var t=this.getVtxProfilesCount(),i=0;i<t;i++)e=this.getVtxProfile(i).getAllVertices(e);return e},VtxProfilesList.prototype.getMesh=function(e,t,i){if(void 0===this.vtxProfilesArray)return resultTriangleMatrix;var o,r,n=this.getVtxProfilesCount();if(n<2)return resultTriangleMatrix;void 0===e&&(e=new Mesh),void 0===e.vertexList&&(e.vertexList=new VertexList),e.vertexList.vertexArray=this.getAllVertices(e.vertexList.vertexArray);for(var a,s,l,c,h,d,u=(o=this.getVtxProfile(0)).outerVtxRing,f=[],g=u.elemsIndexRangesArray.length,p=0;p<g;p++){c=e.newSurface(),h=void 0,a=u.getElementIndexRange(p);for(var m=0;m<n-1;m++){if(o=this.getVtxProfile(m),r=this.getVtxProfile(m+1),s=o.outerVtxRing,l=r.outerVtxRing,f.length=0,f=VtxProfilesList.getLateralFaces(s,l,f,e,a),c.addFacesArray(f),void 0!==h&&h.length>0)for(var y=f.length,v=0;v<y;v++)C=f[v],M=h[v],C.setTwinFace(M);h=[],Array.prototype.push.apply(h,f)}}var x,b=o.getInnerVtxRingsCount();for(v=0;v<b;v++){g=(d=o.getInnerVtxRing(v)).elemsIndexRangesArray.length;for(p=0;p<g;p++){c=e.newSurface(),h=void 0,a=d.getElementIndexRange(p);for(m=0;m<n-1;m++){if(o=this.getVtxProfile(m),r=this.getVtxProfile(m+1),s=o.getInnerVtxRing(v),l=r.getInnerVtxRing(v),f.length=0,f=VtxProfilesList.getLateralFaces(s,l,f,e,a),c.addFacesArray(f),void 0!==h&&h.length>0){y=f.length;for(var C,M,_=0;_<y;_++)C=f[_],M=h[_],C.setTwinFace(M)}h=[],Array.prototype.push.apply(h,f)}}}return void 0===this.convexFacesIndicesData?e:(void 0!==i&&!0!==i||(r=this.getVtxProfile(n-1),x=e.newSurface(),x=VtxProfilesList.getTransversalSurface(r,this.convexFacesIndicesData,x)),void 0!==t&&!0!==t||(o=this.getVtxProfile(0),x=e.newSurface(),(x=VtxProfilesList.getTransversalSurface(o,this.convexFacesIndicesData,x)).reverseSense()),e)},VtxProfilesList.getTransversalSurface=function(e,t,i){var o,r,n,a,s,l,c;void 0===i&&(i=new Surface);for(var h=t.length,d=0;d<h;d++){(l=i.newFace()).vertexArray=[],s=(o=t[d]).length;for(var u=0;u<s;u++)n=(r=o[u]).ownerIdx,a=r.idxInList,c=(-1===n?e.outerVtxRing:e.innerVtxRingsList.getVtxRing(n)).vertexList.getVertex(a),l.vertexArray.push(c)}return i};var VtxRing=function(){if(!(this instanceof VtxRing))throw new Error(Messages.CONSTRUCT_ERROR);this.vertexList,this.elemsIndexRangesArray};VtxRing.prototype.newElementIndexRange=function(){void 0===this.elemsIndexRangesArray&&(this.elemsIndexRangesArray=[]);var e=new IndexRange;return this.elemsIndexRangesArray.push(e),e},VtxRing.prototype.getElementIndexRange=function(e){if(void 0!==this.elemsIndexRangesArray)return this.elemsIndexRangesArray[e]},VtxRing.prototype.getAllVertices=function(e){return void 0===this.vertexList||void 0===this.vertexList.vertexArray?e:(void 0===e&&(e=[]),e.push.apply(e,this.vertexList.vertexArray),e)},VtxRing.prototype.copyFrom=function(e){if(void 0!==e.vertexList&&(void 0===this.vertexList&&(this.vertexList=new VertexList),this.vertexList.copyFrom(e.vertexList)),void 0!==e.elemsIndexRangesArray){var t;void 0===this.elemsIndexRangesArray&&(this.elemsIndexRangesArray=[]);for(var i=e.elemsIndexRangesArray.length,o=0;o<i;o++)t=e.elemsIndexRangesArray[o],this.newElementIndexRange().copyFrom(t)}},VtxRing.prototype.translate=function(e,t,i){void 0!==this.vertexList&&this.vertexList.translateVertices(e,t,i)},VtxRing.prototype.transformPointsByMatrix4=function(e){void 0!==this.vertexList&&this.vertexList.transformPointsByMatrix4(e)},VtxRing.prototype.makeByPoint2DList=function(e,t){void 0!==e&&(void 0===t&&(t=0),void 0===this.vertexList&&(this.vertexList=new VertexList),this.vertexList.copyFromPoint2DList(e,t),this.calculateElementsIndicesRange())},VtxRing.prototype.calculateElementsIndicesRange=function(){if(void 0===this.vertexList)return!1;for(var e,t=void 0,i=this.vertexList.getVertexCount(),o=0;o<i;o++)(e=this.vertexList.getVertex(o).vertexType)&&1===e&&(void 0!==t&&(t.endIdx=o),o!==i&&((t=this.newElementIndexRange()).strIdx=o));void 0!==t&&(t.endIdx=0)};var VtxRingsList=function(){if(!(this instanceof VtxRingsList))throw new Error(Messages.CONSTRUCT_ERROR);this.vtxRingsArray};VtxRingsList.prototype.getVtxRingsCount=function(){return void 0===this.vtxRingsArray?0:this.vtxRingsArray.length},VtxRingsList.prototype.getVtxRing=function(e){if(void 0!==this.vtxRingsArray)return this.vtxRingsArray[e]},VtxRingsList.prototype.newVtxRing=function(){void 0===this.vtxRingsArray&&(this.vtxRingsArray=[]);var e=new VtxRing;return this.vtxRingsArray.push(e),e},VtxRingsList.prototype.copyFrom=function(e){if(void 0!==e){void 0===this.vtxRingsArray&&(this.vtxRingsArray=[]);for(var t=e.getVtxRingsCount(),i=0;i<t;i++)this.newVtxRing().copyFrom(e.getVtxRing(i))}},VtxRingsList.prototype.translate=function(e,t,i){for(var o=this.getVtxRingsCount(),r=0;r<o;r++)this.vtxRingsArray[r].translate(e,t,i)},VtxRingsList.prototype.transformPointsByMatrix4=function(e){for(var t=this.getVtxRingsCount(),i=0;i<t;i++)this.vtxRingsArray[i].transformPointsByMatrix4(e)},VtxRingsList.prototype.getAllVertices=function(e){if(void 0===this.vtxRingsArray)return e;for(var t=this.getVtxRingsCount(),i=0;i<t;i++)this.vtxRingsArray[i].getAllVertices(e);return e},VtxRingsList.prototype.setVerticesIdxInList=function(){if(void 0!==this.vtxRingsArray)for(var e=this.getVtxRingsCount(),t=0;t<e;t++)this.vtxRingsArray[t].setVerticesIdxInList()};var VtxSegment=function(e,t){if(!(this instanceof VtxSegment))throw new Error(Messages.CONSTRUCT_ERROR);this.startVertex,this.endVertex,e&&(this.startVertex=e),t&&(this.endVertex=t)};VtxSegment.prototype.setVertices=function(e,t){this.startVertex=e,this.endVertex=t},VtxSegment.prototype.getDirection=function(e){if(void 0!==(e=this.getVector()))return e.unitary(),e},VtxSegment.prototype.getVector=function(e){if(void 0!==this.startVertex&&void 0!==this.endVertex){var t=this.startVertex.point3d,i=this.endVertex.point3d;if(void 0!==t&&void 0!==i)return e=t.getVectorToPoint(i,e)}},VtxSegment.prototype.getLine=function(e){void 0===e&&(e=new Line);var t=this.getDirection(),i=this.startVertex.point3d;return e.setPointAndDir(i.x,i.y,i.z,t.x,t.y,t.z),e},VtxSegment.prototype.getSquaredLength=function(){return this.startVertex.point3d.squareDistToPoint(this.endVertex.point3d)},VtxSegment.prototype.getLength=function(){return Math.sqrt(this.getSquaredLength())},VtxSegment.prototype.intersectionWithPoint=function(e,t){var i=this.getLine();if(void 0===t&&(t=1e-7),!i.isCoincidentPoint(e,t))return Constant.INTERSECTION_OUTSIDE;var o=this.startVertex.point3d.distToPoint(e),r=this.endVertex.point3d.distToPoint(e),n=this.getLength();return o<t?Constant.INTERSECTION_POINT_A:r<t?Constant.INTERSECTION_POINT_B:o>n||r>n?Constant.INTERSECTION_OUTSIDE:Math.abs(o+r-n)<t?Constant.INTERSECTION_INSIDE:void 0};var UniformMatrix4fvDataPair=function(e,t){if(!(this instanceof UniformMatrix4fvDataPair))throw new Error(Messages.CONSTRUCT_ERROR);this.gl=e,this.name=t,this.uniformLocation,this.matrix4fv};UniformMatrix4fvDataPair.prototype.bindUniform=function(){this.gl.uniformMatrix4fv(this.uniformLocation,!1,this.matrix4fv)};var UniformVec2fvDataPair=function(e,t){if(!(this instanceof UniformVec2fvDataPair))throw new Error(Messages.CONSTRUCT_ERROR);this.gl=e,this.name=t,this.uniformLocation,this.vec2fv};UniformVec2fvDataPair.prototype.bindUniform=function(){this.gl.uniform2fv(this.uniformLocation,this.vec2fv)};var UniformVec3fvDataPair=function(e,t){if(!(this instanceof UniformVec3fvDataPair))throw new Error(Messages.CONSTRUCT_ERROR);this.gl=e,this.name=t,this.uniformLocation,this.vec3fv};UniformVec3fvDataPair.prototype.bindUniform=function(){this.gl.uniform3fv(this.uniformLocation,this.vec3fv)};var UniformVec4fvDataPair=function(e,t){if(!(this instanceof UniformVec4fvDataPair))throw new Error(Messages.CONSTRUCT_ERROR);this.gl=e,this.name=t,this.uniformLocation,this.vec4fv};UniformVec4fvDataPair.prototype.bindUniform=function(){this.gl.uniform4fv(this.uniformLocation,this.vec4fv)};var Uniform1fDataPair=function(e,t){if(!(this instanceof Uniform1fDataPair))throw new Error(Messages.CONSTRUCT_ERROR);this.gl=e,this.name=t,this.uniformLocation,this.floatValue};Uniform1fDataPair.prototype.bindUniform=function(){this.gl.uniform1f(this.uniformLocation,this.floatValue)};var Uniform1iDataPair=function(e,t){if(!(this instanceof Uniform1iDataPair))throw new Error(Messages.CONSTRUCT_ERROR);this.gl=e,this.name=t,this.uniformLocation,this.intValue};Uniform1iDataPair.prototype.bindUniform=function(){this.gl.uniform1i(this.uniformLocation,this.intValue)};var PostFxShader=function(e){if(!(this instanceof PostFxShader))throw new Error(Messages.CONSTRUCT_ERROR);this.gl=e,this.name,this.attribLocationCacheObj={},this.uniformsArrayGeneral=[],this.uniformsMapGeneral={},this.uniformsArrayLocal=[],this.uniformsMapLocal={},this.program,this.shader_vertex,this.shader_fragment};PostFxShader.prototype.bindUniformGenerals=function(){if(void 0!==this.uniformsArrayGeneral)for(var e=this.uniformsArrayGeneral.length,t=0;t<e;t++)this.uniformsArrayGeneral[t].bindUniform()},PostFxShader.prototype.newUniformDataPair=function(e,t){var i;return"Matrix4fv"===e?(i=new UniformMatrix4fvDataPair(this.gl,t),this.uniformsArrayGeneral.push(i),this.uniformsMapGeneral[t]=i):"Vec4fv"===e?(i=new UniformVec4fvDataPair(this.gl,t),this.uniformsArrayGeneral.push(i),this.uniformsMapGeneral[t]=i):"Vec3fv"===e?(i=new UniformVec3fvDataPair(this.gl,t),this.uniformsArrayGeneral.push(i),this.uniformsMapGeneral[t]=i):"Vec2fv"===e?(i=new UniformVec2fvDataPair(this.gl,t),this.uniformsArrayGeneral.push(i),this.uniformsMapGeneral[t]=i):"1f"===e?(i=new Uniform1fDataPair(this.gl,t),this.uniformsArrayGeneral.push(i),this.uniformsMapGeneral[t]=i):"1i"===e&&(i=new Uniform1iDataPair(this.gl,t),this.uniformsArrayGeneral.push(i),this.uniformsMapGeneral[t]=i),i},PostFxShader.prototype.newUniformDataPairLocal=function(e,t){var i;return"Matrix4fv"===e?(i=new UniformMatrix4fvDataPair(this.gl,t),this.uniformsArrayLocal.push(i),this.uniformsMapLocal[t]=i):"Vec4fv"===e?(i=new UniformVec4fvDataPair(this.gl,t),this.uniformsArrayLocal.push(i),this.uniformsMapLocal[t]=i):"Vec3fv"===e?(i=new UniformVec3fvDataPair(this.gl,t),this.uniformsArrayLocal.push(i),this.uniformsMapLocal[t]=i):"Vec2fv"===e?(i=new UniformVec2fvDataPair(this.gl,t),this.uniformsArrayLocal.push(i),this.uniformsMapLocal[t]=i):"1f"===e?(i=new Uniform1fDataPair(this.gl,t),this.uniformsArrayLocal.push(i),this.uniformsMapLocal[t]=i):"1i"===e&&(i=new Uniform1iDataPair(this.gl,t),this.uniformsArrayLocal.push(i),this.uniformsMapLocal[t]=i),i},PostFxShader.prototype.createUniformGenerals=function(e,t,i){var o,r;null!==(r=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"))&&void 0!==r&&((o=t.newUniformDataPair("Matrix4fv","mvpMat4RelToEye")).uniformLocation=r,o.matrix4fv=i.modelViewProjRelToEyeMatrix._floatArrays),null!==(r=e.getUniformLocation(t.program,"ModelViewProjectionMatrix"))&&void 0!==r&&((o=t.newUniformDataPair("Matrix4fv","mvpMat4")).uniformLocation=r,o.matrix4fv=i.modelViewProjMatrix._floatArrays),null!==(r=e.getUniformLocation(t.program,"modelViewMatrixRelToEye"))&&void 0!==r&&((o=t.newUniformDataPair("Matrix4fv","mvMat4RelToEye")).uniformLocation=r,o.matrix4fv=i.modelViewRelToEyeMatrix._floatArrays),null!==(r=e.getUniformLocation(t.program,"modelViewMatrix"))&&void 0!==r&&((o=t.newUniformDataPair("Matrix4fv","modelViewMatrix")).uniformLocation=r,o.matrix4fv=i.modelViewRelToEyeMatrix._floatArrays),null!==(r=e.getUniformLocation(t.program,"projectionMatrix"))&&void 0!==r&&((o=t.newUniformDataPair("Matrix4fv","pMat4")).uniformLocation=r,o.matrix4fv=i.projectionMatrix._floatArrays),null!==(r=e.getUniformLocation(t.program,"normalMatrix4"))&&void 0!==r&&((o=t.newUniformDataPair("Matrix4fv","normalMat4")).uniformLocation=r,o.matrix4fv=i.normalMatrix4._floatArrays),null!==(r=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"))&&void 0!==r&&((o=t.newUniformDataPair("Vec3fv","encodedCamPosHigh")).uniformLocation=r,o.vec3fv=i.encodedCamPosHigh),null!==(r=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"))&&void 0!==r&&((o=t.newUniformDataPair("Vec3fv","encodedCamPosLow")).uniformLocation=r,o.vec3fv=i.encodedCamPosLow),null!==(r=e.getUniformLocation(t.program,"near"))&&void 0!==r&&((o=t.newUniformDataPair("1f","frustumNear")).uniformLocation=r,o.floatValue=i.camera.frustum.near),null!==(r=e.getUniformLocation(t.program,"far"))&&void 0!==r&&((o=t.newUniformDataPair("1f","frustumFar")).uniformLocation=r,o.floatValue=i.camera.frustum.far),null!==(r=e.getUniformLocation(t.program,"fov"))&&void 0!==r&&((o=t.newUniformDataPair("1f","fovyRad")).uniformLocation=r,o.floatValue=i.camera.frustum.fovyRad),null!==(r=e.getUniformLocation(t.program,"aspectRatio"))&&void 0!==r&&((o=t.newUniformDataPair("1f","aspectRatio")).uniformLocation=r,o.floatValue=i.camera.frustum.aspectRatio),null!==(r=e.getUniformLocation(t.program,"screenWidth"))&&void 0!==r&&((o=t.newUniformDataPair("1f","drawBuffWidht")).uniformLocation=r,o.floatValue=i.drawingBufferWidth),null!==(r=e.getUniformLocation(t.program,"screenHeight"))&&void 0!==r&&((o=t.newUniformDataPair("1f","drawBuffHeight")).uniformLocation=r,o.floatValue=i.drawingBufferHeight),null!==(r=e.getUniformLocation(t.program,"depthTex"))&&void 0!==r&&((o=t.newUniformDataPair("1i","depthTex")).uniformLocation=r,o.intValue=0),null!==(r=e.getUniformLocation(t.program,"noiseTex"))&&void 0!==r&&((o=t.newUniformDataPair("1i","noiseTex")).uniformLocation=r,o.intValue=1),null!==(r=e.getUniformLocation(t.program,"diffuseTex"))&&void 0!==r&&((o=t.newUniformDataPair("1i","diffuseTex")).uniformLocation=r,o.intValue=2),null!==(r=e.getUniformLocation(t.program,"specularColor"))&&void 0!==r&&((o=t.newUniformDataPair("Vec3fv","specularColor")).uniformLocation=r,o.vec3fv=i.specularColor),null!==(r=e.getUniformLocation(t.program,"radius"))&&void 0!==r&&((o=t.newUniformDataPair("1f","radius")).uniformLocation=r,o.floatValue=i.ssaoRadius),null!==(r=e.getUniformLocation(t.program,"ambientReflectionCoef"))&&void 0!==r&&((o=t.newUniformDataPair("1f","ambientReflectionCoef")).uniformLocation=r,o.floatValue=i.ambientReflectionCoef),null!==(r=e.getUniformLocation(t.program,"diffuseReflectionCoef"))&&void 0!==r&&((o=t.newUniformDataPair("1f","diffuseReflectionCoef")).uniformLocation=r,o.floatValue=i.diffuseReflectionCoef),null!==(r=e.getUniformLocation(t.program,"specularReflectionCoef"))&&void 0!==r&&((o=t.newUniformDataPair("1f","specularReflectionCoef")).uniformLocation=r,o.floatValue=i.specularReflectionCoef),null!==(r=e.getUniformLocation(t.program,"shininessValue"))&&void 0!==r&&((o=t.newUniformDataPair("1f","shininessValue")).uniformLocation=r,o.floatValue=i.shininessValue),null!==(r=e.getUniformLocation(t.program,"noiseScale"))&&void 0!==r&&((o=t.newUniformDataPair("Vec2fv","ssaoNoiseScale2")).uniformLocation=r,o.vec2fv=i.ssaoNoiseScale2),null!==(r=e.getUniformLocation(t.program,"kernel"))&&void 0!==r&&((o=t.newUniformDataPair("Vec3fv","ssaoKernel16")).uniformLocation=r,o.vec3fv=i.ssaoKernel16)},PostFxShader.prototype.createUniformLocals=function(e,t,i){t.buildingRotMatrix_loc=e.getUniformLocation(t.program,"buildingRotMatrix"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.refMatrixType_loc=e.getUniformLocation(t.program,"refMatrixType"),t.refMatrix_loc=e.getUniformLocation(t.program,"RefTransfMatrix"),t.refTranslationVec_loc=e.getUniformLocation(t.program,"refTranslationVec"),t.aditionalMov_loc=e.getUniformLocation(t.program,"aditionalPosition"),t.hasTexture_loc=e.getUniformLocation(t.program,"hasTexture"),t.textureFlipYAxis_loc=e.getUniformLocation(t.program,"textureFlipYAxis"),t.kernel16_loc=e.getUniformLocation(t.program,"kernel"),t.noiseScale2_loc=e.getUniformLocation(t.program,"noiseScale"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.texCoord2_loc=e.getAttribLocation(t.program,"texCoord"),t.normal3_loc=e.getAttribLocation(t.program,"normal"),t.color4_loc=e.getAttribLocation(t.program,"color4"),t.bUse1Color_loc=e.getUniformLocation(t.program,"bUse1Color"),t.oneColor4_loc=e.getUniformLocation(t.program,"oneColor4"),t.posDataByteSize_loc=e.getUniformLocation(t.program,"posDataByteSize"),t.texCoordByteSize_loc=e.getUniformLocation(t.program,"texCoordByteSize"),t.compressionMaxPoint_loc=e.getUniformLocation(t.program,"compressionMaxPoint"),t.compressionMinPoint_loc=e.getUniformLocation(t.program,"compressionMinPoint"),t.bApplySpecularLighting_loc=e.getUniformLocation(t.program,"bApplySpecularLighting")};var PostFxShadersManager=function(){if(!(this instanceof PostFxShadersManager))throw new Error(Messages.CONSTRUCT_ERROR);this.gl,this.pFx_shaders_array=[],this.shadersMap={},this.modelRefShader,this.modelRefSilhouetteShader,this.lodBuildingShader};PostFxShadersManager.prototype.newShader=function(e){var t=new PostFxShader(this.gl);return t.name=e,this.shadersMap[e]=t,t},PostFxShadersManager.prototype.getShader=function(e){return this.shadersMap[e]},PostFxShadersManager.prototype.createShader=function(e,t,i,o){var r=e.createShader(i);return e.shaderSource(r,t),e.compileShader(r),!!e.getShaderParameter(r,e.COMPILE_STATUS)&&r},PostFxShadersManager.prototype.createDefaultShaders=function(e,t){this.createRenderDepthShader(e),this.createSsaoShader(e),this.createBlurShader(e),this.createRenderDepthShaderModelRef(e),this.modelRefShader=this.createSsaoShaderModelRef(e),this.createColorSelectionShaderModelRef(e),this.createSimpleDepthShaderModelRef(e),this.createRenderDepthShaderLODBuilding(e),this.lodBuildingShader=this.createSsaoShaderLODBuilding(e),this.createRenderDepthShaderLego(e),this.createSsaoShaderLego(e),this.triPolyhedronDepthShader=this.createDepthShaderBox(e),this.triPolyhedronShader=this.createSsaoShaderBox(e),this.createPngImageShader(e),this.modelRefSilhouetteShader=this.createSilhouetteShaderModelRef(e),this.invertedBoxShader=this.createInvertedBoxShader(e)},PostFxShadersManager.prototype.getModelRefShader=function(){return this.modelRefShader},PostFxShadersManager.prototype.getModelRefSilhouetteShader=function(){return this.modelRefSilhouetteShader},PostFxShadersManager.prototype.getTriPolyhedronDepthShader=function(){return this.triPolyhedronDepthShader},PostFxShadersManager.prototype.getTriPolyhedronShader=function(){return this.triPolyhedronShader},PostFxShadersManager.prototype.getInvertedBoxShader=function(){return this.invertedBoxShader},PostFxShadersManager.prototype.createBlurShader=function(e){var t=new PostFxShader(this.gl);this.pFx_shaders_array.push(t);var i=ShaderSource.BlurVS,o=ShaderSource.BlurFS;t.program=e.createProgram(),t.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.program,t.shader_vertex),e.attachShader(t.program,t.shader_fragment),e.linkProgram(t.program),t.projectionMatrix4_loc=e.getUniformLocation(t.program,"projectionMatrix"),t.modelViewMatrix4_loc=e.getUniformLocation(t.program,"modelViewMatrix"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.texCoord2_loc=e.getAttribLocation(t.program,"texCoord"),t.attribLocationCacheObj.position=e.getAttribLocation(t.program,"position"),t.attribLocationCacheObj.texCoord=e.getAttribLocation(t.program,"texCoord"),t.texelSize_loc=e.getUniformLocation(t.program,"texelSize"),t.colorTex_loc=e.getUniformLocation(t.program,"colorTex")},PostFxShadersManager.prototype.createSsaoShader=function(e){var t=new PostFxShader(this.gl);this.pFx_shaders_array.push(t);var i=ShaderSource.SsaoVS,o=ShaderSource.SsaoFS;t.program=e.createProgram(),t.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.program,t.shader_vertex),e.attachShader(t.program,t.shader_fragment),e.linkProgram(t.program),t.cameraPosHIGH_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"),t.cameraPosLOW_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.modelViewMatrix4RelToEye_loc=e.getUniformLocation(t.program,"modelViewMatrixRelToEye"),t.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"),t.normalMatrix4_loc=e.getUniformLocation(t.program,"normalMatrix4"),t.projectionMatrix4_loc=e.getUniformLocation(t.program,"projectionMatrix"),t.modelViewMatrix4_loc=e.getUniformLocation(t.program,"modelViewMatrix"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.texCoord2_loc=e.getAttribLocation(t.program,"texCoord"),t.normal3_loc=e.getAttribLocation(t.program,"normal"),t.attribLocationCacheObj.position=e.getAttribLocation(t.program,"position"),t.attribLocationCacheObj.normal=e.getAttribLocation(t.program,"normal"),t.attribLocationCacheObj.texCoord=e.getAttribLocation(t.program,"texCoord"),t.noiseScale2_loc=e.getUniformLocation(t.program,"noiseScale"),t.kernel16_loc=e.getUniformLocation(t.program,"kernel"),t.near_loc=e.getUniformLocation(t.program,"near"),t.far_loc=e.getUniformLocation(t.program,"far"),t.fov_loc=e.getUniformLocation(t.program,"fov"),t.aspectRatio_loc=e.getUniformLocation(t.program,"aspectRatio"),t.screenWidth_loc=e.getUniformLocation(t.program,"screenWidth"),t.screenHeight_loc=e.getUniformLocation(t.program,"screenHeight"),t.depthTex_loc=e.getUniformLocation(t.program,"depthTex"),t.noiseTex_loc=e.getUniformLocation(t.program,"noiseTex"),t.diffuseTex_loc=e.getUniformLocation(t.program,"diffuseTex")},PostFxShadersManager.prototype.createRenderDepthShader=function(e){var t=new PostFxShader(this.gl);this.pFx_shaders_array.push(t);var i=ShaderSource.ShowDepthVS,o=ShaderSource.ShowDepthFS;t.program=e.createProgram(),t.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.program,t.shader_vertex),e.attachShader(t.program,t.shader_fragment),e.linkProgram(t.program),t.cameraPosHIGH_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"),t.cameraPosLOW_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.modelViewMatrix4RelToEye_loc=e.getUniformLocation(t.program,"modelViewMatrixRelToEye"),t.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"),t.normalMatrix4_loc=e.getUniformLocation(t.program,"normalMatrix4"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.normal3_loc=e.getAttribLocation(t.program,"normal"),t.attribLocationCacheObj.position=e.getAttribLocation(t.program,"position"),t.attribLocationCacheObj.normal=e.getAttribLocation(t.program,"normal"),t.near_loc=e.getUniformLocation(t.program,"near"),t.far_loc=e.getUniformLocation(t.program,"far")},PostFxShadersManager.prototype.createSsaoShaderModelRef=function(e){var t=new PostFxShader(this.gl);this.pFx_shaders_array.push(void 0);var i=ShaderSource.ModelRefSsaoVS,o=ShaderSource.ModelRefSsaoFS;return t.program=e.createProgram(),t.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.program,t.shader_vertex),e.attachShader(t.program,t.shader_fragment),e.linkProgram(t.program),t.cameraPosHIGH_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"),t.cameraPosLOW_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.modelViewMatrix4RelToEye_loc=e.getUniformLocation(t.program,"modelViewMatrixRelToEye"),t.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"),t.normalMatrix4_loc=e.getUniformLocation(t.program,"normalMatrix4"),t.projectionMatrix4_loc=e.getUniformLocation(t.program,"projectionMatrix"),t.refMatrix_loc=e.getUniformLocation(t.program,"RefTransfMatrix"),t.buildingRotMatrix_loc=e.getUniformLocation(t.program,"buildingRotMatrix"),t.refMatrixType_loc=e.getUniformLocation(t.program,"refMatrixType"),t.refTranslationVec_loc=e.getUniformLocation(t.program,"refTranslationVec"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.texCoord2_loc=e.getAttribLocation(t.program,"texCoord"),t.normal3_loc=e.getAttribLocation(t.program,"normal"),t.attribLocationCacheObj.position=e.getAttribLocation(t.program,"position"),t.attribLocationCacheObj.texCoord=e.getAttribLocation(t.program,"texCoord"),t.attribLocationCacheObj.normal=e.getAttribLocation(t.program,"normal"),t.aditionalMov_loc=e.getUniformLocation(t.program,"aditionalPosition"),t.noiseScale2_loc=e.getUniformLocation(t.program,"noiseScale"),t.kernel16_loc=e.getUniformLocation(t.program,"kernel"),t.near_loc=e.getUniformLocation(t.program,"near"),t.far_loc=e.getUniformLocation(t.program,"far"),t.fov_loc=e.getUniformLocation(t.program,"fov"),t.aspectRatio_loc=e.getUniformLocation(t.program,"aspectRatio"),t.screenWidth_loc=e.getUniformLocation(t.program,"screenWidth"),t.screenHeight_loc=e.getUniformLocation(t.program,"screenHeight"),t.shininessValue_loc=e.getUniformLocation(t.program,"shininessValue"),t.hasTexture_loc=e.getUniformLocation(t.program,"hasTexture"),t.color4Aux_loc=e.getUniformLocation(t.program,"vColor4Aux"),t.textureFlipYAxis_loc=e.getUniformLocation(t.program,"textureFlipYAxis"),t.depthTex_loc=e.getUniformLocation(t.program,"depthTex"),t.noiseTex_loc=e.getUniformLocation(t.program,"noiseTex"),t.diffuseTex_loc=e.getUniformLocation(t.program,"diffuseTex"),t.specularColor_loc=e.getUniformLocation(t.program,"specularColor"),t.ssaoRadius_loc=e.getUniformLocation(t.program,"radius"),t.ambientReflectionCoef_loc=e.getUniformLocation(t.program,"ambientReflectionCoef"),t.diffuseReflectionCoef_loc=e.getUniformLocation(t.program,"diffuseReflectionCoef"),t.specularReflectionCoef_loc=e.getUniformLocation(t.program,"specularReflectionCoef"),t},PostFxShadersManager.prototype.createRenderDepthShaderModelRef=function(e,t){var i=new PostFxShader(this.gl);this.pFx_shaders_array.push(i);var o=ShaderSource.RenderShowDepthVS,r=ShaderSource.RenderShowDepthFS;i.program=e.createProgram(),i.shader_vertex=this.createShader(e,o,e.VERTEX_SHADER,"VERTEX"),i.shader_fragment=this.createShader(e,r,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(i.program,i.shader_vertex),e.attachShader(i.program,i.shader_fragment),e.linkProgram(i.program),i.cameraPosHIGH_loc=e.getUniformLocation(i.program,"encodedCameraPositionMCHigh"),i.cameraPosLOW_loc=e.getUniformLocation(i.program,"encodedCameraPositionMCLow"),i.buildingPosHIGH_loc=e.getUniformLocation(i.program,"buildingPosHIGH"),i.buildingPosLOW_loc=e.getUniformLocation(i.program,"buildingPosLOW"),i.modelViewMatrix4RelToEye_loc=e.getUniformLocation(i.program,"modelViewMatrixRelToEye"),i.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(i.program,"ModelViewProjectionMatrixRelToEye"),i.modelViewMatrix4_loc=e.getUniformLocation(i.program,"modelViewMatrix"),i.refMatrix_loc=e.getUniformLocation(i.program,"RefTransfMatrix"),i.buildingRotMatrix_loc=e.getUniformLocation(i.program,"buildingRotMatrix"),i.refMatrixType_loc=e.getUniformLocation(i.program,"refMatrixType"),i.refTranslationVec_loc=e.getUniformLocation(i.program,"refTranslationVec"),i.position3_loc=e.getAttribLocation(i.program,"position"),i.attribLocationCacheObj.position=e.getAttribLocation(i.program,"position"),i.aditionalMov_loc=e.getUniformLocation(i.program,"aditionalPosition"),i.near_loc=e.getUniformLocation(i.program,"near"),i.far_loc=e.getUniformLocation(i.program,"far")},PostFxShadersManager.prototype.createColorSelectionShaderModelRef=function(e){var t=new PostFxShader(this.gl);this.pFx_shaders_array.push(t);var i=ShaderSource.ColorSelectionSsaoVS,o=ShaderSource.ColorSelectionSsaoFS;t.program=e.createProgram(),t.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.program,t.shader_vertex),e.attachShader(t.program,t.shader_fragment),e.linkProgram(t.program),t.cameraPosHIGH_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"),t.cameraPosLOW_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"),t.refMatrix_loc=e.getUniformLocation(t.program,"RefTransfMatrix"),t.buildingRotMatrix_loc=e.getUniformLocation(t.program,"buildingRotMatrix"),t.refMatrixType_loc=e.getUniformLocation(t.program,"refMatrixType"),t.refTranslationVec_loc=e.getUniformLocation(t.program,"refTranslationVec"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.attribLocationCacheObj.position=e.getAttribLocation(t.program,"position"),t.aditionalMov_loc=e.getUniformLocation(t.program,"aditionalPosition"),t.color4Aux_loc=e.getUniformLocation(t.program,"vColor4Aux")},PostFxShadersManager.prototype.createSimpleDepthShaderModelRef=function(e){var t=new PostFxShader(this.gl);this.pFx_shaders_array.push(t);var i=ShaderSource.SimpleDepthSsaoVS,o=ShaderSource.SimpleDepthSsaoFS;t.program=e.createProgram(),t.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.program,t.shader_vertex),e.attachShader(t.program,t.shader_fragment),e.linkProgram(t.program),t.cameraPosHIGH_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"),t.cameraPosLOW_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"),t.refMatrix_loc=e.getUniformLocation(t.program,"RefTransfMatrix"),t.modelViewMatrix4RelToEye_loc=e.getUniformLocation(t.program,"modelViewMatrixRelToEye"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.attribLocationCacheObj.position=e.getAttribLocation(t.program,"position"),t.far_loc=e.getUniformLocation(t.program,"far")},PostFxShadersManager.prototype.createSsaoShaderLODBuilding=function(e){var t=new PostFxShader(this.gl);this.pFx_shaders_array.push(t);var i=ShaderSource.LodBuildingSsaoVS,o=ShaderSource.LodBuildingSsaoFS;t.program=e.createProgram(),t.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.program,t.shader_vertex),e.attachShader(t.program,t.shader_fragment),e.linkProgram(t.program),t.cameraPosHIGH_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"),t.cameraPosLOW_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.modelViewMatrix4RelToEye_loc=e.getUniformLocation(t.program,"modelViewMatrixRelToEye"),t.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"),t.normalMatrix4_loc=e.getUniformLocation(t.program,"normalMatrix4"),t.projectionMatrix4_loc=e.getUniformLocation(t.program,"projectionMatrix"),t.modelViewMatrix4_loc=e.getUniformLocation(t.program,"modelViewMatrix"),t.refMatrix_loc=e.getUniformLocation(t.program,"RefTransfMatrix"),t.buildingRotMatrix_loc=e.getUniformLocation(t.program,"buildingRotMatrix"),t.bUse1Color_loc=e.getUniformLocation(t.program,"bUse1Color"),t.oneColor4_loc=e.getUniformLocation(t.program,"oneColor4"),t.hasTexture_loc=e.getUniformLocation(t.program,"hasTexture"),t.textureFlipYAxis_loc=e.getUniformLocation(t.program,"textureFlipYAxis"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.texCoord2_loc=e.getAttribLocation(t.program,"texCoord"),t.normal3_loc=e.getAttribLocation(t.program,"normal"),t.color4_loc=e.getAttribLocation(t.program,"color4"),t.attribLocationCacheObj.position=e.getAttribLocation(t.program,"position"),t.attribLocationCacheObj.normal=e.getAttribLocation(t.program,"normal"),t.attribLocationCacheObj.color4=e.getAttribLocation(t.program,"color4"),t.aditionalMov_loc=e.getUniformLocation(t.program,"aditionalPosition"),t.shininessValue_loc=e.getUniformLocation(t.program,"shininessValue"),t.noiseScale2_loc=e.getUniformLocation(t.program,"noiseScale"),t.kernel16_loc=e.getUniformLocation(t.program,"kernel"),t.near_loc=e.getUniformLocation(t.program,"near"),t.far_loc=e.getUniformLocation(t.program,"far"),t.fov_loc=e.getUniformLocation(t.program,"fov"),t.aspectRatio_loc=e.getUniformLocation(t.program,"aspectRatio"),t.screenWidth_loc=e.getUniformLocation(t.program,"screenWidth"),t.screenHeight_loc=e.getUniformLocation(t.program,"screenHeight"),t.color4Aux_loc=e.getUniformLocation(t.program,"vColor4Aux"),t.specularColor_loc=e.getUniformLocation(t.program,"specularColor"),t.depthTex_loc=e.getUniformLocation(t.program,"depthTex"),t.noiseTex_loc=e.getUniformLocation(t.program,"noiseTex"),t.diffuseTex_loc=e.getUniformLocation(t.program,"diffuseTex"),t.useRefTransfMatrix_loc=e.getUniformLocation(t.program,"useRefTransfMatrix"),t.useTexture_loc=e.getUniformLocation(t.program,"useTexture"),t.invertNormals_loc=e.getUniformLocation(t.program,"invertNormals"),t.ssaoRadius_loc=e.getUniformLocation(t.program,"radius"),t.ambientReflectionCoef_loc=e.getUniformLocation(t.program,"ambientReflectionCoef"),t.diffuseReflectionCoef_loc=e.getUniformLocation(t.program,"diffuseReflectionCoef"),t.specularReflectionCoef_loc=e.getUniformLocation(t.program,"specularReflectionCoef")},PostFxShadersManager.prototype.createRenderDepthShaderLODBuilding=function(e){var t=new PostFxShader(this.gl);this.pFx_shaders_array.push(t);var i=ShaderSource.LodBuildingDepthVS,o=ShaderSource.LodBuildingDepthFS;t.program=e.createProgram(),t.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.program,t.shader_vertex),e.attachShader(t.program,t.shader_fragment),e.linkProgram(t.program),t.cameraPosHIGH_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"),t.cameraPosLOW_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.modelViewMatrix4RelToEye_loc=e.getUniformLocation(t.program,"modelViewMatrixRelToEye"),t.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"),t.modelViewMatrix4_loc=e.getUniformLocation(t.program,"modelViewMatrix"),t.refMatrix_loc=e.getUniformLocation(t.program,"RefTransfMatrix"),t.buildingRotMatrix_loc=e.getUniformLocation(t.program,"buildingRotMatrix"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.attribLocationCacheObj.position=e.getAttribLocation(t.program,"position"),t.aditionalMov_loc=e.getUniformLocation(t.program,"aditionalPosition"),t.near_loc=e.getUniformLocation(t.program,"near"),t.far_loc=e.getUniformLocation(t.program,"far")},PostFxShadersManager.prototype.createSsaoShaderLego=function(e){var t=new PostFxShader(this.gl);this.pFx_shaders_array.push(t);var i=ShaderSource.LegoSsaoVS,o=ShaderSource.LegoSsaoFS;t.program=e.createProgram(),t.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.program,t.shader_vertex),e.attachShader(t.program,t.shader_fragment),e.linkProgram(t.program),t.cameraPosHIGH_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"),t.cameraPosLOW_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.modelViewMatrix4RelToEye_loc=e.getUniformLocation(t.program,"modelViewMatrixRelToEye"),t.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"),t.normalMatrix4_loc=e.getUniformLocation(t.program,"normalMatrix4"),t.projectionMatrix4_loc=e.getUniformLocation(t.program,"projectionMatrix"),t.modelViewMatrix4_loc=e.getUniformLocation(t.program,"modelViewMatrix"),t.refMatrix_loc=e.getUniformLocation(t.program,"RefTransfMatrix"),t.buildingRotMatrix_loc=e.getUniformLocation(t.program,"buildingRotMatrix"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.normal3_loc=e.getAttribLocation(t.program,"normal"),t.color4_loc=e.getAttribLocation(t.program,"color4"),t.attribLocationCacheObj.position=e.getAttribLocation(t.program,"position"),t.attribLocationCacheObj.normal=e.getAttribLocation(t.program,"normal"),t.attribLocationCacheObj.color4=e.getAttribLocation(t.program,"color4"),t.aditionalMov_loc=e.getUniformLocation(t.program,"aditionalPosition"),t.noiseScale2_loc=e.getUniformLocation(t.program,"noiseScale"),t.kernel16_loc=e.getUniformLocation(t.program,"kernel"),t.near_loc=e.getUniformLocation(t.program,"near"),t.far_loc=e.getUniformLocation(t.program,"far"),t.fov_loc=e.getUniformLocation(t.program,"fov"),t.aspectRatio_loc=e.getUniformLocation(t.program,"aspectRatio"),t.screenWidth_loc=e.getUniformLocation(t.program,"screenWidth"),t.screenHeight_loc=e.getUniformLocation(t.program,"screenHeight"),t.hasTexture_loc=e.getUniformLocation(t.program,"hasTexture"),t.color4Aux_loc=e.getUniformLocation(t.program,"vColor4Aux"),t.depthTex_loc=e.getUniformLocation(t.program,"depthTex"),t.noiseTex_loc=e.getUniformLocation(t.program,"noiseTex"),t.diffuseTex_loc=e.getUniformLocation(t.program,"diffuseTex"),t.useRefTransfMatrix_loc=e.getUniformLocation(t.program,"useRefTransfMatrix"),t.useTexture_loc=e.getUniformLocation(t.program,"useTexture"),t.invertNormals_loc=e.getUniformLocation(t.program,"invertNormals")},PostFxShadersManager.prototype.createRenderDepthShaderLego=function(e){var t=new PostFxShader(this.gl);this.pFx_shaders_array.push(t);var i=ShaderSource.LegoDepthVS,o=ShaderSource.LegoDepthFS;t.program=e.createProgram(),t.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.program,t.shader_vertex),e.attachShader(t.program,t.shader_fragment),e.linkProgram(t.program),t.cameraPosHIGH_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"),t.cameraPosLOW_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.modelViewMatrix4RelToEye_loc=e.getUniformLocation(t.program,"modelViewMatrixRelToEye"),t.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"),t.modelViewMatrix4_loc=e.getUniformLocation(t.program,"modelViewMatrix"),t.refMatrix_loc=e.getUniformLocation(t.program,"RefTransfMatrix"),t.buildingRotMatrix_loc=e.getUniformLocation(t.program,"buildingRotMatrix"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.attribLocationCacheObj.position=e.getAttribLocation(t.program,"position"),t.aditionalMov_loc=e.getUniformLocation(t.program,"aditionalPosition"),t.near_loc=e.getUniformLocation(t.program,"near"),t.far_loc=e.getUniformLocation(t.program,"far")},PostFxShadersManager.prototype.createRenderDepthShaderLODBuilding=function(e){var t=new PostFxShader(this.gl);this.pFx_shaders_array.push(t);var i=ShaderSource.LodBuildingDepthVS,o=ShaderSource.LodBuildingDepthFS;t.program=e.createProgram(),t.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.program,t.shader_vertex),e.attachShader(t.program,t.shader_fragment),e.linkProgram(t.program),t.cameraPosHIGH_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"),t.cameraPosLOW_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.modelViewMatrix4RelToEye_loc=e.getUniformLocation(t.program,"modelViewMatrixRelToEye"),t.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"),t.modelViewMatrix4_loc=e.getUniformLocation(t.program,"modelViewMatrix"),t.refMatrix_loc=e.getUniformLocation(t.program,"RefTransfMatrix"),t.buildingRotMatrix_loc=e.getUniformLocation(t.program,"buildingRotMatrix"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.attribLocationCacheObj.position=e.getAttribLocation(t.program,"position"),t.aditionalMov_loc=e.getUniformLocation(t.program,"aditionalPosition"),t.near_loc=e.getUniformLocation(t.program,"near"),t.far_loc=e.getUniformLocation(t.program,"far")},PostFxShadersManager.prototype.createDepthShaderBox=function(e){var t=new PostFxShader(this.gl);this.pFx_shaders_array.push(t);var i=ShaderSource.BoxDepthVS,o=ShaderSource.BoxDepthFS;return t.program=e.createProgram(),t.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.program,t.shader_vertex),e.attachShader(t.program,t.shader_fragment),e.linkProgram(t.program),t.cameraPosHIGH_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"),t.cameraPosLOW_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.modelViewMatrix4RelToEye_loc=e.getUniformLocation(t.program,"modelViewMatrixRelToEye"),t.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"),t.modelViewMatrix4_loc=e.getUniformLocation(t.program,"modelViewMatrix"),t.refMatrix_loc=e.getUniformLocation(t.program,"RefTransfMatrix"),t.buildingRotMatrix_loc=e.getUniformLocation(t.program,"buildingRotMatrix"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.attribLocationCacheObj.position=e.getAttribLocation(t.program,"position"),t.aditionalMov_loc=e.getUniformLocation(t.program,"aditionalPosition"),t.near_loc=e.getUniformLocation(t.program,"near"),t.far_loc=e.getUniformLocation(t.program,"far"),t},PostFxShadersManager.prototype.createSsaoShaderBox=function(e){var t=new PostFxShader(this.gl);this.pFx_shaders_array.push(t);var i=ShaderSource.BoxSsaoVS,o=ShaderSource.BoxSsaoFS;return t.program=e.createProgram(),t.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.program,t.shader_vertex),e.attachShader(t.program,t.shader_fragment),e.linkProgram(t.program),t.cameraPosHIGH_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"),t.cameraPosLOW_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.modelViewMatrix4RelToEye_loc=e.getUniformLocation(t.program,"modelViewMatrixRelToEye"),t.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"),t.normalMatrix4_loc=e.getUniformLocation(t.program,"normalMatrix4"),t.projectionMatrix4_loc=e.getUniformLocation(t.program,"projectionMatrix"),t.modelViewMatrix4_loc=e.getUniformLocation(t.program,"modelViewMatrix"),t.buildingRotMatrix_loc=e.getUniformLocation(t.program,"buildingRotMatrix"),t.bUse1Color_loc=e.getUniformLocation(t.program,"bUse1Color"),t.bApplySsao_loc=e.getUniformLocation(t.program,"bApplySsao"),t.oneColor4_loc=e.getUniformLocation(t.program,"oneColor4"),t.bUseNormal_loc=e.getUniformLocation(t.program,"bUseNormal"),t.bScale_loc=e.getUniformLocation(t.program,"bScale"),t.scale_loc=e.getUniformLocation(t.program,"scale"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.normal3_loc=e.getAttribLocation(t.program,"normal"),t.color4_loc=e.getAttribLocation(t.program,"color4"),t.attribLocationCacheObj.position=e.getAttribLocation(t.program,"position"),t.attribLocationCacheObj.normal=e.getAttribLocation(t.program,"normal"),t.attribLocationCacheObj.color4=e.getAttribLocation(t.program,"color4"),t.aditionalMov_loc=e.getUniformLocation(t.program,"aditionalPosition"),t.noiseScale2_loc=e.getUniformLocation(t.program,"noiseScale"),t.kernel16_loc=e.getUniformLocation(t.program,"kernel"),t.near_loc=e.getUniformLocation(t.program,"near"),t.far_loc=e.getUniformLocation(t.program,"far"),t.fov_loc=e.getUniformLocation(t.program,"fov"),t.aspectRatio_loc=e.getUniformLocation(t.program,"aspectRatio"),t.screenWidth_loc=e.getUniformLocation(t.program,"screenWidth"),t.screenHeight_loc=e.getUniformLocation(t.program,"screenHeight"),t.hasTexture_loc=e.getUniformLocation(t.program,"hasTexture"),t.color4Aux_loc=e.getUniformLocation(t.program,"vColor4Aux"),t.depthTex_loc=e.getUniformLocation(t.program,"depthTex"),t.noiseTex_loc=e.getUniformLocation(t.program,"noiseTex"),t.diffuseTex_loc=e.getUniformLocation(t.program,"diffuseTex"),t.useRefTransfMatrix_loc=e.getUniformLocation(t.program,"useRefTransfMatrix"),t.useTexture_loc=e.getUniformLocation(t.program,"useTexture"),t.invertNormals_loc=e.getUniformLocation(t.program,"invertNormals"),t},PostFxShadersManager.prototype.createPngImageShader=function(e){var t=new PostFxShader(this.gl);this.pFx_shaders_array.push(t);var i=ShaderSource.PngImageVS,o=ShaderSource.PngImageFS;t.program=e.createProgram(),t.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.program,t.shader_vertex),e.attachShader(t.program,t.shader_fragment),e.linkProgram(t.program),t.texture_loc=e.getUniformLocation(t.program,"u_texture"),t.cameraPosHIGH_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"),t.cameraPosLOW_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"),t.buildingRotMatrix_loc=e.getUniformLocation(t.program,"buildingRotMatrix"),t.position3_loc=e.getAttribLocation(t.program,"a_position"),t.texCoord2_loc=e.getAttribLocation(t.program,"a_texcoord"),t.textureFlipYAxis_loc=e.getUniformLocation(t.program,"textureFlipYAxis")},PostFxShadersManager.prototype.createSilhouetteShaderModelRef=function(e){var t=new PostFxShader(this.gl);this.pFx_shaders_array.push(void 0);var i=ShaderSource.SilhouetteVS,o=ShaderSource.SilhouetteFS;return t.program=e.createProgram(),t.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.program,t.shader_vertex),e.attachShader(t.program,t.shader_fragment),e.linkProgram(t.program),t.cameraPosHIGH_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"),t.cameraPosLOW_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"),t.refMatrix_loc=e.getUniformLocation(t.program,"RefTransfMatrix"),t.buildingRotMatrix_loc=e.getUniformLocation(t.program,"buildingRotMatrix"),t.refMatrixType_loc=e.getUniformLocation(t.program,"refMatrixType"),t.refTranslationVec_loc=e.getUniformLocation(t.program,"refTranslationVec"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.attribLocationCacheObj.position=e.getAttribLocation(t.program,"position"),t.aditionalMov_loc=e.getUniformLocation(t.program,"aditionalPosition"),t.color4Aux_loc=e.getUniformLocation(t.program,"vColor4Aux"),t.camSpacePixelTranslation_loc=e.getUniformLocation(t.program,"camSpacePixelTranslation"),t.screenSize_loc=e.getUniformLocation(t.program,"screenSize"),t.ProjectionMatrix_loc=e.getUniformLocation(t.program,"ProjectionMatrix"),t.ModelViewMatrixRelToEye_loc=e.getUniformLocation(t.program,"ModelViewMatrixRelToEye"),t},PostFxShadersManager.prototype.createInvertedBoxShader=function(e){var t=new PostFxShader(this.gl);this.pFx_shaders_array.push(void 0);var i=ShaderSource.InvertedBoxVS,o=ShaderSource.InvertedBoxFS;return t.program=e.createProgram(),t.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.program,t.shader_vertex),e.attachShader(t.program,t.shader_fragment),e.linkProgram(t.program),t.cameraPosHIGH_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"),t.cameraPosLOW_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.modelViewMatrix4RelToEye_loc=e.getUniformLocation(t.program,"modelViewMatrixRelToEye"),t.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"),t.normalMatrix4_loc=e.getUniformLocation(t.program,"normalMatrix4"),t.projectionMatrix4_loc=e.getUniformLocation(t.program,"projectionMatrix"),t.refMatrix_loc=e.getUniformLocation(t.program,"RefTransfMatrix"),t.buildingRotMatrix_loc=e.getUniformLocation(t.program,"buildingRotMatrix"),t.refMatrixType_loc=e.getUniformLocation(t.program,"refMatrixType"),t.refTranslationVec_loc=e.getUniformLocation(t.program,"refTranslationVec"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.texCoord2_loc=e.getAttribLocation(t.program,"texCoord"),t.normal3_loc=e.getAttribLocation(t.program,"normal"),t.attribLocationCacheObj.position=e.getAttribLocation(t.program,"position"),t.attribLocationCacheObj.texCoord=e.getAttribLocation(t.program,"texCoord"),t.attribLocationCacheObj.normal=e.getAttribLocation(t.program,"normal"),t.aditionalMov_loc=e.getUniformLocation(t.program,"aditionalPosition"),t.noiseScale2_loc=e.getUniformLocation(t.program,"noiseScale"),t.kernel16_loc=e.getUniformLocation(t.program,"kernel"),t.near_loc=e.getUniformLocation(t.program,"near"),t.far_loc=e.getUniformLocation(t.program,"far"),t.fov_loc=e.getUniformLocation(t.program,"fov"),t.aspectRatio_loc=e.getUniformLocation(t.program,"aspectRatio"),t.screenWidth_loc=e.getUniformLocation(t.program,"screenWidth"),t.screenHeight_loc=e.getUniformLocation(t.program,"screenHeight"),t.shininessValue_loc=e.getUniformLocation(t.program,"shininessValue"),t.hasTexture_loc=e.getUniformLocation(t.program,"hasTexture"),t.color4Aux_loc=e.getUniformLocation(t.program,"vColor4Aux"),t.textureFlipYAxis_loc=e.getUniformLocation(t.program,"textureFlipYAxis"),t.depthTex_loc=e.getUniformLocation(t.program,"depthTex"),t.noiseTex_loc=e.getUniformLocation(t.program,"noiseTex"),t.diffuseTex_loc=e.getUniformLocation(t.program,"diffuseTex"),t.specularColor_loc=e.getUniformLocation(t.program,"specularColor"),t.ssaoRadius_loc=e.getUniformLocation(t.program,"radius"),t.ambientReflectionCoef_loc=e.getUniformLocation(t.program,"ambientReflectionCoef"),t.diffuseReflectionCoef_loc=e.getUniformLocation(t.program,"diffuseReflectionCoef"),t.specularReflectionCoef_loc=e.getUniformLocation(t.program,"specularReflectionCoef"),t};var Shader=function(){if(!(this instanceof Shader))throw new Error(Messages.CONSTRUCT_ERROR);this.shader_name,this.shader_vertex_source,this.shader_fragment_source,this.SHADER_PROGRAM,this.shader_vertex,this.shader_fragment,this._ModelViewProjectionMatrixRelToEye,this._RefTransfMatrix,this._NormalMatrix,this._encodedCamPosHIGH,this._encodedCamPosLOW,this._BuildingPosHIGH,this._BuildingPosLOW,this._lightDirection,this._color,this._position,this._texcoord,this._normal,this.samplerUniform},ShadersManager=function(){if(!(this instanceof ShadersManager))throw new Error(Messages.CONSTRUCT_ERROR);this.shaders_array=[]};ShadersManager.prototype.getMagoShader=function(e){var t;return e>=0&&e<this.shaders_array.length&&(t=this.shaders_array[e]),t},ShadersManager.prototype.getShader=function(e,t,i,o){var r=e.createShader(i);return e.shaderSource(r,t),e.compileShader(r),!!e.getShaderParameter(r,e.COMPILE_STATUS)&&r},ShadersManager.prototype.createDefaultShader=function(e){this.createStandardShader(e),this.createTextureSimpleObjectShader(e),this.createColorSelectionShader(e),this.createTextureSimpleObjectA1Shader(e),this.createCloudShader(e),this.createBlendingCubeShader(e),this.createPCloudShader(e),this.createSimpleObjectTexNormalShader(e)},ShadersManager.prototype.createColorSelectionShader=function(e){var t=new Shader;this.shaders_array.push(t),t.shader_vertex_source=ShaderSource.ColorVS,t.shader_fragment_source=ShaderSource.ColorFS,t.SHADER_PROGRAM=e.createProgram(),t.shader_vertex=this.getShader(e,t.shader_vertex_source,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.getShader(e,t.shader_fragment_source,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.SHADER_PROGRAM,t.shader_vertex),e.attachShader(t.SHADER_PROGRAM,t.shader_fragment),e.linkProgram(t.SHADER_PROGRAM),t._ModelViewProjectionMatrixRelToEye=e.getUniformLocation(t.SHADER_PROGRAM,"ModelViewProjectionMatrixRelToEye"),t._encodedCamPosHIGH=e.getUniformLocation(t.SHADER_PROGRAM,"encodedCameraPositionMCHigh"),t._encodedCamPosLOW=e.getUniformLocation(t.SHADER_PROGRAM,"encodedCameraPositionMCLow"),t._BuildingPosHIGH=e.getUniformLocation(t.SHADER_PROGRAM,"buildingPosHIGH"),t._BuildingPosLOW=e.getUniformLocation(t.SHADER_PROGRAM,"buildingPosLOW"),t._RefTransfMatrix=e.getUniformLocation(t.SHADER_PROGRAM,"RefTransfMatrix"),t._position=e.getAttribLocation(t.SHADER_PROGRAM,"position")},ShadersManager.prototype.createTextureSimpleObjectShader=function(e){var t=new Shader;this.shaders_array.push(t),t.shader_vertex_source=ShaderSource.TextureVS,t.shader_fragment_source=ShaderSource.TextureFS,t.SHADER_PROGRAM=e.createProgram(),t.shader_vertex=this.getShader(e,t.shader_vertex_source,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.getShader(e,t.shader_fragment_source,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.SHADER_PROGRAM,t.shader_vertex),e.attachShader(t.SHADER_PROGRAM,t.shader_fragment),e.linkProgram(t.SHADER_PROGRAM),t._encodedCamPosHIGH=e.getUniformLocation(t.SHADER_PROGRAM,"encodedCameraPositionMCHigh"),t._encodedCamPosLOW=e.getUniformLocation(t.SHADER_PROGRAM,"encodedCameraPositionMCLow"),t._BuildingPosHIGH=e.getUniformLocation(t.SHADER_PROGRAM,"buildingPosHIGH"),t._BuildingPosLOW=e.getUniformLocation(t.SHADER_PROGRAM,"buildingPosLOW"),t._Mmatrix=e.getUniformLocation(t.SHADER_PROGRAM,"Mmatrix"),t._ModelViewProjectionMatrixRelToEye=e.getUniformLocation(t.SHADER_PROGRAM,"ModelViewProjectionMatrixRelToEye"),t.SHADER_PROGRAM.samplerUniform=e.getUniformLocation(t.SHADER_PROGRAM,"uSampler"),t._position=e.getAttribLocation(t.SHADER_PROGRAM,"position"),t._texcoord=e.getAttribLocation(t.SHADER_PROGRAM,"aTextureCoord")},ShadersManager.prototype.createTextureSimpleObjectA1Shader=function(e){var t=new Shader;this.shaders_array.push(t),t.shader_vertex_source=ShaderSource.TextureA1VS,t.shader_fragment_source=ShaderSource.TextureA1FS,t.SHADER_PROGRAM=e.createProgram(),t.shader_vertex=this.getShader(e,t.shader_vertex_source,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.getShader(e,t.shader_fragment_source,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.SHADER_PROGRAM,t.shader_vertex),e.attachShader(t.SHADER_PROGRAM,t.shader_fragment),e.linkProgram(t.SHADER_PROGRAM),t._encodedCamPosHIGH=e.getUniformLocation(t.SHADER_PROGRAM,"encodedCameraPositionMCHigh"),t._encodedCamPosLOW=e.getUniformLocation(t.SHADER_PROGRAM,"encodedCameraPositionMCLow"),t._BuildingPosHIGH=e.getUniformLocation(t.SHADER_PROGRAM,"buildingPosHIGH"),t._BuildingPosLOW=e.getUniformLocation(t.SHADER_PROGRAM,"buildingPosLOW"),t._ModelViewProjectionMatrixRelToEye=e.getUniformLocation(t.SHADER_PROGRAM,"ModelViewProjectionMatrixRelToEye"),t.SHADER_PROGRAM.samplerUniform=e.getUniformLocation(t.SHADER_PROGRAM,"uSampler"),t._position=e.getAttribLocation(t.SHADER_PROGRAM,"position"),t._texcoord=e.getAttribLocation(t.SHADER_PROGRAM,"aTextureCoord")},ShadersManager.prototype.createStandardShader=function(e){var t=new Shader;this.shaders_array.push(t),t.shader_vertex_source=ShaderSource.StandardVS,t.shader_fragment_source=ShaderSource.StandardFS,t.SHADER_PROGRAM=e.createProgram(),t.shader_vertex=this.getShader(e,t.shader_vertex_source,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.getShader(e,t.shader_fragment_source,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.SHADER_PROGRAM,t.shader_vertex),e.attachShader(t.SHADER_PROGRAM,t.shader_fragment),e.linkProgram(t.SHADER_PROGRAM),t._ModelViewProjectionMatrixRelToEye=e.getUniformLocation(t.SHADER_PROGRAM,"ModelViewProjectionMatrixRelToEye"),t._RefTransfMatrix=e.getUniformLocation(t.SHADER_PROGRAM,"RefTransfMatrix"),t._encodedCamPosHIGH=e.getUniformLocation(t.SHADER_PROGRAM,"encodedCameraPositionMCHigh"),t._encodedCamPosLOW=e.getUniformLocation(t.SHADER_PROGRAM,"encodedCameraPositionMCLow"),t._BuildingPosHIGH=e.getUniformLocation(t.SHADER_PROGRAM,"buildingPosHIGH"),t._BuildingPosLOW=e.getUniformLocation(t.SHADER_PROGRAM,"buildingPosLOW"),t._color=e.getAttribLocation(t.SHADER_PROGRAM,"color"),t._position=e.getAttribLocation(t.SHADER_PROGRAM,"position")},ShadersManager.prototype.createCloudShader=function(e){var t=new Shader;this.shaders_array.push(t),t.shader_vertex_source=ShaderSource.CloudVS,t.shader_fragment_source=ShaderSource.CloudFS,t.SHADER_PROGRAM=e.createProgram(),t.shader_vertex=this.getShader(e,t.shader_vertex_source,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.getShader(e,t.shader_fragment_source,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.SHADER_PROGRAM,t.shader_vertex),e.attachShader(t.SHADER_PROGRAM,t.shader_fragment),e.linkProgram(t.SHADER_PROGRAM),t._ModelViewProjectionMatrixRelToEye=e.getUniformLocation(t.SHADER_PROGRAM,"ModelViewProjectionMatrixRelToEye"),t._encodedCamPosHIGH=e.getUniformLocation(t.SHADER_PROGRAM,"encodedCameraPositionMCHigh"),t._encodedCamPosLOW=e.getUniformLocation(t.SHADER_PROGRAM,"encodedCameraPositionMCLow"),t._cloudPosHIGH=e.getUniformLocation(t.SHADER_PROGRAM,"cloudPosHIGH"),t._cloudPosLOW=e.getUniformLocation(t.SHADER_PROGRAM,"cloudPosLOW"),t._color=e.getAttribLocation(t.SHADER_PROGRAM,"color"),t._position=e.getAttribLocation(t.SHADER_PROGRAM,"position")},ShadersManager.prototype.createBlendingCubeShader=function(e){var t=new Shader;this.shaders_array.push(t),t.shader_vertex_source=ShaderSource.BlendingCubeVS,t.shader_fragment_source=ShaderSource.BlendingCubeFS,t.SHADER_PROGRAM=e.createProgram(),t.shader_vertex=this.getShader(e,t.shader_vertex_source,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.getShader(e,t.shader_fragment_source,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.SHADER_PROGRAM,t.shader_vertex),e.attachShader(t.SHADER_PROGRAM,t.shader_fragment),e.linkProgram(t.SHADER_PROGRAM),t._ModelViewProjectionMatrixRelToEye=e.getUniformLocation(t.SHADER_PROGRAM,"ModelViewProjectionMatrixRelToEye"),t._encodedCamPosHIGH=e.getUniformLocation(t.SHADER_PROGRAM,"encodedCameraPositionMCHigh"),t._encodedCamPosLOW=e.getUniformLocation(t.SHADER_PROGRAM,"encodedCameraPositionMCLow"),t._color=e.getAttribLocation(t.SHADER_PROGRAM,"color"),t._position=e.getAttribLocation(t.SHADER_PROGRAM,"position")},ShadersManager.prototype.createPCloudShader=function(e){var t=new Shader;this.shaders_array.push(t),t.shader_vertex_source=ShaderSource.PointCloudVS,t.shader_fragment_source=ShaderSource.PointCloudFS,t.SHADER_PROGRAM=e.createProgram(),t.shader_vertex=this.getShader(e,t.shader_vertex_source,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.getShader(e,t.shader_fragment_source,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.SHADER_PROGRAM,t.shader_vertex),e.attachShader(t.SHADER_PROGRAM,t.shader_fragment),e.linkProgram(t.SHADER_PROGRAM),t._ModelViewProjectionMatrixRelToEye=e.getUniformLocation(t.SHADER_PROGRAM,"ModelViewProjectionMatrixRelToEye"),t._encodedCamPosHIGH=e.getUniformLocation(t.SHADER_PROGRAM,"encodedCameraPositionMCHigh"),t._encodedCamPosLOW=e.getUniformLocation(t.SHADER_PROGRAM,"encodedCameraPositionMCLow"),t._BuildingPosHIGH=e.getUniformLocation(t.SHADER_PROGRAM,"buildingPosHIGH"),t._BuildingPosLOW=e.getUniformLocation(t.SHADER_PROGRAM,"buildingPosLOW"),t._color=e.getAttribLocation(t.SHADER_PROGRAM,"color"),t._position=e.getAttribLocation(t.SHADER_PROGRAM,"position")},ShadersManager.prototype.createSimpleObjectTexNormalShader=function(e){var t=new Shader;this.shaders_array.push(t),t.shader_vertex_source=ShaderSource.TextureNormalVS,t.shader_fragment_source=ShaderSource.TextureNormalFS,t.SHADER_PROGRAM=e.createProgram(),t.shader_vertex=this.getShader(e,t.shader_vertex_source,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.getShader(e,t.shader_fragment_source,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.SHADER_PROGRAM,t.shader_vertex),e.attachShader(t.SHADER_PROGRAM,t.shader_fragment),e.linkProgram(t.SHADER_PROGRAM),t._encodedCamPosHIGH=e.getUniformLocation(t.SHADER_PROGRAM,"encodedCameraPositionMCHigh"),t._encodedCamPosLOW=e.getUniformLocation(t.SHADER_PROGRAM,"encodedCameraPositionMCLow"),t._BuildingPosHIGH=e.getUniformLocation(t.SHADER_PROGRAM,"buildingPosHIGH"),t._BuildingPosLOW=e.getUniformLocation(t.SHADER_PROGRAM,"buildingPosLOW"),t._ModelViewProjectionMatrixRelToEye=e.getUniformLocation(t.SHADER_PROGRAM,"ModelViewProjectionMatrixRelToEye"),t._NormalMatrix=e.getUniformLocation(t.SHADER_PROGRAM,"uNMatrix"),t.samplerUniform=e.getUniformLocation(t.SHADER_PROGRAM,"uSampler"),t._lightDirection=e.getUniformLocation(t.SHADER_PROGRAM,"uLightingDirection"),t._position=e.getAttribLocation(t.SHADER_PROGRAM,"position"),t._texcoord=e.getAttribLocation(t.SHADER_PROGRAM,"aTextureCoord"),t._normal=e.getAttribLocation(t.SHADER_PROGRAM,"aVertexNormal")};var ShaderSource={BlendingCubeFS:"\tprecision lowp float;\n\tvarying vec4 vColor;\n\n\tvoid main()\n    {\n\t\tgl_FragColor = vColor;\n\t}",BlendingCubeVS:"attribute vec3 position;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nattribute vec4 color;\nvarying vec4 vColor;\n\nvoid main()\n{\n    vec3 highDifference = -encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = position.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(position.xyz, 1.0);\n\n    vColor=color;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n}",BlurFS:"#ifdef GL_ES\n    precision highp float;\n    #endif\nuniform sampler2D colorTex;\nuniform vec2 texelSize;\nvarying vec2 vTexCoord; \t \t\n\nvoid main()\n{\n    vec3 result = vec3(0.0);\n    for (int i = 0; i < 4; ++i) {\n        for (int j = 0; j < 4; ++j) {\n            vec2 offset = vec2(texelSize.x * float(j), texelSize.y * float(i));\n            result += texture2D(colorTex, vTexCoord + offset).rgb;\n        }\n    }\n            \n    gl_FragColor.rgb = vec3(result * 0.0625); \n    gl_FragColor.a = 1.0;\n}\n",BlurVS:"attribute vec4 position;\nattribute vec2 texCoord;\n\nuniform mat4 projectionMatrix;\nuniform mat4 modelViewMatrix;  \n\nvarying vec2 vTexCoord;\n\nvoid main()\n{\t\n    vTexCoord = texCoord;\n    \n    gl_Position = projectionMatrix * modelViewMatrix * position;\n}\n",BoxDepthFS:"#ifdef GL_ES\n    precision highp float;\n#endif\nuniform float near;\nuniform float far;\n\nvarying float depth;  \n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625); \n    vec4 res = fract(depth * bit_shift);\n    res -= res.xxyz * bit_mask;\n    return res;  \n}\n\nvoid main()\n{     \n    gl_FragData[0] = packDepth(-depth);\n}\n",BoxDepthVS:"attribute vec3 position;\n\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform vec3 aditionalPosition;\n\nvarying float depth;  \nvoid main()\n{\t\n    vec4 rotatedPos = buildingRotMatrix * vec4(position.xyz + aditionalPosition.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    //linear depth in camera space (0..far)\n    depth = (modelViewMatrixRelToEye * pos4).z/far;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",BoxSsaoFS:"#ifdef GL_ES\n    precision highp float;\n#endif\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool hasTexture;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform vec3 kernel[16];   \nuniform vec4 vColor4Aux;\nuniform bool bUseNormal;\nuniform bool bApplySsao;\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\n\nconst int kernelSize = 16;  \nconst float radius = 0.5;      \n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{                          \n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{ \n\tvec4 textureColor;\n\ttextureColor = vcolor4;  \n\tif(bUseNormal)\n    {\n\t\tif(bApplySsao)\n\t\t{\n\t\t\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n\t\t\tfloat linearDepth = getDepth(screenPos);          \n\t\t\tvec3 origin = getViewRay(screenPos) * linearDepth;   \n\t\t\tvec3 normal2 = vNormal;   \n\t\t\t\t\t\n\t\t\tvec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n\t\t\tvec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n\t\t\tvec3 bitangent = cross(normal2, tangent);\n\t\t\tmat3 tbn = mat3(tangent, bitangent, normal2);        \n\t\t\t\n\t\t\tfloat occlusion = 0.0;\n\t\t\tfor(int i = 0; i < kernelSize; ++i)\n\t\t\t{    \t \n\t\t\t\tvec3 sample = origin + (tbn * kernel[i]) * radius;\n\t\t\t\tvec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n\t\t\t\toffset.xy /= offset.w;\n\t\t\t\toffset.xy = offset.xy * 0.5 + 0.5;        \n\t\t\t\tfloat sampleDepth = -sample.z/far;\n\t\t\t\tfloat depthBufferValue = getDepth(offset.xy);\t\t\t\t              \n\t\t\t\tfloat range_check = abs(linearDepth - depthBufferValue)+radius*0.998;\n\t\t\t\tif (range_check < radius*1.001 && depthBufferValue <= sampleDepth)\n\t\t\t\t{\n\t\t\t\t\tocclusion +=  1.0;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t}   \n\t\t\t\t\n\t\t\tocclusion = 1.0 - occlusion / float(kernelSize);\n\t\t\t\t\t\t\t\t\t\t\n\t\t\tvec3 lightPos = vec3(10.0, 10.0, 10.0);\n\t\t\tvec3 L = normalize(lightPos);\n\t\t\tfloat DiffuseFactor = dot(normal2, L);\n\t\t\tfloat NdotL = abs(DiffuseFactor);\n\t\t\tvec3 diffuse = vec3(NdotL);\n\t\t\tvec3 ambient = vec3(1.0);\n\t\t\tgl_FragColor.rgb = vec3((textureColor.xyz)*vLightWeighting * occlusion); \n\t\t\tgl_FragColor.a = 1.0; \n\t\t}\n\t\telse{\n\t\t\tgl_FragColor.rgb = vec3((textureColor.xyz)*vLightWeighting); \n\t\t\tgl_FragColor.a = 1.0; \n\t\t}\n\t}\n\telse\n\t{\n\t\tgl_FragColor.rgb = vec3(textureColor.xyz); \n\t\tgl_FragColor.a = 1.0; \n\t}\t\n}\n",BoxSsaoVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color4;\n\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec4 oneColor4;\nuniform bool bUse1Color;\nuniform bool bUseNormal;\nuniform vec3 scale;\nuniform bool bScale;\n\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;  \nvarying vec3 uAmbientColor;\nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\n\nvoid main()\n{\t\n    vec4 position2 = vec4(position.xyz, 1.0);\n    if(bScale)\n    {\n        position2.x *= scale.x;\n        position2.y *= scale.y;\n        position2.z *= scale.z;\n    }\n    vec4 rotatedPos = buildingRotMatrix * vec4(position2.xyz + aditionalPosition.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    if(bUseNormal)\n    {\n\t\tvec4 rotatedNormal = buildingRotMatrix * vec4(normal.xyz, 1.0);\n\t\tvLightWeighting = vec3(1.0, 1.0, 1.0);\n\t\tuAmbientColor = vec3(0.8, 0.8, 0.8);\n\t\tvec3 uLightingDirection = vec3(0.5, 0.5, 0.5);\n\t\tvec3 directionalLightColor = vec3(0.6, 0.6, 0.6);\n\t\tvNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n\t\tfloat directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\t}\n    if(bUse1Color)\n    {\n        vcolor4 = oneColor4;\n    }\n    else\n    {\n        vcolor4 = color4;\n    }\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",CloudFS:"precision lowp float;\nvarying vec3 vColor;\n\nvoid main()\n{\n    gl_FragColor = vec4(vColor, 1.);\n}",CloudVS:"attribute vec3 position;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 cloudPosHIGH;\nuniform vec3 cloudPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nattribute vec3 color;\nvarying vec3 vColor;\n\nvoid main()\n{\n    vec3 objPosHigh = cloudPosHIGH;\n    vec3 objPosLow = cloudPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n    vColor=color;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n}",ColorFS:"precision mediump float;\nuniform int byteColor_r;\nuniform int byteColor_g;\nuniform int byteColor_b;\n\nvoid main()\n{\n    float byteMaxValue = 255.0;\n\n    gl_FragColor = vec4(float(byteColor_r)/byteMaxValue, float(byteColor_g)/byteMaxValue, float(byteColor_b)/byteMaxValue, 1);\n}\n",ColorSelectionSsaoFS:"precision highp float;\nuniform vec4 vColor4Aux;\n\nvoid main()\n{          \n    gl_FragColor = vColor4Aux;\n}\n",ColorSelectionSsaoVS:"attribute vec3 position;\n\nuniform mat4 buildingRotMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 RefTransfMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\nvoid main()\n{\n    vec4 rotatedPos;\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    gl_PointSize = 10.0;\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",ColorVS:"attribute vec3 position;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform mat4 RefTransfMatrix;\n\nvoid main()\n{\n    vec4 rotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n}\n",InvertedBoxFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool hasTexture;\nuniform bool textureFlipYAxis;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform float shininessValue;\nuniform vec3 kernel[16];   \nuniform vec4 vColor4Aux;\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\n\nvarying vec3 diffuseColor;\nuniform vec3 specularColor;\nvarying vec3 vertexPos;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{          \n    vec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n    float linearDepth = getDepth(screenPos);          \n    vec3 origin = getViewRay(screenPos) * linearDepth;   \n\n    vec3 normal2 = vNormal;\n            \n    vec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n    vec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n    vec3 bitangent = cross(normal2, tangent);\n    mat3 tbn = mat3(tangent, bitangent, normal2);        \n    \n    float occlusion = 0.0;\n    for(int i = 0; i < kernelSize; ++i)\n    {    \t \n        vec3 sample = origin + (tbn * kernel[i]) * radius;\n        vec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n        offset.xy /= offset.w;\n        offset.xy = offset.xy * 0.5 + 0.5;        \n        float sampleDepth = -sample.z/far;\n\t\tif(sampleDepth > 0.49)\n\t\t\tcontinue;\n        float depthBufferValue = getDepth(offset.xy);\t\t\t\t              \n        float range_check = abs(linearDepth - depthBufferValue)+radius*0.998;\n        if (range_check < radius*1.001 && depthBufferValue <= sampleDepth)\n        {\n            occlusion +=  1.0;\n        }\n    }   \n        \n    occlusion = 1.0 - occlusion / float(kernelSize);\n\n    vec3 lightPos = vec3(20.0, 60.0, 20.0);\n    vec3 L = normalize(lightPos - vertexPos);\n    float lambertian = max(dot(normal2, L), 0.0);\n    float specular = 0.0;\n    if(lambertian > 0.0)\n    {\n        vec3 R = reflect(-L, normal2);      // Reflected light vector\n        vec3 V = normalize(-vertexPos); // Vector to viewer\n        \n        // Compute the specular term\n        float specAngle = max(dot(R, V), 0.0);\n        specular = pow(specAngle, shininessValue);\n    }\n\t\n\tif(lambertian < 0.5)\n    {\n\t\tlambertian = 0.5;\n\t}\n\n    vec4 textureColor;\n    if(hasTexture)\n    {\n        if(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\t\n        if(textureColor.w == 0.0)\n        {\n            discard;\n        }\n    }\n    else{\n        textureColor = vColor4Aux;\n    }\n\t\n\tvec3 ambientColor = vec3(textureColor.x, textureColor.y, textureColor.z);\n\n    gl_FragColor = vec4((ambientReflectionCoef * ambientColor + diffuseReflectionCoef * lambertian * textureColor.xyz + specularReflectionCoef * specular * specularColor)*vLightWeighting * occlusion, 1.0); \n}\n",InvertedBoxVS:"\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\t\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 projectionMatrix;  \n\tuniform mat4 modelViewMatrix;\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 uAmbientColor;\n\tvarying vec3 vLightWeighting;\n\tvarying vec3 vertexPos;\n\t\n\tvoid main()\n    {\t\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\tif(refMatrixType == 0)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 1)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 2)\n\t\t{\n\t\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t\t}\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n\t\tvertexPos = vec3(modelViewMatrixRelToEye * pos4);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\tvLightWeighting = vec3(1.0, 1.0, 1.0);\n\t\tuAmbientColor = vec3(0.8);\n\t\tvec3 uLightingDirection = vec3(0.6, 0.6, 0.6);\n\t\tvec3 directionalLightColor = vec3(0.7, 0.7, 0.7);\n\t\tvNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n\t\tvTexCoord = texCoord;\n\t\tfloat directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t}\n",LegoDepthFS:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform float near;\nuniform float far;\n\nvarying float depth;  \n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625); \n    vec4 res = fract(depth * bit_shift);\n    res -= res.xxyz * bit_mask;\n    return res;  \n}\n\nvoid main()\n{     \n    gl_FragData[0] = packDepth(-depth);\n}\n",LegoDepthVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\n\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 RefTransfMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform vec3 aditionalPosition;\n\nvarying float depth;  \nvoid main()\n{\t\n    vec4 rotatedPos = RefTransfMatrix * vec4(position.xyz + aditionalPosition.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n    depth = (modelViewMatrixRelToEye * pos4).z/far;\n    \n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",LegoSsaoFS:"#ifdef GL_ES\n    precision highp float;\n#endif\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool hasTexture;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform vec3 kernel[16];   \nuniform vec4 vColor4Aux;\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\n\nconst int kernelSize = 16;  \nconst float radius = 0.5;      \n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{                          \n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{          \n    vec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n    float linearDepth = getDepth(screenPos);          \n    vec3 origin = getViewRay(screenPos) * linearDepth;   \n    vec3 normal2 = vNormal;   \n            \n    vec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n    vec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n    vec3 bitangent = cross(normal2, tangent);\n    mat3 tbn = mat3(tangent, bitangent, normal2);        \n    \n    float occlusion = 0.0;\n    for(int i = 0; i < kernelSize; ++i)\n    {    \t \n        vec3 sample = origin + (tbn * kernel[i]) * radius;\n        vec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n        offset.xy /= offset.w;\n        offset.xy = offset.xy * 0.5 + 0.5;        \n        float sampleDepth = -sample.z/far;\n        float depthBufferValue = getDepth(offset.xy);\t\t\t\t              \n        float range_check = abs(linearDepth - depthBufferValue)+radius*0.998;\n        if (range_check < radius*1.001 && depthBufferValue <= sampleDepth)\n        {\n            occlusion +=  1.0;\n        }\n        \n    }   \n        \n    occlusion = 1.0 - occlusion / float(kernelSize);\n                                \n    vec3 lightPos = vec3(10.0, 10.0, 10.0);\n    vec3 L = normalize(lightPos);\n    float DiffuseFactor = dot(normal2, L);\n    float NdotL = abs(DiffuseFactor);\n    vec3 diffuse = vec3(NdotL);\n    vec3 ambient = vec3(1.0);\n    vec4 textureColor;\n    textureColor = vcolor4;\n\n    gl_FragColor.rgb = vec3((textureColor.xyz)*vLightWeighting * occlusion); \n    gl_FragColor.a = 1.0;   \n}\n",LegoSsaoVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color4;\nattribute vec2 texCoord;\n\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 RefTransfMatrix;\nuniform mat4 normalMatrix4;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\n\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;  \nvarying vec3 uAmbientColor;\nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\n\nvoid main()\n{\t\n    vec4 rotatedPos = RefTransfMatrix * vec4(position.xyz + aditionalPosition.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    vec3 rotatedNormal = mat3(RefTransfMatrix) * normal;\n    vLightWeighting = vec3(1.0, 1.0, 1.0);\n    uAmbientColor = vec3(0.8, 0.8, 0.8);\n    vec3 uLightingDirection = vec3(0.5, 0.5, 0.5);\n    vec3 directionalLightColor = vec3(0.6, 0.6, 0.6);\n    vNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n\n    float directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n    vLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n    vcolor4 = color4;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",LodBuildingDepthFS:"#ifdef GL_ES\n    precision highp float;\n#endif\nvarying float depth;  \n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625); \n    vec4 res = fract(depth * bit_shift);\n    res -= res.xxyz * bit_mask;\n    return res;  \n}\n\nvoid main()\n{     \n    gl_FragData[0] = packDepth(-depth);\n}\n",LodBuildingDepthVS:"attribute vec3 position;\n\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform vec3 aditionalPosition;\n\nvarying float depth;  \nvoid main()\n{\t\n    vec4 rotatedPos = buildingRotMatrix * vec4(position.xyz + aditionalPosition.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n        \n    depth = (modelViewMatrixRelToEye * pos4).z/far;\n    \n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",LodBuildingSsaoFS:"#ifdef GL_ES\n    precision highp float;\n#endif\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool hasTexture;\nuniform bool textureFlipYAxis;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;   \nuniform float shininessValue; \nuniform vec3 kernel[16];   \nuniform vec4 vColor4Aux;\nuniform bool bApplyScpecularLighting;\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\nuniform vec3 specularColor;\nvarying vec3 vertexPos;\nvarying float applySpecLighting;\n\nconst int kernelSize = 16;  \nuniform float radius;    \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef;  \n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{                          \n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{          \n    vec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n    float linearDepth = getDepth(screenPos);          \n    vec3 origin = getViewRay(screenPos) * linearDepth;   \n\n    vec3 normal2 = vNormal;   \n            \n    vec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n    vec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n    vec3 bitangent = cross(normal2, tangent);\n    mat3 tbn = mat3(tangent, bitangent, normal2);        \n    \n    float occlusion = 0.0;\n    for(int i = 0; i < kernelSize; ++i)\n    {    \t \n        vec3 sample = origin + (tbn * kernel[i]) * radius;\n        vec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n        offset.xy /= offset.w;\n        offset.xy = offset.xy * 0.5 + 0.5;        \n        float sampleDepth = -sample.z/far;\n\t\tif(sampleDepth > 0.49)\n\t\t\tcontinue;\n        float depthBufferValue = getDepth(offset.xy);\t\t\t\t              \n        float range_check = abs(linearDepth - depthBufferValue)+radius*0.998;\n        if (range_check < radius*1.001 && depthBufferValue <= sampleDepth)\n        {\n            occlusion +=  1.0;\n        }\n        \n    }   \n        \n    occlusion = 1.0 - occlusion / float(kernelSize);\n\n\tfloat lambertian;\n\tfloat specular;\n    if(applySpecLighting > 0.0)\n\t{\n\t\tvec3 lightPos = vec3(20.0, 60.0, 20.0);\n\t\tvec3 L = normalize(lightPos - vertexPos);\n\t\tlambertian = max(dot(normal2, L), 0.0);\n\t\tspecular = 0.0;\n\t\tif(lambertian > 0.0)\n\t\t{\n\t\t\tvec3 R = reflect(-L, normal2);      // Reflected light vector\n\t\t\tvec3 V = normalize(-vertexPos); // Vector to viewer\n\t\t\t\n\t\t\t// Compute the specular term\n\t\t\tfloat specAngle = max(dot(R, V), 0.0);\n\t\t\tspecular = pow(specAngle, shininessValue);\n\t\t}\n\t\t\n\t\tif(lambertian < 0.5)\n\t\t{\n\t\t\tlambertian = 0.5;\n\t\t}\n\t}\n\n    vec4 textureColor;\n    if(hasTexture)\n    {\n        if(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\t\n        if(textureColor.w == 0.0)\n        {\n            discard;\n        }\n    }\n    else{\n        textureColor = vcolor4;\n    }\n\t\n\tvec3 ambientColor = vec3(textureColor.x, textureColor.y, textureColor.z);\n\tvec4 finalColor;\n\tif(applySpecLighting > 0.0)\n\t{\n\t\tfinalColor = vec4((ambientReflectionCoef * ambientColor + diffuseReflectionCoef * lambertian * textureColor.xyz + specularReflectionCoef * specular * specularColor)*vLightWeighting * occlusion, 1.0); \n\t}\n\telse{\n\t\tfinalColor = vec4((textureColor.xyz) * occlusion, 1.0);\n\t}\n    gl_FragColor = finalColor; \n}\n",LodBuildingSsaoSimpleCompressFS:"#ifdef GL_ES\n    precision highp float;\n#endif\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool hasTexture;\nuniform bool textureFlipYAxis;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;   \nuniform vec3 kernel[16];   \nuniform vec4 vColor4Aux;\n\nvarying vec2 vTexCoord;   \nvarying vec4 vcolor4;\nuniform vec3 specularColor;\n\nconst int kernelSize = 16;  \nuniform float radius;     \n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{                          \n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{          \n    vec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n    float linearDepth = getDepth(screenPos);          \n    vec3 origin = getViewRay(screenPos) * linearDepth;   \n\n    vec3 normal2 = vNormal;   \n            \n    vec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n    vec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n    vec3 bitangent = cross(normal2, tangent);\n    mat3 tbn = mat3(tangent, bitangent, normal2);        \n    \n    float occlusion = 0.0;\n    for(int i = 0; i < kernelSize; ++i)\n    {    \t \n        vec3 sample = origin + (tbn * kernel[i]) * radius;\n        vec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n        offset.xy /= offset.w;\n        offset.xy = offset.xy * 0.5 + 0.5;        \n        float sampleDepth = -sample.z/far;\n\t\tif(sampleDepth > 0.49)\n\t\t\tcontinue;\n        float depthBufferValue = getDepth(offset.xy);\t\t\t\t              \n        float range_check = abs(linearDepth - depthBufferValue)+radius*0.998;\n        if (range_check < radius*1.001 && depthBufferValue <= sampleDepth)\n        {\n            occlusion +=  1.0;\n        }\n    }   \n        \n    occlusion = 1.0 - occlusion / float(kernelSize);\n\n    vec4 textureColor;\n    if(hasTexture)\n    {\n        if(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\t\n        if(textureColor.w == 0.0)\n        {\n            discard;\n        }\n    }\n    else{\n        textureColor = vcolor4;\n    }\n\n    gl_FragColor = vec4((textureColor.xyz) * occlusion, 1.0); \n}\n",LodBuildingSsaoSimpleCompressVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color4;\nattribute vec2 texCoord;\n\nuniform sampler2D diffuseTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec4 oneColor4;\nuniform bool bUse1Color;\nuniform bool hasTexture;\n\nuniform int posDataByteSize;\nuniform int texCoordByteSize;\nuniform vec3 compressionMaxPoint;\nuniform vec3 compressionMinPoint;\n\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\n\nvoid main()\n{\t\n    vec3 finalPos;\n\tvec2 finalTexCoord;\n\tif(posDataByteSize == 2)\n\t{\n\t\t// Decompress the position.*** \n\t\tfloat rangeX = compressionMaxPoint.x - compressionMinPoint.x;\n\t\tfloat rangeY = compressionMaxPoint.y - compressionMinPoint.y;\n\t\tfloat rangeZ = compressionMaxPoint.z - compressionMinPoint.z;\n\t\tfloat shortMax = 65535.0;\n\t\tfinalPos.x = (float(position.x) * rangeX / shortMax) + compressionMinPoint.x;\n\t\tfinalPos.y = (float(position.y) * rangeY / shortMax) + compressionMinPoint.y;\n\t\tfinalPos.z = (float(position.z) * rangeZ / shortMax) + compressionMinPoint.z;\n\t}\n\telse{\n\t\tfinalPos = position;\n\t}\n\tvec4 rotatedPos = buildingRotMatrix * vec4(finalPos.xyz + aditionalPosition.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    vec4 rotatedNormal = buildingRotMatrix * vec4(normal.xyz, 1.0);\n    vNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n\n    if(bUse1Color)\n    {\n        vcolor4 = oneColor4;\n    }\n    else\n    {\n        vcolor4 = color4;\n    }\n\t\n    if(texCoordByteSize == 2)\n\t{\n\t\t// Decompress the texCoord.***\n\t\tfloat shortMax = 65535.0;\n\t\tfinalTexCoord.x = float(texCoord.x) / shortMax;\n\t\tfinalTexCoord.y = float(texCoord.y) / shortMax;\n\t}\n\telse\n\t{\n\t\tfinalTexCoord = texCoord;\n\t}\n    vTexCoord = finalTexCoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",LodBuildingSsaoSimpleFS:"#ifdef GL_ES\n    precision highp float;\n#endif\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool hasTexture;\nuniform bool textureFlipYAxis;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;   \nuniform vec3 kernel[16];   \nuniform vec4 vColor4Aux;\n\nvarying vec2 vTexCoord;   \nvarying vec4 vcolor4;\nuniform vec3 specularColor;\n\nconst int kernelSize = 16;  \nuniform float radius;     \n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{                          \n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{          \n    vec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n    float linearDepth = getDepth(screenPos);          \n    vec3 origin = getViewRay(screenPos) * linearDepth;   \n\n    vec3 normal2 = vNormal;   \n            \n    vec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n    vec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n    vec3 bitangent = cross(normal2, tangent);\n    mat3 tbn = mat3(tangent, bitangent, normal2);        \n    \n    float occlusion = 0.0;\n    for(int i = 0; i < kernelSize; ++i)\n    {    \t \n        vec3 sample = origin + (tbn * kernel[i]) * radius;\n        vec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n        offset.xy /= offset.w;\n        offset.xy = offset.xy * 0.5 + 0.5;        \n        float sampleDepth = -sample.z/far;\n\t\tif(sampleDepth > 0.49)\n\t\t\tcontinue;\n        float depthBufferValue = getDepth(offset.xy);\t\t\t\t              \n        float range_check = abs(linearDepth - depthBufferValue)+radius*0.998;\n        if (range_check < radius*1.001 && depthBufferValue <= sampleDepth)\n        {\n            occlusion +=  1.0;\n        }\n    }   \n        \n    occlusion = 1.0 - occlusion / float(kernelSize);\n\n    vec4 textureColor;\n    if(hasTexture)\n    {\n        if(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\t\n        if(textureColor.w == 0.0)\n        {\n            discard;\n        }\n    }\n    else{\n        textureColor = vcolor4;\n    }\n\n    gl_FragColor = vec4((textureColor.xyz) * occlusion, 1.0); \n}\n",LodBuildingSsaoSimpleVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color4;\nattribute vec2 texCoord;\n\nuniform sampler2D diffuseTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec4 oneColor4;\nuniform bool bUse1Color;\nuniform bool hasTexture;\n\nvarying vec2 vTexCoord;   \nvarying vec4 vcolor4;\n\nvoid main()\n{\t\n    vec4 rotatedPos = buildingRotMatrix * vec4(position.xyz + aditionalPosition.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n    if(bUse1Color)\n    {\n        vcolor4 = oneColor4;\n    }\n    else\n    {\n        vcolor4 = color4;\n    }\n    vTexCoord = texCoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}",LodBuildingSsaoVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color4;\nattribute vec2 texCoord;\n\nuniform sampler2D diffuseTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec4 oneColor4;\nuniform bool bUse1Color;\nuniform bool hasTexture;\nuniform bool bApplySpecularLighting;\n\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;   \nvarying vec3 uAmbientColor;\nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\nvarying vec3 vertexPos;\nvarying float applySpecLighting;\n\nvoid main()\n{\t\n    vec4 rotatedPos = buildingRotMatrix * vec4(position.xyz + aditionalPosition.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n\tvertexPos = vec3(modelViewMatrixRelToEye * pos4);\n    vec4 rotatedNormal = buildingRotMatrix * vec4(normal.xyz, 1.0);\n    vLightWeighting = vec3(1.0, 1.0, 1.0);\n    uAmbientColor = vec3(0.8, 0.8, 0.8);\n    vec3 uLightingDirection = vec3(0.6, 0.6, 0.6);\n    vec3 directionalLightColor = vec3(0.7, 0.7, 0.7);\n    vNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n    float directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n    vLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\t\n\tif(bApplySpecularLighting)\n\t\t\tapplySpecLighting = 1.0;\n\t\telse\n\t\t\tapplySpecLighting = -1.0;\n\n    if(bUse1Color)\n    {\n        vcolor4 = oneColor4;\n    }\n    else\n    {\n        vcolor4 = color4;\n    }\n    vTexCoord = texCoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",ModelRefSsaoFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool hasTexture;\nuniform bool textureFlipYAxis;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform float shininessValue;\nuniform vec3 kernel[16];   \nuniform vec4 oneColor4;\nuniform bool bApplyScpecularLighting;\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\n\nvarying vec3 diffuseColor;\nuniform vec3 specularColor;\nvarying vec3 vertexPos;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \nvarying float applySpecLighting;\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{          \n    vec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n    float linearDepth = getDepth(screenPos);          \n    vec3 origin = getViewRay(screenPos) * linearDepth;   \n\n    vec3 normal2 = vNormal;\n            \n    vec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n    vec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n    vec3 bitangent = cross(normal2, tangent);\n    mat3 tbn = mat3(tangent, bitangent, normal2);        \n    \n    float occlusion = 0.0;\n    for(int i = 0; i < kernelSize; ++i)\n    {    \t \n        vec3 sample = origin + (tbn * kernel[i]) * radius;\n        vec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n        offset.xy /= offset.w;\n        offset.xy = offset.xy * 0.5 + 0.5;        \n        float sampleDepth = -sample.z/far;\n\t\tif(sampleDepth > 0.49)\n\t\t\tcontinue;\n        float depthBufferValue = getDepth(offset.xy);\t\t\t\t              \n        float range_check = abs(linearDepth - depthBufferValue)+radius*0.998;\n        if (range_check < radius*1.001 && depthBufferValue <= sampleDepth)\n        {\n            occlusion +=  1.0;\n        }\n    }   \n        \n    occlusion = 1.0 - occlusion / float(kernelSize);\n\n    // Do specular lighting.***\n\tfloat lambertian;\n\tfloat specular;\n\t\t\n\tif(applySpecLighting> 0.0)\n\t{\n\t\tvec3 lightPos = vec3(20.0, 60.0, 20.0);\n\t\tvec3 L = normalize(lightPos - vertexPos);\n\t\tlambertian = max(dot(normal2, L), 0.0);\n\t\tspecular = 0.0;\n\t\tif(lambertian > 0.0)\n\t\t{\n\t\t\tvec3 R = reflect(-L, normal2);      // Reflected light vector\n\t\t\tvec3 V = normalize(-vertexPos); // Vector to viewer\n\t\t\t\n\t\t\t// Compute the specular term\n\t\t\tfloat specAngle = max(dot(R, V), 0.0);\n\t\t\tspecular = pow(specAngle, shininessValue);\n\t\t}\n\t\t\n\t\tif(lambertian < 0.5)\n\t\t{\n\t\t\tlambertian = 0.5;\n\t\t}\n\t}\n\n    vec4 textureColor;\n    if(hasTexture)\n    {\n        if(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\t\n        if(textureColor.w == 0.0)\n        {\n            discard;\n        }\n    }\n    else{\n        textureColor = oneColor4;\n    }\n\t\n\tvec3 ambientColor = vec3(textureColor.x, textureColor.y, textureColor.z);\n\tfloat alfa = textureColor.w;\n\n    vec4 finalColor;\n\tif(applySpecLighting> 0.0)\n\t{\n\t\tfinalColor = vec4((ambientReflectionCoef * ambientColor + diffuseReflectionCoef * lambertian * textureColor.xyz + specularReflectionCoef * specular * specularColor)*vLightWeighting * occlusion, alfa); \n\t}\n\telse{\n\t\tfinalColor = vec4((textureColor.xyz) * occlusion, alfa);\n\t}\n    gl_FragColor = finalColor; \n}\n",ModelRefSsaoSimpleFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool hasTexture;\nuniform bool textureFlipYAxis;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform float shininessValue;\nuniform vec3 kernel[16];   \nuniform vec4 oneColor4;\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\n\nvarying vec3 diffuseColor;\nuniform vec3 specularColor;\nvarying vec3 vertexPos;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{          \n    vec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n    float linearDepth = getDepth(screenPos);          \n    vec3 origin = getViewRay(screenPos) * linearDepth;   \n\n    vec3 normal2 = vNormal;\n            \n    vec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n    vec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n    vec3 bitangent = cross(normal2, tangent);\n    mat3 tbn = mat3(tangent, bitangent, normal2);        \n    \n    float occlusion = 0.0;\n    for(int i = 0; i < kernelSize; ++i)\n    {    \t \n        vec3 sample = origin + (tbn * kernel[i]) * radius;\n        vec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n        offset.xy /= offset.w;\n        offset.xy = offset.xy * 0.5 + 0.5;        \n        float sampleDepth = -sample.z/far;\n\t\tif(sampleDepth > 0.49)\n\t\t\tcontinue;\n        float depthBufferValue = getDepth(offset.xy);\t\t\t\t              \n        float range_check = abs(linearDepth - depthBufferValue)+radius*0.998;\n        if (range_check < radius*1.001 && depthBufferValue <= sampleDepth)\n        {\n            occlusion +=  1.0;\n        }\n    }   \n        \n    occlusion = 1.0 - occlusion / float(kernelSize);\n\n    vec4 textureColor;\n    if(hasTexture)\n    {\n        if(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\t\n        if(textureColor.w == 0.0)\n        {\n            discard;\n        }\n    }\n    else{\n        textureColor = oneColor4;\n    }\n\t\n\tgl_FragColor = vec4((textureColor.xyz) * occlusion, 1.0); \n}\n",ModelRefSsaoSimpleVS:"\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\t\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 projectionMatrix;  \n\tuniform mat4 modelViewMatrix;\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 uAmbientColor;\n\tvarying vec3 vLightWeighting;\n\tvarying vec3 vertexPos;\n\t\n\tvoid main()\n    {\t\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\tif(refMatrixType == 0)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 1)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 2)\n\t\t{\n\t\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t\t}\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n\t\tvertexPos = vec3(modelViewMatrixRelToEye * pos4);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\tvLightWeighting = vec3(1.0, 1.0, 1.0);\n\t\tuAmbientColor = vec3(0.8);\n\t\tvec3 uLightingDirection = vec3(0.6, 0.6, 0.6);\n\t\tvec3 directionalLightColor = vec3(0.7, 0.7, 0.7);\n\t\tvNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n\t\tvTexCoord = texCoord;\n\t\tfloat directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t}\n",ModelRefSsaoVS:"\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\t\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 projectionMatrix;  \n\tuniform mat4 modelViewMatrix;\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\tuniform bool bApplySpecularLighting;\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 uAmbientColor;\n\tvarying vec3 vLightWeighting;\n\tvarying vec3 vertexPos;\n\tvarying float applySpecLighting;\n\t\n\tvoid main()\n    {\t\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\tif(refMatrixType == 0)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 1)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 2)\n\t\t{\n\t\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t\t}\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n\t\tvertexPos = vec3(modelViewMatrixRelToEye * pos4);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\tvLightWeighting = vec3(1.0, 1.0, 1.0);\n\t\tuAmbientColor = vec3(0.8);\n\t\tvec3 uLightingDirection = vec3(0.6, 0.6, 0.6);\n\t\tvec3 directionalLightColor = vec3(0.7, 0.7, 0.7);\n\t\tvNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n\t\tvTexCoord = texCoord;\n\t\tfloat directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\t\t\n\t\tif(bApplySpecularLighting)\n\t\t\tapplySpecLighting = 1.0;\n\t\telse\n\t\t\tapplySpecLighting = -1.0;\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t}\n",PngImageFS:"precision mediump float;\nvarying vec2 v_texcoord;\nuniform bool textureFlipYAxis;\nuniform sampler2D u_texture;\n\nvoid main()\n{\n    vec4 textureColor;\n    if(textureFlipYAxis)\n    {\n        textureColor = texture2D(u_texture, vec2(v_texcoord.s, 1.0 - v_texcoord.t));\n    }\n    else\n    {\n        textureColor = texture2D(u_texture, v_texcoord);\n    }\n    if(textureColor.w < 0.1)\n    {\n        discard;\n    }\n\n    gl_FragColor = textureColor;\n}",PngImageVS:"attribute vec3 a_position;\nattribute vec2 a_texcoord;\nuniform mat4 buildingRotMatrix;  \nuniform mat4 ModelViewProjectionMatrixRelToEye;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nvarying vec2 v_texcoord;\n\nvoid main()\n{\n    vec4 position2 = vec4(a_position.xyz, 1.0);\n    vec4 rotatedPos = buildingRotMatrix * vec4(position2.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n    v_texcoord = a_texcoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",PointCloudFS:"\tprecision lowp float;\n\tvarying vec4 vColor;\n\n\tvoid main()\n    {\n\t\tgl_FragColor = vColor;\n\t}",PointCloudVS:"attribute vec3 position;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform mat4 buildingRotMatrix;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform bool bPositionCompressed;\nuniform vec3 minPosition;\nuniform vec3 bboxSize;\nattribute vec4 color4;\nvarying vec4 vColor;\n\nvoid main()\n{\n\tvec3 realPos;\n\tvec4 rotatedPos;\n\tif(bPositionCompressed)\n\t{\n\t\tfloat maxShort = 65535.0;\n\t\trealPos = vec3(float(position.x)/maxShort*bboxSize.x + minPosition.x, float(position.y)/maxShort*bboxSize.y + minPosition.y, float(position.z)/maxShort*bboxSize.z + minPosition.z);\n\t}\n\telse\n\t{\n\t\trealPos = position;\n\t}\n\trotatedPos = buildingRotMatrix * vec4(realPos.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n    vColor=color4;\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n\tgl_PointSize = 1.0 + 50.0/gl_Position.z;\n\tif(gl_PointSize > 10.0)\n\t\tgl_PointSize = 10.0;\n}",RenderShowDepthFS:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform float near;\nuniform float far;\n\nvarying float depth;  \n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625); \n    vec4 res = fract(depth * bit_shift);\n    res -= res.xxyz * bit_mask;\n    return res;  \n}\n\nvoid main()\n{     \n    gl_FragData[0] = packDepth(-depth);\n}\n",RenderShowDepthVS:"attribute vec3 position;\n\nuniform mat4 buildingRotMatrix; \nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 RefTransfMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\nvarying float depth;\n  \nvoid main()\n{\t\n\tvec4 rotatedPos;\n\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    //linear depth in camera space (0..far)\n    depth = (modelViewMatrixRelToEye * pos4).z/far;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\tgl_PointSize = 2.0;\n}\n",ShowDepthFS:"#ifdef GL_ES\n    precision highp float;\n#endif\nuniform float near;\nuniform float far;\n\nvarying float depth;  \nvarying vec3 vN; \nvarying vec4 vVSPos;\n\n// from http://spidergl.org/example.php?id=6\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625); \n    vec4 res = fract(depth * bit_shift);\n    res -= res.xxyz * bit_mask;\n\n    return res;  \n}\n\nvoid main()\n{\n    gl_FragData[0] = packDepth(-depth);\n    gl_FragData[0].r = -depth/far;\n}\n",ShowDepthVS:"attribute vec3 position;\nattribute vec3 normal;\n\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix3;\nuniform mat4 normalMatrix4;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\n\nvarying vec3 vN;\nvarying float depth;  \nvarying vec4 vVSPos;\n\nvoid main()\n{\t\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n    vN = normalize((normalMatrix4 * vec4(normal, 1.0)).xyz);\n    \n    //linear depth in camera space (0..far)\n    depth = (modelViewMatrixRelToEye * pos4).z/far;\n    vVSPos = modelViewMatrixRelToEye * pos4;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",SilhouetteFS:"precision highp float;\nuniform vec4 vColor4Aux;\n\nvoid main()\n{          \n    gl_FragColor = vColor4Aux;\n}",SilhouetteVS:"attribute vec3 position;\n\nuniform mat4 buildingRotMatrix; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 ModelViewMatrixRelToEye;\nuniform mat4 ProjectionMatrix;\nuniform mat4 RefTransfMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\nuniform vec2 camSpacePixelTranslation;\nuniform vec2 screenSize;    \nvarying vec2 camSpaceTranslation;\n\nvoid main()\n{    \n    vec4 rotatedPos;\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    vec4 camSpacePos = ModelViewMatrixRelToEye * pos4;\n    vec4 translationVec = ProjectionMatrix * vec4(camSpacePixelTranslation.x*(-camSpacePos.z), camSpacePixelTranslation.y*(-camSpacePos.z), 0.0, 1.0);\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n    gl_Position += translationVec;  \n}",SimpleDepthSsaoFS:"precision highp float;\nconst vec4 bitEnc = vec4(1.0,255.0,65025.0,16581375.0);\nconst vec4 bitDec = 1.0/bitEnc;\nvarying float zDepth;\n\nvec4 EncodeFloatRGBA (float v)\n{\n    vec4 enc = bitEnc * v;\n    enc = fract(enc);\n    enc -= enc.yzww * vec2(1.0/255.0, 0.0).xxxy;\n    return enc;\n}\n\nvoid main()\n{          \n    vec4 encodedZ = EncodeFloatRGBA(zDepth);\n    gl_FragData[0] = encodedZ;\n}\n",SimpleDepthSsaoVS:"attribute vec3 position;\n\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 RefTransfMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nvarying float zDepth;\nuniform float far;\n\nvoid main()\n{\t\n    vec4 rotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    zDepth = (modelViewMatrixRelToEye * pos4).z/far;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",SsaoFS:"#ifdef GL_ES\n    precision highp float;\n#endif\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform vec3 kernel[16];   \n\nvarying vec2 vTexCoord;   \n\nconst int kernelSize = 16;  \nconst float radius = 1.0;      \n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{                          \n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{          \n    vec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n    float linearDepth = getDepth(screenPos);          \n    vec3 origin = getViewRay(screenPos) * linearDepth;   \n \n    vec3 normal2 = vNormal;   \n            \n    vec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n    vec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n    vec3 bitangent = cross(normal2, tangent);\n    mat3 tbn = mat3(tangent, bitangent, normal2);        \n    \n    float occlusion = 0.0;\n    for(int i = 0; i < kernelSize; ++i)\n    {    \t \n        vec3 sample = origin + (tbn * kernel[i]) * radius;\n        vec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n        offset.xy /= offset.w;\n        offset.xy = offset.xy * 0.5 + 0.5;        \n        float sampleDepth = -sample.z/far;\n        float depthBufferValue = getDepth(offset.xy);\t\t\t\t              \n\n        float range_check = abs(linearDepth - depthBufferValue)+radius*0.998;\n        if (range_check < radius && depthBufferValue <= sampleDepth)\n        {\n            occlusion +=  1.0;\n        }\n        \n    }   \n        \n    occlusion = 1.0 - (occlusion) / float(kernelSize);\n                                \n    vec3 lightPos = vec3(10.0, 10.0, 10.0);\n    vec3 L = normalize(lightPos);\n    float NdotL = abs(dot(normal2, L));\n    vec3 diffuse = vec3(NdotL);\n    vec3 ambient = vec3(1.0);\n    vec4 textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n\n    gl_FragColor.rgb = vec3((textureColor.xyz*0.2 + textureColor.xyz*0.8) * occlusion); // with texture.***\n    gl_FragColor.a = 1.0;   \n}\n",SsaoVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\n\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;  \n\nvoid main()\n{\t\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n    vNormal = (normalMatrix4 * vec4(-normal.x, -normal.y, -normal.z, 1.0)).xyz;\n    vTexCoord = texCoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}",StandardFS:"precision lowp float;\nvarying vec3 vColor;\n\nvoid main()\n{\n    gl_FragColor = vec4(vColor, 1.);\n}",StandardVS:"attribute vec3 position;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform mat4 RefTransfMatrix;\nattribute vec3 color;\nvarying vec3 vColor;\n\nvoid main()\n{\n    vec4 rotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n \n    vColor=color;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n}",TextureA1FS:"precision mediump float;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\nuniform sampler2D uSampler;\n\nvoid main()\n{\n    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n}\n",TextureA1VS:"attribute vec3 position;\nattribute vec4 aVertexColor;\nattribute vec2 aTextureCoord;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\n\nvoid main()\n{\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n \n    vColor=aVertexColor;\n    vTextureCoord = aTextureCoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n}",TextureFS:"precision mediump float;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\nuniform sampler2D uSampler;\n\nvoid main()\n{\n    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n}",TextureNormalFS:"\tprecision mediump float;\n\tvarying vec4 vColor;\n\tvarying vec2 vTextureCoord;\n\tuniform sampler2D uSampler;\n\tvarying vec3 vLightWeighting;\n\n\tvoid main()\n    {\n\t\tvec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n        \n\t\tgl_FragColor = vec4(textureColor.rgb * vLightWeighting, textureColor.a);\n\t}\n",TextureNormalVS:"attribute vec3 position;\nattribute vec4 aVertexColor;\nattribute vec2 aTextureCoord;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\nattribute vec3 aVertexNormal;\nvarying vec3 uAmbientColor;\nvarying vec3 vLightWeighting;\nuniform mat3 uNMatrix;\n\nvoid main()\n{\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    vColor = aVertexColor;\n    vTextureCoord = aTextureCoord;\n    \n    vLightWeighting = vec3(1.0, 1.0, 1.0);\n    uAmbientColor = vec3(0.7, 0.7, 0.7);\n    vec3 uLightingDirection = vec3(0.8, 0.2, -0.9);\n    vec3 directionalLightColor = vec3(0.4, 0.4, 0.4);\n    vec3 transformedNormal = uNMatrix * aVertexNormal;\n    float directionalLightWeighting = max(dot(transformedNormal, uLightingDirection), 0.0);\n    vLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n}\n",TextureVS:"attribute vec3 position;\nattribute vec4 aVertexColor;\nattribute vec2 aTextureCoord;\nuniform mat4 Mmatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\n\nvoid main()\n{\n    vec4 rotatedPos = Mmatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n    vColor=aVertexColor;\n    vTextureCoord = aTextureCoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n    \n}",TinTerrainFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool hasTexture;\nuniform bool textureFlipYAxis;\nuniform bool bIsMakingDepth;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform float shininessValue;\nuniform vec3 kernel[16];   \nuniform vec4 vColor4Aux;\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\n\nvarying vec3 diffuseColor;\nuniform vec3 specularColor;\nvarying vec3 vertexPos;\nvarying float depthValue;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n} \n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625); \n    vec4 res = fract(depth * bit_shift);\n    res -= res.xxyz * bit_mask;\n    return res;  \n}               \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{           \n\tif(bIsMakingDepth)\n\t{\n\t\tgl_FragColor = packDepth(-depthValue);\n\t}\n\telse{\n\t\tvec4 textureColor;\n\t\tif(hasTexture)\n\t\t{\n\t\t\tif(textureFlipYAxis)\n\t\t\t{\n\t\t\t\ttextureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n\t\t\t}\n\t\t\telse{\n\t\t\t\ttextureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n\t\t\t}\n\t\t\t\n\t\t\tif(textureColor.w == 0.0)\n\t\t\t{\n\t\t\t\tdiscard;\n\t\t\t}\n\t\t}\n\t\telse{\n\t\t\ttextureColor = vColor4Aux;\n\t\t}\n\t\t//vec3 ambientColor = vec3(textureColor.x, textureColor.y, textureColor.z);\n\t\tgl_FragColor = vec4(textureColor.xyz, 1.0); \n\t}\n}",TinTerrainVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color4;\nattribute vec2 texCoord;\n\nuniform sampler2D diffuseTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 ModelViewProjectionMatrix;\nuniform mat4 normalMatrix4;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec4 oneColor4;\nuniform bool bUse1Color;\nuniform bool hasTexture;\nuniform bool bIsMakingDepth;\nuniform float near;\nuniform float far;\n\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;   \nvarying vec3 uAmbientColor;\nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\nvarying vec3 vertexPos;\nvarying float depthValue;\n\nvoid main()\n{\t\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n\tif(bIsMakingDepth)\n\t{\n\t\tdepthValue = (modelViewMatrixRelToEye * pos4).z/far;\n\t}\n\telse\n\t{\n\t\tvTexCoord = texCoord;\n\t}\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t\n}"},MAGO3DJS_MESSAGE=new Object,Renderer=function(){if(!(this instanceof Renderer))throw new Error(Messages.CONSTRUCT_ERROR);this.renderNormals=!0,this.renderTexture=!0,this.vbo_vi_cacheKey_aux,this.byteColorAux=new ByteColor,this.currentTimeSC,this.dateSC,this.startTimeSC,this.simpObj_scratch};Renderer.prototype.renderRenderables=function(e,t,i,o,r,n,a,s){for(var l=t.length,c=0;c<l;c++)t[c].data.neoBuilding.currentLod},Renderer.prototype.renderVboContainer=function(e,t,i,o,r){if(void 0!==t)for(var n,a=t.vboCacheKeysArray.length,s=0;s<a;s++)if(this.vbo_vi_cacheKey_aux=t.vboCacheKeysArray[s],this.vbo_vi_cacheKey_aux.isReadyPositions(e,i.vboMemoryManager)){if(this.vbo_vi_cacheKey_aux.isReadyNormals(e,i.vboMemoryManager),this.vbo_vi_cacheKey_aux.isReadyFaces(e,i.vboMemoryManager),e.bindBuffer(e.ARRAY_BUFFER,this.vbo_vi_cacheKey_aux.meshVertexCacheKey),e.vertexAttribPointer(o.position3_loc,3,e.FLOAT,!1,0,0),-1!==o.normal3_loc&&this.renderNormals?(e.enableVertexAttribArray(o.normal3_loc),e.bindBuffer(e.ARRAY_BUFFER,this.vbo_vi_cacheKey_aux.meshNormalCacheKey),e.vertexAttribPointer(o.normal3_loc,3,e.BYTE,!0,0,0)):e.disableVertexAttribArray(o.normal3_loc),-1!==o.texCoord2_loc&&this.renderTexture){if(!this.vbo_vi_cacheKey_aux.isReadyTexCoords(e,i.vboMemoryManager))continue;e.enableVertexAttribArray(o.texCoord2_loc),e.bindBuffer(e.ARRAY_BUFFER,this.vbo_vi_cacheKey_aux.meshTexcoordsCacheKey),e.vertexAttribPointer(o.texCoord2_loc,2,e.FLOAT,!1,0,0)}else-1!==o.texCoord2_loc&&e.disableVertexAttribArray(o.texCoord2_loc);n=(i.isCameraMoving,this.vbo_vi_cacheKey_aux.indicesCount),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.vbo_vi_cacheKey_aux.meshFacesCacheKey),r?e.drawElements(e.LINES,this.vbo_vi_cacheKey_aux.indicesCount,e.UNSIGNED_SHORT,0):e.drawElements(e.TRIANGLES,n,e.UNSIGNED_SHORT,0)}},Renderer.prototype.renderNodes=function(e,t,i,o,r,n,a,s){var l,c,h,d,u,f=0;e.enable(e.DEPTH_TEST),"true"===MagoConfig.getPolicy().geo_cull_face_enable?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),e.enable(e.CULL_FACE),e.frontFace(e.CCW);for(var g=!1,p=t.length,m=0;m<p;m++){c=(l=t[m]).getRoot().data.geoLocDataManager,h=l.data.neoBuilding;var y=i.hierarchyManager.getNodesMap(l.data.projectId);if(void 0!==y.attributes&&void 0!==y.attributes.specularLighting&&void 0!==o.bApplySpecularLighting_loc)y.attributes.specularLighting?e.uniform1i(o.bApplySpecularLighting_loc,!0):e.uniform1i(o.bApplySpecularLighting_loc,!1);if(void 0!==h.currentVisibleOctreesControler){g=void 0!==l.data.attributes.flipYTexCoords&&l.data.attributes.flipYTexCoords,e.uniform1i(o.textureFlipYAxis_loc,g);var v=c.getCurrentGeoLocationData();e.uniformMatrix4fv(o.buildingRotMatrix_loc,!1,v.rotMatrix._floatArrays),e.uniform3fv(o.buildingPosHIGH_loc,v.positionHIGH),e.uniform3fv(o.buildingPosLOW_loc,v.positionLOW),0===n?r=!1:1===n&&(r=!!(h.texturesLoaded&&h.texturesLoaded.length>0),i.magoPolicy.getObjectMoveMode()===CODE.moveMode.ALL&&i.buildingSelected===h&&this.enableStencilBuffer(e)),f=0,d=h.currentVisibleOctreesControler.currentVisibles0.length;for(var x=0;x<d;x++)void 0!==(u=h.currentVisibleOctreesControler.currentVisibles0[x]).neoReferencesMotherAndIndices&&this.renderNeoRefListsAsimetricVersion(e,u.neoReferencesMotherAndIndices,h,i,!1,o,r,n,f,0,s);f=.45,d=h.currentVisibleOctreesControler.currentVisibles1.length;for(x=0;x<d;x++)void 0!==(u=h.currentVisibleOctreesControler.currentVisibles1[x]).neoReferencesMotherAndIndices&&this.renderNeoRefListsAsimetricVersion(e,u.neoReferencesMotherAndIndices,h,i,!1,o,r,n,f,1,s);1===n&&i.magoPolicy.getObjectMoveMode()===CODE.moveMode.ALL&&i.buildingSelected===h&&this.disableStencilBuffer(e)}}},Renderer.prototype.renderNeoBuildingsLOD2AsimetricVersion=function(e,t,i,o,r,n){for(var a,s,l,c,h,d,u=t.length,f=0;f<u;f++)if(s=(a=t[f]).getRoot().data.geoLocDataManager,void 0!==(l=a.data.neoBuilding).currentVisibleOctreesControler&&0!==(c=l.currentVisibleOctreesControler.currentVisibles2.length)){1===n&&i.magoPolicy.getObjectMoveMode()===CODE.moveMode.ALL&&i.buildingSelected===l&&this.enableStencilBuffer(e);var g=i.hierarchyManager.getNodesMap(a.data.projectId);if(void 0!==g.attributes&&void 0!==g.attributes.specularLighting&&void 0!==o.bApplySpecularLighting_loc)g.attributes.specularLighting?e.uniform1i(o.bApplySpecularLighting_loc,!0):e.uniform1i(o.bApplySpecularLighting_loc,!1);var p=s.getCurrentGeoLocationData();e.uniformMatrix4fv(o.buildingRotMatrix_loc,!1,p.rotMatrix._floatArrays),e.uniform3fv(o.buildingPosHIGH_loc,p.positionHIGH),e.uniform3fv(o.buildingPosLOW_loc,p.positionLOW);for(var m=0;m<c;m++)void 0!==(h=l.currentVisibleOctreesControler.currentVisibles2[m]).lego?h.lego.fileLoadState===CODE.fileLoadState.PARSE_FINISHED&&(1===n&&(l.isHighLighted?(e.uniform1i(o.bUse1Color_loc,!0),e.uniform4fv(o.oneColor4_loc,this.highLightColor4)):l.isColorChanged?(e.uniform1i(o.bUse1Color_loc,!0),e.uniform4fv(o.oneColor4_loc,[l.aditionalColor.r,l.aditionalColor.g,l.aditionalColor.b,l.aditionalColor.a])):e.uniform1i(o.bUse1Color_loc,!1),r=!0,void 0!==l.simpleBuilding3x3Texture&&l.simpleBuilding3x3Texture.texId?(e.enableVertexAttribArray(o.texCoord2_loc),e.uniform1i(o.hasTexture_loc,!0),d!==l.simpleBuilding3x3Texture.texId&&(e.bindTexture(e.TEXTURE_2D,l.simpleBuilding3x3Texture.texId),d=l.simpleBuilding3x3Texture.texId)):(e.uniform1i(o.hasTexture_loc,!1),e.disableVertexAttribArray(o.texCoord2_loc),r=!1)),this.renderLodBuilding(e,h.lego,i,o,n,r)):(h.lego=new Lego,h.lego.fileLoadState=CODE.fileLoadState.READY,h.lego.legoKey=h.octreeKey+"_lego");1===n&&i.magoPolicy.getObjectMoveMode()===CODE.moveMode.ALL&&i.buildingSelected===l&&this.disableStencilBuffer(e)}},Renderer.prototype.renderPCloud=function(e,t,i,o,r,n,a,s,l){if(0!==t.vbo_vicks_container.vboCacheKeysArray.length)if(e.frontFace(e.CCW),0===r){if(!(c=t.vbo_vicks_container.vboCacheKeysArray[0]).isReadyPositions(e,i.vboMemoryManager))return;if(0===(h=c.vertexCount))return;e.disableVertexAttribArray(o.color4_loc),e.bindBuffer(e.ARRAY_BUFFER,c.meshVertexCacheKey),e.vertexAttribPointer(o.position3_loc,3,e.UNSIGNED_SHORT,!1,0,0),e.drawArrays(e.POINTS,0,h)}else if(1===r){var c,h;if(0===(h=(c=t.vbo_vicks_container.vboCacheKeysArray[0]).vertexCount))return;if(!c.isReadyPositions(e,i.vboMemoryManager))return;if(!c.isReadyColors(e,i.vboMemoryManager))return;if(e.bindBuffer(e.ARRAY_BUFFER,c.meshVertexCacheKey),l?e.vertexAttribPointer(o.position3_loc,3,e.UNSIGNED_SHORT,!1,0,0):e.vertexAttribPointer(o.position3_loc,3,e.FLOAT,!1,0,0),void 0!==c.meshColorCacheKey&&(e.enableVertexAttribArray(o.color4_loc),e.bindBuffer(e.ARRAY_BUFFER,c.meshColorCacheKey),e.vertexAttribPointer(o.color4_loc,4,e.UNSIGNED_BYTE,!0,0,0)),i.isCameraMoving&&0===(h=Math.floor(h/5)))return;if(a<100);else if(a<200){if(0===(h=Math.floor(h/2)))return}else if(a<400){if(0===(h=Math.floor(h/4)))return}else if(a<800){if(0===(h=Math.floor(h/8)))return}else if(a<1600){if(0===(h=Math.floor(h/16)))return}else if(0===(h=Math.floor(h/32)))return;e.drawArrays(e.POINTS,0,h),e.disableVertexAttribArray(o.color4_loc)}},Renderer.prototype.renderNeoBuildingsPCloud=function(e,t,i,o,r,n){for(var a,s,l,c,h,d=t.length,u=0;u<d;u++)if(s=(a=t[u]).getRoot().data.geoLocDataManager,void 0!==(l=a.data.neoBuilding).currentVisibleOctreesControler&&0!==(c=l.currentVisibleOctreesControler.currentVisibles2.length)){1===n&&i.magoPolicy.getObjectMoveMode()===CODE.moveMode.ALL&&i.buildingSelected===l&&this.enableStencilBuffer(e);var f=i.hierarchyManager.getNodesMap(a.data.projectId);void 0!==f.attributes&&void 0!==f.attributes.specularLighting&&o.bApplySpecularLighting_loc;var g=s.getCurrentGeoLocationData();e.uniformMatrix4fv(o.buildingRotMatrix_loc,!1,g.rotMatrix._floatArrays),e.uniform3fv(o.buildingPosHIGH_loc,g.positionHIGH),e.uniform3fv(o.buildingPosLOW_loc,g.positionLOW);for(var p=0;p<c;p++)if(void 0!==(h=l.currentVisibleOctreesControler.currentVisibles2[p]).lego){if(h.lego.fileLoadState===CODE.fileLoadState.PARSE_FINISHED){var m=!1;void 0!==h.lego.bPositionsCompressed&&(m=h.lego.bPositionsCompressed),e.uniform1i(o.bPositionCompressed_loc,m);var y=h.lego.bbox;e.uniform3fv(o.bboxSize_loc,[y.getXLength(),y.getYLength(),y.getZLength()]),e.uniform3fv(o.minPosition_loc,[y.minX,y.minY,y.minZ]);var v=h.distToCamera;this.renderPCloud(e,h.lego,i,o,n,r,v,2,m)}}else h.lego=new Lego,h.lego.fileLoadState=CODE.fileLoadState.READY,h.lego.legoKey=h.octreeKey+"_lego";1===n&&i.magoPolicy.getObjectMoveMode()===CODE.moveMode.ALL&&i.buildingSelected===l&&this.disableStencilBuffer(e)}},Renderer.prototype.renderNeoBuildingsLowLOD=function(e,t,i,o,r,n){for(var a,s,l,c,h,d=t.length,u=0;u<d;u++)if(s=(a=t[u]).getRoot().data.geoLocDataManager,void 0!==(l=a.data.neoBuilding)&&void 0!==(h=l.getCurrentSkin())&&h.fileLoadState===CODE.fileLoadState.PARSE_FINISHED){1===n&&i.magoPolicy.getObjectMoveMode()===CODE.moveMode.ALL&&i.buildingSelected===l&&this.enableStencilBuffer(e);var f=i.hierarchyManager.getNodesMap(a.data.projectId);if(void 0!==f.attributes&&void 0!==f.attributes.specularLighting&&void 0!==o.bApplySpecularLighting_loc)f.attributes.specularLighting?e.uniform1i(o.bApplySpecularLighting_loc,!0):e.uniform1i(o.bApplySpecularLighting_loc,!1);var g=s.getCurrentGeoLocationData();e.uniformMatrix4fv(o.buildingRotMatrix_loc,!1,g.rotMatrix._floatArrays),e.uniform3fv(o.buildingPosHIGH_loc,g.positionHIGH),e.uniform3fv(o.buildingPosLOW_loc,g.positionLOW),1===n&&(l.isHighLighted?(e.uniform1i(o.bUse1Color_loc,!0),e.uniform4fv(o.oneColor4_loc,this.highLightColor4)):l.isColorChanged?(e.uniform1i(o.bUse1Color_loc,!0),e.uniform4fv(o.oneColor4_loc,[l.aditionalColor.r,l.aditionalColor.g,l.aditionalColor.b,l.aditionalColor.a])):e.uniform1i(o.bUse1Color_loc,!1),r=!0,void 0!==h.texture&&h.texture.texId?(e.enableVertexAttribArray(o.texCoord2_loc),e.uniform1i(o.hasTexture_loc,!0),c!==h.texture.texId&&(e.bindTexture(e.TEXTURE_2D,h.texture.texId),c=h.texture.texId)):void 0!==i.textureAux_1x1&&(e.enableVertexAttribArray(o.texCoord2_loc),e.uniform1i(o.hasTexture_loc,!0),e.bindTexture(e.TEXTURE_2D,i.textureAux_1x1))),this.renderLodBuilding(e,h,i,o,n,r),h=void 0,1===n&&i.magoPolicy.getObjectMoveMode()===CODE.moveMode.ALL&&i.buildingSelected===l&&this.disableStencilBuffer(e)}},Renderer.prototype.enableStencilBuffer=function(e){e.enable(e.STENCIL_TEST),e.stencilFunc(e.ALWAYS,1,1),e.stencilOp(e.KEEP,e.REPLACE,e.REPLACE),e.enable(e.POLYGON_OFFSET_FILL)},Renderer.prototype.disableStencilBuffer=function(e){e.disable(e.STENCIL_TEST),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.disable(e.POLYGON_OFFSET_FILL)},Renderer.prototype.isReadyNeoRefList=function(e){if(void 0===e)return!1;if(0===e.neoRefsIndices.length)return!1;var t=e.blocksList;return void 0!==t&&t.fileLoadState===CODE.fileLoadState.PARSE_FINISHED},Renderer.prototype.isReadyNeoReference=function(e,t){return void 0!==e&&(e.renderingFase!==t.renderingFase&&void 0!==e.tMatrixAuxArray)},Renderer.prototype.isReadyBlock=function(e,t,i,o){return void 0!==e&&(!(o&&e.radius<o)&&!(i.isCameraMoving&&e.radius<i.smallObjectSize&&i.objectSelected!==t))},Renderer.prototype.renderNeoRefListsAsimetricVersion=function(e,t,i,o,r,n,a,s,l,c,h){if(this.isReadyNeoRefList(t))if(0!==s){var d,u,f,g;e.activeTexture(e.TEXTURE2),a&&1===s&&e.uniform1i(n.hasTexture_loc,!0),e.bindTexture(e.TEXTURE_2D,o.textureAux_1x1);for(var p=t.currentVisibleIndices.length,m=0;m<p;m++){var y=t.motherNeoRefsList[t.currentVisibleIndices[m]];if(this.isReadyNeoReference(y,o)&&(u=y._block_idx,f=i.motherBlocksArray[u],this.isReadyBlock(f,y,o,l))){if(y.hasTexture){if(i.manageNeoReferenceTexture(y,o)!==CODE.fileLoadState.LOADING_FINISHED)continue;if(void 0===y.texture)continue;if(void 0===y.texture.texId)continue}i.isHighLighted?(e.uniform1i(n.hasTexture_loc,!1),e.uniform4fv(n.oneColor4_loc,o.highLightColor4)):i.isColorChanged?(e.uniform1i(n.hasTexture_loc,!1),o.objectSelected===y?e.uniform4fv(n.oneColor4_loc,[1,0,0,1]):e.uniform4fv(n.oneColor4_loc,[i.aditionalColor.r,i.aditionalColor.g,i.aditionalColor.b,i.aditionalColor.a])):y.aditionalColor?(e.uniform1i(n.hasTexture_loc,!1),o.objectSelected===y?e.uniform4fv(n.oneColor4_loc,[1,0,0,1]):e.uniform4fv(n.oneColor4_loc,[y.aditionalColor.r,y.aditionalColor.g,y.aditionalColor.b,y.aditionalColor.a])):o.magoPolicy.getObjectMoveMode()===CODE.moveMode.OBJECT&&o.objectSelected===y?(e.uniform1i(n.hasTexture_loc,!1),e.uniform4fv(n.oneColor4_loc,[1,0,0,1]),this.enableStencilBuffer(e)):o.magoPolicy.colorChangedObjectId===y.objectId?(e.uniform1i(n.hasTexture_loc,!1),e.uniform4fv(n.oneColor4_loc,[o.magoPolicy.color[0],o.magoPolicy.color[1],o.magoPolicy.color[2],1])):a&&y.hasTexture?void 0!==y.texture&&void 0!==y.texture.texId?(e.uniform1i(n.hasTexture_loc,!0),g!==y.texture.texId&&(e.bindTexture(e.TEXTURE_2D,y.texture.texId),g=y.texture.texId)):(e.uniform1i(n.hasTexture_loc,!1),e.uniform4fv(n.oneColor4_loc,[.8,.8,.8,1])):(e.uniform1i(n.bUse1Color_loc,!0),y.color4?(e.uniform1i(n.hasTexture_loc,!1),e.uniform4fv(n.oneColor4_loc,[y.color4.r/255,y.color4.g/255,y.color4.b/255,y.color4.a/255])):(e.uniform1i(n.hasTexture_loc,!1),e.uniform4fv(n.oneColor4_loc,[.8,.8,.8,1]))),d=f.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray.length,e.uniform1i(n.refMatrixType_loc,y.refMatrixType),1===y.refMatrixType?e.uniform3fv(n.refTranslationVec_loc,y.refTranslationVec):2===y.refMatrixType&&e.uniformMatrix4fv(n.refMatrix_loc,!1,y.tMatrixAuxArray[h]._floatArrays),void 0!==y.moveVector?(e.uniform1i(n.hasAditionalMov_loc,!0),e.uniform3fv(n.aditionalMov_loc,[y.moveVector.x,y.moveVector.y,y.moveVector.z])):(e.uniform1i(n.hasAditionalMov_loc,!1),e.uniform3fv(n.aditionalMov_loc,[0,0,0]));for(var v=0;v<d;v++)if(this.vbo_vi_cacheKey_aux=f.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[v],this.vbo_vi_cacheKey_aux.isReadyPositions(e,o.vboMemoryManager)&&this.vbo_vi_cacheKey_aux.isReadyNormals(e,o.vboMemoryManager)&&this.vbo_vi_cacheKey_aux.isReadyFaces(e,o.vboMemoryManager)){if(e.bindBuffer(e.ARRAY_BUFFER,this.vbo_vi_cacheKey_aux.meshVertexCacheKey),e.vertexAttribPointer(n.position3_loc,3,e.FLOAT,!1,0,0),-1!==n.normal3_loc&&(e.bindBuffer(e.ARRAY_BUFFER,this.vbo_vi_cacheKey_aux.meshNormalCacheKey),e.vertexAttribPointer(n.normal3_loc,3,e.BYTE,!0,0,0)),a&&y.hasTexture)if(f.vertexCount<=y.vertexCount){var x=y.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[v];if(!x.isReadyTexCoords(e,o.vboMemoryManager))continue;e.enableVertexAttribArray(n.texCoord2_loc),e.bindBuffer(e.ARRAY_BUFFER,x.meshTexcoordsCacheKey),e.vertexAttribPointer(n.texCoord2_loc,2,e.FLOAT,!1,0,0)}else-1!==n.texCoord2_loc&&e.disableVertexAttribArray(n.texCoord2_loc);else-1!==n.texCoord2_loc&&e.disableVertexAttribArray(n.texCoord2_loc);var b;o.isCameraMoving?o.objectSelected===y?b=this.vbo_vi_cacheKey_aux.indicesCount:(b=this.vbo_vi_cacheKey_aux.bigTrianglesIndicesCount)>this.vbo_vi_cacheKey_aux.indicesCount&&(b=this.vbo_vi_cacheKey_aux.indicesCount):o.thereAreUrgentOctrees?(b=this.vbo_vi_cacheKey_aux.bigTrianglesIndicesCount)>this.vbo_vi_cacheKey_aux.indicesCount&&(b=this.vbo_vi_cacheKey_aux.indicesCount):b=this.vbo_vi_cacheKey_aux.indicesCount,e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.vbo_vi_cacheKey_aux.meshFacesCacheKey),e.drawElements(e.TRIANGLES,b,e.UNSIGNED_SHORT,0)}y.swapRenderingFase(),o.magoPolicy.getObjectMoveMode()===CODE.moveMode.OBJECT&&o.objectSelected===y&&(this.disableStencilBuffer(e),e.disable(e.POLYGON_OFFSET_FILL))}}}else this.depthRenderNeoRefListsAsimetricVersion(e,t,i,o,r,n,a,s,l,c,h)},Renderer.prototype.depthRenderNeoRefListsAsimetricVersion=function(e,t,i,o,r,n,a,s,l,c,h){if(this.isReadyNeoRefList(t))for(var d,u,f,g=t.currentVisibleIndices.length,p=0;p<g;p++){var m=t.motherNeoRefsList[t.currentVisibleIndices[p]];if(this.isReadyNeoReference(m,o)&&(u=m._block_idx,f=i.motherBlocksArray[u],this.isReadyBlock(f,m,o,l))){e.uniform1i(n.hasTexture_loc,!1),e.uniform4fv(n.color4Aux_loc,[0,0,0,1]),d=f.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray.length,e.uniform1i(n.refMatrixType_loc,m.refMatrixType),1===m.refMatrixType?e.uniform3fv(n.refTranslationVec_loc,m.refTranslationVec):2===m.refMatrixType&&e.uniformMatrix4fv(n.refMatrix_loc,!1,m.tMatrixAuxArray[h]._floatArrays),void 0!==m.moveVector?(e.uniform1i(n.hasAditionalMov_loc,!0),e.uniform3fv(n.aditionalMov_loc,[m.moveVector.x,m.moveVector.y,m.moveVector.z])):(e.uniform1i(n.hasAditionalMov_loc,!1),e.uniform3fv(n.aditionalMov_loc,[0,0,0]));for(var y=0;y<d;y++){var v;if(this.vbo_vi_cacheKey_aux=f.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[y],this.vbo_vi_cacheKey_aux.isReadyPositions(e,o.vboMemoryManager))if(this.vbo_vi_cacheKey_aux.isReadyFaces(e,o.vboMemoryManager))e.bindBuffer(e.ARRAY_BUFFER,this.vbo_vi_cacheKey_aux.meshVertexCacheKey),e.vertexAttribPointer(n.position3_loc,3,e.FLOAT,!1,0,0),o.isCameraMoving?o.objectSelected===m?v=this.vbo_vi_cacheKey_aux.indicesCount:(v=this.vbo_vi_cacheKey_aux.bigTrianglesIndicesCount)>this.vbo_vi_cacheKey_aux.indicesCount&&(v=this.vbo_vi_cacheKey_aux.indicesCount):v=this.vbo_vi_cacheKey_aux.indicesCount,e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.vbo_vi_cacheKey_aux.meshFacesCacheKey),e.drawElements(e.TRIANGLES,v,e.UNSIGNED_SHORT,0)}m.swapRenderingFase()}}},Renderer.prototype.renderNeoRefListsAsimetricVersionColorSelection=function(e,t,i,o,r,n,a,s,l){var c=i.data.neoBuilding,h=t.neoReferencesMotherAndIndices;if(this.isReadyNeoRefList(h))for(var d,u=h.currentVisibleIndices.length,f=o.selectionCandidates,g=0;g<u;g++){var p=h.motherNeoRefsList[h.currentVisibleIndices[g]];this.isReadyNeoReference(p,o)&&(p.selColor4=o.selectionColor.getAvailableColor(p.selColor4),d=o.selectionColor.decodeColor3(p.selColor4.r,p.selColor4.g,p.selColor4.b),f.setCandidates(d,p,t,c,i),p.selColor4&&e.uniform4fv(n.color4Aux_loc,[p.selColor4.r/255,p.selColor4.g/255,p.selColor4.b/255,1]),this.renderNeoReferenceAsimetricVersionColorSelection(e,p,h,c,o,n,a,s,l),p.swapRenderingFase())}},Renderer.prototype.renderNeoReferenceAsimetricVersionColorSelection=function(e,t,i,o,r,n,a,s,l){var c,h,d;if(h=t._block_idx,d=o.motherBlocksArray[h],this.isReadyBlock(d,t,r,a)){c=d.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray.length,e.uniform1i(n.refMatrixType_loc,t.refMatrixType),1===t.refMatrixType?e.uniform3fv(n.refTranslationVec_loc,t.refTranslationVec):2===t.refMatrixType&&e.uniformMatrix4fv(n.refMatrix_loc,!1,t.tMatrixAuxArray[s]._floatArrays),void 0!==t.moveVector?(e.uniform1i(n.hasAditionalMov_loc,!0),e.uniform3fv(n.aditionalMov_loc,[t.moveVector.x,t.moveVector.y,t.moveVector.z])):(e.uniform1i(n.hasAditionalMov_loc,!1),e.uniform3fv(n.aditionalMov_loc,[0,0,0]));for(var u=0;u<c;u++)this.vbo_vi_cacheKey_aux=d.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[u],this.vbo_vi_cacheKey_aux.isReadyPositions(e,r.vboMemoryManager)&&this.vbo_vi_cacheKey_aux.isReadyFaces(e,r.vboMemoryManager)&&(e.bindBuffer(e.ARRAY_BUFFER,this.vbo_vi_cacheKey_aux.meshVertexCacheKey),e.vertexAttribPointer(n.position3_loc,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.vbo_vi_cacheKey_aux.meshFacesCacheKey),e.drawElements(l,this.vbo_vi_cacheKey_aux.indicesCount,e.UNSIGNED_SHORT,0))}},Renderer.prototype.renderLodBuilding=function(e,t,i,o,r,n){if(0!==t.vbo_vicks_container.vboCacheKeysArray.length)if(e.frontFace(e.CCW),0===r){if(!(a=t.vbo_vicks_container.vboCacheKeysArray[0]).isReadyPositions(e,i.vboMemoryManager))return;if(0===(s=a.vertexCount))return;e.bindBuffer(e.ARRAY_BUFFER,a.meshVertexCacheKey),e.vertexAttribPointer(o.position3_loc,3,e.FLOAT,!1,0,0),e.drawArrays(e.TRIANGLES,0,s)}else if(1===r){var a,s;if(0===(s=(a=t.vbo_vicks_container.vboCacheKeysArray[0]).vertexCount))return;if(!a.isReadyPositions(e,i.vboMemoryManager))return;if(!a.isReadyNormals(e,i.vboMemoryManager))return;if(!n&&!a.isReadyColors(e,i.vboMemoryManager))return;if(n){if(!a.isReadyTexCoords(e,i.vboMemoryManager))return}else e.uniform1i(o.bUse1Color_loc,!1),e.disableVertexAttribArray(o.texCoord2_loc);e.bindBuffer(e.ARRAY_BUFFER,a.meshVertexCacheKey),e.vertexAttribPointer(o.position3_loc,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,a.meshNormalCacheKey),e.vertexAttribPointer(o.normal3_loc,3,e.BYTE,!0,0,0),void 0!==a.meshColorCacheKey&&(e.enableVertexAttribArray(o.color4_loc),e.bindBuffer(e.ARRAY_BUFFER,a.meshColorCacheKey),e.vertexAttribPointer(o.color4_loc,4,e.UNSIGNED_BYTE,!0,0,0)),n&&a.meshTexcoordsCacheKey&&(e.disableVertexAttribArray(o.color4_loc),e.bindBuffer(e.ARRAY_BUFFER,a.meshTexcoordsCacheKey),e.vertexAttribPointer(o.texCoord2_loc,2,e.FLOAT,!1,0,0)),e.drawArrays(e.TRIANGLES,0,s),e.disableVertexAttribArray(o.color4_loc)}},Renderer.prototype.renderLodBuildingColorSelection=function(e,t,i,o){if(0!==t.vbo_vicks_container.vboCacheKeysArray.length){e.frontFace(e.CCW);var r=t.vbo_vicks_container.vboCacheKeysArray[0];if(r.isReadyPositions(e,i.vboMemoryManager)){var n=r.vertexCount;0!==n&&(e.bindBuffer(e.ARRAY_BUFFER,r.meshVertexCacheKey),e.vertexAttribPointer(o.position3_loc,3,e.FLOAT,!1,0,0),e.drawArrays(e.TRIANGLES,0,n))}}},Renderer.prototype.renderObject=function(e,t,i,o,r,n,a){var s=t.getVboKeysContainer();if(void 0!==s&&0!==s.vboCacheKeysArray.length){void 0===n&&(n=!1);for(var l=s.getVbosCount(),c=0;c<l;c++){var h=s.vboCacheKeysArray[c];if(!h.isReadyPositions(e,i.vboMemoryManager))return;var d=h.vertexCount;if(0===d)return;if(e.bindBuffer(e.ARRAY_BUFFER,h.meshVertexCacheKey),e.vertexAttribPointer(o.position3_loc,3,e.FLOAT,!1,0,0),1===r&&(h.isReadyNormals(e,i.vboMemoryManager)?(e.enableVertexAttribArray(o.normal3_loc),e.uniform1i(o.bUseNormal_loc,!0),e.bindBuffer(e.ARRAY_BUFFER,h.meshNormalCacheKey),e.vertexAttribPointer(o.normal3_loc,3,e.BYTE,!0,0,0)):(e.disableVertexAttribArray(o.normal3_loc),e.uniform1i(o.bUseNormal_loc,!1)),h.isReadyColors(e,i.vboMemoryManager)?(e.bindBuffer(e.ARRAY_BUFFER,h.meshColorCacheKey),e.vertexAttribPointer(o.color4_loc,4,e.UNSIGNED_BYTE,!0,0,0)):e.disableVertexAttribArray(o.color4_loc)),!1===n)if(h.indicesCount>0){if(!h.isReadyFaces(e,i.vboMemoryManager))return;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,h.meshFacesCacheKey),e.drawElements(e.TRIANGLES,h.indicesCount,e.UNSIGNED_SHORT,0)}else e.drawArrays(e.TRIANGLES,0,d);else e.drawArrays(e.LINE_STRIP,0,d)}}};var SceneState=function(){if(!(this instanceof SceneState))throw new Error(Messages.CONSTRUCT_ERROR);this.gl,this.modelViewProjRelToEyeMatrix=new Matrix4,this.modelViewRelToEyeMatrix=new Matrix4,this.modelViewRelToEyeMatrixInv=new Matrix4,this.modelViewMatrix=new Matrix4,this.modelViewMatrixInv=new Matrix4,this.projectionMatrix=new Matrix4,this.modelViewProjMatrix=new Matrix4,this.normalMatrix4=new Matrix4,this.identityMatrix4=new Matrix4,this.encodedCamPosHigh=new Float32Array([0,0,0]),this.encodedCamPosLow=new Float32Array([0,0,0]),this.camera=new Camera,this.drawingBufferWidth=new Int32Array([1e3]),this.drawingBufferHeight=new Int32Array([1e3]),this.mouseAction=new MouseAction,this.ambientReflectionCoef=.45,this.diffuseReflectionCoef=.75,this.specularReflectionCoef=.6,this.specularColor=new Float32Array([.7,.7,.7]),this.ssaoRadius=.15,this.shininessValue=40,this.ssaoNoiseScale2=new Float32Array([1,1]),this.ssaoKernel16=[.33,0,.85,.25,.3,.5,.1,.3,.85,-.15,.2,.85,-.33,.05,.6,-.1,-.15,.85,-.05,-.32,.25,.2,-.15,.85,.6,0,.55,.5,.6,.45,-.01,.7,.35,-.33,.5,.45,-.45,0,.55,-.65,-.5,.7,0,-.5,.55,.33,.3,.35],this.ssaoSphereKernel32=[.33,0,.85,.25,.3,.5,.1,.3,.85,-.15,.2,.85,-.33,.05,.6,-.1,-.15,.85,-.05,-.32,.25,.2,-.15,.85,.6,0,.55,.5,.6,.45,-.01,.7,.35,-.33,.5,.45,-.45,0,.55,-.65,-.5,.7,0,-.5,.55,.33,.3,.35,.33,0,-.85,.25,.3,-.5,.1,.3,-.85,-.15,.2,-.85,-.33,.05,-.6,-.1,-.15,-.85,-.05,-.32,-.25,.2,-.15,-.85,.6,0,-.55,.5,.6,-.45,-.01,.7,-.35,-.33,.5,-.45,-.45,0,-.55,-.65,-.5,-.7,0,-.5,-.55,.33,.3,-.35],this.bMust=!1,this.dc,this.insertIssueState=0,this.textureFlipYAxis=!1,this.mouseButton=-1},Selection=function(){if(!(this instanceof Selection))throw new Error(Messages.CONSTRUCT_ERROR);this.drawing_height,this.drawing_width,this.GAIA_selectFrameBuffer,this.GAIA_selectRenderBuffer,this.GAIA_selectRttTexture,this.currentByteColorPicked=new Uint8Array(4),this.currentSelectedObj_idx=-1};Selection.prototype.init=function(e,t,i){this.drawing_height=i,this.drawing_width=t,this.GAIA_selectFrameBuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this.GAIA_selectFrameBuffer),this.GAIA_selectRenderBuffer=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this.GAIA_selectRenderBuffer),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.drawing_width,this.drawing_height),this.GAIA_selectRttTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.GAIA_selectRttTexture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.drawing_width,this.drawing_height,0,e.RGBA,e.UNSIGNED_BYTE,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.GAIA_selectRttTexture,0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.GAIA_selectRenderBuffer),e.bindTexture(e.TEXTURE_2D,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null)};var SelectionCandidates=function(){if(!(this instanceof SelectionCandidates))throw new Error(Messages.CONSTRUCT_ERROR);this.referencesMap={},this.octreesMap={},this.buildingsMap={},this.nodesMap={},this.currentReferenceSelected,this.currentOctreeSelected,this.currentBuildingSelected,this.currentNodeSelected};function defaultValue(e,t){return void 0!==e?e:t}SelectionCandidates.prototype.setCandidates=function(e,t,i,o,r){t&&(this.referencesMap[e]=t),i&&(this.octreesMap[e]=i),o&&(this.buildingsMap[e]=o),r&&(this.nodesMap[e]=r)},SelectionCandidates.prototype.clearCandidates=function(){this.referencesMap={},this.octreesMap={},this.buildingsMap={},this.nodesMap={}},SelectionCandidates.prototype.selectObjects=function(e){this.currentReferenceSelected=this.referencesMap[e],this.currentOctreeSelected=this.octreesMap[e],this.currentBuildingSelected=this.buildingsMap[e],this.currentNodeSelected=this.nodesMap[e]},SelectionCandidates.prototype.clearCurrents=function(e){this.currentReferenceSelected=void 0,this.currentOctreeSelected=void 0,this.currentBuildingSelected=void 0,this.currentNodeSelected=void 0};var ByteColor=function(){if(!(this instanceof ByteColor))throw new Error(Messages.CONSTRUCT_ERROR);this.ByteR=0,this.ByteG=0,this.ByteB=0,this.ByteAlfa=255};ByteColor.prototype.destroy=function(){this.ByteR=null,this.ByteG=null,this.ByteB=null,this.ByteAlfa=null},ByteColor.prototype.set=function(e,t,i){this.ByteR=e,this.ByteG=t,this.ByteB=i};var Point3DAux=function(){if(!(this instanceof Point3DAux))throw new Error(Messages.CONSTRUCT_ERROR);this.x=0,this.y=0,this.z=0},TTriangle=function(){if(!(this instanceof TTriangle))throw new Error(Messages.CONSTRUCT_ERROR);this.mVertex1,this.mVertex2,this.mVertex3};TTriangle.prototype.setVertices=function(e,t,i){this.mVertex1=e,this.mVertex2=t,this.mVertex3=i},TTriangle.prototype.invert=function(){var e=this.mVertex2;this.mVertex2=this.mVertex3,this.mVertex3=e};var TTrianglesList=function(){if(!(this instanceof TTrianglesList))throw new Error(Messages.CONSTRUCT_ERROR);this.tTrianglesArray=[]};TTrianglesList.prototype.newTTriangle=function(){var e=new TTriangle;return this.tTrianglesArray.push(e),e},TTrianglesList.prototype.invertTrianglesSense=function(){for(var e=0,t=this.tTrianglesArray.length;e<t;e++)this.tTrianglesArray[e].invert()},TTrianglesList.prototype.getTTriangle=function(e){return e>=0&&e<this.tTrianglesArray.length?this.tTrianglesArray[e]:void 0};var TTrianglesMatrix=function(){if(!(this instanceof TTrianglesMatrix))throw new Error(Messages.CONSTRUCT_ERROR);this.tTrianglesListsArray=[],this.totalTTrianglesArraySC=[]};TTrianglesMatrix.prototype.newTTrianglesList=function(){var e=new TTrianglesList;return this.tTrianglesListsArray.push(e),e},TTrianglesMatrix.prototype.invertTrianglesSense=function(){for(var e=0,t=this.tTrianglesListsArray.length;e<t;e++)this.tTrianglesListsArray[e].invertTrianglesSense()},TTrianglesMatrix.prototype.getTotalTTrianglesArray=function(e){for(var t=0,i=this.tTrianglesListsArray.length;t<i;t++)for(var o=0,r=this.tTrianglesListsArray[t].tTrianglesArray.length;o<r;o++){var n=this.tTrianglesListsArray[t].getTTriangle(o);e.push(n)}return e},TTrianglesMatrix.prototype.getVBOIndicesShortArray=function(){var e;this.totalTTrianglesArraySC.length=0,this.totalTTrianglesArraySC=this.getTotalTTrianglesArray(this.totalTTrianglesArraySC);for(var t=this.totalTTrianglesArraySC.length,i=new Uint16Array(3*t),o=0;o<t;o++)e=this.totalTTrianglesArraySC[o],i[3*o]=e.mVertex1.mIdxInList,i[3*o+1]=e.mVertex2.mIdxInList,i[3*o+2]=e.mVertex3.mIdxInList;return i};var ManagerUtils=function(){this.sqrtTable=[];for(var e=0;e<101;e++)this.sqrtTable[e]=Math.sqrt(1+.01*e*(.01*e))};ManagerUtils.pointToGeographicCoord=function(e,t,i){if(void 0===t&&(t=new GeographicCoord),i.configInformation.geo_view_library===Constant.WORLDWIND){var o=i.wwd.globe,r=new WorldWind.Position;r=o.computePositionFromPoint(e.x,e.y,e.z,r),t.setLonLatAlt(r.longitude,r.latitude,r.altitude)}else if(i.configInformation.geo_view_library===Constant.CESIUM){var n=Cesium.Cartographic.fromCartesian(new Cesium.Cartesian3(e.x,e.y,e.z));t.setLonLatAlt(n.longitude*(180/Math.PI),n.latitude*(180/Math.PI),n.height)}else if(i.configInformation.geo_view_library===Constant.MAGOWORLD){n=Globe.CartesianToGeographicWgs84(e.x,e.y,e.z,n);t.setLonLatAlt(n.longitude,n.latitude,n.height)}return t},ManagerUtils.geographicCoordToWorldPoint=function(e,t,i,o,r){void 0===o&&(o=new Point3D);var n=Globe.geographicToCartesianWgs84(e,t,i,void 0);return void 0!==r.configInformation&&r.configInformation.geo_view_library===Constant.WORLDWIND?(o.set(n[1],n[2],n[0]),o):(o.set(n[0],n[1],n[2]),o)},ManagerUtils.getTransformationMatrixInPoint=function(e,t,i,o){return o.configInformation.geo_view_library===Constant.WORLDWIND||o.configInformation.geo_view_library===Constant.CESIUM&&(void 0===t&&(t=new Matrix4),Cesium.Transforms.eastNorthUpToFixedFrame(new Cesium.Cartesian3(e.x,e.y,e.z),void 0,t._floatArrays),i&&Cesium.Matrix4.inverseTransformation(t._floatArrays,i._floatArrays)),t},ManagerUtils.translatePivotPointGeoLocationData=function(e,t){if(void 0!==e){var i=new Point3D;i.set(-t.x,-t.y,-t.z),e.pivotPointTraslation=i,e.doEffectivePivotPointTranslation()}},ManagerUtils.calculateGeoLocationMatrixAtWorldPosition=function(e,t,i){if(void 0===t&&(t=new Matrix4),i.configInformation.geo_view_library===Constant.WORLDWIND){var o=new WorldWind.Vec3(0,0,0),r=new WorldWind.Vec3(0,0,0),n=new WorldWind.Vec3(0,0,0),a=WorldWind.Matrix.fromIdentity();WorldWind.WWMath.localCoordinateAxesAtPoint([e.x,e.y,e.z],i.wwd.globe,o,r,n),a.set(o[0],r[0],n[0],e.x,o[1],r[1],n[1],e.y,o[2],r[2],n[2],e.z,0,0,0,1);var s=WorldWind.Matrix.fromIdentity();return s=a.columnMajorComponents(s),t.setByFloat32Array(s),t}return void 0===i.globe&&(i.globe=new Globe),i.globe.transformMatrixAtCartesianPointWgs84(e.x,e.y,e.z,t._floatArrays),t},ManagerUtils.calculateGeoLocationMatrixAtLonLatAlt=function(e,t,i,o,r){var n;return void 0===o&&(o=new Matrix4),n=this.geographicCoordToWorldPoint(e,t,i,n,r),o=ManagerUtils.calculateGeoLocationMatrixAtWorldPosition(n,o,r)},ManagerUtils.calculateTransformMatrixAtWorldPosition=function(e,t,i,o,r,n,a){var s,l,c,h=new Matrix4,d=new Matrix4,u=new Matrix4;return void 0!==t&&0!==t&&u.rotationAxisAngDeg(t,0,0,1),void 0!==i&&0!==i&&h.rotationAxisAngDeg(i,1,0,0),void 0!==o&&0!==o&&d.rotationAxisAngDeg(o,0,1,0),void 0===r&&(r=new Matrix4),void 0===n&&(n=new Matrix4),r=ManagerUtils.calculateGeoLocationMatrixAtWorldPosition(e,r,a),n.copyFromMatrix4(r),s=u.getMultipliedByMatrix(n,s),l=h.getMultipliedByMatrix(s,l),n=c=d.getMultipliedByMatrix(l,c)},ManagerUtils.calculateGeoLocationData=function(e,t,i,o,r,n,a,s){if(void 0===a&&(a=new GeoLocationData),void 0===a.geographicCoord&&(a.geographicCoord=new GeographicCoord),void 0!==e?a.geographicCoord.longitude=e:e=a.geographicCoord.longitude,void 0!==t?a.geographicCoord.latitude=t:t=a.geographicCoord.latitude,void 0!==i?a.geographicCoord.altitude=i:i=a.geographicCoord.altitude,void 0!==o&&(a.heading=o),void 0!==r&&(a.pitch=r),void 0!==n&&(a.roll=n),void 0!==a.geographicCoord.longitude&&void 0!==a.geographicCoord.latitude&&void 0!==s.configInformation){if(a.position=this.geographicCoordToWorldPoint(e,t,i,a.position,s),void 0===a.positionHIGH&&(a.positionHIGH=new Float32Array([0,0,0])),void 0===a.positionLOW&&(a.positionLOW=new Float32Array([0,0,0])),this.calculateSplited3fv([a.position.x,a.position.y,a.position.z],a.positionHIGH,a.positionLOW),void 0===a.tMatrix?a.tMatrix=new Matrix4:a.tMatrix.Identity(),void 0===a.geoLocMatrix?a.geoLocMatrix=new Matrix4:a.geoLocMatrix.Identity(),void 0===a.geoLocMatrixInv?a.geoLocMatrixInv=new Matrix4:a.geoLocMatrixInv.Identity(),void 0===a.tMatrixInv?a.tMatrixInv=new Matrix4:a.tMatrixInv.Identity(),void 0===a.rotMatrix?a.rotMatrix=new Matrix4:a.rotMatrix.Identity(),void 0===a.rotMatrixInv?a.rotMatrixInv=new Matrix4:a.rotMatrixInv.Identity(),a.tMatrix=ManagerUtils.calculateTransformMatrixAtWorldPosition(a.position,a.heading,a.pitch,a.roll,a.geoLocMatrix,a.tMatrix,s),a.rotMatrix.copyFromMatrix4(a.tMatrix),a.rotMatrix._floatArrays[12]=0,a.rotMatrix._floatArrays[13]=0,a.rotMatrix._floatArrays[14]=0,s.configInformation.geo_view_library===Constant.WORLDWIND){var l=WorldWind.Matrix.fromIdentity();l.invertMatrix(a.tMatrix._floatArrays),a.tMatrixInv.setByFloat32Array(l);var c=WorldWind.Matrix.fromIdentity();c.invertMatrix(a.rotMatrix._floatArrays),a.rotMatrixInv.setByFloat32Array(c);var h=WorldWind.Matrix.fromIdentity();h.invertMatrix(a.geoLocMatrix._floatArrays),a.geoLocMatrixInv.setByFloat32Array(h)}else s.configInformation.geo_view_library===Constant.CESIUM&&(Cesium.Matrix4.inverseTransformation(a.tMatrix._floatArrays,a.tMatrixInv._floatArrays),Cesium.Matrix4.inverseTransformation(a.rotMatrix._floatArrays,a.rotMatrixInv._floatArrays),Cesium.Matrix4.inverseTransformation(a.geoLocMatrix._floatArrays,a.geoLocMatrixInv._floatArrays));return void 0===a.pivotPoint&&(a.pivotPoint=new Point3D),a.pivotPoint.set(a.position.x,a.position.y,a.position.z),a.doEffectivePivotPointTranslation(),a}},ManagerUtils.calculateGeoLocationDataByAbsolutePoint=function(e,t,i,o,r){if(void 0===o&&(o=new GeoLocationData),void 0===o.geographicCoord&&(o.geographicCoord=new GeographicCoord),void 0!==r.configInformation){if(void 0===o.position&&(o.position=new Point3D),o.position.x=e,o.position.y=t,o.position.z=i,r.configInformation.geo_view_library===Constant.WORLDWIND){var n=r.wwd.globe,a=new WorldWind.Vec3(0,0,0);a=n.computePositionFromPoint(e,t,i,a),o.geographicCoord.longitude=a.longitude,o.geographicCoord.latitude=a.latitude,o.geographicCoord.altitude=a.altitude}else if(r.configInformation.geo_view_library===Constant.CESIUM){var s=new Cesium.Cartographic,l=new Cesium.Cartesian3;l.x=e,l.y=t,l.z=i,s=Cesium.Cartographic.fromCartesian(l,r.scene._globe._ellipsoid,s),o.geographicCoord.longitude=180*s.longitude/Math.PI,o.geographicCoord.latitude=180*s.latitude/Math.PI,o.geographicCoord.altitude=s.height}void 0===o.positionHIGH&&(o.positionHIGH=new Float32Array([0,0,0])),void 0===o.positionLOW&&(o.positionLOW=new Float32Array([0,0,0])),this.calculateSplited3fv([o.position.x,o.position.y,o.position.z],o.positionHIGH,o.positionLOW),void 0===o.tMatrix?o.tMatrix=new Matrix4:o.tMatrix.Identity(),void 0===o.geoLocMatrix?o.geoLocMatrix=new Matrix4:o.geoLocMatrix.Identity(),void 0===o.geoLocMatrixInv?o.geoLocMatrixInv=new Matrix4:o.geoLocMatrixInv.Identity(),void 0===o.tMatrixInv?o.tMatrixInv=new Matrix4:o.tMatrixInv.Identity(),void 0===o.rotMatrix?o.rotMatrix=new Matrix4:o.rotMatrix.Identity(),void 0===o.rotMatrixInv?o.rotMatrixInv=new Matrix4:o.rotMatrixInv.Identity();var c=new Matrix4,h=new Matrix4,d=new Matrix4;if(void 0!==o.heading&&0!==o.heading&&d.rotationAxisAngDeg(o.heading,0,0,-1),void 0!==o.pitch&&0!==o.pitch&&c.rotationAxisAngDeg(o.pitch,-1,0,0),void 0!==o.roll&&0!==o.roll&&h.rotationAxisAngDeg(o.roll,0,-1,0),r.configInformation.geo_view_library===Constant.WORLDWIND){var u=new WorldWind.Vec3(0,0,0),f=new WorldWind.Vec3(0,0,0),g=new WorldWind.Vec3(0,0,0),p=WorldWind.Matrix.fromIdentity(),m=WorldWind.Matrix.fromIdentity();WorldWind.WWMath.localCoordinateAxesAtPoint([o.position.x,o.position.y,o.position.z],r.wwd.globe,u,f,g),p.set(u[0],f[0],g[0],0,u[1],f[1],g[1],0,u[2],f[2],g[2],0,0,0,0,1),m.set(u[0],f[0],g[0],o.position.x,u[1],f[1],g[1],o.position.y,u[2],f[2],g[2],o.position.z,0,0,0,1);var y=WorldWind.Matrix.fromIdentity();y=p.columnMajorComponents(y);var v=WorldWind.Matrix.fromIdentity();v.invertMatrix(p);var x=WorldWind.Matrix.fromIdentity(),b=(v.columnMajorComponents(x),WorldWind.Matrix.fromIdentity());b=m.columnMajorComponents(b),o.tMatrix.setByFloat32Array(b),o.geoLocMatrix.copyFromMatrix4(o.tMatrix);var C=d.getMultipliedByMatrix(o.tMatrix,C),M=c.getMultipliedByMatrix(C,M),_=h.getMultipliedByMatrix(M,_);o.tMatrix=_,o.rotMatrix.copyFromMatrix4(o.tMatrix),o.rotMatrix._floatArrays[12]=0,o.rotMatrix._floatArrays[13]=0,o.rotMatrix._floatArrays[14]=0;var A=WorldWind.Matrix.fromIdentity();A.invertMatrix(o.tMatrix._floatArrays),o.tMatrixInv.setByFloat32Array(A);var R=WorldWind.Matrix.fromIdentity();R.invertMatrix(o.rotMatrix._floatArrays),o.rotMatrixInv.setByFloat32Array(R);var P=WorldWind.Matrix.fromIdentity();P.invertMatrix(o.geoLocMatrix._floatArrays),o.geoLocMatrixInv.setByFloat32Array(P)}else if(r.configInformation.geo_view_library===Constant.CESIUM){Cesium.Transforms.eastNorthUpToFixedFrame(o.position,void 0,o.tMatrix._floatArrays),o.geoLocMatrix.copyFromMatrix4(o.tMatrix);C=d.getMultipliedByMatrix(o.tMatrix,C),M=c.getMultipliedByMatrix(C,M),_=h.getMultipliedByMatrix(M,_);o.tMatrix=_,o.rotMatrix.copyFromMatrix4(o.tMatrix),o.rotMatrix._floatArrays[12]=0,o.rotMatrix._floatArrays[13]=0,o.rotMatrix._floatArrays[14]=0,Cesium.Matrix4.inverse(o.tMatrix._floatArrays,o.tMatrixInv._floatArrays),Cesium.Matrix4.inverse(o.rotMatrix._floatArrays,o.rotMatrixInv._floatArrays),Cesium.Matrix4.inverse(o.geoLocMatrix._floatArrays,o.geoLocMatrixInv._floatArrays)}return void 0===o.pivotPoint&&(o.pivotPoint=new Point3D),o.pivotPoint.set(o.position.x,o.position.y,o.position.z),o}},ManagerUtils.calculateSplitedValues=function(e,t){var i;return void 0===t&&(t=new SplitValue),e>=0?(i=65536*Math.floor(e/65536),t.high=i,t.low=e-i):(i=65536*Math.floor(-e/65536),t.high=-i,t.low=e+i),t},ManagerUtils.calculateSplited3fv=function(e,t,i){if(void 0!==e){void 0===t&&(t=new Float32Array(3)),void 0===i&&(i=new Float32Array(3));var o=new SplitValue;o=this.calculateSplitedValues(e[0],o);var r=new SplitValue;r=this.calculateSplitedValues(e[1],r);var n=new SplitValue;n=this.calculateSplitedValues(e[2],n),t[0]=o.high,t[1]=r.high,t[2]=n.high,i[0]=o.low,i[1]=r.low,i[2]=n.low}},ManagerUtils.calculateAproxDist2D=function(e,t,i){var o,r,n=Math.abs(e.x-t.x),a=Math.abs(e.y-t.y);return r=n>a?a/(o=n):n/(o=a),o*i[Math.floor(100*r)]};for(var sqrtTable=new Float32Array(11),increValue=.1,i=0;i<11;i++)sqrtTable[i]=Math.sqrt(1+increValue*i*(increValue*i));ManagerUtils.calculateAproxDist3D=function(e,t){var i,o,r,n,a,s,l=Math.abs(e.x-t.x),c=Math.abs(e.y-t.y),h=Math.abs(e.z-t.z);return l>c?l>h?(o=c/(i=l),n=Math.floor(100*o),r=h/(s=i*sqrtTable[n]),a=Math.floor(100*r),s*sqrtTable[a]):(o=l/(i=h),n=Math.floor(100*o),r=c/(s=i*sqrtTable[n]),a=Math.floor(100*r),s*sqrtTable[a]):c>h?(o=l/(i=c),n=Math.floor(100*o),r=h/(s=i*sqrtTable[n]),a=Math.floor(100*r),s*sqrtTable[a]):(o=l/(i=h),n=Math.floor(100*o),r=c/(s=i*sqrtTable[n]),a=Math.floor(100*r),s*sqrtTable[a])},function(){var e=window.URL||window.webkitURL;if(!e)throw new Error("This browser does not support Blob URLs");if(!window.Worker)throw new Error("This browser does not support Web Workers");function t(e){this.threads=Math.max(2,0|e),this._queue=[],this._queueSize=0,this._activeThreads=0,this._debug={start:0,end:0,time:0}}t.prototype._worker={JSON:function(){var e=func;self.addEventListener("message",function(t){for(var i=t.data,o=new DataView(i),r=i.byteLength,n=Array(r),a=0;a<r;a++)n[a]=String.fromCharCode(o.getUint8(a));var s=JSON.parse(n.join("")),l=e.apply(e,s);try{i=JSON.stringify(l)}catch(e){throw new Error("Parallel function must return JSON serializable response")}r=void 0===i?0:i.length;var c=new ArrayBuffer(r);for(o=new DataView(c),a=0;a<r;a++)o.setUint8(a,255&i.charCodeAt(a));self.postMessage(c,[c]),self.close()})},Int32:function(){var e=func;self.addEventListener("message",function(t){for(var i=t.data,o=new DataView(i),r=i.byteLength/4,n=Array(r),a=0;a<r;a++)n[a]=o.getInt32(4*a);var s=e.apply(e,n);s instanceof Array||(s=[s]),r=s.length;var l=new ArrayBuffer(4*r);for(o=new DataView(l),a=0;a<r;a++)o.setInt32(4*a,s[a]);self.postMessage(l,[l]),self.close()})},Float64:function(){var e=func;self.addEventListener("message",function(t){for(var i=t.data,o=new DataView(i),r=i.byteLength/8,n=Array(r),a=0;a<r;a++)n[a]=o.getFloat64(8*a);var s=e.apply(e,n);s instanceof Array||(s=[s]),r=s.length;var l=new ArrayBuffer(8*r);for(o=new DataView(l),a=0;a<r;a++)o.setFloat64(8*a,s[a]);self.postMessage(l,[l]),self.close()})}},t.prototype._encode={JSON:function(e){try{var t=JSON.stringify(e)}catch(e){throw new Error("Arguments provided to parallel function must be JSON serializable")}len=t.length;for(var i=new ArrayBuffer(len),o=new DataView(i),r=0;r<len;r++)o.setUint8(r,255&t.charCodeAt(r));return i},Int32:function(e){len=e.length;for(var t=new ArrayBuffer(4*len),i=new DataView(t),o=0;o<len;o++)i.setInt32(4*o,e[o]);return t},Float64:function(e){len=e.length;for(var t=new ArrayBuffer(8*len),i=new DataView(t),o=0;o<len;o++)i.setFloat64(8*o,e[o]);return t}},t.prototype._decode={JSON:function(e){for(var t=new DataView(e),i=e.byteLength,o=Array(i),r=0;r<i;r++)o[r]=String.fromCharCode(t.getUint8(r));return o.length?JSON.parse(o.join("")):void 0},Int32:function(e){for(var t=new DataView(e),i=e.byteLength/4,o=Array(i),r=0;r<i;r++)o[r]=t.getInt32(4*r);return o},Float64:function(e){for(var t=new DataView(e),i=e.byteLength/8,o=Array(i),r=0;r<i;r++)o[r]=t.getFloat64(8*r);return o}},t.prototype._execute=function(e,t,i,o){if(this._activeThreads||(this._debug.start=(new Date).valueOf()),this._activeThreads<this.threads){this._activeThreads++;(new Date).valueOf();var r=new Worker(e),n=this._encode[i](t),a=this._decode[i],s=this;if("JSON"===i)var l=function(e){o.call(s,a(e.data)),s.ready()};else l=function(e){o.apply(s,a(e.data)),s.ready()};r.addEventListener("message",l),r.postMessage(n,[n])}else this._queueSize++,this._queue.push([e,t,i,o])},t.prototype.ready=function(){this._activeThreads--,this._queueSize?(this._execute.apply(this,this._queue.shift()),this._queueSize--):this._activeThreads||(this._debug.end=(new Date).valueOf(),this._debug.time=this._debug.end-this._debug.start)},t.prototype._prepare=function(t,i){var o=(t=t).name,r=t.toString();if(!o)for(o="$"+(10*Math.random()|0);-1!==r.indexOf(o);)o+=10*Math.random()|0;var n=this._worker[i].toString().replace(/^.*?[\n\r]+/gi,"").replace(/\}[\s]*$/,"").replace(/\/\*\*\/name\/\*\*\//gi,o).replace(/\/\*\*\/func\/\*\*\//gi,r);return e.createObjectURL(new Blob([n],{type:"text/javascript"}))},t.prototype.process=function(e,t){var i=this._prepare(e,"JSON"),o=this;return function(){o._execute(i,[].slice.call(arguments),"JSON",t)}},t.prototype.processInt32=function(e,t){var i=this._prepare(e,"Int32"),o=this;return function(){o._execute(i,[].slice.call(arguments),"Int32",t)}},t.prototype.processFloat64=function(e,t){var i=this._prepare(e,"Float64"),o=this;return function(){o._execute(i,[].slice.call(arguments),"Float64",t)}},window.Multithread=t}();